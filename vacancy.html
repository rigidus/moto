<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Модуль HeadHunter (Vacancy Operations)</title>
<!-- 2017-09-08 Пт 04:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 87 -*- -->
<!-- org-toggle-inline-images -->

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Модуль HeadHunter (Vacancy Operations)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Как это работает?</a>
<ul>
<li><a href="#sec-1-1">1.1. Источник вакансий</a></li>
<li><a href="#sec-1-2">1.2. Фабрика генераторов вакансий</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. Построение URL-ов для скачивания тизеров (<code>make-hh-url</code>)</a></li>
<li><a href="#sec-1-2-2">1.2.2. Получение страниц (<code>hh-get-page</code>)</a></li>
<li><a href="#sec-1-2-3">1.2.3. Разбор тизеров вакансий (<code>hh-parse-vacancy-teasers</code>)</a></li>
<li><a href="#sec-1-2-4">1.2.4. Разбор вакансий (<code>hh-parse-vacancy</code>)</a></li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. Правила обработки тизеров и вакансий</a>
<ul>
<li><a href="#sec-1-3-1">1.3.1. Правила отсева тизеров</a></li>
<li><a href="#sec-1-3-2">1.3.2. <span class="todo nilTODO">TODO</span> Правила анализа вакансий</a></li>
<li><a href="#sec-1-3-3">1.3.3. Извлечение правил</a></li>
</ul>
</li>
<li><a href="#sec-1-4">1.4. Процессор правил (<code>process</code>)</a></li>
<li><a href="#sec-1-5">1.5. Декоратор для process-teaser (<code>process-teaser :around</code>)</a></li>
<li><a href="#sec-1-6">1.6. Получение и обработка вакансий правилами (<code>run</code>)</a>
<ul>
<li><a href="#sec-1-6-1">1.6.1. Создание правила</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2">2. Сборка</a></li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Как это работает?</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Источник вакансий</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Пусть у нас есть источник вакансий, например, hh.ru. На нем можно сформулировать запрос и
получить выборку в виде списка тизеров вакансий, каждый из которых ведет на полное
описание вакансии.
</p>

<p>
./img/warehouse.jpg]]
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Фабрика генераторов вакансий</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Пусть у нас есть фабрика <code>генераторов</code> назовем её <code>factory</code>, которая принимает
<code>источник вакансий</code> и параметры запроса (например: <code>профессиональную область</code>,
<code>специализацию</code>, <code>город</code>) и возвращает <code>функцию-генератор</code> в замыкании.
</p>

<p>
./img/factory.jpg]]
</p>

<p>
Эта функция-генератор при каждом своем вызове вернет одну вакансию или <code>ложь</code> если все
вакансии кончились (или сервер вернул 404-ую ошибку).
</p>

<p>
./img/generator.jpg]]
</p>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает сначала тизеры
вакансий, а потом и сами вакансии. При этом процесс превращения тизера в вакансию
(<code>process-teaser</code>) вынесен из замыкания, т.к. не зависит от замкнутых переменных.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="factory">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;make_hh_url&gt;&gt;

&lt;&lt;hh_get_page&gt;&gt;

&lt;&lt;hh_parse_vacancy_teasers&gt;&gt;

&lt;&lt;hh_parse_vacancy&gt;&gt;

(<span style="color: #af00ff;">let</span> ((cookie-jar (make-instance 'drakma:cookie-jar)))
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">------- &#1101;&#1090;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090;&#1089;&#1103; &#1080;&#1079; get-vacancy, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; factory</span>
  (<span style="color: #af00ff;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> (current-teaser src-account referer)
    (dbg <span style="color: #87005f;">":process-teaser:"</span>)
    (<span style="color: #af00ff;">let*</span> ((vac-plist (plistp current-teaser))
           <span style="color: #af0000;">;; </span><span style="color: #af0000;">(none (print vac-plist))</span>
           (vac-id (<span style="color: #af00ff;">if</span> vac-plist
                       (getf (getf current-teaser <span style="color: #5f5f87;">:teaser</span>) <span style="color: #5f5f87;">:id</span>)
                       (getf (getf (car current-teaser) <span style="color: #5f5f87;">:vacancy</span>) <span style="color: #5f5f87;">:id</span>)))
           (vacancy-page (format nil <span style="color: #87005f;">"https://spb.hh.ru/vacancy/~A"</span> vac-id)))
      (<span style="color: #af00ff;">multiple-value-bind</span> (vacancy new-cookies ref-url)
          (hh-get-page vacancy-page cookie-jar src-account referer)
        (setf cookie-jar new-cookies)
        (<span style="color: #af00ff;">restart-case</span>
            (aif (hh-parse-vacancy vacancy)
                 (merge-plists current-teaser it)
                 nil)
          (skip () nil)))))
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">------- &#1101;&#1090;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; get-vacancy, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1103;&#1074;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1090;&#1086;&#1088;&#1086;&#1084; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;</span>
  (<span style="color: #af00ff;">defmethod</span> <span style="color: #0000ff;">factory</span> ((vac-src (eql 'hh)) src-account city prof-area <span style="color: #008700;">&amp;optional</span> spec)
    (dbg <span style="color: #87005f;">":factory:"</span>)
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">closure</span>
    (<span style="color: #af00ff;">let</span> ((url        (make-hh-url city prof-area spec))
          (page       0)
          (teasers    nil))
      <span style="color: #af0000;">;; </span><span style="color: #af0000;">returned function-generator in closure</span>
      (alexandria:named-lambda get-vacancy ()
        (<span style="color: #af00ff;">labels</span> (<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1090; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1090;&#1080;&#1079;&#1077;&#1088;&#1086;&#1074; &#1074; TEASERS</span>
                 (LOAD-NEXT-TEASERS-PAGE ()
                   (dbg <span style="color: #87005f;">":load-next-teasers-page: (page=~A)"</span> page)
                   (<span style="color: #af00ff;">let*</span> ((next-teasers-page-url (format nil url page))
                          (referer (<span style="color: #af00ff;">if</span> (<span style="color: #af00ff;">=</span> page 0) <span style="color: #87005f;">"https://spb.hh.ru"</span> (format nil url (- page 1)))))
                     (<span style="color: #af00ff;">handler-case</span>
                         (<span style="color: #af00ff;">multiple-value-bind</span> (next-teasers-page new-cookies ref-url)
                             (hh-get-page next-teasers-page-url cookie-jar src-account referer)
                           (setf cookie-jar new-cookies)
                           (setf teasers (hh-parse-vacancy-teasers next-teasers-page))
                           (incf page)
                           (<span style="color: #af00ff;">when</span> (equal 0 (length teasers))
                             (dbg <span style="color: #87005f;">"~~ FIN(0)"</span>)
                             (<span style="color: #af00ff;">return-from</span> get-vacancy 'nil)))
                       (hh-404-error (err)
                         (<span style="color: #af00ff;">progn</span>
                           (dbg <span style="color: #87005f;">"~~ FIN(404) : ~A"</span> (url err))
                           (<span style="color: #af00ff;">return-from</span> get-vacancy 'nil))))))
                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1090;&#1080;&#1079;&#1077;&#1088; &#1080;&#1079; &#1087;&#1091;&#1083;&#1072; &#1090;&#1080;&#1079;&#1077;&#1088;&#1086;&#1074;.</span>
                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1045;&#1089;&#1083;&#1080; &#1087;&#1091;&#1083; &#1087;&#1091;&#1089;&#1090;, &#1090;&#1086; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; LOAD-NEXT-TEASER-PAGE &#1095;&#1090;&#1086;&#1073;&#1099; &#1085;&#1072;&#1087;&#1086;&#1083;&#1085;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086;</span>
                 (GET-TEASER ()
                   (dbg <span style="color: #87005f;">":get-teaser:"</span>)
                   (<span style="color: #af00ff;">when</span> (equal 0 (length teasers))
                     (load-next-teasers-page))
                   (<span style="color: #af00ff;">prog1</span> (car teasers)
                     (setf teasers (cdr teasers)))))
          (<span style="color: #af00ff;">tagbody</span> get-new-teaser
             (<span style="color: #af00ff;">let*</span> ((teaser (get-teaser))
                    (current-vacancy (process-teaser teaser src-account (format nil url page))))
               (<span style="color: #af00ff;">if</span> (null current-vacancy)
                   (<span style="color: #af00ff;">go</span> get-new-teaser)
                   (<span style="color: #af00ff;">return-from</span> get-vacancy current-vacancy)))))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(let ((gen (factory 'hh "spb" "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #af0000;">;;                     </span><span style="color: #af0000;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(loop :for i :from 1 :to 100 :do</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">;; (dbg "~A" i)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">(let ((vacancy (funcall gen)))</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(when (null vacancy)</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">(return))))))</span>
</pre>
</div>

<p>
Для работы этому генератору нужно уметь:
</p>
<ul class="org-ul">
<li>Собирать URL страницы, где лежат тизеры (краткие описания) вакансий из параметов запроса
(<code>make-hh-url</code>)
</li>
<li>Скачивать HTML-страницы (<code>hh-get-page</code>)
</li>
<li>Разбирать тизеры из html-кода (<code>hh-parse-vacancy-teasers</code>)
</li>
<li>Обрабатывать разобранные тизеры (<code>hh-parse-vacancy</code>), чтобы получить по ним вакансии.
</li>
</ul>

<p>
Реализуем все эти вещи:
</p>
</div>

<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> Построение URL-ов для скачивания тизеров (<code>make-hh-url</code>)</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Тизеры вакансий размещаются постранично, по 20 штук на странице, и мы можем собрать все
страницы, если будем получать страницу за страницей, пока не получим страницу, на которой
вакансий нет.
</p>

<p>
В качестве GET-параметров запросы указываются <code>специализации</code> и город. Значения <code>cluster</code>
и <code>area</code> не меняются. Поэтому, единственная сложность построения URL - это правильно
сформировать <code>специализации</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_hh_url">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;!make_specialization_hh_url_string&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">make-hh-url</span> (city prof-area <span style="color: #008700;">&amp;optional</span> specs)
  <span style="color: #87005f;">"https://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;items_on_page=100&amp;no_magic=true&amp;page=~A"</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(make-hh-url "spb" "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-2-1-1"></a><span class="todo TODO">TODO</span> Построение специализаций<br  /><div class="outline-text-5" id="text-1-2-1-1">
<p>
Специализации задаются в формате "1.221", где цифра слева от точки представляет
профессиональное направление, а справа - собственно специализацию. В интерфейсе
допустимо выбрать одно направление и несколько специализаций в нем, при этом для каждой
специализации формируется параметр GET-запроса. Допустимо выбрать только направление,
без специализаций.
</p>

<p>
По этой причине мы должны иметь дерево специализаций и транслятор названий специализаций
в их номера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_specialization_hh_url_string">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;prof_areas&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">make-specialization-hh-url-string</span> (prof-area <span style="color: #008700;">&amp;optional</span> specs)
  (<span style="color: #af00ff;">let</span> ((specialization (assoc prof-area *prof-areas* <span style="color: #5f5f87;">:test</span> #'equal)))
    (<span style="color: #af00ff;">when</span> (null specialization)
      (err 'specialization-not-found))
    (<span style="color: #af00ff;">when</span> (stringp specs)
      (setf specs (list specs)))
    (<span style="color: #af00ff;">if</span> (null specs)
        (concatenate 'string
                     <span style="color: #87005f;">"&amp;specialization="</span>
                     (cadr specialization))
        (format nil <span style="color: #87005f;">"~{&amp;~A~}"</span>
                (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> spec <span style="color: #5f5f87;">:in</span> specs <span style="color: #5f5f87;">:collect</span>
                   (<span style="color: #af00ff;">let</span> ((spec (cdr (assoc spec (caddr specialization) <span style="color: #5f5f87;">:test</span> #'equal))))
                     (<span style="color: #af00ff;">when</span> (null spec)
                       (err 'spec-not-found))
                     (concatenate 'string <span style="color: #87005f;">"specialization="</span> (cadr specialization) <span style="color: #87005f;">"."</span> spec)))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" '("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #af0000;">;;                                    </span><span style="color: #af0000;">'("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>
<span style="color: #af0000;">;;                                      </span><span style="color: #af0000;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span>
<span style="color: #af0000;">;;                                      </span><span style="color: #af0000;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span>
<span style="color: #af0000;">;;                                      </span><span style="color: #af0000;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span>
<span style="color: #af0000;">;;                                      </span><span style="color: #af0000;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span>
<span style="color: #af0000;">;;                                      </span><span style="color: #af0000;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"))</span>
</pre>
</div>

<p>
Дерево специализаций будем хранить в глобальном alist-е, т.к. оно никогда не меняется. Я
не стал заполнять его целиком, ограничившись только профессиональной областью "ИТ". По
необходимости заполню остальное.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="prof_areas">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*prof-areas*</span>
  '((<span style="color: #87005f;">"&#1042;&#1089;&#1077; &#1087;&#1088;&#1086;&#1092;&#1077;&#1089;&#1089;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080;"</span> . (<span style="color: #87005f;">""</span>))
    (<span style="color: #87005f;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
     . (<span style="color: #87005f;">"1"</span> ((<span style="color: #87005f;">"CRM &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;"</span> . <span style="color: #87005f;">"536"</span>)
             (<span style="color: #87005f;">"CTO, CIO, &#1044;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088; &#1087;&#1086; IT"</span> . <span style="color: #87005f;">"3"</span>)
             (<span style="color: #87005f;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #87005f;">"9"</span>)
             (<span style="color: #87005f;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span> . <span style="color: #87005f;">"10"</span>)
             (<span style="color: #87005f;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088; &#1073;&#1072;&#1079; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;"</span> . <span style="color: #87005f;">"420"</span>)
             (<span style="color: #87005f;">"&#1040;&#1085;&#1072;&#1083;&#1080;&#1090;&#1080;&#1082;"</span> . <span style="color: #87005f;">"25"</span>)
             (<span style="color: #87005f;">"&#1040;&#1088;&#1090;-&#1076;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088;"</span> . <span style="color: #87005f;">"30"</span>)
             (<span style="color: #87005f;">"&#1041;&#1072;&#1085;&#1082;&#1086;&#1074;&#1089;&#1082;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #87005f;">"395"</span>)
             (<span style="color: #87005f;">"&#1048;&#1075;&#1088;&#1086;&#1074;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #87005f;">"475"</span>)
             (<span style="color: #87005f;">"&#1048;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #87005f;">"82"</span>)
             (<span style="color: #87005f;">"&#1048;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #87005f;">"89"</span>)
             (<span style="color: #87005f;">"&#1050;&#1086;&#1084;&#1087;&#1100;&#1102;&#1090;&#1077;&#1088;&#1085;&#1072;&#1103; &#1073;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . <span style="color: #87005f;">"110"</span>)
             (<span style="color: #87005f;">"&#1050;&#1086;&#1085;&#1089;&#1072;&#1083;&#1090;&#1080;&#1085;&#1075;, &#1040;&#1091;&#1090;&#1089;&#1086;&#1088;&#1089;&#1080;&#1085;&#1075;"</span> . <span style="color: #87005f;">"113"</span>)
             (<span style="color: #87005f;">"&#1050;&#1086;&#1085;&#1090;&#1077;&#1085;&#1090;"</span> . <span style="color: #87005f;">"116"</span>)
             (<span style="color: #87005f;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;"</span> . <span style="color: #87005f;">"137"</span>)
             (<span style="color: #87005f;">"&#1052;&#1091;&#1083;&#1100;&#1090;&#1080;&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . <span style="color: #87005f;">"161"</span>)
             (<span style="color: #87005f;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1091;&#1088;&#1086;&#1074;&#1077;&#1085;&#1100;, &#1052;&#1072;&#1083;&#1086; &#1086;&#1087;&#1099;&#1090;&#1072;"</span> . <span style="color: #87005f;">"172"</span>)
             (<span style="color: #87005f;">"&#1054;&#1087;&#1090;&#1080;&#1084;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103; &#1089;&#1072;&#1081;&#1090;&#1072; (SEO)"</span> . <span style="color: #87005f;">"400"</span>)
             (<span style="color: #87005f;">"&#1055;&#1077;&#1088;&#1077;&#1076;&#1072;&#1095;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1080; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1074; &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #87005f;">"203"</span>)
             (<span style="color: #87005f;">"&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072;, Helpdesk"</span> . <span style="color: #87005f;">"211"</span>)
             (<span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span> . <span style="color: #87005f;">"221"</span>)
             (<span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . <span style="color: #87005f;">"225"</span>)
             (<span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1076;&#1102;&#1089;&#1077;&#1088;"</span> . <span style="color: #87005f;">"232"</span>)
             (<span style="color: #87005f;">"&#1056;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1077; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;&#1072;"</span> . <span style="color: #87005f;">"246"</span>)
             (<span style="color: #87005f;">"&#1057;&#1077;&#1090;&#1077;&#1074;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #87005f;">"270"</span>)
             (<span style="color: #87005f;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1072;&#1103; &#1080;&#1085;&#1090;&#1077;&#1075;&#1088;&#1072;&#1094;&#1080;&#1103;"</span> . <span style="color: #87005f;">"272"</span>)
             (<span style="color: #87005f;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span> . <span style="color: #87005f;">"273"</span>)
             (<span style="color: #87005f;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;"</span> . <span style="color: #87005f;">"274"</span>)
             (<span style="color: #87005f;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1077;&#1084; (ERP)"</span> . <span style="color: #87005f;">"50"</span>)
             (<span style="color: #87005f;">"&#1057;&#1086;&#1090;&#1086;&#1074;&#1099;&#1077;, &#1041;&#1077;&#1089;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #87005f;">"277"</span>)
             (<span style="color: #87005f;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span> . <span style="color: #87005f;">"474"</span>)
             (<span style="color: #87005f;">"&#1058;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&#1084;&#1091;&#1085;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080;"</span> . <span style="color: #87005f;">"295"</span>)
             (<span style="color: #87005f;">"&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . <span style="color: #87005f;">"117"</span>)
             (<span style="color: #87005f;">"&#1058;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1087;&#1080;&#1089;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> . <span style="color: #87005f;">"296"</span>)
             (<span style="color: #87005f;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span> . <span style="color: #87005f;">"327"</span>)
             (<span style="color: #87005f;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"</span> . <span style="color: #87005f;">"359"</span>))))
    (<span style="color: #87005f;">"&#1041;&#1091;&#1093;&#1075;&#1072;&#1083;&#1090;&#1077;&#1088;&#1080;&#1103;, &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1091;&#1095;&#1077;&#1090;, &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1099; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1103;"</span> . (<span style="color: #87005f;">"2"</span>))
    (<span style="color: #87005f;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;, &#1088;&#1077;&#1082;&#1083;&#1072;&#1084;&#1072;, PR"</span> . (<span style="color: #87005f;">"3"</span>))
    (<span style="color: #87005f;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1080;&#1074;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #87005f;">"4"</span>))
    (<span style="color: #87005f;">"&#1041;&#1072;&#1085;&#1082;&#1080;, &#1080;&#1085;&#1074;&#1077;&#1089;&#1090;&#1080;&#1094;&#1080;&#1080;, &#1083;&#1080;&#1079;&#1080;&#1085;&#1075;"</span> . (<span style="color: #87005f;">"5"</span>))
    (<span style="color: #87005f;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;&#1086;&#1084;, &#1090;&#1088;&#1077;&#1085;&#1080;&#1085;&#1075;&#1080;"</span> . (<span style="color: #87005f;">"6"</span>))
    (<span style="color: #87005f;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100;&#1085;&#1099;&#1081; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;"</span> . (<span style="color: #87005f;">"7"</span>))
    (<span style="color: #87005f;">"&#1041;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #87005f;">"8"</span>))
    (<span style="color: #87005f;">"&#1042;&#1099;&#1089;&#1096;&#1080;&#1081; &#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1084;&#1077;&#1085;&#1090;"</span> . (<span style="color: #87005f;">"9"</span>))
    (<span style="color: #87005f;">"&#1044;&#1086;&#1073;&#1099;&#1095;&#1072; &#1089;&#1099;&#1088;&#1100;&#1103;"</span> . (<span style="color: #87005f;">"10"</span>))
    (<span style="color: #87005f;">"&#1048;&#1089;&#1082;&#1091;&#1089;&#1089;&#1090;&#1074;&#1086;, &#1088;&#1072;&#1079;&#1074;&#1083;&#1077;&#1095;&#1077;&#1085;&#1080;&#1103;, &#1084;&#1072;&#1089;&#1089;-&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . (<span style="color: #87005f;">"11"</span>))
    (<span style="color: #87005f;">"&#1050;&#1086;&#1085;&#1089;&#1091;&#1083;&#1100;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #87005f;">"12"</span>))
    (<span style="color: #87005f;">"&#1052;&#1077;&#1076;&#1080;&#1094;&#1080;&#1085;&#1072;, &#1092;&#1072;&#1088;&#1084;&#1072;&#1094;&#1077;&#1074;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #87005f;">"13"</span>))
    (<span style="color: #87005f;">"&#1053;&#1072;&#1091;&#1082;&#1072;, &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #87005f;">"14"</span>))
    (<span style="color: #87005f;">"&#1043;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1072;&#1103; &#1089;&#1083;&#1091;&#1078;&#1073;&#1072;, &#1085;&#1077;&#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1095;&#1077;&#1089;&#1082;&#1080;&#1077; &#1086;&#1088;&#1075;&#1072;&#1085;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080;"</span> . (<span style="color: #87005f;">"16"</span>))
    (<span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . (<span style="color: #87005f;">"17"</span>))
    (<span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1080;&#1079;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;"</span> . (<span style="color: #87005f;">"18"</span>))
    (<span style="color: #87005f;">"&#1057;&#1090;&#1088;&#1072;&#1093;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #87005f;">"19"</span>))
    (<span style="color: #87005f;">"&#1057;&#1090;&#1088;&#1086;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;&#1086;, &#1085;&#1077;&#1076;&#1074;&#1080;&#1078;&#1080;&#1084;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #87005f;">"20"</span>))
    (<span style="color: #87005f;">"&#1058;&#1088;&#1072;&#1085;&#1089;&#1087;&#1086;&#1088;&#1090;, &#1083;&#1086;&#1075;&#1080;&#1089;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #87005f;">"21"</span>))
    (<span style="color: #87005f;">"&#1058;&#1091;&#1088;&#1080;&#1079;&#1084;, &#1075;&#1086;&#1089;&#1090;&#1080;&#1085;&#1080;&#1094;&#1099;, &#1088;&#1077;&#1089;&#1090;&#1086;&#1088;&#1072;&#1085;&#1099;"</span> . (<span style="color: #87005f;">"22"</span>))
    (<span style="color: #87005f;">"&#1070;&#1088;&#1080;&#1089;&#1090;&#1099;"</span> . (<span style="color: #87005f;">"23"</span>))
    (<span style="color: #87005f;">"&#1057;&#1087;&#1086;&#1088;&#1090;&#1080;&#1074;&#1085;&#1099;&#1077; &#1082;&#1083;&#1091;&#1073;&#1099;, &#1092;&#1080;&#1090;&#1085;&#1077;&#1089;, &#1089;&#1072;&#1083;&#1086;&#1085;&#1099; &#1082;&#1088;&#1072;&#1089;&#1086;&#1090;&#1099;"</span> . (<span style="color: #87005f;">"24"</span>))
    (<span style="color: #87005f;">"&#1048;&#1085;&#1089;&#1090;&#1072;&#1083;&#1083;&#1103;&#1094;&#1080;&#1103; &#1080; &#1089;&#1077;&#1088;&#1074;&#1080;&#1089;"</span> . (<span style="color: #87005f;">"25"</span>))
    (<span style="color: #87005f;">"&#1047;&#1072;&#1082;&#1091;&#1087;&#1082;&#1080;"</span> . (<span style="color: #87005f;">"26"</span>))
    (<span style="color: #87005f;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1072;&#1088;&#1100;&#1077;&#1088;&#1099;, &#1089;&#1090;&#1091;&#1076;&#1077;&#1085;&#1090;&#1099;"</span> . (<span style="color: #87005f;">"15"</span>))
    (<span style="color: #87005f;">"&#1044;&#1086;&#1084;&#1072;&#1096;&#1085;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #87005f;">"27"</span>))
    (<span style="color: #87005f;">"&#1056;&#1072;&#1073;&#1086;&#1095;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #87005f;">"29"</span>))))
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> Получение страниц (<code>hh-get-page</code>)</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Так как мы хотим получать информацию, которая находится за авторизацией, нам нужно
обеспечить прозрачность авторизации, если ее в данный момент нет. <code>hh_recovery_login</code> решает эту
проблему.
</p>

<p>
Вот так мы можем получать страницы, к примеру те, на который находятся тизеры:
</p>
<ul class="org-ul">
<li>Получаем страницу &lt;-&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+
</li>
<li>Проверяем, залогинены ли мы                                   |
<ul class="org-ul">
<li>Если залогинены - отдаем страницу                           |
</li>
<li>Если не залогинены - логинимся и получаем страницу снова.&#x2014;+
<ul class="org-ul">
<li>Если во время логина произошла ошибка - сигнализируем условие.
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Есть также одна особенность (типа баг) в результате которой drakma неправильно
воспринимает сформированные в get-запросе параметры и говорит что URI malformed. Мы
обходим это с помощью глобального флага <code>*need-start*</code>, что является временным
решением.
</p>

<p>
Если сервер возвращает 404 ошибку, функция сигнализирует condition <code>hh-404-error</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_get_page">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;hh_recovery_login&gt;&gt;

(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">hh-404-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((url  <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:url</span> <span style="color: #5f5f87;">:reader</span> url)
   (text <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:text</span> <span style="color: #5f5f87;">:reader</span> text)))

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*need-start*</span> t)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">hh-get-page</span> (url cookie-jar src-account referer)
  <span style="color: #87005f;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;"</span>
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1045;&#1089;&#1083;&#1080; &#1085;&#1080; &#1086;&#1076;&#1085;&#1086;&#1075;&#1086; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1072; &#1077;&#1097;&#1077; &#1085;&#1077; &#1073;&#1099;&#1083;&#1086; - &#1089;&#1076;&#1077;&#1083;&#1072;&#1077;&#1084; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089; &#1082; &#1075;&#1083;&#1072;&#1074;&#1085;&#1086;&#1081; &#1080; &#1089;&#1085;&#1080;&#1084;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075;</span>
  (<span style="color: #af00ff;">when</span> *need-start*
    (drakma:http-request <span style="color: #87005f;">"https://spb.hh.ru/"</span> <span style="color: #5f5f87;">:user-agent</span> *user-agent* <span style="color: #5f5f87;">:redirect</span> 10
                         <span style="color: #5f5f87;">:force-binary</span> t     <span style="color: #5f5f87;">:cookie-jar</span> cookie-jar)
    (setf referer <span style="color: #87005f;">"https://spb.hh.ru/"</span>)
    (setf *need-start* nil))
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1044;&#1077;&#1083;&#1072;&#1077;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1081; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;, &#1087;&#1086; &#1091;&#1088;&#1083;&#1091; &#1080;&#1079; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;, &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1103; &#1088;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090; &#1074; response</span>
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1080; &#1086;&#1073;&#1085;&#1086;&#1074;&#1083;&#1103;&#1103; cookie-jar</span>
  (<span style="color: #af00ff;">let</span> ((response   <span style="color: #87005f;">""</span>)
        (repeat-cnt 0))
    (<span style="color: #af00ff;">tagbody</span> repeat
       (<span style="color: #af00ff;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
           (drakma:http-request
            url <span style="color: #5f5f87;">:user-agent</span> *user-agent* <span style="color: #5f5f87;">:force-binary</span> t <span style="color: #5f5f87;">:cookie-jar</span> cookie-jar <span style="color: #5f5f87;">:redirect</span> 10
            <span style="color: #5f5f87;">:additional-headers</span> (append *additional-headers*
                                        `((<span style="color: #87005f;">"Referer"</span> . ,referer))))
         (dbg <span style="color: #87005f;">":hh-get-page: ~A : ~A"</span> status-code url)
         (<span style="color: #af00ff;">when</span> (equal 404 status-code)
           (<span style="color: #ff0000; font-weight: bold;">error</span> 'hh-404-error <span style="color: #5f5f87;">:url</span> url <span style="color: #5f5f87;">:text</span> (flexi-streams:octets-to-string body-or-stream <span style="color: #5f5f87;">:external-format</span> <span style="color: #5f5f87;">:utf-8</span>)))
         (setf response (flexi-streams:octets-to-string body-or-stream <span style="color: #5f5f87;">:external-format</span> <span style="color: #5f5f87;">:utf-8</span>)))
       <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1045;&#1089;&#1083;&#1080; &#1084;&#1099; &#1085;&#1077; &#1079;&#1072;&#1083;&#1086;&#1075;&#1080;&#1085;&#1077;&#1085;&#1099;:</span>
       (<span style="color: #af00ff;">unless</span> (is-logged response)
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084;, &#1085;&#1077; &#1087;&#1088;&#1077;&#1074;&#1099;&#1096;&#1077;&#1085;&#1086; &#1083;&#1080; &#1082;&#1086;&#1083;-&#1074;&#1086; &#1087;&#1086;&#1087;&#1099;&#1090;&#1086;&#1082; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103;</span>
         (<span style="color: #af00ff;">when</span> (&gt; repeat-cnt 3)
           <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1045;&#1089;&#1083;&#1080; &#1080;&#1093; &#1073;&#1086;&#1083;&#1100;&#1096;&#1077; &#1090;&#1088;&#1077;&#1093; - &#1089;&#1080;&#1075;&#1085;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1091;&#1077;&#1084; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091;</span>
           (err <span style="color: #87005f;">"max recovery-login try"</span>))
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1099;&#1090;&#1072;&#1077;&#1084;&#1089;&#1103; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1089;&#1077;&#1089;&#1089;&#1080;&#1102;</span>
         (<span style="color: #af00ff;">multiple-value-bind</span> (recovery-html recovery-cookie-jar)
             (recovery-login src-account)
           (setf response recovery-html)
           (setf cookie-jar recovery-cookie-jar)
           (setf referer <span style="color: #87005f;">"https://spb.hh.ru/account/login"</span>))
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1059;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1095;&#1077;&#1090;&#1095;&#1080;&#1082; &#1087;&#1086;&#1087;&#1099;&#1090;&#1086;&#1082;</span>
         (incf repeat-cnt)
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1088;&#1086;&#1073;&#1091;&#1077;&#1084; &#1079;&#1072;&#1075;&#1088;&#1091;&#1079;&#1080;&#1090;&#1100; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1089;&#1085;&#1086;&#1074;&#1072;</span>
         (<span style="color: #af00ff;">go</span> repeat)))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103;</span>
    (values <span style="color: #af0000;">;; </span><span style="color: #af0000;">(html5-parser:node-to-xmls (html5-parser:parse-html5-fragment response))</span>
            response
            cookie-jar
            url)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/applicant/negotiations?wed=1"</span>
<span style="color: #af0000;">;;              </span><span style="color: #af0000;">(make-instance 'drakma:cookie-jar)</span>
<span style="color: #af0000;">;;              </span><span style="color: #af0000;">"https://spb.hh.ru/")</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-2-2-1"></a>Логин на источник (<code>recovery-login</code>)<br  /><div class="outline-text-5" id="text-1-2-2-1">
<p>
Прежде чем мы получим возможность забирать авторизованную информацию с нашего источника,
нам нужно иметь способ залогиниться на него. В дополнение к этому мы должны отслеживать
момент потери авторизованной сесии и в каждый конкретный момент определять, залогинены ли
мы. Обычно это можно определить по наличию формы для логина на любой загружаемой
странице.
</p>

<p>
Мы хотим в случае обрыва сессии перелогиниваться прозрачно для всего остального
кода, поэтому процедура логина должна вызвываться по необходимости из процедуры
загрузки любой страницы. Также важно обрабатывать ошибки, которые могут произойти
при логине, например, если неверен пароль.
</p>

<p>
Для всех этих целей мы передаем в <code>recovery-login</code> объект <code>src-account</code>, который
содержит все необходимое, чтобы восстановить сессию: логин, пароль и ФИО
пользователя, по которому мы определяем, что успешно залогинились.
</p>

<p>
<code>recovery-login</code> вторым возвращаемым значением возвращает новый cookie-jar,
который нужно использовать для работы внутри сессии.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_recovery_login">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;data_for_account&gt;&gt;

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*user-agent*</span> <span style="color: #87005f;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0"</span>)

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*additional-headers*</span> `((<span style="color: #87005f;">"Accept"</span> . <span style="color: #87005f;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
                                     (<span style="color: #87005f;">"Accept-Language"</span> . <span style="color: #87005f;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
                                     (<span style="color: #87005f;">"Accept-Charset"</span> . <span style="color: #87005f;">"utf-8"</span>)))

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*cookies*</span> nil)  <span style="color: #af0000;">;; </span><span style="color: #af0000;">deprecated, use cookie-jar in closure</span>

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">is-logged</span> (html)
  <span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084; &#1085;&#1072;&#1083;&#1080;&#1095;&#1080;&#1077; &#1074; html &#1073;&#1083;&#1086;&#1082;&#1072; '&#1042;&#1086;&#1081;&#1090;&#1080;'"</span>
  (<span style="color: #af00ff;">let</span> ((res (not (contains html <span style="color: #87005f;">"data-qa=\"mainmenu_loginForm\"&gt;&#1042;&#1086;&#1081;&#1090;&#1080;&lt;/div&gt;"</span>))))
    (dbg <span style="color: #87005f;">":is-logged: ~A"</span> res)
    res))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">get-cookies-alist</span> (cookie-jar)
  <span style="color: #87005f;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; alist &#1089; &#1087;&#1077;&#1095;&#1077;&#1085;&#1100;&#1082;&#1072;&#1084;&#1080; &#1080;&#1079; cookie-jar"</span>
  (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> cookie <span style="color: #5f5f87;">:in</span> (drakma:cookie-jar-cookies cookie-jar) <span style="color: #5f5f87;">:append</span>
     (list (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">recovery-login</span> (src-account)
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1085;&#1072; &#1075;&#1083;&#1072;&#1074;&#1085;&#1091;&#1102; &#1082;&#1072;&#1082; &#1073;&#1091;&#1076;&#1090;&#1086; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1088;&#1072;&#1079;, &#1073;&#1077;&#1079; &#1087;&#1077;&#1095;&#1077;&#1085;&#1077;&#1082;</span>
  (setf drakma:*header-stream* nil)
  (<span style="color: #af00ff;">let*</span> ((start-uri <span style="color: #87005f;">"https://spb.hh.ru/"</span>)
         (cookie-jar (make-instance 'drakma:cookie-jar))
         (additional-headers *additional-headers*)
         (response (drakma:http-request start-uri
                                        <span style="color: #5f5f87;">:user-agent</span> *user-agent*
                                        <span style="color: #5f5f87;">:additional-headers</span> additional-headers
                                        <span style="color: #5f5f87;">:force-binary</span> t
                                        <span style="color: #5f5f87;">:cookie-jar</span> cookie-jar
                                        <span style="color: #5f5f87;">:redirect</span> 10
                                        ))
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">(tree ;; (html5-parser:node-to-xmls ;; !=!</span>
         <span style="color: #af0000;">;;        </span><span style="color: #af0000;">(html5-parser:parse-html5-fragment</span>
         <span style="color: #af0000;">;;         </span><span style="color: #af0000;">(flexi-streams:octets-to-string response :external-format :utf-8)</span>
         <span style="color: #af0000;">;;         </span><span style="color: #af0000;">:dom :xmls</span>
         <span style="color: #af0000;">;;         </span><span style="color: #af0000;">;; )</span>
         <span style="color: #af0000;">;;         </span><span style="color: #af0000;">))</span>
         )
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1091;&#1077;&#1084; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1100; &#1087;&#1077;&#1095;&#1077;&#1085;&#1100;&#1082;&#1080; &#1076;&#1083;&#1103; &#1083;&#1086;&#1075;&#1080;&#1085;&#1072;</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">GMT=3 ;; _xsrf=  ;; hhrole=anonymous ;; hhtoken= ;; hhuid= ;; regions=2 ;; unique_banner_user=</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048; &#1079;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1089; &#1074;&#1086;&#1090;-&#1090;&#1072;&#1082;&#1080;&#1084; &#1075;&#1077;&#1090;-&#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1086;&#1084;:</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">username=avenger-f@ya.ru ;; password=jGwPswRAfU6sKEhVXX ;; backurl=https://spb.hh.ru/ ;; remember=yes ;; action="&#1042;&#1086;&#1081;&#1090;&#1080;" ;; _xsrf=</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">(setf drakma:*header-stream* *standard-output*)</span>
    (<span style="color: #af00ff;">let*</span> ((post-parameters `((<span style="color: #87005f;">"username"</span> . ,(src_login src-account))
                              (<span style="color: #87005f;">"password"</span> . ,(src_password src-account))
                              (<span style="color: #87005f;">"backUrl"</span>  . <span style="color: #87005f;">"https://spb.hh.ru/"</span>)
                              (<span style="color: #87005f;">"remember"</span> . <span style="color: #87005f;">"yes"</span>)
                              (<span style="color: #87005f;">"action"</span>   . <span style="color: #87005f;">"%D0%92%D0%BE%D0%B9%D1%82%D0%B8"</span>)
                              (<span style="color: #87005f;">"_xsrf"</span>    . ,(cdr (assoc <span style="color: #87005f;">"_xsrf"</span> (get-cookies-alist cookie-jar) <span style="color: #5f5f87;">:test</span> #'equal)))))
           (xsrf (cdr (assoc <span style="color: #87005f;">"_xsrf"</span> (get-cookies-alist cookie-jar) <span style="color: #5f5f87;">:test</span> #'equal)))
           (cookie-jar-2 (make-instance 'drakma:cookie-jar
                                        <span style="color: #5f5f87;">:cookies</span> (append (list (make-instance 'drakma:cookie <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"GMT"</span>   <span style="color: #5f5f87;">:value</span> <span style="color: #87005f;">"3"</span> <span style="color: #5f5f87;">:domain</span> <span style="color: #87005f;">"spb.hh.ru"</span>)
                                                               (make-instance 'drakma:cookie <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"_xsrf"</span> <span style="color: #5f5f87;">:value</span> xsrf <span style="color: #5f5f87;">:domain</span> <span style="color: #87005f;">"spb.hh.ru"</span>))
                                                         (remove-if #'(<span style="color: #af00ff;">lambda</span> (x)
                                                                        (equal <span style="color: #87005f;">"crypted_id"</span> (drakma:cookie-name x)))
                                                                    (drakma:cookie-jar-cookies cookie-jar)))))
           (response-2 (drakma:http-request <span style="color: #87005f;">"https://spb.hh.ru/account/login"</span>
                                            <span style="color: #5f5f87;">:user-agent</span> *user-agent*
                                            <span style="color: #5f5f87;">:method</span> <span style="color: #5f5f87;">:post</span>
                                            <span style="color: #5f5f87;">:parameters</span> post-parameters
                                            <span style="color: #5f5f87;">:additional-headers</span> (append *additional-headers* `((<span style="color: #87005f;">"Referer"</span> . ,start-uri)))
                                            <span style="color: #5f5f87;">:cookie-jar</span> cookie-jar-2
                                            <span style="color: #5f5f87;">:force-binary</span> t
                                            <span style="color: #5f5f87;">:redirect</span> 10))
           (html (flexi-streams:octets-to-string response-2 <span style="color: #5f5f87;">:external-format</span> <span style="color: #5f5f87;">:utf-8</span>)))
      (<span style="color: #af00ff;">when</span> (contains html <span style="color: #87005f;">"&#1053;&#1077;&#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1100;&#1085;&#1099;&#1077; &#1080;&#1084;&#1103; &#1080;/&#1080;&#1083;&#1080; &#1087;&#1072;&#1088;&#1086;&#1083;&#1100; - &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1091;&#1081;&#1090;&#1077;, &#1087;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072;, &#1089;&#1085;&#1086;&#1074;&#1072;."</span>)
        (err <span style="color: #87005f;">"login failed"</span>))
      (<span style="color: #af00ff;">when</span> (contains html <span style="color: #87005f;">"&#1063;&#1090;&#1086;-&#1090;&#1086; &#1087;&#1086;&#1096;&#1083;&#1086; &#1085;&#1077; &#1090;&#1072;&#1082;"</span>)
        (err <span style="color: #87005f;">"login error"</span>))
      (<span style="color: #af00ff;">when</span> (contains html (src_fio src-account))
        (<span style="color: #af00ff;">return-from</span> recovery-login
          (values <span style="color: #af0000;">;; </span><span style="color: #af0000;">(html5-parser:node-to-xmls (html5-parser:parse-html5-fragment html))</span>
                  html
                  cookie-jar-2)))
      (err <span style="color: #87005f;">"login exception"</span>))))
</pre>
</div>


<p>
Теперь надо создать хотя бы один логин
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="data_for_account">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*hh_account*</span> (make-srcaccount <span style="color: #5f5f87;">:user_id</span> 1
                                            <span style="color: #5f5f87;">:src_source</span> <span style="color: #87005f;">"hh"</span>
                                            <span style="color: #5f5f87;">:src_login</span> <span style="color: #87005f;">"avenger-f@yandex.ru"</span>
                                            <span style="color: #5f5f87;">:src_password</span> <span style="color: #87005f;">"jGwPswRAfU6sKEhVXX"</span>
                                            <span style="color: #5f5f87;">:src_fio</span> <span style="color: #87005f;">"&#1052;&#1080;&#1093;&#1072;&#1080;&#1083; &#1052;&#1080;&#1093;&#1072;&#1081;&#1083;&#1086;&#1074;&#1080;&#1095; &#1043;&#1083;&#1091;&#1093;&#1086;&#1074;"</span>
                                            <span style="color: #5f5f87;">:state</span> <span style="color: #87005f;">":ACTIVE"</span>))
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> Разбор тизеров вакансий (<code>hh-parse-vacancy-teasers</code>)</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
Функция <code>hh-parse-vacancy-teasers</code> получает на вход html страницы поисковой выдачи
и превращает его в список вакансий. Для этого она выполняет ряд операций, которые
можно поделить не несколько классов:
</p>
<ul class="org-ul">
<li>Преобразование html-кода в дерево s-выражений
</li>
<li>Извлечение из этого дерева части, которая содержит поисковую выдачу
</li>
<li>Преобразование элементов форматирования, таких как div и span в "говорящие"
элементы дерева для повышения читаемости (названия для преобразования извлекаются
из атрибутов <code>class</code> и <code>data-qa</code>
</li>
<li>Преобразование содержимого вакансий в plists, с отнесением отдельных элементов к
разным разделам информации о вакансии (sections)
</li>
<li>Слияние разделов из разных plists и формирование вакансии, которая предавляет
собой 2-х уровневое plist-дерево, в котором первый уровень - ключи разделов, а из
значения представляют собой второй уровень и являются plist-ами
</li>
</ul>

<p>
Типичная вакансия после обработки должна выглядеть примерно так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #5f5f87;">:VACANCY</span>
 (<span style="color: #5f5f87;">:DATE</span> <span style="color: #87005f;">"18&#160;&#1072;&#1074;&#1075;&#1091;&#1089;&#1090;&#1072;"</span>
  <span style="color: #5f5f87;">:ID</span> 22403675
  <span style="color: #5f5f87;">:HREF</span> <span style="color: #87005f;">"https://spb.hh.ru/vacancy/22403675"</span>
  <span style="color: #5f5f87;">:NAME</span> <span style="color: #87005f;">"Senior JavaScript/React &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
 <span style="color: #5f5f87;">:COMPENSATION</span>
 (<span style="color: #5f5f87;">:SALARY-MAX</span> 230000
  <span style="color: #5f5f87;">:SALARY-MIN</span> 230000
  <span style="color: #5f5f87;">:CURRENCY</span> <span style="color: #87005f;">"RUR"</span>
  <span style="color: #5f5f87;">:SALARY</span> <span style="color: #87005f;">"230000"</span>
  <span style="color: #5f5f87;">:SALARY-TEXT</span> <span style="color: #87005f;">"&#1086;&#1090; 230&#160;000 &#1088;&#1091;&#1073;."</span>)
 <span style="color: #5f5f87;">:SHORT-DESCR</span>
 (<span style="color: #5f5f87;">:REQUIREMENT</span> <span style="color: #87005f;">"&#1054;&#1087;&#1099;&#1090; Frontend &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080; &#1086;&#1090; 3 &#1083;&#1077;&#1090;. &#1054;&#1087;&#1099;&#1090; &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080; SPA &#1085;&#1072; React. &#1054;&#1087;&#1099;&#1090; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; &#1089; Redux &#1080; &#1076;&#1088;&#1091;&#1075;&#1080;&#1084;&#1080; &#1084;&#1086;&#1076;&#1091;&#1083;&#1103;&#1084;&#1080; &#1101;&#1082;&#1086;&#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; React..."</span>
  <span style="color: #5f5f87;">:RESPONSIBILITY</span> <span style="color: #87005f;">"&#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072; &#1073;&#1086;&#1083;&#1100;&#1096;&#1086;&#1075;&#1086; SPA &#1087;&#1088;&#1080;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1085;&#1072; React. &#1059;&#1095;&#1072;&#1089;&#1090;&#1080;&#1077; &#1074; &#1072;&#1088;&#1093;&#1080;&#1090;&#1077;&#1082;&#1090;&#1091;&#1088;&#1085;&#1099;&#1093; &#1080; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093; &#1088;&#1077;&#1096;&#1077;&#1085;&#1080;&#1103;&#1093;. &#1054;&#1094;&#1077;&#1085;&#1082;&#1072; &#1089;&#1083;&#1086;&#1078;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081; &#1080; &#1089;&#1088;&#1086;&#1082;&#1086;&#1074; &#1088;&#1077;&#1072;&#1083;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080; &#1079;&#1072;&#1076;&#1072;&#1095;. "</span>)
 <span style="color: #5f5f87;">:COMPANY</span>
 (<span style="color: #5f5f87;">:ADDR</span> <span style="color: #87005f;">"&#1057;&#1072;&#1085;&#1082;&#1090;-&#1055;&#1077;&#1090;&#1077;&#1088;&#1073;&#1091;&#1088;&#1075;"</span>
  <span style="color: #5f5f87;">:EMP-NAME</span> <span style="color: #87005f;">"&#1054;&#1054;&#1054; &#1057;&#1084;&#1072;&#1088;&#1090;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;"</span>
  <span style="color: #5f5f87;">:HREF</span> <span style="color: #87005f;">"/employer/2959988"</span>))
</pre>
</div>

<p>
Технические подробности о трансформации дерева - далее в этом разделе:
Трансформация дерева]]
</p>

<p>
Если в вакансии указана зарплата, мы также получаем
</p>
<ul class="org-ul">
<li>Валюту зарплаты (3х-буквенный идентификатор)
</li>
<li>Сумму
</li>
<li>Текстовое выражение, содержащее "от" или "от и до"
</li>
</ul>

<p>
Иногда HeadHunter синдицирует вакансии с других платформ, к примеру с CAREER.RU, тогда в
вакансии может отсутствовать работодатель.
</p>

<p>
Вот код преобразования, все вещи, от которых он зависит будут раскрыты в
подразделах этого раздела.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy_teasers">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;maptree_transform&gt;&gt;

&lt;&lt;html_to_tree&gt;&gt;

&lt;&lt;extract_search_results&gt;&gt;

&lt;&lt;maptreefilter&gt;&gt;

&lt;&lt;make_detect&gt;&gt;

&lt;&lt;teaser_detectors&gt;&gt;

&lt;&lt;plistp&gt;&gt;

&lt;&lt;my_merge_plist&gt;&gt;

&lt;&lt;tree_plist_p&gt;&gt;

&lt;&lt;compactor&gt;&gt;

(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">malformed-vacancy</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((text <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:text</span> <span style="color: #5f5f87;">:reader</span> text)))

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*last-parse-data*</span> nil)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy-teasers</span> (html)
  <span style="color: #87005f;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080;&#1079; html"</span>
  (dbg <span style="color: #87005f;">":hh-parse-vacancy-teasers:"</span>)
  (setf *last-parse-data* html)
  (-&gt;&gt; (html-to-tree html)
       (extract-search-results)
       (maptreefilter)
       (detect-responder)
       (detect-rejecter)
       (detect-title)
       (detect-or-title-archived)
       (detect-schedule)
       (detect-responsibility)
       (detect-requirement)
       (detect-insider-teaser)
       (detect-company)
       (detect-company-anon)
       (detect-addr)
       (detect-compensation)
       (detect-teaser-finalizer)
       (mapcar #'(<span style="color: #af00ff;">lambda</span> (vacancy)
                   (<span style="color: #af00ff;">if</span> (not (tree-plist-p vacancy))
                       (<span style="color: #af00ff;">progn</span>
                         (dbg <span style="color: #87005f;">"[~A]"</span> (bprint vacancy))
                         <span style="color: #af0000;">;; </span><span style="color: #af0000;">error if malformed plist</span>
                         (<span style="color: #ff0000; font-weight: bold;">error</span> 'malformed-vacancy <span style="color: #5f5f87;">:text</span>))
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">else</span>
                       (compactor vacancy)
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">vacancy</span>
                       )))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print (hh-parse-vacancy-teasers *last-parse-data*))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(hh-parse-vacancy-teasers</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;salary=&amp;currency_code=RUR&amp;only_with_salary=true&amp;experience=doesNotMatter&amp;order_by=salary_desc&amp;search_period=30&amp;items_on_page=100&amp;no_magic=true" temp-cookie-jar "https://spb.hh.ru/")))</span>


<span style="color: #af0000;">;; </span><span style="color: #af0000;">(mapcar #'(lambda (x)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(del-vacancy (id x)))</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(find-vacancy :state ":UNINTERESTING"))</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-2-3-1"></a>Парсер html-to-tree<br  /><div class="outline-text-5" id="text-1-2-3-1">
<p>
Чтобы получить вакансии со страниц поисковой выдачи - напишем парсер,
который переведет полученный html в более удобное лисп-дерево (<code>html-to-tree</code>)
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_to_tree">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">html-to-tree</span> (html)
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(html5-parser:node-to-xmls</span>
  (html5-parser:parse-html5-fragment html <span style="color: #5f5f87;">:dom</span> <span style="color: #5f5f87;">:xmls</span>
                                     ))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-2"></a>Экстрактор поисковых результатов extract<sub>search</sub><sub>results</sub><br  /><div class="outline-text-5" id="text-1-2-3-2">
<p>
Затем нам понадобится отделить собственно поисковые результаты, с которыми будем
работать:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="extract_search_results">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">extract-search-results</span> (tree)
  (<span style="color: #af00ff;">block</span> subtree-extract
    (mtm (`(<span style="color: #87005f;">"div"</span>
            ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"search-result"</span>)
             (<span style="color: #87005f;">"data-qa"</span> <span style="color: #87005f;">"vacancy-serp__results"</span>))
            ,@rest)
           (<span style="color: #af00ff;">return-from</span> subtree-extract rest))
         tree)))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-3"></a>Фильтр-преобразователь дерева maptreefilter<br  /><div class="outline-text-5" id="text-1-2-3-3">
<p>
Поисковые результаты представляют собой список деревьев, внутри которых много кода,
относящегося к разметке. Из-за этого их сложно читать и анализировать. Но можно
преобразовать эти деревья в более удобные для анализа, следуя следующему алгоритму:
</p>

<ul class="org-ul">
<li>Проходя по каждому элементу дерева
<ul class="org-ul">
<li>Если элемент является списком
<ul class="org-ul">
<li>Если элемент - это '("target" "<sub>blank</sub>"), то удаляем его, записывая остаток
списка (cdr) на его место, потому что этот элемент не несет никакой нужной
нам информации.
</li>
<li>Если элемент начинается с "script" (т.е. мы обоснованно предполагаем, что это
тег &lt;script&gt;, потому что нигде не употребляется атрибут "script"), то
поступаем аналогично, удаляя его
</li>
<li>Если элемент начинается с "div" "span" или "a", то для начала отделим
атрибуты от его содержимого.
<ul class="org-ul">
<li>Если существует атрибут "data-qa", то он станет новым именем элемента, в
противном случае
<ul class="org-ul">
<li>Если существует атрибут "class", то он будет новым именем элемента.
</li>
</ul>
</li>
<li>Если есть новое имя элемента:
<ul class="org-ul">
<li>Существуют блоки с именами, которые нам полностью неинтересны, поэтому мы
можем прямо здесь заменить их на их строковые имена, чтобы сделать все более
читаемым. Если мы нашли такой блок - то сделаем это. В противном случае:
<ul class="org-ul">
<li>Удалим атрибуты "data-qa" и "class" из списка атрибутов
</li>
<li>Запишем новое имя элемента на место "div" или "span"
</li>
<li>Запишем обновленные атрибуты на место старых
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Реализуем этот алгоритм. Для поиска атрибутов будем использовать функцию
<code>get-attr</code>, которая превращает атрибуты в plist и ищет в нем.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="maptreefilter">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">attrs-to-plist</span> (attrs)
  (mapcan #'(<span style="color: #af00ff;">lambda</span> (x)
              (list (intern (string-upcase (car x)) <span style="color: #5f5f87;">:keyword</span>) (cadr x)))
          attrs))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(attrs-to-plist '(("href" "/employer/3127") ("class" "bloko-link bloko-link_secondary")</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">("data-qa" "vacancy-serp__vacancy-employer")))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (:HREF "/employer/3127" :CLASS "bloko-link bloko-link_secondary" :DATA-QA</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">"vacancy-serp__vacancy-employer")</span>

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">plist-to-attrs</span> (attrs)
  (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> attr <span style="color: #5f5f87;">:in</span> attrs <span style="color: #5f5f87;">:by</span> #'cddr <span style="color: #5f5f87;">:collect</span>
     (list (string-downcase (symbol-name attr)) (getf attrs attr))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(plist-to-attrs '(:HREF "/employer/3127" :CLASS "bloko-link bloko-link_secondary" :DATA-QA</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">"vacancy-serp__vacancy-employer"))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (("href" "/employer/3127") ("class" "bloko-link bloko-link_secondary")</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">("data-qa" "vacancy-serp__vacancy-employer"))</span>

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">maptreefilter</span> (tree)
  (<span style="color: #af00ff;">when</span> (listp tree)
    (<span style="color: #af00ff;">when</span> (and (listp (car tree)) (equal '(<span style="color: #87005f;">"target"</span> <span style="color: #87005f;">"_blank"</span>) (car tree)))
      (setf tree (cdr tree)))
    (<span style="color: #af00ff;">when</span> (and (listp (car tree)) (equal <span style="color: #87005f;">"script"</span> (caar tree)))
      (setf tree (cdr tree)))
    (<span style="color: #af00ff;">when</span> (and (listp (car tree)) <span style="color: #af0000;">;; </span><span style="color: #af0000;">fix error if car is not list</span>
               (or (equal <span style="color: #87005f;">"div"</span> (caar tree))
                   (equal <span style="color: #87005f;">"span"</span> (caar tree))
                   (equal <span style="color: #87005f;">"a"</span> (caar tree))
                   (equal <span style="color: #87005f;">"td"</span> (caar tree))
                   (equal <span style="color: #87005f;">"th"</span> (caar tree))
                   (equal <span style="color: #87005f;">"table"</span> (caar tree))
                   ))
      (<span style="color: #af00ff;">let</span> ((attrs (attrs-to-plist (cadar tree)))
            (rest  (cddar tree))
            (name   nil))
        <span style="color: #af0000;">;; </span><span style="color: #af0000;">data-qa is primary target for new name</span>
        (aif (getf attrs <span style="color: #5f5f87;">:data-qa</span>)
             (<span style="color: #af00ff;">progn</span>
               (setf name it))
             <span style="color: #af0000;">;; </span><span style="color: #af0000;">else: class is secondary target for new name</span>
             (aif (getf attrs <span style="color: #5f5f87;">:class</span>)
                  (<span style="color: #af00ff;">progn</span>
                    (setf name it))))
        (<span style="color: #af00ff;">when</span> name
          (<span style="color: #af00ff;">if</span> (or (equal name <span style="color: #87005f;">"search-result-description__item"</span>)
                  (equal name <span style="color: #87005f;">"search-result-item__control"</span>))
              <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1059;&#1073;&#1080;&#1074;&#1072;&#1077;&#1084; &#1085;&#1077;&#1085;&#1091;&#1078;&#1085;&#1086;&#1077;, &#1077;&#1089;&#1083;&#1080; &#1086;&#1085;&#1086; &#1077;&#1089;&#1090;&#1100;</span>
              (setf (car tree) name)
              <span style="color: #af0000;">;; </span><span style="color: #af0000;">else</span>
              (<span style="color: #af00ff;">progn</span>
                (remf attrs <span style="color: #5f5f87;">:data-qa</span>)
                (remf attrs <span style="color: #5f5f87;">:class</span>)
                (setf (caar tree) name) <span style="color: #af0000;">;; </span><span style="color: #af0000;">new name</span>
                (setf (cadar tree) (plist-to-attrs attrs)) <span style="color: #af0000;">;; </span><span style="color: #af0000;">new attrs</span>
                ))))))
  (<span style="color: #af00ff;">cond</span>
    ((null tree) nil)
    ((atom tree) tree)
    (t (cons (maptreefilter (car tree))
             (maptreefilter (cdr tree))))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-4"></a>Макрос для создания шаблонных преобразователей make-detect<br  /><div class="outline-text-5" id="text-1-2-3-4">
<p>
Этот макрос формирует функции вида detect-* которые осуществляют преобразование
дерева в соответствии с шаблоном, переданным в body
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_detect">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">make-detect</span> ((name) <span style="color: #008700;">&amp;body</span> body)
  (<span style="color: #af00ff;">let</span> ((param   (gensym)))
    `(<span style="color: #af00ff;">defun</span> ,(intern (format nil <span style="color: #87005f;">"DETECT-~A"</span> (string-upcase (symbol-name name)))) (,param)
       (mtm ,@body
            ,param))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-5"></a>Набор шаблонных макросов-преобразователей для тизеров<br  /><div class="outline-text-5" id="text-1-2-3-5">
<p>
Эти макросы по шаблону преобразуют тизер вакансии в plist
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="teaser_detectors">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(make-detect (responder)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy_responded"</span>
     ((<span style="color: #87005f;">"href"</span> ,_)) <span style="color: #87005f;">"&#1042;&#1099; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1083;&#1080;&#1089;&#1100;"</span>)
    `(<span style="color: #5f5f87;">:teaser</span> (<span style="color: #5f5f87;">:status</span> <span style="color: #87005f;">"responded"</span>))))

(make-detect (rejecter)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy_rejected"</span>
     ((<span style="color: #87005f;">"href"</span> <span style="color: #87005f;">"/negotiations/gotopic?vacancy_id=20255184"</span>)) <span style="color: #87005f;">"&#1042;&#1072;&#1084; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;&#1080;"</span>)
    `(<span style="color: #5f5f87;">:teaser</span> (<span style="color: #5f5f87;">:status</span> <span style="color: #87005f;">"rejected"</span>))))

(make-detect (title)
  (`(<span style="color: #87005f;">"search-result-item__head"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-serp__vacancy-title"</span>
      ((<span style="color: #87005f;">"href"</span> ,href) ,@rest)
      ,title))
    `(<span style="color: #5f5f87;">:teaser</span> (<span style="color: #5f5f87;">:id</span> ,(parse-integer (car (last (split-sequence:split-sequence #\/ href))))
                    <span style="color: #5f5f87;">:href</span> ,href
                    <span style="color: #5f5f87;">:name</span> ,title
                    <span style="color: #5f5f87;">:archived</span> nil))))

(make-detect (or-title-archived)
  (`(<span style="color: #87005f;">"search-result-item__head"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-serp__vacancy-title"</span>
      ((<span style="color: #87005f;">"href"</span> ,href) ,@rest)
      ,title)
     <span style="color: #87005f;">" ("</span>
     (<span style="color: #87005f;">"strong"</span> ((<span style="color: #87005f;">"data-qa"</span> <span style="color: #87005f;">"vacancy-serp__vacancy_archived"</span>))
               <span style="color: #87005f;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103; &#1073;&#1099;&#1083;&#1072; &#1087;&#1077;&#1088;&#1077;&#1085;&#1077;&#1089;&#1077;&#1085;&#1072; &#1074; &#1072;&#1088;&#1093;&#1080;&#1074;"</span>)
     <span style="color: #87005f;">")"</span>)
    `(<span style="color: #5f5f87;">:teaser</span> (<span style="color: #5f5f87;">:id</span> ,(parse-integer (car (last (split-sequence:split-sequence #\/ href))))
                    <span style="color: #5f5f87;">:href</span> ,href
                    <span style="color: #5f5f87;">:name</span> ,title
                    <span style="color: #5f5f87;">:archived</span> t))))

(make-detect (schedule)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy-work-schedule"</span>
     NIL ,schedule)
    `(<span style="color: #5f5f87;">:teaser-conditions</span> (<span style="color: #5f5f87;">:schedule</span> schedule))))

(make-detect (responsibility)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy_snippet_responsibility"</span>
     NIL
     ,responsibility)
    `(<span style="color: #5f5f87;">:teaser-descr</span> (<span style="color: #5f5f87;">:responsibility</span> ,responsibility))))

(make-detect (requirement)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy_snippet_requirement"</span>
     NIL
     ,requirement)
    `(<span style="color: #5f5f87;">:teaser-descr</span> (<span style="color: #5f5f87;">:requirement</span> ,requirement))))

(make-detect (insider-teaser)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy-interview-insider"</span>
     ((<span style="color: #87005f;">"href"</span> ,insider))
     <span style="color: #87005f;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>)
    `(<span style="color: #5f5f87;">:teaser-descr</span> (<span style="color: #5f5f87;">:insider</span> ,insider))))

(make-detect (company)
  (`(<span style="color: #87005f;">"search-result-item__company"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-serp__vacancy-employer"</span>
      ((<span style="color: #87005f;">"href"</span> ,href))
      ,emp-name)
     ,@rest)
    `(<span style="color: #5f5f87;">:teaser-emp</span>
      (<span style="color: #5f5f87;">:emp-name</span> ,emp-name
       <span style="color: #5f5f87;">:href</span> ,href
       <span style="color: #5f5f87;">:emp-id</span> ,(parse-integer
                 (car (last (split-sequence:split-sequence #\/ href))) <span style="color: #5f5f87;">:junk-allowed</span> t)))))

(make-detect (company-anon)
  (`(<span style="color: #87005f;">"search-result-item__company"</span>
     NIL
     ,anon
     ,@rest)
    `(<span style="color: #5f5f87;">:teaser-emp</span> (<span style="color: #5f5f87;">:emp-name</span> ,anon <span style="color: #5f5f87;">:anon</span> t))))

(make-detect (addr)
  (`(<span style="color: #87005f;">"search-result-item__info"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-serp__vacancy-address"</span> NIL ,address ,@restaddr) <span style="color: #87005f;">"&#160;&#160;&#8226;&#160;&#160;"</span>
     (<span style="color: #87005f;">"vacancy-serp__vacancy-date"</span> NIL ,date)
     ,@rest)
    `(<span style="color: #5f5f87;">:teaser-emp</span> (<span style="color: #5f5f87;">:addr</span> ,address)
      <span style="color: #5f5f87;">:teaser</span> (<span style="color: #5f5f87;">:date</span> ,date))))

(make-detect (compensation)
  (`(<span style="color: #87005f;">"vacancy-serp__vacancy-compensation"</span>
     NIL
     (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"salaryCurrency"</span>) (<span style="color: #87005f;">"content"</span> ,currency)))
     (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"baseSalary"</span>) (<span style="color: #87005f;">"content"</span> ,salary)))
     ,salary-text)
    (<span style="color: #af00ff;">let</span> ((currency currency)
          (salary-text (ppcre:regex-replace-all <span style="color: #87005f;">"&#160;"</span> salary-text <span style="color: #87005f;">""</span>))
          (salary-min nil)
          (salary-max nil))
      (<span style="color: #af00ff;">cond</span> ((equal currency <span style="color: #87005f;">"RUR"</span>)
             (setf salary-text (ppcre:regex-replace-all <span style="color: #87005f;">" &#1088;&#1091;&#1073;."</span> salary-text <span style="color: #87005f;">""</span>)))
            ((equal currency <span style="color: #87005f;">"USD"</span>)
             (setf salary-text (ppcre:regex-replace-all <span style="color: #87005f;">" USD"</span> salary-text <span style="color: #87005f;">""</span>)))
            ((equal currency <span style="color: #87005f;">"EUR"</span>)
             (setf salary-text (ppcre:regex-replace-all <span style="color: #87005f;">" EUR"</span> salary-text <span style="color: #87005f;">""</span>)))
            ((equal currency <span style="color: #87005f;">"UAH"</span>)
             (setf salary-text (ppcre:regex-replace-all <span style="color: #87005f;">" &#1075;&#1088;&#1085;."</span> salary-text <span style="color: #87005f;">""</span>)))
            ((equal currency nil)
             'nil)
            (t (<span style="color: #af00ff;">progn</span>
                 (print currency)
                 (err 'unk-currency))))
      (<span style="color: #af00ff;">cond</span> ((search <span style="color: #87005f;">"&#1086;&#1090; "</span> salary-text)
             (setf salary-min (parse-integer (ppcre:regex-replace-all <span style="color: #87005f;">"&#1086;&#1090; "</span> salary-text <span style="color: #87005f;">""</span>))))
            ((search <span style="color: #87005f;">"&#1076;&#1086; "</span> salary-text)
             (setf salary-max (parse-integer (ppcre:regex-replace-all <span style="color: #87005f;">"&#1076;&#1086; "</span> salary-text <span style="color: #87005f;">""</span>))))
            ((search <span style="color: #87005f;">"&#8211;"</span> salary-text)
             (<span style="color: #af00ff;">let</span> ((splt (ppcre:split <span style="color: #87005f;">"&#8211;"</span> salary-text)))
               (setf salary-min (parse-integer (car splt)))
               (setf salary-max (parse-integer (cadr splt)))))
            ((search <span style="color: #87005f;">"-"</span> salary-text)
             (<span style="color: #af00ff;">let</span> ((splt (ppcre:split <span style="color: #87005f;">"-"</span> salary-text)))
               (setf salary-min (parse-integer (car splt)))
               (setf salary-max (parse-integer (cadr splt))))))
      (<span style="color: #af00ff;">when</span> (null salary-min)
        (setf salary-min salary-max))
      (<span style="color: #af00ff;">when</span> (null salary-max)
        (setf salary-max salary-min))
      `(<span style="color: #5f5f87;">:teaser-compensation</span> (<span style="color: #5f5f87;">:currency</span> ,currency <span style="color: #5f5f87;">:salary</span> ,salary <span style="color: #5f5f87;">:salary-text</span> ,salary-text
                                        <span style="color: #5f5f87;">:salary-min</span> ,salary-min <span style="color: #5f5f87;">:salary-max</span> ,salary-max)))))

(make-detect (teaser-finalizer)
  (`(,_
     NIL
     ,_
     (<span style="color: #87005f;">"search-result-description"</span>
      NIL
      <span style="color: #87005f;">"search-result-description__item"</span>
      (<span style="color: #87005f;">"search-result-description__item search-result-description__item_primary"</span>
       NIL
       ,@contents)
      ,@rest))
    contents))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-6"></a>Plistp<br  /><div class="outline-text-5" id="text-1-2-3-6">
<p>
Это функция-предикат, которая возвращает свой параметр, если он является
правильным plist и NIL в противном случае.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="plistp">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">plistp</span> (param)
  <span style="color: #87005f;">"Test wheather PARAM is a properly formed pparam."</span>
  (<span style="color: #af00ff;">when</span> (listp param)
    (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> rest <span style="color: #5f5f87;">:on</span> param <span style="color: #5f5f87;">:by</span> #'cddr
       <span style="color: #5f5f87;">:unless</span> (and (keywordp (car rest))
                    (cdr rest))
       <span style="color: #5f5f87;">:do</span> (<span style="color: #af00ff;">return</span> nil)
       <span style="color: #5f5f87;">:finally</span> (<span style="color: #af00ff;">return</span> param))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-7"></a>my<sub>merge</sub><sub>plist</sub><br  /><div class="outline-text-5" id="text-1-2-3-7">
<p>
Это функция, которая правильным образом сливает вместе два plist-а
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="my_merge_plist">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">my-merge-plists</span> (p1 p2)
  (<span style="color: #af00ff;">loop</span> with notfound <span style="color: #af00ff;">=</span> '#<span style="color: #5f5f87;">:notfound</span>
     for (indicator value) on p1 by #'cddr
     when (eq (getf p2 indicator notfound) notfound)
     do (<span style="color: #af00ff;">progn</span>
          (push value p2)
          (push indicator p2)))
  p2)
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-8"></a>tree-plist-p<br  /><div class="outline-text-5" id="text-1-2-3-8">
<p>
Это функция возвращает T если список, переданный в параметре является правильным
plist-деревом.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="tree_plist_p">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tree-plist-p</span> (pl)
  <span style="color: #87005f;">"Returns T if PL is a plist (list with alternating keyword elements). "</span>
  (<span style="color: #af00ff;">cond</span> ((null pl)                 t)
        ((and (listp pl)
              (keywordp (car pl))
              (cdr pl))            (tree-plist-p (cddr pl)))
        ((and (listp pl)
              (listp (car pl)))    (and (tree-plist-p (car pl))
                                        (tree-plist-p (cdr pl))))
        (t                         (<span style="color: #af00ff;">progn</span>
                                     <span style="color: #af0000;">;; </span><span style="color: #af0000;">(print pl)</span>
                                     nil))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-9"></a>compactor<br  /><div class="outline-text-5" id="text-1-2-3-9">
<p>
Эта функция проходит по каждому элементу plist-tree, которое передано в
параметре. Каждый элемент оценивается, и разделяется на имя секции и значение. Все
элементы у которых одинаковое имя секции помещаются в эту секцию. Таким образом
осуществляется перегруппировка входных данных
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="compactor">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">compactor</span> (param)
  (<span style="color: #af00ff;">let</span> ((ht  (make-hash-table <span style="color: #5f5f87;">:test</span> #'equal))
        (result-vacancy))
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (section)
                (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (logand (length section) 1) 0)) <span style="color: #af0000;">;; </span><span style="color: #af0000;">even length</span>
                (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> key <span style="color: #5f5f87;">:in</span> section <span style="color: #5f5f87;">:by</span> #'cddr <span style="color: #5f5f87;">:do</span>
                   (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (type-of key) 'keyword))
                   (<span style="color: #af00ff;">let</span> ((new-val (getf section key)))
                     (<span style="color: #ff0000; font-weight: bold;">assert</span> (plistp new-val))
                     (<span style="color: #af00ff;">multiple-value-bind</span> (old-val present)
                         (gethash key ht)
                       (setf (gethash key ht)
                             (<span style="color: #af00ff;">if</span> (not present)
                                 new-val
                                 (my-merge-plists old-val new-val)))))))
            param)
    (maphash #'(<span style="color: #af00ff;">lambda</span> (k v) (push (list k v) result-vacancy)) ht)
    (mapcan #'identity (reverse result-vacancy))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-10"></a>Трансформация дерева<br  /><div class="outline-text-5" id="text-1-2-3-10">
<p>
Описание вакансии (или ее тизера), после преобразования из html, представляет из себя
дерево, в котором нам важна структура, так как требования, обязанности и прочее
описываются списком. В этом списке много лишнего форматирования, для удаления которого
нам необходимо уметь преобразовывать (трансформировать) дерево.
</p>
</div>

<ol class="org-ol"><li><a id="sec-1-2-3-10-1"></a>Match-tree<br  /><div class="outline-text-6" id="text-1-2-3-10-1">
<p>
Чтобы эффективнее (с точки зрения скорости написания кода) разбирать вакансии мы
разберем всю полученную страницу в дерево, из которого будем извлекать необходимые нам
элементы.
</p>

<p>
Чтобы делать это будем обходить дерево, сопоставляя каждый узел с предикатом, в
который скомпилируется образец. Начнем с обхода дерева, для этого напишем рекурсивную
функцию <code>match-tree</code>, которую определим с помощью <code>labels</code>, чтобы окружить ее формой
<code>let</code> с аккумулятором.
</p>

<p>
Определим параметры этой функции:
</p>
<ul class="org-ul">
<li><code>tree</code> - под-дерево, которое мы рекурсивно обходим
</li>
<li><code>predict</code> - функция-предикат, которая может совпасть с обходимым поддеревом
</li>
<li><code>if-match</code> - параметр чтобы иметь возможность передавать <code>стратегию</code>. Про стратегии
поговорим чуть позже.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_tree">(<span style="color: #af00ff;">labels</span> ((match-tree (tree f-predict <span style="color: #008700;">&amp;optional</span> (if-match <span style="color: #5f5f87;">:return-first-match</span>))
         (<span style="color: #af00ff;">cond</span> ((null tree) nil)
               ((atom tree) nil)
               (t
                &lt;&lt;cons&gt;&gt;))))
  &lt;&lt;call&gt;&gt;)
</pre>
</div>

<p>
Теперь переходим к рассмотрению плейсхолдера <code>cons</code>, который выполняет основную
работу. В первую очередь нам следует сравнить текущий узел с параметром <code>predict</code> и в
случае если <code>predict</code> вернул T - выполнить какие-то действия. В противном случае -
обрабатываем поддеревья этого узла.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cons">(<span style="color: #af00ff;">if</span> (funcall f-predict tree)
    &lt;&lt;match_ok&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="sub_trees">(cons
 (funcall #'match-tree (car tree) f-predict if-match)
 (funcall #'match-tree (cdr tree) f-predict if-match))
</pre>
</div>

<p>
<b>Теперь о стратегиях</b>
</p>

<p>
В случае, когда узел совпал с <code>predict</code> мы можем реализовать следующие стратегии:
</p>
<ul class="org-ul">
<li>Немедленно вернуть совпавший узел и более не обрабатывать никакие узлы.
</li>
<li>Прекратить обработку всех подузлов совпавшего узла, запомнить его и перейти к
обработке следующего за ним.
</li>
<li>Запомнить совпавший узел и продолжить обработку вглубь совпавшего узла, а затем и
всех остальных узлов.
</li>
<li>Наиболее общий вариант - применить к сопавшему узлу переданную лямбда-функцию,
которая может с ним что-то сделать - например записать в какую-нибудь переменную на
более высоком уровне.
</li>
</ul>
<p>
Реализуем эти стратегии друг за другом.
</p>

<p>
Реализуем выбор стратегии в общих чертах - будем использовать <code>cond</code> по параметру
<code>if-match</code>. В случае, если в этом параметре не лежит keyword symbol с именем
стратегии - считаем, что там функция, если это не так - сигнализируем ошибку
<code>strategy-not-implemented</code> (которая пока нигде не определена - я считаю что ее имя
говорит само за себя).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="match_ok">(<span style="color: #af00ff;">cond</span> ((equal if-match <span style="color: #5f5f87;">:return-first-match</span>)
       &lt;&lt;return_first_match&gt;&gt;)
      ((equal if-match <span style="color: #5f5f87;">:return-first-level-match</span>)
       &lt;&lt;return_first_level_match&gt;&gt;)
      ((equal if-match <span style="color: #5f5f87;">:return-all-match</span>)
       &lt;&lt;return_all_match&gt;&gt;)
      ((equal 'function (type-of if-match))
       (funcall if-match tree))
      (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'strategy-not-implemented)))
</pre>
</div>

<p>
Теперь приступим к реализации (первой) стратегии: немедленного возврата совпавшего
узла. Для этого нам понадобится определить внешнюю функцию <code>tree-match</code>, чтобы
возвращаться из нее, а не из текущего рекурсивного вызова <code>match-tree</code>. Мы сделаем это
несколько позже, а пока заполним плейсхолдер <code>return-first-match</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_match">(<span style="color: #af00ff;">return-from</span> tree-match tree)
</pre>
</div>

<p>
Теперь переходим ко второй стратегии - прекратить обработку всех подузлов сопавшего
узла, запомнить его и перейти к обработке следующего за ним. Нам понадобится
переменная <code>collect</code> чтобы хранить значения, запомним это и реализуем добавление узла
в нее. После того, как узел сохранен, мы не проводим обработку его под-деревьев, а
переходим в следующему узлу этого уровня.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_level_match">(setf collect
      (append collect (list tree)))
</pre>
</div>

<p>
И наконец, реализуем последнюю оставшуюся стратегию, которая представляет из себя
расширение предыдущей, но с обработкой вложенных узлов. Так и запишем:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_all_match">(<span style="color: #af00ff;">progn</span>
    &lt;&lt;return_first_level_match&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<p>
Теперь нам осталось лишь правильно возвращать результат. Если используются
аккумулирующие стратегии, то мы возвращаем содержимое переменной <code>collect</code>, в случае
немедленного возврата совпавшего узла мы никогда не окажемся в этом месте, а в случае
передачи в <code>if-match</code> лямбда-фукции - мы будем считать, что она как-нибудь сама
заботится о передачи значений. Поэтому всегда будем возвращать <code>collect</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="call">(match-tree tree predict if-match)
collect
</pre>
</div>

<p>
Осталось обернуть это все во внешнюю функцию, с аккумулятором:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="tree_match">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tree-match</span> (tree predict <span style="color: #008700;">&amp;optional</span> (if-match <span style="color: #5f5f87;">:return-first-match</span>))
  (<span style="color: #af00ff;">let</span> ((collect))
    &lt;&lt;cond_tree&gt;&gt;))
</pre>
</div>

<p>
Но для удобной работы этого недостаточно, поэтому напишем компилер шаблона в
соответствующий ему <code>predict</code>. Этот компилер будет принимать в качестве параметра
форму, которая будет связываться с элементами шаблона с помощью
<code>destructuring-bind</code>. Попытка связывания будет проводиться для каждого элемента
дерева. Ошибки, которые возникают в случае невозможности связывания, игнорируются.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-predict</span> (pattern <span style="color: #008700;">&amp;body</span> body)
  (<span style="color: #af00ff;">let</span> ((lambda-param (gensym)))
    `#'(<span style="color: #af00ff;">lambda</span> (,lambda-param)
         (<span style="color: #af00ff;">handler-case</span>
             (<span style="color: #af00ff;">destructuring-bind</span> ,pattern
                 ,lambda-param
               ,@body)
           (sb-kernel::arg-count-error nil)
           (sb-kernel::defmacro-bogus-sublist-error nil)))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1 '</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(with-predict (a ((b c)) d &amp;rest e)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(aif (and (string= a "div")</span>
<span style="color: #af0000;">;;              </span><span style="color: #af0000;">(string= c "title b-vacancy-title"))</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(prog1 it</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(setf **a** a)</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(setf **b** b)))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; #'(LAMBDA (LAMBDA-PARAM)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(HANDLER-CASE</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(DESTRUCTURING-BIND</span>
<span style="color: #af0000;">;;                  </span><span style="color: #af0000;">(A ((B C)) D &amp;REST E)</span>
<span style="color: #af0000;">;;                </span><span style="color: #af0000;">LAMBDA-PARAM</span>
<span style="color: #af0000;">;;              </span><span style="color: #af0000;">(AIF (AND (STRING= A "div") (STRING= C "title b-vacancy-title"))</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">(PROG1 IT (SETF **A** A) (SETF **B** B))))</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">(SB-KERNEL::ARG-COUNT-ERROR NIL)</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">(SB-KERNEL::DEFMACRO-BOGUS-SUBLIST-ERROR NIL))), T</span>
</pre>
</div>

<p>
Вот так, к примеру, это можно совместить с поиском по дереву:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(tree-match '(<span style="color: #87005f;">"div"</span>
              ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"b-vacancy-custom g-round"</span>
                (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"title"</span>) (<span style="color: #87005f;">"content"</span> <span style="color: #87005f;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
                (<span style="color: #87005f;">"h1"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"title b-vacancy-title"</span>)) <span style="color: #87005f;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
                (<span style="color: #87005f;">"table"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l"</span>))
                         (<span style="color: #87005f;">"tr"</span> NIL
                               (<span style="color: #87005f;">"td"</span> ((<span style="color: #87005f;">"colspan"</span> <span style="color: #87005f;">"2"</span>) (<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l-cell"</span>)))
                               (<span style="color: #87005f;">"td"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l-cell"</span>)))))))
              ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"g-round plus"</span>))`
              (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"title"</span>) (<span style="color: #87005f;">"content"</span> <span style="color: #87005f;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>))))
            (<span style="color: #af00ff;">with-predict</span> (a b <span style="color: #008700;">&amp;rest</span> c)
              (aif (and (stringp a)
                        (string<span style="color: #af00ff;">=</span> a <span style="color: #87005f;">"class"</span>))
                   (<span style="color: #af00ff;">prog1</span> it
                     (setf **a** a)
                     (setf **b** b))))
            <span style="color: #5f5f87;">:return-all-match</span>)
</pre>
</div>

<p>
Для еще большей лаконичности мы можем определить оборачивающий макрос, который
позволит нам не писать ничего, кроме условия в <code>aif</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict_if">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;with_predict&gt;&gt;

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-predict-if</span> (pattern <span style="color: #008700;">&amp;body</span> condition)
  `(<span style="color: #af00ff;">with-predict</span> ,pattern
     (aif ,@condition
          (<span style="color: #af00ff;">prog1</span> it
            ,@(mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                          `(setf ,(intern (format nil <span style="color: #87005f;">"**~A**"</span> (symbol-name x))) ,x))
                      (remove-if #'(<span style="color: #af00ff;">lambda</span> (x)
                                     (or (equal x '<span style="color: #008700;">&amp;rest</span>)
                                         (equal x '<span style="color: #008700;">&amp;optional</span>)
                                         (equal x '<span style="color: #008700;">&amp;body</span>)
                                         (equal x '<span style="color: #008700;">&amp;key</span>)
                                         (equal x '<span style="color: #008700;">&amp;allow-other-keys</span>)
                                         (equal x '<span style="color: #008700;">&amp;environment</span>)
                                         (equal x '<span style="color: #008700;">&amp;aux</span>)
                                         (equal x '<span style="color: #008700;">&amp;whole</span>)
                                         (equal x '<span style="color: #008700;">&amp;allow-other-keys</span>)))
                                 (alexandria:flatten pattern)))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1 '</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(with-predict-if (a b &amp;rest c)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(and (stringp a)</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(string= a "class"))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (WITH-PREDICT (A B &amp;REST C)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">(AIF (AND (STRINGP A) (STRING= A "class"))</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(PROG1 IT</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(SETF **A** A)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(SETF **B** B)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(SETF **C** C))))</span>
</pre>
</div>

<p>
Таким образом мы инжектируем переменные шаблона в глобальную область видимости, если
они не определены в более высокоуровневом <code>let</code>.
</p>

<p>
Теперь мы можем использовать <code>tree-match</code> так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(print
 (tree-match '(<span style="color: #87005f;">"div"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"b-vacancy-custom g-round"</span>))
               (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"title"</span>) (<span style="color: #87005f;">"content"</span> <span style="color: #87005f;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
               (<span style="color: #87005f;">"h1"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"title b-vacancy-title"</span>)) <span style="color: #87005f;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
               (<span style="color: #87005f;">"table"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l"</span>))
                (<span style="color: #87005f;">"tbody"</span> NIL
                 (<span style="color: #87005f;">"tr"</span> NIL
                       (<span style="color: #87005f;">"td"</span> ((<span style="color: #87005f;">"colspan"</span> <span style="color: #87005f;">"2"</span>) (<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l-cell"</span>))
                             (<span style="color: #87005f;">"div"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"employer-marks g-clearfix"</span>))
                                    (<span style="color: #87005f;">"div"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"companyname"</span>))
                                           (<span style="color: #87005f;">"a"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"hiringOrganization"</span>) (<span style="color: #87005f;">"href"</span> <span style="color: #87005f;">"/employer/1529644"</span>))
                                                <span style="color: #87005f;">"&#1054;&#1054;&#1054; &#1053;&#1080;&#1084;&#1073;&#1083;"</span>))))
                       (<span style="color: #87005f;">"td"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"l-cell"</span>)))))))
             (<span style="color: #af00ff;">with-predict-if</span> (a b <span style="color: #008700;">&amp;rest</span> c)
               (and (stringp a)
                    (string<span style="color: #af00ff;">=</span> a <span style="color: #87005f;">"class"</span>)))
             <span style="color: #5f5f87;">:return-all-match</span>))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (("class" "b-vacancy-custom g-round") ("class" "title b-vacancy-title")</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">("class" "l") ("class" "l-cell") ("class" "employer-marks g-clearfix")</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">("class" "companyname") ("class" "l-cell"))</span>

(print **b**)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; "l-cell"</span>
</pre>
</div>

<p>
Тут оставим адаптацию <code>with-predict</code> для <code>maptree-if</code>, рассмотренного в следующем
разделе
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="drop_f_util_contents">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-predict-maptree</span> (pattern condition replace tree)
  (<span style="color: #af00ff;">let</span> ((lambda-param (gensym)))
    `(maptree-if #'(<span style="color: #af00ff;">lambda</span> (,lambda-param)
                     (and (consp ,lambda-param)
                        (funcall (<span style="color: #af00ff;">with-predict-if</span> ,pattern
                                   ,condition)
                                 ,lambda-param)))
                 ,replace
                 ,tree)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">'(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(and (equal b 'ping))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">#'(lambda (x)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">'(progn (ping (ping ping (ping 1))) ping)))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(and (equal b 'ping))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">#'(lambda (x)</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">'(progn (ping (ping ping (ping 1))) ping))</span>
</pre>
</div>

<p>
Ну и "всем дочитавшим до этого места" могу теперь сообщить, что применение
pattern-matchinga из пакета <code>optima</code> делает вышеприведенный код существенно менее
полезным :)
</p>
</div>
</li>

<li><a id="sec-1-2-3-10-2"></a>Maptree-if<br  /><div class="outline-text-6" id="text-1-2-3-10-2">
<p>
Функция <code>maptree-if</code> - рекурсивный преобразователь, который возвращает новое дерево,
рекурсивно вызывая аргумент <code>transformer</code> на <code>sub-tree</code>, которые удовлетворяют
аргументу <code>predicate</code>.
</p>

<p>
Аргумент <code>predicate</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает T или NIL
</p>

<p>
Аргумент <code>transformer</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code>
и возвращает <code>atom</code> или <code>subtree</code> в первом параметре, а во втором может возвратить
функцию <code>control</code>. Если эта функция возвращена, тогда дерево возвращается с замененным
<code>transformer</code>-ом узлами по следующему алгоритму:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(funcall control
         #'(<span style="color: #af00ff;">lambda</span> (x)
             (maptree-if predicate transformer x))
         transformed-tree)
</pre>
</div>

<p>
В противном случае оно возвращается как есть.
</p>

<p>
Собственно функция <code>maptree-if</code>, которую мы помещаем в утилиты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">maptree-if</span> (predicate transformer tree)
  (<span style="color: #af00ff;">multiple-value-bind</span> (t-tree control)
      (<span style="color: #af00ff;">if</span> (funcall predicate tree)
          (funcall transformer tree)
          (values tree #'mapcar))
    (<span style="color: #af00ff;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #af00ff;">lambda</span> (x)
                     (maptree-if predicate transformer x))
                 t-tree)
        t-tree)))
</pre>
</div>

<p>
Несколько примеров работы:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1053;&#1077;&#1088;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #af00ff;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #af00ff;">lambda</span> (x)
                `(pong ,@(cdr x)))
            '(<span style="color: #af00ff;">progn</span> (ping (ping (ping 1)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (PROGN (PONG (PING (PING 1))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1056;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #af00ff;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #af00ff;">lambda</span> (x)
                (values `(pong ,@(cdr x)) #'mapcar))
            '(<span style="color: #af00ff;">progn</span> (ping (ping (ping 1)))
              ping))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt; (PROGN (PONG (PONG (PONG 1))))</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-3-10-3"></a>Maptree-transform<br  /><div class="outline-text-6" id="text-1-2-3-10-3">
<p>
<code>maptree-transform</code> - это аналог maptree-if, но здесь одна функция
(<code>predicate-transformer</code>) и ищет и трансформирует узел дерева:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="maptree_transform">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">maptree-transform</span> (predicate-transformer tree)
  (<span style="color: #af00ff;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #af00ff;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #af00ff;">lambda</span> (x)
                     (maptree-transform predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">mtm - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree-transform</span>
(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">mtm</span> (transformer tree)
  (<span style="color: #af00ff;">let</span> ((lambda-param (gensym)))
    `(maptree-transform #'(<span style="color: #af00ff;">lambda</span> (,lambda-param)
                            (values (match ,lambda-param ,transformer)
                                    #'mapcar))
                        ,tree)))
</pre>
</div>
</div>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-1-2-4" class="outline-4">
<h4 id="sec-1-2-4"><span class="section-number-4">1.2.4</span> Разбор вакансий (<code>hh-parse-vacancy</code>)</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
Функция <code>hh-parse-vacancy</code> обрабатывает вакансии примерно так же как
<code>hh-parse-vacancy-teaser</code> обрабатывает тизеры вакансий: получает на вход html и
превращает его в вакансию. Для этого она использует те же шаги и те же функции:
</p>
<ul class="org-ul">
<li>Преобразование html-кода в дерево s-выражений
</li>
<li>Извлечение из этого дерева части, которая содержит вакансию
</li>
<li>Преобразование элементов форматирования, таких как div и span в "говорящие"
элементы дерева для повышения читаемости (названия для преобразования извлекаются
из атрибутов <code>class</code> и <code>data-qa</code>
</li>
<li>Преобразование содержимого вакансии в plists, с отнесением отдельных элементов к
разным разделам информации о вакансии (sections)
</li>
<li>Слияние разделов из разных plists и формирование вакансии, которая предавляет
собой 2-х уровневое plist-дерево, в котором первый уровень - ключи разделов, а из
значения представляют собой второй уровень и являются plist-ами
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;extract_vacancy&gt;&gt;

&lt;&lt;transform_description&gt;&gt;

&lt;&lt;vacancy_detectors&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy</span> (html)
  <span style="color: #87005f;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080; &#1080;&#1079; html"</span>
  (dbg <span style="color: #87005f;">":hh-parse-vacancy:"</span>)
  (setf *last-parse-data* html)
  (<span style="color: #af00ff;">let</span> ((candidat (-&gt;&gt; (html-to-tree html)
                       (extract-vacancy)
                       (maptreefilter)
                       (detect-script)
                       (detect-insider-vacancy)
                       (detect-branded)
                       (detect-branded2)
                       (detect-gap)
                       (detect-vacancy-custom)
                       (detect-l)
                       (detect-emp)
                       (detect-vacancy-info)
                       (detect-vac-info-tr)
                       (detect-or-vac-info-tr-no-salary)
                       (detect-container)
                       (detect-col-1)
                       (detect-hypercontext)
                       (detect-descr-outer-block)
                       (detect-longdescr)
                       (detect-vacancy-address)
                       (detect-jobtype)
                       (detect-closed-contacts)
                       (detect-contacts-body)
                       (detect-contacts-fio)
                       (detect-contacts-list)
                       (detect-contacts-tr)
                       (detect-contacts-phone)
                       (detect-contacts-mail)
                       (detect-logo)
                       (detect-date)
                       (detect-or-date-with-disabled)
                       (detect-vacancy-view-banners)
                       (detect-column-2)
                       (detect-response-block)
                       (detect-skill-element)
                       (detect-skills)
                       (detect-joblocation)
                       (detect-handicap)
                       (detect-compact-l)
                       (detect-compact-contacts)
                       (detect-compact-info)
                       (detect-columns)
                       (detect-branded-hype)
                       (detect-meta)
                       (detect-compact-infoblock)
                       )))
    (<span style="color: #af00ff;">if</span> (not (tree-plist-p candidat))
        (<span style="color: #af00ff;">progn</span>
          (dbg <span style="color: #87005f;">"~A"</span> (bprint candidat))
          (<span style="color: #ff0000; font-weight: bold;">error</span> 'malformed-vacancy <span style="color: #5f5f87;">:text</span>))
        (<span style="color: #af00ff;">let*</span> ((non-compacted-vacancy candidat)
               (compacted-vacancy (compactor candidat))
               )
          <span style="color: #af0000;">;; </span><span style="color: #af0000;">non-compacted-vacancy</span>
          compacted-vacancy
        ))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">(print candidat)</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">(print (compactor candidat))</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">candidat</span>
    ))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print (hh-parse-vacancy *last-parse-data*))</span>


<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *last-vacancy-html*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/vacancy/17527227" temp-cookie-jar *hh_account* "https://spb.hh.ru/")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *last-vacancy-html*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/vacancy/18108178" temp-cookie-jar *hh_account* "https://spb.hh.ru/")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *last-vacancy-html*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/vacancy/17527227" temp-cookie-jar *hh_account* "https://spb.hh.ru/")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *last-vacancy-html*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/vacancy/22262525" temp-cookie-jar *hh_account* "https://spb.hh.ru/")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *last-vacancy-html*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-get-page "https://spb.hh.ru/vacancy/22518184" temp-cookie-jar *hh_account* "https://spb.hh.ru/")))</span>



<span style="color: #af0000;">;; </span><span style="color: #af0000;">(let ((sections (hh-parse-vacancy *last-vacancy-html*)))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(loop :for section-key :in sections by #'cddr  :do</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">(format t "~%_______~%~A" (bprint (list section-key (getf sections section-key))))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print (hh-parse-vacancy *last-vacancy-html*))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hh-parse-vacancy (hh-get-page "https://spb.hh.ru/vacancy/16606806" temp-cookie-jar *hh_account* "https://spb.hh.ru/"))))</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-2-4-1"></a>Экстрактор вакансии extract-vacancy<br  /><div class="outline-text-5" id="text-1-2-4-1">
<p>
Затем нам понадобится выделить вакансию, с которыми будем работать:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="extract_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">extract-vacancy</span> (tree)
  (<span style="color: #af00ff;">block</span> subtree-extract
    (mtm (`(<span style="color: #87005f;">"div"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"nopaddings"</span>) (<span style="color: #87005f;">"itemscope"</span> <span style="color: #87005f;">"itemscope"</span>)
                   (<span style="color: #87005f;">"itemtype"</span> <span style="color: #87005f;">"http://schema.org/JobPosting"</span>))
                  ,@rest)
           (<span style="color: #af00ff;">return-from</span> subtree-extract rest))
         tree)))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-4-2"></a>Преобразователь описания вакансии<br  /><div class="outline-text-5" id="text-1-2-4-2">
<p>
Теперь, можно написать функцию, которая трансформирует описание, очищая его от всего
лишнего:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="transform_description">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">transform-description</span> (tree-descr)
  (<span style="color: #af00ff;">labels</span> ((rem-space (tree)
             (<span style="color: #af00ff;">cond</span> ((consp tree) (cons (rem-space (car tree))
                                       (rem-space (remove-if #'(<span style="color: #af00ff;">lambda</span> (x) (equal x <span style="color: #87005f;">" "</span>))
                                                             (cdr tree)))))
                   (t tree))))
    (append `((<span style="color: #5f5f87;">:p</span>))
            (mtm (`(<span style="color: #87005f;">"p"</span> nil ,@in) `((<span style="color: #5f5f87;">:p</span>) ,@in))
                 (mtm (`(<span style="color: #87005f;">"ul"</span> nil ,@in) `((<span style="color: #5f5f87;">:ul</span>) ,@in))
                      (mtm (`(<span style="color: #87005f;">"li"</span> nil ,@in) `((<span style="color: #5f5f87;">:li</span>) ,@in))
                           (mtm (`(<span style="color: #87005f;">"em"</span> nil ,@in) `((<span style="color: #5f5f87;">:b</span>) ,@in))
                                (mtm (`(<span style="color: #87005f;">"strong"</span> nil ,@in) `((<span style="color: #5f5f87;">:b</span>) ,@in))
                                     (mtm (`(<span style="color: #87005f;">"br"</span>) `((<span style="color: #5f5f87;">:br</span>)))
                                          (rem-space tree-descr))))))))))
</pre>
</div>
</div>
</li>

<li><a id="sec-1-2-4-3"></a>Набор шаблонных макросов-преобразователей для вакансий<br  /><div class="outline-text-5" id="text-1-2-4-3">
<p>
Эти макросы по шаблону преобразуют вакансии в plist
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="vacancy_detectors">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(make-detect (script)
  (`(<span style="color: #87005f;">"script"</span> ((<span style="color: #87005f;">"data-name"</span> ,name) (<span style="color: #87005f;">"data-params"</span> ,params)))
    `(<span style="color: #5f5f87;">:empty</span> (<span style="color: #5f5f87;">:script</span> ,name <span style="color: #5f5f87;">:params</span> ,params))))

(make-detect (insider-vacancy)
  (`(<span style="color: #87005f;">"bloko-gap bloko-gap_left"</span>
     ((<span style="color: #87005f;">"xmlns:b"</span> <span style="color: #87005f;">"http://hhru.github.com/bloko/"</span>))
     (<span style="color: #87005f;">"b-insider-interview"</span>
      NIL
      (<span style="color: #87005f;">"a"</span> ((<span style="color: #87005f;">"href"</span> ,insider-href))
           <span style="color: #87005f;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>)))
    `(<span style="color: #5f5f87;">:empty</span> (<span style="color: #5f5f87;">:insider</span> ,insider-href))))

(make-detect (branded)
  (`(<span style="color: #87005f;">"vacancy-branded"</span> NIL ,@data)
    `(<span style="color: #5f5f87;">:branded</span> ,(<span style="color: #af00ff;">block</span> subtree-extract
                       (mtm (`(<span style="color: #87005f;">"l-paddings b-vacancy-desc g-user-content"</span> NIL ,payload)
                              (<span style="color: #af00ff;">return-from</span> subtree-extract payload))
                            data)))))

(make-detect (branded2)
  (`(<span style="color: #87005f;">"branded-vacancy"</span>
     NIL
     ,content
     ,@_)
    `(<span style="color: #5f5f87;">:branded-vacancy</span> ,content)))

(make-detect (gap)
  (`(<span style="color: #87005f;">"bloko-gap bloko-gap_bottom bloko-gap_left"</span> NIL ,@_)
    `(<span style="color: #5f5f87;">:empty</span> (<span style="color: #5f5f87;">:gap</span> <span style="color: #87005f;">"controls"</span>))))

(make-detect (vacancy-custom)
  (`(<span style="color: #87005f;">"b-vacancy-custom g-round"</span>
     NIL
     (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"title"</span>) (<span style="color: #87005f;">"content"</span> ,_)))
     (<span style="color: #87005f;">"h1"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"title b-vacancy-title"</span>)) ,title)
     ,@emp)
    `(<span style="color: #5f5f87;">:vacancy</span> (<span style="color: #5f5f87;">:title</span> ,title) <span style="color: #5f5f87;">:emp</span> ,emp)))

(make-detect (l)
  (`(<span style="color: #87005f;">"l"</span>
     NIL
     (<span style="color: #87005f;">"tbody"</span>
      NIL (<span style="color: #87005f;">"tr"</span>
           NIL
           (<span style="color: #87005f;">"l-cell"</span>
            ((<span style="color: #87005f;">"colspan"</span> <span style="color: #87005f;">"2"</span>))
            ,@l)
           (<span style="color: #87005f;">"l-cell"</span> ,@_))))
    `(<span style="color: #5f5f87;">:l</span> ,l)))

(make-detect (emp)
  (`(<span style="color: #87005f;">"employer-marks g-clearfix"</span>
     NIL
     (<span style="color: #87005f;">"companyname"</span> NIL
                    (<span style="color: #87005f;">"a"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"hiringOrganization"</span>) (<span style="color: #87005f;">"href"</span> ,emp-href)) ,emp-name)
                    ,@_))
    `(<span style="color: #5f5f87;">:emp-name</span> ,emp-name <span style="color: #5f5f87;">:emp-href</span> ,emp-href)))

(make-detect (vacancy-info)
  (`(<span style="color: #87005f;">"b-vacancy-info"</span>
     NIL
     (<span style="color: #87005f;">"l-content-3colums"</span>
      NIL
      (<span style="color: #87005f;">"tbody"</span>
       NIL
       (<span style="color: #87005f;">"tr"</span>
        NIL
        (<span style="color: #87005f;">"l-content-colum-1 b-v-info-title"</span> NIL (<span style="color: #87005f;">"l-paddings"</span> NIL <span style="color: #87005f;">"&#1059;&#1088;&#1086;&#1074;&#1077;&#1085;&#1100; &#1079;&#1072;&#1088;&#1087;&#1083;&#1072;&#1090;&#1099;"</span>))
        (<span style="color: #87005f;">"l-content-colum-2 b-v-info-title"</span> NIL (<span style="color: #87005f;">"l-paddings"</span> NIL <span style="color: #87005f;">"&#1043;&#1086;&#1088;&#1086;&#1076;"</span>))
        (<span style="color: #87005f;">"l-content-colum-3 b-v-info-title"</span> NIL (<span style="color: #87005f;">"l-paddings"</span> NIL <span style="color: #87005f;">"&#1058;&#1088;&#1077;&#1073;&#1091;&#1077;&#1084;&#1099;&#1081; &#1086;&#1087;&#1099;&#1090; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099;"</span>)))
       ,info
       )))
    `(<span style="color: #5f5f87;">:vac-info</span> ,info)))

(make-detect (vac-info-tr)
  (`(<span style="color: #87005f;">"tr"</span>
     NIL
     (<span style="color: #87005f;">"l-content-colum-1 b-v-info-content"</span>
      NIL
      (<span style="color: #87005f;">"l-paddings"</span>
       NIL
       (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"salaryCurrency"</span>) (<span style="color: #87005f;">"content"</span> ,currency)))
       (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"baseSalary"</span>) (<span style="color: #87005f;">"content"</span> ,base-salary)))
       ,salary-text))
     (<span style="color: #87005f;">"l-content-colum-2 b-v-info-content"</span>
      NIL
      (<span style="color: #87005f;">"l-paddings"</span> NIL ,city ,@metro))
     (<span style="color: #87005f;">"l-content-colum-3 b-v-info-content"</span>
      NIL
      (<span style="color: #87005f;">"l-paddings"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"experienceRequirements"</span>)) ,exp)))
    `(<span style="color: #5f5f87;">:vacancy-compensation</span> (<span style="color: #5f5f87;">:currency</span> ,currency <span style="color: #5f5f87;">:base-salary</span> ,base-salary <span style="color: #5f5f87;">:salary-text</span> ,salary-text)
                            <span style="color: #5f5f87;">:vacancy-place</span> (<span style="color: #5f5f87;">:city</span> ,city)
                            <span style="color: #5f5f87;">:vacancy-exp</span> (<span style="color: #5f5f87;">:exp</span> ,exp)
                            <span style="color: #5f5f87;">:vacancy-place</span> (<span style="color: #5f5f87;">:metro</span> ,(mapcar #'(<span style="color: #af00ff;">lambda</span> (x) (car (last x)))
                                                            (remove-if-not #'listp metro))))))

(make-detect (or-vac-info-tr-no-salary)
  (`(<span style="color: #87005f;">"tr"</span>
     NIL
     (<span style="color: #87005f;">"l-content-colum-1 b-v-info-content"</span>
      NIL
      (<span style="color: #87005f;">"l-paddings"</span> NIL <span style="color: #87005f;">" &#1079;/&#1087; &#1085;&#1077; &#1091;&#1082;&#1072;&#1079;&#1072;&#1085;&#1072;"</span>))
     (<span style="color: #87005f;">"l-content-colum-2 b-v-info-content"</span> NIL (<span style="color: #87005f;">"l-paddings"</span> NIL ,city ,@metro))
     (<span style="color: #87005f;">"l-content-colum-3 b-v-info-content"</span>
      NIL
      (<span style="color: #87005f;">"l-paddings"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"experienceRequirements"</span>)) ,exp)))
    `(<span style="color: #5f5f87;">:vacancy-place</span> (<span style="color: #5f5f87;">:city</span> ,city)
                     <span style="color: #5f5f87;">:vacancy-exp</span> (<span style="color: #5f5f87;">:exp</span> ,exp)
                     <span style="color: #5f5f87;">:vacancy-place</span> (<span style="color: #5f5f87;">:metro</span> ,(mapcar #'(<span style="color: #af00ff;">lambda</span> (x) (car (last x)))
                                       (remove-if-not #'listp metro))))))

(make-detect (container)
  (`(<span style="color: #87005f;">"l-content-2colums b-vacancy-container"</span>
     NIL
     (<span style="color: #87005f;">"tbody"</span>
      NIL
      (<span style="color: #87005f;">"tr"</span>
       NIL
       ,col-1
       ,col-2)))
    `(<span style="color: #5f5f87;">:cols</span> (<span style="color: #5f5f87;">:col-1</span> ,col-1 <span style="color: #5f5f87;">:col-2</span> ,col-2))))

(make-detect (col-1)
  (`(<span style="color: #87005f;">"l-content-colum-1"</span>
     ((<span style="color: #87005f;">"colspan"</span> <span style="color: #87005f;">"2"</span>))
     ,hypercontext
     ,_) <span style="color: #af0000;">;; </span><span style="color: #af0000;">response-block</span>
    `(<span style="color: #5f5f87;">:hypercontext</span> ,hypercontext)))

(make-detect (hypercontext)
  (`(<span style="color: #87005f;">"div"</span>
     ((<span style="color: #87005f;">"id"</span> <span style="color: #87005f;">"hypercontext"</span>))
     (<span style="color: #87005f;">"index"</span> NIL ,@rest))
    `(<span style="color: #5f5f87;">:hype</span> ,rest)))

(make-detect (descr-outer-block)
  (`(<span style="color: #87005f;">"bloko-gap bloko-gap_bottom"</span>
     NIL
     (<span style="color: #87005f;">"l-paddings b-vacancy-desc g-user-content"</span>
      NIL
      ,descr))
    `(<span style="color: #5f5f87;">:vacancy-descr</span> ,descr)))

(make-detect (longdescr)
  (`(<span style="color: #87005f;">"b-vacancy-desc-wrapper"</span>
     ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"description"</span>))
     ,@descr)
    `(<span style="color: #5f5f87;">:long-descr</span> ,(transform-description descr))))

(make-detect (vacancy-address)
  (`(,(or <span style="color: #87005f;">"span"</span> <span style="color: #87005f;">"b-vacancy-address l-paddings"</span>)
      ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"jobLocation"</span>) (<span style="color: #87005f;">"itemscope"</span> <span style="color: #87005f;">"itemscope"</span>)
       (<span style="color: #87005f;">"itemtype"</span> <span style="color: #87005f;">"http://schema.org/Place"</span>))
      (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"name"</span>) (<span style="color: #87005f;">"content"</span> ,_)))
      (<span style="color: #87005f;">"h3"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"b-subtitle"</span>)) <span style="color: #87005f;">"&#1040;&#1076;&#1088;&#1077;&#1089;"</span>)
      (<span style="color: #87005f;">"b-employer-office-address"</span>
       ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"address"</span>) (<span style="color: #87005f;">"itemscope"</span> <span style="color: #87005f;">"itemscope"</span>)
        (<span style="color: #87005f;">"itemtype"</span> <span style="color: #87005f;">"http://schema.org/PostalAddress"</span>))
       (<span style="color: #87005f;">"meta"</span>
        ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"streetAddress"</span>) (<span style="color: #87005f;">"content"</span> ,street-addr)))
       (<span style="color: #87005f;">"div"</span> NIL
              (<span style="color: #87005f;">"vacancy-address-with-map"</span> NIL ,addr-with-map)
              ,@_)))
    `(<span style="color: #5f5f87;">:addr</span> (<span style="color: #5f5f87;">:street-addr</span> ,street-addr <span style="color: #5f5f87;">:addr-with-map</span> ,addr-with-map))))

(make-detect (jobtype)
  (`(<span style="color: #87005f;">"b-vacancy-employmentmode l-paddings"</span>
     NIL
     (<span style="color: #87005f;">"h3"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"b-subtitle"</span>)) <span style="color: #87005f;">"&#1058;&#1080;&#1087; &#1079;&#1072;&#1085;&#1103;&#1090;&#1086;&#1089;&#1090;&#1080;"</span>)
     (<span style="color: #87005f;">"l-content-paddings"</span>
      NIL
      (<span style="color: #87005f;">"span"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"employmentType"</span>)) ,emptype) <span style="color: #87005f;">", "</span>
      (<span style="color: #87005f;">"span"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"workHours"</span>)) ,workhours)))
    `(<span style="color: #5f5f87;">:vacancy-jobtype</span> (<span style="color: #5f5f87;">:emptype</span> ,emptype <span style="color: #5f5f87;">:workhours</span> ,workhours))))

(make-detect (closed-contacts)
  (`(<span style="color: #87005f;">"l-paddings"</span>
     NIL
     (<span style="color: #87005f;">"noindex"</span>
      NIL
      (<span style="color: #87005f;">"vacancy-contacts vacancy-contacts_closed"</span>
       NIL
       (<span style="color: #5f5f87;">:EMPTY</span> ,_)
       (<span style="color: #5f5f87;">:EMPTY</span> ,_)
       (<span style="color: #87005f;">"h3"</span> ((<span style="color: #87005f;">"id"</span> <span style="color: #87005f;">"expand-vacancy-contacts"</span>))
             (<span style="color: #87005f;">"show-employer-contacts"</span> ((<span style="color: #87005f;">"data-toggle"</span> <span style="color: #87005f;">""</span>))
                                       (<span style="color: #87005f;">"bloko-link-switch"</span> NIL <span style="color: #87005f;">"&#1055;&#1086;&#1082;&#1072;&#1079;&#1072;&#1090;&#1100; &#1082;&#1086;&#1085;&#1090;&#1072;&#1082;&#1090;&#1085;&#1091;&#1102; &#1080;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1102;"</span>))
             (<span style="color: #87005f;">"vacancy-contacts__title-opened"</span> NIL <span style="color: #87005f;">"&#1050;&#1086;&#1085;&#1090;&#1072;&#1082;&#1090;&#1085;&#1072;&#1103; &#1080;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1103;"</span>))
       ,contacts)))
    `(<span style="color: #5f5f87;">:closed</span> ,contacts)))

(make-detect (contacts-body)
  (`(<span style="color: #87005f;">"vacancy-contacts__body"</span>
     NIL
     (<span style="color: #87005f;">"l-content-paddings"</span> NIL ,@rest))
    `(<span style="color: #5f5f87;">:contacts</span> ,@rest)))

(make-detect (contacts-fio)
  (`(<span style="color: #87005f;">"vacancy-contacts__fio"</span> NIL ,fio)
    `(<span style="color: #5f5f87;">:fio</span> ,fio)))

(make-detect (contacts-list)
  (`(<span style="color: #87005f;">"vacancy-contacts__list"</span>
     NIL
     (<span style="color: #87005f;">"tbody"</span> NIL ,@rest))
    `(<span style="color: #5f5f87;">:contacts-list</span> ,rest)))

(make-detect (contacts-tr)
  (`(<span style="color: #87005f;">"tr"</span> NIL
          (<span style="color: #87005f;">"vacancy-contacts__list-title"</span> NIL ,_)
          (<span style="color: #87005f;">"td"</span> NIL ,@contacts-data))
    `(<span style="color: #5f5f87;">:contacts-tr</span> ,contacts-data)))

(make-detect (contacts-phone)
  (`(<span style="color: #87005f;">"vacancy-contacts__phone"</span> NIL ,phone (<span style="color: #87005f;">"vacancy-contacts__comment"</span> NIL ,phone-comment))
    `(<span style="color: #5f5f87;">:phone</span> ,phone <span style="color: #5f5f87;">:phone-comment</span> ,phone-comment)))

(make-detect (contacts-mail)
  (`(<span style="color: #87005f;">"vacancy-contacts__email"</span> ((<span style="color: #87005f;">"href"</span> ,mail-link) (<span style="color: #87005f;">"rel"</span> <span style="color: #87005f;">"nofollow"</span>)) ,email)
    `(<span style="color: #5f5f87;">:mail-link</span> ,mail-link <span style="color: #5f5f87;">:email</span> ,email)))

(make-detect (contacts-tr)
  (`(<span style="color: #87005f;">"tr"</span> NIL
          (<span style="color: #87005f;">"vacancy-contacts__list-title"</span> NIL ,_)
          (<span style="color: #87005f;">"td"</span> NIL ,contacts-data))
    `(<span style="color: #5f5f87;">:contacts-tr</span> ,contacts-data)))

(make-detect (contacts-list)
  (`(<span style="color: #87005f;">"vacancy-contacts__list"</span>
     NIL
     (<span style="color: #87005f;">"tbody"</span> NIL ,@rest))
    `(<span style="color: #5f5f87;">:contacts-list</span> ,rest)))

(make-detect (closed-contacts)
  (`(<span style="color: #87005f;">"l-paddings"</span>
     NIL
     (<span style="color: #87005f;">"noindex"</span>
      NIL
      (<span style="color: #87005f;">"vacancy-contacts vacancy-contacts_closed"</span>
       NIL
       (<span style="color: #5f5f87;">:EMPTY</span> ,_)
       (<span style="color: #5f5f87;">:EMPTY</span> ,_)
       (<span style="color: #87005f;">"h3"</span> ((<span style="color: #87005f;">"id"</span> <span style="color: #87005f;">"expand-vacancy-contacts"</span>))
             (<span style="color: #87005f;">"show-employer-contacts"</span> ((<span style="color: #87005f;">"data-toggle"</span> <span style="color: #87005f;">""</span>))
                                       (<span style="color: #87005f;">"bloko-link-switch"</span> NIL <span style="color: #87005f;">"&#1055;&#1086;&#1082;&#1072;&#1079;&#1072;&#1090;&#1100; &#1082;&#1086;&#1085;&#1090;&#1072;&#1082;&#1090;&#1085;&#1091;&#1102; &#1080;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1102;"</span>))
             (<span style="color: #87005f;">"vacancy-contacts__title-opened"</span> NIL <span style="color: #87005f;">"&#1050;&#1086;&#1085;&#1090;&#1072;&#1082;&#1090;&#1085;&#1072;&#1103; &#1080;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1103;"</span>))
       ,contacts)))
    contacts))

(make-detect (logo)
  (`(<span style="color: #87005f;">"b-vacancy-companylogo"</span>
     NIL
     (<span style="color: #87005f;">"a"</span> ((<span style="color: #87005f;">"href"</span> ,logo-href))
          (<span style="color: #87005f;">"img"</span> ((<span style="color: #87005f;">"src"</span> ,logo-img) (<span style="color: #87005f;">"border"</span> <span style="color: #87005f;">"0"</span>) (<span style="color: #87005f;">"alt"</span> ,logo-alt)))))
    `(<span style="color: #5f5f87;">:logo-href</span> ,logo-href
                 <span style="color: #5f5f87;">:logo-img</span> ,logo-img
                 <span style="color: #5f5f87;">:logo-alt</span> ,logo-alt)))

(make-detect (date)
  (`(<span style="color: #87005f;">"l-content-paddings"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-sidebar"</span>
      NIL
      <span style="color: #87005f;">"&#1044;&#1072;&#1090;&#1072; &#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080; "</span>
      (<span style="color: #87005f;">"time"</span>
       ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"vacancy-sidebar__publication-date"</span>)
        (<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"datePosted"</span>)
        (<span style="color: #87005f;">"datetime"</span> ,datetime))
       ,date-text))
     ,@_)
    `(<span style="color: #5f5f87;">:datetime</span> ,datetime <span style="color: #5f5f87;">:date-text</span> ,date-text <span style="color: #5f5f87;">:disabled</span> nil)))

(make-detect (or-date-with-disabled)
  (`(<span style="color: #87005f;">"l-content-paddings"</span>
     NIL
     (<span style="color: #87005f;">"vacancy-sidebar"</span>
      NIL
      <span style="color: #87005f;">"&#1044;&#1072;&#1090;&#1072; &#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080; "</span>
      (<span style="color: #87005f;">"time"</span>
       ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"vacancy-sidebar__publication-date"</span>)
        (<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"datePosted"</span>)
        (<span style="color: #87005f;">"datetime"</span> ,datetime))
       ,date-text))
     (<span style="color: #87005f;">"vacancy__print-info vacancy__print-info_noscreen"</span>
      NIL
      <span style="color: #87005f;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1072; &#1076;&#1083;&#1103; &#1089;&#1086;&#1080;&#1089;&#1082;&#1072;&#1090;&#1077;&#1083;&#1077;&#1081; &#1089; &#1080;&#1085;&#1074;&#1072;&#1083;&#1080;&#1076;&#1085;&#1086;&#1089;&#1090;&#1100;&#1102;"</span>))
    `(<span style="color: #5f5f87;">:datetime</span> ,datetime <span style="color: #5f5f87;">:date-text</span> ,date-text <span style="color: #5f5f87;">:disabled</span> t)))


(make-detect (response-block)
  (`(<span style="color: #87005f;">"vacancy-response-block HH-VacancyResponsePopup-ResponseBlock"</span> NIL ,@_)
    `(<span style="color: #5f5f87;">:response-block</span> <span style="color: #87005f;">"empty"</span>)))

(make-detect (vacancy-view-banners)
  (`(<span style="color: #87005f;">"vacancy-view-banners"</span> NIL ,@_)
    `(<span style="color: #5f5f87;">:empty</span> (<span style="color: #5f5f87;">:vacancy-view-banners</span> <span style="color: #87005f;">"empty"</span>))))

(make-detect (column-2)
  (`(<span style="color: #87005f;">"l-content-colum-2"</span> NIL ,logo ,date ,@_)
    `(<span style="color: #5f5f87;">:column-2</span> (<span style="color: #5f5f87;">:vacancy-logo</span> ,logo <span style="color: #5f5f87;">:vacancy-date</span> ,date))))

(make-detect (meta)
  (`(<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> ,prop) (<span style="color: #87005f;">"content"</span> ,content)))
    `(<span style="color: #5f5f87;">:meta</span> (,(intern (string-upcase prop) <span style="color: #5f5f87;">:keyword</span>) ,content))))

(make-detect (skill-element)
  (`(<span style="color: #87005f;">"skills-element"</span>
     ((<span style="color: #87005f;">"data-tag-id"</span> ,tag))
     (<span style="color: #87005f;">"bloko-tag__section bloko-tag__section_text"</span>
      ((<span style="color: #87005f;">"title"</span> ,title))
      (<span style="color: #87005f;">"bloko-tag__text"</span> NIL ,tagtext)))
    `(<span style="color: #5f5f87;">:skill</span> (<span style="color: #5f5f87;">:tag</span> ,tag <span style="color: #5f5f87;">:title</span> ,title <span style="color: #5f5f87;">:tagtext</span> ,tagtext))))

(make-detect (skills)
  (`(<span style="color: #87005f;">"l-paddings"</span> NIL (<span style="color: #87005f;">"h3"</span> ((<span style="color: #87005f;">"class"</span> <span style="color: #87005f;">"b-subtitle"</span>)) <span style="color: #87005f;">"&#1050;&#1083;&#1102;&#1095;&#1077;&#1074;&#1099;&#1077; &#1085;&#1072;&#1074;&#1099;&#1082;&#1080;"</span>) ,@rest)
    `(<span style="color: #5f5f87;">:vacancy-skills</span> (<span style="color: #5f5f87;">:list-of-skilss</span> ,(mapcar #'cadadr rest)))))

(make-detect (joblocation)
  (`(<span style="color: #87005f;">"span"</span>
     ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"jobLocation"</span>) (<span style="color: #87005f;">"itemscope"</span> <span style="color: #87005f;">"itemscope"</span>)
      (<span style="color: #87005f;">"itemtype"</span> <span style="color: #87005f;">"http://schema.org/Place"</span>))
     (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"name"</span>) (<span style="color: #87005f;">"content"</span> ,name)))
     (<span style="color: #87005f;">"span"</span>
      ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"address"</span>) (<span style="color: #87005f;">"itemscope"</span> <span style="color: #87005f;">"itemscope"</span>)
       (<span style="color: #87005f;">"itemtype"</span> <span style="color: #87005f;">"http://schema.org/PostalAddress"</span>))
      (<span style="color: #87005f;">"meta"</span> ((<span style="color: #87005f;">"itemprop"</span> <span style="color: #87005f;">"addressLocality"</span>) (<span style="color: #87005f;">"content"</span> ,addresslocality)))))
    `(<span style="color: #5f5f87;">:vacancy-address</span> (<span style="color: #5f5f87;">:location</span> ,name <span style="color: #5f5f87;">:addresslocality</span> ,addresslocality))))

(make-detect (handicap)
  (`(<span style="color: #87005f;">"vacancy__info vacancy__info_handicapped vacancy__info_noprint"</span>
     NIL
     (<span style="color: #87005f;">"bloko-link-switch bloko-link-switch_inherited"</span> ((<span style="color: #87005f;">"data-toggle"</span> <span style="color: #87005f;">""</span>)) ,handicap)
     (<span style="color: #87005f;">"vacancy__info-expandable"</span>
      NIL
      (<span style="color: #87005f;">"vacancy-info-tip"</span> NIL<span style="color: #87005f;">"&#1069;&#1090;&#1086; &#1086;&#1079;&#1085;&#1072;&#1095;&#1072;&#1077;&#1090; &#1075;&#1086;&#1090;&#1086;&#1074;&#1085;&#1086;&#1089;&#1090;&#1100; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080; &#1088;&#1072;&#1089;&#1089;&#1084;&#1072;&#1090;&#1088;&#1080;&#1074;&#1072;&#1090;&#1100; &#1089;&#1086;&#1080;&#1089;&#1082;&#1072;&#1090;&#1077;&#1083;&#1077;&#1081; &#1085;&#1072; &#1088;&#1072;&#1074;&#1085;&#1099;&#1093; &#1085;&#1072; &#1086;&#1089;&#1085;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1076;&#1077;&#1083;&#1086;&#1074;&#1099;&#1093; &#1082;&#1072;&#1095;&#1077;&#1089;&#1090;&#1074;. &#1057;&#1086;&#1080;&#1089;&#1082;&#1072;&#1090;&#1077;&#1083;&#1100; &#1086;&#1094;&#1077;&#1085;&#1080;&#1074;&#1072;&#1077;&#1090; &#1089;&#1072;&#1084;&#1086;&#1089;&#1090;&#1086;&#1103;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;, &#1085;&#1072;&#1089;&#1082;&#1086;&#1083;&#1100;&#1082;&#1086; &#1090;&#1088;&#1077;&#1073;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080; &#1089;&#1086;&#1087;&#1086;&#1089;&#1090;&#1072;&#1074;&#1080;&#1084;&#1099; &#1089; &#1077;&#1075;&#1086; &#1080;&#1085;&#1076;&#1080;&#1074;&#1080;&#1076;&#1091;&#1072;&#1083;&#1100;&#1085;&#1099;&#1084;&#1080; &#1086;&#1089;&#1086;&#1073;&#1077;&#1085;&#1085;&#1086;&#1089;&#1090;&#1103;&#1084;&#1080;."</span>)))
    `(<span style="color: #5f5f87;">:vacancy-handicap</span> (<span style="color: #5f5f87;">:msg</span> ,handicap))))


(make-detect (compact-l)
  (`(<span style="color: #5f5f87;">:VACANCY</span> (<span style="color: #5f5f87;">:TITLE</span> ,title) <span style="color: #5f5f87;">:EMP</span> ((<span style="color: #5f5f87;">:L</span> ((<span style="color: #5f5f87;">:EMP-NAME</span> ,emp-name <span style="color: #5f5f87;">:EMP-HREF</span> ,emp-href)))))
    `(<span style="color: #5f5f87;">:vacancy</span> (<span style="color: #5f5f87;">:title</span> ,title) <span style="color: #5f5f87;">:vacancy-emp</span> (<span style="color: #5f5f87;">:EMP-NAME</span> ,emp-name <span style="color: #5f5f87;">:EMP-HREF</span> ,emp-href))))

(make-detect (compact-info)
  (`(<span style="color: #5f5f87;">:VAC-INFO</span> ,info)
    `(,@info)))

(make-detect (compact-contacts)
  (`(<span style="color: #5f5f87;">:CONTACTS</span> (<span style="color: #5f5f87;">:FIO</span> ,fio) (<span style="color: #5f5f87;">:CONTACTS-LIST</span> ,contacts-trs))
    `(<span style="color: #5f5f87;">:vacancy-contacts</span> (<span style="color: #5f5f87;">:trs</span> ,(append `((<span style="color: #5f5f87;">:CONTACTS-TR</span>
                                  ((<span style="color: #5f5f87;">:FIO</span> ,fio)))) contacts-trs)))))

(make-detect (columns)
  (`(<span style="color: #5f5f87;">:COLS</span>
     (<span style="color: #5f5f87;">:COL-1</span>
      (<span style="color: #5f5f87;">:HYPERCONTEXT</span>
       (<span style="color: #5f5f87;">:HYPE</span>
        (,@rest-1)))
      <span style="color: #5f5f87;">:COL-2</span>
      (<span style="color: #5f5f87;">:COLUMN-2</span>
       ,col-2)))
    `(<span style="color: #5f5f87;">:infoblock-1</span> ,rest-1 <span style="color: #5f5f87;">:infoblock-2</span> ,col-2)))

(make-detect (branded-hype)
  (`(<span style="color: #5f5f87;">:BRANDED-VACANCY</span>
     (<span style="color: #5f5f87;">:HYPE</span>
      ((<span style="color: #5f5f87;">:BRANDED</span>
        ,descr)
       ,@rest)))
    (mapcan #'identity (append `((<span style="color: #5f5f87;">:vacancy-descr</span> ,descr)) rest))))

(make-detect (compact-infoblock)
  (`(<span style="color: #5f5f87;">:INFOBLOCK-1</span> ,infoblock-1 <span style="color: #5f5f87;">:INFOBLOCK-2</span> ,infoblock-2)
    (mapcan #'identity (append infoblock-1 (list infoblock-2)))))
</pre>
</div>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Правила обработки тизеров и вакансий</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Пусть у нас есть возможность создавать именованные <code>правила</code>, которые получают на
вход список, представляющий собой тизер или вакансию, анализируют его, и выполняют
какие-то действия. В качестве примера, мы могли бы создать правило, которое
увеличивает <code>ранг</code> вакансии если упомянуты какие-то технологии.
</p>

<p>
Создавая правило, нам необходимо передать конструктору правила:
</p>
<ul class="org-ul">
<li>условие срабатывания (назовем его <code>antecedent</code>)
</li>
<li>код, который будет выполнен, в случае если условие на этой вакансии вернуло
<code>истину</code> (назоваем его <code>consequent</code>)
</li>
</ul>

<p>
Примем соглашение, что правило, если оно сработало, возвращает два значения:
</p>
<ul class="org-ul">
<li>первое - вакансию (<code>consequent</code> может вернуть модифицированную вакансию)
</li>
<li>второе - указание процессору правил (например, прекратить обработку)
</li>
</ul>

<p>
Мы реализуем правило, как сущность, чтобы воспользоваться всеми возможностями по
сохранению, извлечению и другим операциям с сущностями.
</p>
</div>

<div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> Правила отсева тизеров</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
Какие же правила и действия можно составить для того чтобы отсеять неинтересные
вакансии еще на стадии, когда мы видим только их тизеры?
</p>

<p>
В основном те, которые не устраивают по зарплате и те, у которых в названиях
упомянуты неинтересные технологии.
</p>

<p>
К примеру, я не хочу даже смотреть на вакансии у которых не указана зарплата или
она ниже минимально приемлимой:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_teasers">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;sugar_for_teaser_rules&gt;&gt;

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(salary-1-no (null (getf vacancy :compensation)))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "- no salary"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (salary-2-low (or</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(and (equal (getf vacancy :currency) "RUR")</span>
<span style="color: #af0000;">;;                                              </span><span style="color: #af0000;">(&lt; (getf vacancy :salary-max) 90000))</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(and (equal (getf vacancy :currency) "USD")</span>
<span style="color: #af0000;">;;                                              </span><span style="color: #af0000;">(&lt; (getf vacancy :salary-max) (floor 90000 58)))</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(and (equal (getf vacancy :currency) "EUR")</span>
<span style="color: #af0000;">;;                                              </span><span style="color: #af0000;">(&lt; (getf vacancy :salary-max) (floor 90000 61)))</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "- low salary"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (iOS (contains-in-words (string-downcase (getf vacancy :name)) "ios"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "  - name contains iOS"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (FrontEnd (contains-in-words (string-downcase (getf vacancy :name)) "front"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "  - name contains FrontEnd"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (Manager (contains-in-words (string-downcase (getf vacancy :name)) "&#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088;"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "  - name contains &#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088;"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (Saler (contains-in-words (string-downcase (getf vacancy :name)) "&#1087;&#1088;&#1086;&#1076;&#1072;&#1078;"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "  - name contains &#1087;&#1088;&#1086;&#1076;&#1072;&#1078;"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-rule (DotNet (contains-in-words (string-downcase (getf vacancy :name)) ".net"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(dbg "  - name contains .net"))</span>


<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-all-teaser-when-name-contains-rule</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Python" "Django"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"1C" "1&#1057;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"C++" "&#1057;++"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Ruby" "Ruby on Rails"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Go"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Q/A" "QA"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Unity" "Unity3D"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Flash"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Java"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Android"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"ASP"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Objective-C"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Delphi"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Sharepoint"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"PL/SQL"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Oracle"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Node"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1097;&#1080;&#1082;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1058;&#1088;&#1072;&#1092;&#1080;&#1082;-&#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Traffic" "&#1058;&#1088;&#1072;&#1092;&#1080;&#1082;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1052;&#1077;&#1076;&#1080;&#1072;&#1073;&#1072;&#1081;&#1077;&#1088;" "Media Buyer" "&#1052;&#1077;&#1076;&#1080;&#1072;&#1073;&#1072;&#1077;&#1088;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"SAP"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1084;&#1072;&#1088;&#1082;&#1077;&#1090;&#1086;&#1083;&#1086;&#1075;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"SMM"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"DevOps"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Axapta"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"designer"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1044;&#1080;&#1079;&#1072;&#1081;&#1085;&#1077;&#1088;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Designer"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"UX"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1087;&#1086; &#1088;&#1077;&#1084;&#1086;&#1085;&#1090;&#1091;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1055;&#1086;&#1084;&#1086;&#1097;&#1085;&#1080;&#1082;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"&#1042;&#1077;&#1088;&#1089;&#1090;&#1072;&#1083;&#1100;&#1097;&#1080;&#1082;"</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">"Smolensk" "&#1051;&#1100;&#1074;&#1086;&#1074;")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(mapcar #'(lambda (x)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(del-vacancy (id x)))</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(find-vacancy :state ":UNSORT"))</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-3-1-1"></a>Макросы для определения правил отсева тизеров<br  /><div class="outline-text-5" id="text-1-3-1-1">
<p>
Для начала определим макрос, который создает правила отсева тизеров - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-drop-teaser-rule</span> ((name antecedent) <span style="color: #008700;">&amp;body</span> consequent)
  `(<span style="color: #af00ff;">define-rule</span> (,(intern (concatenate 'string <span style="color: #87005f;">"DROP-TEASER-IF-"</span>(symbol-name name))) ,antecedent)
     (dbg <span style="color: #87005f;">"drop-teaser-rule: [https://spb.hh.ru/vacancy/~A] ~A"</span>
          (getf (getf vacancy <span style="color: #5f5f87;">:vacancy</span>) <span style="color: #5f5f87;">:id</span>)
          (getf (getf vacancy <span style="color: #5f5f87;">:vacancy</span>) <span style="color: #5f5f87;">:name</span>))
     <span style="color: #af0000;">;; </span><span style="color: #af0000;">(dbg (bprint vacancy))</span>
     ,@consequent
     (setf vacancy nil)
     <span style="color: #5f5f87;">:stop</span>))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(macroexpand-1</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">'(define-drop-teaser-rule</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(hi-salary-java (and (&gt; (getf (getf vacancy :compensation) :salary) 70000)</span>
<span style="color: #af0000;">;;                      </span><span style="color: #af0000;">(not (contains "Java" (getf (getf vacancy :vacancy) :name)))))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(print (getf vacancy :vacancy) :name)</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(print (getf (getf vacancy :compensation) :salary)))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(DEFINE-RULE (DROP-TEASER-IF-HI-SALARY-JAVA</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(AND (&gt; (GETF (GETF VACANCY :COMPENSATION) :SALARY) 70000)</span>
<span style="color: #af0000;">;;                    </span><span style="color: #af0000;">(NOT</span>
<span style="color: #af0000;">;;                     </span><span style="color: #af0000;">(CONTAINS "Java" (GETF (GETF VACANCY :VACANCY) :NAME)))))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(DBG "drop teaser: ~A-~A (~A) ~A"</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(GETF (GETF VACANCY :COMPENSATION) :SALARY-MIN)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(GETF (GETF VACANCY :COMPENSATION) :SALARY-MAX)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(GETF (GETF VACANCY :COMPENSATION) :CURRENCY)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(GETF (GETF VACANCY :VACANCY) :NAME))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(PRINT (GETF VACANCY :VACANCY) :NAME)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(PRINT (GETF (GETF VACANCY :COMPENSATION) :SALARY))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(SETF VACANCY NIL)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">:STOP)</span>
</pre>
</div>

<p>
Теперь определим расширение предыдущего макроса, которое создает правило, отсеивающее
тизер, в случае, если в поле <code>:name</code> есть вхождение переданной строки
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-drop-teaser-by-name-rule</span> (str <span style="color: #008700;">&amp;body</span> consequent)
  `(<span style="color: #af00ff;">define-drop-teaser-rule</span> (,(intern (concatenate 'string <span style="color: #87005f;">"NAME-CONTAINS-"</span> (string-upcase (ppcre:regex-replace-all <span style="color: #87005f;">"\\s+"</span> str <span style="color: #87005f;">"-"</span>))))
                              (contains (getf (getf vacancy <span style="color: #5f5f87;">:vacancy</span>) <span style="color: #5f5f87;">:name</span>) ,str))
     (dbg <span style="color: #87005f;">"  - name contains \"~A\""</span> ,str)
     ,@consequent))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(macroexpand-1</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">'(define-drop-teaser-by-name-rule "Android")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(DEFINE-DROP-TEASER-RULE (NAME-CONTAINS-ANDROID</span>
<span style="color: #af0000;">;;                           </span><span style="color: #af0000;">(CONTAINS (GETF (GETF VACANCY :VACANCY) :NAME)</span>
<span style="color: #af0000;">;;                                     </span><span style="color: #af0000;">"Android"))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(DBG "  - name contains \"~A\"" "Android"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-teaser-by-name-rule "Android")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(#&lt;FUNCTION (LABELS DROP-TEASER-IF-NAME-CONTAINS-ANDROID-ANTECEDENT-G2507)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">{100455A44B}&gt;</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">#&lt;FUNCTION (LABELS DROP-TEASER-IF-NAME-CONTAINS-ANDROID-CONSEQUENT-G2508)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">{10045E5C4B}&gt;</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">#&lt;RULE {10045FE523}&gt;)</span>
</pre>
</div>

<p>
Теперь в соответствии с принципом DRY определем макрос, который создаст список правил,
отсеивающих тизеры по вхождению первой строки в поле <code>:name</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-drop-all-teaser-when-name-contains-rule</span> (<span style="color: #008700;">&amp;rest</span> names)
  `(list ,@(<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> name <span style="color: #5f5f87;">:in</span> names <span style="color: #5f5f87;">:collect</span>
              `(<span style="color: #af00ff;">define-drop-teaser-by-name-rule</span> ,name))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1 '(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(LIST (DEFINE-DROP-TEASER-BY-NAME-RULE "IOS")</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(DEFINE-DROP-TEASER-BY-NAME-RULE "1&#1057;")</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(DEFINE-DROP-TEASER-BY-NAME-RULE "C++"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">=&gt;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">((DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-ANTECEDENT</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-CONSEQUENT)</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-ANTECEDENT</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-CONSEQUENT)</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(DROP-TEASER-IF-IF-NAME-CONTAINS-C++-ANTECEDENT</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-C++-CONSEQUENT))</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> <span class="todo TODO">TODO</span> Правила анализа вакансий</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Для начала определим макрос, который создает правила отсева вакансий - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-drop-vacancy-rule</span> ((name antecedent) <span style="color: #008700;">&amp;body</span> consequent)
  `(<span style="color: #af00ff;">define-rule</span> (,(intern (concatenate 'string <span style="color: #87005f;">"DROP-VACANCY-IF-"</span>(symbol-name name))) ,antecedent)
     (dbg <span style="color: #87005f;">"drop vacancy: ~A : ~A"</span>
          (getf (getf vacancy <span style="color: #5f5f87;">:vacancy</span>) <span style="color: #5f5f87;">:name</span>)
          (getf (getf vacancy <span style="color: #5f5f87;">:company</span>) <span style="color: #5f5f87;">:emp-name</span>))
     ,@consequent
     (setf vacancy nil)
     <span style="color: #5f5f87;">:stop</span>))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(macroexpand-1</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">'(define-drop-vacancy-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #af0000;">;;                                              </span><span style="color: #af0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(print (getf vacancy :name))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(print (getf vacancy :salary)))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(DEFINE-RULE (DROP-VACANCY-IF-HI-SALARY-JAVA</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #af0000;">;;                    </span><span style="color: #af0000;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME)))))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(PRINT (GETF VACANCY :NAME))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(PRINT (GETF VACANCY :SALARY))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(SETF VACANCY NIL)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">:STOP)</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-3-2-1"></a><span class="todo TODO">TODO</span> Я не хочу смотреть на вакансии, в компаниях где я уже работал.<br  /><div class="outline-text-5" id="text-1-3-2-1">
<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-drop-all-vacancy-when-already-worked</span> (<span style="color: #008700;">&amp;rest</span> employers)
  `(list ,@(<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> emp <span style="color: #5f5f87;">:in</span> employers <span style="color: #5f5f87;">:collect</span>
              `(<span style="color: #af00ff;">define-drop-vacancy-rule</span> (already-worked (contains (getf (getf vacancy <span style="color: #5f5f87;">:company</span>) <span style="color: #5f5f87;">:emp-name</span>) ,emp))
                   (dbg <span style="color: #87005f;">"   - already worked"</span>)))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1 '(define-drop-all-vacancy-when-already-worked "Webdom" "Semrush" "&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;"))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(LIST</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(DEFINE-DROP-VACANCY-RULE (ALREADY-WORKED</span>
<span style="color: #af0000;">;;                             </span><span style="color: #af0000;">(CONTAINS (GETF VACANCY :EMP-NAME) "Webdom"))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(DBG "   - already worked"))</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(DEFINE-DROP-VACANCY-RULE (ALREADY-WORKED</span>
<span style="color: #af0000;">;;                             </span><span style="color: #af0000;">(CONTAINS (GETF VACANCY :EMP-NAME) "Semrush"))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(DBG "   - already worked"))</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(DEFINE-DROP-VACANCY-RULE (ALREADY-WORKED</span>
<span style="color: #af0000;">;;                             </span><span style="color: #af0000;">(CONTAINS (GETF VACANCY :EMP-NAME)</span>
<span style="color: #af0000;">;;                                       </span><span style="color: #af0000;">"&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;"))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(DBG "   - already worked")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-all-vacancy-when-already-worked "Webdom" "Semrush" "&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-all-vacancy-when-already-worked "Webdom" "Semrush" "&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;" "FBS")</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-1-3-2-2"></a><span class="todo TODO">TODO</span> Если это уже существующая в базе вакансия (todo: и ничего не изменилось) игнорируем.<br  /><div class="outline-text-5" id="text-1-3-2-2">
<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-drop-vacancy-rule (already-exists-in-db (not (null (find-vacancy :src-id (getf (getf vacancy :vacancy) :id)))))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; (let ((exists (car (find-vacancy :src-id (getf vacancy :id)))))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(dbg "   - already exists"))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; )</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-1-3-2-3"></a><span class="todo TODO">TODO</span> Вычислить теги для любой вакансии<br  /><div class="outline-text-5" id="text-1-3-2-3">
<p>
Я хочу проанализировать заголовок и текст вакансии, чтобы тэггировать ее -
определить, под какой профиль работы она более всего подходит. В дальнейшем это
станет основой для построения резюме под вакансию.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy"><span style="color: #af0000;">;; </span><span style="color: #af0000;">(in-package #:moto)</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-rule (set-tags t)</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1055;&#1088;&#1077;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1086;&#1087;&#1080;&#1089;&#1072;&#1085;&#1080;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080; &#1074; plain-text &#1089; &#1084;&#1080;&#1085;&#1080;&#1084;&#1091;&#1084;&#1086;&#1084; &#1079;&#1085;&#1072;&#1082;&#1086;&#1074; &#1087;&#1088;&#1077;&#1087;&#1088;&#1080;&#1085;&#1072;&#1085;&#1080;&#1103;, &#1072; &#1087;&#1086;&#1090;&#1086;&#1084; &#1088;&#1072;&#1079;&#1073;&#1080;&#1074;&#1072;&#1077;&#1084; &#1087;&#1086; &#1087;&#1088;&#1086;&#1073;&#1077;&#1083;&#1072;&#1084;,</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1095;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1089;&#1083;&#1086;&#1074;, &#1086;&#1090;&#1089;&#1086;&#1088;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1099;&#1081; &#1087;&#1086; &#1095;&#1072;&#1089;&#1090;&#1086;&#1090;&#1077; &#1074;&#1089;&#1090;&#1088;&#1077;&#1095;&#1072;&#1077;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1048;&#1079; &#1101;&#1090;&#1086;&#1075;&#1086; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1089;&#1083;&#1086;&#1074; &#1084;&#1099; &#1093;&#1086;&#1090;&#1080;&#1084; &#1085;&#1072;&#1081;&#1090;&#1080; &#1074;&#1089;&#1077; &#1090;&#1077;&#1088;&#1084;&#1080;&#1085;&#1099;. &#1058;&#1077;&#1088;&#1084;&#1080;&#1085;&#1072;&#1084;&#1080; &#1084;&#1086;&#1075;&#1091;&#1090; &#1073;&#1099;&#1090;&#1100;:</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; - &#1072;&#1073;&#1073;&#1088;&#1077;&#1074;&#1080;&#1090;&#1091;&#1088;&#1099; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1081;</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; - &#1085;&#1072;&#1079;&#1074;&#1072;&#1085;&#1080;&#1103; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1081; &#1080; &#1087;&#1088;&#1086;&#1076;&#1091;&#1082;&#1090;&#1086;&#1074;, &#1080;&#1079;&#1074;&#1077;&#1089;&#1090;&#1085;&#1099;&#1077; &#1085;&#1072;&#1084;.</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1052;&#1099; &#1089;&#1095;&#1080;&#1090;&#1072;&#1077;&#1084; &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1084;&#1080; &#1090;&#1077; &#1089;&#1083;&#1086;&#1074;&#1072;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1090; &#1090;&#1086;&#1083;&#1100;&#1082;&#1086; &#1072;&#1085;&#1075;&#1083;&#1080;&#1081;&#1089;&#1082;&#1080;&#1077; &#1073;&#1091;&#1082;&#1074;&#1099; (&#1087;&#1091;&#1089;&#1090;&#1100; &#1076;&#1072;&#1078;&#1077; &#1080; &#1074; &#1085;&#1080;&#1078;&#1085;&#1077;&#1084; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1077;)</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1052;&#1086;&#1078;&#1085;&#1086; &#1077;&#1097;&#1077; &#1074;&#1099;&#1103;&#1074;&#1083;&#1103;&#1090;&#1100; &#1085;&#1072;&#1080;&#1073;&#1086;&#1083;&#1077;&#1077; &#1095;&#1072;&#1089;&#1090;&#1086; &#1074;&#1089;&#1090;&#1088;&#1077;&#1095;&#1072;&#1102;&#1097;&#1080;&#1077;&#1089;&#1103; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1099; (https://habrahabr.ru/post/167177/)</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">;; &#1053;&#1072;&#1081;&#1076;&#1077;&#1085;&#1085;&#1099;&#1077; &#1072;&#1073;&#1088;&#1077;&#1074;&#1080;&#1072;&#1090;&#1091;&#1088;&#1099; &#1082;&#1083;&#1072;&#1076;&#1077;&#1084; &#1074; &#1087;&#1086;&#1083;&#1077; tags</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">(let ((hash (make-hash-table :test #'equal))</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(result))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(mapcar #'(lambda (trm)</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">(multiple-value-bind (result exist)</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(gethash trm hash)</span>
<span style="color: #af0000;">;;                     </span><span style="color: #af0000;">(if (null exist)</span>
<span style="color: #af0000;">;;                         </span><span style="color: #af0000;">(setf (gethash trm hash) 1)</span>
<span style="color: #af0000;">;;                         </span><span style="color: #af0000;">(setf (gethash trm hash) (+ 1 result)))))</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(ppcre:split "\\s+"</span>
<span style="color: #af0000;">;;                            </span><span style="color: #af0000;">(ppcre:regex-replace-all</span>
<span style="color: #af0000;">;;                             </span><span style="color: #af0000;">"\\s+" (-&gt;  (replace-all (bprint (getf vacancy :descr)) "(:P)" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "(:B)" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "(:LI)" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "(:UL)" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "(" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all ")" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "\"" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "/" " ")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "," "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all ":" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all ";" "")</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(replace-all "-" ""))</span>
<span style="color: #af0000;">;;                             </span><span style="color: #af0000;">" ")))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(maphash #'(lambda (k v)</span>
<span style="color: #af0000;">;;                    </span><span style="color: #af0000;">(setf result (append result (list (list v k)))))</span>
<span style="color: #af0000;">;;                </span><span style="color: #af0000;">hash)</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">;; (dbg "~A" (bprint result))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(setf result (remove-if #'(lambda (x)</span>
<span style="color: #af0000;">;;                                   </span><span style="color: #af0000;">(block the-filter</span>
<span style="color: #af0000;">;;                                     </span><span style="color: #af0000;">;; &#1048;&#1079;&#1074;&#1077;&#1089;&#1090;&#1085;&#1099;&#1077; &#1085;&#1072;&#1084; &#1089;&#1083;&#1086;&#1074;&#1072;</span>
<span style="color: #af0000;">;;                                     </span><span style="color: #af0000;">(if (or (equal "1&#1057;" (cadr x))</span>
<span style="color: #af0000;">;;                                             </span><span style="color: #af0000;">;; need more ...</span>
<span style="color: #af0000;">;;                                             </span><span style="color: #af0000;">)</span>
<span style="color: #af0000;">;;                                         </span><span style="color: #af0000;">(return-from the-filter nil))</span>
<span style="color: #af0000;">;;                                     </span><span style="color: #af0000;">(loop :for char :across (cadr x) :do</span>
<span style="color: #af0000;">;;                                        </span><span style="color: #af0000;">(if (&lt; 1 (length (subseq (bprint char) 2)))</span>
<span style="color: #af0000;">;;                                            </span><span style="color: #af0000;">(return-from the-filter t)))</span>
<span style="color: #af0000;">;;                                     </span><span style="color: #af0000;">nil))</span>
<span style="color: #af0000;">;;                               </span><span style="color: #af0000;">result))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(sort result #'(lambda (a b)</span>
<span style="color: #af0000;">;;                        </span><span style="color: #af0000;">(&lt; (car a) (car b))))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(setf (getf vacancy :tags)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(bprint result))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">))</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-1-3-2-4"></a><span class="todo TODO">TODO</span> Я хочу выделить из описания разделы<br  /><div class="outline-text-5" id="text-1-3-2-4">
<p>
В описании есть списки, у списков есть заголовок, этот заголовок является
вариацией на:
</p>
<ul class="org-ul">
<li>Сведения о компании
</li>
<li>Обязанности
</li>
<li>Требования
</li>
<li>Условия
</li>
</ul>

<p>
Встречаются такие варианты:
</p>
<ul class="org-ul">
<li>Задачи
</li>
<li>Какие задачи предстоит решать
</li>
<li>Ключевые цели
</li>
<li>Мы предлагаем
</li>
<li>Мы хотим видеть тебя в своей команде, если ты
</li>
<li>Какие задачи мы решаем
</li>
<li>Как устроено внутри
</li>
<li>О компании
</li>
<li>Должностные обязанности
</li>
<li>Условия сотрудничества
</li>
</ul>

<p>
По этим данным можно классифицировать вакансии и снабдить их тегами. Алгоритм
разделения на подблоки такой:
</p>
<ul class="org-ul">
<li>Прочитать описание вакансии
</li>
<li>Найти все списки - позиции начала и окончания всех списков
</li>
<li>Для каждого списка
<ul class="org-ul">
<li>Найти предыдущий блок, который начинается с большой буквы и заканчивается двоеточием
</li>
<li>Если он не является списком и не похож на длинный абзац текста - считать его
заголовком списка
</li>
<li>Классифицировать заголовок, отнеся его к одному из трех классов
</li>
</ul>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #af0000;">;; </span><span style="color: #af0000;">(in-package :moto)</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">;; (read-from-string</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(descr (car (find-vacancy :src-id 17340689))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *tst*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">'((:P)</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:B) "Instamoney")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">"- &#1085;&#1086;&#1074;&#1099;&#1081; &#1084;&#1077;&#1078;&#1076;&#1091;&#1085;&#1072;&#1088;&#1086;&#1076;&#1085;&#1099;&#1081; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090; &#1074; &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1086;&#1074;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080;."</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">"Instamoney - &#1101;&#1090;&#1086; &#1088;&#1077;&#1074;&#1086;&#1083;&#1102;&#1094;&#1080;&#1086;&#1085;&#1085;&#1086;&#1077; &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1086;&#1074;&#1086;&#1077; &#1088;&#1077;&#1096;&#1077;&#1085;&#1080;&#1077; &#1076;&#1083;&#1103; &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;-&#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1085;&#1080;&#1084;&#1072;&#1090;&#1077;&#1083;&#1077;&#1081;.")</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P) "&#1057;&#1077;&#1081;&#1095;&#1072;&#1089; &#1084;&#1099; &#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1091;")</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:B) "&#1059; &#1085;&#1072;&#1089; &#1086;&#1090;&#1082;&#1088;&#1099;&#1090;&#1086; 2 &#1087;&#1086;&#1079;&#1080;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103; PHP"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:B) "&#1047;&#1072;&#1076;&#1072;&#1095;&#1080;:"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P) "&#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072; &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1086;&#1074;&#1086;&#1075;&#1086; &#1089;&#1077;&#1088;&#1074;&#1080;&#1089;&#1072;")</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:UL)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "API &#1076;&#1083;&#1103; &#1080;&#1085;&#1090;&#1077;&#1075;&#1088;&#1072;&#1094;&#1080;&#1080; &#1089; &#1082;&#1083;&#1080;&#1077;&#1085;&#1090;&#1072;&#1084;&#1080;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1060;&#1080;&#1085;&#1072;&#1085;&#1089;&#1086;&#1074;&#1086;-&#1091;&#1095;&#1077;&#1090;&#1085;&#1091;&#1102; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1091;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1057;&#1083;&#1086;&#1078;&#1085;&#1099;&#1077; &#1072;&#1085;&#1072;&#1083;&#1080;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1085;&#1072; &#1086;&#1089;&#1085;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1089;&#1073;&#1086;&#1088;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1089;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1093; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1056;&#1086;&#1083;&#1077;&#1074;&#1091;&#1102; &#1084;&#1086;&#1076;&#1077;&#1083;&#1100; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1072; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1088;&#1072;&#1073;&#1086;&#1095;&#1077;&#1075;&#1086; &#1084;&#1077;&#1089;&#1090;&#1072;;"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:B) "&#1058;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;:"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:UL)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "PHP &#1074;&#1077;&#1088;&#1089;&#1080;&#1080; 7.0.0 - &#1076;&#1083;&#1103; &#1082;&#1086;&#1076;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1083;&#1086;&#1075;&#1080;&#1082;&#1080;.")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1056;&#1077;&#1083;&#1103;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1093;&#1088;&#1072;&#1085;&#1080;&#1083;&#1080;&#1097;&#1072;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "TDD &#1087;&#1086;&#1076;&#1093;&#1086;&#1076;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "SOA &#1087;&#1086;&#1076;&#1093;&#1086;&#1076; - &#1076;&#1083;&#1103; &#1073;&#1099;&#1089;&#1090;&#1088;&#1086;&#1075;&#1086; &#1084;&#1072;&#1089;&#1096;&#1090;&#1072;&#1073;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;;"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:P)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:B) "&#1052;&#1099; &#1087;&#1088;&#1077;&#1076;&#1083;&#1072;&#1075;&#1072;&#1077;&#1084; &#1091;&#1089;&#1087;&#1077;&#1096;&#1085;&#1099;&#1084; &#1082;&#1072;&#1085;&#1076;&#1080;&#1076;&#1072;&#1090;&#1072;&#1084;:"))</span>
<span style="color: #af0000;">;;     </span><span style="color: #af0000;">((:UL)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1042;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086;&#1089;&#1090;&#1100; &#1089; \"0\" &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100; &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1086;&#1074;&#1099;&#1081; &#1087;&#1088;&#1086;&#1076;&#1091;&#1082;&#1090;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1042;&#1099;&#1089;&#1086;&#1082;&#1072;&#1103; &#1089;&#1090;&#1077;&#1087;&#1077;&#1085;&#1100; &#1074;&#1083;&#1080;&#1103;&#1085;&#1080;&#1103; &#1085;&#1072; &#1088;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1077; &#1087;&#1088;&#1086;&#1076;&#1091;&#1082;&#1090;&#1072;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1054;&#1092;&#1080;&#1094;&#1080;&#1072;&#1083;&#1100;&#1085;&#1086;&#1077; &#1086;&#1092;&#1086;&#1088;&#1084;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1058;&#1050; &#1056;&#1060;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1060;&#1088;&#1091;&#1082;&#1090;&#1099;/&#1086;&#1074;&#1086;&#1097;&#1080;/&#1089;&#1085;&#1077;&#1082;&#1080; &#1074; &#1082;&#1086;&#1084;&#1092;&#1086;&#1088;&#1090;&#1085;&#1086;&#1084; &#1086;&#1092;&#1080;&#1089;&#1077; &#1091; &#1089;&#1090;.&#1084;. &#1063;&#1082;&#1072;&#1083;&#1086;&#1074;&#1089;&#1082;&#1072;&#1103;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072; &#1087;&#1088;&#1086;&#1092;&#1077;&#1089;&#1089;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086; &#1088;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1103;;")</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">((:LI) "&#1057;&#1074;&#1086;&#1080; &#1089;&#1087;&#1086;&#1088;&#1090;&#1080;&#1074;&#1085;&#1099;&#1077; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1099;, &#1087;&#1086;&#1093;&#1086;&#1076;&#1099;, &#1082;&#1086;&#1088;&#1087;&#1086;&#1088;&#1072;&#1090;&#1080;&#1074;&#1099;")))</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-1-3-2-5"></a>Я хочу вывести вакансию в консоль.<br  /><div class="outline-text-5" id="text-1-3-2-5">
<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;show_vacancy&gt;&gt;

(<span style="color: #af00ff;">define-rule</span> (z-print t)
  (show-vacancy vacancy))
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-3-2-5-1"></a>Печать вакансий (<code>show-vacancy</code>)<br  /><div class="outline-text-6" id="text-1-3-2-5-1">
<p>
Создадим специальную функцию, которая будет выводить вакансии в консоль. Эта функция
будет вызываться из правила, чтобы таким образом можно было реализовать отладочную
печать для наблюдения за работой системы правил:
</p>


<div class="org-src-container">

<pre class="src src-lisp" id="show_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">show-descr</span> (tree)
  (<span style="color: #af00ff;">let</span> ((output (make-string-output-stream))
        (indent 2)
        (prefix <span style="color: #87005f;">""</span>))
    (<span style="color: #af00ff;">labels</span> ((out (format tree)
               (format output <span style="color: #87005f;">"~A~A"</span> (make-string indent <span style="color: #5f5f87;">:initial-element</span> #\Space)
                       (format nil format tree)))
             (rec (tree)
               (<span style="color: #af00ff;">cond</span> ((consp tree) (<span style="color: #af00ff;">cond</span> ((and (equal 2 (length tree))
                                               (equal <span style="color: #5f5f87;">:L</span> (car tree))
                                               (stringp (cadr tree))) (<span style="color: #af00ff;">prog1</span> nil
                                                                        (format output <span style="color: #87005f;">"~A-&gt; ~A~%"</span> prefix (cadr tree))))
                                         ((equal <span style="color: #5f5f87;">:U</span> (car tree)) (<span style="color: #af00ff;">prog1</span> nil
                                                                  (setf prefix (concatenate 'string (make-string indent <span style="color: #5f5f87;">:initial-element</span> #\Space) prefix))
                                                                  (rec (cdr tree))
                                                                  (setf prefix (subseq prefix indent))))
                                         ((and (equal 2 (length tree))
                                               (equal <span style="color: #5f5f87;">:B</span> (car tree))
                                               (stringp (cadr tree))) (format output <span style="color: #87005f;">"~A[~A]~%"</span> prefix (cadr tree)))
                                         (t (cons (rec (car tree))
                                                  (rec (cdr tree))))))
                     (t (<span style="color: #af00ff;">cond</span> ((stringp tree) (format output <span style="color: #87005f;">"~A~A~%"</span> prefix tree)))))))
      (rec tree))
    (get-output-stream-string output)))

(<span style="color: #af00ff;">defmethod</span> <span style="color: #0000ff;">show-vacancy</span> (vacancy)
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(format t "~%")</span>
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(format t (bprint vacancy))           ;</span>
  (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> section-key <span style="color: #5f5f87;">:in</span> vacancy by #'cddr  <span style="color: #5f5f87;">:do</span>
     (format t <span style="color: #87005f;">"~%_______~%~A"</span> (bprint (list section-key (getf vacancy section-key)))))
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(format t "~%~A :~A: ~A [~A]"</span>
  <span style="color: #af0000;">;;      </span><span style="color: #af0000;">(getf vacancy :salary-text)</span>
  <span style="color: #af0000;">;;      </span><span style="color: #af0000;">(getf vacancy :currency)</span>
  <span style="color: #af0000;">;;      </span><span style="color: #af0000;">(getf vacancy :name)</span>
  <span style="color: #af0000;">;;      </span><span style="color: #af0000;">(getf vacancy :id))</span>
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(format t "~%~A" (getf vacancy :emp-name))</span>
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(format t "~A" (show-descr (getf vacancy :descr)))</span>
  )
</pre>
</div>
</div>
</li></ol>
</li>

<li><a id="sec-1-3-2-6"></a><span class="todo TODO">TODO</span> Я хочу занести вакансию в базу.<br  /><div class="outline-text-5" id="text-1-3-2-6">
<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;save_vacancy&gt;&gt;

(<span style="color: #af00ff;">define-rule</span> (z-save t)
  (save-vacancy vacancy)
  <span style="color: #5f5f87;">:stop</span>)
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-1-3-2-6-1"></a>Сохранение вакансии (<code>save-vacancy</code>)<br  /><div class="outline-text-6" id="text-1-3-2-6-1">
<p>
Структура данных вакансии описана в <a href="hh.html">hh.html</a>
</p>

<p>
Напишем процедуру сохранения вакансии в базу данных
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="save_vacancy">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*saved-vacancy*</span> nil)

(<span style="color: #af00ff;">defmethod</span> <span style="color: #0000ff;">save-vacancy</span> (vac)
  (setf *saved-vacancy*
        (append *saved-vacancy*
                (list (make-vacancy
                       <span style="color: #5f5f87;">:src-id</span>      (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:teaser</span> <span style="color: #5f5f87;">:id</span>)
                       <span style="color: #5f5f87;">:name</span>        (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:teaser</span> <span style="color: #5f5f87;">:name</span>)
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:currency    (.&gt; getf vac -&gt; :teaser-compensation :currency)</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:salary      (aif (.&gt; getf vac -&gt; :teaser-compensation :salary) it "")</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:base-salary (aif (.&gt; getf vac -&gt; :teaser-compensation :base-salary) it 0)</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:salary-text (aif (.&gt; getf vac -&gt; :teaser-compensation :salary-text) it "")</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:salary-max  (aif (.&gt; getf vac -&gt; :teaser-compensation :salary-max) it 0)</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:salary-min  (aif (.&gt; getf vac -&gt; :teaser-compensation :salary-min) it 0)</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:emp-id      (aif (.&gt; getf vac -&gt; :vacancy-emp :emp-id) it 0)</span>
                       <span style="color: #5f5f87;">:emp-name</span>    (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:teaser-emp</span> <span style="color: #5f5f87;">:emp-name</span>)
                       <span style="color: #5f5f87;">:city</span>        (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:vacancy-place</span> <span style="color: #5f5f87;">:city</span>)
                       <span style="color: #5f5f87;">:metro</span>       <span style="color: #87005f;">""</span>
                       <span style="color: #5f5f87;">:experience</span>  (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:vacancy-exp</span> <span style="color: #5f5f87;">:exp</span>)
                       <span style="color: #5f5f87;">:archive</span>     (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:teaser</span> <span style="color: #5f5f87;">:archived</span>)
                       <span style="color: #5f5f87;">:date</span>        (aif (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:teaser</span> <span style="color: #5f5f87;">:date</span>) it <span style="color: #87005f;">""</span>)
                       <span style="color: #5f5f87;">:respond</span>     <span style="color: #87005f;">""</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:state       (if nil ":RESPONDED" ":UNSORT")</span>
                       <span style="color: #5f5f87;">:descr</span>       (bprint (.&gt; getf vac -&gt; <span style="color: #5f5f87;">:vacancy-descr</span> <span style="color: #5f5f87;">:long-descr</span>))
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:notes       ""</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:tags        "" ;; (aif (getf vac :tags) it "")</span>
                       <span style="color: #af0000;">;; </span><span style="color: #af0000;">:response "&#1047;&#1076;&#1088;&#1072;&#1074;&#1089;&#1090;&#1074;&#1091;&#1081;&#1090;&#1077;, &#1103; &#1087;&#1086;&#1076;&#1093;&#1086;&#1078;&#1091; &#1087;&#1086;&#1076; &#1074;&#1072;&#1096;&#1080; &#1090;&#1088;&#1077;&#1073;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;. &#1050;&#1086;&#1075;&#1076;&#1072; &#1084;&#1086;&#1078;&#1085;&#1086; &#1076;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088;&#1080;&#1090;&#1100;&#1089;&#1103; &#1086; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080;? &#1052;&#1080;&#1093;&#1072;&#1080;&#1083; 8(911)286-92-90"</span>
                       ))
                       ))
  )
</pre>
</div>
</div>
</li></ol>
</li>

<li><a id="sec-1-3-2-7"></a><span class="todo TODO">TODO</span> Я хочу отправить отклик на вакансию (<code>send-respond</code>)<br  /><div class="outline-text-5" id="text-1-3-2-7">
<p>
Создадим функию, которая будет отправлять отклик на вакансию, чтобы мы могли сделать
соответствующее правило для автоматизированной отправки отклика
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="send_respond">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">send-respond</span> (vacancy-id cookie-jar resume-id letter)
  (<span style="color: #af00ff;">let</span> ((url (format nil <span style="color: #87005f;">"https://spb.hh.ru/vacancy/~A"</span> vacancy-id)))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;</span>
    (<span style="color: #af00ff;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page url cookie-jar *hh_account* <span style="color: #87005f;">"https://spb.hh.ru"</span>)
      <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1086;&#1090;&#1086;&#1084; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; &#1074;&#1089;&#1087;&#1083;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; &#1086;&#1082;&#1085;&#1086; (X-Requested-With: XMLHttpRequest, Referer)</span>
      (<span style="color: #af00ff;">let</span> ((url-popup (format nil <span style="color: #87005f;">"https://spb.hh.ru/applicant/vacancy_response/popup?vacancyId=~A&amp;autoOpen=no&amp;isTest=no&amp;withoutTest=no"</span> vacancy-id)))
        (<span style="color: #af00ff;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page url-popup cookie-jar *hh_account* url)
          <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1091;&#1090; &#1084;&#1086;&#1078;&#1085;&#1086; &#1073;&#1099;&#1083;&#1086; &#1073;&#1099; &#1087;&#1088;&#1086;&#1072;&#1085;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1092;&#1086;&#1088;&#1084;&#1091; &#1085;&#1072; &#1087;&#1088;&#1077;&#1076;&#1084;&#1077;&#1090; &#1089;&#1086;&#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1080;&#1103; &#1074;&#1099;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084;&#1099;&#1093; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
          (<span style="color: #af00ff;">let</span> ((cookie-alist (mapcar #'(<span style="color: #af00ff;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST-&#1079;&#1072;&#1087;&#1088;&#1086;&#1089;</span>
            (<span style="color: #af00ff;">let</span> ((resp (drakma:http-request
                         <span style="color: #87005f;">"https://spb.hh.ru/applicant/vacancy_response/popup"</span>
                         <span style="color: #5f5f87;">:user-agent</span> <span style="color: #87005f;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                         <span style="color: #5f5f87;">:method</span> <span style="color: #5f5f87;">:post</span>
                         <span style="color: #5f5f87;">:content</span> (format nil <span style="color: #87005f;">"~{~A~^&amp;~}"</span>
                                          (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                                                      (format nil <span style="color: #87005f;">"~A=~A"</span> (car x) (cdr x)))
                                                  `((<span style="color: #87005f;">"vacancy_id"</span> . ,(format nil <span style="color: #87005f;">"~A"</span> vacancy-id))
                                                    (<span style="color: #87005f;">"resume_id"</span> . ,(format nil <span style="color: #87005f;">"~A"</span> resume-id))
                                                    (<span style="color: #87005f;">"letter"</span> . ,(drakma:url-encode letter <span style="color: #5f5f87;">:utf-8</span>))
                                                    (<span style="color: #87005f;">"_xsrf"</span> . ,(cdr (assoc <span style="color: #87005f;">"_xsrf"</span> cookie-alist <span style="color: #5f5f87;">:test</span> #'equal)))
                                                    (<span style="color: #87005f;">"ignore_postponed"</span> . <span style="color: #87005f;">"true"</span>))))
                         <span style="color: #5f5f87;">:content-type</span> <span style="color: #87005f;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                         <span style="color: #5f5f87;">:additional-headers</span>
                         `((<span style="color: #87005f;">"Accept"</span> . <span style="color: #87005f;">"*/*"</span>)
                           (<span style="color: #87005f;">"Accept-Language"</span> . <span style="color: #87005f;">"en-US,en;q=0.5"</span>)
                           (<span style="color: #87005f;">"Accept-Encoding"</span> . <span style="color: #87005f;">"gzip, deflate"</span>)
                           (<span style="color: #87005f;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #87005f;">"_xsrf"</span> cookie-alist <span style="color: #5f5f87;">:test</span> #'equal)))
                           (<span style="color: #87005f;">"X-Requested-With"</span> . <span style="color: #87005f;">"XMLHttpRequest"</span>)
                           (<span style="color: #87005f;">"Referer"</span> . ,(format nil <span style="color: #87005f;">"https://spb.hh.ru/vacancy/~A"</span> vacancy-id))
                           (<span style="color: #87005f;">"Connection"</span> . <span style="color: #87005f;">"keep-alive"</span>)
                           (<span style="color: #87005f;">"Pragma"</span> . <span style="color: #87005f;">"no-cache"</span>)
                           (<span style="color: #87005f;">"Cache-Control"</span> . <span style="color: #87005f;">"no-cache"</span>)
                           )
                         <span style="color: #5f5f87;">:cookie-jar</span> cookie-jar
                         <span style="color: #5f5f87;">:redirect</span> 10
                         <span style="color: #5f5f87;">:force-binary</span> t)))
              (flexi-streams:octets-to-string resp <span style="color: #5f5f87;">:external-format</span> <span style="color: #5f5f87;">:utf-8</span>))))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(send-respond "15382394" cookie-jar "39357756" "letter")))</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-3-3" class="outline-4">
<h4 id="sec-1-3-3"><span class="section-number-4">1.3.3</span> Извлечение правил</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
Теперь можно удобным и компактным способом добавить все необходимые правила и
обеспечить методы их обработки. Для удобства сделаем специальные функции для
получения всех правил, правил для тизеров и правил для вакансий.
</p>

<p>
Пока мы будем считать, что правила для отсева тизеров содержать в поле <code>name</code>
"DROP-TEASER-IF".
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;rules_for_vacancy&gt;&gt;

&lt;&lt;rules_for_teasers&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">get-all-rules</span> ()
  (sort
   (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
               (setf (name x)
                     (replace-all (name x) <span style="color: #87005f;">"|"</span> <span style="color: #87005f;">""</span>))
               x)
           (find-rule <span style="color: #5f5f87;">:user-id</span> 1))
   #'(<span style="color: #af00ff;">lambda</span> (a b)
       (string&lt; (name a) (name b)))))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">rules-for-teaser</span> ()
  (remove-if-not #'(<span style="color: #af00ff;">lambda</span> (x)
                     (search <span style="color: #87005f;">"DROP-TEASER-IF"</span> (name x)))
                 (get-all-rules)))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">rules-for-vacancy</span> ()
  (remove-if #'(<span style="color: #af00ff;">lambda</span> (x)
                 (search <span style="color: #87005f;">"DROP-TEASER-IF"</span> (name x)))
             (get-all-rules)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Процессор правил (<code>process</code>)</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Теперь мы можем создать процессор правил <code>process</code>, который применяет к вакансии правила
поочередно. По сути, это <code>машина Э.Поста</code>, а все вместе представляет собой <code>продукционную
систему</code> с прямой цепочкой вывода. Подробнее про продукционные системы <a href="https://www.ngpedia.ru/id429603p1.html">тут</a> и <a href="https://www.myshared.ru/slide/445840/">тут</a>.
</p>

<p>
./img/production<sub>system.gif</sub>]]
</p>

<p>
Процессор правил обрабатывает следущие особые случаи:
</p>
<ul class="org-ul">
<li>Если какое-то из правил возвращает во втором возвращаемом значении <code>:stop</code> -
обработка прекращается и возвращается текущий обработанный результат
</li>
<li>Если какое-то из правил возвращает во втором параметре <code>:renew</code> - то обработка текущего
входного результата начинается с самого первого правила.
</li>
</ul>
<p>
По окончании обработки возвращается результирующая вакансия, которая может быть
модифицирована правилами
</p>

<p>
<img src="./img/process.png" alt="process.png" />
<img src="./img/process.png" alt="process.png" />]]
</p>

<p>
Поскольку мы извлекаем код правил из БД приходится оборачивать их в лямбду и
применять <code>eval</code> и <code>read-from-string</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="process">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">process</span> (vacancy rules)
  (dbg <span style="color: #87005f;">":process: (count rules: ~A)"</span> (length rules))
  (<span style="color: #af00ff;">let</span> ((vacancy vacancy))
    (<span style="color: #af00ff;">tagbody</span>
     renew
       (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> rule <span style="color: #5f5f87;">:in</span> rules <span style="color: #5f5f87;">:do</span>
          (<span style="color: #af00ff;">progn</span>
            (<span style="color: #af00ff;">declaim</span> #+sbcl(sb-ext:muffle-conditions style-warning))
            (<span style="color: #af00ff;">let</span> ((ant (read-from-string (format nil <span style="color: #87005f;">"(lambda (vacancy) ~A)"</span> (antecedent rule))))
                  (con (read-from-string (consequent rule))))
              (<span style="color: #af00ff;">when</span> (funcall (eval ant) vacancy)
                (dbg <span style="color: #87005f;">":process: rule #~A match : ~A"</span> (id rule) (name rule))
                (dbg <span style="color: #87005f;">":process: ant : ~A"</span> (bprint ant))
                <span style="color: #af0000;">;; </span><span style="color: #af0000;">(dbg ":process: con : ~%~A" (bprint con))</span>
                (<span style="color: #af00ff;">multiple-value-bind</span> (vacancy-result rule-result)
                    (funcall (eval `(<span style="color: #af00ff;">lambda</span> (vacancy)
                                      (<span style="color: #af00ff;">let</span> ((result (<span style="color: #af00ff;">progn</span> ,@con)))
                                        (values vacancy result))))
                             vacancy)
                  (setf vacancy vacancy-result)
                  (<span style="color: #af00ff;">when</span> (equal rule-result <span style="color: #5f5f87;">:stop</span>)
                    (<span style="color: #af00ff;">return-from</span> process vacancy))
                  (<span style="color: #af00ff;">when</span> (equal rule-result <span style="color: #5f5f87;">:renew</span>)
                    (<span style="color: #af00ff;">go</span> renew)))))
            (<span style="color: #af00ff;">declaim</span> #+sbcl(sb-ext:unmuffle-conditions style-warning)))))
    vacancy))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">example for verify rules</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">dbg-rule-vac</span> (vac-id rule-id)
  (<span style="color: #af00ff;">let</span> ((vacancy      (car (find-vacancy vac-id)))
        (antecedent   (read-from-string (format nil <span style="color: #87005f;">"(lambda (vacancy) ~A)"</span> (antecedent (get-rule rule-id))))))
    (values
     (funcall (eval antecedent) (get-obj-data vacancy))
     (getf (get-obj-data vacancy) <span style="color: #5f5f87;">:name</span>)
     antecedent)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Декоратор для process-teaser (<code>process-teaser :around</code>)</h3>
<div class="outline-text-3" id="text-1-5">
<p>
Поскольку и вакансии, и их тизеры представлены у нас одинаково, мы можем применять
правила и к тем, и к другим. Это позволит отфильтровать некоторые вакансии только
анализируя их тизеры и не загружать лишнего.
</p>

<p>
Для того, чтобы сделать это удобным образом, обернем (:around method)
<code>process-teaser</code> так, чтобы перед запуском <code>process</code> отфильтровать те тизеры, на
которых сработали правила отсева тизеров.
</p>

<p>
После того как оставшиеся тизеры будут обработаны методом <code>process</code> и тизер
превратиться в вакансию мы применим к ней правила для вакансий.
</p>

<p>
Вот так это выглядит:
</p>

<p>
<img src="./img/around.png" alt="around.png" />
<img src="./img/around.png" alt="around.png" />]]
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="process_teaser_around">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;rules&gt;&gt;

(<span style="color: #af00ff;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> <span style="color: #5f5f87;">:around</span> (current-teaser src-account referer)
  (dbg <span style="color: #87005f;">":process-teaser :around:"</span>)
  (aif (process current-teaser (rules-for-teaser))
       (process (call-next-method it) (rules-for-vacancy))
       nil))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> Получение и обработка вакансий правилами (<code>run</code>)</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Теперь мы можем получить генератор, и, вызывая его, забирать вакансии, пока они не
закончатся. Все вакансии будут корректно обработаны правилами - сначала на этапе получения
тизеров, а потом на этапе получения вакансий.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="run">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

&lt;&lt;define_rule&gt;&gt;

&lt;&lt;process&gt;&gt;

&lt;&lt;process_teaser_around&gt;&gt;

&lt;&lt;factory&gt;&gt;

<span style="color: #af0000;">;; </span><span style="color: #af0000;">moved &lt;&lt;save_vacancy&gt;&gt;</span>

&lt;&lt;send_respond&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">run</span> ()
  (make-event <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"run"</span>
              <span style="color: #5f5f87;">:tag</span> <span style="color: #87005f;">"parser-run"</span>
              <span style="color: #5f5f87;">:msg</span> (format nil <span style="color: #87005f;">"&#1057;&#1073;&#1086;&#1088; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;"</span>)
              <span style="color: #5f5f87;">:author-id</span> 0
              <span style="color: #5f5f87;">:ts-create</span> (get-universal-time))
  (<span style="color: #af00ff;">let</span> ((gen (factory 'hh *hh_account* <span style="color: #87005f;">"spb"</span> <span style="color: #87005f;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
                      <span style="color: #87005f;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)))
    (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> i <span style="color: #5f5f87;">:from</span> 1 <span style="color: #5f5f87;">:to</span> 100 <span style="color: #5f5f87;">:do</span>
       (dbg <span style="color: #87005f;">":run: i=~A"</span> i)
       (<span style="color: #af00ff;">let</span> ((vacancy (funcall gen)))
         (<span style="color: #af00ff;">when</span> (null vacancy)
           (<span style="color: #af00ff;">return</span>))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(run)</span>
</pre>
</div>
</div>

<div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1"><span class="section-number-4">1.6.1</span> Создание правила</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
Определим также макрос, который будет создавать правило
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_rule">(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-rule</span> ((name antecedent) <span style="color: #008700;">&amp;body</span> consequent)
  `(<span style="color: #af00ff;">progn</span>
     (mapcar #'(<span style="color: #af00ff;">lambda</span> (rule)
                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">(when (string= "acitve" (state rule))</span>
                   (del-rule (id rule)))
                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">)</span>
             (find-rule <span style="color: #5f5f87;">:name</span> ,(symbol-name name)))
     (list
      (alexandria:named-lambda
          ,(intern (concatenate 'string (symbol-name name) <span style="color: #87005f;">"-ANTECEDENT-"</span> (symbol-name (gensym)))) (vacancy)
        ,antecedent)
      (alexandria:named-lambda
          ,(intern (concatenate 'string (symbol-name name) <span style="color: #87005f;">"-CONSEQUENT-"</span> (symbol-name (gensym)))) (vacancy)
        (<span style="color: #af00ff;">let</span> ((result (<span style="color: #af00ff;">progn</span> ,@consequent)))
          (values vacancy result)))
      (make-rule <span style="color: #5f5f87;">:name</span> ,(symbol-name name)
                 <span style="color: #5f5f87;">:user-id</span> 1
                 <span style="color: #5f5f87;">:rank</span> 100
                 <span style="color: #5f5f87;">:ruletype</span> <span style="color: #87005f;">":TEASER"</span>
                 <span style="color: #5f5f87;">:antecedent</span> ,(bprint antecedent)
                 <span style="color: #5f5f87;">:consequent</span> ,(bprint consequent)
                 <span style="color: #5f5f87;">:notes</span> <span style="color: #87005f;">""</span>
                 <span style="color: #5f5f87;">:state</span> <span style="color: #87005f;">":ACTIVE"</span>))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">expand</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">'(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #af0000;">;;                                 </span><span style="color: #af0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">:stop))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">test</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #af0000;">;;                                   </span><span style="color: #af0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">:stop)</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(let ((rule (car (find-rule :name "HI-SALARY-JAVA")))</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(vacancy '(:name "Python" :salary 80000)))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(if (funcall (eval (read-from-string (format nil "(lambda (vacancy) ~A)" (antecedent rule))))</span>
<span style="color: #af0000;">;;                </span><span style="color: #af0000;">vacancy)</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(progn</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(multiple-value-bind (vacancy-result rule-result)</span>
<span style="color: #af0000;">;;             </span><span style="color: #af0000;">(funcall (eval `(lambda (vacancy)</span>
<span style="color: #af0000;">;;                               </span><span style="color: #af0000;">(let ((result (progn ,@(read-from-string (consequent rule)))))</span>
<span style="color: #af0000;">;;                                 </span><span style="color: #af0000;">(values vacancy result))))</span>
<span style="color: #af0000;">;;                      </span><span style="color: #af0000;">vacancy)</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(setf vacancy vacancy-result)</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">(print (format nil "vacancy: ~A ||| rule-result: ~A" (bprint vacancy-result) (bprint rule-result)))</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">))))</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Сборка</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-lisp" id="vacancy">(<span style="color: #af00ff;">in-package</span> <span style="color: #5f5f87;">:moto</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">special syntax for pattern-matching - ON</span>
(named-readtables:in-readtable <span style="color: #5f5f87;">:fare-quasiquote</span>)

&lt;&lt;tree_match&gt;&gt;

&lt;&lt;run&gt;&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2017-09-08 Пт 04:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
