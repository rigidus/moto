<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>moto</title>
<!-- 2017-09-08 Пт 05:01 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 86 -*- -->
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">moto</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Введение</a></li>
<li><a href="#sec-2">2. Стартап</a></li>
<li><a href="#sec-3">3. Что улучшать</a></li>
<li><a href="#sec-4">4. Сущности</a>
<ul>
<li><a href="#sec-4-1">4.1. Функции для кодогенерации сущностей</a></li>
<li><a href="#sec-4-2">4.2. Функции для работы с lisp-сущностями</a></li>
<li><a href="#sec-4-3">4.3. События</a></li>
<li><a href="#sec-4-4">4.4. Роли (role)</a></li>
<li><a href="#sec-4-5">4.5. Пользователи (user)</a></li>
<li><a href="#sec-4-6">4.6. Группы (group, user2group)</a></li>
<li><a href="#sec-4-7">4.7. Сообщения (msg)</a></li>
<li><a href="#sec-4-8">4.8. Задачи (task)</a></li>
<li><a href="#sec-4-9">4.9. Очереди (que, quelt)</a></li>
<li><a href="#sec-4-10">4.10. Аватары (avatar)</a></li>
</ul>
</li>
<li><a href="#sec-5">5. События</a></li>
<li><a href="#sec-6">6. Модули</a>
<ul>
<li><a href="#sec-6-1">6.1. Cущности, автоматы и их тесты</a></li>
<li><a href="#sec-6-2">6.2. Авторизация</a></li>
<li><a href="#sec-6-3">6.3. Очереди</a></li>
<li><a href="#sec-6-4">6.4. Сообщения</a></li>
<li><a href="#sec-6-5">6.5. HeadHunter</a></li>
<li><a href="#sec-6-6">6.6. Trend</a></li>
<li><a href="#sec-6-7">6.7. Граббер пользователей мотобратана</a></li>
<li><a href="#sec-6-8">6.8. <span class="todo nilTODO">TODO</span> Граббер тем мотобратана</a></li>
<li><a href="#sec-6-9">6.9. <span class="todo nilTODO">TODO</span> Посты</a></li>
<li><a href="#sec-6-10">6.10. <span class="todo nilTODO">TODO</span> Багзилла</a></li>
<li><a href="#sec-6-11">6.11. <span class="todo nilTODO">TODO</span> Шаринг</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Сборка</a>
<ul>
<li><a href="#sec-7-1">7.1. Утилиты</a></li>
<li><a href="#sec-7-2">7.2. Глобальные определения</a></li>
<li><a href="#sec-7-3">7.3. Каркас проекта</a></li>
<li><a href="#sec-7-4">7.4. Пакеты</a></li>
<li><a href="#sec-7-5">7.5. Подготовка к старту</a></li>
<li><a href="#sec-7-6">7.6. Точка входа</a></li>
<li><a href="#sec-7-7">7.7. Readme</a></li>
<li><a href="#sec-7-8">7.8. Copyright</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Идеи</a>
<ul>
<li><a href="#sec-8-1">8.1. Обозначения и маркировка мотошин</a></li>
<li><a href="#sec-8-2">8.2. Очень интересный способ добавлять фичи</a></li>
<li><a href="#sec-8-3">8.3. Способ вести обсуждение графически</a></li>
<li><a href="#sec-8-4">8.4. MUMPS</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Исследования</a>
<ul>
<li><a href="#sec-9-1">9.1. Graphviz</a></li>
<li><a href="#sec-9-2">9.2. Дракон и sqlite</a></li>
<li><a href="#sec-9-3">9.3. tkl</a></li>
</ul>
</li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Введение</h2>
<div class="outline-text-2" id="text-1">
<p>
Создаем самый посещаемый ресурс по мототематике. Сначала в С-Пб, потом в Москве.
</p>

<p>
Задачи:
</p>
<ul class="org-ul">
<li>Определить интересы целевой аудитории. Клубы, тусовки, небходимые сервисы
</li>
<li>Определить круг зарубежных ресурсов, с которых брать идеи
</li>
<li>Выйти на рекламодателей, определить возможную окупаемость и схемы монетизации
</li>
</ul>

<p>
Отличия от других:
</p>
<ul class="org-ul">
<li>Более демократичный ресурс чем мотобратан:
<ul class="org-ul">
<li>модератор подписывается под баном
</li>
<li>можно баны обсуждать
</li>
<li>сообщество может отменить бан модератора!
</li>
</ul>
</li>
<li>Больше возможностей:
<ul class="org-ul">
<li>поиск людей (ник, имя, район)
</li>
<li>разделы общения:
</li>
<li>по районам - для совместных прохватов (север, юг, пригороды)
</li>
<li>кварталы по классу мотоциклов (спорбайки, эндуро, etc)
<ul class="org-ul">
<li>новости, которые сегментирутся по кварталам.
</li>
<li>пользователь может подписаться на разные кварталы и сформировать ленту, а также на
разных людей (иерархические теги)
</li>
</ul>
</li>
<li>прохваты - календарь
</li>
<li>карта с маршрутами прохватов
</li>
<li>статистика дтп как на motositizen
</li>
<li>отметить темы как прочитанные
</li>
<li>личные сообщения сделать удобнее чем на мотобратане и с поиском
</li>
</ul>
</li>
<li>Больше полезной информации о мотоциклах
<ul class="org-ul">
<li>раздел с мануалами и поиском по мотоциклу
</li>
<li>раздел с поиском по запчастям
</li>
<li>раздел с "у кого спросить" по мотоциклу
</li>
<li>мотосервисы и отзывы о ремонтах
</li>
</ul>
</li>
<li>Никакой надоедливой рекламы (баннеров)
</li>
<li>Разделы
<ul class="org-ul">
<li>УСЛУГИ - в этом разделе пользователь должен увидеть, где какие гаражи можно
арендовать, в каких мастерских можно починиться, где есть мотошколы, где
зарегистрироваться или застраховаться и пр - то есть здесь надо собрать инфу обо всех
услугах, которые могут пригодиться.
</li>
<li>ЗАПЧАСТИ - поиск запчастей как у частных так и по магазинам, отзывы с инфой где
покупал эту запчасть <a href="https://www.louis.de/rubrik/motorradbekleidung-motorradhelme/1">https://www.louis.de/rubrik/motorradbekleidung-motorradhelme/1</a>
</li>
<li>ПРОХВАТЫ
</li>
<li>БЛОГИ - сортировка новостей для удобства поиска (мало ли людям
пригодится). Сортировать по источникам, например - СМИ (то есть газеты и проч
известные сми), блоги, новости сайта.
</li>
<li>УГОНЫ. Совместные рейды против угонов с применением gps-locate
</li>
<li>ДТП
</li>
<li>ГАЛЕРЕЯ - как у харлея или тут <a href="http://www.dorna.com/dornacontents_wsbk.html">http://www.dorna.com/dornacontents_wsbk.html</a>
</li>
<li>Гонки
</li>
<li>Отчеты о путешествиях
</li>
<li>Брендованные страницы сервисов <a href="http://www.cobrausa.com/">http://www.cobrausa.com/</a>
    <a href="https://www.louis.de/katalog/themen-welten/meine-werkstatt">https://www.louis.de/katalog/themen-welten/meine-werkstatt</a>
</li>
<li>Статьи с кармой как на байкпосте
</li>
<li><p>
Раздел для начинающих мотоциклистов
</p>
<ul class="org-ul">
<li>Где учиться (мотошколы)
</li>
<li>Как выбрать мотоцикл, экип (магазины)
</li>
<li>Лайфхаки
</li>
<li>Безопасное вождение
</li>
</ul>
<p>
Разбивку по стажу можно легко сделать из данных по стажу и типу
мото в гараже
</p>
</li>
<li>Мото-дети (кроссовая подготовка, тренера, ШКМГ)
</li>
<li>Мото-мастерские - узнать что ремонтируют и что заказывают
</li>
<li>Мотовыставки и мотофестивали
</li>
</ul>
</li>
<li>Трансляции с мотобратана, байкпоста и других сайтов, например
ру<sub>чп</sub>, в части мотоциклистов
</li>
<li>Специальные тестовые программы устройств для пользователей сайтов
</li>
<li>Места для безопасной парковки мота.
</li>
<li>Мотофлирт с функционалом полноценного сайта знакомств.
</li>
<li>Комментарии ко всему
</li>
<li>Продажа мотоциклов с функицоналом авто.ру и синдикацией с авто.ру и авито
</li>
<li>Юридическая помощь
</li>
<li>Отслеживание камер и радаров (за карму) (по карте)
</li>
<li>Карма
<ul class="org-ul">
<li>отслеживать за что
</li>
<li>привлекать людей к оценке сколько дать за какое действие
</li>
</ul>
</li>
<li>Связь с админами
</li>
<li>Система исправления орфографических (и не только) ошибок сначала для себя, а при
подтверждении автором - и для других. С наглядностью диффа.
</li>
<li>Заметки по юзерам:
<a href="http://vk.com/ekaterina.klochkova">http://vk.com/ekaterina.klochkova</a>
На всякий пожарный.
Ближайшую неделю меня не будет вконтактике.
У меня есть телефон: +79218857023
и почта: kait.klochkova@gmail.com.
</li>
<li>Поиск друзей с кем покататься
Вводишь время, место и радиус, система находит друзей, и пишешь им - давай катать!
</li>
<li>Мототур "по бабам"
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Стартап</h2>
<div class="outline-text-2" id="text-2">
<p>
Одоната
идея. жизнь на пракачку, или как из омеги заальфаться для задротов.
приложение на мобилку, которое раздает тебе очки за то что ты делаешь что-то
душеспасительное и полезное.
связано с форсквэром, считывалкой штрихкодов и прочей поебней.
</p>

<p>
ты логгишься туда и тебе рисуют аватарку тупого дрыща, нихуя не умеющего в этой жизни. у
тебя 0 уровень.
</p>

<p>
ты получаешь очки, когда отслеживалка находит тебя в фитнес-клубах, центрах обучения и
т.д. если ты там появляешься регулярно - очки удваиваются, пока не поломаешь цепь
регулярности. то есть 20 посещений качалки дают 20 очков, если ходить как поппало, или 40,
если не ломать периодичность 2 раза в неделю.
небольшое количество баллов получаешь, когда покупаешь полезную жратву или развивающие
книги, гантели. спорт товары, оплачиваешь услуги обучения, медицинские услуги и проч. для
этого используется сканер штрихкодоов
</p>

<p>
растет уровень - растет необходимое количество баллов для достижения следующего.
более ценные баллы можно получить, предоставляя приложению докозательства успехов -
сертификаты об окончании курсов на курсере, сдача нормативов по бегу или прочей хуйне,
которую отмеряет шагометр, встроенный в мобилку, чекины с других концов планеты.
</p>

<p>
задроты - они задроты везде, и зарабатывая баллы будут прокачивать свою жизнь.
</p>

<p>
идея для коммерциализации - заключать контракты с магазинами спорт товаров/ресторанами
здорового питания/ центрами обучения, что бы при оплате их услуг получать бонусные баллы
</p>

<p>
Одоната
по пути побочные квестики - прочитай вот эту книжку, ответь на вопросики по содержанию,
получи полюсик
сходи в такой музейчик, отметься - держи еще один плюсик.
на этой неделе пройдет вот такое мероприятие, сходи, получи супер бонус, а мы денег за
рекламу от организаторов
ага. ток что бы этим заняться мне надо либо с работы уволиться либо бросить спать.
я чо эт хуйню то придумала. я узнада что мой клуб очки начисляет за посещения. и
обнаружила, что как только об этом узнала. частота моих посещений возрасла до 3х раз в
неделю. мне эти балы не дают нихуя. не даж так. НИХУЯШЕНЬКИ
но воспитанное годами мышление задрота не позволяет упустить возможность заработать баллы
</p>

<p>
есть проблема, связанная с тем, что человеки - в общем-то ленивые скоты. а задроты еще и
хитрые ленивые скоты и нужна система контроля.
</p>

<p>
поэтому эту хуйню надо строить изначально с привязкой к кому-нибудь.
идеальный вариант - начать с физического состояния задрота, т.к. это самая болезненная тема
раз, измеряется проще всего два.
берем в одну руку сеть качалок - тот же задрипанный алекс фитнес и привязываем всю эту
лабуду туда.
менеджменту говорим, что ща продажи вырастут так, что охуеете а так же у вас будет мощная
обратная связь с клиентурой.
чувак не только чекинится в зале, но так же имеет возможность раз в месяц подойти к тренеру
и сказать "смари как я умею". тренер проверяет прогресс и говорит - молодца чувак. после
чего на своей мобилке жамкает кнопулю, которая генерит qr-код. чувак считывает своей
мобилой qr-код и переходит на след уровень.
можно привязать персональные тренировки к этой лабуде. тренра жеж все равно дают роуд мап
какй-то мол по понедельникам ты делаешь два притопа три прихлопа, во вторник дрочишь хуй, в
четверг работаешь вот с такими мышцами вот такими упражнениями по столько подходов. для
чувака который первый раз пришел в зал все это - китайская грамота и вылетает из ушей
моментально (я вот в полном ахуе например была) - а тут тренер говорит, мол выполняешь
программу с номером 15, вот те код - чувак его считывает мобилкой и имеет нормальное
рассписание что и когда ему делать. и задно баллы получает.
</p>

<p>
делает это вместе с тренером - получает от тренера код, баллы удваиваются, в зале растут
продажи персональных тренировок.
</p>

<p>
через нное количество времени получаем сеть посетителей сети клубов, которые радостно друг
другу шлют фотаньки с бицухами и дают оценки тренерам (как бонус)
</p>

<p>
и тогда топаем в сеть школ, ну например иностранных языков. та же лабуда. получаешь баллы
за то что приходишь на уроки, после экзамена и перехода на новый уровень владения языком
получаешь от препода код. + мильен баллов и бэйджик.
школам говорим - ща к вам прибежит клиентура в 100500 чуваков из качалок.
потом туда же постепенно добавляем другие напрваления. автошколы, университеты, курсы
повышения квалификации, оздоровительные программы и проч.
</p>

<p>
от всех организаций-участников получаем обратную связь по поводу того, как чувачки наши
развиваются. каждый новый участник получает прирост клиентуры и охуенную рекламную
площадку. участники игрули получают скидку на услугу компаний-участников. мы сидим и
стрижем купоны. вин-вин
</p>

<p>
так как все участники реальны и действительно ходят во все эти хуйни, то мы будем
единственной площадкой, которая может доказать, что отзывы, складирующиеся у нас (а люди
ж те же голуби, им везде срать надо своим мнением) на 100% реальны, а не написаны
пиарщиками или роботами
</p>

<p>
соответственно к нам начинают прибегать посторонние люди что бы получать объективную оченку
мест в которые они хотят вписаться
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Что улучшать</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Типы для полей state нужно задавать как перечисления
</li>
<li>Добавить AJAX и Comet
</li>
<li>Автоматизированная генерация интерфейса для просмотра и редактирования сущностей
</li>
<li>Забираем пользователей с других ресурсов
</li>
<li>Очищалка базы для каждого модуля должна лежать в модуле
</li>
<li>И сущности тоже туда переложить
</li>
<li>Адаптивный дизайн
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Сущности</h2>
<div class="outline-text-2" id="text-4">
<p>
Соберем все сущности и автоматы в один файл <code>src/entityes.lisp</code>
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Функции для кодогенерации сущностей</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Эти функции будут кодогенерировать сущности и автоматы из таблиц с наименованием и
типами полей внутри этого файла.
</p>

<p>
Чтобы emacs не запрашивал подтверждение на каждое исполнение кода,
установим эту настройку:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_org_confirm">(setq org-confirm-babel-evaluate nil)
</pre>
</div>

<p>
Функция <code>outlist</code> нужна для форматирования лисповых списков при генерации в
s-выражения для entity:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="outlist">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">outlist</span> (lst ident fn)
  (<span style="color: #af00ff;">let</span> ((outlist-result '())
        (first  (car lst))
        (middle (butlast (cdr lst)))
        (last   (car (last lst))))
    (<span style="color: #af00ff;">cond</span> ((equal 0 (length lst))
           (push (concat ident <span style="color: #87005f;">"()"</span>) outlist-result))
          ((equal 1 (length lst))
           (push (funcall fn (concat ident <span style="color: #87005f;">"(%s)"</span>) first) outlist-result))
          ((&lt; 1 (length lst))
           (push (funcall fn (concat ident <span style="color: #87005f;">"(%s"</span>) first) outlist-result)
           (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                       (push (funcall fn (concat <span style="color: #87005f;">"\n"</span> ident <span style="color: #87005f;">" %s"</span>) x) outlist-result))
                   middle)
           (push (funcall fn (concat <span style="color: #87005f;">"\n"</span> ident <span style="color: #87005f;">" %s)"</span>) last) outlist-result)))
   outlist-result))
</pre>
</div>

<p>
Начнем с генерации кода из таблицы полей:
</p>

<p>
Это старая версия <code>gen_fields</code>:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_fields_old">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-fields</span> (rows)
  (<span style="color: #af00ff;">let</span> ((result))
    (push <span style="color: #87005f;">"\n"</span> result)
    (push (format <span style="color: #87005f;">"  (%s\n"</span> (butlast (car rows))) result)
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                (push (format <span style="color: #87005f;">"   %s\n"</span> (butlast x)) result))
            (butlast (cdr rows)))
    (push (format <span style="color: #87005f;">"   %s)"</span> (butlast (car (last rows)))) result)
    (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>)))
</pre>
</div>

<p>
А теперь новая версия:
</p>

<p>
При генерации полей из таблиц описания сущностей некоторые поля имеют
имя, но не имеют типа. Это нормально, т.к. они нужны для создания
полей one-to-many при генерации поля для ORM. Такие поля мы выводим
без указания типа.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_fields">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-fields</span> (rows)
  (<span style="color: #af00ff;">let</span> ((fields) (primary) (foreign) (unique))
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (val)
                (<span style="color: #af00ff;">unless</span> (string= <span style="color: #87005f;">""</span> (nth 3 val))
                  (mapcar #'(<span style="color: #af00ff;">lambda</span> (addon-key)
                              (<span style="color: #af00ff;">let</span> (meta-key)
                                (<span style="color: #af00ff;">if</span> (listp addon-key)
                                    (setq meta-key (car addon-key))
                                  (setq meta-key addon-key))
                                (<span style="color: #af00ff;">cond</span>
                                 ((string= meta-key 'primary)
                                  (push (car val) primary))
                                 ((string= meta-key 'one-to-many)
                                  (push (list 'one-to-many (car val) (nth 1 addon-key)) foreign))
                                 ((string= meta-key 'many-to-one)
                                  (push (list 'many-to-one (car val) (nth 1 addon-key)) foreign))
                                 ((string= meta-key 'unique)
                                  (push (car val) unique)))))
                          (read (nth 3 val)))))
            rows)
  (values
     (outlist rows <span style="color: #87005f;">"  "</span>
              (function (<span style="color: #af00ff;">lambda</span> (tpl val)
                          (<span style="color: #af00ff;">if</span> (not (string= <span style="color: #87005f;">""</span> (nth 1 val)))
                               (<span style="color: #af00ff;">if</span> (string= <span style="color: #87005f;">""</span> (nth 2 val))
                                  (format tpl (subseq val 0 2))
                                  (format tpl (subseq val 0 3)))
                            (format tpl (list (car val)))))))
     primary
     (outlist (reverse foreign) <span style="color: #87005f;">"  "</span>
              (function (<span style="color: #af00ff;">lambda</span> (tpl val)
                          (format tpl val))))
     unique)))
</pre>
</div>

<p>
Теперь напишем код, который генерирует код для состояний конечного автомата:
</p>

<p>
Это его старая версия:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_states_old">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-states</span> (rows)
  (<span style="color: #af00ff;">let</span> ((result)
        (hash (make-hash-table <span style="color: #5f5f87;">:test</span> #'equal))
        (states))
    (<span style="color: #af00ff;">dolist</span> (elt rows nil)
      (puthash (cadr elt) nil hash)
      (puthash (cadr (cdr elt))  nil hash))
    (maphash (<span style="color: #af00ff;">lambda</span> (k v)
               (push k states))
             hash)
    (push <span style="color: #87005f;">"\n"</span> result)
    (push <span style="color: #87005f;">"  ("</span> result)
    (<span style="color: #af00ff;">dolist</span> (elt (butlast states))
      (push (format <span style="color: #87005f;">":%s "</span> elt) result))
    (push (format <span style="color: #87005f;">":%s)"</span> (car (last states))) result)
    (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>)))
</pre>
</div>

<p>
А это - новая:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_states">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-states</span> (rows)
  (<span style="color: #af00ff;">let</span> ((result)
        (hash (make-hash-table <span style="color: #5f5f87;">:test</span> #'equal))
        (states))
    (<span style="color: #af00ff;">dolist</span> (elt rows nil)
      (puthash (cadr elt) nil hash)
      (puthash (cadr (cdr elt))  nil hash))
    (maphash (<span style="color: #af00ff;">lambda</span> (k v)
               (push k states))
             hash)
    (push <span style="color: #87005f;">"\n"</span> result)
    (push <span style="color: #87005f;">"  ("</span> result)
    (<span style="color: #af00ff;">dolist</span> (elt (butlast states))
      (push (format <span style="color: #87005f;">":%s "</span> elt) result))
    (push (format <span style="color: #87005f;">":%s)"</span> (car (last states))) result)
    (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>)))
</pre>
</div>

<p>
И добавим к этом генератор действий - т.е. переходов между состояниями:
</p>

<p>
Это старая версия:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_actions_old">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-actions</span> (rows)
  (<span style="color: #af00ff;">let</span> ((result))
    (push <span style="color: #87005f;">"\n"</span> result)
    (<span style="color: #af00ff;">let</span> ((x (car rows)))
      (push (format <span style="color: #87005f;">"  ((:%s :%s :%s)"</span> (cadr x) (cadr (cdr x)) (car x)) result))
    (<span style="color: #af00ff;">if</span> (equal 1 (length rows))
        (push <span style="color: #87005f;">")"</span> result)
      (<span style="color: #af00ff;">progn</span>
        (push <span style="color: #87005f;">"\n"</span> result)
        (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                    (push (format <span style="color: #87005f;">"   (:%s :%s :%s)\n"</span> (cadr x) (cadr (cdr x)) (car x)) result))
                (cdr (butlast rows)))
        (<span style="color: #af00ff;">let</span> ((x (car (last rows))))
          (push (format <span style="color: #87005f;">"   (:%s :%s :%s))"</span> (cadr x) (cadr (cdr x)) (car x)) result))))
    (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>)))
</pre>
</div>

<p>
Это новая:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_actions">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-actions</span> (rows)
  (<span style="color: #af00ff;">let</span> ((result))
    (push <span style="color: #87005f;">"\n"</span> result)
    (<span style="color: #af00ff;">let</span> ((x (car rows)))
      (push (format <span style="color: #87005f;">"  ((:%s :%s :%s)"</span> (cadr x) (cadr (cdr x)) (car x)) result))
    (<span style="color: #af00ff;">if</span> (equal 1 (length rows))
        (push <span style="color: #87005f;">")"</span> result)
      (<span style="color: #af00ff;">progn</span>
        (push <span style="color: #87005f;">"\n"</span> result)
        (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                    (push (format <span style="color: #87005f;">"   (:%s :%s :%s)\n"</span> (cadr x) (cadr (cdr x)) (car x)) result))
                (cdr (butlast rows)))
        (<span style="color: #af00ff;">let</span> ((x (car (last rows))))
          (push (format <span style="color: #87005f;">"   (:%s :%s :%s))"</span> (cadr x) (cadr (cdr x)) (car x)) result))))
    (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>)))
</pre>
</div>

<p>
Плюс к этому нам нужны функции, которые меняют стиль написания идентификаторов:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="change_case">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">split-name</span> (s)
  (split-string
   (<span style="color: #af00ff;">let</span> ((case-fold-search nil))
     (downcase
      (replace-regexp-in-string <span style="color: #87005f;">"</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">(</span><span style="color: #87005f;">[a-z]</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">)</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">(</span><span style="color: #87005f;">[A-Z]</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">)</span><span style="color: #87005f;">"</span> <span style="color: #87005f;">"\\1 \\2"</span> s)))
   <span style="color: #87005f;">"[</span><span style="color: #87005f;">^</span><span style="color: #87005f;">A-Za-z0-9]+"</span>))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">camelcase</span>  (s) (mapconcat 'capitalize (split-name s) <span style="color: #87005f;">""</span>))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">underscore</span> (s) (mapconcat 'downcase   (split-name s) <span style="color: #87005f;">"_"</span>))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">dasherize</span>  (s) (mapconcat 'downcase   (split-name s) <span style="color: #87005f;">"-"</span>))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">colonize</span>   (s) (mapconcat 'capitalize (split-name s) <span style="color: #87005f;">"::"</span>))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">camelscore</span> (s)
  (<span style="color: #af00ff;">cond</span> ((string-match-p <span style="color: #87005f;">"</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">(?:</span><span style="color: #87005f;">[a-z]+_</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">)</span><span style="color: #87005f;">+[a-z]+"</span> s)(dasherize  s))
        ((string-match-p <span style="color: #87005f;">"</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">(?:</span><span style="color: #87005f;">[a-z]+-</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">)</span><span style="color: #87005f;">+[a-z]+"</span> s)(camelcase  s))
        ((string-match-p <span style="color: #87005f;">"</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">(?:</span><span style="color: #87005f;">[A-Z][a-z]+</span><span style="color: #87005f; font-weight: bold;">\\</span><span style="color: #87005f; font-weight: bold;">)</span><span style="color: #87005f;">+$"</span>  s)(colonize   s))
        (t(underscore s)) ))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">camelscore-word-at-point</span> ()
  (interactive)
  (<span style="color: #af00ff;">let*</span> ((case-fold-search nil)
         (beg (and (skip-chars-backward <span style="color: #87005f;">"[:alnum:]:_-"</span>) (point)))
         (end (and (skip-chars-forward  <span style="color: #87005f;">"[:alnum:]:_-"</span>) (point)))
         (txt (buffer-substring beg end))
         (cml (camelscore txt)) )
    (<span style="color: #af00ff;">if</span> cml (<span style="color: #af00ff;">progn</span> (delete-region beg end) (insert cml)))))
</pre>
</div>

<p>
Аналогичным образом напишем генератор, который собирает
POST-запрос из таблицы с двумя столбцами, в первом из которых лежит
ключ, а во втором - значение. Если значение начинается с символа
двоеточия - то мы отправляем его "как есть" (но без двоеточия), а
противном случае мы считаем его accessor-ом и кодируем в url-encode.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_post">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">gen-post</span> (rows var)
  (flet ((rval (val var)
               (<span style="color: #af00ff;">let</span> ((match-result (string-match <span style="color: #87005f;">":"</span> val)))
                 (<span style="color: #af00ff;">if</span> (and (not (null match-result))
                          (= 0 (string-match <span style="color: #87005f;">":"</span> val)))
                     (concat <span style="color: #87005f;">"\""</span> (substring val 1) <span style="color: #87005f;">"\""</span>)
                   (format <span style="color: #87005f;">",(drakma:url-encode (%s %s) :utf-8)"</span> val var)))))
    (<span style="color: #af00ff;">let</span> ((result))
      (push (format <span style="color: #87005f;">"`((\"%s\" . %s)"</span>
                    (caar rows)
                    (rval (cadar rows) var)
                    var)
            result)
      (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                  (push (format <span style="color: #87005f;">"\n  (\"%s\" . %s)"</span>
                                (car x)
                                (rval (cadr x) var)
                                var)
                        result))
              (butlast (cdr rows)))
      (push (format <span style="color: #87005f;">"\n  (\"%s\" . %s))"</span>
                    (caar (last rows))
                    (rval (cadar (last rows)) var)
                    var)
            result)
      (mapconcat 'identity (reverse result) <span style="color: #87005f;">""</span>))))
</pre>
</div>

<p>
Соберем все это в один файл, чтобы загружать перед кодогенерацией проекта:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>

&lt;&lt;gen_org_confirm&gt;&gt;

&lt;&lt;outlist&gt;&gt;

&lt;&lt;change_case&gt;&gt;

&lt;&lt;gen_fields&gt;&gt;

&lt;&lt;gen_states&gt;&gt;

&lt;&lt;gen_actions&gt;&gt;

&lt;&lt;define-entity&gt;&gt;

&lt;&lt;with-entity&gt;&gt;

&lt;&lt;gen_post&gt;&gt;
</pre>
</div>

<p>
И загрузим его:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators">(load-file <span style="color: #87005f;">"generators.el"</span>)
</pre>
</div>

<p>
Теперь у нас есть все необходимое, чтобы написать вызываемые при
tangle генераторы сущностей и автоматов.
</p>

<p>
При создании сущностей и автоматов мы формируем вызов <code>define-entity</code>
или <code>define-automat</code>, предполагая, что параметры передаются в таком
порядке:
</p>
<ul class="org-ul">
<li>Имя сущности/автомата
</li>
<li>Описание
</li>
<li>Список полей
</li>
<li>Список primary-keys
</li>
<li>Список внешних ключей
</li>
<li>Список уникальных ключей
</li>
</ul>

<p>
Затем, для автоматов передаются еще несколько параметров:
</p>
<ul class="org-ul">
<li>Список всех состояний автомата
</li>
<li>Список действий при допустимых переходах
</li>
</ul>

<p>
Это старый вариант генератора сущностей, который не учитывает
реляционные связи:
</p>

<p>
А это новый вариант генератора сущностей:
</p>

<p>
Это старый вариант генератора автоматов, который не учитывает
реляционные связи:
</p>

<p>
А это новый вариант генератора сущностей:
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Функции для работы с lisp-сущностями</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Главный макрос, разворачивающий промежуточное представление сущности в
набор property list с удобным доступом к каждому полю
</p>

<div class="org-src-container">

<pre class="src src-elisp" id="define-entity">(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-entity</span> (name desc slot-descriptions primary foreign unique <span style="color: #008700;">&amp;rest</span> class-options)
  (<span style="color: #af00ff;">let</span> ((fields))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">full initial hash with pair 'field-name' =&gt; 'slot-description'</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span>(slot)
                (<span style="color: #af00ff;">let</span> ((base-data)
                      (name (car (subseq slot 0 1)))
                      (common-type)
                      (default)
                      (nullable)
                      (type)
                      (type-attrs)
                      (attrs))

                  (<span style="color: #af00ff;">if</span> (&lt; 1 (length slot))
                      (setq common-type  (car (subseq slot 1 2))))

                  (<span style="color: #af00ff;">if</span> (&lt; 2 (length slot))
                      (setq default (car (subseq slot 2 3))))

                  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1090;&#1080;&#1087;&#1072; &#1080;&#1079; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072;</span>
                  (<span style="color: #af00ff;">when</span> (and (listp common-type) (string= <span style="color: #87005f;">"or"</span> (car common-type)))
                    (setq type (car (last common-type)))
                    (setq type-attrs (cdr (last common-type)))
                    (setq nullable t))
                  (<span style="color: #af00ff;">when</span> (and (listp common-type) (not (string= <span style="color: #87005f;">"or"</span> (car common-type))))
                    (setq type (car common-type))
                    (setq type-attrs (cdr common-type)))
                  (<span style="color: #af00ff;">if</span> (listp common-type)
                      (setq type (car common-type))
                    (setq type common-type))

                  (<span style="color: #af00ff;">cond</span>
                   ((string= <span style="color: #87005f;">"numeric"</span> type)
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:precision</span> (nth 0 type-attrs)))
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:scale</span> (nth 1 type-attrs))))
                   ((string= <span style="color: #87005f;">"string"</span> type)
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:max</span> (nth 0 type-attrs)))))

                  (setq fields
                        (plist-put fields (car slot)
                                   (list <span style="color: #5f5f87;">:name</span> name
                                         <span style="color: #5f5f87;">:type</span> type
                                         <span style="color: #5f5f87;">:attrs</span> attrs
                                         <span style="color: #5f5f87;">:default</span> default
                                         <span style="color: #5f5f87;">:nullable</span> nullable)))))
            slot-descriptions)

    <span style="color: #af0000;">;; </span><span style="color: #af0000;">let's parse type in more usable format</span>

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">primary</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (primary-field)
                (<span style="color: #af00ff;">let</span> ((field-value (plist-get fields primary-field)))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields primary-field (plist-put field-value <span style="color: #5f5f87;">:primary</span> t)))))
            primary)

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">foreign</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (foreign)
                (<span style="color: #af00ff;">let</span> ((foreign-field (nth 1 foreign))
                      (field-value (plist-get fields (nth 1 foreign))))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields foreign-field (plist-put field-value
                                                               (intern (concat <span style="color: #87005f;">":"</span> (symbol-name (nth 0 foreign))))
                                                               (nth 2 foreign)))))
                )
            foreign)

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">unique</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (unique-field)
                (<span style="color: #af00ff;">let</span> ((field-value (plist-get fields unique-field)))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields unique-field (plist-put field-value <span style="color: #5f5f87;">:unique</span> t)))))
            unique)

    <span style="color: #af0000;">;; </span><span style="color: #af0000;">plist to normal list</span>
    (setq fields (<span style="color: #af00ff;">cl-loop</span> for (key value) on fields by 'cddr
                          collect value
                          ))
    `',fields))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(define-entity message "&#1057;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1100; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1081;"</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">((id serial)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(type integer)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(author integer)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(target_user integer)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(target_holder integer)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(datetime datetime)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(subject (string 127))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(text text)</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(is_read boolean))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(id)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">((many-to-one type (message-type id))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(many-to-one author (user id))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(many-to-one target_user (user id))</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">(many-to-one target_holder (holder id)))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">())</span>

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-automat</span> (name desc slot-descriptions primary foreign unique <span style="color: #008700;">&amp;rest</span> class-options)
  (<span style="color: #af00ff;">let</span>
      ((fields))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">full initial hash with pair 'field-name' =&gt; 'slot-description'</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span>(slot)
                (<span style="color: #af00ff;">let</span> ((base-data)
                      (name (car (subseq slot 0 1)))
                      (common-type)
                      (default)
                      (nullable)
                      (type)
                      (type-attrs)
                      (attrs))

                  (<span style="color: #af00ff;">if</span> (&lt; 1 (length slot))
                      (setq common-type (car (subseq slot 1 2))))
                  (<span style="color: #af00ff;">if</span> (&lt; 2 (length slot))
                      (setq default (car (subseq slot 2 3))))

                  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1090;&#1080;&#1087;&#1072; &#1080;&#1079; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072;</span>
                  (<span style="color: #af00ff;">when</span> (and (listp common-type) (string= <span style="color: #87005f;">"or"</span> (car common-type)))
                    (setq type (car (last common-type)))
                    (setq type-attrs (cdr (last common-type)))
                    (setq nullable t))
                  (<span style="color: #af00ff;">when</span> (and (listp common-type) (not (string= <span style="color: #87005f;">"or"</span> (car common-type))))
                    (setq type (car common-type))
                    (setq type-attrs (cdr common-type)))
                  (<span style="color: #af00ff;">if</span> (listp common-type)
                      (setq type (car common-type))
                    (setq type common-type))

                  (<span style="color: #af00ff;">cond</span>
                   ((string= <span style="color: #87005f;">"numeric"</span> type)
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:precision</span> (nth 0 type-attrs)))
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:scale</span> (nth 1 type-attrs))))
                   ((string= <span style="color: #87005f;">"string"</span> type)
                    (setq attrs (plist-put attrs <span style="color: #5f5f87;">:max</span> (nth 0 type-attrs)))))

                  (setq fields
                        (plist-put fields (car slot)
                                   (list <span style="color: #5f5f87;">:name</span> name
                                         <span style="color: #5f5f87;">:type</span> type
                                         <span style="color: #5f5f87;">:attrs</span> attrs
                                         <span style="color: #5f5f87;">:default</span> default
                                         <span style="color: #5f5f87;">:nullable</span> nullable)))))
            slot-descriptions)

    <span style="color: #af0000;">;; </span><span style="color: #af0000;">let's parse type in more usable format</span>

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">primary</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (primary-field)
                (<span style="color: #af00ff;">let</span> ((field-value (plist-get fields primary-field)))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields primary-field (plist-put field-value <span style="color: #5f5f87;">:primary</span> t)))))
            primary)

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">foreign</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (foreign)
                (<span style="color: #af00ff;">let</span> ((foreign-field (nth 1 foreign))
                      (field-value (plist-get fields (nth 1 foreign))))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields foreign-field (plist-put field-value
                                                               (intern (concat <span style="color: #87005f;">":"</span> (symbol-name (nth 0 foreign))))
                                                               (nth 2 foreign)))))
                )
            foreign)

    <span style="color: #af0000;">;;</span><span style="color: #af0000;">unique</span>
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (unique-field)
                (<span style="color: #af00ff;">let</span> ((field-value (plist-get fields unique-field)))
                  (<span style="color: #af00ff;">when</span> field-value
                    (plist-put fields unique-field (plist-put field-value <span style="color: #5f5f87;">:unique</span> t)))))
            unique)

    <span style="color: #af0000;">;; </span><span style="color: #af0000;">plist to normal list</span>
    (setq fields (<span style="color: #af00ff;">cl-loop</span> for (key value) on fields by 'cddr
                          collect value
                          ))
    `',fields))
</pre>
</div>


<p>
Теперь необходимо определить функцию, что будет вытягивать
сгенерированное представление сущности из ее файла и отдавать
запрошенные дополнительным параметром поля. Если список полей
отсутствует или пустой, будет возвращен полный список полей сущности.
</p>


<div class="org-src-container">

<pre class="src src-elisp" id="with-entity">(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-entity</span> (entity <span style="color: #008700;">&amp;optional</span> fields)
  (<span style="color: #af00ff;">let</span> ((entity-data)
        (result-fields)
        (need-fields))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1076;&#1086;&#1089;&#1090;&#1072;&#1077;&#1084; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1100; &#1080;&#1079; &#1089;&#1075;&#1077;&#1085;&#1077;&#1088;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1092;&#1072;&#1081;&#1083;&#1072;</span>
    (setq entity-data
          (eval (read
                 (<span style="color: #af00ff;">with-temp-buffer</span>
                   (insert-file-contents
                    (concat <span style="color: #87005f;">"./src/"</span> (symbol-name entity) <span style="color: #87005f;">"-entity.lisp"</span>))
                   (buffer-string)))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1080;&#1083;&#1100;&#1090;&#1088; &#1087;&#1086; &#1079;&#1072;&#1087;&#1088;&#1086;&#1096;&#1077;&#1085;&#1085;&#1099;&#1084; &#1087;&#1086;&#1083;&#1103;&#1084;</span>
    (<span style="color: #af00ff;">when</span> fields
      (mapcar #'(<span style="color: #af00ff;">lambda</span> (field)
                  (<span style="color: #af00ff;">if</span> (listp field)
                      (setq need-fields (plist-put need-fields (car field) (cdr field)))
                    (setq need-fields (plist-put need-fields field nil))))
              fields))
    (<span style="color: #af00ff;">if</span> need-fields
        (setq result-fields
              (apply #'append
                     (mapcar #'(<span style="color: #af00ff;">lambda</span> (entity-field)
                                 (setq field-name (plist-get entity-field <span style="color: #5f5f87;">:name</span>))
                                 (<span style="color: #af00ff;">if</span> (not (plist-member need-fields field-name))
                                     nil
                                   (setq result-field
                                         (<span style="color: #af00ff;">if</span> (plist-get need-fields field-name)
                                             (append entity-field
                                                     (plist-get need-fields field-name))
                                           entity-field))
                                   (setq result-field (plist-put result-field <span style="color: #5f5f87;">:entity</span> entity))
                                   (list result-field)))
                             entity-data)))

      <span style="color: #af0000;">;;</span><span style="color: #af0000;">[TODO:bgg] &#1101;&#1090;&#1086;&#1090; &#1073;&#1083;&#1086;&#1082; &#1084;&#1086;&#1078;&#1085;&#1086; &#1087;&#1077;&#1088;&#1077;&#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1083;&#1091;&#1095;&#1096;&#1077;, &#1080;&#1079;&#1073;&#1077;&#1078;&#1072;&#1074; &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1082;&#1086;&#1076;&#1072;</span>
      (setq result-fields
            (apply #'append
                   (mapcar #'(<span style="color: #af00ff;">lambda</span> (entity-field)
                               (setq result-field (plist-put entity-field <span style="color: #5f5f87;">:entity</span> entity))
                               (list result-field))
                           entity-data))))
    `',result-fields))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1076;&#1083;&#1103; message-entity &#1073;&#1077;&#1079; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1099;&#1093; &#1087;&#1086;&#1083;&#1077;&#1081;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(message "%s"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">(with-entity message))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1076;&#1083;&#1103; message-entity &#1089;&#1086; &#1089;&#1087;&#1080;&#1089;&#1082;&#1086;&#1084; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1099;&#1093; &#1087;&#1086;&#1083;&#1077;&#1081;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(message "%s"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">(with-entity message</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(id target_user target_holder)))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(print</span>
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">(pp</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(macroexpand-all</span>
<span style="color: #af0000;">;;    </span><span style="color: #af0000;">'(with-entity message</span>
<span style="color: #af0000;">;;                  </span><span style="color: #af0000;">(id</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">target_user</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">target_holder</span>
<span style="color: #af0000;">;;                   </span><span style="color: #af0000;">(text :label "Your message"))))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> События</h3>
<div class="outline-text-3" id="text-4-3">
<p>
События протоколируют все что происходит в системе. Каждое создание
сущности, каждое изменение состояния автомата регистрируется
здесь. Роботы используют эти события для своей работы. Также
информация о событиях попадает на главную страницу.
</p>

<p>
Событие является простой сущностью и не имеет состояния.
</p>

<table id="event_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Данные события</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">имя события</td>
</tr>

<tr>
<td class="left">tag</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">тег события</td>
</tr>

<tr>
<td class="left">msg</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">сообщение или описание</td>
</tr>

<tr>
<td class="left">author-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">инициатор события</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время события</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код:
</p>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Роли (role)</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Роли определяют набор сценариев, которые пользователь выполняет на
сайте. Функционал, который выполняют сценарии запрашивает
разрешение на выполнение действий, которое опирается на роль,
присвоенную пользователю. Пользователь может иметь только одну роль
или не иметь ее вовсе.
</p>

<p>
Роль является простой сущностью и не имеет состояния.
</p>

<table id="role_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Данные роли</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">описание</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код и cоздадим необходимые роли:
</p>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Пользователи (user)</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Для начала надо определиться, какие данные мы собираемся хранить о пользователях, и
какого типа будут эти данные. Типы данных задаем в формате <code>Postmodern</code> чтобы потом
сохранить данные в <code>PostgreSQL</code>
</p>

<table id="user_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Данные пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">никнейм пользователя</td>
</tr>

<tr>
<td class="left">password</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">пароль</td>
</tr>

<tr>
<td class="left">email</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">емейл</td>
</tr>

<tr>
<td class="left">firstname</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">lastname</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">фамилия</td>
</tr>

<tr>
<td class="left">phone</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">телефон</td>
</tr>

<tr>
<td class="left">mobilephone</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">мобильный телефон</td>
</tr>

<tr>
<td class="left">sex</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">пол</td>
</tr>

<tr>
<td class="left">birth-day</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">день рождения</td>
</tr>

<tr>
<td class="left">birth-month</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">месяц рождения</td>
</tr>

<tr>
<td class="left">birth-year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">год рождения</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время регистрации</td>
</tr>

<tr>
<td class="left">ts-last</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время последнего действия</td>
</tr>

<tr>
<td class="left">role-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор роли</td>
</tr>
</tbody>
</table>

<p>
В нашей системе пользователь может существовать (или не существовать) в одном из
нескольких состояний:
</p>
<ul class="org-ul">
<li>Когда пользователь еще не зарегистрирован на сайте мы можем считать его
незарегистрированным (<code>unregistred</code>)
</li>
<li>После регистрации он автоматически становится залогиненным (<code>logged</code>)
</li>
<li>Пользователь может покинуть сайт и перейти в состояние <code>unlogged</code>
</li>
<li>Пользователь может забыть свой пароль, тогда мы должны выслать ему ссылку для
восстановления пароля (<code>sended</code>)
</li>
<li>И наконец, после восстановления пароля пользователь вновь становится залогиненным
(<code>logged</code>)
</li>
</ul>

<p>
Все эти переходы и состояния сведем в единую таблицу:
</p>

<table id="user_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Состояния конечного автомата пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">registration</td>
<td class="left">unregistred</td>
<td class="left">logged</td>
</tr>

<tr>
<td class="left">unregistration</td>
<td class="left">logged</td>
<td class="left">unregistred</td>
</tr>

<tr>
<td class="left">enter</td>
<td class="left">unlogged</td>
<td class="left">logged</td>
</tr>

<tr>
<td class="left">leave</td>
<td class="left">logged</td>
<td class="left">unlogged</td>
</tr>

<tr>
<td class="left">forgot</td>
<td class="left">unlogged</td>
<td class="left">sended</td>
</tr>

<tr>
<td class="left">remember</td>
<td class="left">sended</td>
<td class="left">logged</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение пользователя как конечный автомат:
</p>


<div class="figure">
<p><img src="img/user-state.png" alt="user-state.png" />
</p>
</div>

<p>
Для того чтобы избежать дублирования ников и связанной с этим
ситуации, когда один пользователь выдает себя за другого, следует
определить констрейнт на уникальность поля <code>name</code> и <code>email</code>
</p>

<p>
Так как в системе все пользователи тесно связаны с ролями, следует
определить внешний ключ на таблицу ролей:
</p>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на
переходах из одного состояния в другое. Также установим ограничение
на колонку <code>name</code> чтобы избежать дублирования ников.
</p>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> Группы (group, user2group)</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Группы пользователей определяют набор операций, которые
пользователь может выполнять над объектами системы. В отличие от
ролей, один пользователь может входить в несколько групп или не
входить ни в одну из них.
</p>

<p>
Группа является простой сущностью и не имеет состояния.
</p>

<table id="group_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Данные группы</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">имя группы</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">описание группы</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время создания группы</td>
</tr>

<tr>
<td class="left">author-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор создателя группы</td>
</tr>
</tbody>
</table>

<p>
Сгенерируем код и создадим необходимые группы:
</p>

<p>
Теперь создадим таблицу связи, которая свяжет пользователей и группы:
</p>

<table id="user2group_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Данные таблицы связи пользователя и группы</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">user-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор пользователя</td>
</tr>

<tr>
<td class="left">group-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор группы</td>
</tr>
</tbody>
</table>

<p>
Чтобы пары в таблице связи удалялись при удалении связанных групп и
пользователей следует установить on-delete foreigh keys.
</p>

<p>
И сгенерируем код для нее:
</p>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> Сообщения (msg)</h3>
<div class="outline-text-3" id="text-4-7">
<p>
О сообщениях мы знаем только от кого они посылаются, кому и собственно текст
сообщения. Его наверно не стоит ограничивать. По идее как посылающий, так и принимающий
может удалить сообщение (пометить как удаленное), для этого мы используем отдельные
флаги.
</p>

<table id="msg_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Данные сообщения</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">snd-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">пользователь, который послал сообщение</td>
</tr>

<tr>
<td class="left">rcv-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">пользователь, который получает сообщение</td>
</tr>

<tr>
<td class="left">msg</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">сообщение</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время создания</td>
</tr>

<tr>
<td class="left">ts-delivery</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время доставки</td>
</tr>
</tbody>
</table>

<p>
Еще сообщение может быть доставлено или недоставлено.
</p>

<table id="msg_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Состояния конечного автомата сообщения</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">delivery</td>
<td class="left">undelivered</td>
<td class="left">delivered</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на переходах
</p>
</div>
</div>

<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> Задачи (task)</h3>
<div class="outline-text-3" id="text-4-8">
<table id="task_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Данные задачи</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">название</td>
</tr>

<tr>
<td class="left">blockdata</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">суть задачи или данные</td>
</tr>

<tr>
<td class="left">owner-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор владельца</td>
</tr>

<tr>
<td class="left">exec-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор исполнителя</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время регистрации</td>
</tr>
</tbody>
</table>

<p>
В нашей системе задача может существовать  в одном из
нескольких состояний:
</p>
<ul class="org-ul">
<li>Создана, но еще ни разу не исполнялась (<code>new</code>).
</li>
<li>Исполняется в данный момент (<code>inaction</code>)
</li>
<li>Была исполнена но еще не завершена, возможно потребуется исполнять
еще раз или по расписанию (<code>standby</code>)
</li>
<li>Отменена (<code>cancelled</code>)
</li>
<li>Завершена (<code>terminated</code>)
</li>
</ul>

<p>
Все эти переходы и состояния сведем в единую таблицу:
</p>

<table id="task_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Состояния конечного автомата пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">starttask</td>
<td class="left">new</td>
<td class="left">inaction</td>
</tr>

<tr>
<td class="left">stoptask</td>
<td class="left">inaction</td>
<td class="left">standby</td>
</tr>

<tr>
<td class="left">restarttask</td>
<td class="left">standby</td>
<td class="left">inaction</td>
</tr>

<tr>
<td class="left">cancelnewtask</td>
<td class="left">new</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">cancelactiontask</td>
<td class="left">inaction</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">cancelstandbytask</td>
<td class="left">standby</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">terminateactiontask</td>
<td class="left">inaction</td>
<td class="left">terminated</td>
</tr>

<tr>
<td class="left">terminatestandbytask</td>
<td class="left">standby</td>
<td class="left">terminated</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение пользователя как конечный автомат:
</p>


<div class="figure">
<p><img src="img/task-state.png" alt="task-state.png" />
</p>
</div>

<p>
Для того чтобы избежать дублирования задач, следует определить
констрейнт на уникальность поля <code>name</code>
</p>

<p>
Так как в системе все пользователи тесно связаны с задачами,
следует определить внешний ключ на таблицу пользователей так, чтобы
при удалении пользователей-владельцев задач удалялись и их задачи.
</p>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на
переходах из одного состояния в другое. Также установим ограничение
на колонку <code>name</code> чтобы избежать дублирования ников.
</p>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> Очереди (que, quelt)</h3>
<div class="outline-text-3" id="text-4-9">
<p>
Очереди используются для фолловинга и прочей подписки на обновления.
</p>

<p>
Нам нужна некоторая инфраструктура чтобы абстрагироваться от операций управления
очередями, подписчиками и посылки сообщений. Потом ее можно будет изменить для поддержки
RabbitMQ, Mbus или ZMQ или даже использовать все их одновременно для разных целей.
</p>

<p>
Очередь является простой сущностью и не имеет состояния.
</p>

<table id="que_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Данные очереди</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">имя очереди</td>
</tr>
</tbody>
</table>

<p>
Нам понадобится сущность элемента очереди, назовем его <code>quelt</code>. Элемент очереди является
простой сущностью и не имеет состояния.
</p>

<table id="quelt_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Данные элемента очереди</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">que-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор очереди</td>
</tr>

<tr>
<td class="left">text</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">содержимое</td>
</tr>
</tbody>
</table>

<p>
Сгенерируем код и создадим необходимые очереди:
</p>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> Аватары (avatar)</h3>
<div class="outline-text-3" id="text-4-10">
<p>
Пользователи имеют неопределенное кол-во аватарок, разного размера, для которых мы
осуществляем хранение в оригинальном размере, масштабирование и хранение
отмасштабированных превьюшек.
</p>

<table id="avatar_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> Данные аватарки</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">default</th>
<th scope="col" class="left">meta</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">&#xa0;</td>
<td class="left">(primary)</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">user-id</td>
<td class="left">integer</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">идентификатор пользователя</td>
</tr>

<tr>
<td class="left">origin</td>
<td class="left">varchar</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">путь к файлу оригинального размера</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">время создания</td>
</tr>
</tbody>
</table>

<p>
Одна из автарок может быть активной в данный момент.
</p>

<table id="avatar_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Состояния конечного автомата пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">avatar-off</td>
<td class="left">active</td>
<td class="left">inactive</td>
</tr>

<tr>
<td class="left">avatar-on</td>
<td class="left">inactive</td>
<td class="left">active</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на переходах
</p>

<p>
Когда какому-нибудь коду необходимо отобразить аватар он может
получить путь к аватару, передав идентификатор пользователя и
необходимый размер:
</p>

<p>
В будущем этот код будет генерироваться из исполняемой спецификации
размеров и путей к аватаркам
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> События</h2>
<div class="outline-text-2" id="text-5">
<p>
Мы используем события, чтобы отслеживать и логгировать изменения в системе, которые
происходят в ответ на действия внешних сил.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="events"><span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #af0000;">;;;; </span><span style="color: #af0000;">events.lisp</span>

(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Модули</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Cущности, автоматы и их тесты</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_entity">(<span style="color: #5f5f87;">:module</span> <span style="color: #87005f;">"entity"</span>
         <span style="color: #5f5f87;">:serial</span> t
         <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"mod"</span>
         <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"entity"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Авторизация</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_auth">(<span style="color: #5f5f87;">:module</span> <span style="color: #87005f;">"auth"</span>
         <span style="color: #5f5f87;">:serial</span> t
         <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"mod/auth"</span>
         <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:static-file</span> <span style="color: #87005f;">"auth-tpl.htm"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"auth"</span>)))
</pre>
</div>

<p>
Как пользователь, я хочу иметь возможность ввести логин и пароль чтобы получить доступ к
закрытому от неавторизованных пользователей функционалу.
</p>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Очереди</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_que">(<span style="color: #5f5f87;">:module</span> <span style="color: #87005f;">"que"</span>
         <span style="color: #5f5f87;">:serial</span> t
         <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"mod/que"</span>
         <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"que"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> Сообщения</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_msg">(<span style="color: #5f5f87;">:module</span> <span style="color: #87005f;">"msg"</span>
         <span style="color: #5f5f87;">:serial</span> t
         <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"mod/msg"</span>
         <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"msg"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> HeadHunter</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">

<pre class="src src-lisp" id="mod_hh">(<span style="color: #5f5f87;">:module</span> <span style="color: #87005f;">"hh"</span>
         <span style="color: #5f5f87;">:serial</span> t
         <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"mod/hh"</span>
         <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"m-util"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"f-util"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"util"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"globals"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"entityes"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"hh"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"vacancy"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"resume"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"response"</span>)
                      (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"iface"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> Trend</h3>
<div class="outline-text-3" id="text-6-6">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_trend"><span style="color: #af0000;">;; </span><span style="color: #af0000;">(:module "trend"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:serial t</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:pathname "mod/trend"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:components ((:static-file "trend-tpl.htm")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(:file "trend-prepare")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(:file "entityes")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(:file "loader")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(:file "trend")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(:file "iface")))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-7" class="outline-3">
<h3 id="sec-6-7"><span class="section-number-3">6.7</span> Граббер пользователей мотобратана</h3>
<div class="outline-text-3" id="text-6-7">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_bratan"><span style="color: #af0000;">;; </span><span style="color: #af0000;">(:module "bratan"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:serial t</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:pathname "mod/bratan"</span>
<span style="color: #af0000;">;;          </span><span style="color: #af0000;">:components ((:file "bratan")))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-8" class="outline-3">
<h3 id="sec-6-8"><span class="section-number-3">6.8</span> <span class="todo TODO">TODO</span> Граббер тем мотобратана</h3>
</div>
<div id="outline-container-sec-6-9" class="outline-3">
<h3 id="sec-6-9"><span class="section-number-3">6.9</span> <span class="todo TODO">TODO</span> Посты</h3>
</div>
<div id="outline-container-sec-6-10" class="outline-3">
<h3 id="sec-6-10"><span class="section-number-3">6.10</span> <span class="todo TODO">TODO</span> Багзилла</h3>
</div>
<div id="outline-container-sec-6-11" class="outline-3">
<h3 id="sec-6-11"><span class="section-number-3">6.11</span> <span class="todo TODO">TODO</span> Шаринг</h3>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Сборка</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Утилиты</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">

<pre class="src src-lisp" id="utility_file">   <span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
   <span style="color: #af0000;">;;;; </span><span style="color: #af0000;">util.lisp</span>

(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1088;&#1077;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1080;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086;&#1083;&#1103; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1072; &#1074; plist</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">get-obj-data</span> (obj)
  (<span style="color: #af00ff;">let</span> ((class (find-class (type-of obj)))
        (result))
    (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> slot <span style="color: #5f5f87;">:in</span> (closer-mop:class-direct-slots class) <span style="color: #5f5f87;">:collect</span>
       (<span style="color: #af00ff;">let</span> ((slot-name (closer-mop:slot-definition-name slot)))
         (<span style="color: #af00ff;">when</span> (slot-boundp obj slot-name)
           (setf result
                 (append result (list (intern (symbol-name slot-name) <span style="color: #5f5f87;">:keyword</span>)
                                      (funcall slot-name obj)))))))
    result))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">Assembly WHERE clause</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">make-clause-list</span> (glob-rel rel args)
  (append (list glob-rel)
          (<span style="color: #af00ff;">loop</span>
             <span style="color: #5f5f87;">:for</span> i
             <span style="color: #5f5f87;">:in</span> args
             <span style="color: #5f5f87;">:when</span> (and (symbolp i)
                        (getf args i)
                        (not (symbolp (getf args i))))
             <span style="color: #5f5f87;">:collect</span> (list rel i (getf args i)))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1072;&#1082;&#1088;&#1086;&#1089;&#1099; &#1076;&#1083;&#1103; &#1082;&#1086;&#1088;&#1088;&#1077;&#1082;&#1090;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1074;&#1086;&#1076;&#1072; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">bprint</span> (var)
  `(subseq (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)  (pprint ,var)) 1))

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">err</span> (var)
  `(<span style="color: #ff0000; font-weight: bold;">error</span> (format nil <span style="color: #87005f;">"ERR:[~A]"</span> (bprint ,var))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1054;&#1090;&#1083;&#1072;&#1076;&#1086;&#1095;&#1085;&#1099;&#1081; &#1074;&#1099;&#1074;&#1086;&#1076;</span>
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*dbg-enable*</span> t)
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*dbg-indent*</span> 1)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">dbgout</span> (out)
  (<span style="color: #af00ff;">when</span> *dbg-enable*
    (format t (format nil <span style="color: #87005f;">"~~%~~~AT~~A"</span> *dbg-indent*) out)))

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">dbg</span> (frmt <span style="color: #008700;">&amp;rest</span> params)
  `(dbgout (format nil ,frmt ,@params)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(macroexpand-1 '(dbg "~A~A~{~A~^,~}" "zzz" "34234" '(1 2 3 4)))</span>

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">anything-to-keyword</span> (item)
  (intern (string-upcase (format nil <span style="color: #87005f;">"~a"</span> item)) <span style="color: #5f5f87;">:keyword</span>))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alist-to-plist</span> (alist)
  (<span style="color: #af00ff;">if</span> (not (equal (type-of alist) 'cons))
      alist
      <span style="color: #af0000;">;;</span><span style="color: #af0000;">else</span>
      (<span style="color: #af00ff;">loop</span>
         <span style="color: #5f5f87;">:for</span> (key . value)
         <span style="color: #5f5f87;">:in</span> alist
         <span style="color: #5f5f87;">:nconc</span> (list (anything-to-keyword key) value))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1042;&#1088;&#1072;&#1087;&#1087;&#1077;&#1088; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1090; &#1089;&#1077;&#1089;&#1080;&#1080;&#1103;&#1084;&#1080; &#1080; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090; &#1074;&#1089;&#1077; &#1074; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1081; (root-&#1086;&#1074;&#1099;&#1081;) &#1096;&#1072;&#1073;&#1083;&#1086;&#1085;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1045;&#1089;&#1083;&#1080; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1086; &#1074;&#1099;&#1074;&#1077;&#1089;&#1090;&#1080; ajax-&#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1077;&#1090; &#1089;&#1087;&#1077;&#1094;&#1080;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1090;&#1080;&#1087; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080;</span>

(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">ajax</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((output <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:output</span> <span style="color: #5f5f87;">:reader</span> output)))

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-wrapper</span> (<span style="color: #008700;">&amp;body</span> body)
  `(<span style="color: #af00ff;">progn</span>
     (hunchentoot:start-session)
     (<span style="color: #af00ff;">let*</span> ((*current-user* (hunchentoot:session-value 'current-user))
            (retval))
       (<span style="color: #af00ff;">declare</span> (special *current-user*))
       (<span style="color: #af00ff;">handler-case</span>
           (<span style="color: #af00ff;">let</span> ((output (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                           (setf retval ,@body))))
             (tpl:louis
              (list <span style="color: #5f5f87;">:title</span> <span style="color: #87005f;">""</span>
                    <span style="color: #5f5f87;">:header</span> (tpl:header (list <span style="color: #5f5f87;">:login</span> (head-login-block)
                                              <span style="color: #5f5f87;">:search</span>
                                              (ps-html
                                              ((<span style="color: #5f5f87;">:form</span> <span style="color: #5f5f87;">:action</span> <span style="color: #87005f;">"/hh/search"</span> <span style="color: #5f5f87;">:method</span> <span style="color: #87005f;">"get"</span> <span style="color: #5f5f87;">:novalidate</span> <span style="color: #87005f;">""</span> <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"article-search"</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"header-search"</span> :id<span style="color: #af00ff;">=</span><span style="color: #87005f;">"article-search"</span>)
                                               ((<span style="color: #5f5f87;">:fieldset</span>)
                                                ((<span style="color: #5f5f87;">:legend</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"hidden"</span>) <span style="color: #87005f;">"search"</span>)
                                                ((<span style="color: #5f5f87;">:div</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"input-container hide-label"</span>)
                                                 ((<span style="color: #5f5f87;">:label</span> <span style="color: #5f5f87;">:for</span> <span style="color: #87005f;">"header-search-q"</span>) <span style="color: #87005f;">"&#1055;&#1086;&#1080;&#1089;&#1082; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080; &#1092;&#1080;&#1088;&#1084;"</span>)
                                                 ((<span style="color: #5f5f87;">:input</span> <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"q"</span> <span style="color: #5f5f87;">:id</span> <span style="color: #87005f;">"header-search-q"</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"input-text form-element header-search__input"</span>
                                                          <span style="color: #5f5f87;">:maxlength</span> <span style="color: #87005f;">"50"</span> <span style="color: #5f5f87;">:required</span> <span style="color: #87005f;">"required"</span> <span style="color: #5f5f87;">:autocomplete</span> <span style="color: #87005f;">"off"</span> <span style="color: #5f5f87;">:value</span> (aif (get-parameter <span style="color: #87005f;">"q"</span>) it <span style="color: #87005f;">""</span>) <span style="color: #5f5f87;">:type</span> <span style="color: #87005f;">"text"</span>)))
                                                ((<span style="color: #5f5f87;">:button</span> <span style="color: #5f5f87;">:type</span> <span style="color: #87005f;">"submit"</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"button button--header-search"</span> <span style="color: #5f5f87;">:value</span> <span style="color: #87005f;">""</span>)
                                                 ((<span style="color: #5f5f87;">:span</span> <span style="color: #5f5f87;">:class</span> <span style="color: #87005f;">"button__icon sprite"</span>) <span style="color: #87005f;">"Search"</span>)))))))
                    <span style="color: #5f5f87;">:content</span> retval
                    <span style="color: #5f5f87;">:footer</span> (tpl:footer (list <span style="color: #5f5f87;">:dbg</span> (format nil <span style="color: #87005f;">"&lt;pre&gt;~A&lt;/pre&gt;"</span> output))))))
         (ajax (ajax) (output ajax))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1044;&#1083;&#1103; &#1090;&#1086;&#1075;&#1086; &#1095;&#1090;&#1086;&#1073;&#1099; &#1075;&#1077;&#1085;&#1077;&#1088;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1080; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1099; &#1092;&#1086;&#1088;&#1084;, &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1093;&#1077;&#1083;&#1087;&#1077;&#1088;&#1099;:</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun input (type &amp;key name value other)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%&lt;input type=\"~A\"~A~A~A/&gt;" type</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if name  (format nil " name=\"~A\"" name) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if value (format nil " value=\"~A\"" value) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if other (format nil " ~A" other) "")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (input "text" :name "zzz" :value 111)</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (input "submit" :name "submit-btn" :value "send")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defmacro select ((name &amp;optional attrs) &amp;body options)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">`(format nil "~%&lt;select name=\"~A\"~A&gt;~{~%~A~}~%&lt;/select&gt;"</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">,name</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(aif ,attrs (format nil " ~A" it) "")</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(loop :for (name value selected) :in ,@options :collect</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(format nil "&lt;option value=\"~A\"~A&gt;~A&lt;/option&gt;"</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">value</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">(if selected (format nil " ~A" selected) "")</span>
<span style="color: #af0000;">;;                       </span><span style="color: #af0000;">name))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun fld (name &amp;optional (value ""))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(input "text" :name name :value value))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun btn (name &amp;optional (value ""))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(input "button" :name name :value value))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun hid (name &amp;optional (value ""))</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(input "hidden" :name name :value value))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun submit (&amp;optional value)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(if value</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(input "submit" :value value)</span>
<span style="color: #af0000;">;;       </span><span style="color: #af0000;">(input "submit")))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun act-btn (act data title)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%~{~%~A~}"</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(list</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(hid "act"  act)</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(hid "data" data)</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">(submit title))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defmacro row (title &amp;body body)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">`(format nil "~%&lt;tr&gt;~%&lt;td&gt;~A&lt;/td&gt;~%&lt;td&gt;~A~%&lt;/td&gt;~%&lt;/tr&gt;"</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">,title</span>
<span style="color: #af0000;">;;            </span><span style="color: #af0000;">,@body))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (row "thetitrle" (submit))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun td (dat)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%&lt;td&gt;~%~A~%&lt;/td&gt;" dat))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun tr (&amp;rest dat)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%&lt;tr&gt;~%~{~A~}~%&lt;/tr&gt;"</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">dat))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (tr "wfewf")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (tr "wfewf" 1111)</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun frm (contents &amp;key name (method "POST") action)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%&lt;form method=\"~A\"~A~A&gt;~{~A~}~%&lt;/form&gt;"</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">method</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if name (format nil " name=\"~A\"" name) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if action (format nil " action=\"~A\"" action) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if (consp contents)</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">contents</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(list contents))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (frm "form-content" :name "nnnnn")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defun tbl (contents &amp;key name border)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(format nil "~%&lt;table~A~A&gt;~{~A~}~%&lt;/table&gt;"</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if name (format nil " name=\"~A\"" name) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if border (format nil " border=\"~A\"" border) "")</span>
<span style="color: #af0000;">;;           </span><span style="color: #af0000;">(if (consp contents)</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">contents</span>
<span style="color: #af0000;">;;               </span><span style="color: #af0000;">(list contents))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (tbl (list "zzz") :name "table")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; (frm (tbl (list (row "username" (fld "user")))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1072;&#1082;&#1088;&#1086;&#1089; &#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1090; &#1084;&#1072;&#1088;&#1096;&#1088;&#1091;&#1090; &#1080; &#1084;&#1072;&#1088;&#1096;&#1088;&#1091;&#1090;-&#1082;&#1086;&#1085;&#1090;&#1088;&#1086;&#1083;&#1083;&#1077;&#1088;, &#1090;&#1072;&#1082;&#1080;&#1084; &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1084;,</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1074;&#1103;&#1079;&#1072;&#1090;&#1100; &#1076;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1103; &#1082;&#1086;&#1085;&#1090;&#1088;&#1086;&#1083;&#1083;&#1077;&#1088;&#1072; &#1080; &#1082;&#1085;&#1086;&#1087;&#1082;&#1080;</span>
(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">define-page</span> (name url (<span style="color: #008700;">&amp;body</span> body) <span style="color: #008700;">&amp;rest</span> rest)
  (<span style="color: #af00ff;">let</span> ((name-ctrl (intern (format nil <span style="color: #87005f;">"~A-CTRL"</span> (symbol-name name)))))
    `(<span style="color: #af00ff;">symbol-macrolet</span> (,@(<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> (act exp body) <span style="color: #5f5f87;">:in</span> rest <span style="color: #5f5f87;">:collect</span>
                            `(,(intern (format nil <span style="color: #87005f;">"%~A%"</span> (symbol-name act))) ,exp)))
       (<span style="color: #af00ff;">restas:define-route</span> ,name (,url)
         (<span style="color: #af00ff;">with-wrapper</span>
           ,body))
       (<span style="color: #af00ff;">restas:define-route</span> ,name-ctrl (,url <span style="color: #5f5f87;">:method</span> <span style="color: #5f5f87;">:post</span>)
         (<span style="color: #af00ff;">with-wrapper</span>
           (<span style="color: #af00ff;">let*</span> ((p (alist-to-plist (hunchentoot:post-parameters*))))
             (<span style="color: #af00ff;">cond</span>
               ,@(append
                  (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> (act exp body) <span style="color: #5f5f87;">:in</span> rest <span style="color: #5f5f87;">:collect</span>
                     `((string<span style="color: #af00ff;">=</span> ,(symbol-name act) (getf p <span style="color: #5f5f87;">:act</span>))
                       ,body))
                  `((t (format nil <span style="color: #87005f;">"unk act : ~A"</span> (bprint p))))))))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-collection</span> ((item collection) <span style="color: #008700;">&amp;body</span> body)
  `(<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> ,item <span style="color: #5f5f87;">:in</span> ,collection <span style="color: #5f5f87;">:collect</span>
      ,@body))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>

(<span style="color: #af00ff;">defmacro</span> <span style="color: #0000ff;">with-element</span> ((item elt) <span style="color: #008700;">&amp;body</span> body)
  `(<span style="color: #af00ff;">let</span> ((,item ,elt))
     (list
      ,@body)))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">replace-all</span> (string part replacement <span style="color: #008700;">&amp;key</span> (test #'char<span style="color: #af00ff;">=</span>))
  <span style="color: #87005f;">"Returns a new string in which all the occurences of the part</span>
<span style="color: #87005f;">      is replaced with replacement."</span>
  (<span style="color: #af00ff;">with-output-to-string</span> (out)
    (<span style="color: #af00ff;">loop</span> with part-length <span style="color: #af00ff;">=</span> (length part)
       for old-pos <span style="color: #af00ff;">=</span> 0 then (+ pos part-length)
       for pos <span style="color: #af00ff;">=</span> (search part string
                         <span style="color: #5f5f87;">:start2</span> old-pos
                         <span style="color: #5f5f87;">:test</span> test)
       do (write-string string out
                        <span style="color: #5f5f87;">:start</span> old-pos
                        <span style="color: #5f5f87;">:end</span> (or pos (length string)))
       when pos do (write-string replacement out)
       while pos)))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">explore-dir</span> (path)
  (<span style="color: #af00ff;">let</span> ((raw (directory path))
        (dirs)
        (files))
    (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                (<span style="color: #af00ff;">if</span> (cl-fad:directory-pathname-p x)
                    (push x dirs)
                    (push x files)))
            raw)
    (values dirs files raw)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">clear-db</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">drop</span> (tbl-lst)
  (<span style="color: #af00ff;">let</span> ((tables tbl-lst))
    (<span style="color: #af00ff;">flet</span> ((rmtbl (tblname)
             (<span style="color: #af00ff;">when</span> (<span style="color: #af00ff;">with-connection</span> *db-spec*
                     (query (<span style="color: #5f5f87;">:select</span> 'table_name <span style="color: #5f5f87;">:from</span> 'information_schema.tables <span style="color: #5f5f87;">:where</span>
                                     (<span style="color: #5f5f87;">:and</span> (:<span style="color: #af00ff;">=</span> 'table_schema <span style="color: #87005f;">"public"</span>)
                                           (:<span style="color: #af00ff;">=</span> 'table_name tblname)))))
               (<span style="color: #af00ff;">with-connection</span> *db-spec*
                 (query (<span style="color: #5f5f87;">:drop-table</span> (intern (string-upcase tblname))))))))
      (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> tblname <span style="color: #5f5f87;">:in</span> tables <span style="color: #5f5f87;">:collect</span>
         (rmtbl tblname)))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">contains</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">contains</span> (string pattern)
  (<span style="color: #af00ff;">if</span> (search pattern string)
      t))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">contains in words</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">contains-in-words</span> (string pattern)
  (reduce #'(<span style="color: #af00ff;">lambda</span> (a b)
              (or a b))
          (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                      (contains x pattern))
                  (ppcre:split <span style="color: #87005f;">"\\W+"</span> string))
          <span style="color: #5f5f87;">:initial-value</span> nil))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">empty</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">empty</span> (string)
  (<span style="color: #af00ff;">if</span> (or (null string)
          (equal <span style="color: #87005f;">""</span> string))
      t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Глобальные определения</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-lisp" id="globals"><span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">One thing we have to do is make sure that CL-WHO and Parenscript</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">use different string delimiters so that literal strings will</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">work as intended in JavaScript code inlined in HTML element properties.</span>
(setf *js-string-delimiter* #\")

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1077;&#1079; &#1101;&#1090;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1080;&#1089;&#1093;&#1086;&#1076;&#1080;&#1090; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; &#1087;&#1088;&#1080; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080; &#1074; js</span>
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">PARENSCRIPT::SUPPRESS-VALUES</span> nil)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; PostgreSQL</span>
(<span style="color: #af00ff;">defvar</span> <span style="color: #af5f00;">*db-name*</span> <span style="color: #87005f;">"ylg_new"</span>)
(<span style="color: #af00ff;">defvar</span> <span style="color: #af5f00;">*db-user*</span> <span style="color: #87005f;">"ylg"</span>)
(<span style="color: #af00ff;">defvar</span> <span style="color: #af5f00;">*db-pass*</span> <span style="color: #87005f;">"6mEfBjyLrSzlE"</span>)
(<span style="color: #af00ff;">defvar</span> <span style="color: #af5f00;">*db-serv*</span> <span style="color: #87005f;">"localhost"</span>)

(<span style="color: #af00ff;">defvar</span> <span style="color: #af5f00;">*db-spec*</span> (list <span style="color: #87005f;">"ylg_new"</span> <span style="color: #87005f;">"ylg"</span> <span style="color: #87005f;">"6mEfBjyLrSzlE"</span> <span style="color: #87005f;">"localhost"</span>))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; Mysql</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defvar *mysql-db-host* "bkn.ru")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defvar *mysql-db-database* "bkn_base")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defvar *mysql-db-user* "root")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defvar *mysql-db-password* "YGAhBawd1j~SANlw\"Y#l")</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defvar *mysql-db-port* 3306)</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">;; &#1052;&#1072;&#1082;&#1088;&#1086;&#1089; &#1076;&#1083;&#1103; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1103; &#1082; mysql</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defmacro with-mysql-conn (spec &amp;body body)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">`(let ((*mysql-conn-pool* (apply #'cl-mysql:connect ',spec)))</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">(unwind-protect (progn</span>
<span style="color: #af0000;">;;                        </span><span style="color: #af0000;">(cl-mysql:query  "SET NAMES 'utf8'")</span>
<span style="color: #af0000;">;;                        </span><span style="color: #af0000;">,@body)</span>
<span style="color: #af0000;">;;        </span><span style="color: #af0000;">(cl-mysql:disconnect))))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defmacro with-mysql (&amp;body body)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">`(with-mysql-conn (:host "bkn.ru" :database "bkn_base" :user "root" :password "YGAhBawd1j~SANlw\"Y#l" :port 3306)</span>
<span style="color: #af0000;">;;      </span><span style="color: #af0000;">,@body))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defparameter *mysql-conn-pool*</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">(cl-mysql:connect :host "bkn.ru" :database "bkn_base" :user "root" :password "YGAhBawd1j~SANlw\"Y#l" :port 3306))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(cl-mysql:query  "SET NAMES 'utf8'")</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">(defmacro with-mysql (&amp;body body)</span>
<span style="color: #af0000;">;;   </span><span style="color: #af0000;">`(progn ,@body))</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">clear db</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(drop '("resume"))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(drop '("user" "role" "group" "user2group" "msg"</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">"que" "quelt" "bratan" "cmpx" "plex" "crps" "flat"</span>
<span style="color: #af0000;">;;         </span><span style="color: #af0000;">"city" "district" "metro" "deadline"))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> Каркас проекта</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Для генерации "с чистого листа" необходимы функции генерации сущностей, они лежат в
файле <code>generators.el</code>
</p>

<p>
Чтобы их подключить - можно сделать M-x load-file generators.el в emacs-е.
</p>

<p>
Эти функции помещаются в <code>generators.el</code> при <code>tangle</code> и редактировать их можно в
соответствующем разделе этого файла. Для успешной генерации сущностей, они должны быть
загружены в emacs.
</p>

<p>
Файл <code>prepare</code> должен идти до файла <code>util</code> и остальных, так как в нем компилируются
шаблоны, от которых зависит <code>util</code>
</p>

<p>
Файл <code>globals</code> должен идти до файла <code>entity</code> так как в нем происходит подключение к базе
данных, которое используют тесты сущностей и автоматов.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem">     <span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
     <span style="color: #af0000;">;;;; </span><span style="color: #af0000;">moto.asd</span>

(asdf:defsystem #<span style="color: #5f5f87;">:moto</span>
  <span style="color: #5f5f87;">:serial</span> t
  <span style="color: #5f5f87;">:pathname</span> <span style="color: #87005f;">"src"</span>
  <span style="color: #5f5f87;">:depends-on</span> (#<span style="color: #5f5f87;">:closer-mop</span>
               #<span style="color: #5f5f87;">:postmodern</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">#:cl-mysql</span>
               #<span style="color: #5f5f87;">:anaphora</span>
               #<span style="color: #5f5f87;">:cl-ppcre</span>
               #<span style="color: #5f5f87;">:restas</span>
               #<span style="color: #5f5f87;">:restas-directory-publisher</span>
               #<span style="color: #5f5f87;">:closure-template</span>
               #<span style="color: #5f5f87;">:cl-json</span>
               #<span style="color: #5f5f87;">:cl-base64</span>
               #<span style="color: #5f5f87;">:drakma</span>
               #<span style="color: #5f5f87;">:split-sequence</span>
               #<span style="color: #5f5f87;">:cl-html5-parser</span>
               #<span style="color: #5f5f87;">:cl-who</span>
               #<span style="color: #5f5f87;">:parenscript</span>
               #<span style="color: #5f5f87;">:cl-fad</span>
               #<span style="color: #5f5f87;">:optima</span>
               #<span style="color: #5f5f87;">:fare-quasiquote-extras</span>
               #<span style="color: #5f5f87;">:fare-quasiquote-optima</span>
               )
  <span style="color: #5f5f87;">:description</span> <span style="color: #87005f;">"site for bikers"</span>
  <span style="color: #5f5f87;">:author</span> <span style="color: #87005f;">"rigidus"</span>
  <span style="color: #5f5f87;">:version</span> <span style="color: #87005f;">"0.0.3"</span>
  <span style="color: #5f5f87;">:license</span> <span style="color: #87005f;">"GNU AGPLv3"</span>
  <span style="color: #5f5f87;">:components</span> ((<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"package"</span>)    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1072;&#1081;&#1083; &#1087;&#1072;&#1082;&#1077;&#1090;&#1086;&#1074;</span>
               (<span style="color: #5f5f87;">:static-file</span> <span style="color: #87005f;">"templates.htm"</span>)
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"prepare"</span>)    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1086;&#1076;&#1075;&#1086;&#1090;&#1086;&#1074;&#1082;&#1072; &#1082; &#1089;&#1090;&#1072;&#1088;&#1090;&#1091;</span>
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"util"</span>)       <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1072;&#1084;&#1080;</span>
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"globals"</span>)    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1084;&#1080; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1103;&#1084;&#1080;</span>
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"bricks"</span>)     <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1082;&#1086;&#1084;&#1087;&#1086;&#1085;&#1077;&#1085;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1103; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1086;&#1074;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081;, &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1086;&#1074; &#1080; &#1080;&#1093; &#1090;&#1077;&#1089;&#1090;&#1086;&#1074;</span>
               &lt;&lt;mod_entity&gt;&gt;
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"entityes"</span>)   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1080; &#1080; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1099;</span>
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"moto"</span>)       <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1099;&#1081; &#1092;&#1072;&#1081;&#1083;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1072;&#1074;&#1090;&#1086;&#1088;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080; (&#1079;&#1072;&#1074;&#1080;&#1089;&#1080;&#1090; &#1086;&#1090; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081; &#1074; &#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1086;&#1084; &#1092;&#1072;&#1081;&#1083;&#1077;)</span>
               &lt;&lt;mod_auth&gt;&gt;
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1086;&#1095;&#1077;&#1088;&#1077;&#1076;&#1077;&#1081;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&lt;&lt;mod_que&gt;&gt;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1081;</span>
               &lt;&lt;mod_msg&gt;&gt;
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; trend</span>
               &lt;&lt;mod_trend&gt;&gt;
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1084;&#1086;&#1090;&#1086;&#1073;&#1088;&#1072;&#1090;&#1072;&#1085;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&lt;&lt;mod_bratan&gt;&gt;</span>
               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter</span>
               &lt;&lt;mod_hh&gt;&gt;
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"events"</span>)     <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1086;&#1073;&#1099;&#1090;&#1080;&#1103; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;</span>
               (<span style="color: #5f5f87;">:file</span> <span style="color: #87005f;">"iface"</span>)      <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1072;&#1081;&#1083; &#1074;&#1077;&#1073;-&#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1072;</span>
               ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> Пакеты</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Соберем весь код в пакет:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="package"><span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #af0000;">;;;; </span><span style="color: #af0000;">package.lisp</span>

(<span style="color: #af00ff;">restas:define-module</span> #<span style="color: #5f5f87;">:moto</span>
  (<span style="color: #5f5f87;">:use</span>  #<span style="color: #5f5f87;">:cl</span> #<span style="color: #5f5f87;">:closer-mop</span> #<span style="color: #5f5f87;">:postmodern</span> #<span style="color: #5f5f87;">:anaphora</span> #<span style="color: #5f5f87;">:hunchentoot</span> #<span style="color: #5f5f87;">:cl-who</span> #<span style="color: #5f5f87;">:parenscript</span> #<span style="color: #5f5f87;">:cl-fad</span> #<span style="color: #5f5f87;">:optima</span>)
  (<span style="color: #5f5f87;">:shadowing-import-from</span> #<span style="color: #5f5f87;">:closer-mop</span>
                          #<span style="color: #5f5f87;">:defclass</span>
                          #<span style="color: #5f5f87;">:defmethod</span>
                          #<span style="color: #5f5f87;">:standard-class</span>
                          #<span style="color: #5f5f87;">:ensure-generic-function</span>
                          #<span style="color: #5f5f87;">:defgeneric</span>
                          #<span style="color: #5f5f87;">:standard-generic-function</span>
                          #<span style="color: #5f5f87;">:class-name</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> Подготовка к старту</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Подготовка включает в себя загрузку всех необходимых библиотек, компиляцию шаблонов, и,
возможно, инициализацию окружения.
</p>
</div>
</div>

<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> Точка входа</h3>
<div class="outline-text-3" id="text-7-6">
<p>
Отсюда все начинается
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enter_point"><span style="color: #af0000;">;;;; </span><span style="color: #af0000;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #af0000;">;;;; </span><span style="color: #af0000;">moto.lisp</span>

(<span style="color: #af00ff;">in-package</span> #<span style="color: #5f5f87;">:moto</span>)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">main</span> ()
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">start</span>
  (restas:start '#<span style="color: #5f5f87;">:moto</span> <span style="color: #5f5f87;">:port</span> 9997)
  (restas:debug-mode-on)
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(restas:debugg-mode-off)</span>
  (setf hunchentoot:*catch-errors-p* t)
  (make-event <span style="color: #5f5f87;">:name</span> <span style="color: #87005f;">"restart"</span>
              <span style="color: #5f5f87;">:tag</span> <span style="color: #87005f;">"restart"</span>
              <span style="color: #5f5f87;">:msg</span> (format nil <span style="color: #87005f;">"&#1057;&#1077;&#1088;&#1074;&#1077;&#1088; &#1087;&#1077;&#1088;&#1077;&#1079;&#1072;&#1087;&#1091;&#1097;&#1077;&#1085;"</span>)
              <span style="color: #5f5f87;">:author-id</span> 0
              <span style="color: #5f5f87;">:ts-create</span> (get-universal-time)))

(main)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7"><span class="section-number-3">7.7</span> Readme</h3>
<div class="outline-text-3" id="text-7-7">
<div class="org-src-container">

<pre class="src src-org" id="enter_point"><span style="font-weight: bold;">*&#1042;&#1085;&#1080;&#1084;&#1072;&#1085;&#1080;&#1077;!*</span>

&#1045;&#1089;&#1083;&#1080; &#1074;&#1099; &#1087;&#1088;&#1086;&#1089;&#1090;&#1086; &#1093;&#1086;&#1090;&#1080;&#1090;&#1077; &#1087;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1080;&#1089;&#1093;&#1086;&#1076;&#1085;&#1080;&#1082;&#1072;, &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1074; &#1089;&#1090;&#1080;&#1083;&#1077;
&#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1090;&#1091;&#1088;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; - &#1090;&#1086; &#1074;&#1072;&#1084; &#1089;&#1102;&#1076;&#1072;: <span style="color: #5f5fd7; text-decoration: underline;">https://github.com/rigidus/moto/blob/master/hh.org</span>

&#1069;&#1090;&#1086;&#1090; &#1076;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090; &#1086;&#1090;&#1074;&#1077;&#1095;&#1072;&#1077;&#1090; &#1085;&#1072; &#1074;&#1086;&#1087;&#1088;&#1086;&#1089;&#1099;:
- &#1063;&#1090;&#1086; &#1085;&#1091;&#1078;&#1085;&#1086; &#1089;&#1076;&#1077;&#1083;&#1072;&#1090;&#1100; &#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1086;&#1073;&#1088;&#1072;&#1090;&#1100; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;
- &#1063;&#1090;&#1086; &#1085;&#1091;&#1078;&#1085;&#1086; &#1089;&#1076;&#1077;&#1083;&#1072;&#1090;&#1100; &#1095;&#1090;&#1086;&#1073;&#1099; &#1079;&#1072;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1089;&#1086;&#1073;&#1088;&#1072;&#1085;&#1085;&#1099;&#1081; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;
- &#1050;&#1072;&#1082; &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1080; &#1085;&#1072;&#1089;&#1090;&#1088;&#1086;&#1080;&#1090;&#1100; Postgres
- &#1047;&#1072;&#1095;&#1077;&#1084; &#1101;&#1090;&#1086; &#1074;&#1089;&#1077;

&#1052;&#1086;&#1078;&#1085;&#1086; &#1079;&#1072;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;, &#1085;&#1077; &#1089;&#1086;&#1073;&#1080;&#1088;&#1072;&#1103; &#1077;&#1075;&#1086;, &#1077;&#1089;&#1083;&#1080; &#1074;&#1099; &#1087;&#1088;&#1086;&#1089;&#1090;&#1086; &#1093;&#1086;&#1090;&#1080;&#1090;&#1077;
&#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1086;&#1074;&#1072;&#1090;&#1100;. &#1053;&#1086; &#1074; &#1101;&#1090;&#1086;&#1084; &#1085;&#1077;&#1090; &#1092;&#1072;&#1085;&#1072;, &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; &#1074;&#1089;&#1077; &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1086;&#1077; &#1080;&#1084;&#1077;&#1085;&#1085;&#1086; &#1074;
&#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1090;&#1091;&#1088;&#1085;&#1086;&#1084; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1080; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1080; &#1082;&#1086;&#1076;&#1072;.

<span style="color: #0000ff;">* &#1057;&#1073;&#1086;&#1088;&#1082;&#1072;</span>

  &#1053;&#1072; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090;, &#1082;&#1086;&#1075;&#1076;&#1072; &#1074;&#1099; &#1085;&#1072;&#1095;&#1085;&#1077;&#1090;&#1077; &#1101;&#1090;&#1086; &#1076;&#1077;&#1083;&#1072;&#1090;&#1100;, &#1091; &#1074;&#1072;&#1089; &#1076;&#1086;&#1083;&#1078;&#1085;&#1099; &#1089;&#1090;&#1086;&#1103;&#1090;&#1100;:
  - emacs (<span style="color: #5f5fd7; text-decoration: underline;">http://www.gnu.org/software/emacs/</span>)
  - git (<span style="color: #5f5fd7; text-decoration: underline;">http://git-scm.com/</span>)
  - sbcl (<span style="color: #5f5fd7; text-decoration: underline;">http://sbcl.org/</span>)
  - quicklisp (<span style="color: #5f5fd7; text-decoration: underline;">http://quicklisp.org/</span>)
  - postgresql (<span style="color: #5f5fd7; text-decoration: underline;">http://www.postgresql.org/</span>)
  - ditaa (<span style="color: #5f5fd7; text-decoration: underline;">http://ditaa.sourceforge.net/</span>)
  &#1048;&#1093; &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1082;&#1072;, &#1082;&#1072;&#1082; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1086;, &#1090;&#1088;&#1080;&#1074;&#1080;&#1072;&#1083;&#1100;&#1085;&#1072;, &#1087;&#1086;&#1101;&#1090;&#1086;&#1084;&#1091; &#1085;&#1077; &#1073;&#1091;&#1076;&#1077;&#1090; &#1079;&#1076;&#1077;&#1089;&#1100;
  &#1086;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1090;&#1100;&#1089;&#1103;.

  &#1055;&#1077;&#1088;&#1077;&#1076; &#1090;&#1077;&#1084;, &#1082;&#1072;&#1082; &#1085;&#1072;&#1095;&#1072;&#1090;&#1100; &#1089;&#1073;&#1086;&#1088;&#1082;&#1091;, &#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1084; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;, &#1075;&#1076;&#1077; &#1073;&#1091;&#1076;&#1077;&#1090; &#1074;&#1089;&#1077; &#1083;&#1077;&#1078;&#1072;&#1090;&#1100;
  &#1080; &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074; &#1085;&#1077;&#1075;&#1086;:

  <span style="color: #7f7f7f;">=mkdir ~/repo=</span>

  <span style="color: #7f7f7f;">=cd ~/repo=</span>

<span style="color: #af5f00;">** Orgmode</span>

   &#1053;&#1072;&#1093;&#1086;&#1076;&#1103;&#1089;&#1100; &#1074; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1077; <span style="color: #7f7f7f;">=~/repo=</span>, &#1089;&#1082;&#1072;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1102;&#1102; &#1074;&#1077;&#1088;&#1089;&#1080;&#1102;
   <span style="color: #7f7f7f;">=org-mode=</span> - &#1088;&#1072;&#1089;&#1096;&#1080;&#1088;&#1077;&#1085;&#1080;&#1103;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1091;&#1078;&#1077; &#1089;&#1090;&#1086;&#1080;&#1090; &#1074; &#1077;&#1084;&#1072;&#1082;&#1089;&#1077;, &#1085;&#1086;, &#1082;
   &#1089;&#1086;&#1078;&#1072;&#1083;&#1077;&#1085;&#1080;&#1102;, &#1095;&#1072;&#1089;&#1090;&#1086; &#1085;&#1077; &#1089;&#1072;&#1084;&#1086;&#1081; &#1089;&#1074;&#1077;&#1078;&#1077;&#1081; &#1074;&#1077;&#1088;&#1089;&#1080;&#1080;. &#1042; &#1090;&#1086;&#1081; &#1074;&#1077;&#1088;&#1089;&#1080;&#1080;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1103;
   &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1102;, &#1087;&#1086;&#1084;&#1077;&#1085;&#1103;&#1083;&#1089;&#1103; &#1089;&#1087;&#1086;&#1089;&#1086;&#1073; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; &#1089; org-tables, &#1087;&#1086;&#1101;&#1090;&#1086;&#1084;&#1091; &#1103;
   &#1088;&#1077;&#1082;&#1086;&#1084;&#1077;&#1085;&#1076;&#1091;&#1102; &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1090;&#1100; &#1074;&#1077;&#1088;&#1089;&#1080;&#1102; &#1089; &#1084;&#1086;&#1077;&#1075;&#1086; &#1088;&#1077;&#1087;&#1086;&#1079;&#1080;&#1090;&#1086;&#1088;&#1080;&#1103;:

   <span style="color: #7f7f7f;">=git clone </span><span style="color: #7f7f7f; text-decoration: underline;">https://github.com/rigidus/org-mode.git</span><span style="color: #7f7f7f;">=</span>

   &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074; &#1087;&#1086;&#1103;&#1074;&#1080;&#1074;&#1096;&#1080;&#1081;&#1089;&#1103; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075; &#1080; &#1089;&#1086;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084;:

   <span style="color: #7f7f7f;">=cd org-mode=</span>
   <span style="color: #7f7f7f;">=make=</span>
   <span style="color: #7f7f7f;">=make autoloads=</span>

   &#1054;&#1090;&#1082;&#1088;&#1099;&#1074;&#1072;&#1077;&#1084; &#1092;&#1072;&#1081;&#1083; &#1082;&#1086;&#1085;&#1092;&#1080;&#1075;&#1091;&#1088;&#1072;&#1094;&#1080;&#1080; emacs <span style="color: #7f7f7f;">=~/.emacs.d/init.el=</span> &#1080;
   &#1087;&#1088;&#1086;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1089;&#1086;&#1073;&#1088;&#1072;&#1085;&#1085;&#1099;&#1081; org-mode:

   <span style="color: #7f7f7f;">=;; OrgMode </span><span style="color: #7f7f7f; text-decoration: underline;">http://orgmode.org/manual/Installation.html</span><span style="color: #7f7f7f;">=</span>

   <span style="color: #7f7f7f;">=(add-to-list 'load-path "/home/rigidus/repo/org-mode/lisp")=</span>

   <span style="color: #7f7f7f;">=(require 'org-install)=</span>

   &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1089;&#1103; &#1074; &#1080;&#1089;&#1093;&#1086;&#1076;&#1085;&#1099;&#1081; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;:

   <span style="color: #7f7f7f;">=cd ~/repo=</span>

<span style="color: #af5f00;">** &#1055;&#1088;&#1086;&#1077;&#1082;&#1090;</span>

   &#1057;&#1082;&#1072;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1102;&#1102; &#1074;&#1077;&#1088;&#1089;&#1080;&#1102; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;:

   <span style="color: #7f7f7f;">=cd ~/repo=</span>

   <span style="color: #7f7f7f;">=git-clone </span><span style="color: #7f7f7f; text-decoration: underline;">https://github.com/rigidus/moto.git</span><span style="color: #7f7f7f;">=</span>

   &#1054;&#1090;&#1082;&#1088;&#1099;&#1074;&#1072;&#1077;&#1084; <span style="color: #7f7f7f;">=~/repo/moto/doc.org=</span> &#1074; emacs-e

   &#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1084; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1090;&#1086;&#1088;&#1099;:

   <span style="color: #7f7f7f;">=M-x load-file=</span> <span style="color: #7f7f7f;">=~/repo/moto/generators.el=</span>

   &#1041;&#1077;&#1079; &#1101;&#1090;&#1086;&#1075;&#1086; &#1096;&#1072;&#1075;&#1072; &#1087;&#1088;&#1080; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1080; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1091;&#1090;&#1089;&#1103; &#1085;&#1077;&#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1099;&#1077;
   &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;, &#1095;&#1090;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1077;&#1090; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1080;.

   &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1102; &#1082;&#1086;&#1076;&#1072; (org-babel-tangle) &#1074; &#1086;&#1090;&#1082;&#1088;&#1099;&#1090;&#1086;&#1084; &#1074; emacs-&#1077;
   &#1092;&#1072;&#1081;&#1083;&#1077; <span style="color: #7f7f7f;">=~/repo/moto/doc.org=</span>, &#1085;&#1072;&#1078;&#1080;&#1084;&#1072;&#1103; &#1082;&#1086;&#1084;&#1073;&#1080;&#1085;&#1072;&#1094;&#1080;&#1102; &#1082;&#1083;&#1072;&#1074;&#1080;&#1096;&#1100; <span style="color: #7f7f7f;">=C-c C-v t=</span>

   &#1057;&#1075;&#1077;&#1085;&#1077;&#1088;&#1080;&#1088;&#1091;&#1077;&#1090;&#1089;&#1103; &#1084;&#1085;&#1086;&#1078;&#1077;&#1089;&#1090;&#1074;&#1086; &#1092;&#1072;&#1081;&#1083;&#1086;&#1074; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;, &#1074; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1084;, &#1074; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1077;
   <span style="color: #7f7f7f;">=~/repo/moto/src=</span>

   &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1102; &#1076;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1080; &#1074; &#1092;&#1086;&#1088;&#1084;&#1072;&#1090;&#1077; html (org-export) &#1074;
   &#1086;&#1090;&#1082;&#1088;&#1099;&#1090;&#1086;&#1084; &#1074; emacs-&#1077; &#1092;&#1072;&#1081;&#1083;&#1077; <span style="color: #7f7f7f;">=~/repo/moto/doc.org=</span>, &#1085;&#1072;&#1078;&#1080;&#1084;&#1072;&#1103; &#1082;&#1086;&#1084;&#1073;&#1080;&#1085;&#1072;&#1094;&#1080;&#1102;
   &#1082;&#1083;&#1072;&#1074;&#1080;&#1096; <span style="color: #7f7f7f;">=C-c C-e h=</span>

   &#1057;&#1075;&#1077;&#1085;&#1077;&#1088;&#1080;&#1088;&#1091;&#1077;&#1090;&#1089;&#1103; &#1092;&#1072;&#1081;&#1083; &#1076;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1080; <span style="color: #7f7f7f;">=~/repo/moto/doc.html=</span>

   &#1040;&#1085;&#1072;&#1083;&#1086;&#1075;&#1080;&#1095;&#1085;&#1099;&#1084; &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1084; &#1084;&#1086;&#1078;&#1085;&#1086; &#1087;&#1086;&#1089;&#1090;&#1091;&#1087;&#1072;&#1090;&#1100; &#1089;&#1086; &#1074;&#1089;&#1077;&#1084;&#1080; &#1092;&#1072;&#1081;&#1083;&#1072;&#1084;&#1080; &#1084;&#1086;&#1076;&#1091;&#1083;&#1077;&#1081; - &#1101;&#1090;&#1086;
   &#1092;&#1072;&#1081;&#1083;&#1099; &#1089; &#1088;&#1072;&#1089;&#1096;&#1080;&#1088;&#1077;&#1085;&#1080;&#1077;&#1084; <span style="color: #7f7f7f;">=org=</span>, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1083;&#1077;&#1078;&#1072;&#1090; &#1074; &#1082;&#1086;&#1088;&#1085;&#1077;&#1074;&#1086;&#1084; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1077;
   <span style="color: #7f7f7f;">=~/repo/moto/=</span>

   &#1045;&#1089;&#1083;&#1080; &#1087;&#1086;&#1085;&#1072;&#1076;&#1086;&#1073;&#1080;&#1090;&#1089;&#1103; &#1080;&#1079;&#1084;&#1077;&#1085;&#1080;&#1090;&#1100; &#1087;&#1088;&#1086;&#1094;&#1077;&#1089;&#1089; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1080;, &#1090;&#1086; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1079;&#1072;
   &#1085;&#1077;&#1075;&#1086; &#1086;&#1090;&#1074;&#1077;&#1095;&#1072;&#1102;&#1090;, &#1083;&#1077;&#1078;&#1072;&#1090; &#1074; "&#1054;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081;" -&gt; "&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103;
   &#1082;&#1086;&#1076;&#1086;&#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1094;&#1080;&#1080; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081;"

<span style="color: #0000ff;">* &#1047;&#1072;&#1087;&#1091;&#1089;&#1082;</span>

  &#1063;&#1090;&#1086;&#1073;&#1099; &#1079;&#1072;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;, &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1086; &#1080;&#1084;&#1077;&#1090;&#1100;:
  - sbcl
  - quicklisp

    &#1053;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1086;, &#1095;&#1090;&#1086;&#1073;&#1099; quicklisp &#1084;&#1086;&#1075; &#1085;&#1072;&#1081;&#1090;&#1080; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1091; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;. &#1044;&#1083;&#1103; &#1101;&#1090;&#1086;&#1075;&#1086;
    &#1074; <span style="color: #7f7f7f;">=~/.sbclrc=</span> &#1076;&#1086;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1089;&#1083;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; &#1082;&#1086;&#1076;

<span style="color: #af0000;">    #+BEGIN_SRC lisp</span>
      #+quicklisp
      (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                  (pushnew x ql:*local-project-directories*))
             (list
                   #P<span style="color: #87005f;">"~/repo/moto/"</span>
                   ))
<span style="color: #af0000;">    #+END_SRC</span>

  - postgres

    &#1069;&#1090;&#1080; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1076;&#1083;&#1103; &#1074;&#1093;&#1086;&#1076;&#1072; &#1083;&#1077;&#1078;&#1072;&#1090; &#1074; ~/repo/moto/doc.org &#1074; &#1088;&#1072;&#1079;&#1076;&#1077;&#1083;&#1077;
    "&#1043;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103;"
    - &#1055;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100; postgres
    - &#1041;&#1072;&#1079;&#1091; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;

  &#1054;&#1073;&#1077;&#1089;&#1087;&#1077;&#1095;&#1080;&#1074; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1077; &#1101;&#1090;&#1080;&#1093; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1081;, &#1079;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074; <span style="color: #7f7f7f;">=emacs=</span>, &#1085;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; <span style="color: #7f7f7f;">=M-x</span>
<span style="color: #7f7f7f;">  slime=</span> &#1080; &#1074; &#1086;&#1090;&#1082;&#1088;&#1099;&#1074;&#1096;&#1077;&#1084;&#1089;&#1103; &#1073;&#1091;&#1092;&#1077;&#1088;&#1077; <span style="color: #7f7f7f;">=(ql:quickload "moto")=</span>

  &#1042;&#1089;&#1077; &#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1079;&#1072;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100;. &#1045;&#1089;&#1083;&#1080; &#1085;&#1077;&#1090; - &#1089;&#1074;&#1103;&#1079;&#1099;&#1074;&#1072;&#1081;&#1090;&#1077;&#1089;&#1100; &#1089;&#1086; &#1084;&#1085;&#1086;&#1081;.

  &#1063;&#1091;&#1090;&#1100; &#1085;&#1077; &#1079;&#1072;&#1073;&#1099;&#1083;, &#1074;&#1077;&#1073;-&#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089; &#1088;&#1072;&#1079;&#1084;&#1077;&#1097;&#1077;&#1085; &#1085;&#1072; &#1087;&#1086;&#1088;&#1090;&#1091; 9997

<span style="color: #0000ff;">* &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1082;&#1072; &#1080; &#1085;&#1072;&#1089;&#1090;&#1088;&#1086;&#1081;&#1082;&#1072; Postgres</span>

<span style="color: #af0000;">  #+BEGIN_COMMENT</span>
      TODO &#1089;&#1076;&#1077;&#1083;&#1072;&#1090;&#1100; &#1083;&#1080;&#1085;&#1082;&#1080; &#1085;&#1072; &#1087;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1081; &#1089; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1093; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1081; doc.org, &#1077;&#1089;&#1083;&#1080; &#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086;
<span style="color: #af0000;">  #+END_COMMENT</span>

  &#1042; <span style="color: #7f7f7f;">=~/repo/moto/doc.org=</span> &#1074; &#1089;&#1077;&#1082;&#1094;&#1080;&#1080; "&#1043;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103;" &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1085;&#1099; &#1080;&#1084;&#1103; &#1073;&#1072;&#1079;&#1099; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;, &#1083;&#1086;&#1075;&#1080;&#1085; &#1080; &#1087;&#1072;&#1088;&#1086;&#1083;&#1100;

  &#1044;&#1083;&#1103; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084; Ubuntu/Debian:

<span style="color: #af0000;">  #+BEGIN_SRC bash</span>
     sudo apt-get install postgresql postgresql-contrib postgresql-client
     sudo -i -u postgres

     postgres$ createuser --interactive
     ....
     postgres$ createdb DB_NAME
     postgres$ psql -d DB_NAME
<span style="color: #af0000;">  #+END_SRC</span>

  &#1042; &#1082;&#1086;&#1085;&#1089;&#1086;&#1083;&#1100; postrges &#1074;&#1074;&#1077;&#1089;&#1090;&#1080;:

<span style="color: #af0000;">  #+BEGIN_SRC psql</span>
     ALTER USER ylg PASSWORD '...';
     \q
<span style="color: #af0000;">  #+END_SRC</span>

  &#1057;&#1084;. &#1090;&#1091;&#1090;&#1086;&#1088;&#1080;&#1072;&#1083; <span style="color: #5f5fd7; text-decoration: underline;">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-14-04</span>

<span style="color: #0000ff;">* &#1047;&#1072;&#1095;&#1077;&#1084; &#1101;&#1090;&#1086; &#1074;&#1089;&#1077;</span>

  &#1069;&#1090;&#1086; &#1074;&#1089;&#1077; &#1073;&#1099;&#1083;&#1086; &#1079;&#1072;&#1076;&#1091;&#1084;&#1072;&#1085;&#1086; &#1080; &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1085;&#1086; (&#1080; &#1087;&#1080;&#1096;&#1077;&#1090;&#1089;&#1103; &#1074; &#1076;&#1072;&#1085;&#1085;&#1099;&#1081; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090;) &#1082;&#1072;&#1082;
  &#1080;&#1089;&#1089;&#1083;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1088;&#1103;&#1076;&#1072; &#1087;&#1086;&#1076;&#1093;&#1086;&#1076;&#1086;&#1074; &#1074; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1074; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1080; &#1082;
  &#1082;&#1086;&#1085;&#1082;&#1088;&#1077;&#1090;&#1085;&#1099;&#1084; &#1087;&#1088;&#1072;&#1082;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1084; &#1079;&#1072;&#1076;&#1072;&#1095;&#1072;&#1084;. &#1053;&#1091; &#1080; &#1088;&#1072;&#1076;&#1080; &#1086;&#1073;&#1097;&#1077;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1099;,
  &#1087;&#1086;&#1085;&#1080;&#1084;&#1072;&#1077;&#1084;&#1086;&#1081; &#1086;&#1095;&#1077;&#1085;&#1100; &#1096;&#1080;&#1088;&#1086;&#1082;&#1086;, &#1074;&#1082;&#1083;&#1102;&#1095;&#1072;&#1103; &#1082;&#1072;&#1082; &#1087;&#1086;&#1083;&#1100;&#1079;&#1091; &#1086;&#1090; &#1089;&#1072;&#1084;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1076;&#1091;&#1082;&#1090;&#1072;, &#1090;&#1072;&#1082;
  &#1080; &#1087;&#1086;&#1083;&#1100;&#1079;&#1091; &#1086;&#1090; &#1080;&#1089;&#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1084;&#1099;&#1093; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1081; &#1080; &#1087;&#1088;&#1080;&#1077;&#1084;&#1086;&#1074; &#1080;&#1093; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103;.

  &#1042;&#1077;&#1089;&#1100; &#1082;&#1086;&#1076; &#1083;&#1080;&#1094;&#1077;&#1085;&#1079;&#1080;&#1088;&#1091;&#1077;&#1090;&#1089;&#1103; &#1087;&#1086;&#1076; &#1089;&#1074;&#1086;&#1073;&#1086;&#1076;&#1085;&#1086;&#1081; &#1083;&#1080;&#1094;&#1077;&#1085;&#1079;&#1080;&#1077;&#1081; GPLv3 &#1080; &#1074;&#1099; &#1074;&#1087;&#1088;&#1072;&#1074;&#1077;
  &#1088;&#1077;&#1072;&#1083;&#1080;&#1079;&#1086;&#1074;&#1099;&#1074;&#1072;&#1090;&#1100; &#1074;&#1089;&#1077; &#1089;&#1074;&#1103;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1089; &#1101;&#1090;&#1080;&#1084; &#1089;&#1074;&#1086;&#1073;&#1086;&#1076;&#1099;. &#1050;&#1086;&#1085;&#1090;&#1088;&#1080;&#1073;&#1100;&#1102;&#1090;&#1086;&#1088;&#1099;
  &#1087;&#1088;&#1080;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1091;&#1102;&#1090;&#1089;&#1103;, &#1085;&#1077; &#1090;&#1086;&#1083;&#1100;&#1082;&#1086; &#1074; &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1085;&#1080;&#1080; &#1082;&#1086;&#1076;&#1072;, &#1085;&#1086; &#1080; &#1074; &#1087;&#1088;&#1080;&#1074;&#1083;&#1077;&#1095;&#1077;&#1085;&#1080;&#1080;
  &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1077;&#1081;, &#1080;&#1079;&#1091;&#1095;&#1077;&#1085;&#1080;&#1080; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1081;, &#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1080; &#1082;&#1088;&#1080;&#1090;&#1080;&#1082;&#1077; &#1080;&#1076;&#1077;&#1081;.

  &#1045;&#1089;&#1083;&#1080; &#1077;&#1089;&#1090;&#1100; &#1082;&#1072;&#1082;&#1086;&#1081;-&#1090;&#1086; &#1074;&#1086;&#1087;&#1088;&#1086;&#1089; &#1080;&#1083;&#1080; &#1085;&#1077;&#1087;&#1086;&#1085;&#1103;&#1090;&#1085;&#1099;&#1081; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; - &#1085;&#1077; &#1089;&#1090;&#1077;&#1089;&#1085;&#1103;&#1081;&#1090;&#1077;&#1089;&#1100;
  &#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1087;&#1088;&#1103;&#1084;&#1086; &#1074; &#1075;&#1080;&#1090;&#1093;&#1072;&#1073;.
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-8" class="outline-3">
<h3 id="sec-7-8"><span class="section-number-3">7.8</span> Copyright</h3>
<div class="outline-text-3" id="text-7-8">
<p>
Из-за того что есть множество людей, стремящихся нарушить лицензию,
добавляем копирайт.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2015 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Идеи</h2>
<div class="outline-text-2" id="text-8">
<p>
Необходимы заметки одного пользователя о другом. И шаринг их для группы лиц
</p>

<p>
<a href="http://www.motobratan.ru/motoprogress/230.html">http://www.motobratan.ru/motoprogress/230.html</a>
Флип-чарт - как чопперасты видят: спортбайкеров, эндурастов етц
Только отслеживаемые люди (веб-камера, документ етц)
</p>

<p>
Что такое Кодекс чести Coursera?
</p>

<p>
Я зарегистрирую только одну учётную запись.
Все мои ответы на задания, включая опросы и экзамены будут моей собственной работой (за
исключением заданий, которые недвусмысленно допускают возможность совместной работы).
Я не буду выкладывать в открытый доступ ответы на вопросы домашних работ, опросов или
экзаменов. Это включает как написанные мною лично ответы на вопросы, так и любые
официальные ответы, предоставленные сотрудниками курса.
Я не буду прибегать к каким-либо уловкам, с помощью которых обманным путём могут быть
улучшены мои результаты или улучшены/ухудшены результаты других.
</p>

<p>
Курсы по ремонту мотоциклов
</p>

<p>
Умный поиск с привязкой к местонахождению. Ищу то-то - поиск по товарам с ценами и расстоянием
</p>

<p>
Технологическая репутация пользователей - кто как относится к своим мотоциклам. Может
заполняться сервис-менами.
</p>

<p>
Специальная система приглашений - ты можешь завести друга, а потому передать ему его
аккаунт
</p>

<p>
Не забыть адреса травмпунктов и контакты хороших врачей и юристов
</p>
</div>

<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Обозначения и маркировка мотошин</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Рассмотрим данный вопрос на конкретном примере. Например, на боковине #шины имеется
обозначение 140/80 - 18 M/C 70M TL
</p>

<p>
№1 Производитель или название бренда
№2 Выражение максимальной нагрузки на шину при указанном давлении (psi).
№3 Название модели #мотошины
№4 Стрелка, указывающая направление вращения колеса.Обозначение относится к дополнительной
маркировке
№5 Ширина профиля покрышки в миллиметрах. В данном случае - 140 №6 Высота профиля в
процентах от ширины.В данном случае - 80. Это значение не указывается, если ширина выражена
в дюймах. Например, 3,5-18.
№7 Индекс обозначающий конструкцию шины. В данном случае "-" - диагональная
конструкция. Индекс "R"- радиальная конструкция шины. №8 Посадочный размер внутреннего
кольца покрышки в дюймах. На нашей шине он равен 18. Буквы М/С - аббревиатура от motorcycle
. Означает, что шины относятся к категории мотоциклетных шин. Встречается на мотошинах,
имеющих "автомобильные" размеры.
№9 Индекс нагрузки ( в рассматриваем случае 70). Число , соответствующее нагрузке, которую
способна выдержать шина при максимальном внутреннем давлении воздуха. Существует таблица
индексов нагрузок, по которой определяется ее максимальное значение. №10 M - индекс
скорости. Читайте подробнее о индексах скорости.
№11 TT - тип шины ТТ - аббревиатура от Tube Type (камерный тип) - обозначение для покрышек,
предназначенных для использования только вместе с камерой. Обозначение TL - аббревиатура от
Tubeless.(бескамерная) - указывает на то, что шину следует использовать без
камеры. Герметичность обеспечивает слой особой резины, нанесенный на внутреннее
кольцо. Должная фиксация шины на ободе достигается за счет хампов – особых конструктивным
элементам колесного диска.
№12 Номер согласно ECE R 75
№13 Наименование типа протектора. №14 Аббревиатура DOT.
№15 Дата изготовления шины - три или четыре цифры в овале на одной из боковин. У некоторых
производителей – три или четыре последние цифры в индивидуальном номере покрышки. Например,
(178) - 17-я неделя 1998 г.. С 2000 года введено 4-х значное число обозначение. К примеру
(1105) – 11 неделя 2005 года
</p>

<p>
Обозначение и маркировка шин
</p>

<p>
Обозначение и маркировка шин, выпускаемых в Европе, соответствует Евростандарту, а в США -
требованиями Транспортного управления этой страны. Следует отметить, что обозначения и
маркировка отечественных и импортных шин по отдельным позициям совпадают, хотя среди них
имеются характерные различия. Прежде всего рассмотрим маркировки шин, действующих в Европе:
1 - Пример: 185/65 R15 87Т - размер шины и ее техническая характеристика: 185 - ширина
профиля шины в мм.; 65 - отношение высоты профиля к ее ширине, выраженное в процентах; R -
радиальная конструкция шины; 15 - посадочный диаметр обода в дюймах; 87 - индекс
грузоподъемности.
</p>

<p>
Ряд зарубежных фирм указывают максимальную нагрузку (MAX LOAD) в кг. и английских фунтах;
Т - индекс максимальной скорости, на которую рассчитана шина - надпись "Radial" - указывает
на радиальную конструкцию шины; - "Tubeless" - маркировка бескамерной шины. Камерная шина
обозначается "TUBE TYPE";
</p>
<ul class="org-ul">
<li>"M+S" (Mud+Snow -грязь+снег) - тип рисунка протектора. Маркировка обозначает, что шина
предназначена для эксплуатации в зимний период года и по грязи. - цифры 376 - дата выпуска
шины: изготовлена на 37-й недели 1996 года - знак Е одним цифровым индексом (на других
шинах может быть двух цифровой индекс) указывает, что шина проверена на соответствие
европейскому стандарту безопасности - Правилу N 30 Европейской экономической комиссии
ООН. Индекс в кружке - условный номер страны, где назначенная правительством комиссия
провела проверку. Например, Е - проверено в Швеции. Пятизначный (может быть и
шестизначный) индекс, нанесенный рядом с кружком, означает номер сертификата,
свидетельствующий о положительных результатах проверки, и выданного страной,
осуществлявшей проверку; - страна, в которой находится предприятие-изготовитель шин (Made
in Germany -сделано в Германии, Made in Europe - сделано в Европе и т.д.);
</li>
</ul>

<p>
Дополнительные маркировки, действующие в США: - DOT - знак, который означает, что шина
отвечает нормативным требованиям Транспортного управления США; - DM AB CD EFG - код,
означающий место изготовления, размер и тип шины; - максимально допустимые в США нагрузка и
внутреннее давление воздуха в шине: max Load 545kg (1202 lbs) - 545кг (1202 фунта), max
Pressure 300 кПа (44psi) - 3,0 кгс/см2 (44 фунта на квадратный дюйм); - Plies Tread area:1
Rayon + 2 Steel + 1 Nylon Sidewall: 1 Rayon - особенности конструкции шины: в брекере один
слой вискозного корда; два слоя стального и один слой нейлонового корда; в боковине один
слой вискозного корда; - TWI (Tread Wear Indiration) -указатели индикаторов износа
(минимально допустимая глубина) рисунка протектора шины.Указатели располагаются равномерно в
шести- восьми местах по окружности. Маркировка TWI может быть со стрелкой. Индикатор износа
иногда изображается одной стрелкой.Индикатор выполняется в виде выступа высотой 1.6 мм (для
легких автомобилей) и располагается в углублении протектора;
</p>

<ul class="org-ul">
<li>Treadwear 180 - относительная износоустойчивость рисунка протектора.Отвечает специальным
стандартным тестам США; - Traction A - оценка влажных условий А, В или С ( специальный
тест США); - Temperatyre B - температурная устойчивость на больших скоростях движения А, В
или С (специальный тест США);
</li>
<li>Safetywarning - требование техники безопасности при монтаже шины на обод и при
использовании шины. На некоторых моделях шин нового поколения для легковых автомобилей
введена дополнительная маркировка.На боковине шин фирмы "Pirelli" ставится стрелка,
указывающая направление вращения колеса. На боковых шинах других фирм наносятся две
стрелки с надписью "Rotation" (направление вращения). При сборке колеса необходимо
учитывать рекомендации маркировки: направление вращения колеса при движении автомобиля
вперед должно совпадать с направлением, указанным стрелкой (стрелками).
</li>
</ul>

<p>
Индекс грузоподъемности, кг/ #колесо
60 - 250
62 - 265
64 - 280
66 - 300
68 - 315
70 - 335
72 - 355
74 - 375
76 - 400
78 - 425
80 - 450
82 - 475
84 - 500
86 - 530
88 - 560
90 - 600
</p>

<p>
Индекс максимальной скорости, км/ч
I - 100
K - 110
L - 120
M - 130
N - 140
P - 150
Q - 160
R - 170
S - 180
T - 190
H - 210
V - 240
VR - 210-240
ZR - от 240
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Очень интересный способ добавлять фичи</h3>
<div class="outline-text-3" id="text-8-2">
<p>
Сначала мы отталкиваемся от фич и описываем их. Описание фич
сопровождаются кодом, который генерирует структуры данных, которые
являются источником для генераторов сущностий.
</p>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Способ вести обсуждение графически</h3>
<div class="outline-text-3" id="text-8-3">
<p>
В ряде случаев, в ответ на одно утверждение к нему возникает множество
вопросов. Было бы здорово оформлять их в виде отдельных кружков,
которые раскрываются в собственно текст, тогда никакие ветви не будут
упущены. Я представляю это в виде древа жизни из кабаллы, где ветви
обсуждений могут соединяться и расходиться.
</p>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> MUMPS</h3>
<div class="outline-text-3" id="text-8-4">
<p>
Обьединение идей MUMPS и вероятностного программирования
<a href="http://habrahabr.ru/post/242993/">http://habrahabr.ru/post/242993/</a> может обещать некоторые интересные
результаты&#x2026;
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Исследования</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> Graphviz</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Чтобы сохранять позиции элементов commanline должна быть такой:
</p>

<p>
neato -Tpng -otester.png -n test.dot
</p>

<p>
А файл:
</p>


<div class="figure">
<p><img src="zzz.png" alt="zzz.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> Дракон и sqlite</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Чтобы использовать ДРАКОН для облегчения императивного
программирования, необходимо
</p>

<ul class="org-ul">
<li>Поставить tcl/tk (sudo apt-get install tcl8.6 tk8.6 tcllib libsqlite3-tcl libtk-img)
</li>
<li>Поставить drakon<sub>editor</sub> (<a href="http://drakon-editor.sourceforge.net/editor.html#downloads">http://drakon-editor.sourceforge.net/editor.html#downloads</a>)
</li>
<li>Поставить sqlite3 (apt-get install sqlite3)
</li>
<li><p>
Использовать sqlite из elisp-a следующим образом:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-to-list 'load-path <span style="color: #87005f;">"~/repo/sqlite.el/"</span>)

(<span style="color: #af00ff;">require</span> '<span style="color: #008787;">sqlite</span>)

(setq s3d (sqlite-init <span style="color: #87005f;">"~/repo/moto/drakon.drn"</span>))

(<span style="color: #af00ff;">let</span> ((descriptor (sqlite-init <span style="color: #87005f;">"~/repo/moto/drakon.drn"</span>)))
  (setq res (sqlite-query descriptor <span style="color: #87005f;">"SELECT * FROM items"</span>))
  (sqlite-bye descriptor)
  res)
</pre>
</div>
</li>
</ul>

<p>
Таким образом мы получим таблицу элементов. Далее нам нужно
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="right">item<sub>id</sub></td>
<td class="right">diagram<sub>id</sub></td>
<td class="left">type</td>
<td class="left">text</td>
<td class="right">selected</td>
<td class="right">x</td>
<td class="right">y</td>
<td class="right">w</td>
<td class="right">h</td>
<td class="right">a</td>
<td class="right">b</td>
<td class="left">aux<sub>value</sub></td>
<td class="left">color</td>
<td class="left">format</td>
<td class="left">text2</td>
</tr>

<tr>
<td class="right">35</td>
<td class="right">1</td>
<td class="left">if</td>
<td class="left">"Успешная инициализация?"</td>
<td class="right">0</td>
<td class="right">170</td>
<td class="right">330</td>
<td class="right">120</td>
<td class="right">20</td>
<td class="right">80</td>
<td class="right">1</td>
<td class="left">,</td>
<td class="left">,</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">37</td>
<td class="right">1</td>
<td class="left">address</td>
<td class="left">"Отключение"</td>
<td class="right">0</td>
<td class="right">370</td>
<td class="right">550</td>
<td class="right">50</td>
<td class="right">30</td>
<td class="right">60</td>
<td class="right">0</td>
<td class="left">,</td>
<td class="left">,</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>


<p>
определить пересечения веток и других элементов. Начнем с начала,
где началом будем считать элемент <code>beginend</code> который не называется
"Конец"
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(sqlite-query s3d <span style="color: #87005f;">"SELECT item_id, text, x, y, w, h, a, b FROM items WHERE type LIKE 'beginend' AND text NOT LIKE '&#1050;&#1086;&#1085;&#1077;&#1094;'"</span>)
</pre>
</div>

<p>
Однако нам это мало поможет, так как это название диаграммы. Более
интересно узнать все ветви и расположить их в порядке слева-направо
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(sqlite-query s3d <span style="color: #87005f;">"SELECT item_id, text, x, y, w, h, a, b FROM items WHERE type LIKE 'branch' ORDER BY x"</span>)
</pre>
</div>

<p>
Теперь для каждой ветви нам необходимо получить лежащие на ней
элементы. В нашем простом случае все ветви очевидно имеют
одинаковую высоту и расположены строго вертикально, поэтому нам
достаточно найти блоки, координата X которых совпадает с
координатой X ветви. Таким образом, мы можем получить все блоки,
координаты которых лежат на ветви, упорядочив их сверху-вниз:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">get-blocks-of-vertical</span> (x from-y to-y)
  (sqlite-query
   s3d
   (format <span style="color: #87005f;">"SELECT item_id,type,text,x,y,w,h,a,b FROM items WHERE (x = %s) AND (y &gt;= %s) AND (y &lt;= %s) AND type NOT LIKE 'horizontal' AND type NOT LIKE 'vertical' AND type NOT LIKE 'branch' ORDER BY y"</span>
           x
           from-y
           to-y)))

(get-blocks-of-vertical 170 0 1000)
</pre>
</div>

<p>
Здесь мы впервые встречаемся с узлом типа <code>if</code>, у которого две
ветви. По умолчанию ветвь "да" - побочная, если нет, в поле <code>b</code>
устанавливается флаг "1". Мы должны выяснить, с чем соединяется
побочная ветвь, а для этого необходимо вычислить координаты
возможных точек пересечения, которые лежат в диапазоне от окончания
блока if до длины ответвления. Сразу найдем те элементы, с которым
пересекается ответвление, при этом учитываем, что возвратные
стрелки - случай особый, так как их координаты считаются
относительно верхнего правого угла. Поэтому точка пересечения у них
должны быть вычислена как { x = x - a | y = y + h }
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">get-lateral-if</span> (item-id)
  (<span style="color: #af00ff;">let*</span> ((res (sqlite-query
               s3d
               (format <span style="color: #87005f;">"SELECT x,y,w,h,a,b FROM items WHERE item_id = %s"</span> item-id)))
         (val (cadr res))
         (from-x (+ (string-to-number (car val)) (string-to-number (nth 2 val))))
         (to-x   (+ from-x (string-to-number (nth 4 val))))
         (y      (string-to-number (cadr val)))
         (where-not-arrow
          (format <span style="color: #87005f;">"((x &gt;= %s) AND (x &lt;= %s) AND (y = %s) AND type NOT LIKE 'arrow')"</span>
                  from-x
                  to-x
                  y))
         (where-arrow
          (format <span style="color: #87005f;">"((x-a &gt;= %s) AND (x-a &lt;= %s) AND (y+h = %s) AND type LIKE 'arrow')"</span>
                  from-x
                  to-x
                  y)))
    (sqlite-query
     s3d
     (format <span style="color: #87005f;">"SELECT item_id,type,text,x,y,w,h,a,b FROM items WHERE %s OR %s "</span>
             where-not-arrow
             where-arrow))))

(get-lateral-if 35)
</pre>
</div>

<p>
Здесь мы получили объект <code>vertical</code>, по котором уже определенной
функцией получаем все расположенные на нем объекты
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #af00ff;">let*</span> ((res (get-lateral-if 35))
       (val (cadr res))
       (center-x (nth 3 val))
       (from-y   (nth 4 val))
       (to-y     (+ (string-to-number from-y) (string-to-number (nth 6 val)))))
  <span style="color: #af0000;">;; </span><span style="color: #af0000;">(list center-x from-y to-y))</span>
  (get-blocks-of-vertical center-x from-y to-y))
</pre>
</div>

<p>
Таким образом мы можем строить разбор основных элементов дракон
схемы. Для уверенности проделаем эти операции с другим типом
ветвей:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(get-blocks-of-vertical 670  0 1000)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(get-lateral-if 23)
</pre>
</div>

<p>
Ну а дальше - дело техники - получить точку куда указывает стрелка,
элемент выше нее и ниже, чтобы определить переход
</p>

<p>
Следующая задача = построение графа управления по полученным данным
</p>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> tkl</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Исчерпывающая документация
<a href="http://www.peter-herth.de/ltk/ltkdoc/node52.html">http://www.peter-herth.de/ltk/ltkdoc/node52.html</a>
</p>

<p>
О генерации кода для дракон-схем:
<a href="http://drakon-editor.sourceforge.net/howto.html">http://drakon-editor.sourceforge.net/howto.html</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2017-09-08 Пт 05:01</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
