<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Модуль HeadHunter</title>
<!-- 2015-03-28 Сб. 08:06 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 92 -*- -->
<!-- org-toggle-inline-images -->

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Модуль HeadHunter</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Цель</a></li>
<li><a href="#sec-2">2. Что это такое?</a></li>
<li><a href="#sec-3">3. Сценарии использования</a>
<ul>
<li><a href="#sec-3-1">3.1. Составление резюме</a></li>
<li><a href="#sec-3-2">3.2. Опубликование резюме</a></li>
<li><a href="#sec-3-3">3.3. Автоматический поиск вакансий, создание правил отбора вакансий и автоматических действий над ними</a></li>
<li><a href="#sec-3-4">3.4. Поиск и просмотр вакансий, отсев, ранжирование, внесение заметок по вакансиям</a></li>
<li><a href="#sec-3-5">3.5. Нахождение вакансии в момент телефонного звонка</a></li>
<li><a href="#sec-3-6">3.6. Рассылка откликов</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1. Написание сопроводительных писем</a></li>
</ul>
</li>
<li><a href="#sec-3-7">3.7. Достижение договоренности о собеседовании</a></li>
<li><a href="#sec-3-8">3.8. Выполнение тестовых заданий</a></li>
<li><a href="#sec-3-9">3.9. Собеседование с работодателем</a></li>
<li><a href="#sec-3-10">3.10. Выбор лучшего предложения</a></li>
<li><a href="#sec-3-11">3.11. Вакансия становится неактуальной</a></li>
<li><a href="#sec-3-12">3.12. Отзывы соискателей о компаниях и вакансиях</a></li>
<li><a href="#sec-3-13">3.13. Маршрут</a></li>
<li><a href="#sec-3-14">3.14. Побочные сценарии соискателя</a></li>
<li><a href="#sec-3-15">3.15. Составление вакансий</a></li>
<li><a href="#sec-3-16">3.16. Опубликование вакансий</a></li>
<li><a href="#sec-3-17">3.17. Автоматический поиск резюме, создание правил отбора резюме и автоматических действий над ними</a></li>
<li><a href="#sec-3-18">3.18. Ручной поиск и просмотр резюме, отсев, ранжирование, внесение заметок по соискателям</a></li>
<li><a href="#sec-3-19">3.19. Рассылка приглашений</a></li>
<li><a href="#sec-3-20">3.20. Телефонные интервью</a></li>
<li><a href="#sec-3-21">3.21. Заполнение анкеты</a></li>
<li><a href="#sec-3-22">3.22. Собеседование с соискателем</a></li>
<li><a href="#sec-3-23">3.23. Предложение соискателю тестовых заданий</a></li>
<li><a href="#sec-3-24">3.24. Проверка тестовых заданий</a></li>
<li><a href="#sec-3-25">3.25. Анализ статистических отчетов</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Как это работает?</a>
<ul>
<li><a href="#sec-4-1">4.1. Источник вакансий</a></li>
<li><a href="#sec-4-2">4.2. Фабрика генераторов вакансий</a></li>
<li><a href="#sec-4-3">4.3. Определение правила обработки</a></li>
<li><a href="#sec-4-4">4.4. Процессор правил</a></li>
<li><a href="#sec-4-5">4.5. Декоратор для process-teaser</a></li>
<li><a href="#sec-4-6">4.6. Получение и обработка вакансий правилами</a></li>
<li><a href="#sec-4-7">4.7. Составление правил и работа с ними</a></li>
<li><a href="#sec-4-8">4.8. Правила отсева тизеров</a></li>
<li><a href="#sec-4-9">4.9. Макросы для определения правил отсева тизеров</a></li>
<li><a href="#sec-4-10">4.10. Правила анализа вакансий</a></li>
<li><a href="#sec-4-11">4.11. Макросы для определения правил анализа вакансий</a></li>
<li><a href="#sec-4-12">4.12. Построение URL-ов, для скачивания тизеров</a>
<ul>
<li><a href="#sec-4-12-1">4.12.1. Построение специализаций</a></li>
</ul>
</li>
<li><a href="#sec-4-13">4.13. Получение страниц</a></li>
<li><a href="#sec-4-14">4.14. Логин на источник</a></li>
<li><a href="#sec-4-15">4.15. Разбор тизеров вакансий</a>
<ul>
<li><a href="#sec-4-15-1">4.15.1. Трансформация дерева</a></li>
<li><a href="#sec-4-15-2">4.15.2. Определение минимальной и максимальной зарплаты</a></li>
</ul>
</li>
<li><a href="#sec-4-16">4.16. Разбор вакансий</a></li>
<li><a href="#sec-4-17">4.17. Сохранение вакансии и ее структура данных</a></li>
<li><a href="#sec-4-18">4.18. Состояния вакансий</a></li>
<li><a href="#sec-4-19">4.19. Печать вакансий</a></li>
<li><a href="#sec-4-20">4.20. Резюме соискателя</a></li>
<li><a href="#sec-4-21">4.21. Отправка отклика</a></li>
<li><a href="#sec-4-22">4.22. Фабрика генераторов отзывов</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Interface</a>
<ul>
<li><a href="#sec-5-1">5.1. Главная страница модуля</a></li>
<li><a href="#sec-5-2">5.2. Страница списка вакансий</a></li>
<li><a href="#sec-5-3">5.3. Страница вакансии</a></li>
<li><a href="#sec-5-4">5.4. <span class="todo nilSTART">START</span> Страница правил</a></li>
<li><a href="#sec-5-5">5.5. Страница документации модуля</a></li>
<li><a href="#sec-5-6">5.6. Страница поиска</a></li>
<li><a href="#sec-5-7">5.7. Галлерея (parenscript)</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Отдельные технические вещи</a>
<ul>
<li>
<ul>
<li><a href="#sec-6-0-1">6.0.1. <span class="todo nilWAIT">WAIT</span> Обход дерева и извлечение узлов</a></li>
<li><a href="#sec-6-0-2">6.0.2. <span class="todo nilWAIT">WAIT</span> Сопоставление и преобразование узлов</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. Хотелки (набор несогласованных идей, чтобы не забыть)</a>
<ul>
<li><a href="#sec-7-1">7.1. Процесс найма с т.з. соискателя</a></li>
<li><a href="#sec-7-2">7.2. Процесс найма с т.з. HR-а</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Тесты</a></li>
<li><a href="#sec-9">9. Точки входа</a></li>
<li><a href="#sec-10">10. Сборка</a>
<ul>
<li><a href="#sec-10-1">10.1. Фунциональные утилиты</a>
<ul>
<li><a href="#sec-10-1-1">10.1.1. Point-free определения:</a></li>
<li><a href="#sec-10-1-2">10.1.2. Flip, карринг, композиции:</a></li>
<li><a href="#sec-10-1-3">10.1.3. Свёртки и "развёртки":</a></li>
<li><a href="#sec-10-1-4">10.1.4. Отображения и фильтрации:</a></li>
<li><a href="#sec-10-1-5">10.1.5. Функции для списков на основе карринга и свёрток:</a></li>
<li><a href="#sec-10-1-6">10.1.6. Функции для чисел:</a></li>
<li><a href="#sec-10-1-7">10.1.7. И для булевых чисел:</a></li>
<li><a href="#sec-10-1-8">10.1.8. Многие другие функции представляются свёртками, например:</a></li>
<li><a href="#sec-10-1-9">10.1.9. Свёртки для деревьев:</a></li>
</ul>
</li>
<li><a href="#sec-10-2">10.2. Другие утилиты</a></li>
<li><a href="#sec-10-3">10.3. Утилиты</a></li>
<li><a href="#sec-10-4">10.4. Глобальные определения</a></li>
<li><a href="#sec-10-5">10.5. Сущности и автоматы</a></li>
</ul>
</li>
<li><a href="#sec-11">11. <span class="todo nilTODO">TODO</span> TODO</a></li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Цель</h2>
<div class="outline-text-2" id="text-1">
<p>
Мы все ищем работу на профильных сайтах время от времени. Иногда на это уходит
значительное время, т.к. мы выполняем множество рутинных действий, которых могли бы
избежать. Попробуем автоматизировать этот процесс, так чтобы работа, по-возможности
искалась сама, без непосредственного участия соискателя.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Что это такое?</h2>
<div class="outline-text-2" id="text-2">
<p>
Это средство автоматизации процесса поиска работы, выполненное в форме экспертной
системы. Оно умеет обучаться по ходу взаимодействия со своим пользователем. Обучение
производится с помощью внесения пользователем правил обработки входящего потока вакансий.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Сценарии использования</h2>
<div class="outline-text-2" id="text-3">
<p>
Если рассматривать поиск работы как бизнес-процесс, то в этом процессе я выступаю как
соискатель, а если с точки зрения data-flow - то обьект манипуляций является вакансия,
которая, с моей точки зрения, может находится в нескольких состояниях:
</p>
<ul class="org-ul">
<li>неотсортированна
</li>
<li>неинтересная
</li>
<li>интерсная
</li>
<li>отправлен отзыв
</li>
<li>отзыв просмотрен
</li>
<li>работодатель отказал
</li>
<li>работодатель пригласил на интервью
</li>
<li>прохождение интервью
</li>
<li>получено предложение
</li>
</ul>

<p>
Состояния образуют ориентированный граф, а множество вакансий в состояниях после "отзыв
отправлен" - фронт работ, в котором понятно что нужно делать по каждой вакансии. Ну а
интерфейс обеспечивает доступ к выборкам вакансий (CRUD) и действиям над ними
(BehaviourEngine).
</p>

<p>
Если по графу понятно какие возможны действия по каждой вакансии, то часть их можно
автоматизировать - например, т.н. "преселект", когда мы выкидываем вакансии, которые
соискателю заведомо неинтересны (например, я не хочу разрабатывать на .NET или
рассматривать вакансии без указания зарплаты). Или вот, к примеру, можно анализировать
текст вакансии, и если стек технологий, оплата и месторасположение устраивает -
автоматически отправлять отзыв.
</p>

<p>
Вакансии, как правило, пишутся довольно формальным языком, в них всегда есть раздел
"Требования", "Будет плюсом", "Условия" и т.п. поэтому это не так сложно. От
пользователя-соискателя в этом случае требуется только узнать о том, что его пригласили на
собеседование, ну и пройти его конечно.
</p>

<p>
Работу работодателя можно автоматизировать похожим образом. С той лишь разницей, что
работодатель осуществляет операции над отзывом соискателя, к которому прикреплено резюме и
другие личные данные соискателя. Этот отзыв может находится в таких состояниях:
</p>
<ul class="org-ul">
<li>непросмотрен
</li>
<li>неинтересный
</li>
<li>интересный
</li>
<li>отправлено приглашение
</li>
<li>приглашение просмотрено
</li>
<li>отправлено тестовое задание
</li>
<li>назначено собеседование
</li>
<li>сделано предложение (с такими-то условиями)
</li>
<li>предложение принято (вакансия закрыта)
</li>
<li>предложение не принято
</li>
</ul>

<p>
Исходя из всего этого, мы можем написать в первую очередь поддержку сценариев
использования для соискателя [#A] , а потом и работодателя [#B]:
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Составление резюме</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Пользователь просто размещает свое резюме. На самом деле - несколько резюме, так как
наиболее продвинутые пользователи пишут резюме под вакансию, а не рассылают одно и то же
резюме всем подряд.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Опубликование резюме</h3>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Автоматический поиск вакансий, создание правил отбора вакансий и автоматических действий над ними</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Внутри вакансий необходимо искать по критериям, которые пользователь может задавать сам,
в форме правил, выполняющих действия над вакансией, если она совпадает с правилом
</p>

<p>
Вакансии полезно упорядочить по зарплате
</p>

<p>
Мне бы хотелось сразу получать представление, насколько свежая вакансия
</p>

<p>
Мне было бы интересно, сколько интервью было проведено и запланировано по вакансии - эту
информацию можно узнать из анализа активности по ней других пользователей
</p>

<p>
Мне было бы интересно, как менялась вакансия с момента ее размещения компанией - можно
находить и отслеживать похожие вакансии по расстоянию Левенштейна в описании, к
примеру. Динамика изменения зарплатного предложения может многое сказать об отношении к
вакансии.
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Поиск и просмотр вакансий, отсев, ранжирование, внесение заметок по вакансиям</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Когда я читаю вакансию, я бы хотел, чтобы она переходила в статус "просмотрено" (и к ней
добавлялась дата просмотра)
</p>

<p>
Читая вакансию, мне бы хотелось устанавливать ей приоритет и вносить заметки, чтобы
отслеживать такие моменты, как например: необходимость позвонить позже, или все, что мне
сказал hr по телефону.
</p>

<p>
Если я отправляю отзыв на вакансию или звоню по телефону - я бы хотел, чтобы эти действия
сопровождались временем и изменением статуса, чтобы потом можно было отследить историю
взаимодействия с HR.
</p>

<p>
При этом, мне хотелось бы видеть на дашборде те вакансии, с которыми я договорился о
встрече и те, по которым нет движения долгое время, чтобы ничего не забывалось.
</p>

<p>
Я хочу получать напоминания о моем следующем шаге в отношении тех вакансий,
которые мне интересны.
</p>

<p>
Мне бы хотелось видеть на каком я этапе в тех вакансиях, которые меня интересуют.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Нахождение вакансии в момент телефонного звонка</h3>
<div class="outline-text-3" id="text-3-5">
<p>
После отправки отклика звонит работодатель и приглашает на интервью. В этот момент я хочу
найти эту вакансию, глянуть ее и в зависимости от того до чего мы
договорились с работодателем выставить ей некоторое состояние или внести заметки,
поставить тег, и.т.п.
</p>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Рассылка откликов</h3>
<div class="outline-text-3" id="text-3-6">
</div><div id="outline-container-sec-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Написание сопроводительных писем</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
Соискатель пишет шаблоны сопроводительных писем, которые будут отправлены вместе с
отзывом на вакансию
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7"><span class="section-number-3">3.7</span> Достижение договоренности о собеседовании</h3>
</div>
<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8"><span class="section-number-3">3.8</span> Выполнение тестовых заданий</h3>
</div>
<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9"><span class="section-number-3">3.9</span> Собеседование с работодателем</h3>
</div>
<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10"><span class="section-number-3">3.10</span> Выбор лучшего предложения</h3>
</div>
<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11"><span class="section-number-3">3.11</span> Вакансия становится неактуальной</h3>
<div class="outline-text-3" id="text-3-11">
<p>
Вакансия может стать неактуальной если работодатель снимет ее, но работодатели могут
забывать это сделать, поэтому можно предусмотреть тайм-аут или даже некоторое кол-во
голосов соискателей, которые дозвонились но им сказали, что вакансия уже неактуальна.
</p>
</div>
</div>

<div id="outline-container-sec-3-12" class="outline-3">
<h3 id="sec-3-12"><span class="section-number-3">3.12</span> Отзывы соискателей о компаниях и вакансиях</h3>
<div class="outline-text-3" id="text-3-12">
<p>
Можно сэкономить кучу времени и денег просто не нанимаясь в те компании, в которых "все
плохо". В этом плане соискатели могут помочь друг другу. Возможно и компании тоже будут
прислушиваться к такому фидбеку.
</p>
</div>
</div>

<div id="outline-container-sec-3-13" class="outline-3">
<h3 id="sec-3-13"><span class="section-number-3">3.13</span> Маршрут</h3>
<div class="outline-text-3" id="text-3-13">
<p>
Иногда я хочу спланировать маршрут поездки по собеседованиям. Это сервис с картами,
которые можно сделать позже.
</p>
</div>
</div>

<div id="outline-container-sec-3-14" class="outline-3">
<h3 id="sec-3-14"><span class="section-number-3">3.14</span> Побочные сценарии соискателя</h3>
<div class="outline-text-3" id="text-3-14">
<p>
Вакансии на сайтах размещаются <code>компаниями</code> и привязываются к ним. Мне, как соискателю,
интересно посмотреть какие вакансии размещала ранее конкретная компания, какие она
размещает теперь, как изменялись зарплаты - и тому подобная аналитическая информация.
</p>

<p>
   Я также хочу чтобы система проходила по вакансиям и в зависимости от сочетания условий
выполняла какие-то действия
</p>

<ul class="org-ul">
<li>напоминание мне о собеседованиях, звонках (календарь)
</li>
<li>автоматическое ранжирование вакансий (по перспективам найма, зарплате и.т.п)
</li>
</ul>

<p>
Система может анализировать компании с т.з. выставляемых вакансий и формирует профиль
компании. По выставляемым вакансиям можно сделать интересные выводы - например когда у
компании внезапно появляются вакансии на одного сеньера и нескольких линейных
разработчиков - это напоминает открытие нового отдела/проекта.
</p>

<p>
Система может классифицировать сохраненные вакансии по формальным признакам, таким как:
</p>
<ul class="org-ul">
<li>новые вакансии
</li>
<li>измененные
</li>
<li>закрытые (о закрытости вакансии можно судить по ряду критериев)
</li>
<li>особенно интересные
</li>
<li>необычные
</li>
</ul>

<p>
В случае изменений или появления новых интересующих пользователя вакансий можно
пользователю отправляеть уведомление (через систему очередей сообщений и по email).
</p>

<p>
Исходя из анализа DESCRIPTION можно определить требуемую технологию и требуемую степень
владения ею.
</p>

<p>
Еще можно сделать:
</p>

<p>
Предоставление рекомендаций и отбор вакансий на основе модифицируемых правил и фактах
предметной области, таких как "работодатель - компания по разработке ПО" или "ИТ-поддержка
не является приоритетом компании"
</p>

<p>
Предсказание поведения (путей достижения целей) компании (в процессе найма и вне его) на
основе моделей и целей.
</p>

<p>
Выбор вариантов поведения в ответ на предьявляемые требования (цикл распознавание-действие
в продукционной системе). Вплоть до автоматического построния резюме под вакансию из шаблонов.
</p>

<p>
Построение концептуальных моделей и преобразования в них - выбор стратегии действий и
постановка целей.
</p>

<p>
Выбор способа представления знаний (правила, фреймы, концептуальные графы)
</p>

<p>
Выбор стратегии поиска
</p>

<p>
Включение терма из набора технологий в заголовке вакансии - присвоение классификатора
(тега)
</p>

<p>
Правила вывода - сопоставление с профилем
</p>

<p>
Вычисление различий (дифф) требований вакансии и профильных навыков резюме - подбор или
построение оптимального резюме
</p>

<p>
Интерактивное построение профиля (ответы на вопросы). Необходим видимый прогресс и
предварительная классификация предложений
</p>

<p>
Построение новых правил на основе известных
</p>

<p>
Когда вакансия переносится в архив - мы должны отслеживать это на стороннем сайте и
реагировать, устанавливая статус <code>archive</code>
</p>

<p>
Когда мы собираем вакансии, распарсивая их с других сайтов, мы должны отслеживать их
состояние на этих сайтах.
</p>
</div>
</div>

<div id="outline-container-sec-3-15" class="outline-3">
<h3 id="sec-3-15"><span class="section-number-3">3.15</span> Составление вакансий</h3>
</div>
<div id="outline-container-sec-3-16" class="outline-3">
<h3 id="sec-3-16"><span class="section-number-3">3.16</span> Опубликование вакансий</h3>
</div>
<div id="outline-container-sec-3-17" class="outline-3">
<h3 id="sec-3-17"><span class="section-number-3">3.17</span> Автоматический поиск резюме, создание правил отбора резюме и автоматических действий над ними</h3>
</div>
<div id="outline-container-sec-3-18" class="outline-3">
<h3 id="sec-3-18"><span class="section-number-3">3.18</span> Ручной поиск и просмотр резюме, отсев, ранжирование, внесение заметок по соискателям</h3>
</div>
<div id="outline-container-sec-3-19" class="outline-3">
<h3 id="sec-3-19"><span class="section-number-3">3.19</span> Рассылка приглашений</h3>
</div>
<div id="outline-container-sec-3-20" class="outline-3">
<h3 id="sec-3-20"><span class="section-number-3">3.20</span> Телефонные интервью</h3>
</div>
<div id="outline-container-sec-3-21" class="outline-3">
<h3 id="sec-3-21"><span class="section-number-3">3.21</span> Заполнение анкеты</h3>
</div>
<div id="outline-container-sec-3-22" class="outline-3">
<h3 id="sec-3-22"><span class="section-number-3">3.22</span> Собеседование с соискателем</h3>
</div>
<div id="outline-container-sec-3-23" class="outline-3">
<h3 id="sec-3-23"><span class="section-number-3">3.23</span> Предложение соискателю тестовых заданий</h3>
</div>
<div id="outline-container-sec-3-24" class="outline-3">
<h3 id="sec-3-24"><span class="section-number-3">3.24</span> Проверка тестовых заданий</h3>
</div>
<div id="outline-container-sec-3-25" class="outline-3">
<h3 id="sec-3-25"><span class="section-number-3">3.25</span> Анализ статистических отчетов</h3>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Как это работает?</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Источник вакансий</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Пусть у нас есть источник вакансий, например, hh.ru. На нем можно сформулировать запрос и
получить выборку в виде списка тизеров вакансий, каждый из которых ведет на полное
описание вакансии.
</p>


<div id="fig:vacancy_source" class="figure">
<p><img src="./img/warehouse.jpg" alt="warehouse.jpg" />
</p>
<p><span class="figure-number">Figure 1:</span> Это источник вакансий</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Фабрика генераторов вакансий</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Пусть у нас есть фабрика <code>генераторов функций</code> назовем его <code>factory</code>, которая принимает
<code>источник вакансий</code> и параметры запроса (например: <code>профессиональную область</code>, <code>специализацию</code>,
<code>город</code>) и возвращает <code>функцию-генератор в замыкании</code>.
</p>


<div id="fig:factory" class="figure">
<p><img src="./img/factory.jpg" alt="factory.jpg" />
</p>
<p><span class="figure-number">Figure 2:</span> Фабрика генераторов вакансий</p>
</div>

<p>
Эта функция-генератор при каждом своем вызове вернет одну вакансию или <code>ложь</code> если все
вакансии кончились.
</p>


<div id="fig:generator" class="figure">
<p><img src="./img/generator.jpg" alt="generator.jpg" />
</p>
<p><span class="figure-number">Figure 3:</span> Функция-генератор, произведенная фабрикой</p>
</div>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает сначала тизеры
вакансий, а потом и сами вакансии, при этом процесс превращения тизера в вакансию
(<code>process-teaser</code>) вынесен из замыкания, т.к. не зависит от замкнутых переменных.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="factory">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;make_hh_url&gt;&gt;

&lt;&lt;hh_get_page&gt;&gt;

&lt;&lt;hh_parse_vacancy_teasers&gt;&gt;

&lt;&lt;hh_parse_vacancy&gt;&gt;

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> (current-teaser)
  (aif (hh-parse-vacancy (hh-get-page (format nil <span style="color: #8b2252;">"http://spb.hh.ru/vacancy/~A"</span> (getf current-teaser <span style="color: #483d8b;">:id</span>))))
       (merge-plists current-teaser it)
       nil))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">factory</span> ((vac-src (eql 'hh)) city prof-area <span style="color: #228b22;">&amp;optional</span> spec)
  (<span style="color: #a020f0;">let</span> ((url     (make-hh-url city prof-area spec))
        (page    0)
        (teasers nil))
    (alexandria:named-lambda get-vacancy ()
      (<span style="color: #a020f0;">labels</span> ((load-next-teasers-page ()
                 <span style="color: #b22222;">;; </span><span style="color: #b22222;">(dbg "~~ LOAD (page=~A)" page)</span>
                 (setf teasers (hh-parse-vacancy-teasers (hh-get-page (format nil url page))))
                 (incf page)
                 (<span style="color: #a020f0;">when</span> (equal 0 (length teasers))
                   (dbg <span style="color: #8b2252;">"~~ FIN"</span>)
                   (<span style="color: #a020f0;">return-from</span> get-vacancy 'nil)))
               (get-teaser ()
                 (<span style="color: #a020f0;">when</span> (equal 0 (length teasers))
                   (load-next-teasers-page))
                 (<span style="color: #a020f0;">let</span> ((current-teaser (car teasers)))
                   (setf teasers (cdr teasers))
                   current-teaser)))
        (<span style="color: #a020f0;">tagbody</span> get-new-teaser
           (<span style="color: #a020f0;">let</span> ((current-teaser (get-teaser)))
             (<span style="color: #a020f0;">let</span> ((current-vacancy (process-teaser current-teaser)))
               (<span style="color: #a020f0;">if</span> (null current-vacancy)
                   (<span style="color: #a020f0;">go</span> get-new-teaser)
                   (<span style="color: #a020f0;">return-from</span> get-vacancy current-vacancy)))))))))
</pre>
</div>

<p>
Для работы этому генератору нужно уметь:
</p>
<ul class="org-ul">
<li>Собирать URL страницы, где лежат тизеры (краткие описания) вакансий из параметов запроса
(<code>make-hh-url</code>)
</li>
<li>Скачивать HTML-страницы (<code>hh-get-page</code>)
</li>
<li>Разбирать тизеры из html-кода (<code>hh-parse-vacancy-teasers</code>)
</li>
<li>Обрабатывать разобранные тизеры (<code>hh-parse-vacancy</code>), чтобы получить по ним вакансии.
</li>
</ul>
<p>
Но я не буду сейчас на этом останавливаться и опишу потом, в соответствующих разделах.
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Определение правила обработки</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Пусть у нас есть возможность создавать именованные <code>правила</code>, которые получают на вход
список, представляющий собой тизер или вакансию, анализируют его, и выполняют какие-то
действия. В качестве примера, мы могли бы создать правило, которое добавляет к вакансии
поле <code>interesting</code> если зарплата и язык разработки нас устраивает.
</p>

<p>
Правило принимает на вход условие срабатывания и код, который будет выполнен, в случае
если условие выполняется на обрабатываемой вакансии.
</p>

<p>
Примем соглашение, что правило возвращает два значения:
</p>
<ul class="org-ul">
<li>первое - вакансию (возможно измененную)
</li>
<li>второе - указание процессору правил (например, прекратить обработку)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_rule">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-rule</span> ((name antecedent) <span style="color: #228b22;">&amp;body</span> consequent)
  `(list
     (<span style="color: #a020f0;">defun</span> ,(intern (concatenate 'string (symbol-name name) <span style="color: #8b2252;">"-ANTECEDENT"</span>)) (vacancy)
       ,antecedent)
     (<span style="color: #a020f0;">defun</span> ,(intern (concatenate 'string (symbol-name name) <span style="color: #8b2252;">"-CONSEQUENT"</span>)) (vacancy)
       (<span style="color: #a020f0;">let</span> ((result (<span style="color: #a020f0;">progn</span> ,@consequent)))
         (values vacancy result)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                                               </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">:stop))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                                   </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">:stop)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(let ((vacancy '(:name "Python" :salary 80000)))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(multiple-value-bind (vacancy-result rule-result)</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(if (hi-salary-java-antecedent vacancy)</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(hi-salary-java-consequent vacancy))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(print (format nil "vacancy: ~A ||| rule-result: ~A" (bprint vacancy-result) (bprint rule-result)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">-&gt;"vacancy: (:INTERESTING T :NAME \"Python\" :SALARY 80000) ||| rule-result: :STOP"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Процессор правил</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Теперь мы можем создать процессор правил <code>process</code>, который применяет к вакансии правила
поочередно. По сути, это <code>машина Э.Поста</code>, а все вместе представляет собой <code>продукционную
   систему</code> с прямой цепочкой вывода. Подробнее про продукционные системы <a href="http://www.ngpedia.ru/id429603p1.html">тут</a> и <a href="http://www.myshared.ru/slide/445840/">тут</a>.
</p>


<div id="fig:production_system" class="figure">
<p><img src="./img/production_system.gif" alt="production_system.gif" />
</p>
<p><span class="figure-number">Figure 4:</span> Продукционная система</p>
</div>

<p>
Процессор правил обрабатывает следущие особые случаи:
</p>
<ul class="org-ul">
<li>Если какое-то из правил возвращает во втором параметре <code>:stop</code> - обработка прекращается
и возвращается текущий обработанный результат
</li>
<li>Если какое-то из правил возвращает во втором параметре <code>:renew</code> - то обработка текущего
входного результата начинается с самого первого правила.
</li>
</ul>
<p>
По окончании обработки возвращается результирующая вакансия, которая может быть
модифицирована правилами
</p>


<div class="figure">
<p><img src="./img/process.png" alt="process.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="process">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">process</span> (vacancy rules)
  (<span style="color: #a020f0;">let</span> ((vacancy vacancy))
    (<span style="color: #a020f0;">tagbody</span>
     renew
       (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> rule <span style="color: #483d8b;">:in</span> rules <span style="color: #483d8b;">:do</span>
          (<span style="color: #a020f0;">let</span> ((antecedent (concatenate 'string (symbol-name rule) <span style="color: #8b2252;">"-ANTECEDENT"</span>))
                (consequent (concatenate 'string (symbol-name rule) <span style="color: #8b2252;">"-CONSEQUENT"</span>)))
            (<span style="color: #a020f0;">if</span> (funcall (intern antecedent) vacancy)
                (<span style="color: #a020f0;">multiple-value-bind</span> (vacancy-result rule-result)
                    (funcall (intern consequent) vacancy)
                  (setf vacancy vacancy-result)
                  (<span style="color: #a020f0;">when</span> (equal rule-result <span style="color: #483d8b;">:stop</span>)
                    (<span style="color: #a020f0;">return-from</span> process vacancy))
                  (<span style="color: #a020f0;">when</span> (equal rule-result <span style="color: #483d8b;">:renew</span>)
                    (<span style="color: #a020f0;">go</span> renew)))))))
    vacancy))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Декоратор для process-teaser</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Поскольку и вакансии и их тизеры представлены у нас одинаково, мы можем применять правила
и к тем и к другим. Это позволит отфильтровать некоторые вакансии только анализируя их
тизеры и не загружать лишнего.
</p>

<p>
Для того, чтобы сделать это удобным образом, обернем (:around method) <code>process-teaser</code>
так, чтобы исключить из дальнейшей обрабоки те тизеры, которые нам не нравятся. Например
те, у которых нет указания зарплаты или она слишком низка. После того, как тизер
превратиться в вакансию мы применим к ней другой список правил, которые реализуют все
остальную логику.
</p>



<div class="figure">
<p><img src="./img/around.png" alt="around.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="process_teaser_around">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;rules&gt;&gt;

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> <span style="color: #483d8b;">:around</span> (current-teaser)
  (aif (process current-teaser (rules-for-teaser))
       (process (call-next-method it) (rules-for-vacancy))
       nil))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> Получение и обработка вакансий правилами</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Теперь мы можем получить генератор, и, вызывая его, забирать вакансии, пока они не
закончатся. Все вакансии будут корректно обработаны правилами - сначала на этапе получения
тизеров, а потом на этапе получения вакансий.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="run">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;define_rule&gt;&gt;

&lt;&lt;process&gt;&gt;

&lt;&lt;process_teaser_around&gt;&gt;

&lt;&lt;factory&gt;&gt;

&lt;&lt;save_vacancy&gt;&gt;

&lt;&lt;send_respond&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">run</span> ()
  (<span style="color: #a020f0;">let</span> ((gen (factory 'hh <span style="color: #8b2252;">"spb"</span> <span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
                      <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)))
    (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> i <span style="color: #483d8b;">:from</span> 1 <span style="color: #483d8b;">:to</span> 100 <span style="color: #483d8b;">:do</span>
       <span style="color: #b22222;">;; </span><span style="color: #b22222;">(dbg "~A" i)</span>
       (<span style="color: #a020f0;">let</span> ((vacancy (funcall gen)))
         (<span style="color: #a020f0;">when</span> (null vacancy)
           (<span style="color: #a020f0;">return</span>))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(run)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> Составление правил и работа с ними</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Теперь можно удобным и компактным способом добавить все необходимые правила и обеспечить
методы их обработки
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;rules_for_vacancy&gt;&gt;

&lt;&lt;rules_for_teasers&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-all-rules</span> ()
  (<span style="color: #a020f0;">let</span> ((result (make-hash-table <span style="color: #483d8b;">:test</span> #'equal)))
    (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> var <span style="color: #483d8b;">:being</span> <span style="color: #483d8b;">:the</span> present-symbols <span style="color: #483d8b;">:in</span> (find-package <span style="color: #8b2252;">"MOTO"</span>)
       <span style="color: #483d8b;">:when</span> (or
              (and (search <span style="color: #8b2252;">"CONSEQUENT"</span> (symbol-name var))
                   (fboundp var))
              (and (search <span style="color: #8b2252;">"ANTECEDENT"</span> (symbol-name var))
                   (fboundp var)))
       <span style="color: #483d8b;">:collect</span> (<span style="color: #a020f0;">let</span> ((key (ppcre:regex-replace <span style="color: #8b2252;">"-ANTECEDENT"</span> (symbol-name var) <span style="color: #8b2252;">""</span>)))
                  (setf key (ppcre:regex-replace <span style="color: #8b2252;">"-CONSEQUENT"</span> key <span style="color: #8b2252;">""</span>))
                  (setf (gethash key result) <span style="color: #8b2252;">""</span>)))
    (mapcar #'intern
            (sort
             (alexandria:hash-table-keys result)
             #'(<span style="color: #a020f0;">lambda</span> (a b)
                 (string&lt; a b))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">clear-all-rules</span> ()
  (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> var <span style="color: #483d8b;">:being</span> <span style="color: #483d8b;">:the</span> present-symbols <span style="color: #483d8b;">:in</span> (find-package <span style="color: #8b2252;">"MOTO"</span>)
     <span style="color: #483d8b;">:when</span> (or
            (and (search <span style="color: #8b2252;">"CONSEQUENT"</span> (symbol-name var))
                 (fboundp var))
            (and (search <span style="color: #8b2252;">"ANTECEDENT"</span> (symbol-name var))
                 (fboundp var)))
     <span style="color: #483d8b;">:collect</span> (fmakunbound var)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rules-for-teaser</span> ()
  (remove-if-not #'(<span style="color: #a020f0;">lambda</span> (x)
                     (search <span style="color: #8b2252;">"DROP-TEASER-IF"</span> (symbol-name x)))
                 (get-all-rules)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rules-for-vacancy</span> ()
  (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                 (search <span style="color: #8b2252;">"DROP-TEASER-IF"</span> (symbol-name x)))
             (get-all-rules)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> Правила отсева тизеров</h3>
<div class="outline-text-3" id="text-4-8">
<p>
Какие же правила и действия можно составить для того чтобы отсеять неинтересные тизеры
вакансий? В основном те, которые не устраивают по зарплате и те, у которых в названиях
упомянуты неинтересные технологии. К примеру, я не хочу даже смотреть на вакансии у
которых не указана зарплата или она ниже минимально премлимой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_teasers">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;sugar_for_teaser_rules&gt;&gt;

(<span style="color: #a020f0;">define-drop-teaser-rule</span> (salary-1-no (null (getf vacancy <span style="color: #483d8b;">:salary</span>)))
  (dbg <span style="color: #8b2252;">"  - no salary"</span>))

(<span style="color: #a020f0;">define-drop-teaser-rule</span> (salary-2-low (or
                                        (and (equal (getf vacancy <span style="color: #483d8b;">:currency</span>) <span style="color: #8b2252;">"RUR"</span>)
                                             (&lt; (getf vacancy <span style="color: #483d8b;">:salary-max</span>) 90000))
                                        (and (equal (getf vacancy <span style="color: #483d8b;">:currency</span>) <span style="color: #8b2252;">"USD"</span>)
                                             (&lt; (getf vacancy <span style="color: #483d8b;">:salary-max</span>) (floor 90000 67)))
                                        (and (equal (getf vacancy <span style="color: #483d8b;">:currency</span>) <span style="color: #8b2252;">"USD"</span>)
                                             (&lt; (getf vacancy <span style="color: #483d8b;">:salary-max</span>) (floor 90000 77)))
                                        ))
  (dbg <span style="color: #8b2252;">"  - low salary"</span>))

(<span style="color: #a020f0;">define-drop-all-teaser-when-name-contains-rule</span>
    <span style="color: #8b2252;">"iOS"</span> <span style="color: #8b2252;">"Python"</span> <span style="color: #8b2252;">"Django"</span> <span style="color: #8b2252;">"IOS"</span> <span style="color: #8b2252;">"1C"</span> <span style="color: #8b2252;">"1&#1057;"</span> <span style="color: #8b2252;">"C++"</span> <span style="color: #8b2252;">"&#1057;++"</span> <span style="color: #8b2252;">"Ruby"</span> <span style="color: #8b2252;">"Ruby on Rails"</span>
    <span style="color: #8b2252;">"Frontend"</span> <span style="color: #8b2252;">"Front End"</span> <span style="color: #8b2252;">"Front-end"</span> <span style="color: #8b2252;">"Go"</span> <span style="color: #8b2252;">"Q/A"</span> <span style="color: #8b2252;">"QA"</span> <span style="color: #8b2252;">"C#"</span> <span style="color: #8b2252;">".NET"</span> <span style="color: #8b2252;">".Net"</span>
    <span style="color: #8b2252;">"Unity3D"</span> <span style="color: #8b2252;">"Flash"</span> <span style="color: #8b2252;">"Java"</span> <span style="color: #8b2252;">"Android"</span> <span style="color: #8b2252;">"ASP"</span> <span style="color: #8b2252;">"Objective-C"</span> <span style="color: #8b2252;">"Go"</span> <span style="color: #8b2252;">"Delphi"</span>
    <span style="color: #8b2252;">"Sharepoint"</span> <span style="color: #8b2252;">"Flash"</span> <span style="color: #8b2252;">"PL/SQL"</span> <span style="color: #8b2252;">"Oracle"</span> <span style="color: #8b2252;">"designer"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> Макросы для определения правил отсева тизеров</h3>
<div class="outline-text-3" id="text-4-9">
<p>
Для начала определим макрос, который создает правила отсева тизеров - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-drop-teaser-rule</span> ((name antecedent) <span style="color: #228b22;">&amp;body</span> consequent)
  `(<span style="color: #a020f0;">define-rule</span> (,(intern (concatenate 'string <span style="color: #8b2252;">"DROP-TEASER-IF-"</span>(symbol-name name))) ,antecedent)
     (dbg <span style="color: #8b2252;">"drop teaser: ~A-~A (~A) ~A"</span> (getf vacancy <span style="color: #483d8b;">:salary-min</span>) (getf vacancy <span style="color: #483d8b;">:salary-max</span>) (getf vacancy <span style="color: #483d8b;">:currency</span>) (getf vacancy <span style="color: #483d8b;">:name</span>))
     <span style="color: #b22222;">;; </span><span style="color: #b22222;">(dbg "~A" vacancy)</span>
     ,@consequent
     (setf vacancy nil)
     <span style="color: #483d8b;">:stop</span>))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(macroexpand-1</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">'(define-drop-teaser-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                                              </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(print (getf vacancy :name))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(print (getf vacancy :salary)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(DEFINE-RULE (DROP-TEASER-IF-HI-SALARY-JAVA</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">(AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME)))))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(PRINT (GETF VACANCY :NAME))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(PRINT (GETF VACANCY :SALARY))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(SETF VACANCY NIL)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">:STOP)</span>
</pre>
</div>

<p>
Теперь определим расширение предыдущего макроса, которое создает правило, отсеивающее
тизер, в случае, если в поле <code>:name</code> есть вхождение переданной строки
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-drop-teaser-by-name-rule</span> (str <span style="color: #228b22;">&amp;body</span> consequent)
  `(<span style="color: #a020f0;">define-drop-teaser-rule</span> (,(intern (concatenate 'string <span style="color: #8b2252;">"NAME-CONTAINS-"</span> (string-upcase (ppcre:regex-replace-all <span style="color: #8b2252;">"\\s+"</span> str <span style="color: #8b2252;">"-"</span>))))
                              (contains (getf vacancy <span style="color: #483d8b;">:name</span>) ,str))
     (dbg <span style="color: #8b2252;">"  - name contains ~A"</span> ,str)
     ,@consequent))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(macroexpand-1</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">'(define-drop-teaser-by-name-rule "Android")))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(DEFINE-DROP-TEASER-RULE (IF-NAME-CONTAINS-ANDROID</span>
<span style="color: #b22222;">;;                           </span><span style="color: #b22222;">(CONTAINS (GETF VACANCY :NAME) "Android"))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(DBG "drop:")</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(DBG "  name contains ~A" "Android"))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(define-drop-teaser-by-name-rule "Android")</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">==&gt; (DROP-TEASER-IF-IF-NAME-CONTAINS-ANDROID-ANTECEDENT</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">DROP-TEASER-IF-IF-NAME-CONTAINS-ANDROID-CONSEQUENT)</span>
</pre>
</div>

<p>
Теперь в соответствии с принципом DRY определем макрос, который создаст список правил,
отсеивающих тизеры по вхождению первой строки в поле <code>:name</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-drop-all-teaser-when-name-contains-rule</span> (<span style="color: #228b22;">&amp;rest</span> names)
  `(list ,@(<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> name <span style="color: #483d8b;">:in</span> names <span style="color: #483d8b;">:collect</span>
              `(<span style="color: #a020f0;">define-drop-teaser-by-name-rule</span> ,name))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(LIST (DEFINE-DROP-TEASER-BY-NAME-RULE "IOS")</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(DEFINE-DROP-TEASER-BY-NAME-RULE "1&#1057;")</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(DEFINE-DROP-TEASER-BY-NAME-RULE "C++"))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt;</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">((DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-ANTECEDENT</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-CONSEQUENT)</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-ANTECEDENT</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-CONSEQUENT)</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(DROP-TEASER-IF-IF-NAME-CONTAINS-C++-ANTECEDENT</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">DROP-TEASER-IF-IF-NAME-CONTAINS-C++-CONSEQUENT))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> Правила анализа вакансий</h3>
<div class="outline-text-3" id="text-4-10">
<ul class="org-ul">
<li>Я не хочу смотреть на вакансии, в компаниях где я уже работал.
</li>
<li>Если это уже существующая в базе вакансия и ничего не изменилось - игнорируем и
останавливаем ее обработку
</li>
<li>Я хочу присвоить вакансии определенный ранг, в зависимости от з\п
</li>
<li>Я хочу увеличивать этот ранг за упоминание в тексте описания вакансии моих любимых
слов: Lisp, Erlang, Closure, Prolog, Haskell, Smalltalk
</li>
<li>Я хочу особо отметить вакансии, у которых ранг выше [порогового ранга], чтобы
[отправить отклик]
</li>
<li>Я хочу занести вакансию в базу.
</li>
<li>Я хочу вывести вакансию в консоль.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;sugar_for_vacancy_rules&gt;&gt;

&lt;&lt;show_vacancy&gt;&gt;

(<span style="color: #a020f0;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #483d8b;">:emp-name</span>) <span style="color: #8b2252;">"Webdom"</span>))
  (dbg <span style="color: #8b2252;">"   - already worked"</span>))

(<span style="color: #a020f0;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #483d8b;">:emp-name</span>) <span style="color: #8b2252;">"&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;"</span>))
  (dbg <span style="color: #8b2252;">"   - already worked"</span>))

(<span style="color: #a020f0;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #483d8b;">:emp-name</span>) <span style="color: #8b2252;">"FBS"</span>))
  (dbg <span style="color: #8b2252;">"   - already worked"</span>))

(<span style="color: #a020f0;">define-drop-vacancy-rule</span> (already-exists-in-db (not (null (find-vacancy <span style="color: #483d8b;">:src-id</span> (getf vacancy <span style="color: #483d8b;">:id</span>)))))
  (<span style="color: #a020f0;">let</span> ((exists (car (find-vacancy <span style="color: #483d8b;">:src-id</span> (getf vacancy <span style="color: #483d8b;">:id</span>)))))
    (dbg <span style="color: #8b2252;">"   - already exists"</span>)))

(<span style="color: #a020f0;">define-rule</span> (set-rank t)
  (setf (getf vacancy <span style="color: #483d8b;">:rank</span>) (getf vacancy <span style="color: #483d8b;">:salary</span>)))

(<span style="color: #a020f0;">define-rule</span> (set-rank-up-by-lisp (contains (format nil <span style="color: #8b2252;">"~A"</span> (bprint (getf vacancy <span style="color: #483d8b;">:descr</span>))) <span style="color: #8b2252;">"Lisp"</span>))
  (dbg <span style="color: #8b2252;">"up rank by Lisp"</span>)
  (setf (getf vacancy <span style="color: #483d8b;">:rank</span>) (+ (getf vacancy <span style="color: #483d8b;">:rank</span>) 30000)))

(<span style="color: #a020f0;">define-rule</span> (set-rank-up-by-erlang (contains (format nil <span style="color: #8b2252;">"~A"</span> (bprint (getf vacancy <span style="color: #483d8b;">:descr</span>))) <span style="color: #8b2252;">"Erlang"</span>))
  (dbg <span style="color: #8b2252;">"up rank by Erlang"</span>)
  (setf (getf vacancy <span style="color: #483d8b;">:rank</span>) (+ (getf vacancy <span style="color: #483d8b;">:rank</span>) 15000)))

(<span style="color: #a020f0;">define-rule</span> (set-rank-up-by-haskell (contains (format nil <span style="color: #8b2252;">"~A"</span> (bprint (getf vacancy <span style="color: #483d8b;">:descr</span>))) <span style="color: #8b2252;">"Haskell"</span>))
  (dbg <span style="color: #8b2252;">"up rank by Haskell"</span>)
  (setf (getf vacancy <span style="color: #483d8b;">:rank</span>) (+ (getf vacancy <span style="color: #483d8b;">:rank</span>) 10000)))

(<span style="color: #a020f0;">define-rule</span> (z-print t)
  (show-vacancy vacancy))

(<span style="color: #a020f0;">define-rule</span> (z-save t)
  (save-vacancy vacancy)
  <span style="color: #483d8b;">:stop</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> Макросы для определения правил анализа вакансий</h3>
<div class="outline-text-3" id="text-4-11">
<p>
Для начала определим макрос, который создает правила отсева вакансий - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_vacancy_rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-drop-vacancy-rule</span> ((name antecedent) <span style="color: #228b22;">&amp;body</span> consequent)
  `(<span style="color: #a020f0;">define-rule</span> (,(intern (concatenate 'string <span style="color: #8b2252;">"DROP-VACANCY-IF-"</span>(symbol-name name))) ,antecedent)
     (dbg <span style="color: #8b2252;">"drop vacancy: ~A : ~A"</span> (getf vacancy <span style="color: #483d8b;">:name</span>) (getf vacancy <span style="color: #483d8b;">:emp-name</span>))
     ,@consequent
     (setf vacancy nil)
     <span style="color: #483d8b;">:stop</span>))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(macroexpand-1</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">'(define-drop-vacancy-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                                              </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(print (getf vacancy :name))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(print (getf vacancy :salary)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(DEFINE-RULE (DROP-VACANCY-IF-HI-SALARY-JAVA</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">(AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME)))))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(PRINT (GETF VACANCY :NAME))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(PRINT (GETF VACANCY :SALARY))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(SETF VACANCY NIL)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">:STOP)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> Построение URL-ов, для скачивания тизеров</h3>
<div class="outline-text-3" id="text-4-12">
<p>
Тизеры вакансий размещаются постранично, по 20 штук на странице, и мы можем собрать все
страницы, если будем получать страницу за страницей, пока не получим страницу, на которой
вакансий нет.
</p>

<p>
В качестве GET-параметров запросы указываются <code>специализации</code> и город. Значения <code>cluster</code>
и <code>area</code> не меняются. Поэтому, единственная сложность построения URL - это правильно
сформировать <code>специализации</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_hh_url">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;make_specialization_hh_url_string&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-hh-url</span> (city prof-area <span style="color: #228b22;">&amp;optional</span> specs)
  <span style="color: #8b2252;">"http://spb.hh.ru/search/vacancy?text=&amp;specialization=1.221&amp;area=2&amp;items_on_page=100&amp;no_magic=true&amp;page=~A"</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

(make-hh-url <span style="color: #8b2252;">"spb"</span> <span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-4-12-1" class="outline-4">
<h4 id="sec-4-12-1"><span class="section-number-4">4.12.1</span> Построение специализаций</h4>
<div class="outline-text-4" id="text-4-12-1">
<p>
Специализации задаются в формате "1.221", где цифра слева от точки представляет
профессиональное направление, а справа - собственно специализацию. В интерфейсе
допустимо выбрать одно направление и несколько специализаций в нем, при этом для каждой
специализации формируется параметр GET-запроса. Допустимо выбрать только направление,
без специализаций.
</p>

<p>
По этой причине мы должны иметь дерево специализаций и транслятор названий специализаций
в их номера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_specialization_hh_url_string">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;prof_areas&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-specialization-hh-url-string</span> (prof-area <span style="color: #228b22;">&amp;optional</span> specs)
  (<span style="color: #a020f0;">let</span> ((specialization (assoc prof-area *prof-areas* <span style="color: #483d8b;">:test</span> #'equal)))
    (<span style="color: #a020f0;">when</span> (null specialization)
      (err 'specialization-not-found))
    (<span style="color: #a020f0;">when</span> (stringp specs)
      (setf specs (list specs)))
    (<span style="color: #a020f0;">if</span> (null specs)
        (concatenate 'string
                     <span style="color: #8b2252;">"&amp;specialization="</span>
                     (cadr specialization))
        (format nil <span style="color: #8b2252;">"~{&amp;~A~}"</span>
                (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> spec <span style="color: #483d8b;">:in</span> specs <span style="color: #483d8b;">:collect</span>
                   (<span style="color: #a020f0;">let</span> ((spec (cdr (assoc spec (caddr specialization) <span style="color: #483d8b;">:test</span> #'equal))))
                     (<span style="color: #a020f0;">when</span> (null spec)
                       (err 'spec-not-found))
                     (concatenate 'string <span style="color: #8b2252;">"specialization="</span> (cadr specialization) <span style="color: #8b2252;">"."</span> spec)))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" '("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #b22222;">;;                                    </span><span style="color: #b22222;">'("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"))</span>
</pre>
</div>

<p>
Дерево специализаций будем хранить в глобальном alist-е, т.к. оно никогда не меняется. Я
не стал заполнять его целиком, ограничившись только профессиональной областью "ИТ". По
необходимости заполню остальное.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="prof_areas">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*prof-areas*</span>
  '((<span style="color: #8b2252;">"&#1042;&#1089;&#1077; &#1087;&#1088;&#1086;&#1092;&#1077;&#1089;&#1089;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080;"</span> . (<span style="color: #8b2252;">""</span>))
    (<span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
     . (<span style="color: #8b2252;">"1"</span> ((<span style="color: #8b2252;">"CRM &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;"</span> . <span style="color: #8b2252;">"536"</span>)
             (<span style="color: #8b2252;">"CTO, CIO, &#1044;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088; &#1087;&#1086; IT"</span> . <span style="color: #8b2252;">"3"</span>)
             (<span style="color: #8b2252;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"9"</span>)
             (<span style="color: #8b2252;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"10"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088; &#1073;&#1072;&#1079; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;"</span> . <span style="color: #8b2252;">"420"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1085;&#1072;&#1083;&#1080;&#1090;&#1080;&#1082;"</span> . <span style="color: #8b2252;">"25"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1088;&#1090;-&#1076;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088;"</span> . <span style="color: #8b2252;">"30"</span>)
             (<span style="color: #8b2252;">"&#1041;&#1072;&#1085;&#1082;&#1086;&#1074;&#1089;&#1082;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #8b2252;">"395"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1075;&#1088;&#1086;&#1074;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #8b2252;">"475"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"82"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #8b2252;">"89"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1084;&#1087;&#1100;&#1102;&#1090;&#1077;&#1088;&#1085;&#1072;&#1103; &#1073;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . <span style="color: #8b2252;">"110"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1089;&#1072;&#1083;&#1090;&#1080;&#1085;&#1075;, &#1040;&#1091;&#1090;&#1089;&#1086;&#1088;&#1089;&#1080;&#1085;&#1075;"</span> . <span style="color: #8b2252;">"113"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1090;&#1077;&#1085;&#1090;"</span> . <span style="color: #8b2252;">"116"</span>)
             (<span style="color: #8b2252;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;"</span> . <span style="color: #8b2252;">"137"</span>)
             (<span style="color: #8b2252;">"&#1052;&#1091;&#1083;&#1100;&#1090;&#1080;&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . <span style="color: #8b2252;">"161"</span>)
             (<span style="color: #8b2252;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1091;&#1088;&#1086;&#1074;&#1077;&#1085;&#1100;, &#1052;&#1072;&#1083;&#1086; &#1086;&#1087;&#1099;&#1090;&#1072;"</span> . <span style="color: #8b2252;">"172"</span>)
             (<span style="color: #8b2252;">"&#1054;&#1087;&#1090;&#1080;&#1084;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103; &#1089;&#1072;&#1081;&#1090;&#1072; (SEO)"</span> . <span style="color: #8b2252;">"400"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1077;&#1088;&#1077;&#1076;&#1072;&#1095;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1080; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1074; &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #8b2252;">"203"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072;, Helpdesk"</span> . <span style="color: #8b2252;">"211"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span> . <span style="color: #8b2252;">"221"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . <span style="color: #8b2252;">"225"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1102;&#1089;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"232"</span>)
             (<span style="color: #8b2252;">"&#1056;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1077; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;&#1072;"</span> . <span style="color: #8b2252;">"246"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1077;&#1090;&#1077;&#1074;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"270"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1072;&#1103; &#1080;&#1085;&#1090;&#1077;&#1075;&#1088;&#1072;&#1094;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"272"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span> . <span style="color: #8b2252;">"273"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"274"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1077;&#1084; (ERP)"</span> . <span style="color: #8b2252;">"50"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1086;&#1090;&#1086;&#1074;&#1099;&#1077;, &#1041;&#1077;&#1089;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"277"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span> . <span style="color: #8b2252;">"474"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&#1084;&#1091;&#1085;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"295"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . <span style="color: #8b2252;">"117"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1087;&#1080;&#1089;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> . <span style="color: #8b2252;">"296"</span>)
             (<span style="color: #8b2252;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span> . <span style="color: #8b2252;">"327"</span>)
             (<span style="color: #8b2252;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"359"</span>))))
    (<span style="color: #8b2252;">"&#1041;&#1091;&#1093;&#1075;&#1072;&#1083;&#1090;&#1077;&#1088;&#1080;&#1103;, &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1091;&#1095;&#1077;&#1090;, &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1099; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1103;"</span> . (<span style="color: #8b2252;">"2"</span>))
    (<span style="color: #8b2252;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;, &#1088;&#1077;&#1082;&#1083;&#1072;&#1084;&#1072;, PR"</span> . (<span style="color: #8b2252;">"3"</span>))
    (<span style="color: #8b2252;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1080;&#1074;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"4"</span>))
    (<span style="color: #8b2252;">"&#1041;&#1072;&#1085;&#1082;&#1080;, &#1080;&#1085;&#1074;&#1077;&#1089;&#1090;&#1080;&#1094;&#1080;&#1080;, &#1083;&#1080;&#1079;&#1080;&#1085;&#1075;"</span> . (<span style="color: #8b2252;">"5"</span>))
    (<span style="color: #8b2252;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;&#1086;&#1084;, &#1090;&#1088;&#1077;&#1085;&#1080;&#1085;&#1075;&#1080;"</span> . (<span style="color: #8b2252;">"6"</span>))
    (<span style="color: #8b2252;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100;&#1085;&#1099;&#1081; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;"</span> . (<span style="color: #8b2252;">"7"</span>))
    (<span style="color: #8b2252;">"&#1041;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #8b2252;">"8"</span>))
    (<span style="color: #8b2252;">"&#1042;&#1099;&#1089;&#1096;&#1080;&#1081; &#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1084;&#1077;&#1085;&#1090;"</span> . (<span style="color: #8b2252;">"9"</span>))
    (<span style="color: #8b2252;">"&#1044;&#1086;&#1073;&#1099;&#1095;&#1072; &#1089;&#1099;&#1088;&#1100;&#1103;"</span> . (<span style="color: #8b2252;">"10"</span>))
    (<span style="color: #8b2252;">"&#1048;&#1089;&#1082;&#1091;&#1089;&#1089;&#1090;&#1074;&#1086;, &#1088;&#1072;&#1079;&#1074;&#1083;&#1077;&#1095;&#1077;&#1085;&#1080;&#1103;, &#1084;&#1072;&#1089;&#1089;-&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . (<span style="color: #8b2252;">"11"</span>))
    (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1089;&#1091;&#1083;&#1100;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"12"</span>))
    (<span style="color: #8b2252;">"&#1052;&#1077;&#1076;&#1080;&#1094;&#1080;&#1085;&#1072;, &#1092;&#1072;&#1088;&#1084;&#1072;&#1094;&#1077;&#1074;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #8b2252;">"13"</span>))
    (<span style="color: #8b2252;">"&#1053;&#1072;&#1091;&#1082;&#1072;, &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"14"</span>))
    (<span style="color: #8b2252;">"&#1043;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1072;&#1103; &#1089;&#1083;&#1091;&#1078;&#1073;&#1072;, &#1085;&#1077;&#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1095;&#1077;&#1089;&#1082;&#1080;&#1077; &#1086;&#1088;&#1075;&#1072;&#1085;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080;"</span> . (<span style="color: #8b2252;">"16"</span>))
    (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . (<span style="color: #8b2252;">"17"</span>))
    (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1080;&#1079;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;"</span> . (<span style="color: #8b2252;">"18"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1090;&#1088;&#1072;&#1093;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"19"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1090;&#1088;&#1086;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;&#1086;, &#1085;&#1077;&#1076;&#1074;&#1080;&#1078;&#1080;&#1084;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #8b2252;">"20"</span>))
    (<span style="color: #8b2252;">"&#1058;&#1088;&#1072;&#1085;&#1089;&#1087;&#1086;&#1088;&#1090;, &#1083;&#1086;&#1075;&#1080;&#1089;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #8b2252;">"21"</span>))
    (<span style="color: #8b2252;">"&#1058;&#1091;&#1088;&#1080;&#1079;&#1084;, &#1075;&#1086;&#1089;&#1090;&#1080;&#1085;&#1080;&#1094;&#1099;, &#1088;&#1077;&#1089;&#1090;&#1086;&#1088;&#1072;&#1085;&#1099;"</span> . (<span style="color: #8b2252;">"22"</span>))
    (<span style="color: #8b2252;">"&#1070;&#1088;&#1080;&#1089;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"23"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1087;&#1086;&#1088;&#1090;&#1080;&#1074;&#1085;&#1099;&#1077; &#1082;&#1083;&#1091;&#1073;&#1099;, &#1092;&#1080;&#1090;&#1085;&#1077;&#1089;, &#1089;&#1072;&#1083;&#1086;&#1085;&#1099; &#1082;&#1088;&#1072;&#1089;&#1086;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"24"</span>))
    (<span style="color: #8b2252;">"&#1048;&#1085;&#1089;&#1090;&#1072;&#1083;&#1083;&#1103;&#1094;&#1080;&#1103; &#1080; &#1089;&#1077;&#1088;&#1074;&#1080;&#1089;"</span> . (<span style="color: #8b2252;">"25"</span>))
    (<span style="color: #8b2252;">"&#1047;&#1072;&#1082;&#1091;&#1087;&#1082;&#1080;"</span> . (<span style="color: #8b2252;">"26"</span>))
    (<span style="color: #8b2252;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1072;&#1088;&#1100;&#1077;&#1088;&#1099;, &#1089;&#1090;&#1091;&#1076;&#1077;&#1085;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"15"</span>))
    (<span style="color: #8b2252;">"&#1044;&#1086;&#1084;&#1072;&#1096;&#1085;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"27"</span>))
    (<span style="color: #8b2252;">"&#1056;&#1072;&#1073;&#1086;&#1095;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"29"</span>))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13"><span class="section-number-3">4.13</span> Получение страниц</h3>
<div class="outline-text-3" id="text-4-13">
<p>
Так как мы хотим получать информацию, которая находится за авторизацией, нам нужно
обеспечить прозрачность авторизации, если ее в данный момент нет. <code>hh_login</code> решает эту
проблему.
</p>

<p>
Вот так мы можем получать страницы, к примеру те, на который находятся тизеры:
</p>
<ul class="org-ul">
<li>Получаем страницу
</li>
<li>Проверяем, залогинены ли мы
<ul class="org-ul">
<li>Если залогинены - отдаем страницу
</li>
<li>Если не залогинены - логинимся и получаем страницу снова.
<ul class="org-ul">
<li>Если во время логина произошла ошибка - сигнализируем условие.
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Есть также одна особенность (типа баг) в результате которой drakma неправильно
воспринимает сформированные в get-запросе параметры и говорит что URI malformed. Мы
обходим это с помощью глобального флага <code>*need-start*</code> что является временным решением.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_get_page">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;hh_login&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-get-page</span> (url)
  <span style="color: #8b2252;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;"</span>
  (<span style="color: #a020f0;">when</span> *need-start*
    (setf *need-start* nil)
    (set-start))
  (<span style="color: #a020f0;">labels</span> ((get-html-data (uri)
             (flexi-streams:octets-to-string
              (drakma:http-request url
                                   <span style="color: #483d8b;">:user-agent</span> *user-agent*
                                   <span style="color: #483d8b;">:additional-headers</span> (append *additional-headers* `((<span style="color: #8b2252;">"Cookie"</span>  . ,(make-cookies-string *cookies*))
                                                                                      (<span style="color: #8b2252;">"Referer"</span> . ,*referer*)))
                                   <span style="color: #483d8b;">:force-binary</span> t
                                   <span style="color: #483d8b;">:cookie-jar</span> *cookie-jar*)
              <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>)))
    (<span style="color: #a020f0;">let</span> ((html (get-html-data url)))
      (<span style="color: #a020f0;">when</span> (is-logged html)
        (setf *referer* url)
        (<span style="color: #a020f0;">return-from</span> hh-get-page html))
      (setf *cookies* (recovery-login))
      (hh-get-page url))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14"><span class="section-number-3">4.14</span> Логин на источник</h3>
<div class="outline-text-3" id="text-4-14">
<p>
Прежде чем мы получим возможность забирать авторизованную информацию с нашего источника,
нам нужно иметь способ залогиниться на него. В дополнение к этому мы должны отслеживать
момент потери авторизованной сесии и в каждый конкретный момент определять, залогинены ли
мы. Обычно это можно определить по наличию формы для логина на любой загружаемой
странице. Мы хотим в случае обрыва сессии перелогиниваться прозрачно для всего остального
кода, поэтому процедура логина должна вызвываться по необходимости из процедуры загрузки
любой страницы. Также важно обрабатывать ошибки, которые могут произойти при логине,
например, если неверен пароль, но это пока не делается.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_login">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(setf drakma:*header-stream* *standard-output*)</span>

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*user-agent*</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0"</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*additional-headers*</span> `((<span style="color: #8b2252;">"Accept"</span> . <span style="color: #8b2252;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
                                     (<span style="color: #8b2252;">"Accept-Language"</span> . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
                                     (<span style="color: #8b2252;">"Accept-Charset"</span> . <span style="color: #8b2252;">"utf-8"</span>)))

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*cookies*</span> nil)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*cookie-jar*</span> (make-instance 'drakma:cookie-jar))

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*referer*</span> <span style="color: #8b2252;">""</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*login-post*</span> `((<span style="color: #8b2252;">"username"</span> . <span style="color: #8b2252;">"avenger-f%40yandex.ru"</span>)
                             (<span style="color: #8b2252;">"password"</span> . <span style="color: #8b2252;">"jGwPswRAfU6sKEhVXX"</span>)
                             (<span style="color: #8b2252;">"backUrl"</span> . <span style="color: #8b2252;">"http%3A%2F%2Fspb.hh.ru%2F"</span>)
                             (<span style="color: #8b2252;">"remember"</span> . <span style="color: #8b2252;">"yes"</span>)
                             (<span style="color: #8b2252;">"action"</span> . <span style="color: #8b2252;">"%D0%92%D0%BE%D0%B9%D1%82%D0%B8"</span>)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">is-logged</span> (html)
  <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1084; &#1085;&#1072;&#1083;&#1080;&#1095;&#1080;&#1077; &#1074; html &#1073;&#1083;&#1086;&#1082;&#1072; '&#1042;&#1086;&#1081;&#1090;&#1080;'"</span>
  (not (contains html <span style="color: #8b2252;">"data-qa=\"mainmenu_loginForm\"&gt;&#1042;&#1086;&#1081;&#1090;&#1080;&lt;/div&gt;"</span>)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-cookies-alist</span> (cookie-jar)
  (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> cookie <span style="color: #483d8b;">:in</span> (drakma:cookie-jar-cookies cookie-jar) <span style="color: #483d8b;">:append</span>
     (list (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-post-string</span> (alist-param)
  (format nil <span style="color: #8b2252;">"~{~A~^&amp;~}"</span>
          (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"~A=~A"</span> (car x) (cdr x)))
                  alist-param)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-cookies-string</span> (alist-param)
  (format nil <span style="color: #8b2252;">"~{~A~^; ~}"</span>
          (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"~A=~A"</span> (car x) (cdr x)))
                  alist-param)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defun get-password-forms (tree)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1092;&#1086;&#1088;&#1084; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1097;&#1080;&#1093; input password"</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let* ((forms (let ((forms))</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(mtm (`("form" ,attrs ,@rest) (push `("form" ,attrs ,@rest) forms)) tree)</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(labels ((is-contains-password (x)</span>
<span style="color: #b22222;">;;                              </span><span style="color: #b22222;">(mtm (`("type" "password") (return-from is-contains-password t)) x)</span>
<span style="color: #b22222;">;;                              </span><span style="color: #b22222;">(return-from is-contains-password nil)))</span>
<span style="color: #b22222;">;;                     </span><span style="color: #b22222;">(remove-if-not #'is-contains-password forms)))))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(loop :for form :in forms :collect</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(let ((rs (list (cadr form))))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(mtm (`("input" ,attrs) (setf rs (append rs (list (let ((tmp (loop :for (key val) :in attrs :append (list (intern (string-upcase key) :keyword) val))))</span>
<span style="color: #b22222;">;;                                                              </span><span style="color: #b22222;">(list (getf tmp :name) (getf tmp :type) (getf tmp :value))))))) form)</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">rs))))</span>

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">remote-login</span> (xsrf cookies referer cookie-jar)
  (flexi-streams:octets-to-string
   (drakma:http-request <span style="color: #8b2252;">"https://spb.hh.ru/account/login"</span>
                        <span style="color: #483d8b;">:user-agent</span> *user-agent*
                        <span style="color: #483d8b;">:method</span> <span style="color: #483d8b;">:post</span>
                        <span style="color: #483d8b;">:content</span> (make-post-string (append *login-post*  `((<span style="color: #8b2252;">"_xsrf"</span> . ,xsrf))))
                        <span style="color: #483d8b;">:additional-headers</span> (append *additional-headers* `((<span style="color: #8b2252;">"Cookie"</span>  . ,(make-cookies-string cookies)) (<span style="color: #8b2252;">"Referer"</span> . ,*referer*)))
                        <span style="color: #483d8b;">:cookie-jar</span> cookie-jar
                        <span style="color: #483d8b;">:force-binary</span> t)
   <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">recovery-login</span> ()
  (<span style="color: #a020f0;">let*</span> ((start-uri <span style="color: #8b2252;">"http://spb.hh.ru/"</span>)
         (cookie-jar (make-instance 'drakma:cookie-jar))
         (additional-headers *additional-headers*)
         (tree (html5-parser:node-to-xmls
                (html5-parser:parse-html5-fragment
                 (flexi-streams:octets-to-string
                  (drakma:http-request start-uri <span style="color: #483d8b;">:user-agent</span> *user-agent* <span style="color: #483d8b;">:additional-headers</span> additional-headers <span style="color: #483d8b;">:force-binary</span> t <span style="color: #483d8b;">:cookie-jar</span> cookie-jar)
                  <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>))))
         (cookies (get-cookies-alist cookie-jar))
         (xsrf (cdr (assoc <span style="color: #8b2252;">"_xsrf"</span> cookies <span style="color: #483d8b;">:test</span> #'equal)))
         (html (remote-login xsrf cookies start-uri cookie-jar)))
    (get-cookies-alist cookie-jar)))

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*need-start*</span> t)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">set-start</span> ()
  (html5-parser:node-to-xmls
   (html5-parser:parse-html5-fragment
    (hh-get-page <span style="color: #8b2252;">"http://spb.hh.ru"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15"><span class="section-number-3">4.15</span> Разбор тизеров вакансий</h3>
<div class="outline-text-3" id="text-4-15">
<p>
Чтобы получить вакансии со страниц поисковой выдачи - воспользуемся парсером,
который переведет полученный html в более удобное лисп-дерево. Используя сопоставление с
образцом мы раз за разом преобразуем его до тех пор, пока там не остануться только
интересующие нас данные:
</p>
<ul class="org-ul">
<li>название вакансии
</li>
<li>идентификатор (ссылку)
</li>
<li>дата размещения
</li>
<li>название работодателя
</li>
<li>идентификатор работодателя
</li>
</ul>

<p>
Если в вакансии указана зарплата, мы также получаем
</p>
<ul class="org-ul">
<li>Валюту зарплаты (3х-буквенный идентификатор)
</li>
<li>Сумму
</li>
<li>Текстовое выражение, содержащее "от" или "от и до"
</li>
</ul>

<p>
Иногда HeadHunter синдицирует вакансии с других платформ, к примеру с CAREER.RU, тогда в
вакансии может отсутствовать работодатель.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy_teasers">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;maptree_transform&gt;&gt;

&lt;&lt;parse_salary&gt;&gt;

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*last-parse-data*</span> nil)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy-teasers</span> (html)
  <span style="color: #8b2252;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080;&#1079; html"</span>
  (setf *last-parse-data* html)
  (mapcar #'parse-salary
          (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result"</span>) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__results"</span>)) ,@rest) rest)
               (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"data-qa"</span> ,_) (<span style="color: #8b2252;">"class"</span> ,(or <span style="color: #8b2252;">"search-result-item search-result-item_premium  search-result-item_premium"</span>
                                                           <span style="color: #8b2252;">"search-result-item search-result-item_standard "</span>
                                                           <span style="color: #8b2252;">"search-result-item search-result-item_standard_plus "</span>))) ,@rest)
                      (<span style="color: #a020f0;">let</span> ((in (remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (or (equal x 'z) (equal x <span style="color: #8b2252;">"noindex"</span>) (equal x <span style="color: #8b2252;">"/noindex"</span>))) rest)))
                        (<span style="color: #a020f0;">if</span> (not (equal 1 (length in)))
                            (<span style="color: #a020f0;">progn</span> (print in)
                                   (err <span style="color: #8b2252;">"parsing failed, data printed"</span>))
                            (car in))))
                    (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"class"</span> _) (<span style="color: #8b2252;">"href"</span> _) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-interview-insider"</span>))
                                <span style="color: #8b2252;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>) 'Z)
                         (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__label search-result-item__label_invited"</span>)
                                      (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_invited"</span>)) <span style="color: #8b2252;">"&#1042;&#1099; &#1087;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1099;!"</span>) 'Z)
                              (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__label search-result-item__label_discard"</span>)
                                           (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_rejected"</span>)) <span style="color: #8b2252;">"&#1042;&#1072;&#1084; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;&#1080;"</span>) 'Z)
                                   (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__label search-result-item__label_discard"</span>)
                                                (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_rejected"</span>)) <span style="color: #8b2252;">"&#1042;&#1072;&#1084; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;&#1080;"</span>) 'Z)
                                        (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"title"</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1077;&#1084;&#1080;&#1103; HRBrand"</span>) (<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"rel"</span> <span style="color: #8b2252;">"nofollow"</span>)
                                                     (<span style="color: #8b2252;">"class"</span> ,_)
                                                     (<span style="color: #8b2252;">"data-qa"</span> ,_)) <span style="color: #8b2252;">"&#160;"</span>) 'Z)
                                             (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__image"</span>)) ,_) 'Z)
                                                  (mtm (`(<span style="color: #8b2252;">"script"</span> ((<span style="color: #8b2252;">"data-name"</span> <span style="color: #8b2252;">"HH/VacancyResponseTrigger"</span>) (<span style="color: #8b2252;">"data-params"</span> <span style="color: #8b2252;">""</span>))) 'Z)
                                                       (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> ,_)
                                                                    (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_responded"</span>)) <span style="color: #8b2252;">"&#1042;&#1099; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1083;&#1080;&#1089;&#1100;"</span>) 'Z)
                                                            (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__star"</span>)) ,@_) 'Z)
                                                                 (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__description"</span>)) ,@rest)
                                                                        (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item <span style="color: #483d8b;">:in</span> rest <span style="color: #483d8b;">:when</span> (consp item) <span style="color: #483d8b;">:append</span> item))
                                                                      (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__head"</span>))
                                                                                    (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"class"</span> ,(or <span style="color: #8b2252;">"search-result-item__name search-result-item__name_standard"</span>
                                                                                                        <span style="color: #8b2252;">"search-result-item__name search-result-item__name_standard_plus"</span>
                                                                                                        <span style="color: #8b2252;">"search-result-item__name search-result-item__name_premium"</span>))
                                                                                          (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-title"</span>) (<span style="color: #8b2252;">"href"</span> ,id) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>)) ,name))
                                                                             (list <span style="color: #483d8b;">:id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ id)))) <span style="color: #483d8b;">:name</span> name))
                                                                           (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"interview-insider__link                   m-interview-insider__link-searchresult"</span>)
                                                                                        (<span style="color: #8b2252;">"href"</span> ,href)
                                                                                        (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-interview-insider"</span>))
                                                                                       <span style="color: #8b2252;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>)
                                                                                  (list <span style="color: #483d8b;">:interview</span> href))
                                                                                (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-list-salary"</span>) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-compensation"</span>))
                                                                                              (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"salaryCurrency"</span>) (<span style="color: #8b2252;">"content"</span> ,currency)))
                                                                                              (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"baseSalary"</span>) (<span style="color: #8b2252;">"content"</span> ,salary))) ,salary-text)
                                                                                       (list <span style="color: #483d8b;">:currency</span> currency <span style="color: #483d8b;">:salary</span> (parse-integer salary) <span style="color: #483d8b;">:salary-text</span> salary-text))
                                                                                     (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company"</span>)) ,emp-name)
                                                                                            (list <span style="color: #483d8b;">:emp-name</span> emp-name))
                                                                                          (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company"</span>))
                                                                                                        (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,emp-id)
                                                                                                              (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company-link"</span>)
                                                                                                              (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-employer"</span>))
                                                                                                             ,emp-name))
                                                                                                 (list <span style="color: #483d8b;">:emp-id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ emp-id)))
                                                                                                                              <span style="color: #483d8b;">:junk-allowed</span> t)
                                                                                                       <span style="color: #483d8b;">:emp-name</span> emp-name))
                                                                                               (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__info"</span>)) ,@rest)
                                                                                                      (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item <span style="color: #483d8b;">:in</span> rest <span style="color: #483d8b;">:when</span> (consp item) <span style="color: #483d8b;">:append</span> item))
                                                                                                    (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"searchresult__address"</span>)
                                                                                                                    (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-address"</span>)) ,city ,@rest)
                                                                                                           (<span style="color: #a020f0;">let</span> ((metro (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item in rest <span style="color: #483d8b;">:do</span>
                                                                                                                           (<span style="color: #a020f0;">when</span> (and (consp item) (equal <span style="color: #483d8b;">:metro</span> (car item)))
                                                                                                                             (<span style="color: #a020f0;">return</span> (cadr item))))))
                                                                                                             (list <span style="color: #483d8b;">:city</span> city <span style="color: #483d8b;">:metro</span> metro)))
                                                                                                         (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"metro-station"</span>))
                                                                                                                        (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"metro-point"</span>) (<span style="color: #8b2252;">"style"</span> ,_))) ,metro)
                                                                                                                (list <span style="color: #483d8b;">:metro</span> metro))
                                                                                                              (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-list-date"</span>)
                                                                                                                              (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-date"</span>)) ,date)
                                                                                                                     (list <span style="color: #483d8b;">:date</span> date))
                                                                                                                   (mtm (`(<span style="color: #8b2252;">"span"</span>
                                                                                                                           ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"vacancy-list-platform"</span>)
                                                                                                                            (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_career"</span>))
                                                                                                                           <span style="color: #8b2252;">"&#160;&#160;&#8226;&#160;&#160;"</span> (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"vacancy-list-platform__name"</span>))
                                                                                                                                           <span style="color: #8b2252;">"CAREER.RU"</span>))
                                                                                                                          (list <span style="color: #483d8b;">:platform</span> 'career.ru))
                                                                                                                        (<span style="color: #a020f0;">block</span> subtree-extract
                                                                                                                          (mtm (`(<span style="color: #8b2252;">"div"</span>
                                                                                                                                  ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result"</span>)
                                                                                                                                   (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__results"</span>))
                                                                                                                                  ,@rest)
                                                                                                                                 (<span style="color: #a020f0;">return-from</span> subtree-extract rest))
                                                                                                                               (html5-parser:node-to-xmls
                                                                                                                                (html5-parser:parse-html5-fragment html))))))))))))))))))))))))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(hh-parse-vacancy-teasers</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-get-page "http://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;salary=&amp;currency_code=RUR&amp;only_with_salary=true&amp;experience=doesNotMatter&amp;order_by=salary_desc&amp;search_period=30&amp;items_on_page=100&amp;no_magic=true"))</span>
</pre>
</div>
</div>

<div id="outline-container-sec-4-15-1" class="outline-4">
<h4 id="sec-4-15-1"><span class="section-number-4">4.15.1</span> Трансформация дерева</h4>
<div class="outline-text-4" id="text-4-15-1">
<div class="org-src-container">

<pre class="src src-lisp" id="maptree_transform">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1069;&#1090;&#1086; &#1072;&#1085;&#1072;&#1083;&#1086;&#1075; maptree-if, &#1085;&#1086; &#1079;&#1076;&#1077;&#1089;&#1100; &#1086;&#1076;&#1085;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1080; &#1080;&#1097;&#1077;&#1090; &#1080; &#1090;&#1088;&#1072;&#1085;&#1089;&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1090; &#1091;&#1079;&#1077;&#1083; &#1076;&#1077;&#1088;&#1077;&#1074;&#1072;</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree</span> (predicate-transformer tree)
  (<span style="color: #a020f0;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #a020f0;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #a020f0;">lambda</span> (x)
                     (maptree predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">maptree-transformer - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree</span>
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">mtm</span> (transformer tree)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `(maptree #'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
                  (values (match ,lambda-param ,transformer)
                          #'mapcar))
              ,tree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-15-2" class="outline-4">
<h4 id="sec-4-15-2"><span class="section-number-4">4.15.2</span> Определение минимальной и максимальной зарплаты</h4>
<div class="outline-text-4" id="text-4-15-2">
<div class="org-src-container">

<pre class="src src-lisp" id="parse_salary">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">parse-salary</span> (vacancy)
  (<span style="color: #a020f0;">let</span> ((currency (getf vacancy <span style="color: #483d8b;">:CURRENCY</span>))
        (salary-text (ppcre:regex-replace-all <span style="color: #8b2252;">"&#160;"</span> (getf vacancy <span style="color: #483d8b;">:salary-text</span>) <span style="color: #8b2252;">""</span>))
        (salary-min nil)
        (salary-max nil))
    (<span style="color: #a020f0;">cond</span> ((equal currency <span style="color: #8b2252;">"RUR"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #8b2252;">" &#1088;&#1091;&#1073;."</span> salary-text <span style="color: #8b2252;">""</span>)))
          ((equal currency <span style="color: #8b2252;">"USD"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #8b2252;">" USD"</span> salary-text <span style="color: #8b2252;">""</span>)))
          ((equal currency <span style="color: #8b2252;">"EUR"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #8b2252;">" EUR"</span> salary-text <span style="color: #8b2252;">""</span>)))
          ((equal currency nil)
           'nil)
          (t (<span style="color: #a020f0;">progn</span>
               (print (getf vacancy <span style="color: #483d8b;">:currency</span>))
               (err 'unk-currency))))
    (<span style="color: #a020f0;">cond</span> ((search <span style="color: #8b2252;">"&#1086;&#1090; "</span> salary-text)
           (setf salary-min (parse-integer (ppcre:regex-replace-all <span style="color: #8b2252;">"&#1086;&#1090; "</span> salary-text <span style="color: #8b2252;">""</span>))))
          ((search <span style="color: #8b2252;">"&#1076;&#1086; "</span> salary-text)
           (setf salary-max (parse-integer (ppcre:regex-replace-all <span style="color: #8b2252;">"&#1076;&#1086; "</span> salary-text <span style="color: #8b2252;">""</span>))))
          ((search <span style="color: #8b2252;">"&#8211;"</span> salary-text)
           (<span style="color: #a020f0;">let</span> ((splt (ppcre:split <span style="color: #8b2252;">"&#8211;"</span> salary-text)))
             (setf salary-min (parse-integer (car splt)))
             (setf salary-max (parse-integer (cadr splt)))))
          ((search <span style="color: #8b2252;">"-"</span> salary-text)
           (<span style="color: #a020f0;">let</span> ((splt (ppcre:split <span style="color: #8b2252;">"-"</span> salary-text)))
             (setf salary-min (parse-integer (car splt)))
             (setf salary-max (parse-integer (cadr splt))))))
    (<span style="color: #a020f0;">when</span> (null salary-min)
      (setf salary-min salary-max))
    (<span style="color: #a020f0;">when</span> (null salary-max)
      (setf salary-max salary-min))
    (setf (getf vacancy <span style="color: #483d8b;">:salary-min</span>) salary-min)
    (setf (getf vacancy <span style="color: #483d8b;">:salary-max</span>) salary-max)
    vacancy))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(hh-parse-vacancy-teasers</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-get-page "http://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;salary=&amp;currency_code=RUR&amp;only_with_salary=true&amp;experience=doesNotMatter&amp;order_by=salary_desc&amp;search_period=30&amp;items_on_page=100&amp;no_magic=true"))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16"><span class="section-number-3">4.16</span> Разбор вакансий</h3>
<div class="outline-text-3" id="text-4-16">
<p>
Теперь, можно написать функцию, которая трансформирует описание, очищая его от всего
лишнего:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="transform_description">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">transform-description</span> (tree-descr)
  (<span style="color: #a020f0;">labels</span> ((rem-space (tree)
             (<span style="color: #a020f0;">cond</span> ((consp tree) (cons (rem-space (car tree))
                                       (rem-space (remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (equal x <span style="color: #8b2252;">" "</span>))
                                                             (cdr tree)))))
                   (t tree))))
    (append `((<span style="color: #483d8b;">:p</span>))
            (mtm (`(<span style="color: #8b2252;">"p"</span> nil ,@in) `((<span style="color: #483d8b;">:p</span>) ,@in))
                 (mtm (`(<span style="color: #8b2252;">"ul"</span> nil ,@in) `((<span style="color: #483d8b;">:ul</span>) ,@in))
                      (mtm (`(<span style="color: #8b2252;">"li"</span> nil ,@in) `((<span style="color: #483d8b;">:li</span>) ,@in))
                           (mtm (`(<span style="color: #8b2252;">"em"</span> nil ,@in) `((<span style="color: #483d8b;">:b</span>) ,@in))
                                (mtm (`(<span style="color: #8b2252;">"strong"</span> nil ,@in) `((<span style="color: #483d8b;">:b</span>) ,@in))
                                     (mtm (`(<span style="color: #8b2252;">"br"</span>) `((<span style="color: #483d8b;">:br</span>)))
                                          (rem-space tree-descr))))))))))
</pre>
</div>

<p>
И, наконец, применим все что мы подготовили, чтобы разобрать вакансию:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;transform_description&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy</span> (html)
  (<span style="color: #a020f0;">let*</span> ((tree (html5-parser:node-to-xmls (html5-parser:parse-html5-fragment html))))
    (append (<span style="color: #a020f0;">block</span> header-extract
              (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>)) (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> ,_)))
                            (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) ,name ,@archive) ,@rest)
                     (<span style="color: #a020f0;">return-from</span> header-extract
                       (append (list <span style="color: #483d8b;">:name</span> name <span style="color: #483d8b;">:archive</span> (<span style="color: #a020f0;">if</span> archive t nil))
                               (<span style="color: #a020f0;">block</span> emp-block (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"companyname"</span>)) (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"hiringOrganization"</span>) (<span style="color: #8b2252;">"href"</span> ,emp-lnk)) ,emp-name))
                                                       (<span style="color: #a020f0;">return-from</span> emp-block
                                                         (list <span style="color: #483d8b;">:emp-id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ emp-lnk))) <span style="color: #483d8b;">:junk-allowed</span> t)
                                                               <span style="color: #483d8b;">:emp-name</span> emp-name))) rest)))))
                   tree))
            (<span style="color: #a020f0;">let</span> ((salary-result (<span style="color: #a020f0;">block</span> salary-extract
                                   (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>))
                                                 (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"salaryCurrency"</span>) (<span style="color: #8b2252;">"content"</span> ,currency)))
                                                 (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"baseSalary"</span>) (<span style="color: #8b2252;">"content"</span> ,base-salary)))
                                                 ,salary-text)
                                          (<span style="color: #a020f0;">return-from</span> salary-extract (list <span style="color: #483d8b;">:currency</span> currency <span style="color: #483d8b;">:base-salary</span> (parse-integer base-salary) <span style="color: #483d8b;">:salary-text</span> salary-text)))
                                        tree))))
              (<span style="color: #a020f0;">if</span> (equal 6 (length salary-result))
                  salary-result
                  (list <span style="color: #483d8b;">:currency</span> nil <span style="color: #483d8b;">:base-salary</span> nil <span style="color: #483d8b;">:salary-text</span> nil)))
            (<span style="color: #a020f0;">let</span> ((city-result (<span style="color: #a020f0;">block</span> city-extract (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-content-colum-2 b-v-info-content"</span>)) (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>)) ,city))
                                                          (<span style="color: #a020f0;">return-from</span> city-extract (list <span style="color: #483d8b;">:city</span> city))) tree))))
              (<span style="color: #a020f0;">if</span> (equal 2 (length city-result)) city-result (list <span style="color: #483d8b;">:city</span> nil)))
            (<span style="color: #a020f0;">let</span> ((exp-result (<span style="color: #a020f0;">block</span> exp-extract (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-content-colum-3 b-v-info-content"</span>))
                                                              (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>) (<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"experienceRequirements"</span>)) ,exp))
                                                        (<span style="color: #a020f0;">return-from</span> exp-extract (list <span style="color: #483d8b;">:exp</span> exp))) tree))))
              (<span style="color: #a020f0;">if</span> (equal 2 (length exp-result)) exp-result (list <span style="color: #483d8b;">:exp</span> nil)))
            (<span style="color: #a020f0;">let</span> ((respond-result (<span style="color: #a020f0;">block</span> respond-extract (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"g-attention m-attention_good b-vacancy-message"</span>))
                                                                       <span style="color: #8b2252;">"&#1042;&#1099; &#1091;&#1078;&#1077; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1072;&#1083;&#1080;&#1089;&#1100; &#1085;&#1072; &#1101;&#1090;&#1091; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102;. "</span>
                                                                       (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,resp)) <span style="color: #8b2252;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1080;."</span>))
                                                                (<span style="color: #a020f0;">return-from</span> respond-extract (list <span style="color: #483d8b;">:respond</span> resp))) tree))))
              (<span style="color: #a020f0;">if</span> (equal 2 (length respond-result)) respond-result (list <span style="color: #483d8b;">:respond</span> nil)))
            (<span style="color: #a020f0;">block</span> descr-extract
              (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-desc-wrapper"</span>) (<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"description"</span>)) ,@descr)
                     (<span style="color: #a020f0;">return-from</span> descr-extract (list <span style="color: #483d8b;">:descr</span> (transform-description descr)))) tree)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-parse-vacancy (hh-get-page "http://spb.hh.ru/vacancy/12561525")))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-parse-vacancy (hh-get-page  "http://spb.hh.ru/vacancy/12091953")))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17"><span class="section-number-3">4.17</span> Сохранение вакансии и ее структура данных</h3>
<div class="outline-text-3" id="text-4-17">
<p>
Опишем структуру данных вакансии:
</p>

<table id="vacancy_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Данные вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">src-id</td>
<td class="left">integer</td>
<td class="left">идентификатор вакансии в источнике</td>
</tr>

<tr>
<td class="left">archive</td>
<td class="left">boolean</td>
<td class="left">призак, что вакансия в архиве</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название вакансии</td>
</tr>

<tr>
<td class="left">currency</td>
<td class="left">(or db-null varchar)</td>
<td class="left">валюта зарплаты</td>
</tr>

<tr>
<td class="left">base-salary</td>
<td class="left">(or db-null integer)</td>
<td class="left">размер компенсации в тизере</td>
</tr>

<tr>
<td class="left">salary</td>
<td class="left">(or db-null integer)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">salary-text</td>
<td class="left">(or db-null varchar)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">salary-max</td>
<td class="left">(or db-null integer)</td>
<td class="left">максимальный уровень зарплаты</td>
</tr>

<tr>
<td class="left">salary-min</td>
<td class="left">(or db-null integer)</td>
<td class="left">минимальный уровень зарплаты</td>
</tr>

<tr>
<td class="left">emp-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">emp-name</td>
<td class="left">varchar</td>
<td class="left">имя работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">city</td>
<td class="left">varchar</td>
<td class="left">город</td>
</tr>

<tr>
<td class="left">metro</td>
<td class="left">varchar</td>
<td class="left">метро</td>
</tr>

<tr>
<td class="left">experience</td>
<td class="left">varchar</td>
<td class="left">требуемый опыт работы</td>
</tr>

<tr>
<td class="left">date</td>
<td class="left">varchar</td>
<td class="left">дата опубликования в источнике</td>
</tr>

<tr>
<td class="left">respond</td>
<td class="left">varchar</td>
<td class="left">ссылка на отклик</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">varchar</td>
<td class="left">описание вакансии</td>
</tr>

<tr>
<td class="left">notes</td>
<td class="left">(or db-null varchar)</td>
<td class="left">заметки по вакансии</td>
</tr>

<tr>
<td class="left">response</td>
<td class="left">(or db-null varchar)</td>
<td class="left">текст отклика на вакансию</td>
</tr>
</tbody>
</table>

<p>
Напишем процедуру сохранения вакансии в базу данных
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="save_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*saved-vacancy*</span> nil)

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">save-vacancy</span> (vacancy)
  (setf *saved-vacancy*
        (append *saved-vacancy*
                (list (make-vacancy
                       <span style="color: #483d8b;">:src-id</span> (getf vacancy <span style="color: #483d8b;">:id</span>)
                       <span style="color: #483d8b;">:name</span> (getf vacancy <span style="color: #483d8b;">:name</span>)
                       <span style="color: #483d8b;">:currency</span> (getf vacancy <span style="color: #483d8b;">:currency</span>)
                       <span style="color: #483d8b;">:salary</span> (aif (getf vacancy <span style="color: #483d8b;">:salary</span>) it 0)
                       <span style="color: #483d8b;">:base-salary</span> (aif (getf vacancy <span style="color: #483d8b;">:base-salary</span>) it 0)
                       <span style="color: #483d8b;">:salary-text</span> (getf vacancy <span style="color: #483d8b;">:salary-text</span>)
                       <span style="color: #483d8b;">:salary-max</span> (getf vacancy <span style="color: #483d8b;">:salary-max</span>)
                       <span style="color: #483d8b;">:salary-min</span> (getf vacancy <span style="color: #483d8b;">:salary-min</span>)
                       <span style="color: #483d8b;">:emp-id</span> (aif (getf vacancy <span style="color: #483d8b;">:emp-id</span>) it 0)
                       <span style="color: #483d8b;">:emp-name</span> (getf vacancy <span style="color: #483d8b;">:emp-name</span>)
                       <span style="color: #483d8b;">:city</span> (getf vacancy <span style="color: #483d8b;">:city</span>)
                       <span style="color: #483d8b;">:metro</span> (getf vacancy <span style="color: #483d8b;">:metro</span>)
                       <span style="color: #483d8b;">:experience</span> (getf vacancy <span style="color: #483d8b;">:exp</span>)
                       <span style="color: #483d8b;">:archive</span> (getf vacancy <span style="color: #483d8b;">:archive</span>)
                       <span style="color: #483d8b;">:date</span> (getf vacancy <span style="color: #483d8b;">:date</span>)
                       <span style="color: #483d8b;">:respond</span> (aif (getf vacancy <span style="color: #483d8b;">:respond</span>) it <span style="color: #8b2252;">""</span>)
                       <span style="color: #483d8b;">:state</span> (<span style="color: #a020f0;">if</span> (getf vacancy <span style="color: #483d8b;">:respond</span>) <span style="color: #8b2252;">":RESPONDED"</span> <span style="color: #8b2252;">":UNSORT"</span>)
                       <span style="color: #483d8b;">:descr</span> (bprint (getf vacancy <span style="color: #483d8b;">:descr</span>))
                       <span style="color: #483d8b;">:notes</span> <span style="color: #8b2252;">""</span>
                       <span style="color: #483d8b;">:response</span> <span style="color: #8b2252;">"&#1047;&#1076;&#1088;&#1072;&#1074;&#1089;&#1090;&#1074;&#1091;&#1081;&#1090;&#1077;, &#1103; &#1087;&#1086;&#1076;&#1093;&#1086;&#1078;&#1091; &#1087;&#1086;&#1076; &#1074;&#1072;&#1096;&#1080; &#1090;&#1088;&#1077;&#1073;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;. &#1050;&#1086;&#1075;&#1076;&#1072; &#1084;&#1086;&#1078;&#1085;&#1086; &#1076;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088;&#1080;&#1090;&#1100;&#1089;&#1103; &#1086; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080;? &#1052;&#1080;&#1093;&#1072;&#1080;&#1083; 8(911)286-92-90"</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-18" class="outline-3">
<h3 id="sec-4-18"><span class="section-number-3">4.18</span> Состояния вакансий</h3>
<div class="outline-text-3" id="text-4-18">
<p>
После загрузки, вакансия получает статус <code>unsort</code>
</p>

<p>
После сортировки пользователем ваканисия может принять один из статусов: <code>unsort</code>,
<code>interesting</code> или <code>uninteresting</code>
</p>

<p>
Пользователь, работая с этими интересными вакансиями, отслеживает их состояния, выполняя
действия, переводящие вакансию из одного состояния в другое: когда пользователь
отправляет отзыв - вакансия становится <code>responded</code>.
</p>

<table id="vacancy_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Состояния конечного автомата вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">uns-uni</td>
<td class="left">unsort</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">uns-int</td>
<td class="left">unsort</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">uns-res</td>
<td class="left">unsort</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">uni-int</td>
<td class="left">uninteresting</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">uni-res</td>
<td class="left">uninteresting</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">uni-uni</td>
<td class="left">uninteresting</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-uni</td>
<td class="left">interesting</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-res</td>
<td class="left">interesting</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">int-int</td>
<td class="left">interesting</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">res-bee</td>
<td class="left">responded</td>
<td class="left">beenviewed</td>
</tr>

<tr>
<td class="left">res-uni</td>
<td class="left">responded</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">res-rej</td>
<td class="left">responded</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">res-inv</td>
<td class="left">responded</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">res-res</td>
<td class="left">responded</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">bee-uni</td>
<td class="left">beenviewed</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">bee-rej</td>
<td class="left">beenviewed</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">bee-inv</td>
<td class="left">beenviewed</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">bee-bee</td>
<td class="left">beenviewed</td>
<td class="left">beenviewed</td>
</tr>

<tr>
<td class="left">rej-res</td>
<td class="left">reject</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">rej-uni</td>
<td class="left">reject</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">rej-rej</td>
<td class="left">reject</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">inv-inv</td>
<td class="left">invite</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">inv-uni</td>
<td class="left">invite</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">inv-int</td>
<td class="left">invite</td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">int-uni</td>
<td class="left">interview</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-int</td>
<td class="left">interview</td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">int-dis</td>
<td class="left">interview</td>
<td class="left">discard</td>
</tr>

<tr>
<td class="left">dis-uni</td>
<td class="left">discard</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">dis-dis</td>
<td class="left">discard</td>
<td class="left">discard</td>
</tr>

<tr>
<td class="left">int-off</td>
<td class="left">interview</td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">off-uni</td>
<td class="left">offer</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">off-off</td>
<td class="left">offer</td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">off-onj</td>
<td class="left">offer</td>
<td class="left">accept</td>
</tr>

<tr>
<td class="left">acc-acc</td>
<td class="left">accept</td>
<td class="left">accept</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение вакансии как конечный автомат:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="vacancy_state_graph">(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
            (princ (format <span style="color: #8b2252;">"%s -&gt; %s [label =\"%s\"];\n"</span>
                           (second x) (third x) (first x))))
        table)
</pre>
</div>


<div class="figure">
<p><img src="img/vacancy-state.png" alt="vacancy-state.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uns-uni</span> ()
  <span style="color: #8b2252;">"| unsort        | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uns-int</span> ()
  <span style="color: #8b2252;">"| unsort        | interesting   |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uns-res</span> ()
  <span style="color: #8b2252;">"| unsort        | responded     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uni-int</span> ()
  <span style="color: #8b2252;">"| uninteresting | interesting   |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uni-res</span> ()
  <span style="color: #8b2252;">"| uninteresting | responded     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">uni-uni</span> ()
  <span style="color: #8b2252;">"| uninteresting | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-uni</span> ()
  <span style="color: #8b2252;">"| interesting   | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-res</span> ()
  <span style="color: #8b2252;">"| interesting   | responded     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-int</span> ()
  <span style="color: #8b2252;">"| interesting   | interesting   |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">res-bee</span> ()
  <span style="color: #8b2252;">"| responded     | beenviewed    |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">res-uni</span> ()
  <span style="color: #8b2252;">"| responded     | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">res-rej</span> ()
  <span style="color: #8b2252;">"| responded     | reject        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">res-inv</span> ()
  <span style="color: #8b2252;">"| responded     | invite        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">res-res</span> ()
  <span style="color: #8b2252;">"| responded     | responded     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">bee-uni</span> ()
  <span style="color: #8b2252;">"| beenviewed    | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">bee-rej</span> ()
  <span style="color: #8b2252;">"| beenviewed    | reject        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">bee-inv</span> ()
  <span style="color: #8b2252;">"| beenviewed    | invite        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">bee-bee</span> ()
  <span style="color: #8b2252;">"| beenviewed    | beenviewed    |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rej-res</span> ()
  <span style="color: #8b2252;">"| reject        | responded     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rej-uni</span> ()
  <span style="color: #8b2252;">"| reject        | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rej-rej</span> ()
  <span style="color: #8b2252;">"| reject        | reject        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">inv-inv</span> ()
  <span style="color: #8b2252;">"| invite        | invite        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">inv-uni</span> ()
  <span style="color: #8b2252;">"| invite        | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">inv-int</span> ()
  <span style="color: #8b2252;">"| invite        | interview     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-uni</span> ()
  <span style="color: #8b2252;">"| interview     | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-int</span> ()
  <span style="color: #8b2252;">"| interview     | interview     |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-dis</span> ()
  <span style="color: #8b2252;">"| interview     | discard       |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">dis-uni</span> ()
  <span style="color: #8b2252;">"| discard       | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">dis-dis</span> ()
  <span style="color: #8b2252;">"| discard       | discard       |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">int-off</span> ()
  <span style="color: #8b2252;">"| interview     | offer         |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">off-uni</span> ()
  <span style="color: #8b2252;">"| offer         | uninteresting |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">off-off</span> ()
  <span style="color: #8b2252;">"| offer         | offer         |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">off-onj</span> ()
  <span style="color: #8b2252;">"| offer         | accept        |"</span>)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">acc-acc</span> ()
  <span style="color: #8b2252;">"| accept        | accept        |"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-19" class="outline-3">
<h3 id="sec-4-19"><span class="section-number-3">4.19</span> Печать вакансий</h3>
<div class="outline-text-3" id="text-4-19">
<p>
Пока у нас нет веб-интерфейса мы будем выводить вакансии в консоль
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="show_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">show-vacancy</span> (vacancy)
  (format t <span style="color: #8b2252;">"~%"</span>)
  (format t <span style="color: #8b2252;">"~%~A :~A: ~A [~A]"</span>
       (getf vacancy <span style="color: #483d8b;">:salary-text</span>)
       (getf vacancy <span style="color: #483d8b;">:currency</span>)
       (getf vacancy <span style="color: #483d8b;">:name</span>)
       (getf vacancy <span style="color: #483d8b;">:id</span>))
  (format t <span style="color: #8b2252;">"~%~A"</span> (getf vacancy <span style="color: #483d8b;">:emp-name</span>))
  (format t <span style="color: #8b2252;">"~A"</span> (show-descr (getf vacancy <span style="color: #483d8b;">:descr</span>))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">show-descr</span> (tree)
  (<span style="color: #a020f0;">let</span> ((output (make-string-output-stream))
        (indent 2)
        (prefix <span style="color: #8b2252;">""</span>))
    (<span style="color: #a020f0;">labels</span> ((out (format tree)
               (format output <span style="color: #8b2252;">"~A~A"</span> (make-string indent <span style="color: #483d8b;">:initial-element</span> #\Space)
                       (format nil format tree)))
             (rec (tree)
               (<span style="color: #a020f0;">cond</span> ((consp tree) (<span style="color: #a020f0;">cond</span> ((and (equal 2 (length tree))
                                               (equal <span style="color: #483d8b;">:L</span> (car tree))
                                               (stringp (cadr tree))) (<span style="color: #a020f0;">prog1</span> nil
                                                                        (format output <span style="color: #8b2252;">"~A-&gt; ~A~%"</span> prefix (cadr tree))))
                                         ((equal <span style="color: #483d8b;">:U</span> (car tree)) (<span style="color: #a020f0;">prog1</span> nil
                                                                  (setf prefix (concatenate 'string (make-string indent <span style="color: #483d8b;">:initial-element</span> #\Space) prefix))
                                                                  (rec (cdr tree))
                                                                  (setf prefix (subseq prefix indent))))
                                         ((and (equal 2 (length tree))
                                               (equal <span style="color: #483d8b;">:B</span> (car tree))
                                               (stringp (cadr tree))) (format output <span style="color: #8b2252;">"~A[~A]~%"</span> prefix (cadr tree)))
                                         (t (cons (rec (car tree))
                                                  (rec (cdr tree))))))
                     (t (<span style="color: #a020f0;">cond</span> ((stringp tree) (format output <span style="color: #8b2252;">"~A~A~%"</span> prefix tree)))))))
      (rec tree))
    (get-output-stream-string output)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-20" class="outline-3">
<h3 id="sec-4-20"><span class="section-number-3">4.20</span> Резюме соискателя</h3>
<div class="outline-text-3" id="text-4-20">
<p>
Иногда у одного соискателя может быть несколько резюме. Опишем структуру данных резюме:
</p>

<table id="resume_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Данные резюме</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">src-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор страницы резюме на hh.ru</td>
</tr>

<tr>
<td class="left">res-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор резюме на hh.ru</td>
</tr>

<tr>
<td class="left">title</td>
<td class="left">varchar</td>
<td class="left">заголовок резюме</td>
</tr>
</tbody>
</table>

<p>
Резюме может быть активным или неактивным:
</p>

<table id="resume_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Состояния конечного автомата вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">rai</td>
<td class="left">active</td>
<td class="left">inactive</td>
</tr>

<tr>
<td class="left">ria</td>
<td class="left">inactive</td>
<td class="left">active</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение резюме как конечный автомат:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="resume_state_graph">(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
            (princ (format <span style="color: #8b2252;">"%s -&gt; %s [label =\"%s\"];\n"</span>
                           (second x) (third x) (first x))))
        table)
</pre>
</div>


<div class="figure">
<p><img src="img/resume-state.png" alt="resume-state.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rai</span> ()
  <span style="color: #8b2252;">"active-inactive"</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">ria</span> ()
  <span style="color: #8b2252;">"inactive-active"</span>)
</pre>
</div>

<p>
Создадим резюме, связав их с резюме на hh:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(make-resume
 <span style="color: #483d8b;">:src-id</span> <span style="color: #8b2252;">"1036680cff007465bc0039ed1f736563726574"</span>
 <span style="color: #483d8b;">:title</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090; (web) / &#1056;&#1091;&#1082;&#1086;&#1074;&#1086;&#1076;&#1080;&#1090;&#1077;&#1083;&#1100; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;"</span>
 <span style="color: #483d8b;">:res-id</span> <span style="color: #8b2252;">"7628220"</span>
 <span style="color: #483d8b;">:state</span> <span style="color: #8b2252;">":ACTIVE"</span>)

 (make-resume
  <span style="color: #483d8b;">:src-id</span> <span style="color: #8b2252;">"9555a7ecff02588d3c0039ed1f454162305732"</span>
  <span style="color: #483d8b;">:title</span> <span style="color: #8b2252;">"Senior Developer"</span>
  <span style="color: #483d8b;">:res-id</span> <span style="color: #8b2252;">"39357756"</span>
  <span style="color: #483d8b;">:state</span> <span style="color: #8b2252;">":ACTIVE"</span>)

(make-resume
 <span style="color: #483d8b;">:src-id</span> <span style="color: #8b2252;">"2a016741ff01fbb5880039ed1f466b6e573358"</span>
 <span style="color: #483d8b;">:title</span> <span style="color: #8b2252;">"Lisp-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>
 <span style="color: #483d8b;">:res-id</span> <span style="color: #8b2252;">"33273224"</span>
 <span style="color: #483d8b;">:state</span> <span style="color: #8b2252;">":ACTIVE"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-21" class="outline-3">
<h3 id="sec-4-21"><span class="section-number-3">4.21</span> Отправка отклика</h3>
<div class="outline-text-3" id="text-4-21">
<div class="org-src-container">

<pre class="src src-lisp" id="send_respond">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-additional-headers</span> (referer cookies)
    `((<span style="color: #8b2252;">"Accept"</span>           . <span style="color: #8b2252;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
      (<span style="color: #8b2252;">"Accept-Language"</span>  . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
      (<span style="color: #8b2252;">"Accept-Charset"</span>   . <span style="color: #8b2252;">"utf-8"</span>)
      (<span style="color: #8b2252;">"Referer"</span>          . ,referer)
      (<span style="color: #8b2252;">"Cache-Control"</span>    . <span style="color: #8b2252;">"no-cache"</span>)
      (<span style="color: #8b2252;">"Cookie"</span>           . ,(format nil <span style="color: #8b2252;">"~{~{~A=~A~}~^; ~}"</span> cookies))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">send-respond</span> (vacancy-id resume-id letter)
  (<span style="color: #a020f0;">let*</span> ((hhtoken     (cdr (assoc <span style="color: #8b2252;">"hhtoken"</span> *cookies* <span style="color: #483d8b;">:test</span> #'equal)))
         (hhuid       (cdr (assoc <span style="color: #8b2252;">"hhuid"</span> *cookies* <span style="color: #483d8b;">:test</span> #'equal)))
         (xsrf        (cdr (assoc <span style="color: #8b2252;">"_xsrf"</span> *cookies* <span style="color: #483d8b;">:test</span> #'equal)))
         (hhrole      <span style="color: #8b2252;">"applicant"</span>)
         (crypted-id  <span style="color: #8b2252;">"2B9E046016B13C9E701CAC5A276D51C8A5471C6F722104504734B32F0D03E9F8"</span>)
         (cookie-jar (make-instance 'drakma:cookie-jar))
         (html (flexi-streams:octets-to-string
                (drakma:http-request
                 (format nil <span style="color: #8b2252;">"http://spb.hh.ru/vacancy/~A"</span> vacancy-id)
                 <span style="color: #483d8b;">:user-agent</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:34.0) Gecko/20100101 Firefox/34.0"</span>
                 <span style="color: #483d8b;">:additional-headers</span> (make-additional-headers <span style="color: #8b2252;">"http://spb.hh.ru/"</span>
                                                              `((<span style="color: #8b2252;">"redirect_host"</span>       <span style="color: #8b2252;">"spb.hh.ru"</span>)  (<span style="color: #8b2252;">"regions"</span>             <span style="color: #8b2252;">"2"</span>)        (<span style="color: #8b2252;">"_xsrf"</span>               ,xsrf)
                                                                (<span style="color: #8b2252;">"hhtoken"</span>             ,hhtoken)     (<span style="color: #8b2252;">"hhuid"</span>               ,hhuid)     (<span style="color: #8b2252;">"hhrole"</span>              ,hhrole)
                                                                (<span style="color: #8b2252;">"GMT"</span>                 <span style="color: #8b2252;">"3"</span>)          (<span style="color: #8b2252;">"display"</span>             <span style="color: #8b2252;">"desktop"</span>)))
                 <span style="color: #483d8b;">:cookie-jar</span> cookie-jar <span style="color: #483d8b;">:force-binary</span> t)
                <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>))
         (cookie-data (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> cookie <span style="color: #483d8b;">:in</span> (drakma:cookie-jar-cookies cookie-jar) <span style="color: #483d8b;">:append</span>
                         (list (intern (string-upcase (drakma:cookie-name cookie)) <span style="color: #483d8b;">:keyword</span>) (drakma:cookie-value cookie))))
         (unique-banner-user (getf cookie-data <span style="color: #483d8b;">:unique_banner_user</span>)))
    (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal crypted-id (getf cookie-data <span style="color: #483d8b;">:crypted_id</span>)))
    (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"applicant"</span> (getf cookie-data <span style="color: #483d8b;">:hhrole</span>)))
    (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal xsrf (getf cookie-data <span style="color: #483d8b;">:_xsrf</span>)))
    (<span style="color: #a020f0;">let*</span> ((tree (html5-parser:node-to-xmls (html5-parser:parse-html5-fragment html)))
           (name (<span style="color: #a020f0;">block</span> namer (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"navi-item__switcher HH-Navi-MenuItems-Switcher"</span>) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"mainmenu_normalUserName"</span>))
                                            ,name (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"navi-item__post"</span>))))
                                     (<span style="color: #a020f0;">return-from</span> namer name))
                                   tree))))
      (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"&#1052;&#1080;&#1093;&#1072;&#1080;&#1083; &#1052;&#1080;&#1093;&#1072;&#1081;&#1083;&#1086;&#1074;&#1080;&#1095; &#1043;&#1083;&#1091;&#1093;&#1086;&#1074;"</span> name))
      (sleep 1)
      (<span style="color: #a020f0;">let</span> ((cookie-jar (make-instance 'drakma:cookie-jar)))
        (flexi-streams:octets-to-string
         (drakma:http-request
          <span style="color: #8b2252;">"http://spb.hh.ru/applicant/vacancy_response/popup"</span>
          <span style="color: #483d8b;">:user-agent</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:34.0) Gecko/20100101 Firefox/34.0"</span>
          <span style="color: #483d8b;">:method</span> <span style="color: #483d8b;">:post</span>
          <span style="color: #483d8b;">:content</span> (format nil <span style="color: #8b2252;">"~{~A~^&amp;~}"</span>
                           (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                       (format nil <span style="color: #8b2252;">"~A=~A"</span> (car x) (cdr x)))
                                   `((<span style="color: #8b2252;">"vacancy_id"</span> . ,(format nil <span style="color: #8b2252;">"~A"</span> vacancy-id))
                                     (<span style="color: #8b2252;">"resume_id"</span> . ,(format nil <span style="color: #8b2252;">"~A"</span> resume-id))
                                     (<span style="color: #8b2252;">"letter"</span> . ,(drakma:url-encode letter <span style="color: #483d8b;">:utf-8</span>))
                                     (<span style="color: #8b2252;">"_xsrf"</span> . ,xsrf)
                                     (<span style="color: #8b2252;">"ignore_postponed"</span> . <span style="color: #8b2252;">"true"</span>))))
          <span style="color: #483d8b;">:content-type</span> <span style="color: #8b2252;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
          <span style="color: #483d8b;">:additional-headers</span> `((<span style="color: #8b2252;">"Accept"</span>           . <span style="color: #8b2252;">"*/*"</span>)
                                (<span style="color: #8b2252;">"Accept-Language"</span>  . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
                                (<span style="color: #8b2252;">"Accept-Encoding"</span>  . <span style="color: #8b2252;">"gzip, deflate"</span>)
                                (<span style="color: #8b2252;">"X-Xsrftoken"</span>      . ,xsrf)
                                (<span style="color: #8b2252;">"X-Requested-With"</span> . <span style="color: #8b2252;">"XMLHttpRequest"</span>)
                                (<span style="color: #8b2252;">"Referer"</span>          . ,(format nil <span style="color: #8b2252;">"http://spb.hh.ru/vacancy/~A"</span> vacancy-id))
                                (<span style="color: #8b2252;">"Cookie"</span>           . ,(format nil <span style="color: #8b2252;">"~{~A~^;~}"</span>
                                                               (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                                                           (format nil <span style="color: #8b2252;">"~A=~A"</span> (car x) (cdr x)))
                                                                       `((<span style="color: #8b2252;">"redirect_host"</span> . <span style="color: #8b2252;">"vladivostok.hh.ru"</span>)
                                                                         (<span style="color: #8b2252;">"regions"</span> . <span style="color: #8b2252;">"2"</span>)
                                                                         (<span style="color: #8b2252;">"__utma"</span> . <span style="color: #8b2252;">"192485224.1206865564.1390484616.1421799450.1421859024.49"</span>)
                                                                         (<span style="color: #8b2252;">"__utmz"</span> . <span style="color: #8b2252;">"192485224.1390484616.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)"</span>)
                                                                         (<span style="color: #8b2252;">"hipsterShown"</span> . <span style="color: #8b2252;">"true"</span>)
                                                                         (<span style="color: #8b2252;">"hhref"</span> . <span style="color: #8b2252;">""</span>)
                                                                         (<span style="color: #8b2252;">"vishnu1.userid"</span> . <span style="color: #8b2252;">"2B9E046016B13C9E701CAC5A276D51C8A5471C6F722104504734B32F0D03E9F8"</span>)
                                                                         (<span style="color: #8b2252;">"lt-vc"</span> . <span style="color: #8b2252;">"11"</span>)
                                                                         (<span style="color: #8b2252;">"hhtoken"</span> . ,hhtoken)
                                                                         (<span style="color: #8b2252;">"hhuid"</span> . ,hhuid)
                                                                         (<span style="color: #8b2252;">"hhrole"</span> . ,hhrole)
                                                                         (<span style="color: #8b2252;">"GMT"</span> . <span style="color: #8b2252;">"3"</span>)
                                                                         (<span style="color: #8b2252;">"display"</span> . <span style="color: #8b2252;">"desktop"</span>)
                                                                         (<span style="color: #8b2252;">"_xsrf"</span> . ,xsrf)
                                                                         (<span style="color: #8b2252;">"JSESSIONID"</span> . <span style="color: #8b2252;">"1i5cpqbtgjgh7ztfwncgixv8c"</span>)
                                                                         (<span style="color: #8b2252;">"lrp"</span> . <span style="color: #8b2252;">"\"http://spb.hh.ru/\""</span>)
                                                                         (<span style="color: #8b2252;">"lrr"</span> . <span style="color: #8b2252;">"true"</span>)
                                                                         (<span style="color: #8b2252;">"crypted_id"</span> . ,crypted-id)
                                                                         (<span style="color: #8b2252;">"lt-tl"</span> . <span style="color: #8b2252;">"8xmy,rn2r,21i1,6gix"</span>)
                                                                         (<span style="color: #8b2252;">"lt-on-site-time"</span> . <span style="color: #8b2252;">"1421859023"</span>)
                                                                         (<span style="color: #8b2252;">"_xsrf"</span> . <span style="color: #8b2252;">"ed689ea1ff02a3074c848b69225e3c78"</span>)
                                                                         (<span style="color: #8b2252;">"crypted_id"</span> . ,crypted-id)
                                                                         (<span style="color: #8b2252;">"unique_banner_user"</span> . ,unique-banner-user)
                                                                         (<span style="color: #8b2252;">"__utmb"</span> . <span style="color: #8b2252;">"192485224.39.10.1421859024"</span>)
                                                                         (<span style="color: #8b2252;">"__utmc"</span> . <span style="color: #8b2252;">"192485224"</span>)
                                                                         (<span style="color: #8b2252;">"lt-8xmy"</span> . <span style="color: #8b2252;">"46005334"</span>)
                                                                         (<span style="color: #8b2252;">"lt-rn2r"</span> . <span style="color: #8b2252;">"46005334"</span>)
                                                                         (<span style="color: #8b2252;">"lt-21i1"</span> . <span style="color: #8b2252;">"46005334"</span>)
                                                                         (<span style="color: #8b2252;">"__utmt_vishnu1"</span> . <span style="color: #8b2252;">"1"</span>)
                                                                         (<span style="color: #8b2252;">"lt-6gix"</span> . <span style="color: #8b2252;">"46005334"</span>)))))
                                (<span style="color: #8b2252;">"Cache-Control"</span> . <span style="color: #8b2252;">"no-cache"</span>))
          <span style="color: #483d8b;">:cookie-jar</span> cookie-jar
          <span style="color: #483d8b;">:force-binary</span> t)
         <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(respond 12644276 7628220 "&#1047;&#1076;&#1088;&#1072;&#1074;&#1089;&#1090;&#1074;&#1091;&#1081;&#1090;&#1077;, &#1103; &#1087;&#1086;&#1076;&#1093;&#1086;&#1078;&#1091; &#1087;&#1086;&#1076; &#1074;&#1072;&#1096;&#1080; &#1090;&#1088;&#1077;&#1073;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;. &#1050;&#1086;&#1075;&#1076;&#1072; &#1084;&#1086;&#1078;&#1085;&#1086; &#1076;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088;&#1080;&#1090;&#1100;&#1089;&#1103; &#1086; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080;? &#1052;&#1080;&#1093;&#1072;&#1080;&#1083; 8(911)286-92-90")</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(let ((respond (respond 12646549 7628220 "&#1090;&#1077;&#1089;&#1090;")))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(print respond))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(setf drakma:*header-stream* *standard-output*)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-22" class="outline-3">
<h3 id="sec-4-22"><span class="section-number-3">4.22</span> Фабрика генераторов отзывов</h3>
<div class="outline-text-3" id="text-4-22">
<p>
Пусть у нас есть фабрика <code>генераторов функций</code> назовем его <code>factory</code>, которая принимает
<code>источник вакансий</code> и параметры запроса (например: <code>профессиональную область</code>, <code>специализацию</code>,
<code>город</code>) и возвращает <code>функцию-генератор в замыкании</code>.
</p>

<p>
Аналогично фабрике - генератору вакансий сделаем фабрику - генератор отзывов,
возвращающую функцию, которая при каждом своем вызове вернет один отзыв или <code>ложь</code> если все
вакансии кончились.
</p>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает отзывы.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="run_response">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-parse-responds</span> (html)
  <span style="color: #8b2252;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1086;&#1074; &#1080;&#1079; html"</span>
  (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) (reduce #'append x))
          (mtm (`(<span style="color: #8b2252;">"tr"</span> ((<span style="color: #8b2252;">"data-hh-negotiations-responses-topic-id"</span> ,topic-id) (<span style="color: #8b2252;">"class"</span> ,_)) ,@rest)
                 `(,@(remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (or (equal x 'z) (equal x <span style="color: #8b2252;">"noindex"</span>) (equal x <span style="color: #8b2252;">"/noindex"</span>))) rest)))
               (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell"</span>)) (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-trash"</span>)) ,@rest)) `Z)
                    (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>))) `Z)
                         (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell"</span>)) (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-bubble HH-Responses-NotificationIcon"</span>)))) `Z)
                              (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell"</span>))) `Z)
                                   (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell"</span>)) (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-vacancy responses-vacancy_disabled"</span>)) ,vacancy-name)
                                                (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-company"</span>)) ,emp-name))
                                          `(<span style="color: #483d8b;">:vacancy-name</span> ,vacancy-name <span style="color: #483d8b;">:emp-name</span> ,emp-name <span style="color: #483d8b;">:disabled</span> t))
                                        (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell"</span>))
                                                     (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-vacancy"</span>))
                                                            (<span style="color: #8b2252;">"a"</span>
                                                             ((<span style="color: #8b2252;">"class"</span> ,_)
                                                              (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"href"</span> ,vacancy-link))
                                                             ,vacancy-name))
                                                     (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-company"</span>)) ,emp-name))
                                               `(<span style="color: #483d8b;">:vacancy-link</span> ,vacancy-link <span style="color: #483d8b;">:vacancy-name</span> ,vacancy-name <span style="color: #483d8b;">:emp-name</span> ,emp-name))
                                             (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #8b2252;">"&#1042; &#1072;&#1088;&#1093;&#1080;&#1074;&#1077;"</span>) `(<span style="color: #483d8b;">:archive</span> t))
                                                  (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>) `(<span style="color: #483d8b;">:result</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>))
                                                       (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #8b2252;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>) `(<span style="color: #483d8b;">:result</span> <span style="color: #8b2252;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>))
                                                            (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
                                                                         (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"negotiations__invitation"</span>)) <span style="color: #8b2252;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span>)) `(<span style="color: #483d8b;">:result</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span>))
                                                                 (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
                                                                              (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"negotiations__denial"</span>)) <span style="color: #8b2252;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span>)) `(<span style="color: #483d8b;">:result</span> <span style="color: #8b2252;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span>))
                                                                      (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
                                                                                   (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-date"</span>)) ,result-date))
                                                                             `(<span style="color: #483d8b;">:result-date</span>, result-date))
                                                                           (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
                                                                                        (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"responses-date responses-date_dimmed"</span>)) ,result))
                                                                                  `(<span style="color: #483d8b;">:response-date</span> ,result))
                                                                                (<span style="color: #a020f0;">block</span> subtree-extract
                                                                                  (mtm (`(<span style="color: #8b2252;">"tbody"</span> NIL ,@rest)
                                                                                         (<span style="color: #a020f0;">return-from</span> subtree-extract rest))
                                                                                       (html5-parser:node-to-xmls
                                                                                        (html5-parser:parse-html5-fragment html))))))))))))))))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-parse-responds (hh-get-page "http://spb.hh.ru/applicant/negotiations?page=1")))</span>

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">process-respond</span> (respond)
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1053;&#1072;&#1081;&#1090;&#1080; src-id &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;</span>
  (<span style="color: #a020f0;">let</span> ((src-id (car (last (split-sequence:split-sequence #\/ (getf respond <span style="color: #483d8b;">:vacancy-link</span>))))))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1044;&#1083;&#1103; &#1074;&#1089;&#1077;&#1093; &#1087;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1085;&#1099;&#1093; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;, &#1089;&#1090;&#1072;&#1090;&#1091;&#1089; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1093; &#1086;&#1090;&#1083;&#1080;&#1095;&#1072;&#1077;&#1090;&#1089;&#1103; &#1086;&#1090; "&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"..</span>
    (<span style="color: #a020f0;">unless</span> (equal <span style="color: #8b2252;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #483d8b;">:result</span>))
      (<span style="color: #a020f0;">unless</span> (null src-id)
        <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1045;&#1089;&#1083;&#1080; &#1090;&#1072;&#1082;&#1072;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103; &#1077;&#1089;&#1090;&#1100; &#1074; &#1073;&#1076;</span>
        (<span style="color: #a020f0;">let</span> ((target (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id))))
          (<span style="color: #a020f0;">unless</span> (null target)
            (dbg (format nil <span style="color: #8b2252;">"~A : [~A] ~A "</span> src-id (getf respond <span style="color: #483d8b;">:result</span>) (getf respond <span style="color: #483d8b;">:vacancy-name</span>)))
            <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1080; &#1091; &#1085;&#1077;&#1077; &#1089;&#1090;&#1072;&#1090;&#1091;&#1089; RESPONDED &#1080;&#1083;&#1080; BEENVIEWED  - &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1089;&#1090;&#1072;&#1090;&#1091;&#1089;</span>
            (<span style="color: #a020f0;">when</span> (or (equal <span style="color: #8b2252;">":RESPONDED"</span> (state target))
                      (equal <span style="color: #8b2252;">":BEENVIEWED"</span> (state target)))
              (<span style="color: #a020f0;">cond</span> ((equal <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #483d8b;">:result</span>))
                     (takt target <span style="color: #483d8b;">:beenviewed</span>))
                    ((equal <span style="color: #8b2252;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span> (getf respond <span style="color: #483d8b;">:result</span>))
                     (takt target <span style="color: #483d8b;">:reject</span>))
                    ((equal <span style="color: #8b2252;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span> (getf respond <span style="color: #483d8b;">:result</span>))
                     (takt target <span style="color: #483d8b;">:invite</span>))
                    ((equal <span style="color: #8b2252;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #483d8b;">:result</span>))
                     nil)
                    (t (err (format nil <span style="color: #8b2252;">"unk respond state ~A"</span> (state target)))))))))))
  respond)

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">response-factory</span> ((vac-src (eql 'hh)))
  (<span style="color: #a020f0;">let</span> ((url      <span style="color: #8b2252;">"http://spb.hh.ru/applicant/negotiations?page=~A"</span>)
        (page     0)
        (responds nil))
    (alexandria:named-lambda get-responds ()
      (<span style="color: #a020f0;">labels</span> ((load-next-responds-page ()
                 <span style="color: #b22222;">;; </span><span style="color: #b22222;">(dbg "~~ LOAD (page=~A)" page)</span>
                 (setf responds (hh-parse-responds (hh-get-page (format nil url page))))
                 (incf page)
                 (<span style="color: #a020f0;">when</span> (equal 0 (length responds))
                   (dbg <span style="color: #8b2252;">"~~ FIN"</span>)
                   (<span style="color: #a020f0;">return-from</span> get-responds 'nil)))
               (get-respond ()
                 (<span style="color: #a020f0;">when</span> (equal 0 (length responds))
                   (load-next-responds-page))
                 (<span style="color: #a020f0;">let</span> ((current-respond (car responds)))
                   (setf responds (cdr responds))
                   current-respond)))
        (<span style="color: #a020f0;">tagbody</span> get-new-respond
           (<span style="color: #a020f0;">let</span> ((current-respond (process-respond (get-respond))))
             (<span style="color: #a020f0;">if</span> (null current-respond)
                 (<span style="color: #a020f0;">go</span> get-new-respond)
                 (<span style="color: #a020f0;">return-from</span> get-responds current-respond))))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">run-response</span> ()
  (<span style="color: #a020f0;">let</span> ((archive-cnt 0))
    (<span style="color: #a020f0;">let</span> ((gen (response-factory 'hh)))
      (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> i <span style="color: #483d8b;">:from</span> 1 <span style="color: #483d8b;">:to</span> 700 <span style="color: #483d8b;">:do</span>
         (<span style="color: #a020f0;">let</span> ((target (funcall gen)))
           (<span style="color: #a020f0;">when</span> (null target)
             (<span style="color: #a020f0;">return-from</span> run-response 'FIN-NIL))
           (<span style="color: #a020f0;">when</span> (getf target <span style="color: #483d8b;">:archive</span>)
             (incf archive-cnt))
           (<span style="color: #a020f0;">when</span> (&gt; archive-cnt 140)
             (<span style="color: #a020f0;">return-from</span> run-response 'ARCHIVE))
           <span style="color: #b22222;">;; </span><span style="color: #b22222;">(print target)</span>
           ))
      (<span style="color: #a020f0;">return-from</span> run-response 'loop))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(run-response)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Interface</h2>
<div class="outline-text-2" id="text-5">
<p>
Соберем веб-интерфейс:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">iface.lisp</span>

(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;</span>
&lt;&lt;iface_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Главная страница модуля</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-page</span> hh <span style="color: #8b2252;">"/hh"</span>
  (<span style="color: #a020f0;">let*</span> ((vacs (aif (all-vacancy) it (err <span style="color: #8b2252;">"null vacancy"</span>)))
         (sorted-vacs (sort vacs #'(<span style="color: #a020f0;">lambda</span> (a b) (&gt; (salary a) (salary b)))))
         (breadcrumb (breadcrumb <span style="color: #8b2252;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span> (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>)))
         (user       (<span style="color: #a020f0;">if</span> (null *current-user*) <span style="color: #8b2252;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
    (base-page (<span style="color: #483d8b;">:breadcrumb</span> breadcrumb)
      (content-box ()
        (heading (<span style="color: #8b2252;">"&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter"</span>) <span style="color: #8b2252;">"&#1052;&#1077;&#1085;&#1102; &#1084;&#1086;&#1076;&#1091;&#1083;&#1103;"</span>))
      (content-box ()
        ((<span style="color: #483d8b;">:section</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"dnd-area"</span>)
         ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected handles list"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"not"</span>)
          ((<span style="color: #483d8b;">:li</span>)
           ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> <span style="color: #8b2252;">"/hh/vacs"</span>) <span style="color: #8b2252;">"&#1054;&#1090;&#1086;&#1073;&#1088;&#1072;&#1085;&#1085;&#1099;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>) <span style="color: #8b2252;">""</span>)
          ((<span style="color: #483d8b;">:li</span>)
           ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> <span style="color: #8b2252;">"/hh/rules"</span>) <span style="color: #8b2252;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080;"</span>) <span style="color: #8b2252;">""</span>)
          ((<span style="color: #483d8b;">:li</span>)
           ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> <span style="color: #8b2252;">"/hh-doc"</span>) <span style="color: #8b2252;">"&#1044;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1103;"</span>) <span style="color: #8b2252;">""</span>))))
      (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>)))))
  (<span style="color: #483d8b;">:SAVE</span> (ps-html
          ((<span style="color: #483d8b;">:input</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"hidden"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"SAVE"</span>))
          (submit <span style="color: #8b2252;">"SAVE"</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"save();return false;"</span>))
         (<span style="color: #a020f0;">progn</span> nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Страница списка вакансий</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<a href="http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/">http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/</a>
<a href="http://romka.eu/blog/jquery-table-drag-and-drop">http://romka.eu/blog/jquery-table-drag-and-drop</a>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-page</span> vacs <span style="color: #8b2252;">"/hh/vacs"</span>
  (<span style="color: #a020f0;">labels</span> ((mrg (param)
             (<span style="color: #a020f0;">if</span> (null param)
                 <span style="color: #8b2252;">""</span>
                 (reduce #'(<span style="color: #a020f0;">lambda</span> (x y)
                             (concatenate 'string x (string #\NewLine) y))
                         (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                     (ps-html ((<span style="color: #483d8b;">:li</span> <span style="color: #483d8b;">:id</span> (src-id x)
                                                    <span style="color: #483d8b;">:class</span> (string-downcase (subseq (state x) 1))
                                                    <span style="color: #483d8b;">:title</span> (notes x))
                                               ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> (<span style="color: #a020f0;">if</span> (empty (notes x)) <span style="color: #8b2252;">"emptynotes"</span> <span style="color: #8b2252;">"notes"</span>))
                                                (<span style="color: #a020f0;">cond</span> ((equal <span style="color: #8b2252;">"USD"</span> (currency x)) <span style="color: #8b2252;">"$"</span>)
                                                      ((equal <span style="color: #8b2252;">"EUR"</span> (currency x)) <span style="color: #8b2252;">"&#8364;"</span>)
                                                      ((equal <span style="color: #8b2252;">"RUR"</span> (currency x)) <span style="color: #8b2252;">""</span>))
                                                (salary-max x))
                                               ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"/hh/vac/~A"</span> (src-id x)))
                                                (name x)))))
                                 param)))))
    (<span style="color: #a020f0;">let*</span> ((vacs (aif (all-vacancy) it (err <span style="color: #8b2252;">"null vacancy"</span>)))
           (sorted-vacs (sort vacs #'(<span style="color: #a020f0;">lambda</span> (a b) (&gt; (salary-max a) (salary-max b)))))
           (breadcrumb (breadcrumb <span style="color: #8b2252;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span> (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>)))
           (user       (<span style="color: #a020f0;">if</span> (null *current-user*) <span style="color: #8b2252;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
      (base-page (<span style="color: #483d8b;">:breadcrumb</span> breadcrumb)
        ((<span style="color: #483d8b;">:script</span>)
         (ps
           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-child-ids</span> (selector)
             ((@ ((@ ((@ ($ selector) children)) map) (<span style="color: #a020f0;">lambda</span> (i elt) (array ((@ ((@ $) elt) attr) <span style="color: #8b2252;">"id"</span>)))) get)))
           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">save</span> ()
             ((@ $ post) <span style="color: #8b2252;">"#"</span> (create <span style="color: #483d8b;">:act</span> <span style="color: #8b2252;">"SAVE"</span> <span style="color: #483d8b;">:not</span> ((@ (get-child-ids <span style="color: #8b2252;">"#not"</span>) join)) <span style="color: #483d8b;">:yep</span> ((@ (get-child-ids <span style="color: #8b2252;">"#yep"</span>) join)))
              (<span style="color: #a020f0;">lambda</span> (data status)
                (<span style="color: #a020f0;">if</span> (not (equal status <span style="color: #8b2252;">"success"</span>))
                    (alert (concatenate 'string <span style="color: #8b2252;">"err-ajax-fail: "</span> status))
                    (eval data))))
             false)))
        (content-box ()
          (heading (<span style="color: #8b2252;">"&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter"</span>)
            <span style="color: #8b2252;">"&#1042; &#1087;&#1088;&#1072;&#1074;&#1086;&#1081; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1077; - &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1074; &#1083;&#1077;&#1074;&#1086;&#1081; - &#1085;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;. "</span>
            ((<span style="color: #483d8b;">:br</span>))((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"unsort"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1046;&#1077;&#1083;&#1090;&#1099;&#1084;&amp;nbsp;"</span>)
            <span style="color: #8b2252;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1087;&#1086;&#1103;&#1074;&#1080;&#1083;&#1080;&#1089;&#1100; &#1074; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1075;&#1086; &#1089;&#1073;&#1086;&#1088;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;. "</span>
            <span style="color: #8b2252;">"&#1055;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; &#1086;&#1085;&#1080; &#1087;&#1086;&#1084;&#1077;&#1097;&#1072;&#1102;&#1090;&#1089;&#1103; &#1074; &#1087;&#1088;&#1072;&#1074;&#1099;&#1081; &#1089;&#1090;&#1086;&#1083;&#1073;&#1080;&#1082; - &#1082; &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1091;&#1102;&#1097;&#1080;&#1084; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103;&#1084;. "</span>
            <span style="color: #8b2252;">"&#1055;&#1086;&#1089;&#1083;&#1077; &#1089;&#1086;&#1088;&#1090;&#1080;&#1088;&#1086;&#1074;&#1082;&#1080; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1089;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1080;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080; &#1090;&#1086;&#1075;&#1076;&#1072; &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077; &#1080;&#1089;&#1095;&#1077;&#1079;&#1085;&#1077;&#1090;. "</span>
            ((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"responded"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1043;&#1086;&#1083;&#1091;&#1073;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085; &#1086;&#1090;&#1079;&#1099;&#1074;. "</span>
            ((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"beenviewed"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1060;&#1080;&#1086;&#1083;&#1077;&#1090;&#1086;&#1074;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1086;&#1090;&#1079;&#1099;&#1074; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1099;&#1083; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;. "</span>
            ((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"reject"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1050;&#1088;&#1072;&#1089;&#1085;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" - &#1077;&#1089;&#1083;&#1080; &#1088;&#1072;&#1073;&#1086;&#1090;&#1086;&#1076;&#1072;&#1090;&#1077;&#1083;&#1100; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;. "</span>
            <span style="color: #8b2252;">"&#1052;&#1086;&#1078;&#1085;&#1086; &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1086;&#1074;&#1072;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103; &#1076;&#1088;&#1091;&#1075;&#1080;&#1084; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077; &#1080;&#1083;&#1080; &#1079;&#1072;&#1073;&#1080;&#1090;&#1100; &#1085;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102; &#1080; &#1087;&#1077;&#1088;&#1077;&#1085;&#1077;&#1089;&#1090;&#1080; &#1077;&#1077; &#1074; '&#1085;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;' "</span>
            ((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"invite"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1047;&#1077;&#1083;&#1077;&#1085;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" - &#1077;&#1089;&#1083;&#1080; &#1088;&#1072;&#1073;&#1086;&#1090;&#1086;&#1076;&#1072;&#1090;&#1077;&#1083;&#1100; &#1087;&#1088;&#1080;&#1075;&#1083;&#1072;&#1089;&#1080;&#1083; &#1085;&#1072; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;. "</span>
            ((<span style="color: #483d8b;">:br</span>))
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"interview"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1057;&#1077;&#1088;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" - &#1077;&#1089;&#1083;&#1080; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1073;&#1099;&#1083;&#1086; &#1087;&#1088;&#1086;&#1081;&#1076;&#1077;&#1085;&#1086;. "</span>
            ((<span style="color: #483d8b;">:br</span>))((<span style="color: #483d8b;">:br</span>))
            <span style="color: #8b2252;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1082; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1084; &#1077;&#1089;&#1090;&#1100; &#1079;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;, &#1074;&#1099;&#1076;&#1077;&#1083;&#1103;&#1102;&#1090;&#1089;&#1103; &#1079;&#1072;&#1088;&#1087;&#1083;&#1072;&#1090;&#1086;&#1081; &#1085;&#1072; "</span>
            ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"notes"</span>) <span style="color: #8b2252;">"&amp;nbsp;&#1095;&#1077;&#1088;&#1085;&#1086;&#1084;&amp;nbsp;"</span>) <span style="color: #8b2252;">" &#1092;&#1086;&#1085;&#1077;. "</span>
            <span style="color: #8b2252;">"&#1055;&#1088;&#1080; &#1085;&#1072;&#1074;&#1077;&#1076;&#1077;&#1085;&#1080;&#1080; &#1085;&#1072; &#1090;&#1072;&#1082;&#1091;&#1102; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102; &#1084;&#1086;&#1078;&#1085;&#1086; &#1091;&#1074;&#1080;&#1076;&#1077;&#1090;&#1100; &#1090;&#1077;&#1082;&#1089;&#1090; &#1079;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;."</span>))
        (content-box ()
          %SAVE%
          ((<span style="color: #483d8b;">:section</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"dnd-area"</span>)
           ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected handles list"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"not"</span>)
            (mrg (remove-if-not #'(<span style="color: #a020f0;">lambda</span> (x)
                                    (equal <span style="color: #8b2252;">":UNINTERESTING"</span> (state x)))
                                sorted-vacs)))
           ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected handles list no2"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"yep"</span>)
            (mrg (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                (equal <span style="color: #8b2252;">":UNINTERESTING"</span> (state x)))
                            sorted-vacs)))))
        (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>))))))
  (<span style="color: #483d8b;">:SAVE</span> (ps-html
          ((<span style="color: #483d8b;">:input</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"hidden"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"SAVE"</span>))
          (submit <span style="color: #8b2252;">"SAVE"</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"save();return false;"</span>))
         (<span style="color: #a020f0;">progn</span>
           (setf *tmp1* (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:not</span>)))
           (setf *tmp2* (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:yep</span>)))
           (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                       (takt (car (find-vacancy <span style="color: #483d8b;">:src-id</span> (parse-integer x))) <span style="color: #483d8b;">:uninteresting</span>))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:not</span>)))
           (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                       (<span style="color: #a020f0;">let</span> ((vac (car (find-vacancy <span style="color: #483d8b;">:src-id</span> (parse-integer x)))))
                         (<span style="color: #a020f0;">when</span> (or (equal (state vac) <span style="color: #8b2252;">":UNSORT"</span>)
                                   (equal (state vac) <span style="color: #8b2252;">":UNINTERESTING"</span>))
                           (takt vac <span style="color: #483d8b;">:interesting</span>))))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:yep</span>)))
           (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> <span style="color: #8b2252;">"window.location.href='/hh/vacs'"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Страница вакансии</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-page</span> vacancy <span style="color: #8b2252;">"/hh/vac/:src-id"</span>
  (<span style="color: #a020f0;">let*</span> ((vac (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id)))
         (breadcrumb (<span style="color: #a020f0;">if</span> (null vac)
                         (breadcrumb <span style="color: #8b2252;">"&#1053;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086;"</span> (<span style="color: #8b2252;">"/"</span> . <span style="color: #8b2252;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>) (<span style="color: #8b2252;">"/hh/vacs"</span> . <span style="color: #8b2252;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>))
                         (breadcrumb (name vac) (<span style="color: #8b2252;">"/"</span> . <span style="color: #8b2252;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>) (<span style="color: #8b2252;">"/hh/vacs"</span> . <span style="color: #8b2252;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>))))
         (user       (<span style="color: #a020f0;">if</span> (null *current-user*) <span style="color: #8b2252;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*))))
         (text (parenscript::process-html-forms-lhtml (read-from-string (descr vac)))))
    (standard-page (<span style="color: #483d8b;">:breadcrumb</span> breadcrumb <span style="color: #483d8b;">:user</span> user <span style="color: #483d8b;">:menu</span> (menu) <span style="color: #483d8b;">:overlay</span> (reg-overlay))
      (content-box ()
        (heading ((format nil <span style="color: #8b2252;">"~A ~A"</span> (name vac) (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"color:red"</span>) (salary-text vac)))))
          (form (<span style="color: #8b2252;">"chvacstateform"</span> <span style="color: #8b2252;">""</span>)
            ((<span style="color: #483d8b;">:table</span> <span style="color: #483d8b;">:border</span> 0 <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"font-size: small;"</span>)
             ((<span style="color: #483d8b;">:tr</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"id:"</span>)
              ((<span style="color: #483d8b;">:td</span>) (id vac))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"src-id:"</span>)
              ((<span style="color: #483d8b;">:td</span>) ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"http://hh.ru/vacancy/~A"</span> (src-id vac))) (src-id vac)))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"archive:"</span>)
              ((<span style="color: #483d8b;">:td</span>) (archive vac))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
             ((<span style="color: #483d8b;">:tr</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"emp-id:"</span>)
              ((<span style="color: #483d8b;">:td</span>) (emp-id vac))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"emp-name:"</span>)
              ((<span style="color: #483d8b;">:td</span>) ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"color:red"</span>) (emp-name vac)))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"state:"</span>)
              ((<span style="color: #483d8b;">:td</span>) (state vac))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
             ((<span style="color: #483d8b;">:tr</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"city:"</span>)       ((<span style="color: #483d8b;">:td</span>) (city vac))                                    ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"metro:"</span>)      ((<span style="color: #483d8b;">:td</span>) (metro vac))                                   ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"state:"</span>)
              ((<span style="color: #483d8b;">:td</span>)
               (fieldset <span style="color: #8b2252;">""</span>
                 (eval
                  (macroexpand
                   (append `(select (<span style="color: #8b2252;">"newstate"</span> <span style="color: #8b2252;">""</span> <span style="color: #483d8b;">:default</span> ,(subseq (state vac) 1)))
                           (list
                            (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                        (cons (symbol-name x) (symbol-name x)))
                                    (possible-trans vac))))))))
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
             ((<span style="color: #483d8b;">:tr</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"experience:"</span>) ((<span style="color: #483d8b;">:td</span>) (experience vac))                              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"date:"</span>)       ((<span style="color: #483d8b;">:td</span>) (date vac))                                    ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
              ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"state:"</span>)      ((<span style="color: #483d8b;">:td</span>) %CHSTATE%)                                     ((<span style="color: #483d8b;">:td</span>) <span style="color: #8b2252;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
             ))))
      (content-box ()
        ((<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"vacancy-descr"</span>) (format nil <span style="color: #8b2252;">"~{~A~}"</span> text)))
      (content-box ()
        (form (<span style="color: #8b2252;">"vacform"</span> nil <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"form-section-container"</span>)
          ((<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"form-section"</span>)
           (fieldset <span style="color: #8b2252;">"&#1047;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;"</span>
             (textarea (<span style="color: #8b2252;">"notes"</span> <span style="color: #8b2252;">"&#1047;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;"</span>) (notes vac))
             (textarea (<span style="color: #8b2252;">"response"</span> <span style="color: #8b2252;">"&#1057;&#1086;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1080;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1087;&#1080;&#1089;&#1100;&#1084;&#1086;"</span>) (response vac))
             (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>)))))
          %RESPOND% %SAVE%))
      (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>)))))
  (<span style="color: #483d8b;">:chstate</span> (ps-html ((<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"form-send-container"</span>)
                      (submit <span style="color: #8b2252;">"&#1048;&#1079;&#1084;&#1077;&#1085;&#1080;&#1090;&#1100;"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"CHSTATE"</span>)))
            (<span style="color: #a020f0;">progn</span>
              <span style="color: #b22222;">;; </span><span style="color: #b22222;">(id (upd-vacancy (car (find-vacancy :src-id src-id))</span>
              <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(list :notes (getf p :notes) :response (getf p :response))))</span>
              (takt (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id))
                    (intern (getf p <span style="color: #483d8b;">:newstate</span>) <span style="color: #483d8b;">:keyword</span>))
              (redirect (format nil <span style="color: #8b2252;">"/hh/vac/~A"</span> src-id))
              ))
  (<span style="color: #483d8b;">:save</span> (ps-html ((<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"form-send-container"</span>)
                   (submit <span style="color: #8b2252;">"&#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102;"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"SAVE"</span>)))
         (<span style="color: #a020f0;">progn</span>
           (id (upd-vacancy (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id))
                            (list <span style="color: #483d8b;">:notes</span> (getf p <span style="color: #483d8b;">:notes</span>) <span style="color: #483d8b;">:response</span> (getf p <span style="color: #483d8b;">:response</span>))))
           (redirect (format nil <span style="color: #8b2252;">"/hh/vac/~A"</span> src-id))))
  (<span style="color: #483d8b;">:respond</span> (ps-html
             ((<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"form-send-container"</span>)
              (eval
               (macroexpand
                (append '(select (<span style="color: #8b2252;">"resume"</span> <span style="color: #8b2252;">"&#1042;&#1099;&#1073;&#1088;&#1072;&#1090;&#1100; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077; &#1076;&#1083;&#1103; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1082;&#1080; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1072;:"</span>))
                        (list
                         (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) (cons (id x) (title x)))
                                 (sort (all-resume) #'(<span style="color: #a020f0;">lambda</span> (a b) (&lt; (id a) (id b)))))))))
              (submit <span style="color: #8b2252;">"&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1080;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"RESPOND"</span>)))
            (<span style="color: #a020f0;">progn</span>
              (id (upd-vacancy (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id))
                               (list <span style="color: #483d8b;">:notes</span> (getf p <span style="color: #483d8b;">:notes</span>) <span style="color: #483d8b;">:response</span> (getf p <span style="color: #483d8b;">:response</span>))))
              (dbg (send-respond
                    src-id
                    (res-id (get-resume (parse-integer (getf p <span style="color: #483d8b;">:resume</span>))))
                    (getf p <span style="color: #483d8b;">:response</span>)))
              (dbg (takt (car (find-vacancy <span style="color: #483d8b;">:src-id</span> src-id)) <span style="color: #483d8b;">:responded</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> <span class="todo START">START</span> Страница правил</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-page</span> rules <span style="color: #8b2252;">"/hh/rules"</span>
  (<span style="color: #a020f0;">labels</span> ((mrg (param)
             (<span style="color: #a020f0;">if</span> (null param)
                 <span style="color: #8b2252;">""</span>
                 (reduce #'(<span style="color: #a020f0;">lambda</span> (x y)
                             (concatenate 'string x (string #\NewLine) y))
                         (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                     (ps-html ((<span style="color: #483d8b;">:li</span> <span style="color: #b22222;">;; </span><span style="color: #b22222;">:id (src-id x)</span>
                                                    <span style="color: #b22222;">;; </span><span style="color: #b22222;">:class (string-downcase (subseq (state x) 1))</span>
                                                    <span style="color: #b22222;">;; </span><span style="color: #b22222;">:title (notes x)</span>
                                                    )
                                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">((:span :class (if (empty (notes x)) "emptynotes" "notes"))</span>
                                               <span style="color: #b22222;">;;  </span><span style="color: #b22222;">(cond ((equal "USD" (currency x)) "$")</span>
                                               <span style="color: #b22222;">;;        </span><span style="color: #b22222;">((equal "EUR" (currency x)) "&#8364;")</span>
                                               <span style="color: #b22222;">;;        </span><span style="color: #b22222;">((equal "RUR" (currency x)) ""))</span>
                                               <span style="color: #b22222;">;;  </span><span style="color: #b22222;">(salary-max x))</span>
                                               ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"/hh/rule/~A"</span> <span style="color: #b22222;">;; </span><span style="color: #b22222;">(src-id x)</span>
                                                                  0
                                                                  ))
                                                (symbol-name x)))))
                                 param)))))
    (<span style="color: #a020f0;">let*</span> ((breadcrumb (breadcrumb <span style="color: #8b2252;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span> (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>)))
           (user       (<span style="color: #a020f0;">if</span> (null *current-user*) <span style="color: #8b2252;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
      (base-page (<span style="color: #483d8b;">:breadcrumb</span> breadcrumb)
        ((<span style="color: #483d8b;">:script</span>)
         (ps
           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-child-ids</span> (selector)
             ((@ ((@ ((@ ($ selector) children)) map) (<span style="color: #a020f0;">lambda</span> (i elt) (array ((@ ((@ $) elt) attr) <span style="color: #8b2252;">"id"</span>)))) get)))
           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">save</span> ()
             ((@ $ post) <span style="color: #8b2252;">"#"</span> (create <span style="color: #483d8b;">:act</span> <span style="color: #8b2252;">"SAVE"</span> <span style="color: #483d8b;">:not</span> ((@ (get-child-ids <span style="color: #8b2252;">"#not"</span>) join)) <span style="color: #483d8b;">:yep</span> ((@ (get-child-ids <span style="color: #8b2252;">"#yep"</span>) join)))
              (<span style="color: #a020f0;">lambda</span> (data status)
                (<span style="color: #a020f0;">if</span> (not (equal status <span style="color: #8b2252;">"success"</span>))
                    (alert (concatenate 'string <span style="color: #8b2252;">"err-ajax-fail: "</span> status))
                    (eval data))))
             false)))
        (content-box ()
          (heading (<span style="color: #8b2252;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080;"</span>)
            <span style="color: #8b2252;">"&#1042; &#1087;&#1088;&#1072;&#1074;&#1086;&#1081; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1077; - &#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1076;&#1083;&#1103; &#1090;&#1080;&#1079;&#1077;&#1088;&#1086;&#1074;, &#1074; &#1083;&#1077;&#1074;&#1086;&#1081; - &#1076;&#1083;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;. "</span>))
        (content-box ()
          %SAVE%
          ((<span style="color: #483d8b;">:section</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"dnd-area"</span>)
           ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected handles list"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"not"</span>)
            (mrg (rules-for-teaser)))
           ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected handles list no2"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"yep"</span>)
            (mrg (rules-for-vacancy)))))
        (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>))))))
  (<span style="color: #483d8b;">:SAVE</span> (ps-html
          ((<span style="color: #483d8b;">:input</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"hidden"</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"act"</span> <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"SAVE"</span>))
          (submit <span style="color: #8b2252;">"SAVE"</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"save();return false;"</span>))
         (<span style="color: #a020f0;">progn</span>
           (setf *tmp1* (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:not</span>)))
           (setf *tmp2* (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:yep</span>)))
           (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                       (takt (car (find-vacancy <span style="color: #483d8b;">:src-id</span> (parse-integer x))) <span style="color: #483d8b;">:uninteresting</span>))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:not</span>)))
           (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                       (<span style="color: #a020f0;">let</span> ((vac (car (find-vacancy <span style="color: #483d8b;">:src-id</span> (parse-integer x)))))
                         (<span style="color: #a020f0;">unless</span> (equal (state vac) <span style="color: #8b2252;">":RESPONDED"</span>)
                           (takt vac <span style="color: #483d8b;">:interesting</span>))))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #483d8b;">:yep</span>)))
           (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> <span style="color: #8b2252;">"window.location.href='/hh/rules'"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Страница документации модуля</h3>
<div class="outline-text-3" id="text-5-5">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(restas:define-route hh-doc (<span style="color: #8b2252;">"/hh-doc"</span>)
  (alexandria:read-file-into-string
   (merge-pathnames
    (pathname-parent-directory (pathname *base-path*))
    #P<span style="color: #8b2252;">"hh.html"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> Страница поиска</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-page</span> search-vacancy <span style="color: #8b2252;">"/hh/search"</span>
  (<span style="color: #a020f0;">let*</span> ((breadcrumb (breadcrumb <span style="color: #8b2252;">"&#1055;&#1086;&#1080;&#1089;&#1082;"</span> (<span style="color: #8b2252;">"/hh"</span> . <span style="color: #8b2252;">"HeadHunter"</span>)))
         (user       (<span style="color: #a020f0;">if</span> (null *current-user*) <span style="color: #8b2252;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
    (base-page (<span style="color: #483d8b;">:breadcrumb</span> breadcrumb)
      (content-box ()
        (heading (<span style="color: #8b2252;">"&#1055;&#1086;&#1080;&#1089;&#1082; &#1087;&#1086; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103;&#1084; &#1074; &#1089;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1080;&#1080; &#1074;&#1099;&#1096;&#1077; :RESPOND"</span>) <span style="color: #8b2252;">""</span>))
      (content-box ()
        (<span style="color: #a020f0;">let</span> ((q (get-parameter <span style="color: #8b2252;">"q"</span>)))
          (<span style="color: #a020f0;">if</span> (null q)
              <span style="color: #8b2252;">"empty searchstring"</span>
              (ps-html
               ((<span style="color: #483d8b;">:ul</span>)
                (format nil <span style="color: #8b2252;">"~{~A~}"</span>
                        (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                    (ps-html
                                     ((<span style="color: #483d8b;">:li</span> <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"padding: 3px"</span>)
                                      ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"/hh/vac/~A"</span> (src-id (car x))))
                                       (name (car x))
                                       <span style="color: #8b2252;">"&amp;nbsp&amp;nbsp:&amp;nbsp&amp;nbsp"</span>
                                       (emp-name (car x))))))
                                (sort (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                                     (equal (cdr x) 0))
                                                 (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                                             (<span style="color: #a020f0;">let</span> ((rel 0))
                                                               (<span style="color: #a020f0;">when</span> (contains (string-downcase (name x)) (string-downcase q))
                                                                 (incf rel 3))
                                                               (<span style="color: #a020f0;">when</span> (contains (string-downcase (emp-name x)) (string-downcase q))
                                                                 (incf rel 5))
                                                               (<span style="color: #a020f0;">when</span> (contains (string-downcase (descr x)) (string-downcase q))
                                                                 (incf rel))
                                                               (cons x rel)))
                                                         (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                                                        (or (equal <span style="color: #8b2252;">":UNSORT"</span> (state x)))
                                                                        (or (equal <span style="color: #8b2252;">":UNINTERESTING"</span> (state x))))
                                                                    (all-vacancy))))
                                      #'(<span style="color: #a020f0;">lambda</span> (a b)
                                          (&gt; (cdr a) (cdr b)))))))))))
      (ps-html ((<span style="color: #483d8b;">:span</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"clear"</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> Галлерея (parenscript)</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*slideshows*</span> (make-hash-table <span style="color: #483d8b;">:test</span> 'equalp))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">add-slideshow</span> (slideshow-name image-folder)
  (setf (gethash slideshow-name *slideshows*)
        (mapcar (<span style="color: #a020f0;">lambda</span> (pathname)
                  (url-encode (format nil <span style="color: #8b2252;">"~a.~a"</span>
                                      (pathname-name pathname)
                                      (pathname-type pathname))))
                (list-directory image-folder))))

(add-slideshow <span style="color: #8b2252;">"img"</span> <span style="color: #8b2252;">"/home/rigidus/repo/moto/img/"</span>)
(add-slideshow <span style="color: #8b2252;">"pic"</span> <span style="color: #8b2252;">"/home/rigidus/repo/moto/pic/"</span>)

(alexandria:hash-table-plist *slideshows*)

(defmacro/ps slideshow-image-uri (slideshow-name image-file)
  `(concatenate 'string ,slideshow-name <span style="color: #8b2252;">"/"</span> ,image-file))

(restas:define-route y (<span style="color: #8b2252;">"y"</span>)
  (ps
    (<span style="color: #a020f0;">define-symbol-macro</span> <span style="color: #0000ff;">fragment-identifier</span> (@ window location hash))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">show-image-number</span> (image-index)
      (<span style="color: #a020f0;">let</span> ((image-name (aref *images* (setf *current-image-index* image-index))))
        (setf (chain document (get-element-by-id <span style="color: #8b2252;">"slideshow-img-object"</span>) src)
              (slideshow-image-uri *slideshow-name* image-name)
              fragment-identifier
              image-name)))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">previous-image</span> ()
      (<span style="color: #a020f0;">when</span> (&gt; *current-image-index* 0)
        (show-image-number (1- *current-image-index*))))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">next-image</span> ()
      (<span style="color: #a020f0;">when</span> (&lt; *current-image-index* (1- (getprop *images* 'length)))
        (show-image-number (1+ *current-image-index*))))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">this gives bookmarkability using fragment identifiers</span>
    (setf (getprop window 'onload)
          (<span style="color: #a020f0;">lambda</span> ()
            (<span style="color: #a020f0;">when</span> fragment-identifier
              (<span style="color: #a020f0;">let</span> ((image-name (chain fragment-identifier (slice 1))))
                (<span style="color: #a020f0;">dotimes</span> (i (length *images*))
                  (<span style="color: #a020f0;">when</span> (string= image-name (aref *images* i))
                    (show-image-number i)))))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slideshow-handler</span> (slideshow-name)
  (<span style="color: #a020f0;">let*</span> ((images (gethash slideshow-name *slideshows*))
         (current-image-index (or (position (get-parameter <span style="color: #8b2252;">"image"</span>) images <span style="color: #483d8b;">:test</span> #'equalp)
                                  0))
         (previous-image-index (max 0 (1- current-image-index)))
         (next-image-index (min (1- (length images)) (1+ current-image-index))))
    (<span style="color: #a020f0;">with-html-output-to-string</span> (s)
      (<span style="color: #483d8b;">:html</span>
       (<span style="color: #483d8b;">:head</span>
        (<span style="color: #483d8b;">:title</span> <span style="color: #8b2252;">"Parenscript slideshow"</span>)
        (<span style="color: #483d8b;">:script</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"text/javascript"</span>
                 (str (ps* `(<span style="color: #a020f0;">progn</span>
                              (var *slideshow-name* ,slideshow-name)
                              (var *images* (array ,@images))
                              (var *current-image-index* ,current-image-index)))))
        (<span style="color: #483d8b;">:script</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"text/javascript"</span> <span style="color: #483d8b;">:src</span> <span style="color: #8b2252;">"/y"</span>)
        )
       (<span style="color: #483d8b;">:body</span>
        (<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"slideshow-container"</span>
              <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"width:100%;text-align:center"</span>
              (<span style="color: #483d8b;">:img</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"slideshow-img-object"</span>
                    <span style="color: #483d8b;">:src</span> (slideshow-image-uri slideshow-name
                                              (elt images current-image-index)))
              <span style="color: #483d8b;">:br</span>
              (<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"?image=~a"</span> (elt images previous-image-index))
                  <span style="color: #483d8b;">:onclick</span> (ps (previous-image) (<span style="color: #a020f0;">return</span> false))
                  <span style="color: #8b2252;">"Previous"</span>)
              <span style="color: #8b2252;">" "</span>
              (<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"?image=~a"</span> (elt images next-image-index))
                  <span style="color: #483d8b;">:onclick</span> (ps (next-image) (<span style="color: #a020f0;">return</span> false))
                  <span style="color: #8b2252;">"Next"</span>)
              ))))))

(restas:define-route x (<span style="color: #8b2252;">"/x"</span>)
  (slideshow-handler <span style="color: #8b2252;">"pic"</span>))

(restas:define-route z (<span style="color: #8b2252;">"/z"</span>)
  (slideshow-handler <span style="color: #8b2252;">"img"</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Отдельные технические вещи</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-0-1" class="outline-4">
<h4 id="sec-6-0-1"><span class="section-number-4">6.0.1</span> <span class="todo WAIT">WAIT</span> Обход дерева и извлечение узлов</h4>
<div class="outline-text-4" id="text-6-0-1">
<p>
Чтобы эффективнее (с точки зрения скорости написания кода) разбирать вакансии мы
разберем всю полученную страницу в дерево, из которого будем извлекать необходимые нам
элементы.
</p>

<p>
Чтобы делать это будем обходить дерево, сопоставляя каждый узел с предикатом, в который
скомпилируется образец. Начнем с обхода дерева, для этого напишем рекурсивную функцию
<code>match-tree</code>, которую определим с помощью <code>labels</code>, чтобы окружить ее формой <code>let</code>
с аккумулятором.
</p>

<p>
Определим параметры этой функции:
</p>
<ul class="org-ul">
<li><code>tree</code> - под-дерево, которое мы рекурсивно обходим
</li>
<li><code>predict</code> - функция-предикат, которая может совпасть с обходимым поддеревом
</li>
<li><code>if-match</code> - параметр чтобы иметь возможность передавать <code>стратегию</code>. Про стратегии
поговорим чуть позже.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_tree">(<span style="color: #a020f0;">labels</span> ((match-tree (tree f-predict <span style="color: #228b22;">&amp;optional</span> (if-match <span style="color: #483d8b;">:return-first-match</span>))
         (<span style="color: #a020f0;">cond</span> ((null tree) nil)
               ((atom tree) nil)
               (t
                &lt;&lt;cons&gt;&gt;))))
  &lt;&lt;call&gt;&gt;)
</pre>
</div>

<p>
Теперь переходим к рассмотрению плейсхолдера <code>cons</code>, который выполняет основную
работу. В первую очередь нам следует сравнить текущий узел с параметром <code>predict</code> и в
случае если <code>predict</code> вернул T - выполнить какие-то действия. В противном случае -
обрабатываем поддеревья этого узла.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cons">(<span style="color: #a020f0;">if</span> (funcall f-predict tree)
    &lt;&lt;match_ok&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="sub_trees">(cons
 (funcall #'match-tree (car tree) f-predict if-match)
 (funcall #'match-tree (cdr tree) f-predict if-match))
</pre>
</div>

<p>
<b>Теперь о стратегиях</b>
</p>

<p>
В случае, когда узел совпал с <code>predict</code> мы можем реализовать следующие стратегии:
</p>
<ul class="org-ul">
<li>Немедленно вернуть совпавший узел и более не обрабатывать никакие узлы.
</li>
<li>Прекратить обработку всех подузлов совпавшего узла, запомнить его и перейти к обработке
следующего за ним.
</li>
<li>Запомнить совпавший узел и продолжить обработку вглубь совпавшего узла, а затем и всех
остальных узлов.
</li>
<li>Наиболее общий вариант - применить к сопавшему узлу переданную лямбда-функцию, которая
может с ним что-то сделать - например записать в какую-нибудь переменную на более
высоком уровне.
</li>
</ul>
<p>
Реализуем эти стратегии друг за другом.
</p>

<p>
Реализуем выбор стратегии в общих чертах - будем использовать <code>cond</code> по параметру
<code>if-match</code>. В случае, если в этом параметре не лежит keyword symbol с именем стратегии -
считаем, что там функция, если это не так - сигнализируем ошибку
<code>strategy-not-implemented</code> (которая пока нигде не определена - я считаю что ее имя
говорит само за себя).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="match_ok">(<span style="color: #a020f0;">cond</span> ((equal if-match <span style="color: #483d8b;">:return-first-match</span>)
       &lt;&lt;return_first_match&gt;&gt;)
      ((equal if-match <span style="color: #483d8b;">:return-first-level-match</span>)
       &lt;&lt;return_first_level_match&gt;&gt;)
      ((equal if-match <span style="color: #483d8b;">:return-all-match</span>)
       &lt;&lt;return_all_match&gt;&gt;)
      ((equal 'function (type-of if-match))
       (funcall if-match tree))
      (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'strategy-not-implemented)))
</pre>
</div>

<p>
Теперь приступим к реализации (первой) стратегии: немедленного возврата совпавшего
узла. Для этого нам понадобится определить внешнюю функцию <code>tree-match</code>, чтобы
возвращаться из нее, а не из текущего рекурсивного вызова <code>match-tree</code>. Мы сделаем это
несколько позже, а пока заполним плейсхолдер <code>return-first-match</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_match">(<span style="color: #a020f0;">return-from</span> tree-match tree)
</pre>
</div>

<p>
Теперь переходим ко второй стратегии - прекратить обработку всех подузлов сопавшего
узла, запомнить его и перейти к обработке следующего за ним. Нам понадобится переменная
<code>collect</code> чтобы хранить значения, запомним это и реализуем добавление узла в нее. После
того, как узел сохранен, мы не проводим обработку его под-деревьев, а переходим в
следующему узлу этого уровня.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_level_match">(setf collect
      (append collect (list tree)))
</pre>
</div>

<p>
И наконец, реализуем последнюю оставшуюся стратегию, которая представляет из себя
расширение предыдущей, но с обработкой вложенных узлов. Так и запишем:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_all_match">(<span style="color: #a020f0;">progn</span>
    &lt;&lt;return_first_level_match&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<p>
Теперь нам осталось лишь правильно возвращать результат. Если используются
аккумулирующие стратегии, то мы возвращаем содержимое переменной <code>collect</code>, в случае
немедленного возврата совпавшего узла мы никогда не окажемся в этом месте, а в случае
передачи в <code>if-match</code> лямбда-фукции - мы будем считать, что она как-нибудь сама
заботится о передачи значений. Поэтому всегда будем возвращать <code>collect</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="call">(match-tree tree predict if-match)
collect
</pre>
</div>

<p>
Осталось обернуть это все во внешнюю функцию, с аккумулятором:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="tree_match">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tree-match</span> (tree predict <span style="color: #228b22;">&amp;optional</span> (if-match <span style="color: #483d8b;">:return-first-match</span>))
  (<span style="color: #a020f0;">let</span> ((collect))
    &lt;&lt;cond_tree&gt;&gt;))
</pre>
</div>

<p>
Но для удобной работы этого недостаточно, поэтому напишем компилер шаблона в
соответствующий ему <code>predict</code>. Этот компилер будет принимать в качестве параметра форму,
которая будет связываться с элементами шаблона с помощью <code>destructuring-bind</code>. Попытка
связывания будет проводиться для каждого элемента дерева. Ошибки, которые возникают в
случае невозможности связывания, игнорируются.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict</span> (pattern <span style="color: #228b22;">&amp;body</span> body)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `#'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
         (<span style="color: #a020f0;">handler-case</span>
             (<span style="color: #a020f0;">destructuring-bind</span> ,pattern
                 ,lambda-param
               ,@body)
           (sb-kernel::arg-count-error nil)
           (sb-kernel::defmacro-bogus-sublist-error nil)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(with-predict (a ((b c)) d &amp;rest e)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(aif (and (string= a "div")</span>
<span style="color: #b22222;">;;              </span><span style="color: #b22222;">(string= c "title b-vacancy-title"))</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(prog1 it</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(setf **a** a)</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(setf **b** b)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; #'(LAMBDA (LAMBDA-PARAM)</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(HANDLER-CASE</span>
<span style="color: #b22222;">;;            </span><span style="color: #b22222;">(DESTRUCTURING-BIND</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(A ((B C)) D &amp;REST E)</span>
<span style="color: #b22222;">;;                </span><span style="color: #b22222;">LAMBDA-PARAM</span>
<span style="color: #b22222;">;;              </span><span style="color: #b22222;">(AIF (AND (STRING= A "div") (STRING= C "title b-vacancy-title"))</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(PROG1 IT (SETF **A** A) (SETF **B** B))))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(SB-KERNEL::ARG-COUNT-ERROR NIL)</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(SB-KERNEL::DEFMACRO-BOGUS-SUBLIST-ERROR NIL))), T</span>
</pre>
</div>

<p>
Вот так, к примеру, это можно совместить с поиском по дереву:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(tree-match '(<span style="color: #8b2252;">"div"</span>
              ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>
                (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
                (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
                (<span style="color: #8b2252;">"table"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l"</span>))
                         (<span style="color: #8b2252;">"tr"</span> NIL
                               (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"colspan"</span> <span style="color: #8b2252;">"2"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))
                               (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))))))
              ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"g-round plus"</span>))`
              (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>))))
            (<span style="color: #a020f0;">with-predict</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
              (aif (and (stringp a)
                        (string= a <span style="color: #8b2252;">"class"</span>))
                   (<span style="color: #a020f0;">prog1</span> it
                     (setf **a** a)
                     (setf **b** b))))
            <span style="color: #483d8b;">:return-all-match</span>)
</pre>
</div>

<p>
Для еще большей лаконичности мы можем определить оборачивающий макрос, который позволит
нам не писать ничего, кроме условия в <code>aif</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict_if">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;with_predict&gt;&gt;

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict-if</span> (pattern <span style="color: #228b22;">&amp;body</span> condition)
  `(<span style="color: #a020f0;">with-predict</span> ,pattern
     (aif ,@condition
          (<span style="color: #a020f0;">prog1</span> it
            ,@(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                          `(setf ,(intern (format nil <span style="color: #8b2252;">"**~A**"</span> (symbol-name x))) ,x))
                      (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                     (or (equal x '<span style="color: #228b22;">&amp;rest</span>)
                                         (equal x '<span style="color: #228b22;">&amp;optional</span>)
                                         (equal x '<span style="color: #228b22;">&amp;body</span>)
                                         (equal x '<span style="color: #228b22;">&amp;key</span>)
                                         (equal x '<span style="color: #228b22;">&amp;allow-other-keys</span>)
                                         (equal x '<span style="color: #228b22;">&amp;environment</span>)
                                         (equal x '<span style="color: #228b22;">&amp;aux</span>)
                                         (equal x '<span style="color: #228b22;">&amp;whole</span>)
                                         (equal x '<span style="color: #228b22;">&amp;allow-other-keys</span>)))
                                 (alexandria:flatten pattern)))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(with-predict-if (a b &amp;rest c)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(and (stringp a)</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(string= a "class"))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (WITH-PREDICT (A B &amp;REST C)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(AIF (AND (STRINGP A) (STRING= A "class"))</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(PROG1 IT</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **A** A)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **B** B)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **C** C))))</span>
</pre>
</div>

<p>
Таким образом мы инжектируем переменные шаблона в глобальную область видимости, если они
не определены в более высокоуровневом <code>let</code>.
</p>

<p>
Теперь мы можем использовать <code>tree-match</code> так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(print
 (tree-match '(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>))
               (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
               (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
               (<span style="color: #8b2252;">"table"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l"</span>))
                (<span style="color: #8b2252;">"tbody"</span> NIL
                 (<span style="color: #8b2252;">"tr"</span> NIL
                       (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"colspan"</span> <span style="color: #8b2252;">"2"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>))
                             (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"employer-marks g-clearfix"</span>))
                                    (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"companyname"</span>))
                                           (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"hiringOrganization"</span>) (<span style="color: #8b2252;">"href"</span> <span style="color: #8b2252;">"/employer/1529644"</span>))
                                                <span style="color: #8b2252;">"&#1054;&#1054;&#1054; &#1053;&#1080;&#1084;&#1073;&#1083;"</span>))))
                       (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))))))
             (<span style="color: #a020f0;">with-predict-if</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
               (and (stringp a)
                    (string= a <span style="color: #8b2252;">"class"</span>)))
             <span style="color: #483d8b;">:return-all-match</span>))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (("class" "b-vacancy-custom g-round") ("class" "title b-vacancy-title")</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">("class" "l") ("class" "l-cell") ("class" "employer-marks g-clearfix")</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">("class" "companyname") ("class" "l-cell"))</span>

(print **b**)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; "l-cell"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-0-2" class="outline-4">
<h4 id="sec-6-0-2"><span class="section-number-4">6.0.2</span> <span class="todo WAIT">WAIT</span> Сопоставление и преобразование узлов</h4>
<div class="outline-text-4" id="text-6-0-2">
<p>
Разбирая вакансию мы должны извлечь несколько блоков:
</p>
<ul class="org-ul">
<li>блок заголовка
</li>
<li>общие данные, такие как уровень зарплаты, город, требуемый опыт работы
</li>
<li>собственно описание вакансии
</li>
</ul>
<p>
Из каждого блока будем извлекать конкретные данные, возвращаемы как plist.
</p>

<p>
Описание вакансии представляет из себя дерево, в котором нам важна структура, так как
требования, обязанности и прочее описываются списком. В этом списке много лишнего
форматирования, для удаления которого нам необходимо уметь преобразовывать дерево.
</p>

<p>
Напишем для этого рекурсивный преобразователь, который возвращает новое дерево,
рекурсивно вызывая аргумент <code>transformer</code> на <code>sub-tree</code>, которые удовлетворяют аргументу
<code>predicate</code>.
</p>

<p>
Аргумент <code>predicate</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает T или NIL
</p>

<p>
Аргумент <code>transformer</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает <code>atom</code> или <code>subtree</code> в первом параметре, а во втором может возвратить функцию
<code>control</code>. Если эта функция возвращена, тогда дерево возвращается с замененным
<code>transformer</code>-ом узлами по следующему алгоритму:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(funcall control
         #'(<span style="color: #a020f0;">lambda</span> (x)
             (maptree-if predicate transformer x))
         transformed-tree)
</pre>
</div>

<p>
В противном случае оно возвращается как есть.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree-if</span> (predicate transformer tree)
  (<span style="color: #a020f0;">multiple-value-bind</span> (t-tree control)
      (<span style="color: #a020f0;">if</span> (funcall predicate tree)
          (funcall transformer tree)
          (values tree #'mapcar))
    (<span style="color: #a020f0;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #a020f0;">lambda</span> (x)
                     (maptree-if predicate transformer x))
                 t-tree)
        t-tree)))
</pre>
</div>

<p>
Несколько примеров работы:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1053;&#1077;&#1088;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                `(pong ,@(cdr x)))
            '(<span style="color: #a020f0;">progn</span> (ping (ping (ping 1)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (PROGN (PONG (PING (PING 1))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1056;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                (values `(pong ,@(cdr x)) #'mapcar))
            '(<span style="color: #a020f0;">progn</span> (ping (ping (ping 1)))
              ping))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (PROGN (PONG (PONG (PONG 1))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1055;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1089;&#1086;&#1074;&#1084;&#1077;&#1089;&#1090;&#1085;&#1086; &#1089; with-predict-if &#1080; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;&#1084; **&#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1093;**</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (funcall (<span style="color: #a020f0;">with-predict-if</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
                                (and (equal b 'ping)))
                              x)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                (values `(,**a** pong ,@(cddr x)) #'mapcar))
            '(<span style="color: #a020f0;">progn</span> (ping (ping ping (ping 1)))
              ping))
</pre>
</div>

<p>
И макрос для более лаконичной записи того же:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict-maptree</span> (pattern condition replace tree)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `(maptree-if #'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
                     (and (consp ,lambda-param)
                        (funcall (<span style="color: #a020f0;">with-predict-if</span> ,pattern
                                   ,condition)
                                 ,lambda-param)))
                 ,replace
                 ,tree)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">'(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(and (equal b 'ping))</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">#'(lambda (x)</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">'(progn (ping (ping ping (ping 1))) ping)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(and (equal b 'ping))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">#'(lambda (x)</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">'(progn (ping (ping ping (ping 1))) ping))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Хотелки (набор несогласованных идей, чтобы не забыть)</h2>
<div class="outline-text-2" id="text-7">
<p>
Есть множество конкурирующих сайтов для поиска работы, информацию с которых
можно аггрегировать.
</p>

<p>
При поиске работы основной сценарий использования - <code>поиск вакансий</code>, и практически все
сайты его предоставляют. Однако мне бы хотелось дополнительно иметь дополнительный
функционал:
</p>

<ul class="org-ul">
<li>заметки по каждой вакансии
</li>
<li>статусы или теги, такие как:
<ul class="org-ul">
<li><code>просмотрено</code> (с датой),
</li>
<li><code>отобрано</code>,
</li>
<li><code>не-берут-трубку</code>,
</li>
<li><code>не-актуально</code>,
</li>
<li><code>приглашен-на-интервью</code>,
</li>
<li><code>выслали-тестовое-задание</code>,
</li>
<li><code>отправил-тестовое-задание</code>,
</li>
<li><code>получен-оффер</code>,
</li>
<li><code>вакансия-закрыта</code> итп.
</li>
</ul>
</li>
</ul>

<p>
Работодатель хочет подтверждения навыков соискателя - для этого и тестовые задания. Надо
автоматизировать этот момент - если соискатель заявляет, к примеру, знания С++ - он должен
сделать некий тестовый код.
</p>

<p>
Я бы хотел ранжировать вакансии вручную (по выставленным приоритетам) и автоматически
(т.е. скриптом), например в зависимости от зарплаты или удаленности.
</p>

<p>
Я бы хотел иметь возможность планировать маршрут, когда еду на собеседование и иметь
календарь, чтобы не пропустить встречу.
</p>

<p>
Я бы хотел иметь версии вакансий, чтобы отслеживать их изменения, например изменения
зарплаты до и после моего интервью - это позволит анализировать рынок и получать больше
информации.
</p>

<p>
Мне также интересно составлять профили компаний и отслеживать как меняется набор
сотрудников которых они ищут - это поможет планировать долгосрочную стратегию. Особенно в
этом плане интересны лидеры рынка - Яндекс, Гугл и.т.п.
</p>

<p>
Я бы хотел иметь возможность пообщаться с теми кто работал или работает в интересующей
меня компании, иметь подмножество функционала социальных сетей или интеграцию с ними
</p>

<p>
Иногда мне приятно работать с уже знакомыми людьми, так что в целом я бы не отказался
создавать на таком сайте что-то типа т.н. <code>рабочих коллективов</code>, чтобы наниматься сразу
командой. Возможно работодателям такой вариант найма тоже будет интересен.
</p>

<p>
В ряде случаев компании меняют свои вакансии, некоторые делают это методом удаления
предыдущей и создания новой. Мне как соискателю хотелось бы не обнаруживать уже
просмотренную и возможно собеседованную вакансию в новых. Поэтому хотелось бы
предусмотреть механизм, который связывает очень похожие вакансии друг с другом.
</p>

<p>
Иногда вакансии меняются, или в них меняются существенные условия. Например, две недели
назад, когда я смотрел вакансию из предыдущей сборки меня не устроила зарпалата, а
сегодня вакансия стала интереснее. Я хочу отслеживать что вакансия поменялась.
</p>

<p>
Таким образом при создании вакансии мы должны проверять, может она уже есть в базе и
тогда указывать, что эта вакансия включена в несколько сборок (требует таблицы связи)
</p>

<p>
Несколько вакансий могут быть от одной компании. В этом случае мне бы хотелось
отслеживать это в профиле компании, кроме того интересна аналитика по этой компании за
определенный период времени.
</p>

<p>
С социальной точки зрения интересно получать отзывы о компании от ее работников, в том
числе и уволенных.
</p>

<p>
Действия по вакансии: звонки, скайп-интервью, собеседования
</p>

<p>
В эту таблицу заносим что сделано по каждой вакансии, которая находится в разработке
</p>

<p>
Теги вакансий Помогают ориентироваться, когда вакансий много.
</p>

<p>
Важно: Для обеспечения социальных взаимодействий нужно предусмотреть, чтобы вакансию
можно было "передать", т.е. у нее минимум должен быть URI.
</p>

<p>
Если пользователь просмотрел вакансию, но пока не хочет отправлять отзыв - он может
добавить вакансию в закладки - в этом случае ее статус меняется на <code>favorited</code>
</p>

<p>
Из <code>favorited</code> мы снова можем отправить отзыв.
</p>

<p>
Из <code>favorited</code> пользователь может вернуть вакансию обратно в <code>interesting</code> или <code>hidden</code>.
</p>

<p>
Из <code>hidden</code> пользователь может вернуть вакансию в <code>interesting</code>.
</p>

<p>
Если по вакансии позвонили, пользователю обычно нужно ее быстро найти. Нужна форма поиска
по вакансиям в статусе <code>responded</code> - пользователь ищет обычно по названию фирмы.
</p>

<p>
После звонка вакансия может быть выкинута или переведена из <code>responded</code> в статус "был
телефонный звонок" - <code>called</code>. Выкидывая вакансию пользователь может выбрать reason - для
них можно будет потом сделать отдельную таблицу но пока просто пишем в поле
вакансии. Если в результате телефонного звонка была достигнута договоренность о
собеседовании - пользователь переводит вакансию в состояние "пригласили на интервью" -
<code>wait-interview</code> и заносит в вакансию данные о том, куда и во сколько ехать. Если по
телефону рекрутер предложил тестовое задание - статус - "ожидание тестового задания" -
<code>wait-test</code>. Если договорились о интервью по скайпу - "ожидание скайп-интервью" -
<code>wait-skype-interview</code>.
</p>

<p>
Получив тестовое задание пользователь переводит вакансию из статуса <code>wait-test</code> в
"выполнение тестового задания" <code>run-test</code>, а оттуда либо в <code>test-cancel</code> либо в
<code>test-sended</code>. Либо выкидывает.
</p>

<p>
Пользователи иногда забивают на интервью (случаются накладки) - в этом случае рекрутер
часто передоговаривается на другое время. Делать петли в графе значит излишне усложнять
его, наверно пусть можно будет просто изменить данные о времени интервью.
</p>

<p>
После интервью или скайп-интервью от вакансии можно либо отказаться (<code>refuse-employer</code>,
<code>refuse-applicant</code>) либо перевести в статус "ожидание результата" - <code>wait-result</code>. Нужно
включать таймер, по истечении которого напоминать пользователю позвонить рекрутеру и
узнать, как дела.
</p>

<p>
Иногда после скайп-интервью назначают очное интервью. Также бывает прямо на интервью
предлагают оффер - <code>offer</code> и соискатель берет время на подумать.
</p>

<p>
Из "ожидания результата" можно перескочить в "предложен оффер", "отказ работодателя" -
<code>refuse-employer</code> или "отказ соискателя" - <code>refuse-аpplicant</code>.
</p>

<p>
История статусов нужна, в нее нужно заносить время когда изменяется статус и возможно
примечания по изменению. Будет красиво, если в интерфейсе будет отображаться полный граф
статусов и текущее положение вакансии в нем.
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Процесс найма с т.з. соискателя</h3>
<div class="outline-text-3" id="text-7-1">
<p>
С точки зрения соискателя процесс найма выглядит так:
</p>

<ul class="org-ul">
<li>Этап составления резюме
</li>
<li>Этап опубликования резюме
</li>
<li>Этап поиска
<ul class="org-ul">
<li>Поиск и просмотр вакансий, отсев, ранжирование
</li>
<li>Рассылка откликов
</li>
</ul>
</li>
<li>Этап телефонных переговоров
<ul class="org-ul">
<li>Получение звонков, обсуждение деталей по телефону
</li>
<li>Договоренность о еще одном звонке
</li>
<li>Тестовое задание на почту
</li>
<li>Договоренность о skype-интервью
</li>
</ul>
</li>
<li>Этап удаленного тестирования
<ul class="org-ul">
<li>Skype-интервью
</li>
<li>Ожидание тестового задания
</li>
<li>Выполнение тестового задания
</li>
</ul>
</li>
<li>Этап очного собеседования
<ul class="org-ul">
<li>Приглашение на интервью
</li>
<li>Интервью
</li>
</ul>
</li>
<li>Этап отбора предложений
<ul class="org-ul">
<li>Получение предложений
</li>
<li>Выбор предложения
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Процесс найма с т.з. HR-а</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Когда HR-специалист ищет вакансии, он пользуется несколькими путями:
</p>
<ul class="org-ul">
<li>Личные знакомства
</li>
<li>Рекомендации
</li>
<li>Социальные сети
<ul class="org-ul">
<li>LinkedIn
</li>
<li>vkontakte
</li>
</ul>
</li>
<li>Помощь коллег
</li>
<li>Специализированные сайты
</li>
</ul>

<p>
Как правило, HR-специалист менее компетентен в предметной области, чем нанимаемый
сотрудник, поэтому для него имеет большой вес мнение рекомендателей и коллег
соискателя. Вероятно, рекомендательный сервис был бы очень актуален.
</p>

<p>
Компании-работодатели выбирают одну из моделей найма, в соответствии со своим бюджетом и
задачами:
</p>
<ul class="org-ul">
<li>Всегда (на любую позицию) нанимать (переманивать) лучших
</li>
<li>Нанимать начинающих в подчинение лучшим
</li>
<li>Нанимать начинающих (конвеерная разработка, большая текучка)
</li>
<li>Нанимать тех, кто понравится лидеру отдела
</li>
<li>Нанимать тех, кто лучше соответствует корпоративной культуре
</li>
</ul>

<p>
Для каждой из этих моделей характерны свои необходимые сервисы. К примеру, для модели
"нанимать лучших" совершенно необходимо вести и актуализировать базу этих "лучших", чтобы
вовремя сделать предложение кандидату. О примерах внедрения таких сервисов мне ничего не
известно. Также интересно уточнить у HR-специалистов из <code>разных</code> компаний их методы
работы.
</p>

<p>
Для HR-специалиста процесс найма выгядит (в общих чертах) так.
</p>

<ul class="org-ul">
<li>Этап составления вакансий
</li>
<li>Этап опубликования вакансий
</li>
<li>Этап поиска резюме
<ul class="org-ul">
<li>По ключевым словам
</li>
<li>По фильтру
</li>
<li>Используя автоподбор
</li>
</ul>
</li>
<li>Этап анализа откликов (неразобранные, подумать, приглашенные, отклоненные)
</li>
<li>Телефонный звонок соискателю (с целью уточнить детали или пригласить)
</li>
<li>Возможно отправка тестового задания
</li>
<li>Получение тестового задания
</li>
<li>Проверка тестового задания
</li>
<li>Скайп-интервью
</li>
<li>Этап собеседования
<ul class="org-ul">
<li>Опционально: заполнение анкеты
</li>
<li>Собеседование с HR-специалистом (об условиях)
</li>
<li>Тесты (например: на знание языка, ООП, БД, многопоточность)
</li>
<li>Тестовое задание
</li>
<li>Проверка тестового задания
</li>
<li>Собеседование с тех. спецом, (как правило нач. отдела)
</li>
</ul>
</li>
</ul>

<p>
HR-специалист анализирует обратную связь о составляемых им вакансиях - у него есть
статистическая информация о кол-ве просмотров вакансий и количестве поступивших
откликов. Из этих данных можно, например, сделать вывод, что предложенная зарплата
неактуальна на рынке.
</p>

<p>
Также HR-специалист заинтересован в технической поддержке при решении задач типа:
</p>
<ul class="org-ul">
<li>Мониторинг резюме (сообщения о обновлении резюме, просмотр старой версии)
</li>
<li>Ведение базы кандидатов (часто в экселе)
</li>
</ul>

<p>
HR-специалист заинтересован в том, чтобы иметь возможность построить процесс найма под
себя.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Тесты</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-lisp" id="hh_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; hh</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-test</span> ()
  &lt;&lt;hh_test_contents&gt;&gt;
  (dbg <span style="color: #8b2252;">"passed: hh-test~%"</span>))
(hh-test)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_test_contents"></pre>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Точки входа</h2>
<div class="outline-text-2" id="text-9">
<p>
Соберем шаблоны:
</p>

<div class="org-src-container">

<pre class="src src-closure-template-html" id="hh_tpl"><span style="color: #b22222;">// -*- mode: closure-template-html; fill-column: 140 -*-</span>
{<span style="color: #228b22; font-weight: bold;">namespace</span> <span style="color: #0000ff;">hhtpl</span>}

&lt;&lt;<span style="color: #0000ff;">hhtpl_contents</span>&gt;&gt;
</pre>
</div>

<p>
Скомпилируем шаблоны при подготовке модуля
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_prepare">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084; &#1096;&#1072;&#1073;&#1083;&#1086;&#1085;</span>
(closure-template:compile-template
 <span style="color: #483d8b;">:common-lisp-backend</span>
 (pathname
  (concatenate 'string *base-path* <span style="color: #8b2252;">"mod/hh/hh-tpl.htm"</span>)))
</pre>
</div>

<p>
Соберем контроллеры и все функции, которые контроллеры вызывают
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;tree_match&gt;&gt;

<span style="color: #b22222;">;; </span><span style="color: #b22222;">special syntax for pattern-matching</span>
(named-readtables:in-readtable <span style="color: #483d8b;">:fare-quasiquote</span>)

&lt;&lt;run&gt;&gt;

&lt;&lt;run_response&gt;&gt;

&lt;&lt;hh_fn_contents&gt;&gt;

&lt;&lt;_hh_parse&gt;&gt;

&lt;&lt;_hh_test&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Сборка</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Фунциональные утилиты</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;f_util_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-10-1-1" class="outline-4">
<h4 id="sec-10-1-1"><span class="section-number-4">10.1.1</span> Point-free определения:</h4>
<div class="outline-text-4" id="text-10-1-1">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define</span> (form* form)
  (<span style="color: #a020f0;">etypecase</span> form*
    (symbol (<span style="color: #a020f0;">etypecase</span> form
              <span style="color: #b22222;">;; </span><span style="color: #b22222;">alias for function or macro</span>
              (symbol `(<span style="color: #a020f0;">defmacro</span> ,form* (<span style="color: #228b22;">&amp;rest</span> args)
                         `(,',form ,@args)))
              <span style="color: #b22222;">;; </span><span style="color: #b22222;">alias for lambda</span>
              (cons   `(<span style="color: #a020f0;">defun</span> ,form* (<span style="color: #228b22;">&amp;rest</span> args)
                         (apply ,form args)))))
    (cons     <span style="color: #b22222;">;; </span><span style="color: #b22222;">scheme-like function definition</span>
     ` (<span style="color: #a020f0;">defun</span> ,(first form*) ,(rest form*)
         ,form))))
</pre>
</div>

<p>
Тут typecase используется до генерации кода - в зависимости от того символы или списки
связываются друг с другом генерируются различные определения. Можно определять
псевдонимы для функций и маросов, псевдоним будет макросом:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define head car)
(define tail cdr)
(define \\   lambda)
(define $    funcall)
</pre>
</div>

<p>
Можно определить функцию f2, которая является псевдонимом для лямбды, возвращённой
формой (f1 a1):
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define f2 (f1 a1))
(f2 a2) ~ (apply (f1 a1) a2)
</pre>
</div>

<p>
Простое определение функций в Scheme-стиле, более соответствующее представлению о
редукции форм:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (f1 a1) (f2 a2))
(f1 a1) ~ (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">f1</span> (a1) (f2 a2))
</pre>
</div>

<p>
Также, чтобы определять функции миксующую аргументы с другой функцией, можно ввести
такой макрос:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define*</span> (form* form)
  `(<span style="color: #a020f0;">defun</span> ,(first form*) ,(rest form*)
     (,(first form) ,@(rest form) ,@(rest form*))))
</pre>
</div>

<p>
Пример:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define* (f1 a1) (f2 a2))
(f1 a1) ~ (f2 a2 a1)
</pre>
</div>

<p>
Либо использовать карринг.
</p>
</div>
</div>

<div id="outline-container-sec-10-1-2" class="outline-4">
<h4 id="sec-10-1-2"><span class="section-number-4">10.1.2</span> Flip, карринг, композиции:</h4>
<div class="outline-text-4" id="text-10-1-2">
<p>
далее f, g, &#x2026; обозначают функции,
a, b, &#x2026; - их аргументы.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (self object) object)
(define (flip f)      (\\ (a b) ($ f b a)))
(define (curry f a)   (\\ (b)   ($ f a b)))
(define (curry* f g)  (\\ (a b) ($ f g a b)))
(define (compose f g) (\\ (a)   ($ f ($ g a))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-3" class="outline-4">
<h4 id="sec-10-1-3"><span class="section-number-4">10.1.3</span> Свёртки и "развёртки":</h4>
<div class="outline-text-4" id="text-10-1-3">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (foldl f a list)
    (<span style="color: #a020f0;">typecase</span> list
      (null a)
      (cons (foldl f ($ f a (head list)) (tail list)))))

(define (foldr f a list)
    (<span style="color: #a020f0;">typecase</span> list
      (null a)
      (cons ($ f (head list) (foldr f a (tail list))))))

(define (unfold f i p)
    (<span style="color: #a020f0;">if</span> ($ p i)
        (cons i '())
        (cons i (unfold f ($ f i) p))))

(define fold foldl)
(define my-reduce fold)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-4" class="outline-4">
<h4 id="sec-10-1-4"><span class="section-number-4">10.1.4</span> Отображения и фильтрации:</h4>
<div class="outline-text-4" id="text-10-1-4">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">map &amp; filter</span>
(define (my-map f list) (foldr (\\ (x y) (cons ($ f x) y)) '() list))
(define (filter p list) (foldr (\\ (x y) (<span style="color: #a020f0;">if</span> ($ p x) (cons x y) y)) '() list))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-5" class="outline-4">
<h4 id="sec-10-1-5"><span class="section-number-4">10.1.5</span> Функции для списков на основе карринга и свёрток:</h4>
<div class="outline-text-4" id="text-10-1-5">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for lists</span>
(define (my-list <span style="color: #228b22;">&amp;rest</span> objs)         objs)
(define (my-length list)             (fold (\\ (x y) (1+ x)) 0 list))
(define (my-reverse list)            (fold (flip 'cons) '() list))
(define (my-append list <span style="color: #228b22;">&amp;rest</span> lists) (fold (flip (curry* 'foldr 'cons)) list lists))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-6" class="outline-4">
<h4 id="sec-10-1-6"><span class="section-number-4">10.1.6</span> Функции для чисел:</h4>
<div class="outline-text-4" id="text-10-1-6">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for numbers</span>
(define zero?                    (curry '= 0))
(define positive?                (curry '&lt; 0))
(define negative?                (curry '&gt; 0))
(define (odd? number)            (= (mod number 2) 1))
(define (even? number)           (= (mod number 2) 0))
(define (my-max a <span style="color: #228b22;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #a020f0;">if</span> (&gt; y z) y z)) a numbers))
(define (my-min a <span style="color: #228b22;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #a020f0;">if</span> (&lt; y z) y z)) a numbers))
(define (summa <span style="color: #228b22;">&amp;rest</span> numbers)    (fold '+ 0 numbers))
(define (product <span style="color: #228b22;">&amp;rest</span> numbers)  (fold '* 1 numbers))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-7" class="outline-4">
<h4 id="sec-10-1-7"><span class="section-number-4">10.1.7</span> И для булевых чисел:</h4>
<div class="outline-text-4" id="text-10-1-7">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for booleans</span>
(define (my-and <span style="color: #228b22;">&amp;rest</span> list)   (fold 'and t list))
(define (my-or <span style="color: #228b22;">&amp;rest</span> list)    (fold 'or nil list))
(define (any? p <span style="color: #228b22;">&amp;rest</span> list)   (apply 'my-or (my-map p list)))
(define (every? p <span style="color: #228b22;">&amp;rest</span> list) (apply 'my-and (my-map p list)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-8" class="outline-4">
<h4 id="sec-10-1-8"><span class="section-number-4">10.1.8</span> Многие другие функции представляются свёртками, например:</h4>
<div class="outline-text-4" id="text-10-1-8">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">member &amp; assoc</span>
(<span style="color: #a020f0;">flet</span> ((helper (p op)
         (\\ (a next) (<span style="color: #a020f0;">if</span> (and (not a) ($ p ($ op next))) next a))))

  (define (my-member object list <span style="color: #228b22;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'self) nil list))

  (define (my-assoc object alist <span style="color: #228b22;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'car) nil alist)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-1-9" class="outline-4">
<h4 id="sec-10-1-9"><span class="section-number-4">10.1.9</span> Свёртки для деревьев:</h4>
<div class="outline-text-4" id="text-10-1-9">
<p>
Теперь, собственно, код для деревьев. Нужно заметить, что учитывая весь код для
"абстракций", получается существенно меньше, чем при реализации "в лоб" (как у Грэхама,
например).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">for (1 . (2 . 3)) trees</span>

(define (my-append a b)
    (append (<span style="color: #a020f0;">if</span> (atom a) (list a) a)
            (<span style="color: #a020f0;">if</span> (atom b) (list b) b)))

(define (fold-tree f g tree)
    (<span style="color: #a020f0;">typecase</span> tree
      (atom ($ f tree))
      (cons ($ g (fold-tree f g (head tree))
               (fold-tree f g (tail tree))))))

(define* (summa/tree tree) (fold-tree 'self '+))
(define* (depth/tree tree) (fold-tree 'one 'max+1))
(define* (flatten tree)    (fold-tree 'self 'my-append))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> Другие утилиты</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defun my-range (n)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let ((i 0))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">#'(lambda ()</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(if (&lt; i n) (incf i) nil))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(let ((f (my-range 3)))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(list</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(range 3)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defmacro do-closure ((i clos) &amp;body body)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let ((c (gensym)))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">`(let ((,c ,clos))</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(loop for ,i = (funcall ,c)</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">while ,i do ,@body))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(do-closure (i (my-range 100)) (print i))</span>


(<span style="color: #a020f0;">declaim</span> (<span style="color: #a020f0;">inline</span> zip))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">zip</span> (<span style="color: #228b22;">&amp;rest</span> args)
  <span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">Zips the elements of @arg{args}.</span>
<span style="color: #8b2252;">Example:</span>
<span style="color: #8b2252;">@lisp</span>
<span style="color: #8b2252;">&gt; (zip '(2 3 4) '(a b c) '(j h c s))</span>
<span style="color: #8b2252;">=&gt; ((2 A J) (3 B H) (4 C C))</span>
<span style="color: #8b2252;">@end lisp</span>
<span style="color: #8b2252;">"</span>
  (apply #'map 'list #'list args))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">symstuff</span> (l)
  <span style="color: #8b2252;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html</span>
<span style="color: #8b2252;">Helper function to (build-symbol)"</span>
  `(concatenate 'string
                ,@(for (x <span style="color: #483d8b;">:in</span> l)
                       (<span style="color: #a020f0;">cond</span> ((stringp x)
                              `',x)
                             ((atom x)
                              `',(format nil <span style="color: #8b2252;">"~a"</span> x))
                             ((eq (car x) '<span style="color: #483d8b;">:&lt;</span>)
                              `(format nil <span style="color: #8b2252;">"~a"</span> ,(cadr x)))
                             ((eq (car x) '<span style="color: #483d8b;">:++</span>)
                              `(format nil <span style="color: #8b2252;">"~a"</span> (incf ,(cadr x))))
                             (t
                              `(format nil <span style="color: #8b2252;">"~a"</span> ,x))))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">build-symbol</span> (<span style="color: #228b22;">&amp;rest</span> l)
  <span style="color: #8b2252;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html"</span>
  (<span style="color: #a020f0;">let</span> ((p (find-if (<span style="color: #a020f0;">lambda</span> (x) (and (consp x) (eq (car x) '<span style="color: #483d8b;">:package</span>)))
                    l)))
    (<span style="color: #a020f0;">cond</span> (p
           (setq l (remove p l))))
    (<span style="color: #a020f0;">let</span> ((pkg (<span style="color: #a020f0;">cond</span> ((eq (cadr p) 'nil)
                      nil)
                     (t `(find-package ',(cadr p))))))
      (<span style="color: #a020f0;">cond</span> (p
             (<span style="color: #a020f0;">cond</span> (pkg
                    `(values (intern ,(symstuff l) ,pkg)))
                   (t
                    `(make-symbol ,(symstuff l)))))
            (t
             `(values (intern ,(symstuff l))))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">remove-nth</span> (n seq)
  <span style="color: #8b2252;">"Remove nth element from sequence"</span>
  (remove-if (constantly t) seq <span style="color: #483d8b;">:start</span> n <span style="color: #483d8b;">:count</span> 1))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-hash</span> (<span style="color: #228b22;">&amp;rest</span> keyvals)
  <span style="color: #8b2252;">"Create a hash table given keys and values"</span>
  (plist-hash-table keyvals))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">make-hash*</span> (<span style="color: #228b22;">&amp;rest</span> keyvals)
  <span style="color: #8b2252;">"Make a hash table given key/value pairs, allowing use of prior key/val pairs in late r definitions"</span>
  (<span style="color: #a020f0;">loop</span> while keyvals
     for k = (intern (symbol-name (pop keyvals)))
     for v = (pop keyvals)
     collect `(,k ,v) into letargs
     collect (make-keyword k) into objargs
     collect k into objargs
     finally (<span style="color: #a020f0;">return</span>
               `(<span style="color: #a020f0;">let*</span> (,@letargs)
                  (make-hash ,@objargs)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maphash2</span> (fn ht)
  <span style="color: #8b2252;">"Returns a hash-table with the results of the function of key &amp; value as values"</span>
  (<span style="color: #a020f0;">let</span> ((ht-out (make-hash-table
                 <span style="color: #483d8b;">:test</span> (hash-table-test ht)
                 <span style="color: #483d8b;">:size</span> (hash-table-size ht)
                 <span style="color: #483d8b;">:rehash-size</span> (hash-table-rehash-size ht)
                 <span style="color: #483d8b;">:rehash-threshold</span> (hash-table-rehash-threshold ht))))
    (maphash #'(<span style="color: #a020f0;">lambda</span> (k v)
                 (setf (gethash k ht-out) (funcall fn k v)))
             ht)
    ht-out))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maphash-values2</span> (fn ht)
  <span style="color: #8b2252;">"Returns a hash-table with the results of the function of value as values"</span>
  (<span style="color: #a020f0;">let</span> ((ht-out (make-hash-table)))
    (maphash #'(<span style="color: #a020f0;">lambda</span> (k v) (setf (gethash k ht-out) (funcall fn v))) ht)
    ht-out))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">swap</span> (pl1 pl2)
  <span style="color: #8b2252;">"Macro to swap two places"</span>
  (<span style="color: #a020f0;">let</span> ((temp1-name (gensym)) <span style="color: #b22222;">; </span><span style="color: #b22222;">don't clobber existing names</span>
        (temp2-name (gensym)))
    `(<span style="color: #a020f0;">let</span> ((,temp1-name ,pl1)
           (,temp2-name ,pl2))
       (setf ,pl1 ,temp2-name)
       (setf ,pl2 ,temp1-name))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">print-hash-key-or-val</span> (kv stream)
  (format stream (<span style="color: #a020f0;">typecase</span> kv
                   (keyword <span style="color: #8b2252;">" :~a"</span>)
                   (string <span style="color: #8b2252;">" \"~a\""</span>)
                   (symbol <span style="color: #8b2252;">" '~a"</span>)
                   (list <span style="color: #8b2252;">" '~a"</span>)
                   (t <span style="color: #8b2252;">" ~a"</span>)) kv))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">printhash</span> (h <span style="color: #228b22;">&amp;optional</span> (stream t))
  <span style="color: #8b2252;">"Pretty print a hash table as :KEY VAL on separate lines"</span>
  (format stream <span style="color: #8b2252;">"#&lt;HASH-TABLE~{~a~a~^~&amp;~}&gt;"</span>
          (<span style="color: #a020f0;">loop</span> for k being the hash-keys in h using (hash-value v)
             collect (print-hash-key-or-val k nil)
             collect (print-hash-key-or-val v nil))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">lethash</span> (keys h <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Let form binding hash table entries to let variables names"</span>
  (<span style="color: #a020f0;">let</span> ((ht (gensym)))
    `(<span style="color: #a020f0;">let</span> ((,ht ,h))
       (<span style="color: #a020f0;">let</span> ,(<span style="color: #a020f0;">loop</span> for key in keys
                collect `(,key (gethash ,(make-keyword key) ,ht)))
         ,@body))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-keys</span> (keys h <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Make keys of hash table available to body for use &amp; changable via setf"</span>
  (<span style="color: #a020f0;">let</span> ((ht (gensym)))
    (<span style="color: #a020f0;">loop</span> for key in keys
       for newbody = (subst `(gethash ,(make-keyword key) ,ht) key body)
       then (subst `(gethash ,(make-keyword key) ,ht) key newbody)
       finally (<span style="color: #a020f0;">return</span> `(<span style="color: #a020f0;">let</span> ((,ht ,h))
                          ,@newbody)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">linear-interpolation</span> (ys xs x)
  <span style="color: #8b2252;">"Linear interpolation: calculate y(x) at x given table of ys and xs. Also returns ind ex of lookup table interval. Works from first x to less than last x."</span>
  (<span style="color: #a020f0;">let*</span> ((i (position x xs <span style="color: #483d8b;">:test</span> #'&gt;= <span style="color: #483d8b;">:from-end</span> t))
         (x0 (elt xs i))
         (x1 (elt xs (1+ i)))
         (y0 (elt ys i))
         (y1 (elt ys (1+ i))))
    (+ y0 (* (- y1 y0) (- x x0) (/ (- x1 x0))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree</span> (f tree)
  <span style="color: #8b2252;">"Map a function on the leaves of a tree"</span>
  (<span style="color: #a020f0;">cond</span>
    ((null tree) nil)
    ((atom tree) (funcall f tree))
    (t (cons (maptree f (car tree))
             (maptree f (cdr tree))))))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">diff</span> ((l list))
  <span style="color: #8b2252;">"Return list of the 1st differences of given list: l(1)-l(0),...,l(n)-l(n-1)"</span>
    (<span style="color: #a020f0;">loop</span> for i below (1- (length l))
       for li in l
       collect (- (elt l (1+ i)) li)))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">diff</span> ((v vector))
  <span style="color: #8b2252;">"Return vector of the 1st differences of given vector: v(1)-v(0),...,v(n)-v(n-1)"</span>
  (<span style="color: #a020f0;">let*</span> ((n (length v))
         (v2 (make-array (1- n))))
    (<span style="color: #a020f0;">dotimes</span> (i (1- n))
      (setf (aref v2 i) (- (aref v (1+ i)) (aref v i))))
    v2))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slot-ref</span> (obj slots)
  <span style="color: #8b2252;">"Reference nested objects by a list of successive slot names. For example, (slot-ref  o 'foo 'bar 'baz) should return (slot-value (slot-value (slot-value o 'foo) 'bar) 'baz) "</span>
  (<span style="color: #a020f0;">cond</span>
    ((atom slots) (slot-value obj slots))
    ((null (cdr slots)) (slot-value obj (car slots)))
    (t (slot-ref (slot-value obj (first slots)) (rest slots)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slot-ref-set</span> (obj slots val)
  <span style="color: #8b2252;">"Set nested object slot reference to new value"</span>
  (<span style="color: #a020f0;">cond</span>
    ((atom slots) (setf (slot-value obj slots) val))
    ((null (cdr slots)) (setf (slot-value obj (car slots)) val))
    (t (slot-ref-set (slot-value obj (first slots)) (rest slots) val))))

(<span style="color: #a020f0;">defsetf</span> <span style="color: #0000ff;">slot-ref</span> slot-ref-set)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">bind-nested-slots</span> (forms obj <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"For each form of (VAR SLOT1 SLOT2 ...) bind VAR to (NESTED-SLOT OBJ SLOT1 SLOT2 ...) "</span>
  `(<span style="color: #a020f0;">let</span> ,(<span style="color: #a020f0;">loop</span> for form in forms
            collect `(,(first form) (slot-ref ,obj ',(rest form))))
     ,@body))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">defpfun</span> (name args pargs <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Define pandoric function given name, arguments, pandoric arguments,</span>
<span style="color: #8b2252;">&amp; body forms."</span>
  `(setf (symbol-function ',name)
         (plambda ,args ,pargs
                  ,@body)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> Утилиты</h3>
<div class="outline-text-3" id="text-10-3">
<div class="org-src-container">

<pre class="src src-lisp" id="utility_file">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*user-agent*</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0"</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*cookies*</span>
  (list <span style="color: #8b2252;">"portal_tid=1291969547067-10909"</span>
        <span style="color: #8b2252;">"__utma=189530924.115785001.1291969547.1297497611.1297512149.377"</span>
        <span style="color: #8b2252;">"__utmc=3521885"</span>))

(setf *drakma-default-external-format* <span style="color: #483d8b;">:utf-8</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-headers</span> (referer)
  `(
    (<span style="color: #8b2252;">"Accept"</span> . <span style="color: #8b2252;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
    (<span style="color: #8b2252;">"Accept-Language"</span> . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
    (<span style="color: #8b2252;">"Accept-Charset"</span> . <span style="color: #8b2252;">"utf-8"</span>)
    (<span style="color: #8b2252;">"Referer"</span> . ,referer)
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">("Cookie" . ,(format nil "~{~a; ~}" *cookies*))</span>
    (<span style="color: #8b2252;">"Cookie"</span> . <span style="color: #8b2252;">"ad20c=2; ad17c=2; __utma=48706362.2093251633.1396569814.1413985658.1413990550.145; __utmz=48706362.1413926450.142.18.utmcsr=vk.com|utmccn=(referral)|utmcmd=referral|utmcct=/im; email=avenger-f%40yandex.ru; password=30e3465569cc7433b34d42baeadff18f; PHPSESSID=ms1rrsgjqvm3lhdl5af1aekvv0; __utmc=48706362; __utmb=48706362.5.10.1413990550"</span>)
    ))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">web</span> (to ot)
  (<span style="color: #a020f0;">let</span> ((x-to (append '(format nil) to))
        (x-ot (append '(format nil) ot)))
    `(<span style="color: #a020f0;">let</span> ((r (sb-ext:octets-to-string
               (drakma:http-request ,x-to
                                    <span style="color: #483d8b;">:user-agent</span> *user-agent*
                                    <span style="color: #483d8b;">:additional-headers</span> (get-headers ,x-ot)
                                    <span style="color: #483d8b;">:force-binary</span> t)
               <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>)))
       r)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">fnd</span> (var pattern)
  `(<span style="color: #a020f0;">multiple-value-bind</span> (all matches)
       (ppcre:scan-to-strings ,pattern ,var)
     (<span style="color: #a020f0;">let</span> ((str (format nil <span style="color: #8b2252;">"~a"</span> matches)))
       (subseq str 2 (- (length str) 1)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">merge-plists</span> (<span style="color: #228b22;">&amp;rest</span> plists)
  <span style="color: #8b2252;">"Merge all the given plists into a new plist. The new plist has all</span>
<span style="color: #8b2252;">the keys from each plist, with values of keys in later lists</span>
<span style="color: #8b2252;">overriding the values of the same keys in earlier plists.</span>
<span style="color: #8b2252;">No particular order of key/value pairs is guaranteed.</span>
<span style="color: #8b2252;">E.g.:</span>
<span style="color: #8b2252;">&gt; (merge-plists '(:a 1 :b 2) '(:a 3 :c 4) '(:d 5))</span>
<span style="color: #ff0000; font-weight: bold;">(</span><span style="color: #8b2252;">:D 5 :C 4 :A 3 :B 2)"</span>
(<span style="color: #a020f0;">let</span> ((result (copy-list (first plists))))
  (<span style="color: #a020f0;">dolist</span> (plist (rest plists))
    (<span style="color: #a020f0;">do*</span> ((prop (first plist) (first plist))
          (value (second plist) (second plist))
          (oldpl plist plist)
          (plist plist (cddr plist)))
         ((not oldpl))
      (setf (getf result prop) value)))
  result))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">eval-always</span>

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">eval-always</span> (<span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Wrap &lt;_:arg body /&gt; in &lt;_:fun eval-when /&gt; with all keys \(compile, load and execute) mentioned"</span>
  `(<span style="color: #a020f0;">eval-when</span> (<span style="color: #483d8b;">:compile-toplevel</span> <span style="color: #483d8b;">:load-toplevel</span> <span style="color: #483d8b;">:execute</span>)
     ,@body))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">#` syntax</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(eval-always</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(defun |#`-reader| (stream char arg)</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">"Literal syntax for zero/one/two argument lambdas.</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">Use @ as the function's argument, % as the second.</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">Examples:</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CL-USER&gt; #`(+ 2 @)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">\(lambda (&amp;optional x y)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(+ 2 x))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CL-USER&gt;  #`((1+ @) (print @))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">\(lambda (&amp;optional x y)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(1+ x)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(print x))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CL-USER&gt; #`(+ 1 2)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">\(lambda (&amp;optional x y)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(+ 1 2))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CL-USER&gt;  #`(+ @ %)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">\(lambda (&amp;optional x y)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(+ x y))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">"</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(declare (ignore char arg))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(let ((sexp (read stream t nil t))</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(x (gensym "X"))</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(y (gensym "Y")))</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">`(lambda (&amp;optional ,x ,y)</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(declare (ignorable ,x)</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(ignorable ,y))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">,@(subst y '%</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(subst x '@</span>
<span style="color: #b22222;">;;                          </span><span style="color: #b22222;">(if (listp (car sexp))</span>
<span style="color: #b22222;">;;                              </span><span style="color: #b22222;">sexp</span>
<span style="color: #b22222;">;;                              </span><span style="color: #b22222;">(list sexp)))))))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">;; set #`</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(set-dispatch-macro-character #\# #\` #'|#`-reader|))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">anaphoric</span>

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">if-it</span> (test then <span style="color: #228b22;">&amp;optional</span> else)
   <span style="color: #8b2252;">"Like IF. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">let</span> ((it ,test))
      (<span style="color: #a020f0;">if</span> it ,then ,else))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">when-it</span> (test <span style="color: #228b22;">&amp;body</span> body)
   <span style="color: #8b2252;">"Like WHEN. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">let</span> ((it ,test))
      (<span style="color: #a020f0;">when</span> it
        ,@body))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">and-it</span> (<span style="color: #228b22;">&amp;rest</span> args)
   <span style="color: #8b2252;">"Like AND. IT is bound to the value of the previous AND form."</span>
   (<span style="color: #a020f0;">cond</span> ((null args) t)
         ((null (cdr args)) (car args))
         (t `(<span style="color: #a020f0;">when-it</span> ,(car args) (and-it ,@(cdr args)))))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">dowhile-it</span> (test <span style="color: #228b22;">&amp;body</span> body)
   <span style="color: #8b2252;">"Like DOWHILE. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">do</span> ((it ,test ,test))
        ((not it))
      ,@body)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(eval-always</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(defmacro cond-it (&amp;body body)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">"Like COND. IT is bound to the passed COND test."</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">`(let (it)</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(cond</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">,@(mapcar #``((setf it ,(car @)) ,(cadr @))</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">;; uses the fact, that SETF returns the value set</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">body)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">maybe</span>

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">maybecall</span> (val <span style="color: #228b22;">&amp;rest</span> funs)
  `(and-it ,val
           ,@(mapcar (<span style="color: #a020f0;">lambda</span> (fun)
                       `(funcall ,fun it))
                     funs)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">maybe</span> (form)
  <span style="color: #8b2252;">"Return a value, returned by a &lt;_:arg form /&gt; or nil, if &lt;_:class error /&gt; is signalled"</span>
  `(<span style="color: #a020f0;">restart-case</span>
       (<span style="color: #a020f0;">handler-bind</span> ((<span style="color: #ff0000; font-weight: bold;">error</span> #'(<span style="color: #a020f0;">lambda</span> (c)
                                 (<span style="color: #a020f0;">declare</span> (ignore condition))
                                 (invoke-restart 'skip))))
         ,form)
     (skip () nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> Глобальные определения</h3>
<div class="outline-text-3" id="text-10-4">
<div class="org-src-container">

<pre class="src src-lisp" id="globals">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">clear db</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(drop '("profile" "vacancy"))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> Сущности и автоматы</h3>
<div class="outline-text-3" id="text-10-5">
<p>
Соберем все сущности и автоматы
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="entity_and_automates">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)
&lt;&lt;gen_automat(<span style="color: #8b2252;">"vacancy"</span>, <span style="color: #8b2252;">"&#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>, vacancy_flds, vacancy_state)&gt;&gt;
&lt;&lt;gen_automat(<span style="color: #8b2252;">"resume"</span>,  <span style="color: #8b2252;">"&#1088;&#1077;&#1079;&#1102;&#1084;&#1077;"</span>,   resume_flds,  vacancy_state)&gt;&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> <span class="todo TODO">TODO</span> TODO</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li>Нужно логгировать (run) и (run-response) с диффами
</li>
<li>Нужен анализ ошибок hh при send-respond (например: вакансия в архиве)
</li>
<li>Нужна привязка к роботу, который по таймеру вынимает данные из hh
</li>
<li>Нужна привязка работы к юзеру
</li>
<li>Поправить неправильное определение emp-name при анализе тизеров
</li>
<li>Подключать несколько hh-аккаунтов к одному профилю пользователя
</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2015-03-28 Сб. 08:06</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
