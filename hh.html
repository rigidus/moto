<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Модуль HeadHunter</title>
<!-- 2016-06-27 Пн. 15:20 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 87 -*- -->
<!-- org-toggle-inline-images -->

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Модуль HeadHunter</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Цель</a></li>
<li><a href="#sec-2">2. Что это такое?</a></li>
<li><a href="#sec-3">3. Сценарии использования</a>
<ul>
<li><a href="#sec-3-1">3.1. Сценарии использования соискателя</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. Составление резюме</a></li>
<li><a href="#sec-3-1-2">3.1.2. Опубликование резюме</a></li>
<li><a href="#sec-3-1-3">3.1.3. Автоматический поиск вакансий, создание правил отбора вакансий и автоматических действий над ними</a></li>
<li><a href="#sec-3-1-4">3.1.4. Поиск и просмотр вакансий, отсев, ранжирование, внесение заметок по вакансиям</a></li>
<li><a href="#sec-3-1-5">3.1.5. Нахождение вакансии в момент телефонного звонка</a></li>
<li><a href="#sec-3-1-6">3.1.6. Рассылка откликов</a></li>
<li><a href="#sec-3-1-7">3.1.7. Достижение договоренности о собеседовании</a></li>
<li><a href="#sec-3-1-8">3.1.8. Выполнение тестовых заданий</a></li>
<li><a href="#sec-3-1-9">3.1.9. Собеседование с работодателем и отзывы о собеседованиях</a></li>
<li><a href="#sec-3-1-10">3.1.10. Выбор лучшего предложения</a></li>
<li><a href="#sec-3-1-11">3.1.11. Вакансия становится неактуальной</a></li>
<li><a href="#sec-3-1-12">3.1.12. Отзывы соискателей о компаниях и вакансиях</a></li>
<li><a href="#sec-3-1-13">3.1.13. Маршрут</a></li>
<li><a href="#sec-3-1-14">3.1.14. Побочные сценарии соискателя</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. Сценарии использования работодателя</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. Составление вакансий</a></li>
<li><a href="#sec-3-2-2">3.2.2. Опубликование вакансий</a></li>
<li><a href="#sec-3-2-3">3.2.3. Автоматический поиск резюме, создание правил отбора резюме и автоматических действий над ними</a></li>
<li><a href="#sec-3-2-4">3.2.4. Ручной поиск и просмотр резюме, отсев, ранжирование, внесение заметок по соискателям</a></li>
<li><a href="#sec-3-2-5">3.2.5. Рассылка приглашений</a></li>
<li><a href="#sec-3-2-6">3.2.6. Телефонные интервью</a></li>
<li><a href="#sec-3-2-7">3.2.7. Заполнение анкеты</a></li>
<li><a href="#sec-3-2-8">3.2.8. Собеседование с соискателем</a></li>
<li><a href="#sec-3-2-9">3.2.9. Предложение соискателю тестовых заданий</a></li>
<li><a href="#sec-3-2-10">3.2.10. Проверка тестовых заданий</a></li>
<li><a href="#sec-3-2-11">3.2.11. Анализ статистических отчетов</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3. Хотелки (набор несогласованных идей, чтобы не забыть)</a></li>
<li><a href="#sec-3-4">3.4. <span class="todo nilTODO">TODO</span> TODO</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Как это работает?</a>
<ul>
<li><a href="#sec-4-1">4.1. Источник вакансий</a></li>
<li><a href="#sec-4-2">4.2. Фабрика генераторов вакансий</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. Построение URL-ов для скачивания тизеров (<code>make-hh-url</code>)</a></li>
<li><a href="#sec-4-2-2">4.2.2. Получение страниц (<code>hh-get-page</code>)</a></li>
<li><a href="#sec-4-2-3">4.2.3. Разбор тизеров вакансий (<code>hh-parse-vacancy-teasers</code>)</a></li>
<li><a href="#sec-4-2-4">4.2.4. Разбор вакансий (<code>hh-parse-vacancy</code>)</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. Правила обработки тизеров и вакансий</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1. Сущность правила (<code>entity:rule</code>)</a></li>
<li><a href="#sec-4-3-2">4.3.2. Правила отсева тизеров</a></li>
<li><a href="#sec-4-3-3">4.3.3. Правила анализа вакансий</a></li>
<li><a href="#sec-4-3-4">4.3.4. Извлечение правил</a></li>
</ul>
</li>
<li><a href="#sec-4-4">4.4. Процессор правил (<code>process</code>)</a></li>
<li><a href="#sec-4-5">4.5. Декоратор для process-teaser (<code>process-teaser :around</code>)</a></li>
<li><a href="#sec-4-6">4.6. Получение и обработка вакансий правилами (<code>run</code>)</a></li>
<li><a href="#sec-4-7">4.7. Сохранение вакансии и ее структура данных (<code>save-vacancy</code>)</a></li>
<li><a href="#sec-4-8">4.8. Состояния вакансий</a></li>
<li><a href="#sec-4-9">4.9. Печать вакансий (<code>show-vacancy</code>)</a></li>
<li><a href="#sec-4-10">4.10. <span class="todo nilSTART">START</span> Жизненный цикл резюме</a>
<ul>
<li><a href="#sec-4-10-1">4.10.1. <span class="todo nilTODO">TODO</span> Фото (<code>photo</code>)</a></li>
<li><a href="#sec-4-10-2">4.10.2. Имя, возраст, город (<code>personal</code>)</a></li>
<li><a href="#sec-4-10-3">4.10.3. Контакты (<code>contacts</code>)</a></li>
<li><a href="#sec-4-10-4">4.10.4. Желаемая должность и зарплата (<code>resume-position</code>)</a></li>
<li><a href="#sec-4-10-5">4.10.5. Образование (<code>education</code>)</a></li>
<li><a href="#sec-4-10-6">4.10.6. <span class="todo nilSTART">START</span> Опыт работы (<code>experience</code>)</a></li>
<li><a href="#sec-4-10-7">4.10.7. <span class="todo nilTODO">TODO</span> Публикация (<code>touch</code>)</a></li>
<li><a href="#sec-4-10-8">4.10.8. <span class="todo nilTODO">TODO</span> Удаление резюме</a></li>
</ul>
</li>
<li><a href="#sec-4-11">4.11. <span class="todo nilTODO">TODO</span> Синхронизация резюме на hh и в хранилище</a>
<ul>
<li><a href="#sec-4-11-1">4.11.1. Парсер резюме в личном кабинете</a></li>
</ul>
</li>
<li><a href="#sec-4-12">4.12. Создание резюме под вакасию по шаблону</a>
<ul>
<li><a href="#sec-4-12-1">4.12.1. Сущности шаблона резюме</a></li>
</ul>
</li>
<li><a href="#sec-4-13">4.13. <span class="todo nilTODO">TODO</span> Сущность резюме соискателя (<code>entity:resume</code>)</a></li>
<li><a href="#sec-4-14">4.14. <span class="todo nilTODO">TODO</span> Вспомогательные сущности резюме</a>
<ul>
<li><a href="#sec-4-14-1">4.14.1. Основное образование</a></li>
<li><a href="#sec-4-14-2">4.14.2. Иностранные языки</a></li>
<li><a href="#sec-4-14-3">4.14.3. Опыт работы</a></li>
<li><a href="#sec-4-14-4">4.14.4. Ключевые навыки</a></li>
<li><a href="#sec-4-14-5">4.14.5. Рекоммендации</a></li>
<li><a href="#sec-4-14-6">4.14.6. Портфолио</a></li>
</ul>
</li>
<li><a href="#sec-4-15">4.15. Отправка отклика (<code>send-respond</code>)</a></li>
<li><a href="#sec-4-16">4.16. Фабрика генераторов отзывов (<code>response-factory</code>)</a>
<ul>
<li><a href="#sec-4-16-1">4.16.1. Разбор отзыва (<code>process-respond</code>)</a></li>
<li><a href="#sec-4-16-2">4.16.2. Разбор откликов (<code>hh_parse_responds</code>)</a></li>
</ul>
</li>
<li><a href="#sec-4-17">4.17. Получение и обработка отзывов (<code>run-response</code>)</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Interface</a>
<ul>
<li><a href="#sec-5-1">5.1. Главная страница модуля</a></li>
<li><a href="#sec-5-2">5.2. Страница списка вакансий</a></li>
<li><a href="#sec-5-3">5.3. Страница вакансии</a></li>
<li><a href="#sec-5-4">5.4. Страница правил</a></li>
<li><a href="#sec-5-5">5.5. Страница правила</a></li>
<li><a href="#sec-5-6">5.6. Страница документации модуля</a></li>
<li><a href="#sec-5-7">5.7. Страница поиска</a></li>
<li><a href="#sec-5-8">5.8. Галлерея (parenscript)</a></li>
<li><a href="#sec-5-9">5.9. <span class="todo nilTODO">TODO</span> Тестовая страница</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Тесты</a></li>
<li><a href="#sec-7">7. Точки входа</a></li>
<li><a href="#sec-8">8. Сборка</a>
<ul>
<li><a href="#sec-8-1">8.1. Макроутилиты</a></li>
<li><a href="#sec-8-2">8.2. Фунциональные утилиты</a>
<ul>
<li><a href="#sec-8-2-1">8.2.1. Point-free определения:</a></li>
<li><a href="#sec-8-2-2">8.2.2. Flip, карринг, композиции:</a></li>
<li><a href="#sec-8-2-3">8.2.3. Свёртки и "развёртки":</a></li>
<li><a href="#sec-8-2-4">8.2.4. Отображения и фильтрации:</a></li>
<li><a href="#sec-8-2-5">8.2.5. Функции для списков на основе карринга и свёрток:</a></li>
<li><a href="#sec-8-2-6">8.2.6. Функции для чисел:</a></li>
<li><a href="#sec-8-2-7">8.2.7. И для булевых чисел:</a></li>
<li><a href="#sec-8-2-8">8.2.8. Многие другие функции представляются свёртками, например:</a></li>
<li><a href="#sec-8-2-9">8.2.9. Свёртки для деревьев:</a></li>
</ul>
</li>
<li><a href="#sec-8-3">8.3. Другие утилиты</a></li>
<li><a href="#sec-8-4">8.4. Утилиты</a></li>
<li><a href="#sec-8-5">8.5. Глобальные определения</a></li>
<li><a href="#sec-8-6">8.6. Сущности и автоматы</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Lisp</a></li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Цель</h2>
<div class="outline-text-2" id="text-1">
<p>
Мы все ищем работу на профильных сайтах время от времени. Иногда на это уходит
значительное время, т.к. мы выполняем множество рутинных действий, которых могли бы
избежать. Попробуем автоматизировать этот процесс, так чтобы работа, по-возможности,
искалась сама, без непосредственного участия соискателя.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Что это такое?</h2>
<div class="outline-text-2" id="text-2">
<p>
Это средство автоматизации процесса поиска работы, выполненное в форме экспертной
системы. Оно умеет обучаться при взаимодействия со своим пользователем. Обучение
производится с помощью внесения пользователем правил обработки входящего потока вакансий.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Сценарии использования</h2>
<div class="outline-text-2" id="text-3">
<p>
Если рассматривать поиск работы как бизнес-процесс, то в этом процессе я выступаю как
соискатель. А если с точки зрения data-flow - то обьектом манипуляций является <code>вакансия</code>,
которая (с моей точки зрения, как соискателя) может находится в нескольких <code>состояниях</code>:
</p>
<ul class="org-ul">
<li>неотсортирована
</li>
<li>неинтересная
</li>
<li>интересная
</li>
<li>отправлен отзыв (мной)
</li>
<li>отзыв просмотрен (работодателем)
</li>
<li>работодатель отказал
</li>
<li>работодатель пригласил на интервью
</li>
<li>прохождение интервью (там возможны тестовые задания)
</li>
<li>получено предложение работы
</li>
</ul>

<p>
Состояния образуют ориентированный граф, а множество вакансий в состояниях после "отзыв
отправлен" - фронт работ, в котором понятно что нужно делать по каждой вакансии. Ну а
интерфейс обеспечивает доступ к выборкам вакансий и действиям над ними.
</p>

<p>
Если по графу понятно какие возможны действия по каждой вакансии, то часть их можно
автоматизировать - например, т.н. "преселект", когда мы выкидываем вакансии, которые
соискателю заведомо неинтересны (например: отбросить вакансии с неподходящими требованиями
или вакансии без указания зарплаты). Или можно анализировать текст вакансии, и если стек
технологий, оплата и месторасположение устраивает - автоматически отправлять отзыв.
</p>

<p>
Вакансии, как правило, пишутся довольно формальным языком, в них всегда есть раздел
"Требования", "Будет плюсом", "Условия" и т.п. поэтому это не так сложно. От
пользователя-соискателя в этом случае требуется только узнать о том, что его пригласили на
собеседование, ну и пройти его, конечно.
</p>

<p>
Работу работодателя можно автоматизировать похожим образом. С той лишь разницей, что
работодатель осуществляет операции над отзывом соискателя, к которому прикреплено резюме и
другие личные данные соискателя. Этот отзыв может находится в таких состояниях:
</p>
<ul class="org-ul">
<li>непросмотрен
</li>
<li>неинтересный
</li>
<li>интересный
</li>
<li>отправлено приглашение
</li>
<li>приглашение просмотрено
</li>
<li>отправлено тестовое задание
</li>
<li>получено решение тестового задания, но оно еще не проверено
</li>
<li>назначено собеседование
</li>
<li>сделано предложение (с такими-то условиями)
</li>
<li>предложение принято (вакансия закрыта)
</li>
<li>предложение не принято
</li>
</ul>

<p>
Исходя из всего этого, мы можем написать в первую очередь поддержку сценариев
использования для соискателя, а потом и работодателя:
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Сценарии использования соискателя</h3>
<div class="outline-text-3" id="text-3-1">
<p>
С точки зрения соискателя процесс найма выглядит так:
</p>

<ul class="org-ul">
<li>Этап составления резюме
</li>
<li>Этап опубликования резюме
</li>
<li>Этап поиска
<ul class="org-ul">
<li>Поиск и просмотр вакансий, отсев, ранжирование
</li>
<li>Рассылка откликов
</li>
</ul>
</li>
<li>Этап телефонных переговоров
<ul class="org-ul">
<li>Получение звонков, обсуждение деталей по телефону
</li>
<li>Договоренность о еще одном звонке
</li>
<li>Тестовое задание на почту
</li>
<li>Договоренность о skype-интервью
</li>
</ul>
</li>
<li>Этап удаленного тестирования
<ul class="org-ul">
<li>Skype-интервью
</li>
<li>Ожидание тестового задания
</li>
<li>Выполнение тестового задания
</li>
</ul>
</li>
<li>Этап очного собеседования
<ul class="org-ul">
<li>Приглашение на интервью
</li>
<li>Интервью
</li>
</ul>
</li>
<li>Этап отбора предложений
<ul class="org-ul">
<li>Получение предложений
</li>
<li>Выбор предложения
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> Составление резюме</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Пользователь просто размещает свое резюме. На самом деле - несколько резюме, так как
наиболее продвинутые пользователи пишут резюме под вакансию, а не рассылают одно и то же
резюме всем подряд.
</p>

<p>
Необходимо дать возможность прикреплять резюме к вакансиям и назначать правила отправки
для конкретного резюме. Т.е. к резюме прикрепляются правила обработки вакансий, которые
решают, будет ли оно отправлено работодателю.
</p>

<p>
Необходимо иметь возможность персонализировать резюме под вакансию. Простейший пример -
адаптировать желаемую оплату под максимальную, которую предлагает вакансия.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> Опубликование резюме</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Автоматическое на всех необходимых сайтах. Здесь надо учитывать правила опубликования и
обрабатывать возможные возникающие ошибки.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3"><span class="section-number-4">3.1.3</span> Автоматический поиск вакансий, создание правил отбора вакансий и автоматических действий над ними</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Внутри вакансий необходимо искать по критериям, которые пользователь может задавать сам,
в форме правил, выполняющих действия над вакансией, если она совпадает с правилом.
</p>

<p>
Вакансии полезно упорядочить по зарплате
</p>

<p>
Мне бы хотелось сразу получать представление, насколько свежая вакансия. Наиболее
наглядно это делает интерактивный график.
</p>

<p>
Мне было бы интересно, сколько интервью было проведено и запланировано по вакансии - эту
информацию можно узнать из анализа активности по ней других пользователей.
</p>

<p>
Мне было бы интересно, как менялась вакансия с момента ее размещения компанией. К примеру
можно находить и отслеживать похожие вакансии по расстоянию Левенштейна. Динамика
изменения зарплатного предложения может многое сказать об отношении к вакансии.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-4" class="outline-4">
<h4 id="sec-3-1-4"><span class="section-number-4">3.1.4</span> Поиск и просмотр вакансий, отсев, ранжирование, внесение заметок по вакансиям</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
Когда я читаю вакансию, я бы хотел, чтобы она переходила в статус "просмотрено" (и к ней
добавлялась дата просмотра)
</p>

<p>
Читая вакансию, мне бы хотелось устанавливать ей приоритет и вносить заметки, чтобы
отслеживать такие моменты, как например: необходимость позвонить позже, или все, что мне
сказал hr по телефону.
</p>

<p>
Если я отправляю отзыв на вакансию или звоню по телефону - я бы хотел, чтобы эти действия
сопровождались временем и изменением статуса, чтобы потом можно было отследить историю
взаимодействия с HR.
</p>

<p>
При этом, мне хотелось бы видеть на дашборде те вакансии, с которыми я договорился о
встрече и те, по которым нет движения долгое время, чтобы ничего не забывалось.
</p>

<p>
Я хочу получать напоминания о моем следующем шаге в отношении тех вакансий,
которые мне интересны.
</p>

<p>
Мне бы хотелось видеть на каком я этапе в тех вакансиях, которые меня интересуют.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-5" class="outline-4">
<h4 id="sec-3-1-5"><span class="section-number-4">3.1.5</span> Нахождение вакансии в момент телефонного звонка</h4>
<div class="outline-text-4" id="text-3-1-5">
<p>
После отправки отклика звонит работодатель и приглашает на интервью. В этот момент я хочу
найти эту вакансию, и в зависимости от того до чего мы договорились с работодателем
выставить ей некоторое состояние или внести заметки, поставить тег, и.т.п.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-6" class="outline-4">
<h4 id="sec-3-1-6"><span class="section-number-4">3.1.6</span> Рассылка откликов</h4>
<div class="outline-text-4" id="text-3-1-6">
<p>
Соискатель пишет шаблоны сопроводительных писем, которые будут отправлены вместе с
отзывом на вакансию
</p>
</div>
</div>

<div id="outline-container-sec-3-1-7" class="outline-4">
<h4 id="sec-3-1-7"><span class="section-number-4">3.1.7</span> Достижение договоренности о собеседовании</h4>
<div class="outline-text-4" id="text-3-1-7">
<p>
В ряде случаев информация о собеседовании может прийти на email пользователя. Это
позволяет вообще исключить человека из этого сценария - единственное что необходимо -
уведомить о созданной встрече, добавив ее в календарь.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-8" class="outline-4">
<h4 id="sec-3-1-8"><span class="section-number-4">3.1.8</span> Выполнение тестовых заданий</h4>
<div class="outline-text-4" id="text-3-1-8">
<p>
Обычно работодатель не слишком заморачивается тестовыми заданиями. Пользователь,
выполнивший тестовое задание, может сохранить его, привязав к вакансии. За это ему можно
начислять баллы или иным способом поощрять.
</p>

<p>
Таким образом с вакансиями можно связывать тестовые задания и их решения, что упрощает
прохождение собеседований. За такую информацию пользователь может платить (балламы или
иным способом)
</p>
</div>
</div>

<div id="outline-container-sec-3-1-9" class="outline-4">
<h4 id="sec-3-1-9"><span class="section-number-4">3.1.9</span> Собеседование с работодателем и отзывы о собеседованиях</h4>
<div class="outline-text-4" id="text-3-1-9">
<p>
После прохождения собеседования пользователь мог бы оставлять отзыв. Другие пользователи
могли бы оценивать качество отзыва
</p>
</div>
</div>

<div id="outline-container-sec-3-1-10" class="outline-4">
<h4 id="sec-3-1-10"><span class="section-number-4">3.1.10</span> Выбор лучшего предложения</h4>
<div class="outline-text-4" id="text-3-1-10">
<p>
Пользователи могли бы использовать интерфейсы к методам многофакторного анализа (симплекс
метод, дерево принятия решений) чтобы определить лучшее предложение.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-11" class="outline-4">
<h4 id="sec-3-1-11"><span class="section-number-4">3.1.11</span> Вакансия становится неактуальной</h4>
<div class="outline-text-4" id="text-3-1-11">
<p>
Вакансия может стать неактуальной если работодатель снимет ее, но работодатели могут
забывать это сделать, поэтому можно предусмотреть тайм-аут.
</p>

<p>
Вакансия также может сниматься по достижению некоторого кол-ва голосов соискателей,
которые дозвонились но им сказали, что вакансия уже неактуальна.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-12" class="outline-4">
<h4 id="sec-3-1-12"><span class="section-number-4">3.1.12</span> Отзывы соискателей о компаниях и вакансиях</h4>
<div class="outline-text-4" id="text-3-1-12">
<p>
Можно сэкономить кучу времени и денег просто не нанимаясь в те компании, в которых "все
плохо". В этом плане соискатели могут помочь друг другу. Возможно и компании тоже будут
прислушиваться к такому фидбеку.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-13" class="outline-4">
<h4 id="sec-3-1-13"><span class="section-number-4">3.1.13</span> Маршрут</h4>
<div class="outline-text-4" id="text-3-1-13">
<p>
Иногда я хочу спланировать маршрут поездки по собеседованиям. Это сервис с картами,
которые можно сделать позже.
</p>

<p>
Полезно распечтывать карты, соответствующие вакансиям
</p>
</div>
</div>

<div id="outline-container-sec-3-1-14" class="outline-4">
<h4 id="sec-3-1-14"><span class="section-number-4">3.1.14</span> Побочные сценарии соискателя</h4>
<div class="outline-text-4" id="text-3-1-14">
<p>
Вакансии на сайтах размещаются <code>компаниями</code> и привязываются к ним. Мне, как соискателю,
интересно посмотреть какие вакансии размещала ранее конкретная компания, какие она
размещает теперь, как изменялись зарплаты - и тому подобная аналитическая информация.
</p>

<p>
Я также хочу чтобы система проходила по вакансиям и в зависимости от сочетания условий
выполняла какие-то действия
</p>
<ul class="org-ul">
<li>напоминание мне о собеседованиях, звонках (календарь)
</li>
<li>автоматическое ранжирование вакансий (по перспективам найма, зарплате и.т.п)
</li>
</ul>

<p>
Система может анализировать компании с т.з. выставляемых вакансий и формирует профиль
компании. По выставляемым вакансиям можно сделать интересные выводы - например когда у
компании внезапно появляются вакансии на одного сеньера и нескольких линейных
разработчиков - это напоминает открытие нового отдела/проекта.
</p>

<p>
Система может классифицировать сохраненные вакансии по формальным признакам, таким как:
</p>
<ul class="org-ul">
<li>новые вакансии
</li>
<li>измененные
</li>
<li>закрытые (о закрытости вакансии можно судить по ряду критериев)
</li>
<li>особенно интересные
</li>
<li>необычные
</li>
</ul>

<p>
В случае изменений или появления новых интересующих пользователя вакансий можно
пользователю отправляеть уведомление (через систему очередей сообщений и по email).
</p>

<p>
Исходя из анализа DESCRIPTION можно определить требуемую технологию и требуемую степень
владения ею.
</p>

<p>
Еще можно сделать:
</p>

<p>
Предоставление рекомендаций и отбор вакансий на основе модифицируемых правил и фактах
предметной области, таких как "работодатель - компания по разработке ПО" или "ИТ-поддержка
не является приоритетом компании"
</p>

<p>
Предсказание поведения (путей достижения целей) компании (в процессе найма и вне его) на
основе моделей и целей.
</p>

<p>
Выбор вариантов поведения в ответ на предьявляемые требования (цикл распознавание-действие
в продукционной системе). Вплоть до автоматического построния резюме под вакансию из шаблонов.
</p>

<p>
Построение концептуальных моделей и преобразования в них - выбор стратегии действий и
постановка целей.
</p>

<p>
Выбор способа представления знаний (правила, фреймы, концептуальные графы)
</p>

<p>
Выбор стратегии поиска
</p>

<p>
Включение терма из набора технологий в заголовке вакансии - присвоение классификатора
(тега)
</p>

<p>
Правила вывода - сопоставление с профилем
</p>

<p>
Вычисление различий (дифф) требований вакансии и профильных навыков резюме - подбор или
построение оптимального резюме
</p>

<p>
Интерактивное построение профиля (ответы на вопросы). Необходим видимый прогресс и
предварительная классификация предложений
</p>

<p>
Построение новых правил на основе известных
</p>

<p>
Когда вакансия переносится в архив - мы должны отслеживать это на стороннем сайте и
реагировать, устанавливая статус <code>archive</code>
</p>

<p>
Когда мы собираем вакансии, распарсивая их с других сайтов, мы должны отслеживать их
состояние на этих сайтах.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Сценарии использования работодателя</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Когда HR-специалист ищет вакансии, он пользуется несколькими путями:
</p>
<ul class="org-ul">
<li>Личные знакомства
</li>
<li>Рекомендации
</li>
<li>Социальные сети
<ul class="org-ul">
<li>LinkedIn
</li>
<li>vkontakte
</li>
</ul>
</li>
<li>Помощь коллег
</li>
<li>Специализированные сайты
</li>
</ul>

<p>
Как правило, HR-специалист менее компетентен в предметной области, чем нанимаемый
сотрудник, поэтому для него имеет большой вес мнение рекомендателей и коллег
соискателя. Вероятно, рекомендательный сервис был бы очень актуален.
</p>

<p>
Компании-работодатели выбирают одну из моделей найма, в соответствии со своим бюджетом и
задачами:
</p>
<ul class="org-ul">
<li>Всегда (на любую позицию) нанимать (переманивать) лучших
</li>
<li>Нанимать начинающих в подчинение лучшим
</li>
<li>Нанимать начинающих (конвеерная разработка, большая текучка)
</li>
<li>Нанимать тех, кто понравится лидеру отдела
</li>
<li>Нанимать тех, кто лучше соответствует корпоративной культуре
</li>
</ul>

<p>
Для каждой из этих моделей характерны свои необходимые сервисы. К примеру, для модели
"нанимать лучших" совершенно необходимо вести и актуализировать базу этих "лучших", чтобы
вовремя сделать предложение кандидату. О примерах внедрения таких сервисов мне ничего не
известно. Также интересно уточнить у HR-специалистов из <code>разных</code> компаний их методы
работы.
</p>

<p>
Для HR-специалиста процесс найма выгядит (в общих чертах) так.
</p>

<ul class="org-ul">
<li>Этап составления вакансий
</li>
<li>Этап опубликования вакансий
</li>
<li>Этап поиска резюме
<ul class="org-ul">
<li>По ключевым словам
</li>
<li>По фильтру
</li>
<li>Используя автоподбор
</li>
</ul>
</li>
<li>Этап анализа откликов (неразобранные, подумать, приглашенные, отклоненные)
</li>
<li>Телефонный звонок соискателю (с целью уточнить детали или пригласить)
</li>
<li>Возможно отправка тестового задания
</li>
<li>Получение тестового задания
</li>
<li>Проверка тестового задания
</li>
<li>Скайп-интервью
</li>
<li>Этап собеседования
<ul class="org-ul">
<li>Опционально: заполнение анкеты
</li>
<li>Собеседование с HR-специалистом (об условиях)
</li>
<li>Тесты (например: на знание языка, ООП, БД, многопоточность)
</li>
<li>Тестовое задание
</li>
<li>Проверка тестового задания
</li>
<li>Собеседование с тех. спецом, (как правило нач. отдела)
</li>
</ul>
</li>
</ul>

<p>
HR-специалист анализирует обратную связь о составляемых им вакансиях - у него есть
статистическая информация о кол-ве просмотров вакансий и количестве поступивших
откликов. Из этих данных можно, например, сделать вывод, что предложенная зарплата
неактуальна на рынке.
</p>

<p>
Также HR-специалист заинтересован в технической поддержке при решении задач типа:
</p>
<ul class="org-ul">
<li>Мониторинг резюме (сообщения о обновлении резюме, просмотр старой версии)
</li>
<li>Ведение базы кандидатов (часто в экселе)
</li>
</ul>

<p>
HR-специалист заинтересован в том, чтобы иметь возможность построить процесс найма под
себя.
</p>
</div>

<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> Составление вакансий</h4>
</div>
<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Опубликование вакансий</h4>
</div>
<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> Автоматический поиск резюме, создание правил отбора резюме и автоматических действий над ними</h4>
</div>
<div id="outline-container-sec-3-2-4" class="outline-4">
<h4 id="sec-3-2-4"><span class="section-number-4">3.2.4</span> Ручной поиск и просмотр резюме, отсев, ранжирование, внесение заметок по соискателям</h4>
</div>
<div id="outline-container-sec-3-2-5" class="outline-4">
<h4 id="sec-3-2-5"><span class="section-number-4">3.2.5</span> Рассылка приглашений</h4>
</div>
<div id="outline-container-sec-3-2-6" class="outline-4">
<h4 id="sec-3-2-6"><span class="section-number-4">3.2.6</span> Телефонные интервью</h4>
</div>
<div id="outline-container-sec-3-2-7" class="outline-4">
<h4 id="sec-3-2-7"><span class="section-number-4">3.2.7</span> Заполнение анкеты</h4>
</div>
<div id="outline-container-sec-3-2-8" class="outline-4">
<h4 id="sec-3-2-8"><span class="section-number-4">3.2.8</span> Собеседование с соискателем</h4>
</div>
<div id="outline-container-sec-3-2-9" class="outline-4">
<h4 id="sec-3-2-9"><span class="section-number-4">3.2.9</span> Предложение соискателю тестовых заданий</h4>
</div>
<div id="outline-container-sec-3-2-10" class="outline-4">
<h4 id="sec-3-2-10"><span class="section-number-4">3.2.10</span> Проверка тестовых заданий</h4>
</div>
<div id="outline-container-sec-3-2-11" class="outline-4">
<h4 id="sec-3-2-11"><span class="section-number-4">3.2.11</span> Анализ статистических отчетов</h4>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Хотелки (набор несогласованных идей, чтобы не забыть)</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Надо уметь удалять сниппеты и добавлять их в избранное
</p>

<p>
Есть множество конкурирующих сайтов для поиска работы, информацию с которых
можно аггрегировать.
</p>

<p>
При поиске работы основной сценарий использования - <code>поиск вакансий</code>, и практически все
сайты его предоставляют. Однако мне бы хотелось дополнительно иметь дополнительный
функционал:
</p>

<ul class="org-ul">
<li>заметки по каждой вакансии
</li>
<li>статусы или теги, такие как:
<ul class="org-ul">
<li><code>просмотрено</code> (с датой),
</li>
<li><code>отобрано</code>,
</li>
<li><code>не-берут-трубку</code>,
</li>
<li><code>не-актуально</code>,
</li>
<li><code>приглашен-на-интервью</code>,
</li>
<li><code>выслали-тестовое-задание</code>,
</li>
<li><code>отправил-тестовое-задание</code>,
</li>
<li><code>получен-оффер</code>,
</li>
<li><code>вакансия-закрыта</code> итп.
</li>
</ul>
</li>
</ul>

<p>
Работодатель хочет подтверждения навыков соискателя - для этого и тестовые задания. Надо
автоматизировать этот момент - если соискатель заявляет, к примеру, знания С++ - он должен
сделать некий тестовый код.
</p>

<p>
Я бы хотел ранжировать вакансии вручную (по выставленным приоритетам) и автоматически
(т.е. скриптом), например в зависимости от зарплаты или удаленности.
</p>

<p>
Я бы хотел иметь возможность планировать маршрут, когда еду на собеседование и иметь
календарь, чтобы не пропустить встречу.
</p>

<p>
Я бы хотел иметь версии вакансий, чтобы отслеживать их изменения, например изменения
зарплаты до и после моего интервью - это позволит анализировать рынок и получать больше
информации.
</p>

<p>
Мне также интересно составлять профили компаний и отслеживать как меняется набор
сотрудников которых они ищут - это поможет планировать долгосрочную стратегию. Особенно в
этом плане интересны лидеры рынка - Яндекс, Гугл и.т.п.
</p>

<p>
Я бы хотел иметь возможность пообщаться с теми кто работал или работает в интересующей
меня компании, иметь подмножество функционала социальных сетей или интеграцию с ними
</p>

<p>
Иногда мне приятно работать с уже знакомыми людьми, так что в целом я бы не отказался
создавать на таком сайте что-то типа т.н. <code>рабочих коллективов</code>, чтобы наниматься сразу
командой. Возможно работодателям такой вариант найма тоже будет интересен.
</p>

<p>
В ряде случаев компании меняют свои вакансии, некоторые делают это методом удаления
предыдущей и создания новой. Мне как соискателю хотелось бы не обнаруживать уже
просмотренную и возможно собеседованную вакансию в новых. Поэтому хотелось бы
предусмотреть механизм, который связывает очень похожие вакансии друг с другом.
</p>

<p>
Иногда вакансии меняются, или в них меняются существенные условия. Например, две недели
назад, когда я смотрел вакансию из предыдущей сборки меня не устроила зарпалата, а
сегодня вакансия стала интереснее. Я хочу отслеживать что вакансия поменялась.
</p>

<p>
Таким образом при создании вакансии мы должны проверять, может она уже есть в базе и
тогда указывать, что эта вакансия включена в несколько сборок (требует таблицы связи)
</p>

<p>
Несколько вакансий могут быть от одной компании. В этом случае мне бы хотелось
отслеживать это в профиле компании, кроме того интересна аналитика по этой компании за
определенный период времени.
</p>

<p>
С социальной точки зрения интересно получать отзывы о компании от ее работников, в том
числе и уволенных.
</p>

<p>
Действия по вакансии: звонки, скайп-интервью, собеседования
</p>

<p>
В эту таблицу заносим что сделано по каждой вакансии, которая находится в разработке
</p>

<p>
Теги вакансий Помогают ориентироваться, когда вакансий много.
</p>

<p>
Важно: Для обеспечения социальных взаимодействий нужно предусмотреть, чтобы вакансию
можно было "передать", т.е. у нее минимум должен быть URI.
</p>

<p>
Если пользователь просмотрел вакансию, но пока не хочет отправлять отзыв - он может
добавить вакансию в закладки - в этом случае ее статус меняется на <code>favorited</code>
</p>

<p>
Из <code>favorited</code> мы снова можем отправить отзыв.
</p>

<p>
Из <code>favorited</code> пользователь может вернуть вакансию обратно в <code>interesting</code> или <code>hidden</code>.
</p>

<p>
Из <code>hidden</code> пользователь может вернуть вакансию в <code>interesting</code>.
</p>

<p>
Если по вакансии позвонили, пользователю обычно нужно ее быстро найти. Нужна форма поиска
по вакансиям в статусе <code>responded</code> - пользователь ищет обычно по названию фирмы.
</p>

<p>
После звонка вакансия может быть выкинута или переведена из <code>responded</code> в статус "был
телефонный звонок" - <code>called</code>. Выкидывая вакансию пользователь может выбрать reason - для
них можно будет потом сделать отдельную таблицу но пока просто пишем в поле
вакансии. Если в результате телефонного звонка была достигнута договоренность о
собеседовании - пользователь переводит вакансию в состояние "пригласили на интервью" -
<code>wait-interview</code> и заносит в вакансию данные о том, куда и во сколько ехать. Если по
телефону рекрутер предложил тестовое задание - статус - "ожидание тестового задания" -
<code>wait-test</code>. Если договорились о интервью по скайпу - "ожидание скайп-интервью" -
<code>wait-skype-interview</code>.
</p>

<p>
Получив тестовое задание пользователь переводит вакансию из статуса <code>wait-test</code> в
"выполнение тестового задания" <code>run-test</code>, а оттуда либо в <code>test-cancel</code> либо в
<code>test-sended</code>. Либо выкидывает.
</p>

<p>
Пользователи иногда забивают на интервью (случаются накладки) - в этом случае рекрутер
часто передоговаривается на другое время. Делать петли в графе значит излишне усложнять
его, наверно пусть можно будет просто изменить данные о времени интервью.
</p>

<p>
После интервью или скайп-интервью от вакансии можно либо отказаться (<code>refuse-employer</code>,
<code>refuse-applicant</code>) либо перевести в статус "ожидание результата" - <code>wait-result</code>. Нужно
включать таймер, по истечении которого напоминать пользователю позвонить рекрутеру и
узнать, как дела.
</p>

<p>
Иногда после скайп-интервью назначают очное интервью. Также бывает прямо на интервью
предлагают оффер - <code>offer</code> и соискатель берет время на подумать.
</p>

<p>
Из "ожидания результата" можно перескочить в "предложен оффер", "отказ работодателя" -
<code>refuse-employer</code> или "отказ соискателя" - <code>refuse-аpplicant</code>.
</p>

<p>
История статусов нужна, в нее нужно заносить время когда изменяется статус и возможно
примечания по изменению. Будет красиво, если в интерфейсе будет отображаться полный граф
статусов и текущее положение вакансии в нем.
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> <span class="todo TODO">TODO</span> TODO</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>Было бы неплохо делать diff-ы между сборами вакансий и отзывов
</li>
<li>Нужен анализ ошибок hh при send-respond (например: вакансия в архиве)
</li>
<li>Нужна привязка к роботу, который по таймеру вынимает данные из hh
</li>
<li>Нужна привязка работы к юзеру
</li>
<li>Поправить неправильное определение emp-name при анализе тизеров
</li>
<li>Подключать несколько hh-аккаунтов к одному профилю пользователя
</li>
<li>Создание и удаление правил
</li>
<li>Предлагать правки статей через гитхаб
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Как это работает?</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Источник вакансий</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Пусть у нас есть источник вакансий, например, hh.ru. На нем можно сформулировать запрос и
получить выборку в виде списка тизеров вакансий, каждый из которых ведет на полное
описание вакансии.
</p>


<div id="fig:vacancy_source" class="figure">
<p><img src="./img/warehouse.jpg" alt="warehouse.jpg" />
</p>
<p><span class="figure-number">Figure 1:</span> Это источник вакансий</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Фабрика генераторов вакансий</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Пусть у нас есть фабрика <code>генераторов функций</code> назовем его <code>factory</code>, которая принимает
<code>источник вакансий</code> и параметры запроса (например: <code>профессиональную область</code>, <code>специализацию</code>,
<code>город</code>) и возвращает <code>функцию-генератор</code> в замыкании.
</p>


<div id="fig:factory" class="figure">
<p><img src="./img/factory.jpg" alt="factory.jpg" />
</p>
<p><span class="figure-number">Figure 2:</span> Фабрика генераторов вакансий</p>
</div>

<p>
Эта функция-генератор при каждом своем вызове вернет одну вакансию или <code>ложь</code> если все
вакансии кончились или сервер вернул 404-ую ошибку.
</p>


<div id="fig:generator" class="figure">
<p><img src="./img/generator.jpg" alt="generator.jpg" />
</p>
<p><span class="figure-number">Figure 3:</span> Функция-генератор, произведенная фабрикой</p>
</div>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает сначала тизеры
вакансий, а потом и сами вакансии, при этом процесс превращения тизера в вакансию
(<code>process-teaser</code>) вынесен из замыкания, т.к. не зависит от замкнутых переменных.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="factory">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;make_hh_url&gt;&gt;

&lt;&lt;hh_get_page&gt;&gt;

&lt;&lt;hh_parse_vacancy_teasers&gt;&gt;

&lt;&lt;hh_parse_vacancy&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-jar (make-instance 'drakma:cookie-jar)))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">------- &#1101;&#1090;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090;&#1089;&#1103; &#1080;&#1079; get-vacancy, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; factory</span>
  (<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">process-teaser</span> (current-teaser src-account referer)
    (dbg <span style="color: #00cd00;">"process-teaser"</span>)
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vacancy-page (format nil <span style="color: #00cd00;">"http://spb.hh.ru/vacancy/~A"</span> (getf current-teaser <span style="color: #0000ee; font-weight: bold;">:id</span>))))
      (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (vacancy new-cookies ref-url)
          (hh-get-page vacancy-page cookie-jar src-account referer)
        (setf cookie-jar new-cookies)
        (aif (hh-parse-vacancy vacancy)
             (merge-plists current-teaser it)
             nil))))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">------- &#1101;&#1090;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; get-vacancy, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1103;&#1074;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1075;&#1077;&#1085;&#1077;&#1088;&#1072;&#1090;&#1086;&#1088;&#1086;&#1084; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;</span>
  (<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">factory</span> ((vac-src (eql 'hh)) src-account city prof-area <span style="color: #00cd00;">&amp;optional</span> spec)
    (dbg <span style="color: #00cd00;">"factory"</span>)
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">closure</span>
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((url        (make-hh-url city prof-area spec))
          (page       0)
          (teasers    nil))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">returned function-generator in closure</span>
      (alexandria:named-lambda get-vacancy ()
        (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((load-next-teasers-page ()
                   (dbg <span style="color: #00cd00;">"load-next-teasers-page (page=~A)"</span> page)
                   (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((next-teasers-page-url (format nil url page))
                          (referer (<span style="color: #00cdcd; font-weight: bold;">if</span> (= page 0) <span style="color: #00cd00;">"http://spb.hh.ru"</span>(format nil url (- page 1)))))
                     (<span style="color: #00cdcd; font-weight: bold;">handler-case</span>
                         (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (next-teasers-page new-cookies ref-url)
                             (hh-get-page next-teasers-page-url cookie-jar src-account referer)
                           (setf cookie-jar new-cookies)
                           (setf teasers (hh-parse-vacancy-teasers next-teasers-page))
                           (incf page)
                           (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal 0 (length teasers))
                             (dbg <span style="color: #00cd00;">"~~ FIN(0)"</span>)
                             (<span style="color: #00cdcd; font-weight: bold;">return-from</span> get-vacancy 'nil)))
                       (hh-404-error (err)
                         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
                           (dbg <span style="color: #00cd00;">"~~ FIN(404) : ~A"</span> (url err))
                           (<span style="color: #00cdcd; font-weight: bold;">return-from</span> get-vacancy 'nil))))
                     ))
                 (get-teaser ()
                   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "get-teaser")</span>
                   (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal 0 (length teasers))
                     (load-next-teasers-page))
                   (<span style="color: #00cdcd; font-weight: bold;">prog1</span> (car teasers)
                     (setf teasers (cdr teasers)))))
          (<span style="color: #00cdcd; font-weight: bold;">tagbody</span> get-new-teaser
             (<span style="color: #00cdcd; font-weight: bold;">let</span> ((current-vacancy (process-teaser (get-teaser) src-account (format nil url page))))
               (<span style="color: #00cdcd; font-weight: bold;">if</span> (null current-vacancy)
                   (<span style="color: #00cdcd; font-weight: bold;">go</span> get-new-teaser)
                   (<span style="color: #00cdcd; font-weight: bold;">return-from</span> get-vacancy current-vacancy)))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((gen (factory 'hh "spb" "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #cd0000;">;;                     </span><span style="color: #cd0000;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(loop :for i :from 1 :to 100 :do</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">;; (dbg "~A" i)</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(let ((vacancy (funcall gen)))</span>
<span style="color: #cd0000;">;;        </span><span style="color: #cd0000;">(when (null vacancy)</span>
<span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(return))))))</span>
</pre>
</div>

<p>
Для работы этому генератору нужно уметь:
</p>
<ul class="org-ul">
<li>Собирать URL страницы, где лежат тизеры (краткие описания) вакансий из параметов запроса
(<code>make-hh-url</code>)
</li>
<li>Скачивать HTML-страницы (<code>hh-get-page</code>)
</li>
<li>Разбирать тизеры из html-кода (<code>hh-parse-vacancy-teasers</code>)
</li>
<li>Обрабатывать разобранные тизеры (<code>hh-parse-vacancy</code>), чтобы получить по ним вакансии.
</li>
</ul>
</div>

<div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> Построение URL-ов для скачивания тизеров (<code>make-hh-url</code>)</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Тизеры вакансий размещаются постранично, по 20 штук на странице, и мы можем собрать все
страницы, если будем получать страницу за страницей, пока не получим страницу, на которой
вакансий нет.
</p>

<p>
В качестве GET-параметров запросы указываются <code>специализации</code> и город. Значения <code>cluster</code>
и <code>area</code> не меняются. Поэтому, единственная сложность построения URL - это правильно
сформировать <code>специализации</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_hh_url">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;!make_specialization_hh_url_string&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">make-hh-url</span> (city prof-area <span style="color: #00cd00;">&amp;optional</span> specs)
  <span style="color: #00cd00;">"http://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;items_on_page=100&amp;no_magic=true&amp;page=~A"</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">test</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-hh-url "spb" "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-2-1-1"></a><span class="todo TODO">TODO</span> Построение специализаций<br  /><div class="outline-text-5" id="text-4-2-1-1">
<p>
Специализации задаются в формате "1.221", где цифра слева от точки представляет
профессиональное направление, а справа - собственно специализацию. В интерфейсе
допустимо выбрать одно направление и несколько специализаций в нем, при этом для каждой
специализации формируется параметр GET-запроса. Допустимо выбрать только направление,
без специализаций.
</p>

<p>
По этой причине мы должны иметь дерево специализаций и транслятор названий специализаций
в их номера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_specialization_hh_url_string">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;prof_areas&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">make-specialization-hh-url-string</span> (prof-area <span style="color: #00cd00;">&amp;optional</span> specs)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((specialization (assoc prof-area *prof-areas* <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (null specialization)
      (err 'specialization-not-found))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (stringp specs)
      (setf specs (list specs)))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (null specs)
        (concatenate 'string
                     <span style="color: #00cd00;">"&amp;specialization="</span>
                     (cadr specialization))
        (format nil <span style="color: #00cd00;">"~{&amp;~A~}"</span>
                (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> spec <span style="color: #0000ee; font-weight: bold;">:in</span> specs <span style="color: #0000ee; font-weight: bold;">:collect</span>
                   (<span style="color: #00cdcd; font-weight: bold;">let</span> ((spec (cdr (assoc spec (caddr specialization) <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))))
                     (<span style="color: #00cdcd; font-weight: bold;">when</span> (null spec)
                       (err 'spec-not-found))
                     (concatenate 'string <span style="color: #00cd00;">"specialization="</span> (cadr specialization) <span style="color: #00cd00;">"."</span> spec)))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">test</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" '("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #cd0000;">;;                                    </span><span style="color: #cd0000;">'("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>
<span style="color: #cd0000;">;;                                      </span><span style="color: #cd0000;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span>
<span style="color: #cd0000;">;;                                      </span><span style="color: #cd0000;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span>
<span style="color: #cd0000;">;;                                      </span><span style="color: #cd0000;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span>
<span style="color: #cd0000;">;;                                      </span><span style="color: #cd0000;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span>
<span style="color: #cd0000;">;;                                      </span><span style="color: #cd0000;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"))</span>
</pre>
</div>

<p>
Дерево специализаций будем хранить в глобальном alist-е, т.к. оно никогда не меняется. Я
не стал заполнять его целиком, ограничившись только профессиональной областью "ИТ". По
необходимости заполню остальное.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="prof_areas">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*prof-areas*</span>
  '((<span style="color: #00cd00;">"&#1042;&#1089;&#1077; &#1087;&#1088;&#1086;&#1092;&#1077;&#1089;&#1089;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080;"</span> . (<span style="color: #00cd00;">""</span>))
    (<span style="color: #00cd00;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
     . (<span style="color: #00cd00;">"1"</span> ((<span style="color: #00cd00;">"CRM &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;"</span> . <span style="color: #00cd00;">"536"</span>)
             (<span style="color: #00cd00;">"CTO, CIO, &#1044;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088; &#1087;&#1086; IT"</span> . <span style="color: #00cd00;">"3"</span>)
             (<span style="color: #00cd00;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #00cd00;">"9"</span>)
             (<span style="color: #00cd00;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span> . <span style="color: #00cd00;">"10"</span>)
             (<span style="color: #00cd00;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088; &#1073;&#1072;&#1079; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;"</span> . <span style="color: #00cd00;">"420"</span>)
             (<span style="color: #00cd00;">"&#1040;&#1085;&#1072;&#1083;&#1080;&#1090;&#1080;&#1082;"</span> . <span style="color: #00cd00;">"25"</span>)
             (<span style="color: #00cd00;">"&#1040;&#1088;&#1090;-&#1076;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088;"</span> . <span style="color: #00cd00;">"30"</span>)
             (<span style="color: #00cd00;">"&#1041;&#1072;&#1085;&#1082;&#1086;&#1074;&#1089;&#1082;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #00cd00;">"395"</span>)
             (<span style="color: #00cd00;">"&#1048;&#1075;&#1088;&#1086;&#1074;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #00cd00;">"475"</span>)
             (<span style="color: #00cd00;">"&#1048;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #00cd00;">"82"</span>)
             (<span style="color: #00cd00;">"&#1048;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #00cd00;">"89"</span>)
             (<span style="color: #00cd00;">"&#1050;&#1086;&#1084;&#1087;&#1100;&#1102;&#1090;&#1077;&#1088;&#1085;&#1072;&#1103; &#1073;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . <span style="color: #00cd00;">"110"</span>)
             (<span style="color: #00cd00;">"&#1050;&#1086;&#1085;&#1089;&#1072;&#1083;&#1090;&#1080;&#1085;&#1075;, &#1040;&#1091;&#1090;&#1089;&#1086;&#1088;&#1089;&#1080;&#1085;&#1075;"</span> . <span style="color: #00cd00;">"113"</span>)
             (<span style="color: #00cd00;">"&#1050;&#1086;&#1085;&#1090;&#1077;&#1085;&#1090;"</span> . <span style="color: #00cd00;">"116"</span>)
             (<span style="color: #00cd00;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;"</span> . <span style="color: #00cd00;">"137"</span>)
             (<span style="color: #00cd00;">"&#1052;&#1091;&#1083;&#1100;&#1090;&#1080;&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . <span style="color: #00cd00;">"161"</span>)
             (<span style="color: #00cd00;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1091;&#1088;&#1086;&#1074;&#1077;&#1085;&#1100;, &#1052;&#1072;&#1083;&#1086; &#1086;&#1087;&#1099;&#1090;&#1072;"</span> . <span style="color: #00cd00;">"172"</span>)
             (<span style="color: #00cd00;">"&#1054;&#1087;&#1090;&#1080;&#1084;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103; &#1089;&#1072;&#1081;&#1090;&#1072; (SEO)"</span> . <span style="color: #00cd00;">"400"</span>)
             (<span style="color: #00cd00;">"&#1055;&#1077;&#1088;&#1077;&#1076;&#1072;&#1095;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1080; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1074; &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #00cd00;">"203"</span>)
             (<span style="color: #00cd00;">"&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072;, Helpdesk"</span> . <span style="color: #00cd00;">"211"</span>)
             (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span> . <span style="color: #00cd00;">"221"</span>)
             (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . <span style="color: #00cd00;">"225"</span>)
             (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1076;&#1102;&#1089;&#1077;&#1088;"</span> . <span style="color: #00cd00;">"232"</span>)
             (<span style="color: #00cd00;">"&#1056;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1077; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;&#1072;"</span> . <span style="color: #00cd00;">"246"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1077;&#1090;&#1077;&#1074;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #00cd00;">"270"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1072;&#1103; &#1080;&#1085;&#1090;&#1077;&#1075;&#1088;&#1072;&#1094;&#1080;&#1103;"</span> . <span style="color: #00cd00;">"272"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span> . <span style="color: #00cd00;">"273"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;"</span> . <span style="color: #00cd00;">"274"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1077;&#1084; (ERP)"</span> . <span style="color: #00cd00;">"50"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1086;&#1090;&#1086;&#1074;&#1099;&#1077;, &#1041;&#1077;&#1089;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #00cd00;">"277"</span>)
             (<span style="color: #00cd00;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span> . <span style="color: #00cd00;">"474"</span>)
             (<span style="color: #00cd00;">"&#1058;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&#1084;&#1091;&#1085;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080;"</span> . <span style="color: #00cd00;">"295"</span>)
             (<span style="color: #00cd00;">"&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . <span style="color: #00cd00;">"117"</span>)
             (<span style="color: #00cd00;">"&#1058;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1087;&#1080;&#1089;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> . <span style="color: #00cd00;">"296"</span>)
             (<span style="color: #00cd00;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span> . <span style="color: #00cd00;">"327"</span>)
             (<span style="color: #00cd00;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"</span> . <span style="color: #00cd00;">"359"</span>))))
    (<span style="color: #00cd00;">"&#1041;&#1091;&#1093;&#1075;&#1072;&#1083;&#1090;&#1077;&#1088;&#1080;&#1103;, &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1091;&#1095;&#1077;&#1090;, &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1099; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1103;"</span> . (<span style="color: #00cd00;">"2"</span>))
    (<span style="color: #00cd00;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;, &#1088;&#1077;&#1082;&#1083;&#1072;&#1084;&#1072;, PR"</span> . (<span style="color: #00cd00;">"3"</span>))
    (<span style="color: #00cd00;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1080;&#1074;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #00cd00;">"4"</span>))
    (<span style="color: #00cd00;">"&#1041;&#1072;&#1085;&#1082;&#1080;, &#1080;&#1085;&#1074;&#1077;&#1089;&#1090;&#1080;&#1094;&#1080;&#1080;, &#1083;&#1080;&#1079;&#1080;&#1085;&#1075;"</span> . (<span style="color: #00cd00;">"5"</span>))
    (<span style="color: #00cd00;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;&#1086;&#1084;, &#1090;&#1088;&#1077;&#1085;&#1080;&#1085;&#1075;&#1080;"</span> . (<span style="color: #00cd00;">"6"</span>))
    (<span style="color: #00cd00;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100;&#1085;&#1099;&#1081; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;"</span> . (<span style="color: #00cd00;">"7"</span>))
    (<span style="color: #00cd00;">"&#1041;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #00cd00;">"8"</span>))
    (<span style="color: #00cd00;">"&#1042;&#1099;&#1089;&#1096;&#1080;&#1081; &#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1084;&#1077;&#1085;&#1090;"</span> . (<span style="color: #00cd00;">"9"</span>))
    (<span style="color: #00cd00;">"&#1044;&#1086;&#1073;&#1099;&#1095;&#1072; &#1089;&#1099;&#1088;&#1100;&#1103;"</span> . (<span style="color: #00cd00;">"10"</span>))
    (<span style="color: #00cd00;">"&#1048;&#1089;&#1082;&#1091;&#1089;&#1089;&#1090;&#1074;&#1086;, &#1088;&#1072;&#1079;&#1074;&#1083;&#1077;&#1095;&#1077;&#1085;&#1080;&#1103;, &#1084;&#1072;&#1089;&#1089;-&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . (<span style="color: #00cd00;">"11"</span>))
    (<span style="color: #00cd00;">"&#1050;&#1086;&#1085;&#1089;&#1091;&#1083;&#1100;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #00cd00;">"12"</span>))
    (<span style="color: #00cd00;">"&#1052;&#1077;&#1076;&#1080;&#1094;&#1080;&#1085;&#1072;, &#1092;&#1072;&#1088;&#1084;&#1072;&#1094;&#1077;&#1074;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #00cd00;">"13"</span>))
    (<span style="color: #00cd00;">"&#1053;&#1072;&#1091;&#1082;&#1072;, &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #00cd00;">"14"</span>))
    (<span style="color: #00cd00;">"&#1043;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1072;&#1103; &#1089;&#1083;&#1091;&#1078;&#1073;&#1072;, &#1085;&#1077;&#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1095;&#1077;&#1089;&#1082;&#1080;&#1077; &#1086;&#1088;&#1075;&#1072;&#1085;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080;"</span> . (<span style="color: #00cd00;">"16"</span>))
    (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . (<span style="color: #00cd00;">"17"</span>))
    (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1080;&#1079;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;"</span> . (<span style="color: #00cd00;">"18"</span>))
    (<span style="color: #00cd00;">"&#1057;&#1090;&#1088;&#1072;&#1093;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #00cd00;">"19"</span>))
    (<span style="color: #00cd00;">"&#1057;&#1090;&#1088;&#1086;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;&#1086;, &#1085;&#1077;&#1076;&#1074;&#1080;&#1078;&#1080;&#1084;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #00cd00;">"20"</span>))
    (<span style="color: #00cd00;">"&#1058;&#1088;&#1072;&#1085;&#1089;&#1087;&#1086;&#1088;&#1090;, &#1083;&#1086;&#1075;&#1080;&#1089;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #00cd00;">"21"</span>))
    (<span style="color: #00cd00;">"&#1058;&#1091;&#1088;&#1080;&#1079;&#1084;, &#1075;&#1086;&#1089;&#1090;&#1080;&#1085;&#1080;&#1094;&#1099;, &#1088;&#1077;&#1089;&#1090;&#1086;&#1088;&#1072;&#1085;&#1099;"</span> . (<span style="color: #00cd00;">"22"</span>))
    (<span style="color: #00cd00;">"&#1070;&#1088;&#1080;&#1089;&#1090;&#1099;"</span> . (<span style="color: #00cd00;">"23"</span>))
    (<span style="color: #00cd00;">"&#1057;&#1087;&#1086;&#1088;&#1090;&#1080;&#1074;&#1085;&#1099;&#1077; &#1082;&#1083;&#1091;&#1073;&#1099;, &#1092;&#1080;&#1090;&#1085;&#1077;&#1089;, &#1089;&#1072;&#1083;&#1086;&#1085;&#1099; &#1082;&#1088;&#1072;&#1089;&#1086;&#1090;&#1099;"</span> . (<span style="color: #00cd00;">"24"</span>))
    (<span style="color: #00cd00;">"&#1048;&#1085;&#1089;&#1090;&#1072;&#1083;&#1083;&#1103;&#1094;&#1080;&#1103; &#1080; &#1089;&#1077;&#1088;&#1074;&#1080;&#1089;"</span> . (<span style="color: #00cd00;">"25"</span>))
    (<span style="color: #00cd00;">"&#1047;&#1072;&#1082;&#1091;&#1087;&#1082;&#1080;"</span> . (<span style="color: #00cd00;">"26"</span>))
    (<span style="color: #00cd00;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1072;&#1088;&#1100;&#1077;&#1088;&#1099;, &#1089;&#1090;&#1091;&#1076;&#1077;&#1085;&#1090;&#1099;"</span> . (<span style="color: #00cd00;">"15"</span>))
    (<span style="color: #00cd00;">"&#1044;&#1086;&#1084;&#1072;&#1096;&#1085;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #00cd00;">"27"</span>))
    (<span style="color: #00cd00;">"&#1056;&#1072;&#1073;&#1086;&#1095;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #00cd00;">"29"</span>))))
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> Получение страниц (<code>hh-get-page</code>)</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
Так как мы хотим получать информацию, которая находится за авторизацией, нам нужно
обеспечить прозрачность авторизации, если ее в данный момент нет. <code>hh_recovery_login</code> решает эту
проблему.
</p>

<p>
Вот так мы можем получать страницы, к примеру те, на который находятся тизеры:
</p>
<ul class="org-ul">
<li>Получаем страницу &lt;-&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+
</li>
<li>Проверяем, залогинены ли мы                                   |
<ul class="org-ul">
<li>Если залогинены - отдаем страницу                           |
</li>
<li>Если не залогинены - логинимся и получаем страницу снова.&#x2014;+
<ul class="org-ul">
<li>Если во время логина произошла ошибка - сигнализируем условие.
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Есть также одна особенность (типа баг) в результате которой drakma неправильно
воспринимает сформированные в get-запросе параметры и говорит что URI malformed. Мы
обходим это с помощью глобального флага <code>*need-start*</code>, что является временным
решением.
</p>

<p>
Если сервер возвращает 404 ошибку, функция сигнализирует condition <code>hh-404-error</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_get_page">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;hh_recovery_login&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">define-condition</span> <span style="color: #0000ee; font-weight: bold;">hh-404-error</span> (<span style="color: #cd0000; font-weight: bold;">error</span>)
  ((url  <span style="color: #0000ee; font-weight: bold;">:initarg</span> <span style="color: #0000ee; font-weight: bold;">:url</span> <span style="color: #0000ee; font-weight: bold;">:reader</span> url)
   (text <span style="color: #0000ee; font-weight: bold;">:initarg</span> <span style="color: #0000ee; font-weight: bold;">:text</span> <span style="color: #0000ee; font-weight: bold;">:reader</span> text)))

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*need-start*</span> t)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">hh-get-page</span> (url cookie-jar src-account referer)
  <span style="color: #00cd00;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;"</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1085;&#1080; &#1086;&#1076;&#1085;&#1086;&#1075;&#1086; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1072; &#1077;&#1097;&#1077; &#1085;&#1077; &#1073;&#1099;&#1083;&#1086; - &#1089;&#1076;&#1077;&#1083;&#1072;&#1077;&#1084; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089; &#1082; &#1075;&#1083;&#1072;&#1074;&#1085;&#1086;&#1081; &#1080; &#1089;&#1085;&#1080;&#1084;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075;</span>
  (<span style="color: #00cdcd; font-weight: bold;">when</span> *need-start*
    (drakma:http-request <span style="color: #00cd00;">"http://spb.hh.ru/"</span> <span style="color: #0000ee; font-weight: bold;">:user-agent</span> *user-agent* <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                         <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t     <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar)
    (setf referer <span style="color: #00cd00;">"http://spb.hh.ru/"</span>)
    (setf *need-start* nil))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1044;&#1077;&#1083;&#1072;&#1077;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1081; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;, &#1087;&#1086; &#1091;&#1088;&#1083;&#1091; &#1080;&#1079; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;, &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1103; &#1088;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090; &#1074; response</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1080; &#1086;&#1073;&#1085;&#1086;&#1074;&#1083;&#1103;&#1103; cookie-jar</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((response   <span style="color: #00cd00;">""</span>)
        (repeat-cnt 0))
    (<span style="color: #00cdcd; font-weight: bold;">tagbody</span> repeat
       (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
           (drakma:http-request
            url <span style="color: #0000ee; font-weight: bold;">:user-agent</span> *user-agent* <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
            <span style="color: #0000ee; font-weight: bold;">:additional-headers</span> (append *additional-headers*
                                        `((<span style="color: #00cd00;">"Referer"</span> . ,referer))))
         (dbg <span style="color: #00cd00;">"-- ~A : ~A"</span> status-code url)
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal 404 status-code)
           (<span style="color: #cd0000; font-weight: bold;">error</span> 'hh-404-error <span style="color: #0000ee; font-weight: bold;">:url</span> url <span style="color: #0000ee; font-weight: bold;">:text</span> (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
         (setf response (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1084;&#1099; &#1085;&#1077; &#1079;&#1072;&#1083;&#1086;&#1075;&#1080;&#1085;&#1077;&#1085;&#1099;:</span>
       (<span style="color: #00cdcd; font-weight: bold;">unless</span> (is-logged response)
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084;, &#1085;&#1077; &#1087;&#1088;&#1077;&#1074;&#1099;&#1096;&#1077;&#1085;&#1086; &#1083;&#1080; &#1082;&#1086;&#1083;-&#1074;&#1086; &#1087;&#1086;&#1087;&#1099;&#1090;&#1086;&#1082; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103;</span>
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (&gt; repeat-cnt 3)
           <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1080;&#1093; &#1073;&#1086;&#1083;&#1100;&#1096;&#1077; &#1090;&#1088;&#1077;&#1093; - &#1089;&#1080;&#1075;&#1085;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1091;&#1077;&#1084; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091;</span>
           (err <span style="color: #00cd00;">"max recovery-login try"</span>))
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1099;&#1090;&#1072;&#1077;&#1084;&#1089;&#1103; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1089;&#1077;&#1089;&#1089;&#1080;&#1102;</span>
         (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (recovery-html recovery-cookie-jar)
             (recovery-login src-account)
           (setf response recovery-html)
           (setf cookie-jar recovery-cookie-jar)
           (setf referer <span style="color: #00cd00;">"https://spb.hh.ru/account/login"</span>))
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1059;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1095;&#1077;&#1090;&#1095;&#1080;&#1082; &#1087;&#1086;&#1087;&#1099;&#1090;&#1086;&#1082;</span>
         (incf repeat-cnt)
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1088;&#1086;&#1073;&#1091;&#1077;&#1084; &#1079;&#1072;&#1075;&#1088;&#1091;&#1079;&#1080;&#1090;&#1100; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1089;&#1085;&#1086;&#1074;&#1072;</span>
         (<span style="color: #00cdcd; font-weight: bold;">go</span> repeat)))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103;</span>
    (values <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(html5-parser:node-to-xmls (html5-parser:parse-html5-fragment response))</span>
            response
            cookie-jar
            url)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(hh-get-page "http://spb.hh.ru/applicant/negotiations?wed=1"</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">(make-instance 'drakma:cookie-jar)</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">"http://spb.hh.ru/")</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-2-2-1"></a>Логин на источник (<code>recovery-login</code>)<br  /><div class="outline-text-5" id="text-4-2-2-1">
<p>
Прежде чем мы получим возможность забирать авторизованную информацию с нашего источника,
нам нужно иметь способ залогиниться на него. В дополнение к этому мы должны отслеживать
момент потери авторизованной сесии и в каждый конкретный момент определять, залогинены ли
мы. Обычно это можно определить по наличию формы для логина на любой загружаемой
странице.
</p>

<p>
Мы хотим в случае обрыва сессии перелогиниваться прозрачно для всего остального
кода, поэтому процедура логина должна вызвываться по необходимости из процедуры
загрузки любой страницы. Также важно обрабатывать ошибки, которые могут произойти
при логине, например, если неверен пароль.
</p>

<p>
Для всех этих целей мы передаем в <code>recovery-login</code> объект <code>src-account</code>, который
содержит все необходимое, чтобы восстановить сессию: логин, пароль и ФИО
пользователя, по которому мы определяем, что успешно залогинились.
</p>

<p>
<code>recovery-login</code> вторым возвращаемым значением возвращает новый cookie-jar,
который нужно использовать для работы внутри сессии.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_recovery_login">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;data_for_account&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*user-agent*</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*additional-headers*</span> `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
                                     (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
                                     (<span style="color: #00cd00;">"Accept-Charset"</span> . <span style="color: #00cd00;">"utf-8"</span>)))

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*cookies*</span> nil)  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">deprecated, use cookie-jar in closure</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">is-logged</span> (html)
  <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084; &#1085;&#1072;&#1083;&#1080;&#1095;&#1080;&#1077; &#1074; html &#1073;&#1083;&#1086;&#1082;&#1072; '&#1042;&#1086;&#1081;&#1090;&#1080;'"</span>
  (dbg <span style="color: #00cd00;">":: is-logged"</span>)
  (not (contains html <span style="color: #00cd00;">"data-qa=\"mainmenu_loginForm\"&gt;&#1042;&#1086;&#1081;&#1090;&#1080;&lt;/div&gt;"</span>)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-cookies-alist</span> (cookie-jar)
  <span style="color: #00cd00;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; alist &#1089; &#1087;&#1077;&#1095;&#1077;&#1085;&#1100;&#1082;&#1072;&#1084;&#1080; &#1080;&#1079; cookie-jar"</span>
  (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> cookie <span style="color: #0000ee; font-weight: bold;">:in</span> (drakma:cookie-jar-cookies cookie-jar) <span style="color: #0000ee; font-weight: bold;">:append</span>
     (list (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">recovery-login</span> (src-account)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1085;&#1072; &#1075;&#1083;&#1072;&#1074;&#1085;&#1091;&#1102; &#1082;&#1072;&#1082; &#1073;&#1091;&#1076;&#1090;&#1086; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1088;&#1072;&#1079;, &#1073;&#1077;&#1079; &#1087;&#1077;&#1095;&#1077;&#1085;&#1077;&#1082;</span>
  (setf drakma:*header-stream* nil)
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((start-uri <span style="color: #00cd00;">"http://spb.hh.ru/"</span>)
         (cookie-jar (make-instance 'drakma:cookie-jar))
         (additional-headers *additional-headers*)
         (response (drakma:http-request start-uri
                                        <span style="color: #0000ee; font-weight: bold;">:user-agent</span> *user-agent*
                                        <span style="color: #0000ee; font-weight: bold;">:additional-headers</span> additional-headers
                                        <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t
                                        <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                                        <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                                        ))
         (tree <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(html5-parser:node-to-xmls ;; !=!</span>
                (html5-parser:parse-html5-fragment
                 (flexi-streams:octets-to-string response <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)
                 <span style="color: #0000ee; font-weight: bold;">:dom</span> <span style="color: #0000ee; font-weight: bold;">:xmls</span>
                 <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">)</span>
                 )))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1091;&#1077;&#1084; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1100; &#1087;&#1077;&#1095;&#1077;&#1085;&#1100;&#1082;&#1080; &#1076;&#1083;&#1103; &#1083;&#1086;&#1075;&#1080;&#1085;&#1072;</span>
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">GMT=3 ;; _xsrf=  ;; hhrole=anonymous ;; hhtoken= ;; hhuid= ;; regions=2 ;; unique_banner_user=</span>
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1048; &#1079;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1089; &#1074;&#1086;&#1090;-&#1090;&#1072;&#1082;&#1080;&#1084; &#1075;&#1077;&#1090;-&#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1086;&#1084;:</span>
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">username=avenger-f@ya.ru ;; password=jGwPswRAfU6sKEhVXX ;; backurl=http://spb.hh.ru/ ;; remember=yes ;; action="&#1042;&#1086;&#1081;&#1090;&#1080;" ;; _xsrf=</span>
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(setf drakma:*header-stream* *standard-output*)</span>
    (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((post-parameters `((<span style="color: #00cd00;">"username"</span> . ,(src_login src-account))
                              (<span style="color: #00cd00;">"password"</span> . ,(src_password src-account))
                              (<span style="color: #00cd00;">"backUrl"</span>  . <span style="color: #00cd00;">"http://spb.hh.ru/"</span>)
                              (<span style="color: #00cd00;">"remember"</span> . <span style="color: #00cd00;">"yes"</span>)
                              (<span style="color: #00cd00;">"action"</span>   . <span style="color: #00cd00;">"%D0%92%D0%BE%D0%B9%D1%82%D0%B8"</span>)
                              (<span style="color: #00cd00;">"_xsrf"</span>    . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> (get-cookies-alist cookie-jar) <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))))
           (xsrf (cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> (get-cookies-alist cookie-jar) <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
           (cookie-jar-2 (make-instance 'drakma:cookie-jar
                                        <span style="color: #0000ee; font-weight: bold;">:cookies</span> (append (list (make-instance 'drakma:cookie <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"GMT"</span>   <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"3"</span> <span style="color: #0000ee; font-weight: bold;">:domain</span> <span style="color: #00cd00;">"spb.hh.ru"</span>)
                                                               (make-instance 'drakma:cookie <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"_xsrf"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> xsrf <span style="color: #0000ee; font-weight: bold;">:domain</span> <span style="color: #00cd00;">"spb.hh.ru"</span>))
                                                         (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                                        (equal <span style="color: #00cd00;">"crypted_id"</span> (drakma:cookie-name x)))
                                                                    (drakma:cookie-jar-cookies cookie-jar)))))
           (response-2 (drakma:http-request <span style="color: #00cd00;">"https://spb.hh.ru/account/login"</span>
                                            <span style="color: #0000ee; font-weight: bold;">:user-agent</span> *user-agent*
                                            <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                                            <span style="color: #0000ee; font-weight: bold;">:parameters</span> post-parameters
                                            <span style="color: #0000ee; font-weight: bold;">:additional-headers</span> (append *additional-headers* `((<span style="color: #00cd00;">"Referer"</span> . ,start-uri)))
                                            <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar-2
                                            <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t
                                            <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10))
           (html (flexi-streams:octets-to-string response-2 <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
      (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains html <span style="color: #00cd00;">"&#1053;&#1077;&#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1100;&#1085;&#1099;&#1077; &#1080;&#1084;&#1103; &#1080;/&#1080;&#1083;&#1080; &#1087;&#1072;&#1088;&#1086;&#1083;&#1100; - &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1091;&#1081;&#1090;&#1077;, &#1087;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072;, &#1089;&#1085;&#1086;&#1074;&#1072;."</span>)
        (err <span style="color: #00cd00;">"login failed"</span>))
      (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains html <span style="color: #00cd00;">"&#1063;&#1090;&#1086;-&#1090;&#1086; &#1087;&#1086;&#1096;&#1083;&#1086; &#1085;&#1077; &#1090;&#1072;&#1082;"</span>)
        (err <span style="color: #00cd00;">"login error"</span>))
      (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains html (src_fio src-account))
        (<span style="color: #00cdcd; font-weight: bold;">return-from</span> recovery-login
          (values <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(html5-parser:node-to-xmls (html5-parser:parse-html5-fragment html))</span>
                  html
                  cookie-jar-2)))
      (err <span style="color: #00cd00;">"login exception"</span>))))
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-2-2-1-1"></a>Аккаунты на источнике вакансий<br  /><div class="outline-text-6" id="text-4-2-2-1-1">
<p>
Для того чтобы иметь возможность работать в нескольких одновременных сессиях
внутри одного потока выполнения мы осуществляем поддержку сессий следующим
образом: Все вызовы получения страниц (<code>hh-get-page</code>) работают таким образом, как
будто считают себя по умолчанию залогиненными в сессию, для этого им передается
параметр cookie-jar. В случае, если по каким-то причинам это оказалось не так -
сессия восстанавливается вызовом <code>recovery-login</code>, который получает
авторизационную информацияю из объекта <code>src-account</code>, который также протягивается
через всю цепочку: <code>factory</code> -&gt; <code>get-vacancy::closure</code> -&gt; <code>hh-get-page</code> -&gt;
<code>recovery-login</code>. Возвращаемые из <code>recovery-login</code> куки попадают в замыкание и в
дальнейшем используются для работы в сессии.
</p>

<p>
Таким образом можно внутри одного потока выполения иметь несколько замыканий,
каждое из которых работает в своей сессии. Они могут выполнять разнообразные
задачи - сбор вакансий, отзывыв, опубликование резюме и.т.п. Для источника
вакансий это будет выглядеть как несколько пользователей, работающих с одного
адреса.
</p>

<table id="srcaccount_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Данные таблицы аккаунтов</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">user<sub>id</sub></td>
<td class="left">integer</td>
<td class="left">идентификатор пользователя, владеющего логином</td>
</tr>

<tr>
<td class="left">src<sub>source</sub></td>
<td class="left">varchar</td>
<td class="left">идентификатор источника ("hh" - для headhunter.ru)</td>
</tr>

<tr>
<td class="left">src<sub>login</sub></td>
<td class="left">varchar</td>
<td class="left">логин пользователя на источнике</td>
</tr>

<tr>
<td class="left">src<sub>password</sub></td>
<td class="left">varchar</td>
<td class="left">пароль пользователя на источнике</td>
</tr>

<tr>
<td class="left">src<sub>fio</sub></td>
<td class="left">varchar</td>
<td class="left">ФИО пользователя, чтобы определить что вход в профиль успешен</td>
</tr>
</tbody>
</table>

<p>
Аккаунты могут быть активные и неактивные. С неактивными аккаунтами никаких
действий (сбор вакансий, проверка отзывов) не производится.
</p>

<p>
Если трижды не удалось залогиниться на аккаунте, он переводится в состояние
<code>wrong</code> после чего требуется ручное устранение ошибки.
</p>

<table id="srcaccount_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Состояния конечного автомата аккаунта</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">account-activation</td>
<td class="left">active</td>
<td class="left">inactive</td>
</tr>

<tr>
<td class="left">account-deactivation</td>
<td class="left">inactive</td>
<td class="left">active</td>
</tr>

<tr>
<td class="left">account-login</td>
<td class="left">active</td>
<td class="left">logged</td>
</tr>

<tr>
<td class="left">account-logout</td>
<td class="left">logged</td>
<td class="left">active</td>
</tr>

<tr>
<td class="left">account-wrong</td>
<td class="left">active</td>
<td class="left">wrong</td>
</tr>
</tbody>
</table>

<p>
Теперь надо создать хотя бы один логин
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="data_for_account">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*hh_account*</span> (make-srcaccount <span style="color: #0000ee; font-weight: bold;">:user_id</span> 1
                                            <span style="color: #0000ee; font-weight: bold;">:src_source</span> <span style="color: #00cd00;">"hh"</span>
                                            <span style="color: #0000ee; font-weight: bold;">:src_login</span> <span style="color: #00cd00;">"avenger-f@yandex.ru"</span>
                                            <span style="color: #0000ee; font-weight: bold;">:src_password</span> <span style="color: #00cd00;">"jGwPswRAfU6sKEhVXX"</span>
                                            <span style="color: #0000ee; font-weight: bold;">:src_fio</span> <span style="color: #00cd00;">"&#1052;&#1080;&#1093;&#1072;&#1080;&#1083; &#1052;&#1080;&#1093;&#1072;&#1081;&#1083;&#1086;&#1074;&#1080;&#1095; &#1043;&#1083;&#1091;&#1093;&#1086;&#1074;"</span>
                                            <span style="color: #0000ee; font-weight: bold;">:state</span> <span style="color: #00cd00;">":ACTIVE"</span>))
</pre>
</div>
</div>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> Разбор тизеров вакансий (<code>hh-parse-vacancy-teasers</code>)</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
Чтобы получить вакансии со страниц поисковой выдачи - воспользуемся парсером,
который переведет полученный html в более удобное лисп-дерево (<code>html-to-tree</code>)
</p>

<p>
Используя сопоставление с образцом, которое мы определим ниже, внутри подраздела
<a href="#sec-4-2-3-1-3">Maptree-transform</a>, мы раз за разом преобразуем это дерево до тех пор, пока там
не остануться только интересующие нас данные:
</p>
<ul class="org-ul">
<li>название вакансии
</li>
<li>идентификатор (ссылку)
</li>
<li>дата размещения
</li>
<li>название работодателя
</li>
<li>идентификатор работодателя
</li>
</ul>

<p>
Технические подробности о трансформации дерева - далее в этом разделе:
<a href="#sec-4-2-3-1">Трансформация дерева</a>
</p>

<p>
Если в вакансии указана зарплата, мы также получаем
</p>
<ul class="org-ul">
<li>Валюту зарплаты (3х-буквенный идентификатор)
</li>
<li>Сумму
</li>
<li>Текстовое выражение, содержащее "от" или "от и до"
</li>
</ul>

<p>
Иногда HeadHunter синдицирует вакансии с других платформ, к примеру с CAREER.RU, тогда в
вакансии может отсутствовать работодатель.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy_teasers">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;maptree_transform&gt;&gt;

&lt;&lt;parse_salary&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">html-to-tree</span> (html)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(html5-parser:node-to-xmls</span>
  (html5-parser:parse-html5-fragment html <span style="color: #0000ee; font-weight: bold;">:dom</span> <span style="color: #0000ee; font-weight: bold;">:xmls</span>
                                     ))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(html-to-tree *last-parse-data*))</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">extract-search-results</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">block</span> subtree-extract
    (mtm (`(<span style="color: #00cd00;">"div"</span>
            ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result"</span>)
             (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__results"</span>))
            ,@rest)
           (<span style="color: #00cdcd; font-weight: bold;">return-from</span> subtree-extract rest))
         tree)))

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*detect-garbage*</span> '(<span style="color: #00cd00;">"premium"</span> <span style="color: #00cd00;">"response-trigger"</span> <span style="color: #00cd00;">"vacancy-responded"</span> <span style="color: #00cd00;">"star"</span> <span style="color: #00cd00;">"trigger-button"</span>
                                 <span style="color: #00cd00;">"response-popup-link"</span> <span style="color: #00cd00;">"vacancy-response-popup-script"</span> <span style="color: #00cd00;">"emp-logo"</span>
                                 <span style="color: #00cd00;">"search-result-description"</span> <span style="color: #00cd00;">"search-result-description-with-garbage"</span> <span style="color: #00cd00;">"search-result-description-empty"</span>
                                 <span style="color: #00cd00;">"search-result-description-primary"</span> <span style="color: #00cd00;">"hrbrand"</span> <span style="color: #00cd00;">"noindex"</span> <span style="color: #00cd00;">"script"</span>
                                 <span style="color: #00cd00;">"bloko-icon-phone"</span> <span style="color: #00cd00;">"bloko-contact"</span> <span style="color: #00cd00;">"bloko-icon-initial"</span>))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">make-detect</span> ((name) <span style="color: #00cd00;">&amp;body</span> body)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((param   (gensym))
        (carlast (car (last (car body)))))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(awhen (stringp carlast)</span>
    <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(setf *detect-garbage*</span>
    <span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(remove-duplicates (append *detect-garbage*</span>
    <span style="color: #cd0000;">;;                                    </span><span style="color: #cd0000;">(list carlast)) :test #'string=)))</span>
    `(<span style="color: #00cdcd; font-weight: bold;">defun</span> ,(intern (format nil <span style="color: #00cd00;">"DETECT-~A"</span> (string-upcase (symbol-name name)))) (,param)
       (mtm ,@body
            ,param))))

(make-detect (date)
  (`(<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-list-date"</span>)
             (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-date"</span>)) ,date)
    (list <span style="color: #0000ee; font-weight: bold;">:date</span> (<span style="color: #00cdcd; font-weight: bold;">progn</span>
                  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print date)</span>
                  (<span style="color: #00cdcd; font-weight: bold;">if</span> (null date) <span style="color: #00cd00;">""</span> date)))))

(make-detect (platform)
  (`(<span style="color: #00cd00;">"span"</span>
          ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"vacancy-list-platform"</span>)
           (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_career"</span>))
          <span style="color: #00cd00;">"&#160;&#160;&#8226;&#160;&#160;"</span> (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"vacancy-list-platform__name"</span>))
                          <span style="color: #00cd00;">"CAREER.RU"</span>))
         (list <span style="color: #0000ee; font-weight: bold;">:platform</span> 'career.ru)))

(make-detect (metro)
  (`(<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"metro-station"</span>))
                 (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"metro-point"</span>) (<span style="color: #00cd00;">"style"</span> ,_))) ,metro)
         (list <span style="color: #0000ee; font-weight: bold;">:metro</span> (aif metro it <span style="color: #00cd00;">""</span>))))

(make-detect (address)
  (`(<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"searchresult__address"</span>)
             (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-address"</span>)) ,city ,@rest)
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((metro (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item in rest <span style="color: #0000ee; font-weight: bold;">:do</span>
                    (<span style="color: #00cdcd; font-weight: bold;">when</span> (and (consp item) (equal <span style="color: #0000ee; font-weight: bold;">:metro</span> (car item)))
                      (<span style="color: #00cdcd; font-weight: bold;">return</span> (cadr item))))))
      (list <span style="color: #0000ee; font-weight: bold;">:city</span> city <span style="color: #0000ee; font-weight: bold;">:metro</span> (aif metro it <span style="color: #00cd00;">""</span>)))))

(make-detect (info)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__info"</span>)) ,@rest)
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item <span style="color: #0000ee; font-weight: bold;">:in</span> rest <span style="color: #0000ee; font-weight: bold;">:when</span> (consp item) <span style="color: #0000ee; font-weight: bold;">:append</span> item)))

(make-detect (emp)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__company"</span>))
           (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,emp-id)
                 (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"link-secondary"</span>)
                 (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-employer"</span>))
                ,emp-name) ,@rest)
    (list <span style="color: #0000ee; font-weight: bold;">:emp-id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ emp-id)))
                                 <span style="color: #0000ee; font-weight: bold;">:junk-allowed</span> t)
          <span style="color: #0000ee; font-weight: bold;">:emp-name</span> (string-trim '(#\Space #\Tab #\Newline) emp-name))))

(make-detect (emp-anon)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__company"</span>)) ,@text)
    (list <span style="color: #0000ee; font-weight: bold;">:emp-anon</span> text)))

(make-detect (salary)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-list-salary"</span>) (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-compensation"</span>))
           (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"salaryCurrency"</span>) (<span style="color: #00cd00;">"content"</span> ,currency)))
           (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"baseSalary"</span>) (<span style="color: #00cd00;">"content"</span> ,salary))) ,salary-text)
    (list <span style="color: #0000ee; font-weight: bold;">:currency</span> currency <span style="color: #0000ee; font-weight: bold;">:salary</span> (parse-integer salary) <span style="color: #0000ee; font-weight: bold;">:salary-text</span> salary-text)))

(make-detect (interview)
  (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"interview-insider__link                   m-interview-insider__link-searchresult"</span>)
          (<span style="color: #00cd00;">"href"</span> ,href)
          (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-interview-insider"</span>))
         <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>)
    (list <span style="color: #0000ee; font-weight: bold;">:interview</span> href)))

    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("a" (("class" "interview-insider__link                   m-interview-insider__link-searchresult")</span>
    <span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">("href" ,href)</span>
    <span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">("data-qa" "vacancy-serp__vacancy-interview-insider"))</span>
    <span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;")</span>

(make-detect (name)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__head"</span>))
           (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"class"</span> ,(or <span style="color: #00cd00;">"search-result-item__name search-result-item__name_standard"</span>
                               <span style="color: #00cd00;">"search-result-item__name search-result-item__name_standard_plus"</span>
                               <span style="color: #00cd00;">"search-result-item__name search-result-item__name_premium"</span>))
                 (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-title"</span>) (<span style="color: #00cd00;">"href"</span> ,id) (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>)) ,name))
    (list <span style="color: #0000ee; font-weight: bold;">:id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ id)))) <span style="color: #0000ee; font-weight: bold;">:name</span> name)))

(make-detect (description)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__description"</span>)) ,@rest)
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item <span style="color: #0000ee; font-weight: bold;">:in</span> rest <span style="color: #0000ee; font-weight: bold;">:when</span> (consp item) <span style="color: #0000ee; font-weight: bold;">:append</span> item)))

(make-detect (snippet)
  (`(<span style="color: #00cd00;">"div"</span>
     ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__snippet"</span>)
      (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_snippet_requirement"</span>))
     ,text)
    (list <span style="color: #0000ee; font-weight: bold;">:snippet</span> text)))

(make-detect (premium)
  (`((<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy vacancy-serp__vacancy_premium"</span>)
     (<span style="color: #00cd00;">"class"</span>
      <span style="color: #00cd00;">"search-result-item search-result-item_premium  search-result-item_premium"</span>))
    <span style="color: #00cd00;">"premium"</span>))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">---&gt;&gt;</span>
(make-detect (standart)
  (`(<span style="color: #00cd00;">"div"</span>
     ((<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy"</span>)
      (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item search-result-item_standard "</span>))
     ,@rest)
    rest))

(make-detect (standart-plus)
  (`(<span style="color: #00cd00;">"div"</span>
     ((<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy"</span>)
      (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item search-result-item_standard_plus "</span>))
     ,@rest)
    rest))

(make-detect (response-trigger)
  (`(<span style="color: #00cd00;">"script"</span> ((<span style="color: #00cd00;">"data-name"</span> <span style="color: #00cd00;">"HH/VacancyResponseTrigger"</span>) (<span style="color: #00cd00;">"data-params"</span> <span style="color: #00cd00;">""</span>))) <span style="color: #00cd00;">"response-trigger"</span>))

(make-detect (vacancy-responded)
  (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,_) (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>) (<span style="color: #00cd00;">"class"</span> ,_)
          (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_responded"</span>)) <span style="color: #00cd00;">"&#1042;&#1099; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1083;&#1080;&#1089;&#1100;"</span>) <span style="color: #00cd00;">"vacancy-responded"</span>))

(make-detect (search-result-description)
  (`((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description"</span>)) <span style="color: #00cd00;">"search-result-description"</span>))

(make-detect (search-result-description-empty)
  (`((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description"</span>)) <span style="color: #00cd00;">"search-result-description-empty"</span>))

(make-detect (search-result-description-non-empty)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description"</span>)) ,@rest) rest))

(make-detect (star)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>))
           (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__star"</span>))
                  ,@_)) <span style="color: #00cd00;">"star"</span>))

(make-detect (trigger-button)
  (`((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__button HH-VacancyResponseTrigger-Button"</span>)) <span style="color: #00cd00;">"trigger-button"</span>))

(make-detect (response-popup-link)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__response"</span>))
           (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,_)
                 (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"bloko-button HH-VacancyResponsePopup-Link"</span>)
                 (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_response"</span>))
                <span style="color: #00cd00;">"&#1054;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103;"</span>)) <span style="color: #00cd00;">"response-popup-link"</span>))

(make-detect (response-popup-script )
  (`(<span style="color: #00cd00;">"script"</span>
     ((<span style="color: #00cd00;">"data-name"</span> <span style="color: #00cd00;">"HH/VacancyResponsePopup"</span>)
      (<span style="color: #00cd00;">"data-params"</span> ,_))) <span style="color: #00cd00;">"vacancy-response-popup-script"</span>))

(make-detect (emp-logo)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>))
           (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,emp-id)
                 (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-employer-logo"</span>)
                 (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__company-image-link"</span>))
                (<span style="color: #00cd00;">"img"</span>
                 ((<span style="color: #00cd00;">"src"</span> ,emp-img) (<span style="color: #00cd00;">"alt"</span> ,emp-alt)
                  (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__logo"</span>)))))
    <span style="color: #00cd00;">"emp-logo"</span>))

(make-detect (search-result-description)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>))) <span style="color: #00cd00;">"search-result-description"</span>))


(make-detect (search-result-description-empty)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>)) ,_) <span style="color: #00cd00;">"search-result-description-empty"</span>))

(make-detect (search-result-description-with-garbage)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>))  ,@rest)
    <span style="color: #00cd00;">"search-result-description-with-garbage"</span>))

(make-detect (search-result-description-primary)
  (`((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item search-result-description__item_primary"</span>)) <span style="color: #00cd00;">"search-result-description-primary"</span>))

(make-detect (hrbrand)
  (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"title"</span> <span style="color: #00cd00;">"&#1055;&#1088;&#1077;&#1084;&#1080;&#1103; HRBrand"</span>) (<span style="color: #00cd00;">"href"</span> ,_) (<span style="color: #00cd00;">"rel"</span> <span style="color: #00cd00;">"nofollow"</span>)
          (<span style="color: #00cd00;">"class"</span> ,_)
          (<span style="color: #00cd00;">"data-qa"</span> ,_)) <span style="color: #00cd00;">"&#160;"</span>) <span style="color: #00cd00;">"hrbrand"</span>))

(make-detect (vacancy_snippet_responsibility)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__snippet"</span>)
            (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_snippet_responsibility"</span>))
         ,text)
    (list <span style="color: #0000ee; font-weight: bold;">:snippet_responsibility</span> text)))

(make-detect (noindex)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-description__item"</span>)) <span style="color: #00cd00;">"noindex"</span> <span style="color: #00cd00;">"hrbrand"</span>
           <span style="color: #00cd00;">"/noindex"</span>)
    <span style="color: #00cd00;">"noindex"</span>))

(make-detect (script)
  (`(<span style="color: #00cd00;">"script"</span> ,@rest) <span style="color: #00cd00;">"script"</span>))

(make-detect (bloko-icon-initial)
  (`(<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"bloko-icon bloko-icon_done bloko-icon_done-initial-action"</span>)) <span style="color: #00cd00;">"script"</span>) <span style="color: #00cd00;">"bloko-icon-initial"</span>))

(make-detect (bloko-icon-phone)
  (`(<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"bloko-icon bloko-icon_phone"</span>))) <span style="color: #00cd00;">"bloko-icon-phone"</span>))

(make-detect (bloko-contact)
  (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__phone"</span>))
           (<span style="color: #00cd00;">"button"</span>
            ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"bloko-button"</span>) (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_contacts"</span>))
            <span style="color: #00cd00;">"script"</span> <span style="color: #00cd00;">"bloko-icon-phone"</span> <span style="color: #00cd00;">"script"</span>
            (<span style="color: #00cd00;">"div"</span>
             ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"g-hidden HH-VacancyContactsLoader-Content"</span>)
              (<span style="color: #00cd00;">"data-attach"</span> <span style="color: #00cd00;">"dropdown-content-placeholder"</span>)))))
    <span style="color: #00cd00;">"bloko-contact"</span>))

(make-detect (bloko-button-rest)
  (`(<span style="color: #0000ee; font-weight: bold;">:CITY</span> ,city ,@rest)
    (append `(<span style="color: #0000ee; font-weight: bold;">:CITY</span> ,city ,(remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                          (or
                                           (member x '(<span style="color: #00cd00;">"div"</span> <span style="color: #00cd00;">"trigger-button"</span> <span style="color: #00cd00;">"vacancy-response-popup-script"</span> <span style="color: #00cd00;">"response-popup-link"</span>) <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)
                                           (listp x)))
                                      rest)))))

(remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
               (or
                (listp x)
                (member x '(<span style="color: #00cd00;">"div"</span> <span style="color: #00cd00;">"trigger-button"</span> <span style="color: #00cd00;">"vacancy-response-popup-script"</span> <span style="color: #00cd00;">"response-popup-link"</span>) <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
           '(<span style="color: #0000ee; font-weight: bold;">:CITY</span> <span style="color: #00cd00;">"&#1057;&#1072;&#1085;&#1082;&#1090;-&#1055;&#1077;&#1090;&#1077;&#1088;&#1073;&#1091;&#1088;&#1075;"</span> <span style="color: #0000ee; font-weight: bold;">:METRO</span> <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:DATE</span> <span style="color: #00cd00;">"22&#160;&#1084;&#1072;&#1088;&#1090;&#1072;"</span> <span style="color: #0000ee; font-weight: bold;">:PLATFORM</span> CAREER.RU
             (((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__phone"</span>))
              (<span style="color: #00cd00;">"button"</span>
               ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"bloko-button"</span>) (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_contacts"</span>))
               (((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"g-hidden HH-VacancyContactsLoader-Content"</span>)
                 (<span style="color: #00cd00;">"data-attach"</span> <span style="color: #00cd00;">"dropdown-content-placeholder"</span>)))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">detect-garbage-elts</span> (tree)
  (mtm (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"class"</span> _) (<span style="color: #00cd00;">"href"</span> _) (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy-interview-insider"</span>))
              <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1074;&#1100;&#1102; &#1086; &#1078;&#1080;&#1079;&#1085;&#1080; &#1074; &#1082;&#1086;&#1084;&#1087;&#1072;&#1085;&#1080;&#1080;"</span>) 'INTERVIEW)
       (mtm (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,_) (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>) (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__label search-result-item__label_invited"</span>)
                    (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_invited"</span>)) <span style="color: #00cd00;">"&#1042;&#1099; &#1087;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1099;!"</span>) '(<span style="color: #0000ee; font-weight: bold;">:INVITED</span> <span style="color: #00cd00;">"invited"</span>))
            (mtm (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,_) (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>) (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__label search-result-item__label_discard"</span>)
                         (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_rejected"</span>)) <span style="color: #00cd00;">"&#1042;&#1072;&#1084; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;&#1080;"</span>) '(<span style="color: #0000ee; font-weight: bold;">:DECINE</span> <span style="color: #00cd00;">"decine"</span>))
                 (mtm (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,_) (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>) (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__label search-result-item__label_discard"</span>)
                              (<span style="color: #00cd00;">"data-qa"</span> <span style="color: #00cd00;">"vacancy-serp__vacancy_rejected"</span>)) <span style="color: #00cd00;">"&#1042;&#1072;&#1084; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;&#1080;"</span>) '(<span style="color: #0000ee; font-weight: bold;">:REJECTED</span> <span style="color: #00cd00;">"regected"</span>))
                      (mtm (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"search-result-item__image"</span>)) ,_) '<span style="color: #0000ee; font-weight: bold;">:ITEM-IMAGE</span>)
                           tree))))))

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*last-parse-data*</span> nil)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print *last-parse-data*)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(hh-parse-vacancy-teasers *last-parse-data*)</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">)</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tree-plist-p</span> (pl)
  <span style="color: #00cd00;">"Returns T if L is a plist (list with alternating keyword elements). "</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((null pl)                 t)
        ((and (listp pl)
              (keywordp (car pl))
              (cdr pl))            (tree-plist-p (cddr pl)))
        ((and (listp pl)
              (listp (car pl)))    (and (tree-plist-p (car pl))
                                        (tree-plist-p (cdr pl))))
        (t                         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
                                     <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print pl)</span>
                                     nil))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(untrace tree-plist-p)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(tree-plist-p</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">'("div" "premium" "response-trigger" "vacancy-responded"</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">("star"</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">("div" "search-result-description-primary"</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(:ID 12359860 :NAME "ASP.NET MVC Developer")</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(:SNIPPET_RESPONSIBILITY ("resp" NIL))</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(:SNIPPET</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">"&#1054;&#1087;&#1099;&#1090; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080; &#1085;&#1072; &#1087;&#1083;&#1072;&#1090;&#1092;&#1086;&#1088;&#1084;&#1077; .NET with C# - &#1085;&#1077; &#1084;&#1077;&#1085;&#1077;&#1077; 2 &#1083;&#1077;&#1090;. ASP.NET MVC. HTML, CSS, JavaScript. SQL Server. ")</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(:EMP-ID 208902 :EMP-NAME "&#1047;&#1040;&#1054; &#1040;&#1088;&#1082;&#1072;&#1076;&#1080;&#1103;")</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(:CITY "&#1057;&#1072;&#1085;&#1082;&#1090;-&#1055;&#1077;&#1090;&#1077;&#1088;&#1073;&#1091;&#1088;&#1075;" (:METRO "" :DATE "6&#160;&#1072;&#1087;&#1088;&#1077;&#1083;&#1103;")))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">"emp-logo" "search-result-description")))</span>


(<span style="color: #00cdcd; font-weight: bold;">define-condition</span> <span style="color: #0000ee; font-weight: bold;">malformed-vacancy</span> (<span style="color: #cd0000; font-weight: bold;">error</span>)
  ((text <span style="color: #0000ee; font-weight: bold;">:initarg</span> <span style="color: #0000ee; font-weight: bold;">:text</span> <span style="color: #0000ee; font-weight: bold;">:reader</span> text)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">hh-parse-vacancy-teasers</span> (html)
  <span style="color: #00cd00;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080;&#1079; html"</span>
  (dbg <span style="color: #00cd00;">"hh-parse-vacancy-teasers"</span>)
  (setf *last-parse-data* html)
  (-&gt;&gt; (html-to-tree html)
       (extract-search-results)
       (detect-platform)
       (detect-date)
       (detect-metro)
       (detect-address)
       (detect-info)
       (detect-emp)
       (detect-emp-anon)
       (detect-salary)
       (detect-interview)
       (detect-name)
       (detect-snippet)
       (detect-premium)
       (detect-standart)
       (detect-standart-plus)
       (detect-response-trigger)
       (detect-garbage-elts)
       (detect-vacancy-responded)
       (detect-search-result-description)
       (detect-search-result-description-with-garbage)
       (detect-star)
       (detect-trigger-button)
       (detect-response-popup-link)
       (detect-response-popup-script)
       (detect-emp-logo)
       (detect-search-result-description)
       (detect-search-result-description-primary)
       (detect-search-result-description-empty)
       (detect-hrbrand)
       (detect-vacancy_snippet_responsibility)
       (detect-noindex)
       (detect-script)
       (detect-bloko-icon-phone)
       (detect-bloko-icon-initial)
       (detect-bloko-contact)
       (detect-search-result-description-non-empty)
       (detect-bloko-button-rest)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">filter garbage data</span>
       (maptree-if #'consp
                   #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (values
                        (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                       (<span style="color: #00cdcd; font-weight: bold;">when</span> (stringp x)
                                         (or
                                          (string= x <span style="color: #00cd00;">"div"</span>)
                                          (find x *detect-garbage* <span style="color: #0000ee; font-weight: bold;">:test</span> #'string=)
                                          )))
                                   x)
                        #'mapcar)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">error if malformed plist</span>
       (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                   (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (tree-plist-p x))
                       (<span style="color: #00cdcd; font-weight: bold;">progn</span>
                         (dbg <span style="color: #00cd00;">"~A"</span> (bprint x))
                         (<span style="color: #cd0000; font-weight: bold;">error</span> 'malformed-vacancy <span style="color: #0000ee; font-weight: bold;">:text</span>))
                       x)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">linearize for each elt</span>
       (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (tree)
                   (<span style="color: #00cdcd; font-weight: bold;">let</span> ((linearize))
                     (maptree #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                  (setf linearize
                                        (append linearize (list x))))
                              tree)
                     linearize)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">parse-salary</span>
       (mapcar #'parse-salary)
       ))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(hh-parse-vacancy-teasers *last-parse-data*))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(hh-parse-vacancy-teasers</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(hh-get-page "http://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;salary=&amp;currency_code=RUR&amp;only_with_salary=true&amp;experience=doesNotMatter&amp;order_by=salary_desc&amp;search_period=30&amp;items_on_page=100&amp;no_magic=true" temp-cookie-jar "http://spb.hh.ru/")))</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-2-3-1"></a>Трансформация дерева<br  /><div class="outline-text-5" id="text-4-2-3-1">
<p>
Описание вакансии (или ее тизера), после преобразования из html, представляет из себя
дерево, в котором нам важна структура, так как требования, обязанности и прочее
описываются списком. В этом списке много лишнего форматирования, для удаления которого
нам необходимо уметь преобразовывать (трансформировать) дерево.
</p>
</div>

<ol class="org-ol"><li><a id="sec-4-2-3-1-1"></a>Match-tree<br  /><div class="outline-text-6" id="text-4-2-3-1-1">
<p>
Чтобы эффективнее (с точки зрения скорости написания кода) разбирать вакансии мы
разберем всю полученную страницу в дерево, из которого будем извлекать необходимые нам
элементы.
</p>

<p>
Чтобы делать это будем обходить дерево, сопоставляя каждый узел с предикатом, в
который скомпилируется образец. Начнем с обхода дерева, для этого напишем рекурсивную
функцию <code>match-tree</code>, которую определим с помощью <code>labels</code>, чтобы окружить ее формой
<code>let</code> с аккумулятором.
</p>

<p>
Определим параметры этой функции:
</p>
<ul class="org-ul">
<li><code>tree</code> - под-дерево, которое мы рекурсивно обходим
</li>
<li><code>predict</code> - функция-предикат, которая может совпасть с обходимым поддеревом
</li>
<li><code>if-match</code> - параметр чтобы иметь возможность передавать <code>стратегию</code>. Про стратегии
поговорим чуть позже.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_tree">(<span style="color: #00cdcd; font-weight: bold;">labels</span> ((match-tree (tree f-predict <span style="color: #00cd00;">&amp;optional</span> (if-match <span style="color: #0000ee; font-weight: bold;">:return-first-match</span>))
         (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((null tree) nil)
               ((atom tree) nil)
               (t
                &lt;&lt;cons&gt;&gt;))))
  &lt;&lt;call&gt;&gt;)
</pre>
</div>

<p>
Теперь переходим к рассмотрению плейсхолдера <code>cons</code>, который выполняет основную
работу. В первую очередь нам следует сравнить текущий узел с параметром <code>predict</code> и в
случае если <code>predict</code> вернул T - выполнить какие-то действия. В противном случае -
обрабатываем поддеревья этого узла.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cons">(<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall f-predict tree)
    &lt;&lt;match_ok&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="sub_trees">(cons
 (funcall #'match-tree (car tree) f-predict if-match)
 (funcall #'match-tree (cdr tree) f-predict if-match))
</pre>
</div>

<p>
<b>Теперь о стратегиях</b>
</p>

<p>
В случае, когда узел совпал с <code>predict</code> мы можем реализовать следующие стратегии:
</p>
<ul class="org-ul">
<li>Немедленно вернуть совпавший узел и более не обрабатывать никакие узлы.
</li>
<li>Прекратить обработку всех подузлов совпавшего узла, запомнить его и перейти к
обработке следующего за ним.
</li>
<li>Запомнить совпавший узел и продолжить обработку вглубь совпавшего узла, а затем и
всех остальных узлов.
</li>
<li>Наиболее общий вариант - применить к сопавшему узлу переданную лямбда-функцию,
которая может с ним что-то сделать - например записать в какую-нибудь переменную на
более высоком уровне.
</li>
</ul>
<p>
Реализуем эти стратегии друг за другом.
</p>

<p>
Реализуем выбор стратегии в общих чертах - будем использовать <code>cond</code> по параметру
<code>if-match</code>. В случае, если в этом параметре не лежит keyword symbol с именем
стратегии - считаем, что там функция, если это не так - сигнализируем ошибку
<code>strategy-not-implemented</code> (которая пока нигде не определена - я считаю что ее имя
говорит само за себя).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="match_ok">(<span style="color: #00cdcd; font-weight: bold;">cond</span> ((equal if-match <span style="color: #0000ee; font-weight: bold;">:return-first-match</span>)
       &lt;&lt;return_first_match&gt;&gt;)
      ((equal if-match <span style="color: #0000ee; font-weight: bold;">:return-first-level-match</span>)
       &lt;&lt;return_first_level_match&gt;&gt;)
      ((equal if-match <span style="color: #0000ee; font-weight: bold;">:return-all-match</span>)
       &lt;&lt;return_all_match&gt;&gt;)
      ((equal 'function (type-of if-match))
       (funcall if-match tree))
      (t (<span style="color: #cd0000; font-weight: bold;">error</span> 'strategy-not-implemented)))
</pre>
</div>

<p>
Теперь приступим к реализации (первой) стратегии: немедленного возврата совпавшего
узла. Для этого нам понадобится определить внешнюю функцию <code>tree-match</code>, чтобы
возвращаться из нее, а не из текущего рекурсивного вызова <code>match-tree</code>. Мы сделаем это
несколько позже, а пока заполним плейсхолдер <code>return-first-match</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_match">(<span style="color: #00cdcd; font-weight: bold;">return-from</span> tree-match tree)
</pre>
</div>

<p>
Теперь переходим ко второй стратегии - прекратить обработку всех подузлов сопавшего
узла, запомнить его и перейти к обработке следующего за ним. Нам понадобится
переменная <code>collect</code> чтобы хранить значения, запомним это и реализуем добавление узла
в нее. После того, как узел сохранен, мы не проводим обработку его под-деревьев, а
переходим в следующему узлу этого уровня.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_level_match">(setf collect
      (append collect (list tree)))
</pre>
</div>

<p>
И наконец, реализуем последнюю оставшуюся стратегию, которая представляет из себя
расширение предыдущей, но с обработкой вложенных узлов. Так и запишем:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_all_match">(<span style="color: #00cdcd; font-weight: bold;">progn</span>
    &lt;&lt;return_first_level_match&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<p>
Теперь нам осталось лишь правильно возвращать результат. Если используются
аккумулирующие стратегии, то мы возвращаем содержимое переменной <code>collect</code>, в случае
немедленного возврата совпавшего узла мы никогда не окажемся в этом месте, а в случае
передачи в <code>if-match</code> лямбда-фукции - мы будем считать, что она как-нибудь сама
заботится о передачи значений. Поэтому всегда будем возвращать <code>collect</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="call">(match-tree tree predict if-match)
collect
</pre>
</div>

<p>
Осталось обернуть это все во внешнюю функцию, с аккумулятором:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="tree_match">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tree-match</span> (tree predict <span style="color: #00cd00;">&amp;optional</span> (if-match <span style="color: #0000ee; font-weight: bold;">:return-first-match</span>))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((collect))
    &lt;&lt;cond_tree&gt;&gt;))
</pre>
</div>

<p>
Но для удобной работы этого недостаточно, поэтому напишем компилер шаблона в
соответствующий ему <code>predict</code>. Этот компилер будет принимать в качестве параметра
форму, которая будет связываться с элементами шаблона с помощью
<code>destructuring-bind</code>. Попытка связывания будет проводиться для каждого элемента
дерева. Ошибки, которые возникают в случае невозможности связывания, игнорируются.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-predict</span> (pattern <span style="color: #00cd00;">&amp;body</span> body)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lambda-param (gensym)))
    `#'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (,lambda-param)
         (<span style="color: #00cdcd; font-weight: bold;">handler-case</span>
             (<span style="color: #00cdcd; font-weight: bold;">destructuring-bind</span> ,pattern
                 ,lambda-param
               ,@body)
           (sb-kernel::arg-count-error nil)
           (sb-kernel::defmacro-bogus-sublist-error nil)))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1 '</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(with-predict (a ((b c)) d &amp;rest e)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(aif (and (string= a "div")</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">(string= c "title b-vacancy-title"))</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(prog1 it</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(setf **a** a)</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(setf **b** b)))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; #'(LAMBDA (LAMBDA-PARAM)</span>
<span style="color: #cd0000;">;;        </span><span style="color: #cd0000;">(HANDLER-CASE</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(DESTRUCTURING-BIND</span>
<span style="color: #cd0000;">;;                  </span><span style="color: #cd0000;">(A ((B C)) D &amp;REST E)</span>
<span style="color: #cd0000;">;;                </span><span style="color: #cd0000;">LAMBDA-PARAM</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">(AIF (AND (STRING= A "div") (STRING= C "title b-vacancy-title"))</span>
<span style="color: #cd0000;">;;                   </span><span style="color: #cd0000;">(PROG1 IT (SETF **A** A) (SETF **B** B))))</span>
<span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(SB-KERNEL::ARG-COUNT-ERROR NIL)</span>
<span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(SB-KERNEL::DEFMACRO-BOGUS-SUBLIST-ERROR NIL))), T</span>
</pre>
</div>

<p>
Вот так, к примеру, это можно совместить с поиском по дереву:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(tree-match '(<span style="color: #00cd00;">"div"</span>
              ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-custom g-round"</span>
                (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"title"</span>) (<span style="color: #00cd00;">"content"</span> <span style="color: #00cd00;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
                (<span style="color: #00cd00;">"h1"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"title b-vacancy-title"</span>)) <span style="color: #00cd00;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
                (<span style="color: #00cd00;">"table"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l"</span>))
                         (<span style="color: #00cd00;">"tr"</span> NIL
                               (<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"colspan"</span> <span style="color: #00cd00;">"2"</span>) (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-cell"</span>)))
                               (<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-cell"</span>)))))))
              ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"g-round plus"</span>))`
              (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"title"</span>) (<span style="color: #00cd00;">"content"</span> <span style="color: #00cd00;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>))))
            (<span style="color: #00cdcd; font-weight: bold;">with-predict</span> (a b <span style="color: #00cd00;">&amp;rest</span> c)
              (aif (and (stringp a)
                        (string= a <span style="color: #00cd00;">"class"</span>))
                   (<span style="color: #00cdcd; font-weight: bold;">prog1</span> it
                     (setf **a** a)
                     (setf **b** b))))
            <span style="color: #0000ee; font-weight: bold;">:return-all-match</span>)
</pre>
</div>

<p>
Для еще большей лаконичности мы можем определить оборачивающий макрос, который
позволит нам не писать ничего, кроме условия в <code>aif</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict_if">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;with_predict&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-predict-if</span> (pattern <span style="color: #00cd00;">&amp;body</span> condition)
  `(<span style="color: #00cdcd; font-weight: bold;">with-predict</span> ,pattern
     (aif ,@condition
          (<span style="color: #00cdcd; font-weight: bold;">prog1</span> it
            ,@(mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                          `(setf ,(intern (format nil <span style="color: #00cd00;">"**~A**"</span> (symbol-name x))) ,x))
                      (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                     (or (equal x '<span style="color: #00cd00;">&amp;rest</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;optional</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;body</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;key</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;allow-other-keys</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;environment</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;aux</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;whole</span>)
                                         (equal x '<span style="color: #00cd00;">&amp;allow-other-keys</span>)))
                                 (alexandria:flatten pattern)))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1 '</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(with-predict-if (a b &amp;rest c)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(and (stringp a)</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(string= a "class"))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (WITH-PREDICT (A B &amp;REST C)</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(AIF (AND (STRINGP A) (STRING= A "class"))</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(PROG1 IT</span>
<span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">(SETF **A** A)</span>
<span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">(SETF **B** B)</span>
<span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">(SETF **C** C))))</span>
</pre>
</div>

<p>
Таким образом мы инжектируем переменные шаблона в глобальную область видимости, если
они не определены в более высокоуровневом <code>let</code>.
</p>

<p>
Теперь мы можем использовать <code>tree-match</code> так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(print
 (tree-match '(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-custom g-round"</span>))
               (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"title"</span>) (<span style="color: #00cd00;">"content"</span> <span style="color: #00cd00;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
               (<span style="color: #00cd00;">"h1"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"title b-vacancy-title"</span>)) <span style="color: #00cd00;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
               (<span style="color: #00cd00;">"table"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l"</span>))
                (<span style="color: #00cd00;">"tbody"</span> NIL
                 (<span style="color: #00cd00;">"tr"</span> NIL
                       (<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"colspan"</span> <span style="color: #00cd00;">"2"</span>) (<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-cell"</span>))
                             (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"employer-marks g-clearfix"</span>))
                                    (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"companyname"</span>))
                                           (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"hiringOrganization"</span>) (<span style="color: #00cd00;">"href"</span> <span style="color: #00cd00;">"/employer/1529644"</span>))
                                                <span style="color: #00cd00;">"&#1054;&#1054;&#1054; &#1053;&#1080;&#1084;&#1073;&#1083;"</span>))))
                       (<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-cell"</span>)))))))
             (<span style="color: #00cdcd; font-weight: bold;">with-predict-if</span> (a b <span style="color: #00cd00;">&amp;rest</span> c)
               (and (stringp a)
                    (string= a <span style="color: #00cd00;">"class"</span>)))
             <span style="color: #0000ee; font-weight: bold;">:return-all-match</span>))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (("class" "b-vacancy-custom g-round") ("class" "title b-vacancy-title")</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">("class" "l") ("class" "l-cell") ("class" "employer-marks g-clearfix")</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">("class" "companyname") ("class" "l-cell"))</span>

(print **b**)
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; "l-cell"</span>
</pre>
</div>

<p>
Тут оставим адаптацию <code>with-predict</code> для <code>maptree-if</code>, рассмотренного в следующем
разделе
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="drop_f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-predict-maptree</span> (pattern condition replace tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lambda-param (gensym)))
    `(maptree-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (,lambda-param)
                     (and (consp ,lambda-param)
                        (funcall (<span style="color: #00cdcd; font-weight: bold;">with-predict-if</span> ,pattern
                                   ,condition)
                                 ,lambda-param)))
                 ,replace
                 ,tree)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">'(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(and (equal b 'ping))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">#'(lambda (x)</span>
<span style="color: #cd0000;">;;        </span><span style="color: #cd0000;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">'(progn (ping (ping ping (ping 1))) ping)))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(and (equal b 'ping))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">#'(lambda (x)</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">'(progn (ping (ping ping (ping 1))) ping))</span>
</pre>
</div>

<p>
Ну и "всем дочитавшим до этого места" могу теперь сообщить, что применение
pattern-matchinga из пакета <code>optima</code> делает вышеприведенный код существенно менее
полезным :)
</p>
</div>
</li>

<li><a id="sec-4-2-3-1-2"></a>Maptree-if<br  /><div class="outline-text-6" id="text-4-2-3-1-2">
<p>
Функция <code>maptree-if</code> - рекурсивный преобразователь, который возвращает новое дерево,
рекурсивно вызывая аргумент <code>transformer</code> на <code>sub-tree</code>, которые удовлетворяют
аргументу <code>predicate</code>.
</p>

<p>
Аргумент <code>predicate</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает T или NIL
</p>

<p>
Аргумент <code>transformer</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code>
и возвращает <code>atom</code> или <code>subtree</code> в первом параметре, а во втором может возвратить
функцию <code>control</code>. Если эта функция возвращена, тогда дерево возвращается с замененным
<code>transformer</code>-ом узлами по следующему алгоритму:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(funcall control
         #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
             (maptree-if predicate transformer x))
         transformed-tree)
</pre>
</div>

<p>
В противном случае оно возвращается как есть.
</p>

<p>
Собственно функция <code>maptree-if</code>, которую мы помещаем в утилиты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">maptree-if</span> (predicate transformer tree)
  (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (t-tree control)
      (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall predicate tree)
          (funcall transformer tree)
          (values tree #'mapcar))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                     (maptree-if predicate transformer x))
                 t-tree)
        t-tree)))
</pre>
</div>

<p>
Несколько примеров работы:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1053;&#1077;&#1088;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                `(pong ,@(cdr x)))
            '(<span style="color: #00cdcd; font-weight: bold;">progn</span> (ping (ping (ping 1)))))
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (PROGN (PONG (PING (PING 1))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1056;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (values `(pong ,@(cdr x)) #'mapcar))
            '(<span style="color: #00cdcd; font-weight: bold;">progn</span> (ping (ping (ping 1)))
              ping))
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (PROGN (PONG (PONG (PONG 1))))</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-4-2-3-1-3"></a>Maptree-transform<br  /><div class="outline-text-6" id="text-4-2-3-1-3">
<p>
<code>maptree-transform</code> - это аналог maptree-if, но здесь одна функция
(<code>predicate-transformer</code>) и ищет и трансформирует узел дерева:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="maptree_transform">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">maptree-transform</span> (predicate-transformer tree)
  (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                     (maptree-transform predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">mtm - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree-transform</span>
(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">mtm</span> (transformer tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lambda-param (gensym)))
    `(maptree-transform #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (,lambda-param)
                            (values (match ,lambda-param ,transformer)
                                    #'mapcar))
                        ,tree)))
</pre>
</div>
</div>
</li></ol>
</li>

<li><a id="sec-4-2-3-2"></a>Определение минимальной и максимальной зарплаты<br  /><div class="outline-text-5" id="text-4-2-3-2">
<div class="org-src-container">

<pre class="src src-lisp" id="parse_salary">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">parse-salary</span> (vacancy)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((currency (getf vacancy <span style="color: #0000ee; font-weight: bold;">:CURRENCY</span>))
        (salary-text (ppcre:regex-replace-all <span style="color: #00cd00;">"&#160;"</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-text</span>) <span style="color: #00cd00;">""</span>))
        (salary-min nil)
        (salary-max nil))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((equal currency <span style="color: #00cd00;">"RUR"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #00cd00;">" &#1088;&#1091;&#1073;."</span> salary-text <span style="color: #00cd00;">""</span>)))
          ((equal currency <span style="color: #00cd00;">"USD"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #00cd00;">" USD"</span> salary-text <span style="color: #00cd00;">""</span>)))
          ((equal currency <span style="color: #00cd00;">"EUR"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #00cd00;">" EUR"</span> salary-text <span style="color: #00cd00;">""</span>)))
          ((equal currency <span style="color: #00cd00;">"UAH"</span>)
           (setf salary-text (ppcre:regex-replace-all <span style="color: #00cd00;">" &#1075;&#1088;&#1085;."</span> salary-text <span style="color: #00cd00;">""</span>)))
          ((equal currency nil)
           'nil)
          (t (<span style="color: #00cdcd; font-weight: bold;">progn</span>
               (print (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>))
               (err 'unk-currency))))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((search <span style="color: #00cd00;">"&#1086;&#1090; "</span> salary-text)
           (setf salary-min (parse-integer (ppcre:regex-replace-all <span style="color: #00cd00;">"&#1086;&#1090; "</span> salary-text <span style="color: #00cd00;">""</span>))))
          ((search <span style="color: #00cd00;">"&#1076;&#1086; "</span> salary-text)
           (setf salary-max (parse-integer (ppcre:regex-replace-all <span style="color: #00cd00;">"&#1076;&#1086; "</span> salary-text <span style="color: #00cd00;">""</span>))))
          ((search <span style="color: #00cd00;">"&#8211;"</span> salary-text)
           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((splt (ppcre:split <span style="color: #00cd00;">"&#8211;"</span> salary-text)))
             (setf salary-min (parse-integer (car splt)))
             (setf salary-max (parse-integer (cadr splt)))))
          ((search <span style="color: #00cd00;">"-"</span> salary-text)
           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((splt (ppcre:split <span style="color: #00cd00;">"-"</span> salary-text)))
             (setf salary-min (parse-integer (car splt)))
             (setf salary-max (parse-integer (cadr splt))))))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (null salary-min)
      (setf salary-min salary-max))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (null salary-max)
      (setf salary-max salary-min))
    (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-min</span>) salary-min)
    (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>) salary-max)
    vacancy))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(hh-parse-vacancy-teasers</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(hh-get-page "http://spb.hh.ru/search/vacancy?text=&amp;specialization=1&amp;area=2&amp;salary=&amp;currency_code=RUR&amp;only_with_salary=true&amp;experience=doesNotMatter&amp;order_by=salary_desc&amp;search_period=30&amp;items_on_page=100&amp;no_magic=true"))</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-2-4" class="outline-4">
<h4 id="sec-4-2-4"><span class="section-number-4">4.2.4</span> Разбор вакансий (<code>hh-parse-vacancy</code>)</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
Теперь, можно написать функцию, которая трансформирует описание, очищая его от всего
лишнего:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="transform_description">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">transform-description</span> (tree-descr)
  (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((rem-space (tree)
             (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((consp tree) (cons (rem-space (car tree))
                                       (rem-space (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (equal x <span style="color: #00cd00;">" "</span>))
                                                             (cdr tree)))))
                   (t tree))))
    (append `((<span style="color: #0000ee; font-weight: bold;">:p</span>))
            (mtm (`(<span style="color: #00cd00;">"p"</span> nil ,@in) `((<span style="color: #0000ee; font-weight: bold;">:p</span>) ,@in))
                 (mtm (`(<span style="color: #00cd00;">"ul"</span> nil ,@in) `((<span style="color: #0000ee; font-weight: bold;">:ul</span>) ,@in))
                      (mtm (`(<span style="color: #00cd00;">"li"</span> nil ,@in) `((<span style="color: #0000ee; font-weight: bold;">:li</span>) ,@in))
                           (mtm (`(<span style="color: #00cd00;">"em"</span> nil ,@in) `((<span style="color: #0000ee; font-weight: bold;">:b</span>) ,@in))
                                (mtm (`(<span style="color: #00cd00;">"strong"</span> nil ,@in) `((<span style="color: #0000ee; font-weight: bold;">:b</span>) ,@in))
                                     (mtm (`(<span style="color: #00cd00;">"br"</span>) `((<span style="color: #0000ee; font-weight: bold;">:br</span>)))
                                          (rem-space tree-descr))))))))))
</pre>
</div>

<p>
И, наконец, применим все что мы подготовили, чтобы разобрать вакансию:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;transform_description&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">header-extractor</span> (tree)
  (mtm (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-custom g-round"</span>)) (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"title"</span>) (<span style="color: #00cd00;">"content"</span> ,_)))
                (<span style="color: #00cd00;">"h1"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"title b-vacancy-title"</span>)) ,name ,@archive) ,@rest)
         (<span style="color: #00cdcd; font-weight: bold;">return-from</span> header-extractor
           (append (list <span style="color: #0000ee; font-weight: bold;">:name</span> name <span style="color: #0000ee; font-weight: bold;">:archive</span> (<span style="color: #00cdcd; font-weight: bold;">if</span> archive t nil))
                   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(block emp-block (mtm (`("div" (("class" "companyname")) ("a" (("itemprop" "hiringOrganization") ("href" ,emp-lnk)) ,emp-name))</span>
                   <span style="color: #cd0000;">;;                         </span><span style="color: #cd0000;">(return-from emp-block</span>
                   <span style="color: #cd0000;">;;                           </span><span style="color: #cd0000;">(list :emp-id (parse-integer (car (last (split-sequence:split-sequence #\/ emp-lnk))) :junk-allowed t)</span>
                   <span style="color: #cd0000;">;;                                 </span><span style="color: #cd0000;">:emp-name emp-name)))</span>
                   <span style="color: #cd0000;">;;                       </span><span style="color: #cd0000;">rest))</span>
                   )))
       tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">company-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((candidat (mtm (`(<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"hiringOrganization"</span>) (<span style="color: #00cd00;">"href"</span> ,emp-lnk)) ,emp-name)
                       (<span style="color: #00cdcd; font-weight: bold;">return-from</span> company-extractor
                         (list <span style="color: #0000ee; font-weight: bold;">:emp-id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ emp-lnk))) <span style="color: #0000ee; font-weight: bold;">:junk-allowed</span> t)
                               <span style="color: #0000ee; font-weight: bold;">:emp-name</span> emp-name)))
                     tree)))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (tree-plist-p candidat))
        (list <span style="color: #0000ee; font-weight: bold;">:emp-id</span> 0
              <span style="color: #0000ee; font-weight: bold;">:emp-name</span> <span style="color: #00cd00;">""</span>)
        candidat)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">salary-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((salary-result (<span style="color: #00cdcd; font-weight: bold;">block</span> salary-extract
                         (mtm (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-paddings"</span>))
                                       (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"salaryCurrency"</span>) (<span style="color: #00cd00;">"content"</span> ,currency)))
                                       (<span style="color: #00cd00;">"meta"</span> ((<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"baseSalary"</span>) (<span style="color: #00cd00;">"content"</span> ,base-salary)))
                                       ,salary-text)
                                (<span style="color: #00cdcd; font-weight: bold;">return-from</span> salary-extract (list <span style="color: #0000ee; font-weight: bold;">:currency</span> currency <span style="color: #0000ee; font-weight: bold;">:base-salary</span> (parse-integer base-salary) <span style="color: #0000ee; font-weight: bold;">:salary-text</span> salary-text)))
                              tree))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 6 (length salary-result))
        salary-result
        (list <span style="color: #0000ee; font-weight: bold;">:currency</span> nil <span style="color: #0000ee; font-weight: bold;">:base-salary</span> nil <span style="color: #0000ee; font-weight: bold;">:salary-text</span> nil))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">city-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((city-result (<span style="color: #00cdcd; font-weight: bold;">block</span> city-extract (mtm (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-content-colum-2 b-v-info-content"</span>)) (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-paddings"</span>)) ,city))
                                                (<span style="color: #00cdcd; font-weight: bold;">return-from</span> city-extract (list <span style="color: #0000ee; font-weight: bold;">:city</span> city))) tree))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 2 (length city-result)) city-result (list <span style="color: #0000ee; font-weight: bold;">:city</span> nil))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">exp-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((exp-result (<span style="color: #00cdcd; font-weight: bold;">block</span> exp-extract (mtm (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-content-colum-3 b-v-info-content"</span>))
                                                    (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"l-paddings"</span>) (<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"experienceRequirements"</span>)) ,exp))
                                              (<span style="color: #00cdcd; font-weight: bold;">return-from</span> exp-extract (list <span style="color: #0000ee; font-weight: bold;">:exp</span> exp))) tree))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 2 (length exp-result)) exp-result (list <span style="color: #0000ee; font-weight: bold;">:exp</span> nil))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">respond-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((respond-result (<span style="color: #00cdcd; font-weight: bold;">block</span> respond-extract (mtm (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"g-attention m-attention_good b-vacancy-message"</span>))
                                                             <span style="color: #00cd00;">"&#1042;&#1099; &#1091;&#1078;&#1077; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1072;&#1083;&#1080;&#1089;&#1100; &#1085;&#1072; &#1101;&#1090;&#1091; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102;. "</span>
                                                             (<span style="color: #00cd00;">"a"</span> ((<span style="color: #00cd00;">"href"</span> ,resp)) <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1080;."</span>))
                                                      (<span style="color: #00cdcd; font-weight: bold;">return-from</span> respond-extract (list <span style="color: #0000ee; font-weight: bold;">:respond</span> resp))) tree))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 2 (length respond-result)) respond-result (list <span style="color: #0000ee; font-weight: bold;">:respond</span> nil))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">descr-extractor</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">block</span> descr-extract
    (mtm (`(<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"b-vacancy-desc-wrapper"</span>) (<span style="color: #00cd00;">"itemprop"</span> <span style="color: #00cd00;">"description"</span>)) ,@descr)
           (<span style="color: #00cdcd; font-weight: bold;">return-from</span> descr-extract (list <span style="color: #0000ee; font-weight: bold;">:descr</span> (transform-description descr)))) tree)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">hh-parse-vacancy</span> (html)
  (dbg <span style="color: #00cd00;">"hh-parse-vacancy"</span>)
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((tree (html-to-tree html))
         (candidat (append (header-extractor tree)
                           (company-extractor tree)
                           (salary-extractor tree)
                           (city-extractor tree)
                           (exp-extractor tree)
                           (respond-extractor tree)
                           (descr-extractor tree))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (tree-plist-p candidat))
        (<span style="color: #00cdcd; font-weight: bold;">progn</span>
          (dbg <span style="color: #00cd00;">"~A"</span> (bprint candidat))
          (<span style="color: #cd0000; font-weight: bold;">error</span> 'malformed-vacancy <span style="color: #0000ee; font-weight: bold;">:text</span>))
        candidat)))


<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(hh-parse-vacancy (hh-get-page "http://spb.hh.ru/vacancy/12561525" temp-cookie-jar *hh_account* "http://spb.hh.ru/"))))</span>


<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(let ((temp-cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(hh-parse-vacancy (hh-get-page "http://spb.hh.ru/vacancy/16606806" temp-cookie-jar *hh_account* "http://spb.hh.ru/"))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Правила обработки тизеров и вакансий</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Пусть у нас есть возможность создавать именованные <code>правила</code>, которые получают на вход
список, представляющий собой тизер или вакансию, анализируют его, и выполняют какие-то
действия. В качестве примера, мы могли бы создать правило, которое добавляет к вакансии
поле <code>interesting</code> если зарплата и язык разработки нас устраивает.
</p>

<p>
Правило принимает на вход условие срабатывания (<code>antecedent</code>) и код, который будет
выполнен, в случае если условие выполняется на обрабатываемой вакансии (<code>consequent</code>).
</p>

<p>
Примем соглашение, что правило возвращает два значения:
</p>
<ul class="org-ul">
<li>первое - вакансию (возможно измененную)
</li>
<li>второе - указание процессору правил (например, прекратить обработку)
</li>
</ul>

<p>
Мы реализуем правило, как сущность, чтобы воспользоваться всеми возможностями по
сохранению, извлечению и другим операциям с сущностями.
</p>
</div>

<div id="outline-container-sec-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> Сущность правила (<code>entity:rule</code>)</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
У нас есть два вида правил - для работы с тизерами и для обработки вакансий. Каждое
правило закреплено за пользователем, который им владеет и имеет ранг, в соответствии с
котором сортируется при применении набора правил.
</p>

<table id="rule_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Данные правила</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">user-id</td>
<td class="left">integer</td>
<td class="left">владелец правила</td>
</tr>

<tr>
<td class="left">rank</td>
<td class="left">integer</td>
<td class="left">приоритет правила</td>
</tr>

<tr>
<td class="left">ruletype</td>
<td class="left">varchar</td>
<td class="left">:teaser - правило для тизеров, :vacancy - для вакансий</td>
</tr>

<tr>
<td class="left">antecedent</td>
<td class="left">varchar</td>
<td class="left">условие срабатывания правила</td>
</tr>

<tr>
<td class="left">consequent</td>
<td class="left">varchar</td>
<td class="left">код правила</td>
</tr>

<tr>
<td class="left">notes</td>
<td class="left">(or db-null varchar)</td>
<td class="left">заметки к правилу</td>
</tr>
</tbody>
</table>

<p>
Правило может быть активным и неактивным
</p>

<table id="rule_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Состояния конечного автомата правила</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">rule-activation</td>
<td class="left">active</td>
<td class="left">inactive</td>
</tr>

<tr>
<td class="left">rule-deactivation</td>
<td class="left">inactive</td>
<td class="left">active</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rule-activation</span> ()
  <span style="color: #00cd00;">"| active   | inactive |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rule-deactivation</span> ()
  <span style="color: #00cd00;">"| inactive | active   |"</span>)
</pre>
</div>

<p>
Определим также макрос, который будет создавать правило
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_rule">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-rule</span> ((name antecedent) <span style="color: #00cd00;">&amp;body</span> consequent)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">`(list</span>
  <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(defun ,(intern (concatenate 'string (symbol-name name) "-ANTECEDENT")) (vacancy)</span>
  <span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">,antecedent)</span>
  <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(defun ,(intern (concatenate 'string (symbol-name name) "-CONSEQUENT")) (vacancy)</span>
  <span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(let ((result (progn ,@consequent)))</span>
  <span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(values vacancy result)))))</span>
  `(<span style="color: #00cdcd; font-weight: bold;">progn</span>
     (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (rule)
                 <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(when (string= "acitve" (state rule))</span>
                   (del-rule (id rule)))
                 <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">)</span>
             (find-rule <span style="color: #0000ee; font-weight: bold;">:name</span> ,(symbol-name name)))
     (list
      (alexandria:named-lambda
          ,(intern (concatenate 'string (symbol-name name) <span style="color: #00cd00;">"-ANTECEDENT-"</span> (symbol-name (gensym)))) (vacancy)
        ,antecedent)
      (alexandria:named-lambda
          ,(intern (concatenate 'string (symbol-name name) <span style="color: #00cd00;">"-CONSEQUENT-"</span> (symbol-name (gensym)))) (vacancy)
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (<span style="color: #00cdcd; font-weight: bold;">progn</span> ,@consequent)))
          (values vacancy result)))
      (make-rule <span style="color: #0000ee; font-weight: bold;">:name</span> ,(symbol-name name)
                 <span style="color: #0000ee; font-weight: bold;">:user-id</span> 1
                 <span style="color: #0000ee; font-weight: bold;">:rank</span> 100
                 <span style="color: #0000ee; font-weight: bold;">:ruletype</span> <span style="color: #00cd00;">":TEASER"</span>
                 <span style="color: #0000ee; font-weight: bold;">:antecedent</span> ,(bprint antecedent)
                 <span style="color: #0000ee; font-weight: bold;">:consequent</span> ,(bprint consequent)
                 <span style="color: #0000ee; font-weight: bold;">:notes</span> <span style="color: #00cd00;">""</span>
                 <span style="color: #0000ee; font-weight: bold;">:state</span> <span style="color: #00cd00;">":ACTIVE"</span>))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">expand</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">'(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #cd0000;">;;                                 </span><span style="color: #cd0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">:stop))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">test</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(define-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #cd0000;">;;                                   </span><span style="color: #cd0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(setf (getf vacancy :interesting) t)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">:stop)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((rule (car (find-rule :name "HI-SALARY-JAVA")))</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(vacancy '(:name "Python" :salary 80000)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(if (funcall (eval (read-from-string (format nil "(lambda (vacancy) ~A)" (antecedent rule))))</span>
<span style="color: #cd0000;">;;                </span><span style="color: #cd0000;">vacancy)</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(progn</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(multiple-value-bind (vacancy-result rule-result)</span>
<span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">(funcall (eval `(lambda (vacancy)</span>
<span style="color: #cd0000;">;;                               </span><span style="color: #cd0000;">(let ((result (progn ,@(read-from-string (consequent rule)))))</span>
<span style="color: #cd0000;">;;                                 </span><span style="color: #cd0000;">(values vacancy result))))</span>
<span style="color: #cd0000;">;;                      </span><span style="color: #cd0000;">vacancy)</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(setf vacancy vacancy-result)</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(print (format nil "vacancy: ~A ||| rule-result: ~A" (bprint vacancy-result) (bprint rule-result)))</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> Правила отсева тизеров</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Какие же правила и действия можно составить для того чтобы отсеять неинтересные тизеры
вакансий? В основном те, которые не устраивают по зарплате и те, у которых в названиях
упомянуты неинтересные технологии. К примеру, я не хочу даже смотреть на вакансии у
которых не указана зарплата или она ниже минимально приемлимой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_teasers">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;sugar_for_teaser_rules&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">define-drop-teaser-rule</span> (salary-1-no (null (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary</span>)))
  (dbg <span style="color: #00cd00;">"  - no salary"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-teaser-rule</span> (salary-2-low (or
                                        (and (equal (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>) <span style="color: #00cd00;">"RUR"</span>)
                                             (&lt; (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>) 90000))
                                        (and (equal (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>) <span style="color: #00cd00;">"USD"</span>)
                                             (&lt; (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>) (floor 90000 73)))
                                        (and (equal (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>) <span style="color: #00cd00;">"EUR"</span>)
                                             (&lt; (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>) (floor 90000 80)))
                                        ))
  (dbg <span style="color: #00cd00;">"  - low salary"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-all-teaser-when-name-contains-rule</span>
    <span style="color: #00cd00;">"iOS"</span> <span style="color: #00cd00;">"Python"</span> <span style="color: #00cd00;">"Django"</span> <span style="color: #00cd00;">"IOS"</span> <span style="color: #00cd00;">"1C"</span> <span style="color: #00cd00;">"C++"</span> <span style="color: #00cd00;">"&#1057;++"</span> <span style="color: #00cd00;">"Ruby"</span> <span style="color: #00cd00;">"Ruby on Rails"</span>
    <span style="color: #00cd00;">"Frontend"</span> <span style="color: #00cd00;">"Front End"</span> <span style="color: #00cd00;">"Front-end"</span> <span style="color: #00cd00;">"Go"</span> <span style="color: #00cd00;">"Q/A"</span> <span style="color: #00cd00;">"QA"</span> <span style="color: #00cd00;">"C#"</span> <span style="color: #00cd00;">".NET"</span> <span style="color: #00cd00;">".Net"</span>
    <span style="color: #00cd00;">"Unity3D"</span> <span style="color: #00cd00;">"Flash"</span> <span style="color: #00cd00;">"Java"</span> <span style="color: #00cd00;">"Android"</span> <span style="color: #00cd00;">"ASP"</span> <span style="color: #00cd00;">"Objective-C"</span> <span style="color: #00cd00;">"Go"</span> <span style="color: #00cd00;">"Delphi"</span>
    <span style="color: #00cd00;">"Sharepoint"</span> <span style="color: #00cd00;">"Flash"</span> <span style="color: #00cd00;">"PL/SQL"</span> <span style="color: #00cd00;">"Oracle"</span> <span style="color: #00cd00;">"designer"</span> <span style="color: #00cd00;">"SharePoint"</span> <span style="color: #00cd00;">"NodeJS"</span>
    <span style="color: #00cd00;">"&#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1097;&#1080;&#1082;"</span> <span style="color: #00cd00;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span> <span style="color: #00cd00;">"&#1058;&#1088;&#1072;&#1092;&#1080;&#1082;-&#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088;"</span> <span style="color: #00cd00;">"Traffic"</span>
    <span style="color: #00cd00;">"&#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088; &#1087;&#1086; &#1087;&#1088;&#1086;&#1076;&#1072;&#1078;&#1072;&#1084;"</span> <span style="color: #00cd00;">"&#1052;&#1077;&#1085;&#1077;&#1076;&#1078;&#1077;&#1088; &#1087;&#1086; &#1087;&#1088;&#1086;&#1076;&#1072;&#1078;&#1072;&#1084;"</span>
    <span style="color: #00cd00;">"&#1084;&#1072;&#1088;&#1082;&#1077;&#1090;&#1086;&#1083;&#1086;&#1075;"</span> <span style="color: #00cd00;">"DevOps"</span> <span style="color: #00cd00;">"Axapta"</span>)
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-3-2-1"></a>Макросы для определения правил отсева тизеров<br  /><div class="outline-text-5" id="text-4-3-2-1">
<p>
Для начала определим макрос, который создает правила отсева тизеров - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-drop-teaser-rule</span> ((name antecedent) <span style="color: #00cd00;">&amp;body</span> consequent)
  `(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (,(intern (concatenate 'string <span style="color: #00cd00;">"DROP-TEASER-IF-"</span>(symbol-name name))) ,antecedent)
     <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "v1: ~A" (bprint vacancy))</span>
     (dbg <span style="color: #00cd00;">"drop teaser: ~A-~A (~A) ~A"</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-min</span>) (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>) (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>) (getf vacancy <span style="color: #0000ee; font-weight: bold;">:name</span>))
     ,@consequent
     (setf vacancy nil)
     <span style="color: #0000ee; font-weight: bold;">:stop</span>))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">expand</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(macroexpand-1</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">'(define-drop-teaser-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #cd0000;">;;                                              </span><span style="color: #cd0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(print (getf vacancy :name))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(print (getf vacancy :salary)))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(DEFINE-RULE (DROP-TEASER-IF-HI-SALARY-JAVA</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">(AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #cd0000;">;;                    </span><span style="color: #cd0000;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME)))))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(PRINT (GETF VACANCY :NAME))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(PRINT (GETF VACANCY :SALARY))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(SETF VACANCY NIL)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">:STOP)</span>
</pre>
</div>

<p>
Теперь определим расширение предыдущего макроса, которое создает правило, отсеивающее
тизер, в случае, если в поле <code>:name</code> есть вхождение переданной строки
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-drop-teaser-by-name-rule</span> (str <span style="color: #00cd00;">&amp;body</span> consequent)
  `(<span style="color: #00cdcd; font-weight: bold;">define-drop-teaser-rule</span> (,(intern (concatenate 'string <span style="color: #00cd00;">"NAME-CONTAINS-"</span> (string-upcase (ppcre:regex-replace-all <span style="color: #00cd00;">"\\s+"</span> str <span style="color: #00cd00;">"-"</span>))))
                              (contains (getf vacancy <span style="color: #0000ee; font-weight: bold;">:name</span>) ,str))
     (dbg <span style="color: #00cd00;">"  - name contains ~A"</span> ,str)
     ,@consequent))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">expand</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(macroexpand-1</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">'(define-drop-teaser-by-name-rule "Android")))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(DEFINE-DROP-TEASER-RULE (IF-NAME-CONTAINS-ANDROID</span>
<span style="color: #cd0000;">;;                           </span><span style="color: #cd0000;">(CONTAINS (GETF VACANCY :NAME) "Android"))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(DBG "drop:")</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(DBG "  name contains ~A" "Android"))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">test</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(define-drop-teaser-by-name-rule "Android")</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">==&gt; (DROP-TEASER-IF-IF-NAME-CONTAINS-ANDROID-ANTECEDENT</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-ANDROID-CONSEQUENT)</span>
</pre>
</div>

<p>
Теперь в соответствии с принципом DRY определем макрос, который создаст список правил,
отсеивающих тизеры по вхождению первой строки в поле <code>:name</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_teaser_rules">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-drop-all-teaser-when-name-contains-rule</span> (<span style="color: #00cd00;">&amp;rest</span> names)
  `(list ,@(<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> name <span style="color: #0000ee; font-weight: bold;">:in</span> names <span style="color: #0000ee; font-weight: bold;">:collect</span>
              `(<span style="color: #00cdcd; font-weight: bold;">define-drop-teaser-by-name-rule</span> ,name))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">expand</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1 '(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(LIST (DEFINE-DROP-TEASER-BY-NAME-RULE "IOS")</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(DEFINE-DROP-TEASER-BY-NAME-RULE "1&#1057;")</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(DEFINE-DROP-TEASER-BY-NAME-RULE "C++"))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">test</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(define-drop-all-teaser-when-name-contains-rule "IOS" "1&#1057;" "C++"))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">((DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-ANTECEDENT</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-IOS-CONSEQUENT)</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-ANTECEDENT</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-1&#1057;-CONSEQUENT)</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(DROP-TEASER-IF-IF-NAME-CONTAINS-C++-ANTECEDENT</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">DROP-TEASER-IF-IF-NAME-CONTAINS-C++-CONSEQUENT))</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> Правила анализа вакансий</h4>
<div class="outline-text-4" id="text-4-3-3">
<ul class="org-ul">
<li>Я не хочу смотреть на вакансии, в компаниях где я уже работал.
</li>
<li>Если это уже существующая в базе вакансия и ничего не изменилось - игнорируем и
останавливаем ее обработку
</li>
<li>Я хочу присвоить вакансии определенный ранг, в зависимости от з\п
</li>
<li>Я хочу увеличивать этот ранг за упоминание в тексте описания вакансии моих любимых
слов: Lisp, Erlang, Closure, Prolog, Haskell, Smalltalk
</li>
<li>Я хочу особо отметить вакансии, у которых ранг выше [порогового ранга], чтобы
[отправить отклик]
</li>
<li>Я хочу занести вакансию в базу.
</li>
<li>Я хочу вывести вакансию в консоль.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;sugar_for_vacancy_rules&gt;&gt;

&lt;&lt;show_vacancy&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>) <span style="color: #00cd00;">"Webdom"</span>))
  (dbg <span style="color: #00cd00;">"   - already worked"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>) <span style="color: #00cd00;">"&#1055;&#1091;&#1083;&#1082;&#1086;&#1074;&#1086;-&#1057;&#1077;&#1088;&#1074;&#1080;&#1089;"</span>))
  (dbg <span style="color: #00cd00;">"   - already worked"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>) <span style="color: #00cd00;">"FBS"</span>))
  (dbg <span style="color: #00cd00;">"   - already worked"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-vacancy-rule</span> (already-worked (contains (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>) <span style="color: #00cd00;">"SEMrush"</span>))
  (dbg <span style="color: #00cd00;">"   - already worked"</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-drop-vacancy-rule</span> (already-exists-in-db (not (null (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:id</span>)))))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((exists (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:id</span>)))))
    (dbg <span style="color: #00cd00;">"   - already exists"</span>)))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (set-rank t)
  (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary</span>)))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (set-rank-up-by-lisp (contains (format nil <span style="color: #00cd00;">"~A"</span> (bprint (getf vacancy <span style="color: #0000ee; font-weight: bold;">:descr</span>))) <span style="color: #00cd00;">"Lisp"</span>))
  (dbg <span style="color: #00cd00;">"up rank by Lisp"</span>)
  (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) (+ (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) 30000)))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (set-rank-up-by-erlang (contains (format nil <span style="color: #00cd00;">"~A"</span> (bprint (getf vacancy <span style="color: #0000ee; font-weight: bold;">:descr</span>))) <span style="color: #00cd00;">"Erlang"</span>))
  (dbg <span style="color: #00cd00;">"up rank by Erlang"</span>)
  (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) (+ (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) 15000)))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (set-rank-up-by-haskell (contains (format nil <span style="color: #00cd00;">"~A"</span> (bprint (getf vacancy <span style="color: #0000ee; font-weight: bold;">:descr</span>))) <span style="color: #00cd00;">"Haskell"</span>))
  (dbg <span style="color: #00cd00;">"up rank by Haskell"</span>)
  (setf (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) (+ (getf vacancy <span style="color: #0000ee; font-weight: bold;">:rank</span>) 10000)))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (z-print t)
  (show-vacancy vacancy))

(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (z-save t)
  (save-vacancy vacancy)
  <span style="color: #0000ee; font-weight: bold;">:stop</span>)
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-3-3-1"></a>Макросы для определения правил анализа вакансий<br  /><div class="outline-text-5" id="text-4-3-3-1">
<p>
Для начала определим макрос, который создает правила отсева вакансий - эти правила
отличаются тем, что всегда в первом параметре возвращают nil, а во втором - <code>:stop</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="sugar_for_vacancy_rules">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-drop-vacancy-rule</span> ((name antecedent) <span style="color: #00cd00;">&amp;body</span> consequent)
  `(<span style="color: #00cdcd; font-weight: bold;">define-rule</span> (,(intern (concatenate 'string <span style="color: #00cd00;">"DROP-VACANCY-IF-"</span>(symbol-name name))) ,antecedent)
     (dbg <span style="color: #00cd00;">"drop vacancy: ~A : ~A"</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:name</span>) (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>))
     ,@consequent
     (setf vacancy nil)
     <span style="color: #0000ee; font-weight: bold;">:stop</span>))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">expand</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(macroexpand-1</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">'(define-drop-vacancy-rule (hi-salary-java (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #cd0000;">;;                                              </span><span style="color: #cd0000;">(not (contains "Java" (getf vacancy :name)))))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(print (getf vacancy :name))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(print (getf vacancy :salary)))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(DEFINE-RULE (DROP-VACANCY-IF-HI-SALARY-JAVA</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">(AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #cd0000;">;;                    </span><span style="color: #cd0000;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME)))))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(PRINT (GETF VACANCY :NAME))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(PRINT (GETF VACANCY :SALARY))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(SETF VACANCY NIL)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">:STOP)</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-3-4" class="outline-4">
<h4 id="sec-4-3-4"><span class="section-number-4">4.3.4</span> Извлечение правил</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
Теперь можно удобным и компактным способом добавить все необходимые правила и
обеспечить методы их обработки. Начнем с получения всех правил, правил для тизеров и
правил для вакансий.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;rules_for_vacancy&gt;&gt;

&lt;&lt;rules_for_teasers&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-all-rules</span> ()
  (sort
   (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
               (setf (name x)
                     (replace-all (name x) <span style="color: #00cd00;">"|"</span> <span style="color: #00cd00;">""</span>))
               x)
           (find-rule <span style="color: #0000ee; font-weight: bold;">:user-id</span> 1))
   #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
       (string&lt; (name a) (name b)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rules-for-teaser</span> ()
  (remove-if-not #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                     (search <span style="color: #00cd00;">"DROP-TEASER-IF"</span> (name x)))
                 (get-all-rules)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rules-for-vacancy</span> ()
  (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                 (search <span style="color: #00cd00;">"DROP-TEASER-IF"</span> (name x)))
             (get-all-rules)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Процессор правил (<code>process</code>)</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Теперь мы можем создать процессор правил <code>process</code>, который применяет к вакансии правила
поочередно. По сути, это <code>машина Э.Поста</code>, а все вместе представляет собой <code>продукционную
   систему</code> с прямой цепочкой вывода. Подробнее про продукционные системы <a href="http://www.ngpedia.ru/id429603p1.html">тут</a> и <a href="http://www.myshared.ru/slide/445840/">тут</a>.
</p>


<div id="fig:production_system" class="figure">
<p><img src="./img/production_system.gif" alt="production_system.gif" />
</p>
<p><span class="figure-number">Figure 4:</span> Продукционная система</p>
</div>

<p>
Процессор правил обрабатывает следущие особые случаи:
</p>
<ul class="org-ul">
<li>Если какое-то из правил возвращает во втором возвращаемом значении <code>:stop</code> -
обработка прекращается и возвращается текущий обработанный результат
</li>
<li>Если какое-то из правил возвращает во втором параметре <code>:renew</code> - то обработка текущего
входного результата начинается с самого первого правила.
</li>
</ul>
<p>
По окончании обработки возвращается результирующая вакансия, которая может быть
модифицирована правилами
</p>


<div class="figure">
<p><img src="./img/process.png" alt="process.png" />
</p>
</div>

<p>
Поскольку мы извлекаем код правил из БД приходится оборачивать их в лямбду и
применять <code>eval</code> и <code>read-from-string</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="process">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">process</span> (vacancy rules)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "process (count rules: ~A)" (length rules))</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vacancy vacancy))
    (<span style="color: #00cdcd; font-weight: bold;">tagbody</span>
     renew
       (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> rule <span style="color: #0000ee; font-weight: bold;">:in</span> rules
          <span style="color: #0000ee; font-weight: bold;">:do</span>
          (<span style="color: #00cdcd; font-weight: bold;">progn</span>
            (<span style="color: #00cdcd; font-weight: bold;">declaim</span> #+sbcl(sb-ext:muffle-conditions style-warning))
            (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall (eval (read-from-string (format nil <span style="color: #00cd00;">"(lambda (vacancy) ~A)"</span> (antecedent rule))))
                         vacancy)
                (<span style="color: #00cdcd; font-weight: bold;">progn</span>
                  (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (vacancy-result rule-result)
                      (funcall (eval `(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (vacancy)
                                        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (<span style="color: #00cdcd; font-weight: bold;">progn</span> ,@(read-from-string (consequent rule)))))
                                          (values vacancy result))))
                               vacancy)
                    (setf vacancy vacancy-result)
                    (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal rule-result <span style="color: #0000ee; font-weight: bold;">:stop</span>)
                      (<span style="color: #00cdcd; font-weight: bold;">return-from</span> process vacancy))
                    (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal rule-result <span style="color: #0000ee; font-weight: bold;">:renew</span>)
                      (<span style="color: #00cdcd; font-weight: bold;">go</span> renew)))
                  ))
            (<span style="color: #00cdcd; font-weight: bold;">declaim</span> #+sbcl(sb-ext:unmuffle-conditions style-warning)))))
    vacancy))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Декоратор для process-teaser (<code>process-teaser :around</code>)</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Поскольку и вакансии, и их тизеры представлены у нас одинаково, мы можем применять
правила и к тем, и к другим. Это позволит отфильтровать некоторые вакансии только
анализируя их тизеры и не загружать лишнего.
</p>

<p>
Для того, чтобы сделать это удобным образом, обернем (:around method) <code>process-teaser</code>
так, чтобы исключить из дальнейшей обрабоки те тизеры, которые нам не нравятся. Например
те, у которых нет указания зарплаты или она слишком низка. После того, как тизер
превратиться в вакансию мы применим к ней другой список правил, которые реализуют все
остальную логику.
</p>



<div class="figure">
<p><img src="./img/around.png" alt="around.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="process_teaser_around">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;rules&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">process-teaser</span> <span style="color: #0000ee; font-weight: bold;">:around</span> (current-teaser src-account referer)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "process-teaser :around")</span>
  (aif (process current-teaser (rules-for-teaser))
       (process (call-next-method it) (rules-for-vacancy))
       nil))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> Получение и обработка вакансий правилами (<code>run</code>)</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Теперь мы можем получить генератор, и, вызывая его, забирать вакансии, пока они не
закончатся. Все вакансии будут корректно обработаны правилами - сначала на этапе получения
тизеров, а потом на этапе получения вакансий.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="run">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;define_rule&gt;&gt;

&lt;&lt;process&gt;&gt;

&lt;&lt;process_teaser_around&gt;&gt;

&lt;&lt;factory&gt;&gt;

&lt;&lt;save_vacancy&gt;&gt;

&lt;&lt;send_respond&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">run</span> ()
  (make-event <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"run"</span>
              <span style="color: #0000ee; font-weight: bold;">:tag</span> <span style="color: #00cd00;">"parser-run"</span>
              <span style="color: #0000ee; font-weight: bold;">:msg</span> (format nil <span style="color: #00cd00;">"&#1057;&#1073;&#1086;&#1088; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;"</span>)
              <span style="color: #0000ee; font-weight: bold;">:author-id</span> 0
              <span style="color: #0000ee; font-weight: bold;">:ts-create</span> (get-universal-time))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((gen (factory 'hh *hh_account* <span style="color: #00cd00;">"spb"</span> <span style="color: #00cd00;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
                      <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)))
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> i <span style="color: #0000ee; font-weight: bold;">:from</span> 1 <span style="color: #0000ee; font-weight: bold;">:to</span> 100 <span style="color: #0000ee; font-weight: bold;">:do</span>
       (dbg <span style="color: #00cd00;">"~A"</span> i)
       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vacancy (funcall gen)))
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (null vacancy)
           (<span style="color: #00cdcd; font-weight: bold;">return</span>))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(run)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> Сохранение вакансии и ее структура данных (<code>save-vacancy</code>)</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Опишем структуру данных вакансии:
</p>

<table id="vacancy_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Данные вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">src-id</td>
<td class="left">integer</td>
<td class="left">идентификатор вакансии в источнике</td>
</tr>

<tr>
<td class="left">archive</td>
<td class="left">boolean</td>
<td class="left">призак, что вакансия в архиве</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название вакансии</td>
</tr>

<tr>
<td class="left">currency</td>
<td class="left">(or db-null varchar)</td>
<td class="left">валюта зарплаты</td>
</tr>

<tr>
<td class="left">base-salary</td>
<td class="left">(or db-null integer)</td>
<td class="left">размер компенсации в тизере</td>
</tr>

<tr>
<td class="left">salary</td>
<td class="left">(or db-null integer)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">salary-text</td>
<td class="left">(or db-null varchar)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">salary-max</td>
<td class="left">(or db-null integer)</td>
<td class="left">максимальный уровень зарплаты</td>
</tr>

<tr>
<td class="left">salary-min</td>
<td class="left">(or db-null integer)</td>
<td class="left">минимальный уровень зарплаты</td>
</tr>

<tr>
<td class="left">emp-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">emp-name</td>
<td class="left">varchar</td>
<td class="left">имя работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">city</td>
<td class="left">varchar</td>
<td class="left">город</td>
</tr>

<tr>
<td class="left">metro</td>
<td class="left">varchar</td>
<td class="left">метро</td>
</tr>

<tr>
<td class="left">experience</td>
<td class="left">varchar</td>
<td class="left">требуемый опыт работы</td>
</tr>

<tr>
<td class="left">date</td>
<td class="left">varchar</td>
<td class="left">дата опубликования в источнике</td>
</tr>

<tr>
<td class="left">respond</td>
<td class="left">varchar</td>
<td class="left">ссылка на отклик</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">varchar</td>
<td class="left">описание вакансии</td>
</tr>

<tr>
<td class="left">notes</td>
<td class="left">(or db-null varchar)</td>
<td class="left">заметки по вакансии</td>
</tr>

<tr>
<td class="left">response</td>
<td class="left">(or db-null varchar)</td>
<td class="left">текст отклика на вакансию</td>
</tr>
</tbody>
</table>

<p>
Напишем процедуру сохранения вакансии в базу данных
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="save_vacancy">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*saved-vacancy*</span> nil)

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">save-vacancy</span> (vacancy)
  (setf *saved-vacancy*
        (append *saved-vacancy*
                (list (make-vacancy
                       <span style="color: #0000ee; font-weight: bold;">:src-id</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:id</span>)
                       <span style="color: #0000ee; font-weight: bold;">:name</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:name</span>)
                       <span style="color: #0000ee; font-weight: bold;">:currency</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>)
                       <span style="color: #0000ee; font-weight: bold;">:salary</span> (aif (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary</span>) it 0)
                       <span style="color: #0000ee; font-weight: bold;">:base-salary</span> (aif (getf vacancy <span style="color: #0000ee; font-weight: bold;">:base-salary</span>) it 0)
                       <span style="color: #0000ee; font-weight: bold;">:salary-text</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-text</span>)
                       <span style="color: #0000ee; font-weight: bold;">:salary-max</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-max</span>)
                       <span style="color: #0000ee; font-weight: bold;">:salary-min</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-min</span>)
                       <span style="color: #0000ee; font-weight: bold;">:emp-id</span> (aif (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-id</span>) it 0)
                       <span style="color: #0000ee; font-weight: bold;">:emp-name</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>)
                       <span style="color: #0000ee; font-weight: bold;">:city</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:city</span>)
                       <span style="color: #0000ee; font-weight: bold;">:metro</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:metro</span>)
                       <span style="color: #0000ee; font-weight: bold;">:experience</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:exp</span>)
                       <span style="color: #0000ee; font-weight: bold;">:archive</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:archive</span>)
                       <span style="color: #0000ee; font-weight: bold;">:date</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:date</span>)
                       <span style="color: #0000ee; font-weight: bold;">:respond</span> (aif (getf vacancy <span style="color: #0000ee; font-weight: bold;">:respond</span>) it <span style="color: #00cd00;">""</span>)
                       <span style="color: #0000ee; font-weight: bold;">:state</span> (<span style="color: #00cdcd; font-weight: bold;">if</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:respond</span>) <span style="color: #00cd00;">":RESPONDED"</span> <span style="color: #00cd00;">":UNSORT"</span>)
                       <span style="color: #0000ee; font-weight: bold;">:descr</span> (bprint (getf vacancy <span style="color: #0000ee; font-weight: bold;">:descr</span>))
                       <span style="color: #0000ee; font-weight: bold;">:notes</span> <span style="color: #00cd00;">""</span>
                       <span style="color: #0000ee; font-weight: bold;">:response</span> <span style="color: #00cd00;">"&#1047;&#1076;&#1088;&#1072;&#1074;&#1089;&#1090;&#1074;&#1091;&#1081;&#1090;&#1077;, &#1103; &#1087;&#1086;&#1076;&#1093;&#1086;&#1078;&#1091; &#1087;&#1086;&#1076; &#1074;&#1072;&#1096;&#1080; &#1090;&#1088;&#1077;&#1073;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;. &#1050;&#1086;&#1075;&#1076;&#1072; &#1084;&#1086;&#1078;&#1085;&#1086; &#1076;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088;&#1080;&#1090;&#1100;&#1089;&#1103; &#1086; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080;? &#1052;&#1080;&#1093;&#1072;&#1080;&#1083; 8(911)286-92-90"</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> Состояния вакансий</h3>
<div class="outline-text-3" id="text-4-8">
<p>
После загрузки, вакансия получает статус <code>unsort</code>
</p>

<p>
После сортировки пользователем ваканисия может принять один из статусов: <code>unsort</code>,
<code>interesting</code> или <code>uninteresting</code>
</p>

<p>
Пользователь, работая с этими интересными вакансиями, отслеживает их состояния, выполняя
действия, переводящие вакансию из одного состояния в другое: когда пользователь
отправляет отзыв - вакансия становится <code>responded</code>.
</p>

<table id="vacancy_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Состояния конечного автомата вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">uns-uni</td>
<td class="left">unsort</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">uns-int</td>
<td class="left">unsort</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">uns-res</td>
<td class="left">unsort</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">uni-int</td>
<td class="left">uninteresting</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">uni-res</td>
<td class="left">uninteresting</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">uni-uni</td>
<td class="left">uninteresting</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-uni</td>
<td class="left">interesting</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-res</td>
<td class="left">interesting</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">int-int</td>
<td class="left">interesting</td>
<td class="left">interesting</td>
</tr>

<tr>
<td class="left">res-bee</td>
<td class="left">responded</td>
<td class="left">beenviewed</td>
</tr>

<tr>
<td class="left">res-uni</td>
<td class="left">responded</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">res-rej</td>
<td class="left">responded</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">res-inv</td>
<td class="left">responded</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">res-res</td>
<td class="left">responded</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">bee-uni</td>
<td class="left">beenviewed</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">bee-rej</td>
<td class="left">beenviewed</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">bee-inv</td>
<td class="left">beenviewed</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">bee-tes</td>
<td class="left">beenviewed</td>
<td class="left">testjob</td>
</tr>

<tr>
<td class="left">bee-bee</td>
<td class="left">beenviewed</td>
<td class="left">beenviewed</td>
</tr>

<tr>
<td class="left">tes-inv</td>
<td class="left">testjob</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">tes-int</td>
<td class="left">testjob</td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">tes-uni</td>
<td class="left">testjob</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">tes-off</td>
<td class="left">testjob</td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">tes-tes</td>
<td class="left">testjob</td>
<td class="left">testjob</td>
</tr>

<tr>
<td class="left">rej-res</td>
<td class="left">reject</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">rej-uni</td>
<td class="left">reject</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">rej-rej</td>
<td class="left">reject</td>
<td class="left">reject</td>
</tr>

<tr>
<td class="left">inv-inv</td>
<td class="left">invite</td>
<td class="left">invite</td>
</tr>

<tr>
<td class="left">inv-uni</td>
<td class="left">invite</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">inv-tes</td>
<td class="left">invite</td>
<td class="left">testjob</td>
</tr>

<tr>
<td class="left">inv-int</td>
<td class="left">invite</td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">int-uni</td>
<td class="left">interview</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">int-dis</td>
<td class="left">interview</td>
<td class="left">discard</td>
</tr>

<tr>
<td class="left">int-tes</td>
<td class="left">interview</td>
<td class="left">testjob</td>
</tr>

<tr>
<td class="left">int-int</td>
<td class="left">interview</td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">dis-uni</td>
<td class="left">discard</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">dis-dis</td>
<td class="left">discard</td>
<td class="left">discard</td>
</tr>

<tr>
<td class="left">int-off</td>
<td class="left">interview</td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">off-uni</td>
<td class="left">offer</td>
<td class="left">uninteresting</td>
</tr>

<tr>
<td class="left">off-off</td>
<td class="left">offer</td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">off-onj</td>
<td class="left">offer</td>
<td class="left">accept</td>
</tr>

<tr>
<td class="left">acc-acc</td>
<td class="left">accept</td>
<td class="left">accept</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение вакансии как конечный автомат:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="vacancy_state_graph">(mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
            (princ (format <span style="color: #00cd00;">"%s -&gt; %s [label =\"%s\"];\n"</span>
                           (second x) (third x) (first x))))
        table)
</pre>
</div>


<div class="figure">
<p><img src="img/vacancy-state.png" alt="vacancy-state.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uns-uni</span> ()
  <span style="color: #00cd00;">"unsort        | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uns-int</span> ()
  <span style="color: #00cd00;">"unsort        | interesting   |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uns-res</span> ()
  <span style="color: #00cd00;">"unsort        | responded     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uni-int</span> ()
  <span style="color: #00cd00;">"uninteresting | interesting   |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uni-res</span> ()
  <span style="color: #00cd00;">"uninteresting | responded     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">uni-uni</span> ()
  <span style="color: #00cd00;">"uninteresting | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-uni</span> ()
  <span style="color: #00cd00;">"interesting   | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-res</span> ()
  <span style="color: #00cd00;">"interesting   | responded     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-int</span> ()
  <span style="color: #00cd00;">"interesting   | interesting   |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">res-bee</span> ()
  <span style="color: #00cd00;">"responded     | beenviewed    |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">res-uni</span> ()
  <span style="color: #00cd00;">"responded     | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">res-rej</span> ()
  <span style="color: #00cd00;">"responded     | reject        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">res-inv</span> ()
  <span style="color: #00cd00;">"responded     | invite        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">res-res</span> ()
  <span style="color: #00cd00;">"responded     | responded     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">bee-uni</span> ()
  <span style="color: #00cd00;">"beenviewed    | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">bee-rej</span> ()
  <span style="color: #00cd00;">"beenviewed    | reject        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">bee-inv</span> ()
  <span style="color: #00cd00;">"beenviewed    | invite        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">bee-tes</span> ()
  <span style="color: #00cd00;">"beenviewed    | testjob       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">bee-bee</span> ()
  <span style="color: #00cd00;">"beenviewed    | beenviewed    |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tes-inv</span> ()
  <span style="color: #00cd00;">"testjob       | invite        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tes-int</span> ()
  <span style="color: #00cd00;">"testjob       | interview     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tes-uni</span> ()
  <span style="color: #00cd00;">"testjob       | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tes-off</span> ()
  <span style="color: #00cd00;">"testjob       | offer         |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">tes-tes</span> ()
  <span style="color: #00cd00;">"testjob       | testjob       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rej-res</span> ()
  <span style="color: #00cd00;">"reject        | responded     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rej-uni</span> ()
  <span style="color: #00cd00;">"reject        | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rej-rej</span> ()
  <span style="color: #00cd00;">"reject        | reject        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">inv-inv</span> ()
  <span style="color: #00cd00;">"invite        | invite        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">inv-uni</span> ()
  <span style="color: #00cd00;">"invite        | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">inv-tes</span> ()
  <span style="color: #00cd00;">"invite        | testjob       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">inv-int</span> ()
  <span style="color: #00cd00;">"invite        | interview     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-uni</span> ()
  <span style="color: #00cd00;">"interview     | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-dis</span> ()
  <span style="color: #00cd00;">"interview     | discard       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-tes</span> ()
  <span style="color: #00cd00;">"interview     | testjob       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-int</span> ()
  <span style="color: #00cd00;">"interview     | interview     |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dis-uni</span> ()
  <span style="color: #00cd00;">"discard       | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dis-dis</span> ()
  <span style="color: #00cd00;">"discard       | discard       |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">int-off</span> ()
  <span style="color: #00cd00;">"interview     | offer         |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">off-uni</span> ()
  <span style="color: #00cd00;">"offer         | uninteresting |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">off-off</span> ()
  <span style="color: #00cd00;">"offer         | offer         |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">off-onj</span> ()
  <span style="color: #00cd00;">"offer         | accept        |"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">acc-acc</span> ()
  <span style="color: #00cd00;">"accept        | accept        |"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> Печать вакансий (<code>show-vacancy</code>)</h3>
<div class="outline-text-3" id="text-4-9">
<p>
Пока у нас нет веб-интерфейса мы будем выводить вакансии в консоль
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="show_vacancy">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">show-descr</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((output (make-string-output-stream))
        (indent 2)
        (prefix <span style="color: #00cd00;">""</span>))
    (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((out (format tree)
               (format output <span style="color: #00cd00;">"~A~A"</span> (make-string indent <span style="color: #0000ee; font-weight: bold;">:initial-element</span> #\Space)
                       (format nil format tree)))
             (rec (tree)
               (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((consp tree) (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((and (equal 2 (length tree))
                                               (equal <span style="color: #0000ee; font-weight: bold;">:L</span> (car tree))
                                               (stringp (cadr tree))) (<span style="color: #00cdcd; font-weight: bold;">prog1</span> nil
                                                                        (format output <span style="color: #00cd00;">"~A-&gt; ~A~%"</span> prefix (cadr tree))))
                                         ((equal <span style="color: #0000ee; font-weight: bold;">:U</span> (car tree)) (<span style="color: #00cdcd; font-weight: bold;">prog1</span> nil
                                                                  (setf prefix (concatenate 'string (make-string indent <span style="color: #0000ee; font-weight: bold;">:initial-element</span> #\Space) prefix))
                                                                  (rec (cdr tree))
                                                                  (setf prefix (subseq prefix indent))))
                                         ((and (equal 2 (length tree))
                                               (equal <span style="color: #0000ee; font-weight: bold;">:B</span> (car tree))
                                               (stringp (cadr tree))) (format output <span style="color: #00cd00;">"~A[~A]~%"</span> prefix (cadr tree)))
                                         (t (cons (rec (car tree))
                                                  (rec (cdr tree))))))
                     (t (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((stringp tree) (format output <span style="color: #00cd00;">"~A~A~%"</span> prefix tree)))))))
      (rec tree))
    (get-output-stream-string output)))

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">show-vacancy</span> (vacancy)
  (format t <span style="color: #00cd00;">"~%"</span>)
  (format t <span style="color: #00cd00;">"~%~A :~A: ~A [~A]"</span>
       (getf vacancy <span style="color: #0000ee; font-weight: bold;">:salary-text</span>)
       (getf vacancy <span style="color: #0000ee; font-weight: bold;">:currency</span>)
       (getf vacancy <span style="color: #0000ee; font-weight: bold;">:name</span>)
       (getf vacancy <span style="color: #0000ee; font-weight: bold;">:id</span>))
  (format t <span style="color: #00cd00;">"~%~A"</span> (getf vacancy <span style="color: #0000ee; font-weight: bold;">:emp-name</span>))
  (format t <span style="color: #00cd00;">"~A"</span> (show-descr (getf vacancy <span style="color: #0000ee; font-weight: bold;">:descr</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> <span class="todo START">START</span> Жизненный цикл резюме</h3>
<div class="outline-text-3" id="text-4-10">
<p>
Создание резюме на hh.ru начинается с перехода на страницу
"<a href="http://spb.hh.ru/applicant/resumes/view?resume">http://spb.hh.ru/applicant/resumes/view?resume</a>=" где расположена форма, которая
предлагает добавить следующие данные:
</p>

<ul class="org-ul">
<li>Фото (photo)
</li>
<li>Имя, возраст, город  (personal)
</li>
<li>Контакты  (contacts)
</li>
<li>Желаемая должность и зарплата  (job-position)
</li>
<li>Образование (education)
</li>
<li>Опыт работы  (experience)
</li>
</ul>

<p>
Каждый из вариантов ведет на свою страницу с шаблоном
"<a href="http://spb.hh.ru/applicant/resumes/edit/%7BSECTION%7D?resume">http://spb.hh.ru/applicant/resumes/edit/%7BSECTION%7D?resume</a>=", где в {SECTON}
подставляется название раздела. На этих страницах размещены формы, которые
отправляют POST-запросы, формируя секции резюме. Рассмотрим эти POST-запросы
подробнее в следующих подразделах.
</p>

<p>
После отправки POST-запроса сервер запоминает данные формы в сессии и возвращает
заголовок LOCATION на основную страницу резюме, но теперь присваивает резюме
идентификатор. Таким образом адрес становится таким:
<a href="http://spb.hh.ru/applicant/resumes/view?resume=341309a0ff02d634530039ed1f543763556562">http://spb.hh.ru/applicant/resumes/view?resume=341309a0ff02d634530039ed1f543763556562</a>
</p>

<p>
Drakma автоматически переходит по location, так что реальное значение resume нужно
извлекать из возвращаемого значения uri.
</p>

<p>
После того, как все разделы заполнены резюме можно опубликовать.
</p>

<p>
Резюме также можно удалить по идентификатору.
</p>

<p>
Резюме сопровождается артефактами (фотографиями), которые привязываются к
нему. Артефакты можно загружать, выбирать и удалять.
</p>

<p>
Видимость резюме можно настраивать. Существуют следующие настройки:
</p>

<ul class="org-ul">
<li>Всему интернету ()
</li>
<li>Не видно никому
Ваше резюме будет недоступно для просмотра всем работодателям и кадровым
агентствам, а также не будет выводиться в результатах поиска по базе данных. Вы
сможете откликаться таким резюме на заинтересовавшие вас вакансии сайта
HeadHunter. При отклике на конкретную вакансию компании «Z», настройки видимости
вашего резюме автоматически изменятся на «Не видно никому, кроме: компания «Z».
</li>
<li>Компаниям, являющимся клиентами HeadHunter
</li>
<li>Только перечисленным компаниям
</li>
<li>Компаниям, зарегистрированным на HeadHunter, кроме&#x2026;
Ваше резюме будет доступно для просмотра всем компаниям и кадровым агентствам,
которые зарегистрированы на HeadHunter, за исключением тех, которые вы отметите в
специальном окне. Таким резюме вы сможете откликаться на все вакансии сайта
HeadHunter, однако те компании, которым вы запретили просматривать свое резюме, не
будут иметь к нему доступ через поиск по базе данных и по прямой ссылке. При
отклике на конкретную вакансию компании «Z», внесенной вами в stop-список,
настройки видимости вашего резюме автоматически изменятся, и компания «Z» удалится
из stop-списка.
</li>
<li>По прямой ссылке
</li>
</ul>

<p>
Настройка видимости осуществляется на странице:
<a href="http://spb.hh.ru/applicant/resumes/edit/visibility?resume=9555a7ecff02588d3c0039ed1f454162305732">http://spb.hh.ru/applicant/resumes/edit/visibility?resume=9555a7ecff02588d3c0039ed1f454162305732</a>
и производится посылкой POST-запроса вида:
</p>

<p>
accessType.string={VISIBILITY}
_xsrf=b2dccfd0ce2ff68b2c4f795ac6d549fb
</p>

<p>
Где вместо {VISIBILITY} посылается тип видимости:
</p>

<p>
-everyone
-no<sub>one</sub>
-clients
-invisibleResumeToVisible=true&amp; accessType.string=clients
-accessType.string=blacklist&amp;<sub>xsrf</sub>=b2dccfd0ce2ff68b2c4f795ac6d549fb
-direct
</p>

<p>
[TODO] - Выполнить весь жизненный цикл резюме
[TODO] - Осущестлять редактирование резюме и изменять его видимость
</p>
</div>

<div id="outline-container-sec-4-10-1" class="outline-4">
<h4 id="sec-4-10-1"><span class="section-number-4">4.10.1</span> <span class="todo TODO">TODO</span> Фото (<code>photo</code>)</h4>
<div class="outline-text-4" id="text-4-10-1">
</div><ol class="org-ol"><li><a id="sec-4-10-1-1"></a>При выборе уже загруженных фото<br  /><div class="outline-text-5" id="text-4-10-1-1">
<p>
photo.string=94187420
type=RESUME<sub>PHOTO</sub>
file=
title=&amp;<sub>xsrf</sub>=b2dccfd0ce2ff68b2c4f795ac6d549fb
</p>
</div>
</li>

<li><a id="sec-4-10-1-2"></a>При загрузке новой фотографии<br  /><div class="outline-text-5" id="text-4-10-1-2">
<p>
POST <a href="http://spb.hh.ru/applicant/resumes/artifacts/upload">http://spb.hh.ru/applicant/resumes/artifacts/upload</a>
</p>

<p>
Content-Type: multipart/form-data;
boundary=&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;41026768278304188928476747
Content-Length: 1364120
</p>

<p>
&#x2013;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;41026768278304188928476747
Content-Disposition: form-data; name="<sub>xsrf</sub>"
</p>

<p>
b2dccfd0ce2ff68b2c4f795ac6d549fb
&#x2013;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;41026768278304188928476747
Content-Disposition: form-data; name="user"
</p>

<p>
3681852
&#x2013;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;41026768278304188928476747
Content-Disposition: form-data; name="type"
</p>

<p>
RESUME<sub>PHOTO</sub>
&#x2013;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;41026768278304188928476747
Content-Disposition: form-data; name="file"; filename="20150726<sub>212228.jpg</sub>"
Content-Type: image/jpeg
</p>

<p>
ÿØÿá0OExif
</p>
</div>
</li>

<li><a id="sec-4-10-1-3"></a>Удаление фото<br  /><div class="outline-text-5" id="text-4-10-1-3">
<p>
POST <a href="http://spb.hh.ru/applicant/resumes/artifacts/remove">http://spb.hh.ru/applicant/resumes/artifacts/remove</a>
</p>

<p>
id=98616186
user=3681852
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-10-2" class="outline-4">
<h4 id="sec-4-10-2"><span class="section-number-4">4.10.2</span> Имя, возраст, город (<code>personal</code>)</h4>
<div class="outline-text-4" id="text-4-10-2">
<div class="org-src-container">

<pre class="src src-lisp" id="personal">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">personal</span> (cookie-jar resume <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume=~A"</span> resume-id)))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; personal</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((personal-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/personal?resume=~A"</span> resume-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page personal-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
            (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                (drakma:http-request
                 personal-url
                 <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                 <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                 <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                  (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                              (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                          `((<span style="color: #00cd00;">"lastName.string"</span>                         . ,(drakma:url-encode (last-name resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"firstName.string"</span>                        . ,(drakma:url-encode (first-name resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"middleName.string"</span>                       . ,(drakma:url-encode (middle-name resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"birthday.date"</span>                           . ,(drakma:url-encode (birthday resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"gender.string"</span>                           . ,(drakma:url-encode (gender resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"area.string"</span>                             . ,(drakma:url-encode (area resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"metro.string"</span>                            . ,(drakma:url-encode (metro resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"relocation.string"</span>                       . ,(drakma:url-encode (relocation resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"relocationArea.string"</span>                   . ,(drakma:url-encode (relocation-area resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"businessTripReadiness.string"</span>            . ,(drakma:url-encode (business-trip-readiness resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"citizenship"</span>                             . ,(drakma:url-encode (citizen-ship resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"citizenship.string"</span>                      . ,(drakma:url-encode (citizen-ship resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"workTicket"</span>                              . ,(drakma:url-encode (work-ticket resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"workTicket.string"</span>                       . ,(drakma:url-encode (work-ticket resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"travelTime.string"</span>                       . ,(drakma:url-encode (travel-time resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                            (<span style="color: #00cd00;">"_xsrf"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))))
                                          ))
                 <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                 <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                 <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                 `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                   (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                   (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                   (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                   (<span style="color: #00cd00;">"Referer"</span> . ,personal-url)
                   (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                   (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   )
                 <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                 <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
              (<span style="color: #00cdcd; font-weight: bold;">return-from</span> personal
                (values
                 uri
                 headers
                 (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(print (personal cookie-jar *test-resume*)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-3" class="outline-4">
<h4 id="sec-4-10-3"><span class="section-number-4">4.10.3</span> Контакты (<code>contacts</code>)</h4>
<div class="outline-text-4" id="text-4-10-3">
<div class="org-src-container">

<pre class="src src-lisp" id="contacts">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">contacts</span> (cookie-jar resume <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume=~A"</span> resume-id)))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; contacts</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((contacts-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/contacts?resume=~A"</span> resume-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page contacts-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
             (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                 (drakma:http-request
                  contacts-url
                  <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                  <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                  <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                   (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                               (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                           `((<span style="color: #00cd00;">"phone.type"</span>    . <span style="color: #00cd00;">"cell"</span>)
                                             (<span style="color: #00cd00;">"phone.country"</span> . ,(drakma:url-encode (cell-phone-country resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.city"</span>    . ,(drakma:url-encode (cell-phone-city resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.number"</span>  . ,(drakma:url-encode (cell-phone-number resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.comment"</span> . ,(drakma:url-encode (cell-phone-comment resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.type"</span>    . <span style="color: #00cd00;">"home"</span>)
                                             (<span style="color: #00cd00;">"phone.country"</span> . ,(drakma:url-encode (home-phone-country resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.city"</span>    . ,(drakma:url-encode (home-phone-city resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.number"</span>  . ,(drakma:url-encode (home-phone-number resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.comment"</span> . ,(drakma:url-encode (home-phone-comment resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.type"</span>    . <span style="color: #00cd00;">"work"</span>)
                                             (<span style="color: #00cd00;">"phone.country"</span> . ,(drakma:url-encode (home-phone-country resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.city"</span>    . ,(drakma:url-encode (home-phone-city resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.number"</span>  . ,(drakma:url-encode (home-phone-number resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"phone.comment"</span> . ,(drakma:url-encode (home-phone-comment resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"email.string"</span>  . ,(drakma:url-encode (email-string resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"preferredContact.string"</span> . ,(drakma:url-encode (preferred-contact resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"icq"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (icq resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"skype"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (skype resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"freelance"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (freelance resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"moi_krug"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (moi_krug resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"linkedin"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (linkedin resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"facebook"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (facebook resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"livejournal"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (livejournal resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"personalSite.type"</span> . <span style="color: #00cd00;">"personal"</span>)
                                             (<span style="color: #00cd00;">"personalSite.url"</span> . ,(drakma:url-encode (personal-site resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                             (<span style="color: #00cd00;">"_xsrf"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))))
                                           ))
                  <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                  <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                  `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                    (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                    (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                    (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                    (<span style="color: #00cd00;">"Referer"</span> . ,contacts-url)
                    (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                    (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    )
                  <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                  <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                  <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
               (<span style="color: #00cdcd; font-weight: bold;">return-from</span> contacts
                 (values
                  uri
                  headers
                  (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(contacts cookie-jar *test-resume*</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">"8eb43271ff030a44e00039ed1f735871443047"</span>
<span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-4" class="outline-4">
<h4 id="sec-4-10-4"><span class="section-number-4">4.10.4</span> Желаемая должность и зарплата (<code>resume-position</code>)</h4>
<div class="outline-text-4" id="text-4-10-4">
<p>
Важно чтобы названия у разных резюме отличались, иначе возращается ошибка.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="resumeposition">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">resume-position</span> (cookie-jar resume <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume=~A"</span> resume-id)))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; position</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((position-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/position?resume=~A"</span> resume-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page position-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
            (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                (drakma:http-request
                 position-url
                 <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                 <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                 <span style="color: #0000ee; font-weight: bold;">:content</span> (<span style="color: #00cdcd; font-weight: bold;">let</span> ((post-list (append
                                            `((<span style="color: #00cd00;">"title.string"</span> . ,(drakma:url-encode <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;"</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                              (<span style="color: #00cd00;">"profArea"</span>     . ,(drakma:url-encode (prof-area resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
                                            (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                        `(<span style="color: #00cd00;">"specialization.string"</span> . ,(drakma:url-encode x <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
                                                    (split-sequence:split-sequence #\Space (specializations resume)))
                                            `((<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">""</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"1"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"2"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"3"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"4"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"5"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"6"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"7"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"8"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"9"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"10"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"11"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"12"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"13"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"14"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"16"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"17"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"18"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"19"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"20"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"21"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"22"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"23"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"24"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"25"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"26"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"15"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"27"</span>)
                                              (<span style="color: #00cd00;">"profarea"</span> . <span style="color: #00cd00;">"29"</span>)
                                              (<span style="color: #00cd00;">"salary.amount"</span>        . ,(drakma:url-encode (salary-amount resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                              (<span style="color: #00cd00;">"salary.currency"</span>      . ,(drakma:url-encode (salary-currency resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                              (<span style="color: #00cd00;">"employment.string"</span>    . ,(drakma:url-encode (employment resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                              (<span style="color: #00cd00;">"workSchedule.string"</span>  . ,(drakma:url-encode (work-schedule resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                              (<span style="color: #00cd00;">"_xsrf"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))))))
                            (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                    (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                            post-list)))
                 <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                 <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                 `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                   (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                   (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                   (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                   (<span style="color: #00cd00;">"Referer"</span> . ,position-url)
                   (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                   (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   )
                 <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                 <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                 <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
              (<span style="color: #00cdcd; font-weight: bold;">return-from</span> resume-position
                (values
                 uri
                 headers
                 (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(resume-position cookie-jar *test-resume*</span>
<span style="color: #cd0000;">;;                     </span><span style="color: #cd0000;">"8eb43271ff030a44e00039ed1f735871443047"</span>
<span style="color: #cd0000;">;;                     </span><span style="color: #cd0000;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-5" class="outline-4">
<h4 id="sec-4-10-5"><span class="section-number-4">4.10.5</span> Образование (<code>education</code>)</h4>
<div class="outline-text-4" id="text-4-10-5">
<div class="org-src-container">

<pre class="src src-lisp" id="education">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">education-resume</span> (cookie-jar resume <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume=~A"</span> resume-id)))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; education</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((education-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/education?resume=~A"</span> resume-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page education-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
             (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                 (drakma:http-request
                  education-url
                  <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                  <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                  <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                   (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                               (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                            (append
                                             `((<span style="color: #00cd00;">"educationLevel.string"</span> . ,(drakma:url-encode (education-level-string resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
                                             (<span style="color: #00cdcd; font-weight: bold;">let</span> ((primary-education-id (car (split-sequence:split-sequence #\Space (educations resume)))))
                                               (<span style="color: #00cdcd; font-weight: bold;">if</span> (null primary-education-id)
                                                   (err <span style="color: #00cd00;">"error education-id"</span>)
                                                   (<span style="color: #00cdcd; font-weight: bold;">let</span> ((education (get-education (parse-integer primary-education-id))))
                                                     `((<span style="color: #00cd00;">"primaryEducation.id"</span>            . ,(<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (education-id education)))
                                                                                                 (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 0 it)
                                                                                                     <span style="color: #00cd00;">""</span>
                                                                                                     (drakma:url-encode it <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))
                                                       (<span style="color: #00cd00;">"primaryEducation.name"</span>          . ,(drakma:url-encode (name education) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                       (<span style="color: #00cd00;">"primaryEducation.universityId"</span>  . ,(drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span> (university-id education)) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                       (<span style="color: #00cd00;">"primaryEducation.facultyId"</span>     . ,(<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (faculty-id education)))
                                                                                                 (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 0 it)
                                                                                                     <span style="color: #00cd00;">""</span>
                                                                                                     (drakma:url-encode it <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))
                                                       (<span style="color: #00cd00;">"primaryEducation.organization"</span>  . ,(drakma:url-encode (organization education) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                       (<span style="color: #00cd00;">"primaryEducation.result"</span>        . ,(drakma:url-encode (result education) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                       (<span style="color: #00cd00;">"primaryEducation.specialtyId"</span>   . ,(drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span> (specialty-id education)) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                       (<span style="color: #00cd00;">"primaryEducation.year"</span>          . ,(drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span> (year education)) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))
                                             `((<span style="color: #00cd00;">"primaryEducation.id"</span>            . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.name"</span>          . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.universityId"</span>  . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.facultyId"</span>     . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.organization"</span>  . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.result"</span>        . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.specialtyId"</span>   . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"primaryEducation.year"</span>          . ,(drakma:url-encode <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"additionalEducation.id"</span>         . ,(drakma:url-encode (additional-education-id resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"additionalEducation.name"</span>       . ,(drakma:url-encode (additional-education-name resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"additionalEducation.organization"</span> . ,(drakma:url-encode (additional-education-organization resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"additionalEducation.result"</span>     . ,(drakma:url-encode (additional-education-result resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"additionalEducation.year"</span>       . ,(drakma:url-encode (additional-education-year resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.id"</span>                 . ,(drakma:url-encode (certificate-id resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.type"</span>               . ,(drakma:url-encode (certificate-type resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.selected"</span>           . ,(drakma:url-encode (certificate-selected resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.ownerName"</span>          . ,(drakma:url-encode (certificate-ownerName resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.transcriptionId"</span>    . ,(drakma:url-encode (certificate-transcription-id resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.password"</span>           . ,(drakma:url-encode (certificate-password resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.title"</span>              . ,(drakma:url-encode (certificate-title resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.achievementDate"</span>    . ,(drakma:url-encode (certificate-achievementDate resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"certificate.url"</span>                . ,(drakma:url-encode (certificate-url resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"attestationEducation.id"</span>        . ,(drakma:url-encode (attestation-education-id resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"attestationEducation.name"</span>      . ,(drakma:url-encode (attestation-education-name resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"attestationEducation.organization"</span> . ,(drakma:url-encode (attestation-education-organization resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"attestationEducation.result"</span>    . ,(drakma:url-encode (attestation-education-result resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               (<span style="color: #00cd00;">"attestationEducation.year"</span>      . ,(drakma:url-encode (attestation-education-year resume) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                               )
                                             (<span style="color: #00cdcd; font-weight: bold;">let</span> ((langs))
                                               (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lang (get-lang (parse-integer x))))
                                                             (push `(<span style="color: #00cd00;">"language.id"</span>     . ,(drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span>(lang-id lang))     <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)) langs)
                                                             (push `(<span style="color: #00cd00;">"language.degree"</span> . ,(drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span> (lang-degree lang)) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)) langs)
                                                             ))
                                                       (split-sequence:split-sequence #\Space (languages *test-resume*)))
                                               (reverse langs))
                                             `(
                                               (<span style="color: #00cd00;">"_xsrf"</span>                          . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))))
                                             )
                                           ))
                  <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                  <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                  `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                    (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                    (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                    (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                    (<span style="color: #00cd00;">"Referer"</span> . ,education-url)
                    (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                    (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    )
                  <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                  <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                  <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
               (<span style="color: #00cdcd; font-weight: bold;">return-from</span> education-resume
                 (values
                  uri
                  headers
                  (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(education-resume cookie-jar *test-resume*</span>
<span style="color: #cd0000;">;;                      </span><span style="color: #cd0000;">"8eb43271ff030a44e00039ed1f735871443047"</span>
<span style="color: #cd0000;">;;                      </span><span style="color: #cd0000;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-6" class="outline-4">
<h4 id="sec-4-10-6"><span class="section-number-4">4.10.6</span> <span class="todo START">START</span> Опыт работы (<code>experience</code>)</h4>
<div class="outline-text-4" id="text-4-10-6">
<div class="org-src-container">

<pre class="src src-lisp" id="expirience">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">url-enc</span> (<span style="color: #00cd00;">&amp;body</span> body)
  `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((it ,@body))
     (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 0 it)
         <span style="color: #00cd00;">""</span>
         (drakma:url-encode (format nil <span style="color: #00cd00;">"~A"</span> it) <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">expirience</span> (cookie-jar resume <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume=~A"</span> resume-id)))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; expirience</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((expirience-url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/experience?resume=~A"</span> resume-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page expirience-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
            (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                (drakma:http-request
                 expirience-url
                 <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                 <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                 <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                  (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                              (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                          `((<span style="color: #00cd00;">"experience.companyName"</span> . <span style="color: #00cd00;">"%D0%9B%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%B8%D1%8F+%D0%9A%D0%B0%D1%81%D0%BF%D0%B5%D1%80%D1%81%D0%BA%D0%BE%D0%B3%D0%BE"</span>)
                                            (<span style="color: #00cd00;">"experience.companyId"</span> . <span style="color: #00cd00;">"1057"</span>)
                                            (<span style="color: #00cd00;">"experience.companyAreaId"</span> . <span style="color: #00cd00;">"1"</span>)
                                            (<span style="color: #00cd00;">"experience.companyUrl"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustryId"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustries"</span> . <span style="color: #00cd00;">"540"</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustries"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.id"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.position"</span> . <span style="color: #00cd00;">"%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82"</span>)
                                            (<span style="color: #00cd00;">"experience.startDate"</span> . <span style="color: #00cd00;">"2000-01-01"</span>)
                                            (<span style="color: #00cd00;">"experience.endDate"</span> . <span style="color: #00cd00;">"2001-01-01"</span>)
                                            (<span style="color: #00cd00;">"experience.description"</span> . <span style="color: #00cd00;">"%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0+%D0%B7%D0%B0+%D0%B4%D0%B5%D0%BD%D1%8C%D0%B3%D0%B8"</span>)
                                            (<span style="color: #00cd00;">"experience.companyName"</span> . <span style="color: #00cd00;">"%D0%92%D1%8B%D0%BC%D0%BF%D0%B5%D0%BB%D0%BA%D0%BE%D0%BC"</span>)
                                            (<span style="color: #00cd00;">"experience.companyId"</span> . <span style="color: #00cd00;">"4934"</span>)
                                            (<span style="color: #00cd00;">"experience.companyAreaId"</span> . <span style="color: #00cd00;">"1"</span>)
                                            (<span style="color: #00cd00;">"experience.companyUrl"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustryId"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustries"</span> . <span style="color: #00cd00;">"399"</span>)
                                            (<span style="color: #00cd00;">"experience.companyIndustries"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.id"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"experience.position"</span> . <span style="color: #00cd00;">"%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82"</span>)
                                            (<span style="color: #00cd00;">"experience.startDate"</span> . <span style="color: #00cd00;">"2001-01-01"</span>)
                                            (<span style="color: #00cd00;">"experience.endDate"</span> . <span style="color: #00cd00;">"2005-01-01"</span>)
                                            (<span style="color: #00cd00;">"experience.description"</span> . <span style="color: #00cd00;">"%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0+%D0%B7%D0%B0+%D0%B5%D0%B4%D1%83+%29"</span>)

                                            (<span style="color: #00cd00;">"keySkills.string"</span> . <span style="color: #00cd00;">"%D0%A0%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0+%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D0%B8+%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D1%8B%D1%85+%D0%BA%D0%BE%D0%BC%D0%BF%D0%B5%D1%82%D0%B5%D0%BD%D1%86%D0%B8%D0%B9"</span>)
                                            (<span style="color: #00cd00;">"keySkills.string"</span> . <span style="color: #00cd00;">"%D0%92%D0%B0%D0%BA%D1%83%D1%83%D0%BC%D0%BD%D0%B0%D1%8F+%D1%87%D0%B8%D1%81%D1%82%D0%BA%D0%B0+%D0%BB%D0%B8%D1%86%D0%B0"</span>)
                                            (<span style="color: #00cd00;">"skills.string"</span> . <span style="color: #00cd00;">"%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BD%D0%B0%D1%85%D0%BE%D0%B6%D1%83%D1%81%D1%8C+%D0%BD%D0%B0+%D0%BF%D0%B5%D0%BD%D1%81%D0%B8%D0%B8.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5+%D0%B2%D1%80%D0%B5%D0%BC%D1%8F+%D0%BD%D0%B0%D1%85%D0%BE%D0%B6%D1%83%D1%81%D1%8C+%D0%B2+%D0%BF%D0%BE%D0%B8%D1%81%D0%BA%D0%B0%D1%85+%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B8%D0%BB+%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D1%83+%D0%B2+%D0%B0%D1%80%D0%BC%D0%B8%D0%B8.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B8%D0%BB+%D0%BE%D0%B1%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5+%D0%B1%D0%B5%D0%B7+%D0%B2%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D0%B8+%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D1%82%D1%8C.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BD%D0%B0%D1%85%D0%BE%D0%B4%D0%B8%D0%BB%D0%B0%D1%81%D1%8C+%D0%B2+%D0%B4%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D0%BE%D0%BC+%D0%BE%D1%82%D0%BF%D1%83%D1%81%D0%BA%D0%B5.%0D%0A"</span>)
                                            (<span style="color: #00cd00;">"recommendation.id"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"recommendation.name"</span> . <span style="color: #00cd00;">"%D0%A1%D0%BC%D0%B8%D1%80%D0%BD%D0%BE%D0%B2"</span>)
                                            (<span style="color: #00cd00;">"recommendation.position"</span> . <span style="color: #00cd00;">"%D0%9A%D0%B0%D0%BF%D0%B8%D1%82%D0%B0%D0%BD"</span>)
                                            (<span style="color: #00cd00;">"recommendation.organization"</span> . <span style="color: #00cd00;">"%D0%90%D1%80%D0%BC%D0%B8%D1%8F"</span>)
                                            (<span style="color: #00cd00;">"recommendation.contactInfo"</span> . <span style="color: #00cd00;">"9112869290"</span>)
                                            (<span style="color: #00cd00;">"recommendation.id"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"recommendation.name"</span> . <span style="color: #00cd00;">"%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2"</span>)
                                            (<span style="color: #00cd00;">"recommendation.position"</span> . <span style="color: #00cd00;">"%D0%9A%D0%B0%D0%BF%D1%80%D0%B0%D0%BB"</span>)
                                            (<span style="color: #00cd00;">"recommendation.organization"</span> . <span style="color: #00cd00;">"%D0%90%D1%80%D0%BC%D0%B8%D1%8F"</span>)
                                            (<span style="color: #00cd00;">"recommendation.contactInfo"</span> . <span style="color: #00cd00;">"9112878789"</span>)
                                            (<span style="color: #00cd00;">"type"</span> . <span style="color: #00cd00;">"PORTFOLIO"</span>)
                                            (<span style="color: #00cd00;">"portfolio.string"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"file"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"title"</span> . <span style="color: #00cd00;">""</span>)
                                            (<span style="color: #00cd00;">"_xsrf"</span>                          . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))))



                                           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((resume (get-resume 1)))
                                             (apply 'append
                                                    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item <span style="color: #0000ee; font-weight: bold;">:in</span> (split-sequence:split-sequence #\Space (expiriences resume)) <span style="color: #0000ee; font-weight: bold;">:collect</span>
                                                       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((item (get-expirience (parse-integer item))))
                                                         `((<span style="color: #00cd00;">"experience.companyName"</span>      . ,(url-enc (name item)))
                                                           (<span style="color: #00cd00;">"experience.companyId"</span>        . ,(url-enc (company-id item)))
                                                           (<span style="color: #00cd00;">"experience.companyAreaId"</span>    . ,(url-enc (company-area-id item)))
                                                           (<span style="color: #00cd00;">"experience.companyUrl"</span>       . ,(url-enc (url item)))
                                                           (<span style="color: #00cd00;">"experience.companyIndustryId"</span>. ,(url-enc (industry-id item)))
                                                           (<span style="color: #00cd00;">"experience.companyIndustries"</span>. ,(url-enc (industries item)))
                                                           (<span style="color: #00cd00;">"experience.companyIndustries"</span>. <span style="color: #00cd00;">""</span>) <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">compatibility: &#1087;&#1088;&#1077;&#1076;&#1087;&#1086;&#1083;&#1086;&#1078;&#1080;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103; &#1076;&#1077;&#1103;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1089;&#1090;&#1080;</span>
                                                           (<span style="color: #00cd00;">"experience.id"</span>               . ,(url-enc (exp-id item)))
                                                           (<span style="color: #00cd00;">"experience.position"</span>         . ,(url-enc (job-position item)))
                                                           (<span style="color: #00cd00;">"experience.startDate"</span>        . ,(url-enc (start-date item)))
                                                           (<span style="color: #00cd00;">"experience.endDate"</span>          . ,(url-enc (end-date item)))
                                                           (<span style="color: #00cd00;">"experience.description"</span>      . ,(url-enc (description item)))
                                                           )))))

                                           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((resume (get-resume 1)))
                                             (apply 'append
                                                    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item <span style="color: #0000ee; font-weight: bold;">:in</span> (split-sequence:split-sequence #\Space (skills resume)) <span style="color: #0000ee; font-weight: bold;">:collect</span>
                                                       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((item (get-skill (parse-integer item))))
                                                         `((<span style="color: #00cd00;">"keySkills.string"</span>      . ,(url-enc (name item)))))))
                                             <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">fix it (only name)</span>
                                             `(
                                               (<span style="color: #00cd00;">"keySkills.string"</span> . <span style="color: #00cd00;">"%D0%A0%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0+%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D0%B8+%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D1%8B%D1%85+%D0%BA%D0%BE%D0%BC%D0%BF%D0%B5%D1%82%D0%B5%D0%BD%D1%86%D0%B8%D0%B9"</span>)
                                               (<span style="color: #00cd00;">"keySkills.string"</span> . <span style="color: #00cd00;">"%D0%92%D0%B0%D0%BA%D1%83%D1%83%D0%BC%D0%BD%D0%B0%D1%8F+%D1%87%D0%B8%D1%81%D1%82%D0%BA%D0%B0+%D0%BB%D0%B8%D1%86%D0%B0"</span>)
                                               (<span style="color: #00cd00;">"skills.string"</span> . <span style="color: #00cd00;">"%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BD%D0%B0%D1%85%D0%BE%D0%B6%D1%83%D1%81%D1%8C+%D0%BD%D0%B0+%D0%BF%D0%B5%D0%BD%D1%81%D0%B8%D0%B8.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5+%D0%B2%D1%80%D0%B5%D0%BC%D1%8F+%D0%BD%D0%B0%D1%85%D0%BE%D0%B6%D1%83%D1%81%D1%8C+%D0%B2+%D0%BF%D0%BE%D0%B8%D1%81%D0%BA%D0%B0%D1%85+%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B8%D0%BB+%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D1%83+%D0%B2+%D0%B0%D1%80%D0%BC%D0%B8%D0%B8.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B8%D0%BB+%D0%BE%D0%B1%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5+%D0%B1%D0%B5%D0%B7+%D0%B2%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D0%B8+%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D1%82%D1%8C.%0D%0A%D0%92+%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B8%D0%B5+%D0%B3%D0%BE%D0%B4%D1%8B+%D0%BD%D0%B0%D1%85%D0%BE%D0%B4%D0%B8%D0%BB%D0%B0%D1%81%D1%8C+%D0%B2+%D0%B4%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D0%BE%D0%BC+%D0%BE%D1%82%D0%BF%D1%83%D1%81%D0%BA%D0%B5.%0D%0A"</span>)))

                                           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((resume (get-resume 1)))
                                             (apply 'append
                                                    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> item <span style="color: #0000ee; font-weight: bold;">:in</span> (split-sequence:split-sequence #\Space (recommendations resume)) <span style="color: #0000ee; font-weight: bold;">:collect</span>
                                                       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((item (get-recommendation (parse-integer item))))
                                                         `((<span style="color: #00cd00;">"recommendation.id"</span>            . ,(url-enc (recommendation-id item)))
                                                           (<span style="color: #00cd00;">"recommendation.name"</span>          . ,(url-enc (name item)))
                                                           (<span style="color: #00cd00;">"recommendation.position"</span>      . ,(url-enc (job-position item)))
                                                           (<span style="color: #00cd00;">"recommendation.organization"</span>  . ,(url-enc (organization item)))
                                                           (<span style="color: #00cd00;">"recommendation.contactInfo"</span>   . ,(url-enc (contact-info item))))))))

                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">append</span>

                                          (<span style="color: #00cd00;">"type"</span> . <span style="color: #00cd00;">"PORTFOLIO"</span>)
                                          (<span style="color: #00cd00;">"portfolio.string"</span> . <span style="color: #00cd00;">""</span>)
                                          (<span style="color: #00cd00;">"file"</span> . <span style="color: #00cd00;">""</span>)
                                          (<span style="color: #00cd00;">"title"</span> . <span style="color: #00cd00;">""</span>)
                                          (<span style="color: #00cd00;">"_xsrf"</span>                          . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))


                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((primary-education-id (car (split-sequence:split-sequence #\Space (educations resume)))))</span>
                                          <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(if (null primary-education-id)</span>
                                          <span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(err "error education-id")</span>
                                          <span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(let ((education (get-education (parse-integer primary-education-id))))</span>
                                          <span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">`(("primaryEducation.id"            . ,(let ((it (education-id education)))</span>
                                          <span style="color: #cd0000;">;;                                                     </span><span style="color: #cd0000;">(if (equal 0 it)</span>
                                          <span style="color: #cd0000;">;;                                                         </span><span style="color: #cd0000;">""</span>
                                          <span style="color: #cd0000;">;;                                                         </span><span style="color: #cd0000;">(drakma:url-encode it :utf-8))))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.name"          . ,(drakma:url-encode (name education) :utf-8))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.universityId"  . ,(drakma:url-encode (format nil "~A" (university-id education)) :utf-8))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.facultyId"     . ,(let ((it (faculty-id education)))</span>
                                          <span style="color: #cd0000;">;;                                                     </span><span style="color: #cd0000;">(if (equal 0 it)</span>
                                          <span style="color: #cd0000;">;;                                                         </span><span style="color: #cd0000;">""</span>
                                          <span style="color: #cd0000;">;;                                                         </span><span style="color: #cd0000;">(drakma:url-encode it :utf-8))))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.organization"  . ,(drakma:url-encode (organization education) :utf-8))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.result"        . ,(drakma:url-encode (result education) :utf-8))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.specialtyId"   . ,(drakma:url-encode (format nil "~A" (specialty-id education)) :utf-8))</span>
                                          <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">("primaryEducation.year"          . ,(drakma:url-encode (format nil "~A" (year education)) :utf-8))))))</span>

                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((resume (get-resume 1)))</span>
                                          <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(apply 'append</span>
                                          <span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(loop :for item :in (split-sequence:split-sequence #\Space (educations resume)) :collect</span>
                                          <span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">(let ((item (get-education (parse-integer item))))</span>
                                          <span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">item))))</span>


                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-name       | (or db-null varchar) | "&#1051;&#1072;&#1073;&#1086;&#1088;&#1072;&#1090;&#1086;&#1088;&#1080;&#1103; &#1050;&#1072;&#1089;&#1087;&#1077;&#1088;&#1089;&#1082;&#1086;&#1075;&#1086;              |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-id         | (or db-null varchar) | "1057"                                |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-area-id    | (or db-null varchar) | "1"                                   |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-url        | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industryId | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industries | (or db-null varchar) | "540"                                 |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industries | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-id                 | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-position           | (or db-null varchar) | &#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;                           |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-start-date         | (or db-null varchar) | "2000-01-01"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-end-date           | (or db-null varchar) | "2001-01-01"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-description        | (or db-null varchar) | "&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1079;&#1072; &#1076;&#1077;&#1085;&#1100;&#1075;&#1080;"                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-name       | (or db-null varchar) | "&#1042;&#1099;&#1084;&#1087;&#1077;&#1083;&#1082;&#1086;&#1084;                            |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-id         | (or db-null varchar) | "4934"                                |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-areaId     | (or db-null varchar) | "1"                                   |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-url        | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industryId | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industries | (or db-null varchar) | "399"                                 |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-company-industries | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-id                 | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-position           | (or db-null varchar) | "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-start-date         | (or db-null varchar) | "2001-01-01"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-end-date           | (or db-null varchar) | "2005-01-01"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| experience-description        | (or db-null varchar) | "&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1079;&#1072; &#1077;&#1076;&#1091; )"                     |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| key-skills-string             | (or db-null varchar) | &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072; &#1072;&#1088;&#1093;&#1080;&#1090;&#1077;&#1082;&#1090;&#1091;&#1088;&#1099;                |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| key-skills-string             | (or db-null varchar) | &#1042;&#1072;&#1082;&#1091;&#1091;&#1084;&#1085;&#1072;&#1103; &#1095;&#1080;&#1089;&#1090;&#1082;&#1072; &#1083;&#1080;&#1094;&#1072;                 |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| skills-string                 | (or db-null varchar) | &#1042; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1075;&#1086;&#1076;&#1099; &#1085;&#1072;&#1093;&#1086;&#1078;&#1091;&#1089;&#1100; &#1085;&#1072; &#1087;&#1077;&#1085;&#1089;&#1080;&#1080; ) |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-id             | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-name           | (or db-null varchar) | &#1057;&#1084;&#1080;&#1088;&#1085;&#1086;&#1074;                               |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-position       | (or db-null varchar) | &#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1080;&#1082;                             |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-organization   | (or db-null varchar) | &#1040;&#1088;&#1084;&#1080;&#1103;                                 |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-contact-info   | (or db-null varchar) | "9112869290"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-id             | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-name           | (or db-null varchar) | &#1048;&#1074;&#1072;&#1085;&#1086;&#1074;                                |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-position       | (or db-null varchar) | &#1047;&#1072;&#1084;&#1087;&#1086;&#1090;&#1077;&#1093;                              |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-organization   | (or db-null varchar) | &#1040;&#1088;&#1084;&#1080;&#1103;                                 |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| recommendation-contact-info   | (or db-null varchar) | "9112878789"                          |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| type                          | (or db-null varchar) | "PORTFOLIO"                           |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| portfolio-string              | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| file                          | (or db-null varchar) | ""                                    |</span>
                                          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">| title                         | (or db-null varchar) | "")))                                 |</span>


                                          ))
                 <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                 <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                 `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                   (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                   (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                   (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)

            (<span style="color: #00cd00;">"Referer"</span> . ,expirience-url)
                   (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                   (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                   )
                 <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                 <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                 <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
              (<span style="color: #00cdcd; font-weight: bold;">return-from</span> expirience
                (values
                 uri
                 headers
                 (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-7" class="outline-4">
<h4 id="sec-4-10-7"><span class="section-number-4">4.10.7</span> <span class="todo TODO">TODO</span> Публикация (<code>touch</code>)</h4>
<div class="outline-text-4" id="text-4-10-7">
<div class="org-src-container">

<pre class="src src-lisp" id="touch">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">touch</span> (cookie-jar <span style="color: #00cd00;">&amp;optional</span> (resume-id <span style="color: #00cd00;">""</span>))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1080;&#1084; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1091;&#1102; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((main-url <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/view?resume="</span>))
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page main-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; touch</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((touch-url <span style="color: #00cd00;">"http://spb.hh.ru/applicant/resumes/edit/touch?resume="</span>))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page touch-url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1082;&#1083;&#1102;&#1095;-&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; cookies</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST</span>
             (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (body-or-stream status-code headers uri stream must-close reason-phrase)
                 (drakma:http-request
                  touch-url
                  <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                  <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                  <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                   (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                               (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                           `((<span style="color: #00cd00;">"resume"</span> . <span style="color: #00cd00;">"341309a0ff02d634530039ed1f543763556562"</span>)
                                             (<span style="color: #00cd00;">"publish"</span> . <span style="color: #00cd00;">"next"</span>)
                                             (<span style="color: #00cd00;">"createVisibleResume"</span> . <span style="color: #00cd00;">"true&amp;_xsrf=b2dccfd0ce2ff68b2c4f795ac6d549fb"</span>))
                                           ))
                  <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                  <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                  `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                    (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Accept-Encoding" . "gzip, deflate")</span>
                    (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                    (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                    (<span style="color: #00cd00;">"Referer"</span> . ,touch-url)
                    (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                    (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                    )
                  <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                  <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                  <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
               (<span style="color: #00cdcd; font-weight: bold;">return-from</span> touch
                 (values
                  headers
                  (flexi-streams:octets-to-string body-or-stream <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(touch cookie-jar)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-10-8" class="outline-4">
<h4 id="sec-4-10-8"><span class="section-number-4">4.10.8</span> <span class="todo TODO">TODO</span> Удаление резюме</h4>
<div class="outline-text-4" id="text-4-10-8">
<p>
<a href="http://spb.hh.ru/applicant/deleteresume/">http://spb.hh.ru/applicant/deleteresume/</a>
</p>

<p>
resumeId=47592531
_xsrf=b2dccfd0ce2ff68b2c4f795ac6d549fb
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> <span class="todo TODO">TODO</span> Синхронизация резюме на hh и в хранилище</h3>
<div class="outline-text-3" id="text-4-11">
</div><div id="outline-container-sec-4-11-1" class="outline-4">
<h4 id="sec-4-11-1"><span class="section-number-4">4.11.1</span> Парсер резюме в личном кабинете</h4>
</div>
</div>
<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> Создание резюме под вакасию по шаблону</h3>
<div class="outline-text-3" id="text-4-12">
</div><div id="outline-container-sec-4-12-1" class="outline-4">
<h4 id="sec-4-12-1"><span class="section-number-4">4.12.1</span> Сущности шаблона резюме</h4>
</div>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13"><span class="section-number-3">4.13</span> <span class="todo TODO">TODO</span> Сущность резюме соискателя (<code>entity:resume</code>)</h3>
<div class="outline-text-3" id="text-4-13">
<p>
Иногда у одного соискателя может быть несколько резюме. Опишем структуру данных резюме:
</p>

<table id="resume_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Данные резюме</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">hh-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор резюме на hh.ru</td>
</tr>

<tr>
<td class="left">title</td>
<td class="left">(or db-null varchar)</td>
<td class="left">заголовок резюме</td>
</tr>

<tr>
<td class="left">last-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">фамилия</td>
</tr>

<tr>
<td class="left">first-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">middle-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">отчество</td>
</tr>

<tr>
<td class="left">birthday</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Дата рождения (по умолчанию: "")</td>
</tr>

<tr>
<td class="left">gender</td>
<td class="left">(or db-null varchar)</td>
<td class="left">пол (по умолчанию: "male")</td>
</tr>

<tr>
<td class="left">area</td>
<td class="left">(or db-null varchar)</td>
<td class="left">город проживания (спб: "2", москва: "1")</td>
</tr>

<tr>
<td class="left">metro</td>
<td class="left">(or db-null varchar)</td>
<td class="left">метро</td>
</tr>

<tr>
<td class="left">relocation</td>
<td class="left">(or db-null varchar)</td>
<td class="left">отношение к переезду ("no<sub>relocation</sub>"/"relocation<sub>possible</sub>"/"relocation<sub>desirable</sub>")</td>
</tr>

<tr>
<td class="left">relocation-area</td>
<td class="left">(or db-null varchar)</td>
<td class="left">куда переезжать (отправляется несколько полей с одним именем но разными значениями)</td>
</tr>

<tr>
<td class="left">business-trip-readiness</td>
<td class="left">(or db-null varchar)</td>
<td class="left">командировки ("never"/"ready"/"sometimes")</td>
</tr>

<tr>
<td class="left">citizen-ship</td>
<td class="left">(or db-null varchar)</td>
<td class="left">гражданство (Россия: 113)</td>
</tr>

<tr>
<td class="left">work-ticket</td>
<td class="left">(or db-null varchar)</td>
<td class="left">разрешение на работу (Россия: 113)</td>
</tr>

<tr>
<td class="left">travel-time</td>
<td class="left">(or db-null varchar)</td>
<td class="left">время в пути ("any"/"from<sub>hour</sub><sub>to</sub><sub>one</sub><sub>and</sub><sub>half</sub>"/"less<sub>than</sub><sub>hour</sub>")</td>
</tr>

<tr>
<td class="left">cell-phone-country</td>
<td class="left">(or db-null varchar)</td>
<td class="left">7</td>
</tr>

<tr>
<td class="left">cell-phone-city</td>
<td class="left">(or db-null varchar)</td>
<td class="left">911</td>
</tr>

<tr>
<td class="left">cell-phone-number</td>
<td class="left">(or db-null varchar)</td>
<td class="left">2869290</td>
</tr>

<tr>
<td class="left">cell-phone-comment</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">home-phone-country</td>
<td class="left">(or db-null varchar)</td>
<td class="left">7</td>
</tr>

<tr>
<td class="left">home-phone-city</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">home-phone-number</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">home-phone-comment</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">work-phone-country</td>
<td class="left">(or db-null varchar)</td>
<td class="left">7</td>
</tr>

<tr>
<td class="left">work-phone-city</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">work-phone-number</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">work-phone-comment</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">email-string</td>
<td class="left">(or db-null varchar)</td>
<td class="left">avenger-f%40yandex-ru</td>
</tr>

<tr>
<td class="left">preferred-contact</td>
<td class="left">(or db-null varchar)</td>
<td class="left">email</td>
</tr>

<tr>
<td class="left">icq</td>
<td class="left">(or db-null varchar)</td>
<td class="left">icq</td>
</tr>

<tr>
<td class="left">skype</td>
<td class="left">(or db-null varchar)</td>
<td class="left">skype</td>
</tr>

<tr>
<td class="left">freelance</td>
<td class="left">(or db-null varchar)</td>
<td class="left">freelance</td>
</tr>

<tr>
<td class="left">moi<sub>krug</sub></td>
<td class="left">(or db-null varchar)</td>
<td class="left">moi<sub>krug</sub></td>
</tr>

<tr>
<td class="left">linkedin</td>
<td class="left">(or db-null varchar)</td>
<td class="left">linkedin</td>
</tr>

<tr>
<td class="left">facebook</td>
<td class="left">(or db-null varchar)</td>
<td class="left">facebook</td>
</tr>

<tr>
<td class="left">livejournal</td>
<td class="left">(or db-null varchar)</td>
<td class="left">livejournal</td>
</tr>

<tr>
<td class="left">personal-site</td>
<td class="left">(or db-null varchar)</td>
<td class="left">personal</td>
</tr>

<tr>
<td class="left">prof-area</td>
<td class="left">(or db-null varchar)</td>
<td class="left">1</td>
</tr>

<tr>
<td class="left">specializations</td>
<td class="left">(or db-null varchar)</td>
<td class="left">82 221</td>
</tr>

<tr>
<td class="left">salary-amount</td>
<td class="left">(or db-null varchar)</td>
<td class="left">100000</td>
</tr>

<tr>
<td class="left">salary-currency</td>
<td class="left">(or db-null varchar)</td>
<td class="left">RUR</td>
</tr>

<tr>
<td class="left">employment</td>
<td class="left">(or db-null varchar)</td>
<td class="left">full</td>
</tr>

<tr>
<td class="left">work-schedule</td>
<td class="left">(or db-null varchar)</td>
<td class="left">full<sub>day</sub></td>
</tr>

<tr>
<td class="left">education-level-string</td>
<td class="left">(or db-null varchar)</td>
<td class="left">higher</td>
</tr>

<tr>
<td class="left">educations</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-university-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">39864</td>
</tr>

<tr>
<td class="left">primary-education-faculty-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-organization</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-result</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">primary-education-specialty-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">224</td>
</tr>

<tr>
<td class="left">primary-education-year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">2005</td>
</tr>

<tr>
<td class="left">additional-education-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">additional-education-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">additional-education-organization</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">additional-education-result</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">additional-education-year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-type</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-selected</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-ownerName</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-transcription-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-password</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-title</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-achievementDate</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">certificate-url</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">attestation-education-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">attestation-education-name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">attestation-education-organization</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">attestation-education-result</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">attestation-education-year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">languages</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Владение языками</td>
</tr>

<tr>
<td class="left">expiriences</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Опыт работы</td>
</tr>

<tr>
<td class="left">skills</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Ключевые навыки</td>
</tr>

<tr>
<td class="left">recommendations</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Рекомендации</td>
</tr>

<tr>
<td class="left">portfolio</td>
<td class="left">(or db-null varchar)</td>
<td class="left">Портфолио</td>
</tr>
</tbody>
</table>

<p>
Резюме может быть активным или неактивным:
</p>

<table id="resume_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Состояния конечного автомата вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">rai</td>
<td class="left">active</td>
<td class="left">inactive</td>
</tr>

<tr>
<td class="left">ria</td>
<td class="left">inactive</td>
<td class="left">active</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение резюме как конечный автомат:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="resume_state_graph">(mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
            (princ (format <span style="color: #00cd00;">"%s -&gt; %s [label =\"%s\"];\n"</span>
                           (second x) (third x) (first x))))
        table)
</pre>
</div>


<div class="figure">
<p><img src="img/resume-state.png" alt="resume-state.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">rai</span> ()
  <span style="color: #00cd00;">"active-inactive"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">ria</span> ()
  <span style="color: #00cd00;">"inactive-active"</span>)
</pre>
</div>

<p>
Создадим резюме, связав их с резюме на hh:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="_hh_fn_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1089;&#1090;, &#1080;&#1083;&#1083;&#1102;&#1089;&#1090;&#1088;&#1080;&#1088;&#1091;&#1102;&#1097;&#1080;&#1081; magic-&#1084;&#1077;&#1090;&#1086;&#1076;&#1099;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1088;&#1080; &#1087;&#1086;&#1087;&#1099;&#1090;&#1082;&#1077; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1072; &#1082; &#1087;&#1086;&#1083;&#1102;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1075;&#1086; &#1085;&#1077; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090; &#1074; &#1082;&#1083;&#1072;&#1089;&#1089;&#1077; &#1074; &#1101;&#1090;&#1086;&#1090; &#1082;&#1083;&#1072;&#1089;&#1089; &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1087;&#1086;&#1083;&#1077;. &#1045;&#1089;&#1083;&#1080; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1073;&#1099;&#1083; &#1085;&#1072; &#1079;&#1072;&#1087;&#1080;&#1089;&#1100; - &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1090;&#1089;&#1103; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;, &#1080;&#1085;&#1072;&#1095;&#1077; &#1074; &#1087;&#1086;&#1083;&#1077; &#1073;&#1091;&#1076;&#1077;&#1090; nil.</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1069;&#1090;&#1086; &#1087;&#1086;&#1083;&#1077; - &#1095;&#1083;&#1077;&#1085; &#1082;&#1083;&#1072;&#1089;&#1089;&#1072;, &#1072; &#1085;&#1077; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1072;. &#1058;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080; &#1085;&#1080;&#1095;&#1090;&#1086; &#1085;&#1077; &#1084;&#1077;&#1096;&#1072;&#1077;&#1090; &#1085;&#1072;&#1084; &#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1075;&#1076;&#1077;-&#1090;&#1086; &#1086;&#1090;&#1076;&#1077;&#1083;&#1100;&#1085;&#1086; &#1086;&#1090; &#1089;&#1072;&#1084;&#1086;&#1075;&#1086; &#1082;&#1083;&#1072;&#1089;&#1089;&#1072;.</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">direct-slot-defn-&gt;initarg</span> (slot-defn)
  (list <span style="color: #0000ee; font-weight: bold;">:name</span> (slot-definition-name slot-defn)
        <span style="color: #0000ee; font-weight: bold;">:readers</span> (slot-definition-readers slot-defn)
        <span style="color: #0000ee; font-weight: bold;">:writers</span> (slot-definition-writers slot-defn)
        <span style="color: #0000ee; font-weight: bold;">:initform</span> (slot-definition-initform slot-defn)
        <span style="color: #0000ee; font-weight: bold;">:initargs</span> (slot-definition-initargs slot-defn)
        <span style="color: #0000ee; font-weight: bold;">:initfunction</span> (slot-definition-initfunction slot-defn)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">add-slot-to-class</span> (class name <span style="color: #00cd00;">&amp;key</span> (initform nil) accessors readers writers initargs (initfunction (constantly nil)))
  (<span style="color: #cd0000; font-weight: bold;">check-type</span> class symbol)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((new-slots (list (list <span style="color: #0000ee; font-weight: bold;">:name</span> name
                               <span style="color: #0000ee; font-weight: bold;">:readers</span> (union accessors readers)
                               <span style="color: #0000ee; font-weight: bold;">:writers</span> (union writers
                                               (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                           (list 'setf x))
                                                       accessors)
                                               <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)
                               <span style="color: #0000ee; font-weight: bold;">:initform</span> initform
                               <span style="color: #0000ee; font-weight: bold;">:initargs</span> initargs
                               <span style="color: #0000ee; font-weight: bold;">:initfunction</span> initfunction))))
    (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (slot-defn (class-direct-slots (find-class class)))
      (push (direct-slot-defn-&gt;initarg slot-defn) new-slots))
    (ensure-class class <span style="color: #0000ee; font-weight: bold;">:direct-slots</span> new-slots)))

(<span style="color: #00cdcd; font-weight: bold;">defclass</span> <span style="color: #00cd00;">foo</span> ()
  ((bar <span style="color: #0000ee; font-weight: bold;">:accessor</span> bar <span style="color: #0000ee; font-weight: bold;">:initform</span> <span style="color: #00cd00;">"zzzzzz"</span>)
   (baz <span style="color: #0000ee; font-weight: bold;">:accessor</span> baz <span style="color: #0000ee; font-weight: bold;">:initform</span> <span style="color: #00cd00;">"zzzzzz"</span>)))

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">slot-missing</span> (class (instance foo) slot-name operation <span style="color: #00cd00;">&amp;optional</span> (new-value <span style="color: #00cd00;">"defailt value"</span>))
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (ignorable class))
  (print (list class instance slot-name operation new-value))
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(err 'zz)</span>
  (add-slot-to-class (class-name class) slot-name)
  (setf (slot-value instance slot-name) new-value))

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*foo*</span> (make-instance 'foo))

(setf (slot-value *foo* 'bar) <span style="color: #00cd00;">"the-bar"</span>)

(setf (slot-value *foo* 't2) <span style="color: #00cd00;">"zzz"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*foo2*</span> (make-instance 'foo))

(slot-value *foo2* 't5)

(slot-value *foo2* 'bar)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1089;&#1090;&#1086;&#1074;&#1086;&#1077; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*test-resume*</span>
  (make-resume
   <span style="color: #0000ee; font-weight: bold;">:last-name</span> <span style="color: #00cd00;">"&#1043;&#1083;&#1091;&#1093;&#1086;&#1074;"</span>
   <span style="color: #0000ee; font-weight: bold;">:first-name</span> <span style="color: #00cd00;">"&#1052;&#1080;&#1093;&#1072;&#1080;&#1083;"</span>
   <span style="color: #0000ee; font-weight: bold;">:middle-name</span> <span style="color: #00cd00;">"&#1052;&#1080;&#1093;&#1072;&#1081;&#1083;&#1086;&#1074;&#1080;&#1095;"</span>
   <span style="color: #0000ee; font-weight: bold;">:birthday</span> <span style="color: #00cd00;">"1982-12-15"</span>
   <span style="color: #0000ee; font-weight: bold;">:gender</span> <span style="color: #00cd00;">"male"</span>
   <span style="color: #0000ee; font-weight: bold;">:area</span> <span style="color: #00cd00;">"2"</span>
   <span style="color: #0000ee; font-weight: bold;">:metro</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:relocation</span> <span style="color: #00cd00;">"relocation_possible"</span>
   <span style="color: #0000ee; font-weight: bold;">:relocation-area</span> <span style="color: #00cd00;">"1"</span>
   <span style="color: #0000ee; font-weight: bold;">:business-trip-readiness</span> <span style="color: #00cd00;">"ready"</span>
   <span style="color: #0000ee; font-weight: bold;">:citizen-ship</span> <span style="color: #00cd00;">"113"</span>
   <span style="color: #0000ee; font-weight: bold;">:work-ticket</span> <span style="color: #00cd00;">"113"</span>
   <span style="color: #0000ee; font-weight: bold;">:travel-time</span> <span style="color: #00cd00;">"any"</span>

   <span style="color: #0000ee; font-weight: bold;">:cell-phone-country</span>      <span style="color: #00cd00;">"7"</span>
   <span style="color: #0000ee; font-weight: bold;">:cell-phone-city</span>         <span style="color: #00cd00;">"911"</span>
   <span style="color: #0000ee; font-weight: bold;">:cell-phone-number</span>       <span style="color: #00cd00;">"2869290"</span>
   <span style="color: #0000ee; font-weight: bold;">:cell-phone-comment</span>      <span style="color: #00cd00;">"&#1042; &#1083;&#1102;&#1073;&#1086;&#1077; &#1074;&#1088;&#1077;&#1084;&#1103;"</span>

   <span style="color: #0000ee; font-weight: bold;">:home-phone-country</span>      <span style="color: #00cd00;">"7"</span>
   <span style="color: #0000ee; font-weight: bold;">:home-phone-city</span>         <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:home-phone-number</span>       <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:home-phone-comment</span>      <span style="color: #00cd00;">""</span>

   <span style="color: #0000ee; font-weight: bold;">:work-phone-country</span>      <span style="color: #00cd00;">"7"</span>
   <span style="color: #0000ee; font-weight: bold;">:work-phone-city</span>         <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:work-phone-number</span>       <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:work-phone-comment</span>      <span style="color: #00cd00;">""</span>

   <span style="color: #0000ee; font-weight: bold;">:email-string</span>            <span style="color: #00cd00;">"avenger-f@yandex.ru"</span>
   <span style="color: #0000ee; font-weight: bold;">:preferred-contact</span>       <span style="color: #00cd00;">"email"</span>
   <span style="color: #0000ee; font-weight: bold;">:icq</span>                     <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:skype</span>                   <span style="color: #00cd00;">"i.am.rigidus"</span>
   <span style="color: #0000ee; font-weight: bold;">:freelance</span>               <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:moi_krug</span>                <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:linkedin</span>                <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:facebook</span>                <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:livejournal</span>             <span style="color: #00cd00;">"rigidus"</span>
   <span style="color: #0000ee; font-weight: bold;">:personal-site</span>           <span style="color: #00cd00;">"http://rigidus.ru"</span>

   <span style="color: #0000ee; font-weight: bold;">:title</span> <span style="color: #00cd00;">"Programmer"</span>
   <span style="color: #0000ee; font-weight: bold;">:specializations</span> <span style="color: #00cd00;">"221"</span>
   <span style="color: #0000ee; font-weight: bold;">:prof-area</span> <span style="color: #00cd00;">"1"</span>
   <span style="color: #0000ee; font-weight: bold;">:salary-amount</span> <span style="color: #00cd00;">"160000"</span>
   <span style="color: #0000ee; font-weight: bold;">:salary-currency</span> <span style="color: #00cd00;">"RUR"</span>
   <span style="color: #0000ee; font-weight: bold;">:employment</span> <span style="color: #00cd00;">"full"</span>
   <span style="color: #0000ee; font-weight: bold;">:work-schedule</span> <span style="color: #00cd00;">"full_day"</span>

   <span style="color: #0000ee; font-weight: bold;">:education-level-string</span> <span style="color: #00cd00;">"higher"</span>
   <span style="color: #0000ee; font-weight: bold;">:educations</span> (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                          (format nil <span style="color: #00cd00;">"~A ~A"</span> a b))
                      (mapcar #'id
                              (list
                               (make-education <span style="color: #0000ee; font-weight: bold;">:education-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"&#1057;&#1072;&#1085;&#1082;&#1090;-&#1055;&#1077;&#1090;&#1077;&#1088;&#1073;&#1091;&#1088;&#1075;&#1089;&#1082;&#1080;&#1081; &#1075;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1099;&#1081; &#1091;&#1085;&#1080;&#1074;&#1077;&#1088;&#1089;&#1080;&#1090;&#1077;&#1090; &#1082;&#1091;&#1083;&#1100;&#1090;&#1091;&#1088;&#1099; &#1080; &#1080;&#1089;&#1082;&#1091;&#1089;&#1089;&#1090;&#1074;, &#1057;&#1072;&#1085;&#1082;&#1090;-&#1055;&#1077;&#1090;&#1077;&#1088;&#1073;&#1091;&#1088;&#1075;"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:university-id</span> <span style="color: #00cd00;">"39864"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:faculty-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:organization</span> <span style="color: #00cd00;">"&#1056;&#1077;&#1078;&#1080;&#1089;&#1089;&#1091;&#1088;&#1099;"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">"&#1056;&#1077;&#1078;&#1080;&#1089;&#1089;&#1091;&#1088;&#1072; &#1084;&#1091;&#1083;&#1100;&#1090;&#1080;&#1084;&#1077;&#1076;&#1080;&#1072; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:specialty-id</span> <span style="color: #00cd00;">"224"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:year</span> <span style="color: #00cd00;">"2005"</span>)
                               (make-education <span style="color: #0000ee; font-weight: bold;">:education-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">""</span>
                                               <span style="color: #0000ee; font-weight: bold;">:university-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:faculty-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:organization</span> <span style="color: #00cd00;">""</span>
                                               <span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">""</span>
                                               <span style="color: #0000ee; font-weight: bold;">:specialty-id</span> <span style="color: #00cd00;">"0"</span>
                                               <span style="color: #0000ee; font-weight: bold;">:year</span> <span style="color: #00cd00;">"0"</span>))))
   <span style="color: #0000ee; font-weight: bold;">:additional-education-id</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:additional-education-name</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:additional-education-organization</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:additional-education-result</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:additional-education-year</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-id</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-type</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-selected</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-ownerName</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-transcription-id</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-password</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-title</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-achievementDate</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:certificate-url</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:attestation-education-id</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:attestation-education-name</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:attestation-education-organization</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:attestation-education-result</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:attestation-education-year</span> <span style="color: #00cd00;">""</span>
   <span style="color: #0000ee; font-weight: bold;">:languages</span> (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                          (format nil <span style="color: #00cd00;">"~A ~A"</span> a b))
                      (mapcar #'id
                              (list
                               (make-lang <span style="color: #0000ee; font-weight: bold;">:lang-id</span> <span style="color: #00cd00;">"34"</span> <span style="color: #0000ee; font-weight: bold;">:lang-degree</span> <span style="color: #00cd00;">"native"</span>)
                               (make-lang <span style="color: #0000ee; font-weight: bold;">:lang-id</span> <span style="color: #00cd00;">"57"</span> <span style="color: #0000ee; font-weight: bold;">:lang-degree</span> <span style="color: #00cd00;">"can_read"</span>)
                               (make-lang <span style="color: #0000ee; font-weight: bold;">:lang-id</span> <span style="color: #00cd00;">"58"</span> <span style="color: #0000ee; font-weight: bold;">:lang-degree</span> <span style="color: #00cd00;">"basic"</span>)
                               (make-lang <span style="color: #0000ee; font-weight: bold;">:lang-id</span> <span style="color: #00cd00;">"59"</span> <span style="color: #0000ee; font-weight: bold;">:lang-degree</span> <span style="color: #00cd00;">"none"</span>))))
   <span style="color: #0000ee; font-weight: bold;">:expiriences</span> (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                            (format nil <span style="color: #00cd00;">"~A ~A"</span> a b))
                        (mapcar #'id
                                (list
                                 (make-expirience
                                  <span style="color: #0000ee; font-weight: bold;">:name</span>         <span style="color: #00cd00;">"&#1051;&#1072;&#1073;&#1086;&#1088;&#1072;&#1090;&#1086;&#1088;&#1080;&#1103; &#1050;&#1072;&#1089;&#1087;&#1077;&#1088;&#1089;&#1082;&#1086;&#1075;&#1086;"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:company-id</span>   <span style="color: #00cd00;">"1057"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:area-id</span>      <span style="color: #00cd00;">"1"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:url</span>          <span style="color: #00cd00;">""</span>
                                  <span style="color: #0000ee; font-weight: bold;">:industry-id</span>  <span style="color: #00cd00;">"0"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:industries</span>   <span style="color: #00cd00;">"540"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:industries</span>   <span style="color: #00cd00;">""</span>
                                  <span style="color: #0000ee; font-weight: bold;">:exp-id</span>       <span style="color: #00cd00;">""</span>
                                  <span style="color: #0000ee; font-weight: bold;">:job-position</span> <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:start-date</span>   <span style="color: #00cd00;">"2000-01-01"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:end-date</span>     <span style="color: #00cd00;">"2001-01-01"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:description</span>  <span style="color: #00cd00;">"&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1079;&#1072; &#1076;&#1077;&#1085;&#1100;&#1075;&#1080;"</span>)
                                 (make-expirience
                                  <span style="color: #0000ee; font-weight: bold;">:name</span>         <span style="color: #00cd00;">"&#1042;&#1099;&#1084;&#1087;&#1077;&#1083;&#1082;&#1086;&#1084;"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:company-id</span>   <span style="color: #00cd00;">"4934"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:area-id</span>      <span style="color: #00cd00;">"1"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:url</span>          <span style="color: #00cd00;">""</span>
                                  <span style="color: #0000ee; font-weight: bold;">:industry-id</span>  <span style="color: #00cd00;">"0"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:industries</span>   <span style="color: #00cd00;">"399"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:exp-id</span>       <span style="color: #00cd00;">""</span>
                                  <span style="color: #0000ee; font-weight: bold;">:job-position</span> <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:start-date</span>   <span style="color: #00cd00;">"2001-01-01"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:end-date</span>     <span style="color: #00cd00;">"2005-01-01"</span>
                                  <span style="color: #0000ee; font-weight: bold;">:description</span>  <span style="color: #00cd00;">"&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1079;&#1072; &#1077;&#1076;&#1091; )"</span>))))
   <span style="color: #0000ee; font-weight: bold;">:skills</span> (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                       (format nil <span style="color: #00cd00;">"~A ~A"</span> a b))
                   (mapcar #'id
                           (list
                            (make-skill <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"&#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072; &#1072;&#1088;&#1093;&#1080;&#1090;&#1077;&#1082;&#1090;&#1091;&#1088;&#1099;"</span>)
                            (make-skill <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1091;&#1091;&#1084;&#1085;&#1072;&#1103; &#1095;&#1080;&#1089;&#1090;&#1082;&#1072; &#1083;&#1080;&#1094;&#1072;"</span>))))
   <span style="color: #0000ee; font-weight: bold;">:skills-string</span> <span style="color: #00cd00;">"&#1042; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1075;&#1086;&#1076;&#1099; &#1085;&#1072;&#1093;&#1086;&#1078;&#1091;&#1089;&#1100; &#1085;&#1072; &#1087;&#1077;&#1085;&#1089;&#1080;&#1080; )"</span>
   <span style="color: #0000ee; font-weight: bold;">:recommendations</span> (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                                (format nil <span style="color: #00cd00;">"~A ~A"</span> a b))
                            (mapcar #'id
                                    (list
                                     (make-recommendation
                                      <span style="color: #0000ee; font-weight: bold;">:recommendation-id</span> <span style="color: #00cd00;">"0"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:name</span>              <span style="color: #00cd00;">"&#1057;&#1084;&#1080;&#1088;&#1085;&#1086;&#1074;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:job-position</span>      <span style="color: #00cd00;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1080;&#1082;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:organization</span>      <span style="color: #00cd00;">"&#1040;&#1088;&#1084;&#1080;&#1103;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:contact-info</span>      <span style="color: #00cd00;">"9112869290"</span>)
                                     (make-recommendation
                                      <span style="color: #0000ee; font-weight: bold;">:recommendation-id</span> <span style="color: #00cd00;">"0"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:name</span>              <span style="color: #00cd00;">"&#1048;&#1074;&#1072;&#1085;&#1086;&#1074;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:job-position</span>      <span style="color: #00cd00;">"&#1047;&#1072;&#1084;&#1087;&#1086;&#1090;&#1077;&#1093;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:organization</span>      <span style="color: #00cd00;">"&#1040;&#1088;&#1084;&#1080;&#1103;"</span>
                                      <span style="color: #0000ee; font-weight: bold;">:contact-info</span>      <span style="color: #00cd00;">"9112878789"</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14"><span class="section-number-3">4.14</span> <span class="todo TODO">TODO</span> Вспомогательные сущности резюме</h3>
<div class="outline-text-3" id="text-4-14">
</div><div id="outline-container-sec-4-14-1" class="outline-4">
<h4 id="sec-4-14-1"><span class="section-number-4">4.14.1</span> Основное образование</h4>
<div class="outline-text-4" id="text-4-14-1">
<p>
[TODO] - Написать процедуру сопоставления вузов, факультетов и их идентификаторов на hh
</p>

<table id="education_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Данные основного образования</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">education-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор обучалки на hh (как правило пустой)</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название учебного заведения</td>
</tr>

<tr>
<td class="left">university-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор учебного заведения (если оно есть в базе hh)</td>
</tr>

<tr>
<td class="left">faculty-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор факультета</td>
</tr>

<tr>
<td class="left">organization</td>
<td class="left">varchar</td>
<td class="left">факультет</td>
</tr>

<tr>
<td class="left">result</td>
<td class="left">varchar</td>
<td class="left">специальность</td>
</tr>

<tr>
<td class="left">specialty-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор специальности</td>
</tr>

<tr>
<td class="left">year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">год окончания</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-4-14-2" class="outline-4">
<h4 id="sec-4-14-2"><span class="section-number-4">4.14.2</span> Иностранные языки</h4>
<div class="outline-text-4" id="text-4-14-2">
<p>
[TODO] - Написать процедуру сопоставления языков и их идентификаторов на hh
</p>

<table id="lang_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Данные иностранного языка</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">язык</td>
</tr>

<tr>
<td class="left">lang-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор на hh</td>
</tr>

<tr>
<td class="left">lang-degree</td>
<td class="left">varchar</td>
<td class="left">уровень владения</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-4-14-3" class="outline-4">
<h4 id="sec-4-14-3"><span class="section-number-4">4.14.3</span> Опыт работы</h4>
<div class="outline-text-4" id="text-4-14-3">
<p>
[TODO] - Посмотреть что значат некоторые поля
</p>

<table id="expirience_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Данные опыта работы</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название компании</td>
</tr>

<tr>
<td class="left">company-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентификатор компании на hh</td>
</tr>

<tr>
<td class="left">company-area-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">идентикатор города компании?</td>
</tr>

<tr>
<td class="left">url</td>
<td class="left">varchar</td>
<td class="left">сайт компании</td>
</tr>

<tr>
<td class="left">industry-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">предположительно отрасль компании (как правило пуста)</td>
</tr>

<tr>
<td class="left">industries</td>
<td class="left">varchar</td>
<td class="left">предположительно направления деятельности</td>
</tr>

<tr>
<td class="left">exp-id</td>
<td class="left">varchar</td>
<td class="left">не знаю что это такое</td>
</tr>

<tr>
<td class="left">job-position</td>
<td class="left">varchar</td>
<td class="left">должность</td>
</tr>

<tr>
<td class="left">start-date</td>
<td class="left">varchar</td>
<td class="left">начало работы</td>
</tr>

<tr>
<td class="left">end-date</td>
<td class="left">varchar</td>
<td class="left">окончание работы</td>
</tr>

<tr>
<td class="left">description</td>
<td class="left">(or db-null varchar)</td>
<td class="left">описание достижений</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-4-14-4" class="outline-4">
<h4 id="sec-4-14-4"><span class="section-number-4">4.14.4</span> Ключевые навыки</h4>
<div class="outline-text-4" id="text-4-14-4">
<table id="skill_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Данные ключевых навыков</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название навыка</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-4-14-5" class="outline-4">
<h4 id="sec-4-14-5"><span class="section-number-4">4.14.5</span> Рекоммендации</h4>
<div class="outline-text-4" id="text-4-14-5">
<table id="recommendation_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> Данные ключевых навыков</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">recommendation-id</td>
<td class="left">integer</td>
<td class="left">идентификатор рекомендации на hh</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">имя рекомендателя</td>
</tr>

<tr>
<td class="left">job-position</td>
<td class="left">varchar</td>
<td class="left">позиция рекомендателя</td>
</tr>

<tr>
<td class="left">organization</td>
<td class="left">varchar</td>
<td class="left">организация рекоммендателя</td>
</tr>

<tr>
<td class="left">contact-info</td>
<td class="left">varchar</td>
<td class="left">контактная информация</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-4-14-6" class="outline-4">
<h4 id="sec-4-14-6"><span class="section-number-4">4.14.6</span> Портфолио</h4>
<div class="outline-text-4" id="text-4-14-6">
<table id="portfolio_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Данные портфолио</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">varchar</td>
<td class="left">описание файла</td>
</tr>

<tr>
<td class="left">file</td>
<td class="left">varchar</td>
<td class="left">файл</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15"><span class="section-number-3">4.15</span> Отправка отклика (<code>send-respond</code>)</h3>
<div class="outline-text-3" id="text-4-15">
<div class="org-src-container">

<pre class="src src-lisp" id="send_respond">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">send-respond</span> (vacancy-id cookie-jar resume-id letter)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((url (format nil <span style="color: #00cd00;">"http://spb.hh.ru/vacancy/~A"</span> vacancy-id)))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;</span>
    (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
        (hh-get-page url cookie-jar *hh_account* <span style="color: #00cd00;">"http://spb.hh.ru"</span>)
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1090;&#1086;&#1084; &#1079;&#1072;&#1087;&#1088;&#1072;&#1096;&#1080;&#1074;&#1072;&#1077;&#1084; &#1074;&#1089;&#1087;&#1083;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; &#1086;&#1082;&#1085;&#1086; (X-Requested-With: XMLHttpRequest, Referer)</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((url-popup (format nil <span style="color: #00cd00;">"http://spb.hh.ru/applicant/vacancy_response/popup?vacancyId=~A&amp;autoOpen=no&amp;isTest=no&amp;withoutTest=no"</span> vacancy-id)))
        (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (response cookie-jar url)
            (hh-get-page url-popup cookie-jar *hh_account* url)
          <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1091;&#1090; &#1084;&#1086;&#1078;&#1085;&#1086; &#1073;&#1099;&#1083;&#1086; &#1073;&#1099; &#1087;&#1088;&#1086;&#1072;&#1085;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1092;&#1086;&#1088;&#1084;&#1091; &#1085;&#1072; &#1087;&#1088;&#1077;&#1076;&#1084;&#1077;&#1090; &#1089;&#1086;&#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1080;&#1103; &#1074;&#1099;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084;&#1099;&#1093; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
          (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-alist (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (cookie)
                                          (cons (drakma:cookie-name cookie) (drakma:cookie-value cookie)))
                                      (drakma:cookie-jar-cookies cookie-jar))))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; POST-&#1079;&#1072;&#1087;&#1088;&#1086;&#1089;</span>
            (<span style="color: #00cdcd; font-weight: bold;">let</span> ((resp (drakma:http-request
                         <span style="color: #00cd00;">"http://spb.hh.ru/applicant/vacancy_response/popup"</span>
                         <span style="color: #0000ee; font-weight: bold;">:user-agent</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0"</span>
                         <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>
                         <span style="color: #0000ee; font-weight: bold;">:content</span> (format nil <span style="color: #00cd00;">"~{~A~^&amp;~}"</span>
                                          (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                      (format nil <span style="color: #00cd00;">"~A=~A"</span> (car x) (cdr x)))
                                                  `((<span style="color: #00cd00;">"vacancy_id"</span> . ,(format nil <span style="color: #00cd00;">"~A"</span> vacancy-id))
                                                    (<span style="color: #00cd00;">"resume_id"</span> . ,(format nil <span style="color: #00cd00;">"~A"</span> resume-id))
                                                    (<span style="color: #00cd00;">"letter"</span> . ,(drakma:url-encode letter <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))
                                                    (<span style="color: #00cd00;">"_xsrf"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                                                    (<span style="color: #00cd00;">"ignore_postponed"</span> . <span style="color: #00cd00;">"true"</span>))))
                         <span style="color: #0000ee; font-weight: bold;">:content-type</span> <span style="color: #00cd00;">"application/x-www-form-urlencoded; charset=UTF-8"</span>
                         <span style="color: #0000ee; font-weight: bold;">:additional-headers</span>
                         `((<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"*/*"</span>)
                           (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"en-US,en;q=0.5"</span>)
                           (<span style="color: #00cd00;">"Accept-Encoding"</span> . <span style="color: #00cd00;">"gzip, deflate"</span>)
                           (<span style="color: #00cd00;">"X-Xsrftoken"</span> . ,(cdr (assoc <span style="color: #00cd00;">"_xsrf"</span> cookie-alist <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal)))
                           (<span style="color: #00cd00;">"X-Requested-With"</span> . <span style="color: #00cd00;">"XMLHttpRequest"</span>)
                           (<span style="color: #00cd00;">"Referer"</span> . ,(format nil <span style="color: #00cd00;">"http://spb.hh.ru/vacancy/~A"</span> vacancy-id))
                           (<span style="color: #00cd00;">"Connection"</span> . <span style="color: #00cd00;">"keep-alive"</span>)
                           (<span style="color: #00cd00;">"Pragma"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                           (<span style="color: #00cd00;">"Cache-Control"</span> . <span style="color: #00cd00;">"no-cache"</span>)
                           )
                         <span style="color: #0000ee; font-weight: bold;">:cookie-jar</span> cookie-jar
                         <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                         <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)))
              (flexi-streams:octets-to-string resp <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(send-respond "15382394" cookie-jar "39357756" "letter")))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16"><span class="section-number-3">4.16</span> Фабрика генераторов отзывов (<code>response-factory</code>)</h3>
<div class="outline-text-3" id="text-4-16">
<p>
Когда я посылаю отзыв на вакансию, работодатель может поменять ему статус. Я увижу
это на странице "отклики и приглашения" (<code>negotiations</code>). Эти отзывы следует
собирать так же как и вакансии.
</p>

<p>
(А может быть и другим путем. Пока используем такой же механизм как и с вакансиями.)
</p>

<p>
Пусть у нас есть фабрика <code>генераторов функций</code> назовем его <code>response-factory</code>, которая принимает
<code>источник вакансий</code> и возвращает <code>функцию-генератор в замыкании</code>.
</p>

<p>
Аналогично фабрике - генератору вакансий сделаем фабрику - генератор отзывов,
возвращающую функцию, которая при каждом своем вызове вернет один отзыв или <code>ложь</code> если все
вакансии кончились.
</p>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает отзывы, при этом
фунция <code>process-respond</code> не нуждается в замкнутых переменных (кукисах), т.к. не
загружает страницу отзыва. Поэтому мы можем вынести ее из замыкания.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="response_factory">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;parse_responds&gt;&gt;

&lt;&lt;process_respond&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">let</span> ((cookie-jar (make-instance 'drakma:cookie-jar)))
  (<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">response-factory</span> ((vac-src (eql 'hh)) src-account)
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((url      <span style="color: #00cd00;">"http://spb.hh.ru/applicant/negotiations?page=~A"</span>)
          (page     0)
          (responds nil))
      (alexandria:named-lambda get-responds ()
        (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((load-next-responds-page ()
                   (dbg <span style="color: #00cd00;">"load-next-responds-page (page=~A)"</span> page)
                   (<span style="color: #00cdcd; font-weight: bold;">let</span> ((next-responds-page-url (format nil url page))
                         (referer (<span style="color: #00cdcd; font-weight: bold;">if</span> (= page 0) <span style="color: #00cd00;">"http://spb.hh.ru"</span>(format nil url (- page 1)))))
                     (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (next-responds-page new-cookies ref-url)
                         (hh-get-page next-responds-page-url cookie-jar src-account referer)
                       (setf cookie-jar new-cookies)
                       (setf responds (hh-parse-responds next-responds-page))
                       (incf page)
                       (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal 0 (length responds))
                         (dbg <span style="color: #00cd00;">"~~ FIN"</span>)
                         (<span style="color: #00cdcd; font-weight: bold;">return-from</span> get-responds 'nil)))))
                 (get-respond ()
                   (dbg <span style="color: #00cd00;">"get-respond"</span>)
                   (<span style="color: #00cdcd; font-weight: bold;">when</span> (equal 0 (length responds))
                     (load-next-responds-page))
                   (<span style="color: #00cdcd; font-weight: bold;">prog1</span> (car responds)
                     (setf responds (cdr responds)))))
          (<span style="color: #00cdcd; font-weight: bold;">tagbody</span> get-new-respond
             (<span style="color: #00cdcd; font-weight: bold;">let</span> ((current-respond (process-respond (get-respond))))
               (<span style="color: #00cdcd; font-weight: bold;">if</span> (null current-respond)
                   (<span style="color: #00cdcd; font-weight: bold;">go</span> get-new-respond)
                   (<span style="color: #00cdcd; font-weight: bold;">return-from</span> get-responds current-respond)))))))))
</pre>
</div>
</div>

<div id="outline-container-sec-4-16-1" class="outline-4">
<h4 id="sec-4-16-1"><span class="section-number-4">4.16.1</span> Разбор отзыва (<code>process-respond</code>)</h4>
<div class="outline-text-4" id="text-4-16-1">
<div class="org-src-container">

<pre class="src src-lisp" id="process_respond">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> <span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">process-respond</span> (respond)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1053;&#1072;&#1081;&#1090;&#1080; src-id &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((src-id (car (last (split-sequence:split-sequence #\/ (getf respond <span style="color: #0000ee; font-weight: bold;">:vacancy-link</span>))))))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1044;&#1083;&#1103; &#1074;&#1089;&#1077;&#1093; &#1087;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1085;&#1099;&#1093; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;, &#1089;&#1090;&#1072;&#1090;&#1091;&#1089; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1093; &#1086;&#1090;&#1083;&#1080;&#1095;&#1072;&#1077;&#1090;&#1089;&#1103; &#1086;&#1090; "&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"..</span>
    (<span style="color: #00cdcd; font-weight: bold;">unless</span> (equal <span style="color: #00cd00;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>))
      (<span style="color: #00cdcd; font-weight: bold;">unless</span> (null src-id)
        <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1090;&#1072;&#1082;&#1072;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103; &#1077;&#1089;&#1090;&#1100; &#1074; &#1073;&#1076;</span>
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((target (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id))))
          (<span style="color: #00cdcd; font-weight: bold;">unless</span> (null target)
            (dbg (format nil <span style="color: #00cd00;">"~A : [~A] ~A "</span> src-id (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>) (getf respond <span style="color: #0000ee; font-weight: bold;">:vacancy-name</span>)))
            <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1080; &#1091; &#1085;&#1077;&#1077; &#1089;&#1090;&#1072;&#1090;&#1091;&#1089; RESPONDED &#1080;&#1083;&#1080; BEENVIEWED  - &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1089;&#1090;&#1072;&#1090;&#1091;&#1089;</span>
            (<span style="color: #00cdcd; font-weight: bold;">when</span> (or (equal <span style="color: #00cd00;">":RESPONDED"</span> (state target))
                      (equal <span style="color: #00cd00;">":BEENVIEWED"</span> (state target)))
              (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((equal <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>))
                     (takt target <span style="color: #0000ee; font-weight: bold;">:beenviewed</span>))
                    ((equal <span style="color: #00cd00;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span> (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>))
                     (takt target <span style="color: #0000ee; font-weight: bold;">:reject</span>))
                    ((equal <span style="color: #00cd00;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span> (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>))
                     (takt target <span style="color: #0000ee; font-weight: bold;">:invite</span>))
                    ((equal <span style="color: #00cd00;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span> (getf respond <span style="color: #0000ee; font-weight: bold;">:result</span>))
                     nil)
                    (t (err (format nil <span style="color: #00cd00;">"unk respond state ~A"</span> (state target)))))))))))
  respond)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-16-2" class="outline-4">
<h4 id="sec-4-16-2"><span class="section-number-4">4.16.2</span> Разбор откликов (<code>hh_parse_responds</code>)</h4>
<div class="outline-text-4" id="text-4-16-2">
<div class="org-src-container">

<pre class="src src-lisp" id="parse_responds">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)


(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">extract-responds-results</span> (tree)
  (<span style="color: #00cdcd; font-weight: bold;">block</span> subtree-extract
    (mtm (`(<span style="color: #00cd00;">"tbody"</span> NIL ,@rest)
           (<span style="color: #00cdcd; font-weight: bold;">return-from</span> subtree-extract rest))
         tree)))

(make-detect (response-date)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
          (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-date"</span>)) ,result))
    `(<span style="color: #0000ee; font-weight: bold;">:response-date</span> ,result)))

(make-detect (response-date-dimmed)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
          (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-date responses-date_dimmed"</span>))
                  ,result))
    `(response-date ,result)))

(make-detect (result-date)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
          (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-date"</span>)) ,result-date))
    `(<span style="color: #0000ee; font-weight: bold;">:result-date</span>, result-date)))

(make-detect (result-deny)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
          (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"negotiations__denial"</span>)) <span style="color: #00cd00;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span>)) `(<span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">"&#1054;&#1090;&#1082;&#1072;&#1079;"</span>)))

(make-detect (result-invite)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))
          (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"negotiations__invitation"</span>)) <span style="color: #00cd00;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span>)) `(<span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">"&#1055;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1077;"</span>)))

(make-detect (result-no-view)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #00cd00;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>) `(<span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">"&#1053;&#1077; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>)))

(make-detect (result-view)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>) `(<span style="color: #0000ee; font-weight: bold;">:result</span> <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;"</span>)))

(make-detect (result-archive)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>)) <span style="color: #00cd00;">"&#1042; &#1072;&#1088;&#1093;&#1080;&#1074;&#1077;"</span>) `(<span style="color: #0000ee; font-weight: bold;">:archive</span> t)))

(make-detect (responses-vacancy)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>))
          (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-vacancy"</span>))
                 (<span style="color: #00cd00;">"a"</span>
                  ((<span style="color: #00cd00;">"class"</span> ,_)
                   (<span style="color: #00cd00;">"target"</span> <span style="color: #00cd00;">"_blank"</span>) (<span style="color: #00cd00;">"href"</span> ,vacancy-link))
                  ,vacancy-name))
          (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-company"</span>)) ,emp-name))
    `(<span style="color: #0000ee; font-weight: bold;">:vacancy-link</span> ,vacancy-link <span style="color: #0000ee; font-weight: bold;">:vacancy-name</span> ,vacancy-name <span style="color: #0000ee; font-weight: bold;">:emp-name</span> ,emp-name)))

(make-detect (responses-vacancy-disabled)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>)) (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-vacancy responses-vacancy_disabled"</span>)) ,vacancy-name)
          (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-company"</span>)) ,emp-name))
    `(<span style="color: #0000ee; font-weight: bold;">:vacancy-name</span> ,vacancy-name <span style="color: #0000ee; font-weight: bold;">:emp-name</span> ,emp-name <span style="color: #0000ee; font-weight: bold;">:disabled</span> t)))

(make-detect (topic)
  (`(<span style="color: #00cd00;">"tr"</span> ((<span style="color: #00cd00;">"data-hh-negotiations-responses-topic-id"</span> ,topic-id) (<span style="color: #00cd00;">"class"</span> ,_)) ,@rest)
    `((<span style="color: #0000ee; font-weight: bold;">:topic-id</span> ,topic-id) ,rest)))


(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*detect-trash*</span> '(<span style="color: #00cd00;">"responses-trash"</span> <span style="color: #00cd00;">"cell_nowrap"</span> <span style="color: #00cd00;">"responses-bubble"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>))


(make-detect (responses-trash)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>)) (<span style="color: #00cd00;">"div"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-trash"</span>)) ,@rest)) <span style="color: #00cd00;">"responses-trash"</span>))

(make-detect (cell_nowrap)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell prosper-table__cell_nowrap"</span>))) <span style="color: #00cd00;">"cell_nowrap"</span>))
(make-detect (responses-bubble)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>)) (<span style="color: #00cd00;">"span"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"responses-bubble HH-Responses-NotificationIcon"</span>)))) <span style="color: #00cd00;">"responses-bubble"</span>))

(make-detect (prosper-table__cell)
  (`(<span style="color: #00cd00;">"td"</span> ((<span style="color: #00cd00;">"class"</span> <span style="color: #00cd00;">"prosper-table__cell"</span>)) ,@rest) <span style="color: #00cd00;">"prosper-table__cell"</span>))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">hh-parse-responds</span> (html)
  <span style="color: #00cd00;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080;&#1079; html"</span>
  (dbg <span style="color: #00cd00;">"hh-parse-responds"</span>)
  (setf *last-parse-data* html)
  (-&gt;&gt; (html-to-tree html)
       (extract-responds-results)
       (detect-response-date)
       (detect-response-date-dimmed)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(detect-result-date)</span>
       (detect-result-deny)
       (detect-result-invite)
       (detect-result-no-view)
       (detect-result-view)
       (detect-result-archive)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(detect-responses-vacancy)</span>
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(detect-responses-vacancy-disabled)</span>
       (detect-topic)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">trash</span>
       (detect-responses-trash)
       (detect-cell_nowrap)
       (detect-responses-bubble)
       (detect-prosper-table__cell)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">filter trash data</span>
       (maptree-if #'consp
                   #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (values
                        (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                       (<span style="color: #00cdcd; font-weight: bold;">when</span> (stringp x)
                                         (or
                                          (string= x <span style="color: #00cd00;">"div"</span>)
                                          (find x *detect-trash* <span style="color: #0000ee; font-weight: bold;">:test</span> #'string=)
                                          )))
                                   x)
                        #'mapcar)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">linearize for each elt</span>
       (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (tree)
                   (<span style="color: #00cdcd; font-weight: bold;">let</span> ((linearize))
                     (maptree #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                  (setf linearize
                                        (append linearize (list x))))
                              tree)
                     linearize)))
       ))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(hh-parse-responds *last-parse-data*))</span>


<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(print</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(hh-parse-responds</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(hh-get-page "http://spb.hh.ru/applicant/negotiations?page=1" cookie-jar *hh_account* "http://spb.hh.ru" ))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17"><span class="section-number-3">4.17</span> Получение и обработка отзывов (<code>run-response</code>)</h3>
<div class="outline-text-3" id="text-4-17">
<div class="org-src-container">

<pre class="src src-lisp" id="run_response">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;response_factory&gt;&gt;

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">run-response</span> ()
  (make-event <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"run-response"</span>
              <span style="color: #0000ee; font-weight: bold;">:tag</span> <span style="color: #00cd00;">"parser-run"</span>
              <span style="color: #0000ee; font-weight: bold;">:msg</span> (format nil <span style="color: #00cd00;">"&#1057;&#1073;&#1086;&#1088; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1086;&#1074; &#1080; &#1087;&#1088;&#1080;&#1075;&#1083;&#1072;&#1096;&#1077;&#1085;&#1080;&#1081;"</span>)
              <span style="color: #0000ee; font-weight: bold;">:author-id</span> 0
              <span style="color: #0000ee; font-weight: bold;">:ts-create</span> (get-universal-time))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((archive-cnt 0))
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((gen (response-factory 'hh *hh_account*)))
      (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> i <span style="color: #0000ee; font-weight: bold;">:from</span> 1 <span style="color: #0000ee; font-weight: bold;">:to</span> 700 <span style="color: #0000ee; font-weight: bold;">:do</span>
         (<span style="color: #00cdcd; font-weight: bold;">let</span> ((target (funcall gen)))
           (<span style="color: #00cdcd; font-weight: bold;">when</span> (null target)
             (<span style="color: #00cdcd; font-weight: bold;">return-from</span> run-response 'FIN-NIL))
           (<span style="color: #00cdcd; font-weight: bold;">when</span> (getf target <span style="color: #0000ee; font-weight: bold;">:archive</span>)
             (incf archive-cnt))
           (<span style="color: #00cdcd; font-weight: bold;">when</span> (&gt; archive-cnt 140)
             (<span style="color: #00cdcd; font-weight: bold;">return-from</span> run-response 'ARCHIVE))
           <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(print target)</span>
           ))
      (<span style="color: #00cdcd; font-weight: bold;">return-from</span> run-response 'loop))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(run-response)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Interface</h2>
<div class="outline-text-2" id="text-5">
<p>
Соберем веб-интерфейс:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface"><span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">iface.lisp</span>

(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;</span>
&lt;&lt;iface_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Главная страница модуля</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> hh <span style="color: #00cd00;">"/hh"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((vacs (aif (all-vacancy) it (err <span style="color: #00cd00;">"null vacancy"</span>)))
         (sorted-vacs (sort vacs #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b) (&gt; (salary a) (salary b)))))
         (breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span> (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>)))
         (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
    (base-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb)
      (content-box ()
        (heading (<span style="color: #00cd00;">"&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter"</span>) <span style="color: #00cd00;">"&#1052;&#1077;&#1085;&#1102; &#1084;&#1086;&#1076;&#1091;&#1083;&#1103;"</span>))
      (content-box ()
        ((<span style="color: #0000ee; font-weight: bold;">:section</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"dnd-area"</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:ul</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"connected handles list"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"not"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:li</span>)
           ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"/hh/vacs"</span>) <span style="color: #00cd00;">"&#1054;&#1090;&#1086;&#1073;&#1088;&#1072;&#1085;&#1085;&#1099;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>) <span style="color: #00cd00;">""</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:li</span>)
           ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"/hh/rules"</span>) <span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080;"</span>) <span style="color: #00cd00;">""</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:li</span>)
           ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"/hh-doc"</span>) <span style="color: #00cd00;">"&#1044;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1103;"</span>) <span style="color: #00cd00;">""</span>))))
      (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>)))))
  (<span style="color: #0000ee; font-weight: bold;">:SAVE</span> (ps-html
          ((<span style="color: #0000ee; font-weight: bold;">:input</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"hidden"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"SAVE"</span>))
          (submit <span style="color: #00cd00;">"SAVE"</span> <span style="color: #0000ee; font-weight: bold;">:onclick</span> <span style="color: #00cd00;">"save();return false;"</span>))
         (<span style="color: #00cdcd; font-weight: bold;">progn</span> nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Страница списка вакансий</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<a href="http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/">http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/</a>
<a href="http://romka.eu/blog/jquery-table-drag-and-drop">http://romka.eu/blog/jquery-table-drag-and-drop</a>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> vacs <span style="color: #00cd00;">"/hh/vacs"</span>
  (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((mrg (param)
             (<span style="color: #00cdcd; font-weight: bold;">if</span> (null param)
                 <span style="color: #00cd00;">""</span>
                 (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x y)
                             (concatenate 'string x (string #\NewLine) y))
                         (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                     (ps-html ((<span style="color: #0000ee; font-weight: bold;">:li</span> <span style="color: #0000ee; font-weight: bold;">:id</span> (src-id x)
                                                    <span style="color: #0000ee; font-weight: bold;">:class</span> (string-downcase (subseq (state x) 1))
                                                    <span style="color: #0000ee; font-weight: bold;">:title</span> (notes x))
                                               ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> (<span style="color: #00cdcd; font-weight: bold;">if</span> (empty (notes x)) <span style="color: #00cd00;">"emptynotes"</span> <span style="color: #00cd00;">"notes"</span>))
                                                (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((equal <span style="color: #00cd00;">"USD"</span> (currency x)) <span style="color: #00cd00;">"$"</span>)
                                                      ((equal <span style="color: #00cd00;">"EUR"</span> (currency x)) <span style="color: #00cd00;">"&#8364;"</span>)
                                                      ((equal <span style="color: #00cd00;">"RUR"</span> (currency x)) <span style="color: #00cd00;">""</span>))
                                                (salary-max x))
                                               ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"/hh/vac/~A"</span> (src-id x)))
                                                (name x)))))
                                 param)))))
    (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((vacs (aif (all-vacancy) it (err <span style="color: #00cd00;">"null vacancy"</span>)))
           (sorted-vacs (sort vacs #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b) (&gt; (salary-max a) (salary-max b)))))
           (breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span> (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>)))
           (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
      (base-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb)
        ((<span style="color: #0000ee; font-weight: bold;">:script</span>)
         (ps
           (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-child-ids</span> (selector)
             ((@ ((@ ((@ ($ selector) children)) map) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (i elt) (array ((@ ((@ $) elt) attr) <span style="color: #00cd00;">"id"</span>)))) get)))
           (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">save</span> ()
             ((@ $ post) <span style="color: #00cd00;">"#"</span> (create <span style="color: #0000ee; font-weight: bold;">:act</span> <span style="color: #00cd00;">"SAVE"</span> <span style="color: #0000ee; font-weight: bold;">:not</span> ((@ (get-child-ids <span style="color: #00cd00;">"#not"</span>) join)) <span style="color: #0000ee; font-weight: bold;">:yep</span> ((@ (get-child-ids <span style="color: #00cd00;">"#yep"</span>) join)))
              (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (data status)
                (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (equal status <span style="color: #00cd00;">"success"</span>))
                    (alert (concatenate 'string <span style="color: #00cd00;">"err-ajax-fail: "</span> status))
                    (eval data))))
             false)))
        (content-box ()
          (heading (<span style="color: #00cd00;">"&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter"</span>)
            <span style="color: #00cd00;">"&#1042; &#1087;&#1088;&#1072;&#1074;&#1086;&#1081; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1077; - &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1074; &#1083;&#1077;&#1074;&#1086;&#1081; - &#1085;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"unsort"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1046;&#1077;&#1083;&#1090;&#1099;&#1084;&amp;nbsp;"</span>)
            <span style="color: #00cd00;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1087;&#1086;&#1103;&#1074;&#1080;&#1083;&#1080;&#1089;&#1100; &#1074; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1075;&#1086; &#1089;&#1073;&#1086;&#1088;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;. "</span>
            <span style="color: #00cd00;">"&#1055;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; &#1086;&#1085;&#1080; &#1087;&#1086;&#1084;&#1077;&#1097;&#1072;&#1102;&#1090;&#1089;&#1103; &#1074; &#1087;&#1088;&#1072;&#1074;&#1099;&#1081; &#1089;&#1090;&#1086;&#1083;&#1073;&#1080;&#1082; - &#1082; &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1091;&#1102;&#1097;&#1080;&#1084; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103;&#1084;. "</span>
            <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1083;&#1077; &#1089;&#1086;&#1088;&#1090;&#1080;&#1088;&#1086;&#1074;&#1082;&#1080; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1089;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1080;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080; &#1090;&#1086;&#1075;&#1076;&#1072; &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077; &#1080;&#1089;&#1095;&#1077;&#1079;&#1085;&#1077;&#1090;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"responded"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1043;&#1086;&#1083;&#1091;&#1073;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085; &#1086;&#1090;&#1079;&#1099;&#1074;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"beenviewed"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1060;&#1080;&#1086;&#1083;&#1077;&#1090;&#1086;&#1074;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" &#1074;&#1099;&#1076;&#1077;&#1083;&#1077;&#1085;&#1099; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1086;&#1090;&#1079;&#1099;&#1074; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1099;&#1083; &#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1077;&#1085;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"reject"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1050;&#1088;&#1072;&#1089;&#1085;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" - &#1077;&#1089;&#1083;&#1080; &#1088;&#1072;&#1073;&#1086;&#1090;&#1086;&#1076;&#1072;&#1090;&#1077;&#1083;&#1100; &#1086;&#1090;&#1082;&#1072;&#1079;&#1072;&#1083;. "</span>
            <span style="color: #00cd00;">"&#1052;&#1086;&#1078;&#1085;&#1086; &#1087;&#1086;&#1087;&#1088;&#1086;&#1073;&#1086;&#1074;&#1072;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103; &#1076;&#1088;&#1091;&#1075;&#1080;&#1084; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077; &#1080;&#1083;&#1080; &#1079;&#1072;&#1073;&#1080;&#1090;&#1100; &#1085;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102; &#1080; &#1087;&#1077;&#1088;&#1077;&#1085;&#1077;&#1089;&#1090;&#1080; &#1077;&#1077; &#1074; '&#1085;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;' "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"invite"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1047;&#1077;&#1083;&#1077;&#1085;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" - &#1077;&#1089;&#1083;&#1080; &#1088;&#1072;&#1073;&#1086;&#1090;&#1086;&#1076;&#1072;&#1090;&#1077;&#1083;&#1100; &#1087;&#1088;&#1080;&#1075;&#1083;&#1072;&#1089;&#1080;&#1083; &#1085;&#1072; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"interview"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1057;&#1077;&#1088;&#1099;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" - &#1077;&#1089;&#1083;&#1080; &#1089;&#1086;&#1073;&#1077;&#1089;&#1077;&#1076;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1073;&#1099;&#1083;&#1086; &#1087;&#1088;&#1086;&#1081;&#1076;&#1077;&#1085;&#1086;. "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:br</span>))((<span style="color: #0000ee; font-weight: bold;">:br</span>))
            <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;, &#1082; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1084; &#1077;&#1089;&#1090;&#1100; &#1079;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;, &#1074;&#1099;&#1076;&#1077;&#1083;&#1103;&#1102;&#1090;&#1089;&#1103; &#1079;&#1072;&#1088;&#1087;&#1083;&#1072;&#1090;&#1086;&#1081; &#1085;&#1072; "</span>
            ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"notes"</span>) <span style="color: #00cd00;">"&amp;nbsp;&#1095;&#1077;&#1088;&#1085;&#1086;&#1084;&amp;nbsp;"</span>) <span style="color: #00cd00;">" &#1092;&#1086;&#1085;&#1077;. "</span>
            <span style="color: #00cd00;">"&#1055;&#1088;&#1080; &#1085;&#1072;&#1074;&#1077;&#1076;&#1077;&#1085;&#1080;&#1080; &#1085;&#1072; &#1090;&#1072;&#1082;&#1091;&#1102; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102; &#1084;&#1086;&#1078;&#1085;&#1086; &#1091;&#1074;&#1080;&#1076;&#1077;&#1090;&#1100; &#1090;&#1077;&#1082;&#1089;&#1090; &#1079;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;."</span>))
        (content-box ()
          %SAVE%
          ((<span style="color: #0000ee; font-weight: bold;">:section</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"dnd-area"</span>)
           ((<span style="color: #0000ee; font-weight: bold;">:ul</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"connected handles list"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"not"</span>)
            (mrg (remove-if-not #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                    (equal <span style="color: #00cd00;">":UNINTERESTING"</span> (state x)))
                                sorted-vacs)))
           ((<span style="color: #0000ee; font-weight: bold;">:ul</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"connected handles list no2"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"yep"</span>)
            (mrg (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                (equal <span style="color: #00cd00;">":UNINTERESTING"</span> (state x)))
                            sorted-vacs)))))
        (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))
  (<span style="color: #0000ee; font-weight: bold;">:SAVE</span> (ps-html
          ((<span style="color: #0000ee; font-weight: bold;">:input</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"hidden"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"SAVE"</span>))
          (submit <span style="color: #00cd00;">"SAVE"</span> <span style="color: #0000ee; font-weight: bold;">:onclick</span> <span style="color: #00cd00;">"save();return false;"</span>))
         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
           (setf *tmp1* (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:not</span>)))
           (setf *tmp2* (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:yep</span>)))
           (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (takt (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (parse-integer x))) <span style="color: #0000ee; font-weight: bold;">:uninteresting</span>))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:not</span>)))
           (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vac (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (parse-integer x)))))
                         (<span style="color: #00cdcd; font-weight: bold;">when</span> (or (equal (state vac) <span style="color: #00cd00;">":UNSORT"</span>)
                                   (equal (state vac) <span style="color: #00cd00;">":UNINTERESTING"</span>))
                           (takt vac <span style="color: #0000ee; font-weight: bold;">:interesting</span>))))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:yep</span>)))
           (<span style="color: #cd0000; font-weight: bold;">error</span> 'ajax <span style="color: #0000ee; font-weight: bold;">:output</span> <span style="color: #00cd00;">"window.location.href='/hh/vacs'"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Страница вакансии</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> vacancy <span style="color: #00cd00;">"/hh/vac/:src-id"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vac (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id))))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (null vac)
      (<span style="color: #00cdcd; font-weight: bold;">return-from</span> vacancy 404))
    (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((breadcrumb (<span style="color: #00cdcd; font-weight: bold;">if</span> (null vac)
                           (breadcrumb <span style="color: #00cd00;">"&#1053;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086;"</span> (<span style="color: #00cd00;">"/"</span> . <span style="color: #00cd00;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>) (<span style="color: #00cd00;">"/hh/vacs"</span> . <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>))
                           (breadcrumb (name vac) (<span style="color: #00cd00;">"/"</span> . <span style="color: #00cd00;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>) (<span style="color: #00cd00;">"/hh/vacs"</span> . <span style="color: #00cd00;">"&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>))))
           (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*))))
           (text (parenscript::process-html-forms-lhtml (read-from-string (descr vac)))))
      (standard-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb <span style="color: #0000ee; font-weight: bold;">:user</span> user <span style="color: #0000ee; font-weight: bold;">:menu</span> (menu) <span style="color: #0000ee; font-weight: bold;">:overlay</span> (reg-overlay))
        (content-box ()
          (heading ((format nil <span style="color: #00cd00;">"~A ~A"</span> (name vac) (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"color:red"</span>) (salary-text vac)))))
            (form (<span style="color: #00cd00;">"chvacstateform"</span> <span style="color: #00cd00;">""</span>)
              ((<span style="color: #0000ee; font-weight: bold;">:table</span> <span style="color: #0000ee; font-weight: bold;">:border</span> 0 <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"font-size: small;"</span>)
               ((<span style="color: #0000ee; font-weight: bold;">:tr</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"id:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (id vac))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"src-id:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"http://hh.ru/vacancy/~A"</span> (src-id vac))) (src-id vac)))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"archive:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (archive vac))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
               ((<span style="color: #0000ee; font-weight: bold;">:tr</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"emp-id:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (emp-id vac))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"emp-name:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"color:red"</span>) (emp-name vac)))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"state:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (state vac))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
               ((<span style="color: #0000ee; font-weight: bold;">:tr</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"city:"</span>)       ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (city vac))                                    ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"metro:"</span>)      ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (metro vac))                                   ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"state:"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>)
                 (fieldset <span style="color: #00cd00;">""</span>
                   (eval
                    (macroexpand
                     (append `(select (<span style="color: #00cd00;">"newstate"</span> <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:default</span> ,(subseq (state vac) 1)))
                             (list
                              (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                          (cons (symbol-name x) (symbol-name x)))
                                      (possible-trans vac))))))))
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
               ((<span style="color: #0000ee; font-weight: bold;">:tr</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"experience:"</span>) ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (experience vac))                              ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"date:"</span>)       ((<span style="color: #0000ee; font-weight: bold;">:td</span>) (date vac))                                    ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"state:"</span>)      ((<span style="color: #0000ee; font-weight: bold;">:td</span>) %CHSTATE%)                                     ((<span style="color: #0000ee; font-weight: bold;">:td</span>) <span style="color: #00cd00;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>))
               ))))
        (content-box ()
          ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"vacancy-descr"</span>) (format nil <span style="color: #00cd00;">"~{~A~}"</span> text)))
        (content-box ()
          (form (<span style="color: #00cd00;">"vacform"</span> nil <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-section-container"</span>)
            ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-section"</span>)
             (fieldset <span style="color: #00cd00;">"&#1047;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;"</span>
               (textarea (<span style="color: #00cd00;">"notes"</span> <span style="color: #00cd00;">"&#1047;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;"</span>) (notes vac))
               (textarea (<span style="color: #00cd00;">"response"</span> <span style="color: #00cd00;">"&#1057;&#1086;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1080;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1087;&#1080;&#1089;&#1100;&#1084;&#1086;"</span>) (response vac))
               (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>)))))
            %RESPOND% %SAVE%))
        (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))
  (<span style="color: #0000ee; font-weight: bold;">:chstate</span> (ps-html ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-send-container"</span>)
                      (submit <span style="color: #00cd00;">"&#1048;&#1079;&#1084;&#1077;&#1085;&#1080;&#1090;&#1100;"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"CHSTATE"</span>)))
            (<span style="color: #00cdcd; font-weight: bold;">progn</span>
              <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(id (upd-vacancy (car (find-vacancy :src-id src-id))</span>
              <span style="color: #cd0000;">;;                  </span><span style="color: #cd0000;">(list :notes (getf p :notes) :response (getf p :response))))</span>
              (takt (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id))
                    (intern (getf p <span style="color: #0000ee; font-weight: bold;">:newstate</span>) <span style="color: #0000ee; font-weight: bold;">:keyword</span>))
              (redirect (format nil <span style="color: #00cd00;">"/hh/vac/~A"</span> src-id))
              ))
  (<span style="color: #0000ee; font-weight: bold;">:save</span> (ps-html ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-send-container"</span>)
                   (submit <span style="color: #00cd00;">"&#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102;"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"SAVE"</span>)))
         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
           (id (upd-vacancy (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id))
                            (list <span style="color: #0000ee; font-weight: bold;">:notes</span> (getf p <span style="color: #0000ee; font-weight: bold;">:notes</span>) <span style="color: #0000ee; font-weight: bold;">:response</span> (getf p <span style="color: #0000ee; font-weight: bold;">:response</span>))))
           (redirect (format nil <span style="color: #00cd00;">"/hh/vac/~A"</span> src-id))))
  (<span style="color: #0000ee; font-weight: bold;">:respond</span> (ps-html
             ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-send-container"</span>)
              (eval
               (macroexpand
                (append '(select (<span style="color: #00cd00;">"resume"</span> <span style="color: #00cd00;">"&#1042;&#1099;&#1073;&#1088;&#1072;&#1090;&#1100; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077; &#1076;&#1083;&#1103; &#1086;&#1090;&#1087;&#1088;&#1072;&#1074;&#1082;&#1080; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1072;:"</span>))
                        (list
                         (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (cons (id x) (title x)))
                                 (sort (all-resume) #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b) (&lt; (id a) (id b)))))))))
              (submit <span style="color: #00cd00;">"&#1054;&#1090;&#1087;&#1088;&#1072;&#1074;&#1080;&#1090;&#1100; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"RESPOND"</span>)))
            (<span style="color: #00cdcd; font-weight: bold;">progn</span>
              (id (upd-vacancy (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id))
                               (list <span style="color: #0000ee; font-weight: bold;">:notes</span> (getf p <span style="color: #0000ee; font-weight: bold;">:notes</span>) <span style="color: #0000ee; font-weight: bold;">:response</span> (getf p <span style="color: #0000ee; font-weight: bold;">:response</span>))))
              (dbg (send-respond
                    src-id
                    (res-id (get-resume (parse-integer (getf p <span style="color: #0000ee; font-weight: bold;">:resume</span>))))
                    (getf p <span style="color: #0000ee; font-weight: bold;">:response</span>)))
              (dbg (takt (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> src-id)) <span style="color: #0000ee; font-weight: bold;">:responded</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> Страница правил</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> rules <span style="color: #00cd00;">"/hh/rules"</span>
  (<span style="color: #00cdcd; font-weight: bold;">labels</span> ((mrg (param)
             (<span style="color: #00cdcd; font-weight: bold;">if</span> (null param)
                 <span style="color: #00cd00;">""</span>
                 (reduce #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x y)
                             (concatenate 'string x (string #\NewLine) y))
                         (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                     (ps-html ((<span style="color: #0000ee; font-weight: bold;">:li</span> <span style="color: #0000ee; font-weight: bold;">:id</span> (id x)
                                                    <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">""</span> <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(if (null (state x)) "" (string-downcase (subseq (state x) 1)))</span>
                                                    <span style="color: #0000ee; font-weight: bold;">:title</span> <span style="color: #00cd00;">"(notes x)"</span>)
                                               ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"emptynotes"</span>) <span style="color: #00cd00;">" &amp;nbsp; "</span>)
                                               ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"/hh/rule/~A"</span> (id x))) (name x)))))
                                 param)))))
    (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span> (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>)))
           (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
      (base-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb)
        ((<span style="color: #0000ee; font-weight: bold;">:script</span>)
         (ps
           (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-child-ids</span> (selector)
             ((@ ((@ ((@ ($ selector) children)) map) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (i elt) (array ((@ ((@ $) elt) attr) <span style="color: #00cd00;">"id"</span>)))) get)))
           (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">save</span> ()
             ((@ $ post) <span style="color: #00cd00;">"#"</span> (create <span style="color: #0000ee; font-weight: bold;">:act</span> <span style="color: #00cd00;">"SAVE"</span> <span style="color: #0000ee; font-weight: bold;">:not</span> ((@ (get-child-ids <span style="color: #00cd00;">"#not"</span>) join)) <span style="color: #0000ee; font-weight: bold;">:yep</span> ((@ (get-child-ids <span style="color: #00cd00;">"#yep"</span>) join)))
              (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (data status)
                (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (equal status <span style="color: #00cd00;">"success"</span>))
                    (alert (concatenate 'string <span style="color: #00cd00;">"err-ajax-fail: "</span> status))
                    (eval data))))
             false)))
        (content-box ()
          (heading (<span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080;"</span>)
            <span style="color: #00cd00;">"&#1042; &#1087;&#1088;&#1072;&#1074;&#1086;&#1081; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1077; - &#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1076;&#1083;&#1103; &#1090;&#1080;&#1079;&#1077;&#1088;&#1086;&#1074;, &#1074; &#1083;&#1077;&#1074;&#1086;&#1081; - &#1076;&#1083;&#1103; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;. "</span>))
        (content-box ()
          %SAVE%
          ((<span style="color: #0000ee; font-weight: bold;">:section</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"dnd-area"</span>)
           ((<span style="color: #0000ee; font-weight: bold;">:ul</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"connected handles list"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"not"</span>)
            (mrg (rules-for-teaser)))
           ((<span style="color: #0000ee; font-weight: bold;">:ul</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"connected handles list no2"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"yep"</span>)
            (mrg (rules-for-vacancy)))))
        (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))
  (<span style="color: #0000ee; font-weight: bold;">:SAVE</span> (ps-html
          ((<span style="color: #0000ee; font-weight: bold;">:input</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"hidden"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"SAVE"</span>))
          (submit <span style="color: #00cd00;">"SAVE"</span> <span style="color: #0000ee; font-weight: bold;">:onclick</span> <span style="color: #00cd00;">"save();return false;"</span>))
         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
           (setf *tmp1* (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:not</span>)))
           (setf *tmp2* (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:yep</span>)))
           (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (takt (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (parse-integer x))) <span style="color: #0000ee; font-weight: bold;">:uninteresting</span>))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:not</span>)))
           (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((vac (car (find-vacancy <span style="color: #0000ee; font-weight: bold;">:src-id</span> (parse-integer x)))))
                         (<span style="color: #00cdcd; font-weight: bold;">unless</span> (equal (state vac) <span style="color: #00cd00;">":RESPONDED"</span>)
                           (takt vac <span style="color: #0000ee; font-weight: bold;">:interesting</span>))))
                   (split-sequence:split-sequence #\, (getf p <span style="color: #0000ee; font-weight: bold;">:yep</span>)))
           (<span style="color: #cd0000; font-weight: bold;">error</span> 'ajax <span style="color: #0000ee; font-weight: bold;">:output</span> <span style="color: #00cd00;">"window.location.href='/hh/rules'"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Страница правила</h3>
<div class="outline-text-3" id="text-5-5">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> rule <span style="color: #00cd00;">"/hh/rule/:id"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((item (get-rule (parse-integer id))))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (null item)
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1056;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1103; &#1085;&#1086;&#1074;&#1086;&#1075;&#1086; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1103;"</span> (<span style="color: #00cd00;">"/"</span> . <span style="color: #00cd00;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #00cd00;">"/secondary"</span> . <span style="color: #00cd00;">"&#1042;&#1090;&#1086;&#1088;&#1086;&#1089;&#1090;&#1077;&#1087;&#1077;&#1085;&#1085;&#1072;&#1103;"</span>)))
              (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
          (standard-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb <span style="color: #0000ee; font-weight: bold;">:user</span> user <span style="color: #0000ee; font-weight: bold;">:menu</span> (menu) <span style="color: #0000ee; font-weight: bold;">:overlay</span> (reg-overlay))
            (content-box ()
              (system-msg (<span style="color: #00cd00;">"caution"</span>)
                (<span style="color: #00cdcd; font-weight: bold;">let</span> ((tmp ))
                  (ps-html ((<span style="color: #0000ee; font-weight: bold;">:p</span>) (format nil <span style="color: #00cd00;">"&#1050; &#1089;&#1086;&#1078;&#1072;&#1083;&#1077;&#1085;&#1080;&#1102;, &#1090;&#1072;&#1082;&#1086;&#1075;&#1086; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072; &#1085;&#1077;&#1090;! &#1053;&#1072;&#1074;&#1077;&#1088;&#1085;&#1086;&#1077;, &#1101;&#1090;&#1086; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1086; &#1073;&#1099;&#1083;&#1086; &#1091;&#1076;&#1072;&#1083;&#1077;&#1085;&#1086;"</span>))
                           (submit <span style="color: #00cd00;">"&#1042;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103; &#1082; &#1089;&#1087;&#1080;&#1089;&#1082;&#1091; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;"</span>
                                   <span style="color: #0000ee; font-weight: bold;">:onclick</span> (format nil <span style="color: #00cd00;">"window.location.href='/hh/rules'; return false;"</span>))))))
            (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>)))))
        <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">else - rule found</span>
        (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((breadcrumb (<span style="color: #00cdcd; font-weight: bold;">if</span> (null item)
                               (breadcrumb <span style="color: #00cd00;">"&#1053;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086;"</span> (<span style="color: #00cd00;">"/"</span> . <span style="color: #00cd00;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>) (<span style="color: #00cd00;">"/hh/rules"</span> . <span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span>))
                               (breadcrumb (name item) (<span style="color: #00cd00;">"/"</span> . <span style="color: #00cd00;">"&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;"</span>) (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>) (<span style="color: #00cd00;">"/hh/rules"</span> . <span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span>))))
               (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
          (standard-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb <span style="color: #0000ee; font-weight: bold;">:user</span> user <span style="color: #0000ee; font-weight: bold;">:menu</span> (menu) <span style="color: #0000ee; font-weight: bold;">:overlay</span> (reg-overlay))
            (content-box ()
              (heading ((format nil <span style="color: #00cd00;">"~A"</span> (ps-html <span style="color: #00cd00;">"&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1088;&#1077;&#1076;&#1072;&#1082;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span>))))
              (form (<span style="color: #00cd00;">"ruleform"</span> nil <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-section-container"</span>)
                ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-section"</span>)
                 (fieldset (format nil <span style="color: #00cd00;">"&#1055;&#1088;&#1072;&#1074;&#1080;&#1083;&#1086; ~A:"</span> (name item))
                   (input (<span style="color: #00cd00;">"name"</span> <span style="color: #00cd00;">"&#1048;&#1084;&#1103;"</span>  <span style="color: #0000ee; font-weight: bold;">:value</span> (name item)))
                   (input (<span style="color: #00cd00;">"rank"</span> <span style="color: #00cd00;">"&#1056;&#1072;&#1085;&#1075;"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> (rank item)))
                   (fieldset <span style="color: #00cd00;">""</span>
                     (eval
                      (macroexpand
                       (append `(select (<span style="color: #00cd00;">"ruletype"</span> <span style="color: #00cd00;">"&#1058;&#1080;&#1087; &#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span> <span style="color: #0000ee; font-weight: bold;">:default</span> ,(subseq (ruletype item) 1)))
                               (list
                                (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                            (cons x x))
                                        '(<span style="color: #00cd00;">"TEASER"</span> <span style="color: #00cd00;">"VACANCY"</span>)))))))
                   (textarea (<span style="color: #00cd00;">"antecedent"</span> <span style="color: #00cd00;">"&#1059;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1089;&#1088;&#1072;&#1073;&#1072;&#1090;&#1099;&#1074;&#1072;&#1085;&#1080;&#1103;"</span>) (antecedent item))
                   (textarea (<span style="color: #00cd00;">"consequent"</span> <span style="color: #00cd00;">"&#1044;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1077;"</span>) (consequent item))
                   (textarea (<span style="color: #00cd00;">"notes"</span> <span style="color: #00cd00;">"&#1047;&#1072;&#1084;&#1077;&#1090;&#1082;&#1080;"</span>) (notes item))
                   (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>)))))
                %SAVE%))
            (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>)))))))
  (<span style="color: #0000ee; font-weight: bold;">:save</span> (ps-html ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"form-send-container"</span>)
                   (submit <span style="color: #00cd00;">"&#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1102;"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"SAVE"</span>)))
         (<span style="color: #00cdcd; font-weight: bold;">progn</span>
           (id (upd-rule (get-rule (parse-integer id))
                         (list
                          <span style="color: #0000ee; font-weight: bold;">:user-id</span> *current-user*
                          <span style="color: #0000ee; font-weight: bold;">:name</span> (getf p <span style="color: #0000ee; font-weight: bold;">:name</span>)
                          <span style="color: #0000ee; font-weight: bold;">:rank</span> (getf p <span style="color: #0000ee; font-weight: bold;">:rank</span>)
                          <span style="color: #0000ee; font-weight: bold;">:ruletype</span> (format nil <span style="color: #00cd00;">":~A"</span> (getf p <span style="color: #0000ee; font-weight: bold;">:ruletype</span>))
                          <span style="color: #0000ee; font-weight: bold;">:antecedent</span> (getf p <span style="color: #0000ee; font-weight: bold;">:antecedent</span>)
                          <span style="color: #0000ee; font-weight: bold;">:consequent</span> (getf p <span style="color: #0000ee; font-weight: bold;">:consequent</span>)
                          <span style="color: #0000ee; font-weight: bold;">:notes</span> (getf p <span style="color: #0000ee; font-weight: bold;">:notes</span>))))
           (redirect (format nil <span style="color: #00cd00;">"/hh/rule/~A"</span> id)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> Страница документации модуля</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(restas:define-route hh-doc (<span style="color: #00cd00;">"/hh-doc"</span>)
  (alexandria:read-file-into-string
   (merge-pathnames
    (pathname-parent-directory (pathname *base-path*))
    #P<span style="color: #00cd00;">"hh.html"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> Страница поиска</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> search-vacancy <span style="color: #00cd00;">"/hh/search"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1055;&#1086;&#1080;&#1089;&#1082;"</span> (<span style="color: #00cd00;">"/hh"</span> . <span style="color: #00cd00;">"HeadHunter"</span>)))
         (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
    (base-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb)
      (content-box ()
        (heading (<span style="color: #00cd00;">"&#1055;&#1086;&#1080;&#1089;&#1082; &#1087;&#1086; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1103;&#1084; &#1074; &#1089;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1080;&#1080; &#1074;&#1099;&#1096;&#1077; :RESPOND"</span>) <span style="color: #00cd00;">""</span>))
      (content-box ()
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((q (get-parameter <span style="color: #00cd00;">"q"</span>)))
          (<span style="color: #00cdcd; font-weight: bold;">if</span> (null q)
              <span style="color: #00cd00;">"empty searchstring"</span>
              (ps-html
               ((<span style="color: #0000ee; font-weight: bold;">:ul</span>)
                (format nil <span style="color: #00cd00;">"~{~A~}"</span>
                        (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                    (ps-html
                                     ((<span style="color: #0000ee; font-weight: bold;">:li</span> <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"padding: 3px"</span>)
                                      ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"/hh/vac/~A"</span> (src-id (car x))))
                                       (name (car x))
                                       <span style="color: #00cd00;">"&amp;nbsp&amp;nbsp:&amp;nbsp&amp;nbsp"</span>
                                       (emp-name (car x))))))
                                (sort (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                     (equal (cdr x) 0))
                                                 (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                             (<span style="color: #00cdcd; font-weight: bold;">let</span> ((rel 0))
                                                               (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains (string-downcase (name x)) (string-downcase q))
                                                                 (incf rel 3))
                                                               (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains (string-downcase (emp-name x)) (string-downcase q))
                                                                 (incf rel 5))
                                                               (<span style="color: #00cdcd; font-weight: bold;">when</span> (contains (string-downcase (descr x)) (string-downcase q))
                                                                 (incf rel))
                                                               (cons x rel)))
                                                         (remove-if #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                                                        (or (equal <span style="color: #00cd00;">":UNSORT"</span> (state x)))
                                                                        (or (equal <span style="color: #00cd00;">":UNINTERESTING"</span> (state x))))
                                                                    (all-vacancy))))
                                      #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b)
                                          (&gt; (cdr a) (cdr b)))))))))))
      (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> Галлерея (parenscript)</h3>
<div class="outline-text-3" id="text-5-8">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*slideshows*</span> (make-hash-table <span style="color: #0000ee; font-weight: bold;">:test</span> 'equalp))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">add-slideshow</span> (slideshow-name image-folder)
  (setf (gethash slideshow-name *slideshows*)
        (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (pathname)
                  (url-encode (format nil <span style="color: #00cd00;">"~a.~a"</span>
                                      (pathname-name pathname)
                                      (pathname-type pathname))))
                (list-directory image-folder))))

(add-slideshow <span style="color: #00cd00;">"img"</span> <span style="color: #00cd00;">"/home/rigidus/repo/moto/img/"</span>)
(add-slideshow <span style="color: #00cd00;">"pic"</span> <span style="color: #00cd00;">"/home/rigidus/repo/moto/pic/"</span>)

(alexandria:hash-table-plist *slideshows*)

(defmacro/ps slideshow-image-uri (slideshow-name image-file)
  `(concatenate 'string ,slideshow-name <span style="color: #00cd00;">"/"</span> ,image-file))

(restas:define-route y (<span style="color: #00cd00;">"y"</span>)
  (ps
    (<span style="color: #00cdcd; font-weight: bold;">define-symbol-macro</span> <span style="color: #0000ee; font-weight: bold;">fragment-identifier</span> (@ window location hash))
    (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">show-image-number</span> (image-index)
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((image-name (aref *images* (setf *current-image-index* image-index))))
        (setf (chain document (get-element-by-id <span style="color: #00cd00;">"slideshow-img-object"</span>) src)
              (slideshow-image-uri *slideshow-name* image-name)
              fragment-identifier
              image-name)))
    (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">previous-image</span> ()
      (<span style="color: #00cdcd; font-weight: bold;">when</span> (&gt; *current-image-index* 0)
        (show-image-number (1- *current-image-index*))))
    (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">next-image</span> ()
      (<span style="color: #00cdcd; font-weight: bold;">when</span> (&lt; *current-image-index* (1- (getprop *images* 'length)))
        (show-image-number (1+ *current-image-index*))))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">this gives bookmarkability using fragment identifiers</span>
    (setf (getprop window 'onload)
          (<span style="color: #00cdcd; font-weight: bold;">lambda</span> ()
            (<span style="color: #00cdcd; font-weight: bold;">when</span> fragment-identifier
              (<span style="color: #00cdcd; font-weight: bold;">let</span> ((image-name (chain fragment-identifier (slice 1))))
                (<span style="color: #00cdcd; font-weight: bold;">dotimes</span> (i (length *images*))
                  (<span style="color: #00cdcd; font-weight: bold;">when</span> (string= image-name (aref *images* i))
                    (show-image-number i)))))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">slideshow-handler</span> (slideshow-name)
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((images (gethash slideshow-name *slideshows*))
         (current-image-index (or (position (get-parameter <span style="color: #00cd00;">"image"</span>) images <span style="color: #0000ee; font-weight: bold;">:test</span> #'equalp)
                                  0))
         (previous-image-index (max 0 (1- current-image-index)))
         (next-image-index (min (1- (length images)) (1+ current-image-index))))
    (<span style="color: #00cdcd; font-weight: bold;">with-html-output-to-string</span> (s)
      (<span style="color: #0000ee; font-weight: bold;">:html</span>
       (<span style="color: #0000ee; font-weight: bold;">:head</span>
        (<span style="color: #0000ee; font-weight: bold;">:title</span> <span style="color: #00cd00;">"Parenscript slideshow"</span>)
        (<span style="color: #0000ee; font-weight: bold;">:script</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"text/javascript"</span>
                 (str (ps* `(<span style="color: #00cdcd; font-weight: bold;">progn</span>
                              (var *slideshow-name* ,slideshow-name)
                              (var *images* (array ,@images))
                              (var *current-image-index* ,current-image-index)))))
        (<span style="color: #0000ee; font-weight: bold;">:script</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"text/javascript"</span> <span style="color: #0000ee; font-weight: bold;">:src</span> <span style="color: #00cd00;">"/y"</span>)
        )
       (<span style="color: #0000ee; font-weight: bold;">:body</span>
        (<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"slideshow-container"</span>
              <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"width:100%;text-align:center"</span>
              (<span style="color: #0000ee; font-weight: bold;">:img</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"slideshow-img-object"</span>
                    <span style="color: #0000ee; font-weight: bold;">:src</span> (slideshow-image-uri slideshow-name
                                              (elt images current-image-index)))
              <span style="color: #0000ee; font-weight: bold;">:br</span>
              (<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"?image=~a"</span> (elt images previous-image-index))
                  <span style="color: #0000ee; font-weight: bold;">:onclick</span> (ps (previous-image) (<span style="color: #00cdcd; font-weight: bold;">return</span> false))
                  <span style="color: #00cd00;">"Previous"</span>)
              <span style="color: #00cd00;">" "</span>
              (<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> (format nil <span style="color: #00cd00;">"?image=~a"</span> (elt images next-image-index))
                  <span style="color: #0000ee; font-weight: bold;">:onclick</span> (ps (next-image) (<span style="color: #00cdcd; font-weight: bold;">return</span> false))
                  <span style="color: #00cd00;">"Next"</span>)
              ))))))

(restas:define-route x (<span style="color: #00cd00;">"/x"</span>)
  (slideshow-handler <span style="color: #00cd00;">"pic"</span>))

(restas:define-route z (<span style="color: #00cd00;">"/z"</span>)
  (slideshow-handler <span style="color: #00cd00;">"img"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9"><span class="section-number-3">5.9</span> <span class="todo TODO">TODO</span> Тестовая страница</h3>
<div class="outline-text-3" id="text-5-9">
<p>
[TODO] - Здесь мы поэкспериментируем с flexbox-дизайном, чтобы сделать все доступным
с мобильных устройств.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(restas:define-route mob (<span style="color: #00cd00;">"mob"</span>)
  (<span style="color: #00cdcd; font-weight: bold;">progn</span>
    <span style="color: #00cd00;">"&lt;!DOCTYPE HTML&gt;</span>
<span style="color: #00cd00;">&lt;html lang=\"ru\"&gt;</span>
<span style="color: #00cd00;">&lt;head&gt;</span>
<span style="color: #00cd00;">&lt;title&gt;Flexbox, &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086; &#8212; &#1055;&#1077;&#1087;&#1077;&#1083;&#1089;&#1073;&#1077;&#1081;.net&lt;/title&gt;</span>
<span style="color: #00cd00;">&lt;meta charset=\"utf-8\"&gt;</span>
<span style="color: #00cd00;">&lt;meta name=\"viewport\" content=\"width=1274, user-scalable=no\"&gt;</span>
<span style="color: #00cd00;">&lt;!-- link rel=\"stylesheet\" href=\"../shower/themes/ribbon/styles/screen.css\" --&gt;</span>
<span style="color: #00cd00;">&lt;style type=\"text/css\"&gt;</span>
<span style="color: #00cd00;">/**</span>
<span style="color: #00cd00;"> * Ribbon theme for Shower HTML presentation engine</span>
<span style="color: #00cd00;"> * shower-ribbon v1.1.0, https://github.com/shower/ribbon</span>
<span style="color: #00cd00;"> * Copyright &#169; 2010&#8211;2015 Vadim Makeev, http://pepelsbey.net</span>
<span style="color: #00cd00;"> * Licensed under MIT license: github.com/shower/shower/wiki/MIT-License</span>
<span style="color: #00cd00;"> */</span>
<span style="color: #00cd00;">@charset \"UTF-8\";@font-face{font-family:'PT Sans';src:url(../fonts/PTSans.woff) format(\"woff\")}@font-face{font-weight:700;font-family:'PT Sans';src:url(../fonts/PTSans.Bold.woff) format(\"woff\")}@font-face{font-style:italic;font-family:'PT Sans';src:url(../fonts/PTSans.Italic.woff) format(\"woff\")}@font-face{font-style:italic;font-weight:700;font-family:'PT Sans';src:url(../fonts/PTSans.Bold.Italic.woff) format(\"woff\")}@font-face{font-family:'PT Sans Narrow';font-weight:700;src:url(../fonts/PTSans.Narrow.Bold.woff) format(\"woff\")}@font-face{font-family:'PT Mono';src:url(../fonts/PTMono.woff) format(\"woff\")}html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}.shower{counter-reset:slide;font:25px/2 'PT Sans',sans-serif}@media print{.shower{text-rendering:geometricPrecision}}.shower a{color:#4b86c2;background:-webkit-linear-gradient(bottom,currentColor,currentColor .09em,transparent .09em,transparent)repeat-x;background:linear-gradient(to top,currentColor,currentColor .09em,transparent .09em,transparent)repeat-x;text-decoration:none}.caption{display:none;margin:0 0 50px;color:#3c3d40;text-shadow:0 1px 1px #8d8e90}.caption h1{font:700 50px/1 'PT Sans Narrow',sans-serif}.caption a{text-shadow:0 -1px 1px #1f3f60;background:0 0}.caption a:hover{color:#5e93c8}.badge{position:absolute;top:0;right:0;display:none;overflow:hidden;visibility:hidden;width:11em;height:11em;line-height:2.5;font-size:15px}.badge a{position:absolute;bottom:50%;right:-50%;left:-50%;visibility:visible;background:#4b86c2;box-shadow:0 0 1em rgba(0,0,0,.3);color:#fff;text-decoration:none;text-align:center;-webkit-transform-origin:50% 100%;-ms-transform-origin:50% 100%;transform-origin:50% 100%;-webkit-transform:rotate(45deg) translateY(-1em);-ms-transform:rotate(45deg) translateY(-1em);transform:rotate(45deg) translateY(-1em)}.badge a:hover{background:#568ec6}.region{display:none}.slide{position:relative;width:1024px;height:640px;background:#fff;color:#000;-webkit-print-color-adjust:exact;-webkit-text-size-adjust:none;-moz-text-size-adjust:none;-ms-text-size-adjust:none}@media print{.slide{page-break-before:always}}.slide:after{position:absolute;top:0;right:119px;padding:20px 0 0;width:50px;height:80px;background:url(../images/ribbon.svg) no-repeat;color:#fff;counter-increment:slide;content:counter(slide);text-align:center;font-size:20px}.slide&gt;div{position:absolute;top:0;left:0;overflow:hidden;padding:105px 120px 0;width:784px;height:535px}.slide h2{margin:0 0 37px;color:#666;font:700 50px/1 'PT Sans Narrow',sans-serif}.slide p{margin:0 0 50px}.slide p.note{color:#999}.slide b,.slide strong{font-weight:700}.slide i,.slide em{font-style:italic}.slide code,.slide kbd,.slide mark,.slide samp{padding:3px 8px;border-radius:8px;color:#000}.slide kbd,.slide code,.slide samp{background:rgba(0,0,0,.07);color:#000;line-height:1;font-family:'PT Mono',monospace}.slide mark{background:#fafaa2}.slide sub,.slide sup{position:relative;line-height:0;font-size:75%}.slide sub{bottom:-.25em}.slide sup{top:-.5em}.slide blockquote{font-style:italic}.slide blockquote:before{position:absolute;margin:-16px 0 0 -80px;color:#ccc;font:200px/1 'PT Sans',sans-serif;content:'\201C'}.slide blockquote+figcaption{margin:-50px 0 50px;font-style:italic;font-weight:700}.slide ol,.slide ul{margin:0 0 50px;counter-reset:list}.slide ol li,.slide ul li{text-indent:-2em}.slide ol li:before,.slide ul li:before{display:inline-block;width:2em;color:#bbb;text-align:right}.slide ol ol,.slide ol ul,.slide ul ol,.slide ul ul{margin:0 0 0 2em}.slide ul&gt;li:before{content:'\2022\00A0\00A0'}.slide ul&gt;li:lang(ru):before{content:'\2014\00A0\00A0'}.slide ol&gt;li:before{counter-increment:list;content:counter(list)\". \"}.slide pre{margin:0 0 49px;padding:1px 0 0;counter-reset:code;white-space:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4}.slide pre code{display:block;padding:0;background:0 0;white-space:pre;line-height:2}.slide pre code:before{position:absolute;margin-left:-50px;color:#bbb;counter-increment:code;content:counter(code,decimal-leading-zero)\".\"}.slide pre code:only-child:before{content:''}.slide pre mark.important{background:#c00;color:#fff}.slide pre mark.comment{padding:0;background:0 0;color:#999}.slide table{margin:0 0 50px;width:100%;border-collapse:collapse;border-spacing:0}.slide table th,.slide table td{background:-webkit-linear-gradient(bottom,#bbb,#bbb .055em,transparent .055em,transparent)repeat-x;background:linear-gradient(to top,#bbb,#bbb .055em,transparent .055em,transparent)repeat-x}.slide table th{text-align:left;font-weight:700}.slide table.striped tr:nth-child(even){background:#eee}.slide.cover,.slide.shout{z-index:1}.slide.cover:after,.slide.shout:after{visibility:hidden}.slide.cover{background:#000}.slide.cover img,.slide.cover svg,.slide.cover video,.slide.cover object,.slide.cover canvas,.slide.cover iframe{position:absolute;top:0;left:0;z-index:-1}.slide.cover.w img,.slide.cover.w svg,.slide.cover.w video,.slide.cover.w object,.slide.cover.w canvas,.slide.cover.w iframe{top:50%;width:100%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.slide.cover.h img,.slide.cover.h svg,.slide.cover.h video,.slide.cover.h object,.slide.cover.h canvas,.slide.cover.h iframe{left:50%;height:100%;-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%);transform:translateX(-50%)}.slide.cover.w.h img,.slide.cover.w.h svg,.slide.cover.w.h video,.slide.cover.w.h object,.slide.cover.w.h canvas,.slide.cover.w.h iframe{top:0;left:0;-webkit-transform:none;-ms-transform:none;transform:none}.slide.shout h2{position:absolute;top:50%;left:0;width:100%;text-align:center;line-height:1;font-size:150px;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.slide.shout h2 a{background:-webkit-linear-gradient(bottom,currentColor,currentColor .11em,transparent .11em,transparent)repeat-x;background:linear-gradient(to top,currentColor,currentColor .11em,transparent .11em,transparent)repeat-x}.slide .place{position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}.slide .place.t.l,.slide .place.t.r,.slide .place.b.r,.slide .place.b.l{-webkit-transform:none;-ms-transform:none;transform:none}.slide .place.t,.slide .place.b{-webkit-transform:translate(-50%,0);-ms-transform:translate(-50%,0);transform:translate(-50%,0)}.slide .place.l,.slide .place.r{-webkit-transform:translate(0,-50%);-ms-transform:translate(0,-50%);transform:translate(0,-50%)}.slide .place.t,.slide .place.t.l,.slide .place.t.r{top:0}.slide .place.r{right:0;left:auto}.slide .place.b,.slide .place.b.r,.slide .place.b.l{top:auto;bottom:0}.slide .place.l{left:0}.slide footer{position:absolute;left:0;right:0;bottom:-640px;z-index:1;display:none;padding:20px 120px 4px;background:#fafaa2;box-shadow:0 0 0 2px #f0f0ac inset;-webkit-transition:bottom .3s;transition:bottom .3s}.slide footer p{margin:0 0 16px}.slide footer mark{background:rgba(255,255,255,.7)}.slide:hover footer{bottom:0}@media screen{.shower.list{position:absolute;clip:rect(0,auto,auto,0);padding:80px 0 40px 100px;background:#585a5e url(../images/linen.png)}}@media screen and (-webkit-min-device-pixel-ratio:2),screen and (min-resolution:192dpi){.shower.list{background-image:url(../images/linen@2x.png);background-size:256px}}@media screen{.shower.list .caption,.shower.list .badge{display:block}.shower.list .slide{float:left;margin:0 -412px -220px 0;-webkit-transform-origin:0 0;-ms-transform-origin:0 0;transform-origin:0 0;-webkit-transform:scale(.5);-ms-transform:scale(.5);transform:scale(.5)}}@media screen and (max-width:1324px){.shower.list .slide{margin:0 -688px -400px 0;-webkit-transform:scale(.25);-ms-transform:scale(.25);transform:scale(.25)}}@media screen{.shower.list .slide:before{position:absolute;top:0;left:0;z-index:-1;width:512px;height:320px;box-shadow:0 0 30px rgba(0,0,0,.005),0 20px 50px rgba(42,43,45,.6);border-radius:2px;content:'';-webkit-transform-origin:0 0;-ms-transform-origin:0 0;transform-origin:0 0;-webkit-transform:scale(2);-ms-transform:scale(2);transform:scale(2)}}@media screen and (max-width:1324px){.shower.list .slide:before{width:256px;height:160px;-webkit-transform:scale(4);-ms-transform:scale(4);transform:scale(4)}}@media screen{.shower.list .slide:after{top:auto;right:auto;bottom:-80px;left:120px;padding:0;width:auto;height:auto;background:0 0;color:#3c3d40;text-shadow:0 1px 1px #8d8e90;font-weight:700;-webkit-transform-origin:0 0;-ms-transform-origin:0 0;transform-origin:0 0;-webkit-transform:scale(2);-ms-transform:scale(2);transform:scale(2)}}@media screen and (max-width:1324px){.shower.list .slide:after{bottom:-104px;-webkit-transform:scale(4);-ms-transform:scale(4);transform:scale(4)}}@media screen{.shower.list .slide:hover:before{box-shadow:0 0 0 10px rgba(42,43,45,.3),0 20px 50px rgba(42,43,45,.6)}.shower.list .slide:target:before{box-shadow:0 0 0 1px #376da3,0 0 0 10px #4b86c2,0 20px 50px rgba(42,43,45,.6)}}@media screen and (max-width:1324px){.shower.list .slide:target:before{box-shadow:0 0 0 1px #376da3,0 0 0 10px #4b86c2,0 20px 50px rgba(42,43,45,.6)}}@media screen{.shower.list .slide:target:after{text-shadow:0 1px 1px rgba(42,43,45,.6);color:#4b86c2}.shower.list .slide&gt;div:before{position:absolute;top:0;right:0;bottom:0;left:0;z-index:2;content:''}.shower.list .slide.cover:after,.shower.list .slide.shout:after{visibility:visible}.shower.list .slide footer{display:block}.shower.full{position:absolute;top:50%;left:50%;overflow:hidden;margin:-320px 0 0 -512px;width:1024px;height:640px;background:#000}.shower.full.debug:after{position:absolute;top:0;right:0;bottom:0;left:0;z-index:2;background:url(../images/grid-16x10.svg) no-repeat;content:''}.shower.full .region{position:absolute;clip:rect(0 0 0 0);overflow:hidden;margin:-1px;padding:0;width:1px;height:1px;border:none;display:block}.shower.full .slide{position:absolute;top:0;left:0;margin-left:150%}.shower.full .slide .next{visibility:hidden}.shower.full .slide .next.active{visibility:visible}.shower.full .slide:target{margin:0}.shower.full .slide.shout.grow h2,.shower.full .slide.shout.shrink h2{opacity:0;-webkit-transition:all .4s ease-out;transition:all .4s ease-out}.shower.full .slide.shout.grow:target h2,.shower.full .slide.shout.shrink:target h2{opacity:1;-webkit-transform:scale(1) translateY(-50%);-ms-transform:scale(1) translateY(-50%);transform:scale(1) translateY(-50%)}.shower.full .slide.shout.grow h2{-webkit-transform:scale(.1) translateY(-50%);-ms-transform:scale(.1) translateY(-50%);transform:scale(.1) translateY(-50%)}.shower.full .slide.shout.shrink h2{-webkit-transform:scale(10) translateY(-50%);-ms-transform:scale(10) translateY(-50%);transform:scale(10) translateY(-50%)}.shower.full .progress{position:absolute;left:-20px;bottom:0;z-index:1;width:0;height:0;box-sizing:content-box;border:10px solid #4b86c2;border-right-color:transparent;-webkit-transition:width .2s linear;transition:width .2s linear;clip:rect(10px,1044px,20px,20px)}.shower.full .progress[style*='100%']{padding-left:10px}}@page{margin:0;size:1024px 640px}</span>
<span style="color: #00cd00;">&lt;/style&gt;</span>
<span style="color: #00cd00;">&lt;style&gt;</span>
<span style="color: #00cd00;">#Cover h2 {</span>
<span style="color: #00cd00;">position:absolute;</span>
<span style="color: #00cd00;">top:50%;</span>
<span style="color: #00cd00;">right:-25%;</span>
<span style="color: #00cd00;">left:-25%;</span>
<span style="color: #00cd00;">margin:-1em 0 0;</span>
<span style="color: #00cd00;">padding:0.5em 0 0.55em;</span>
<span style="color: #00cd00;">background:rgba(255, 255, 234, 0.8);</span>
<span style="color: #00cd00;">color:#334445;</span>
<span style="color: #00cd00;">text-align:center;</span>
<span style="color: #00cd00;">font-size:100px;</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">#Cover .next {</span>
<span style="color: #00cd00;">opacity:0;</span>
<span style="color: #00cd00;">-webkit-transform-origin:50% 50%;</span>
<span style="color: #00cd00;">-webkit-transform:rotate(-20deg) scale(5);</span>
<span style="color: #00cd00;">    -webkit-transition:all 0.5s;</span>
<span style="color: #00cd00;">-moz-transform-origin:50% 50%;</span>
<span style="color: #00cd00;">-moz-transform:rotate(-20deg) scale(5);</span>
<span style="color: #00cd00;">    -moz-transition:all 0.5s;</span>
<span style="color: #00cd00;">-o-transform-origin:50% 50%;</span>
<span style="color: #00cd00;">-o-transform:rotate(-20deg) scale(5);</span>
<span style="color: #00cd00;">    -o-transition:all 0.5s;</span>
<span style="color: #00cd00;">transform-origin:50% 50%;</span>
<span style="color: #00cd00;">transform:rotate(-20deg) scale(5);</span>
<span style="color: #00cd00;">    transition:all 0.5s;</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">#Cover .next.active {</span>
<span style="color: #00cd00;">opacity:1;</span>
<span style="color: #00cd00;">-webkit-transform:rotate(-20deg) scale(1);</span>
<span style="color: #00cd00;">-moz-transform:rotate(-20deg) scale(1);</span>
<span style="color: #00cd00;">-o-transform:rotate(-20deg) scale(1);</span>
<span style="color: #00cd00;">transform:rotate(-20deg) scale(1);</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">#Check img {</span>
<span style="color: #00cd00;">width:115px;</span>
<span style="color: #00cd00;">vertical-align:-4%;</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">#Zoidberg {</span>
<span style="color: #00cd00;">background:#FFF url(pictures/zoidberg.png) 50% 100% no-repeat;</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">#Zoidberg h2 {</span>
<span style="color: #00cd00;">margin-top:-120px;</span>
<span style="color: #00cd00;">font-size:90px;</span>
<span style="color: #00cd00;">}</span>
<span style="color: #00cd00;">&lt;/style&gt;</span>
<span style="color: #00cd00;">&lt;link rel=\"stylesheet\" href=\"index.css\"&gt;</span>
<span style="color: #00cd00;">&lt;/head&gt;</span>
<span style="color: #00cd00;">&lt;body class=\"shower list\"&gt;</span>
<span style="color: #00cd00;">&lt;header class=\"caption\"&gt;</span>
<span style="color: #00cd00;">&lt;h1&gt;Flexbox, &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086;&lt;/h1&gt;</span>
<span style="color: #00cd00;">&lt;p&gt;&lt;a href=\"http://pepelsbey.net/\"&gt;&#1042;&#1072;&#1076;&#1080;&#1084; &#1052;&#1072;&#1082;&#1077;&#1077;&#1074;&lt;/a&gt;, &lt;a href=\"http://opera.com\"&gt;Opera Software&lt;/a&gt;&lt;/p&gt;</span>
<span style="color: #00cd00;">&lt;/header&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\" id=\"Cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2 class=\"next\"&gt;Flexbox, &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/specs.png\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\" id=\"Check\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&lt;img src=\"pictures/check.svg\" alt=\"\"&gt; 68,51%&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2 style=\"font-size:90px\"&gt;&#1055;&#1077;&#1088;&#1074;&#1072;&#1103; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1072; &#1088;&#1072;&#1089;&#1082;&#1083;&#1072;&#1076;&#1082;&#1080;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1085;&#1077; &#1093;&#1072;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;prozrachniy.gif&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&amp;lt;br clear=all&amp;gt;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2 style=\"font-size:130px\"&gt;&lt;a href=\"http://www.w3.org/TR/2009/WD-css3-flexbox-20090723/\" target=\"_blank\"&gt;F09&lt;/a&gt; &#8227; &lt;a href=\"http://www.w3.org/TR/2012/WD-css3-flexbox-20120322/\" target=\"_blank\"&gt;F11&lt;/a&gt; &#8227; &lt;a href=\"http://www.w3.org/TR/css3-flexbox/\" target=\"_blank\"&gt;F12&lt;/a&gt;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-olympic.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox 09&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-09-desktop.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox 09&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-09-mobile.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox 11&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-11.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox 12&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-12.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox 12&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/browsers-12-up.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1057;&#1086;&#1073;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-container.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1054;&#1089;&#1080;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1088;&#1080;&#1074;&#1099;&#1095;&#1085;&#1099;&#1081; CSS&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;top&lt;/mark&gt;:0; &lt;mark class=\"comment\"&gt;/* &#1089;&#1074;&#1077;&#1088;&#1093;&#1091; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;bottom&lt;/mark&gt;:0; &lt;mark class=\"comment\"&gt;/* &#1089;&#1085;&#1080;&#1079;&#1091; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;text-align&lt;/mark&gt;:center; &lt;mark class=\"comment\"&gt;/* &#1075;&#1086;&#1088;&#1080;&#1079;&#1086;&#1085;&#1090;&#1072;&#1083;&#1100;&#1085;&#1086; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;vertical-align&lt;/mark&gt;:middle; &lt;mark class=\"comment\"&gt;/* &#1074;&#1077;&#1088;&#1090;&#1080;&#1082;&#1072;&#1083;&#1100;&#1085;&#1086; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&lt;span style=\"border-bottom:solid 0.13em\"&gt;&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103;&lt;/span&gt;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&lt;span style=\"border-bottom:dotted 0.13em\"&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1077;&#1095;&#1085;&#1072;&#1103;&lt;/span&gt;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-arrow.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-bones.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-column.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-column-arrow.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-column-bones.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1091;&#1096;&#1082;&#1080;&#1085;. &#1047;&#1080;&#1084;&#1085;&#1080;&#1081; &#1074;&#1077;&#1095;&#1077;&#1088;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1091;&#1096;&#1082;&#1080;&#1085;. &#1047;&#1080;&#1084;&#1085;&#1080;&#1081; &#1074;&#1077;&#1095;&#1077;&#1088;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;&amp;lt;div class=\"&lt;mark&gt;poem&lt;/mark&gt;\"&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;&amp;lt;div&amp;gt;&lt;/mark&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&amp;lt;/div&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;&amp;lt;div&amp;gt;&lt;/mark&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&amp;lt;/div&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;&amp;lt;div&amp;gt;&lt;/mark&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&amp;lt;/div&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;&amp;lt;div&amp;gt;&lt;/mark&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&amp;lt;/div&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;&amp;lt;/div&amp;gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1091;&#1096;&#1082;&#1080;&#1085;. &#1047;&#1080;&#1084;&#1085;&#1080;&#1081; &#1074;&#1077;&#1095;&#1077;&#1088;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;&lt;mark&gt;.poem&lt;/mark&gt; {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    overflow:hidden;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    height:&lt;mark&gt;640px&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    .poem &lt;mark&gt;div&lt;/mark&gt; {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;        float:left;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;        }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1091;&#1096;&#1082;&#1080;&#1085;. &#1047;&#1080;&#1084;&#1085;&#1080;&#1081; &#1074;&#1077;&#1095;&#1077;&#1088;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div&lt;mark&gt;:first-child&lt;/mark&gt; {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    background:&lt;span style=\"color:#090\"&gt;#090&lt;/span&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div&lt;mark&gt;:last-child&lt;/mark&gt; {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    background:&lt;span style=\"color:#C00\"&gt;#C00&lt;/span&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;display:flex;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex axis-right\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1077;&#1085;&#1103;&#1077;&#1084; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1086;&#1089;&#1080;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-direction:&lt;mark&gt;row&lt;/mark&gt;; &lt;mark class=\"comment\"&gt;/* &#1087;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-direction:&lt;mark&gt;row-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex row-reverse axis-left\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1074;&#1086;&#1088;&#1072;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1072;&#1084;&#1091; &#1086;&#1089;&#1100;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-direction:&lt;mark&gt;column&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex column axis-down\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1077;&#1085;&#1103;&#1077;&#1084; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1086;&#1089;&#1080;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-direction:&lt;mark&gt;column-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex column-reverse axis-up\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1064;&#1090;&#1086;?&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-bones.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-bones-reverse.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    justify-content:&lt;mark&gt;flex-start&lt;/mark&gt;; &lt;mark class=\"comment\"&gt;/* &#1087;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    justify-content:&lt;mark&gt;flex-end&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-end\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100; &#1087;&#1086;&#1089;&#1077;&#1088;&#1077;&#1076;&#1080;&#1085;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;justify-content:center;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-center\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100; &#1088;&#1072;&#1074;&#1085;&#1086;&#1084;&#1077;&#1088;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;justify-content:space-between;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100; &#1082;&#1088;&#1072;&#1089;&#1080;&#1074;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;justify-content:space-around;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-around\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1077;&#1088;&#1077;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1082;&#1072;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between order\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1088;&#1103;&#1076;&#1086;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;2&lt;/mark&gt;) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;order:1;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between order order-2nd-1\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1088;&#1103;&#1076;&#1086;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;order:4;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between order order-all-4\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1088;&#1103;&#1076;&#1086;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;1&lt;/mark&gt;) { &lt;mark&gt;order:2&lt;/mark&gt; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;2&lt;/mark&gt;) { &lt;mark&gt;order:1&lt;/mark&gt; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;3&lt;/mark&gt;) { &lt;mark&gt;order:4&lt;/mark&gt; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;4&lt;/mark&gt;) { &lt;mark&gt;order:3&lt;/mark&gt; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between order order-arranged\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover w\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/welcome.jpg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-bones.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1044;&#1072;&#1105;&#1084; &#1074;&#1099;&#1089;&#1086;&#1090;&#1091;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;height:250px;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between align-items-height\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082; &#1074;&#1085;&#1080;&#1079;&#1091;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-items:&lt;mark&gt;flex-start&lt;/mark&gt;; &lt;mark class=\"comment\"&gt;/* &#1087;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-items:&lt;mark&gt;flex-end&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between align-items-height align-items-end\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082; &#1087;&#1086;&#1089;&#1077;&#1088;&#1077;&#1076;&#1080;&#1085;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-items:&lt;mark&gt;center&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between align-items-height align-items-center\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082; &#1080;&#1085;&#1076;&#1080;&#1074;&#1080;&#1076;&#1091;&#1072;&#1083;&#1100;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem &lt;mark&gt;div&lt;/mark&gt;:nth-child(&lt;mark class=\"important\"&gt;1&lt;/mark&gt;) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-self:&lt;mark&gt;flex-start&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem &lt;mark&gt;div&lt;/mark&gt;:nth-child(&lt;mark class=\"important\"&gt;4&lt;/mark&gt;) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-self:&lt;mark&gt;flex-end&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex justify-between align-items-height align-items-center align-items-start-end\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex margin\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1062;&#1077;&#1085;&#1090;&#1088;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;display:flex;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;margin:auto;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1056;&#1072;&#1089;&#1090;&#1103;&#1075;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1056;&#1072;&#1089;&#1090;&#1103;&#1075;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-grow:1;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex grow width-play\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1056;&#1072;&#1089;&#1090;&#1103;&#1075;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-grow:1;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;1&lt;/mark&gt;) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-grow:4;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex grow grow-1st-4 width-play\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1057;&#1078;&#1072;&#1090;&#1080;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;width:25%;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(1) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-shrink:4;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex shrink width-play\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1047;&#1072;&#1087;&#1072;&#1089;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-grow:1;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem div:nth-child(&lt;mark class=\"important\"&gt;1&lt;/mark&gt;) {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;flex-basis:250px;&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex grow basis width-play\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#215;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1077;&#1089;&#1100; &#1055;&#1091;&#1096;&#1082;&#1080;&#1085;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1085;&#1086;&#1075;&#1086;&#1089;&#1090;&#1088;&#1086;&#1095;&#1085;&#1099;&#1081; Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1077;&#1088;&#1077;&#1085;&#1086;&#1089;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-wrap:&lt;mark&gt;nowrap&lt;/mark&gt;; &lt;mark class=\"comment\"&gt;/* &#1087;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-wrap:&lt;mark&gt;wrap&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1077;&#1088;&#1077;&#1085;&#1086;&#1089; &#1085;&#1072;&#1086;&#1073;&#1086;&#1088;&#1086;&#1090;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex-wrap:&lt;mark&gt;wrap-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap-reverse\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap grow width-play\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/axis-row-bones.svg\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1088;&#1103;&#1076;&#1086;&#1082; &#1087;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;.poem {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-content:&lt;mark&gt;stretch&lt;/mark&gt;; &lt;mark class=\"comment\"&gt;/* &#1087;&#1086; &#1091;&#1084;&#1086;&#1083;&#1095;&#1072;&#1085;&#1080;&#1102; */&lt;/mark&gt;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    align-content:&lt;mark&gt;center&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;p class=\"note\"&gt;&#1058;&#1086;&#1083;&#1100;&#1082;&#1086; &#1076;&#1083;&#1103; &#1084;&#1085;&#1086;&#1075;&#1086;&#1089;&#1090;&#1088;&#1086;&#1095;&#1085;&#1099;&#1093; &#1073;&#1083;&#1086;&#1082;&#1086;&#1074;!&lt;/p&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap grow align-content-center\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap grow align-content-between\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap grow align-content-start\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"poem flex wrap grow align-content-end\"&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1073;&#1091;&#1088;&#1103; &#1084;&#1075;&#1083;&#1086;&#1102;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1085;&#1077;&#1073;&#1086; &#1082;&#1088;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1080;&#1093;&#1088;&#1080; &#1089;&#1085;&#1077;&#1078;&#1085;&#1099;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1088;&#1091;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1079;&#1074;&#1077;&#1088;&#1100;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1085;&#1072;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1074;&#1086;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1079;&#1072;&#1087;&#1083;&#1072;&#1095;&#1077;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082;&#1072;&#1082; &#1076;&#1080;&#1090;&#1103;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1087;&#1086; &#1082;&#1088;&#1086;&#1074;&#1083;&#1077;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1086;&#1073;&#1074;&#1077;&#1090;&#1096;&#1072;&#1083;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1074;&#1076;&#1088;&#1091;&#1075; &#1089;&#1086;&#1083;&#1086;&#1084;&#1086;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1096;&#1091;&#1084;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1090;&#1086; &#1082;&#1072;&#1082;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1087;&#1091;&#1090;&#1085;&#1080;&#1082; &#1079;&#1072;&#1087;&#1086;&#1079;&#1076;&#1072;&#1083;&#1099;&#1081;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1082; &#1085;&#1072;&#1084; &#1074; &#1086;&#1082;&#1086;&#1096;&#1082;&#1086;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;div&gt;&#1079;&#1072;&#1089;&#1090;&#1091;&#1095;&#1080;&#1090;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\" id=\"Zoidberg\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1052;&#1085;&#1086;&#1075;&#1086;&#1089;&#1090;&#1088;&#1086;&#1095;&#1085;&#1099;&#1081; Flexbox &#1074; Firefox?&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2 style=\"font-size:120px\"&gt;&#1060;&#1086;&#1083;&#1073;&#1077;&#1082;&#1080; &#1085;&#1072; &#1089;&#1090;&#1072;&#1088;&#1099;&#1081; Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; Flexbox&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:&lt;mark&gt;-webkit-box&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:-moz-box;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:&lt;mark&gt;-ms-flexbox&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:&lt;mark&gt;-webkit-flex&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    display:flex;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1056;&#1072;&#1089;&#1090;&#1103;&#1075;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1073;&#1083;&#1086;&#1082;&#1086;&#1074;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-box-flex&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -moz-box-flex:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-ms-flex&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-flex&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    flex:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1088;&#1103;&#1084;&#1072;&#1103; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1072;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E { -webkit-box-orient:&lt;mark&gt;vertical&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;       -moz-box-orient:vertical;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;        -ms-flex-direction:&lt;mark&gt;column&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -webkit-flex-direction:&lt;mark&gt;column&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;            flex-direction:column; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1054;&#1073;&#1088;&#1072;&#1090;&#1085;&#1072;&#1103; &#1082;&#1086;&#1083;&#1086;&#1085;&#1082;&#1072;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E { -webkit-box-orient:&lt;mark&gt;vertical&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -webkit-box-direction:&lt;mark&gt;reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;       -moz-box-orient:vertical;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;       -moz-box-direction:reverse;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;        -ms-flex-direction:&lt;mark&gt;column-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -webkit-flex-direction:&lt;mark&gt;column-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;            flex-direction:column-reverse; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1054;&#1073;&#1088;&#1072;&#1090;&#1085;&#1099;&#1081; &#1088;&#1103;&#1076;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E { -webkit-box-orient:&lt;mark&gt;horizontal&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -webkit-box-direction:&lt;mark&gt;reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;       -moz-box-orient:horizontal;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;       -moz-box-direction:reverse;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;        -ms-flex-direction:&lt;mark&gt;row-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -webkit-flex-direction:&lt;mark&gt;row-reverse&lt;/mark&gt;;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;            flex-direction:row-reverse; }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1042;&#1076;&#1086;&#1083;&#1100; &#1088;&#1072;&#1074;&#1085;&#1086;&#1084;&#1077;&#1088;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-box-pack&lt;/mark&gt;:justify;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -moz-box-pack:justify;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-ms-flex-pack&lt;/mark&gt;:justify;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-justify-content&lt;/mark&gt;:space-between;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    justify-content:space-between;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1086;&#1087;&#1077;&#1088;&#1105;&#1082; &#1087;&#1086;&#1089;&#1077;&#1088;&#1077;&#1076;&#1080;&#1085;&#1077;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-box-align&lt;/mark&gt;:center;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -moz-box-align:center;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-ms-flex-align&lt;/mark&gt;:center;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-align-items&lt;/mark&gt;:center;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1055;&#1077;&#1088;&#1077;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1082;&#1072;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;pre&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;E {&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-box-ordinal-group&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    -moz-box-ordinal-group:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-ms-flex-order&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    &lt;mark&gt;-webkit-order&lt;/mark&gt;:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    order:1;&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;code&gt;    }&lt;/code&gt;</span>
<span style="color: #00cd00;">&lt;/pre&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide cover w\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/gotcha.gif\" alt=\"\"&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&#1063;&#1080;&#1090;&#1072;&#1090;&#1100;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;ul&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://caniuse.com/flexbox\"&gt;&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072; Flexbox &#1074; &#1073;&#1088;&#1072;&#1091;&#1079;&#1077;&#1088;&#1072;&#1093;&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://wiki.csswg.org/spec/flexbox-2009-2011-spec-property-mapping\"&gt;&#1058;&#1072;&#1073;&#1083;&#1080;&#1094;&#1072; &#1089;&#1086;&#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1080;&#1103; F09 &#1080; F11&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://zomigi.com/blog/flexbox-syntax-for-ie-10/\"&gt;&#1058;&#1072;&#1073;&#1083;&#1080;&#1094;&#1072; &#1089;&#1086;&#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1080;&#1103; F09 &#1080; F11 &#1076;&#1083;&#1103; IE10&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://bennettfeely.com/flexplorer/\"&gt;CSS3 Flexplorer&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"https://developer.mozilla.org/en-US/docs/CSS/Using_CSS_flexible_boxes\"&gt;&#1048;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; Flexbox &#1086;&#1090; Mozilla&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://msdn.microsoft.com/en-us/library/ie/hh673531(v=vs.85).aspx\"&gt;&#1056;&#1091;&#1082;&#1086;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086; &#1087;&#1086; Flexbox &#1086;&#1090; Microsoft&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;/ul&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide\" id=\"ThankYou\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;Flexbox, &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1087;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;p&gt;&#1042;&#1072;&#1076;&#1080;&#1084; &#1052;&#1072;&#1082;&#1077;&#1077;&#1074;, Opera Software&lt;/p&gt;</span>
<span style="color: #00cd00;">&lt;ul&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://twitter.com/pepelsbey\"&gt;@pepelsbey&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"http://pepelsbey.net\"&gt;pepelsbey.net&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;li&gt;&lt;a href=\"mailto:pepelsbey@gmail.com\"&gt;pepelsbey@gmail.com&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #00cd00;">&lt;/ul&gt;</span>
<span style="color: #00cd00;">&lt;img src=\"pictures/flexo.png\" alt=\"\" class=\"place b r\" style=\"margin-right:70px\"&gt;</span>
<span style="color: #00cd00;">&lt;p&gt;&#1055;&#1088;&#1077;&#1079;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1103;: &lt;a href=\"http://pepelsbey.net/pres/flexbox-gotcha/\"&gt;pepelsbey.net/pres/flexbox-gotcha&lt;/a&gt;&lt;/p&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;section class=\"slide shout\"&gt;&lt;div&gt;</span>
<span style="color: #00cd00;">&lt;h2&gt;&lt;a href=\"http://sokr.me/fbx\"&gt;sokr.me/fbx&lt;/a&gt;&lt;/h2&gt;</span>
<span style="color: #00cd00;">&lt;/div&gt;&lt;/section&gt;</span>
<span style="color: #00cd00;">&lt;p class=\"badge\"&gt;&lt;a href=\"https://github.com/shower/shower\"&gt;Powered by Shower&lt;/a&gt;&lt;/p&gt;</span>
<span style="color: #00cd00;">&lt;div class=\"progress\"&gt;&lt;/div&gt;</span>
<span style="color: #00cd00;">&lt;script src=\"../shower/shower.min.js\"&gt;&lt;/script&gt;</span>
<span style="color: #00cd00;">&lt;!-- Copyright &#169; 2010&#8211;2014 Vadim Makeev &#8212; pepelsbey.net --&gt;</span>
<span style="color: #00cd00;">&lt;script&gt;(function(b,c,a){(c[a]=c[a]||[]).push(function(){try{c.yaCounter155532=new Ya.Metrika({id:155532})}catch(a){}});var e=b.getElementsByTagName('script')[0],d=b.createElement('script'),a=function(){e.parentNode.insertBefore(d,e)};d.async=!0;d.src='//mc.yandex.ru/metrika/watch.js';'[object Opera]'==c.opera?b.addEventListener('DOMContentLoaded',a):a()})(document,window,'yandex_metrika_callbacks');&lt;/script&gt;&lt;noscript&gt;&lt;img src=\"//mc.yandex.ru/watch/155532\" alt=\"\"&gt;&lt;/noscript&gt;</span>
<span style="color: #00cd00;">&lt;/body&gt;</span>
<span style="color: #00cd00;">&lt;/html&gt;"</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Тесты</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-lisp" id="hh_test"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; hh</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">hh-test</span> ()
  &lt;&lt;hh_test_contents&gt;&gt;
  (dbg <span style="color: #00cd00;">"passed: hh-test~%"</span>))
(hh-test)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_test_contents"></pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Точки входа</h2>
<div class="outline-text-2" id="text-7">
<p>
Соберем шаблоны:
</p>

<div class="org-src-container">

<pre class="src src-closure-template-html" id="hh_tpl"><span style="color: #cd0000;">// -*- mode: closure-template-html; fill-column: 140 -*-</span>
{<span style="color: #00cd00; font-weight: bold;">namespace</span> <span style="color: #0000ee; font-weight: bold;">hhtpl</span>}

&lt;&lt;<span style="color: #0000ee; font-weight: bold;">hhtpl_contents</span>&gt;&gt;
</pre>
</div>

<p>
Скомпилируем шаблоны при подготовке модуля
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_prepare">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084; &#1096;&#1072;&#1073;&#1083;&#1086;&#1085;</span>
(closure-template:compile-template
 <span style="color: #0000ee; font-weight: bold;">:common-lisp-backend</span>
 (pathname
  (concatenate 'string *base-path* <span style="color: #00cd00;">"mod/hh/hh-tpl.htm"</span>)))
</pre>
</div>

<p>
Соберем контроллеры и все функции, которые контроллеры вызывают
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">special syntax for pattern-matching - ON</span>
(named-readtables:in-readtable <span style="color: #0000ee; font-weight: bold;">:fare-quasiquote</span>)

&lt;&lt;tree_match&gt;&gt;

&lt;&lt;run&gt;&gt;

&lt;&lt;run_response&gt;&gt;

&lt;&lt;hh_fn_contents&gt;&gt;

&lt;&lt;hh_test&gt;&gt;

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Pattern matching test</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "match_1: ~A" (match 1 (1 2)))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(dbg "match_2: ~A" (match '(1 2 3 4) (`(1 ,x ,@y) (list x y))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">special syntax for pattern-matching - OFF</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(named-readtables:in-readtable :standard)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Сборка</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Макроутилиты</h3>
<div class="outline-text-3" id="text-8-1">
<p>
[TODO] - Применение макросов отсюда:
<a href="https://github.com/magnars/dash.el/blob/master/dash.el#L1186">https://github.com/magnars/dash.el/blob/master/dash.el#L1186</a>
наверное существенно упростит код.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="todomacro"><span style="color: #cd0000;">;;; </span><span style="color: #cd0000;">dash.el --- A modern list library for Emacs  -*- lexical-binding: t -*-</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Copyright (C) 2012-2015 Free Software Foundation, Inc.</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Author: Magnar Sveen &lt;<a href="mailto:magnars&#64;gmail.com">magnars&#64;gmail.com</a>&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Version: 2.12.1</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Keywords: lists</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">This program is free software; you can redistribute it and/or modify</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">it under the terms of the GNU General Public License as published by</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">the Free Software Foundation, either version 3 of the License, or</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(at your option) any later version.</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">This program is distributed in the hope that it will be useful,</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">GNU General Public License for more details.</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">You should have received a copy of the GNU General Public License</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">along with this program.  If not, see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</span>

<span style="color: #cd0000;">;;; </span><span style="color: #cd0000;">Commentary:</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">A modern list api for Emacs.</span>
<span style="color: #cd0000;">;;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">See documentation on https://github.com/magnars/dash.el#functions</span>
<span style="color: #cd0000;">;;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">**Please note** The lexical binding in this file is not utilised at the</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">moment. We will take full advantage of lexical binding in an upcoming 3.0</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">release of Dash. In the meantime, we've added the pragma to avoid a bug that</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">you can read more about in https://github.com/magnars/dash.el/issues/130.</span>
<span style="color: #cd0000;">;;</span>

<span style="color: #cd0000;">;;; </span><span style="color: #cd0000;">Code:</span>

(<span style="color: #00cdcd; font-weight: bold;">defgroup</span> <span style="color: #00cd00;">dash</span> ()
  <span style="color: #00cd00;">"Customize group for dash.el"</span>
  <span style="color: #0000ee; font-weight: bold;">:group</span> 'lisp
  <span style="color: #0000ee; font-weight: bold;">:prefix</span> <span style="color: #00cd00;">"dash-"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--enable-fontlock</span> (symbol value)
  (<span style="color: #00cdcd; font-weight: bold;">when</span> value
    (dash-enable-font-lock))
  (set-default symbol value))

(<span style="color: #00cdcd; font-weight: bold;">defcustom</span> <span style="color: #cdcd00;">dash-enable-fontlock</span> nil
  <span style="color: #00cd00;">"If non-nil, enable fontification of dash functions, macros and</span>
<span style="color: #00cd00;">special values."</span>
  <span style="color: #0000ee; font-weight: bold;">:type</span> 'boolean
  <span style="color: #0000ee; font-weight: bold;">:set</span> 'dash--enable-fontlock
  <span style="color: #0000ee; font-weight: bold;">:group</span> 'dash)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">!cons</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">!cdr</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">--each</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-each</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">--map-when</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-map-when</span>

(put '-each 'lisp-indent-function 1)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--each-while</span> (list pred <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-each-while</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form body))
           (indent 2))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((l (make-symbol <span style="color: #00cd00;">"list"</span>))
        (c (make-symbol <span style="color: #00cd00;">"continue"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list)
           (,c t)
           (it-index 0))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> (and ,l ,c)
         (<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (car ,l)))
           (<span style="color: #00cdcd; font-weight: bold;">if</span> (not ,pred) (setq ,c nil) ,@body))
         (setq it-index (1+ it-index))
         (!cdr ,l)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-each-while</span> (list pred fn)
  <span style="color: #00cd00;">"Call FN with every item in LIST while (PRED item) is non-nil.</span>
<span style="color: #00cd00;">Return nil, used for side-effects only."</span>
  (--each-while list (funcall pred it) (funcall fn it)))

(put '-each-while 'lisp-indent-function 2)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--dotimes</span> (num <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Repeatedly executes BODY (presumably for side-effects) with `it` bound to integers from 0 through NUM-1."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form body))
           (indent 1))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (make-symbol <span style="color: #00cd00;">"num"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,n ,num)
           (it 0))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> (&lt; it ,n)
         ,@body
         (setq it (1+ it))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-dotimes</span> (num fn)
  <span style="color: #00cd00;">"Repeatedly calls FN (presumably for side-effects) passing in integers from 0 through NUM-1."</span>
  (--dotimes num (funcall fn it)))

(put '-dotimes 'lisp-indent-function 1)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map</span> (fn list)
  <span style="color: #00cd00;">"Return a new list consisting of the result of applying FN to the items in LIST."</span>
  (mapcar fn list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--reduce-from</span> (form initial-value list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-reduce-from</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((acc ,initial-value))
     (--each ,list (setq acc ,form))
     acc))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-reduce-from</span> (fn initial-value list)
  <span style="color: #00cd00;">"Return the result of applying FN to INITIAL-VALUE and the</span>
<span style="color: #00cd00;">first item in LIST, then applying FN to that result and the 2nd</span>
<span style="color: #00cd00;">item, etc. If LIST contains no items, return INITIAL-VALUE and</span>
<span style="color: #00cd00;">FN is not called.</span>

<span style="color: #00cd00;">In the anaphoric form `</span><span style="color: #cd00cd;">--reduce-from</span><span style="color: #00cd00;">', the accumulated value is</span>
<span style="color: #00cd00;">exposed as `acc`.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-reduce</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">'"</span>
  (--reduce-from (funcall fn acc it) initial-value list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--reduce</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-reduce</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lv (make-symbol <span style="color: #00cd00;">"list-value"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,lv ,list))
       (<span style="color: #00cdcd; font-weight: bold;">if</span> ,lv
           (--reduce-from ,form (car ,lv) (cdr ,lv))
           (<span style="color: #00cdcd; font-weight: bold;">let</span> (acc it) ,form)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-reduce</span> (fn list)
  <span style="color: #00cd00;">"Return the result of applying FN to the first 2 items in LIST,</span>
<span style="color: #00cd00;">then applying FN to that result and the 3rd item, etc. If LIST</span>
<span style="color: #00cd00;">contains no items, FN must accept no arguments as well, and</span>
<span style="color: #00cd00;">reduce return the result of calling FN with no arguments. If</span>
<span style="color: #00cd00;">LIST has only 1 item, it is returned and FN is not called.</span>

<span style="color: #00cd00;">In the anaphoric form `</span><span style="color: #cd00cd;">--reduce</span><span style="color: #00cd00;">', the accumulated value is</span>
<span style="color: #00cd00;">exposed as `acc`.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-reduce-from</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> list
      (-reduce-from fn (car list) (cdr list))
      (funcall fn)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-reduce-r-from</span> (fn initial-value list)
  <span style="color: #00cd00;">"Replace conses with FN, nil with INITIAL-VALUE and evaluate</span>
<span style="color: #00cd00;">the resulting expression. If LIST is empty, INITIAL-VALUE is</span>
<span style="color: #00cd00;">returned and FN is not called.</span>

<span style="color: #00cd00;">Note: this function works the same as `</span><span style="color: #cd00cd;">-reduce-from</span><span style="color: #00cd00;">' but the</span>
<span style="color: #00cd00;">operation associates from right instead of from left.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-reduce</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (not list) initial-value
      (funcall fn (car list) (-reduce-r-from fn initial-value (cdr list)))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--reduce-r-from</span> (form initial-value list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-reduce-r-from</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(-reduce-r-from (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (<span style="color: #00cd00;">&amp;optional</span> it acc) ,form) ,initial-value ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-reduce-r</span> (fn list)
  <span style="color: #00cd00;">"Replace conses with FN and evaluate the resulting expression.</span>
<span style="color: #00cd00;">The final nil is ignored. If LIST contains no items, FN must</span>
<span style="color: #00cd00;">accept no arguments as well, and reduce return the result of</span>
<span style="color: #00cd00;">calling FN with no arguments. If LIST has only 1 item, it is</span>
<span style="color: #00cd00;">returned and FN is not called.</span>

<span style="color: #00cd00;">The first argument of FN is the new item, the second is the</span>
<span style="color: #00cd00;">accumulated value.</span>

<span style="color: #00cd00;">Note: this function works the same as `</span><span style="color: #cd00cd;">-reduce</span><span style="color: #00cd00;">' but the operation</span>
<span style="color: #00cd00;">associates from right instead of from left.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-reduce-r-from</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-reduce</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not list) (funcall fn))
    ((not (cdr list)) (car list))
    (t (funcall fn (car list) (-reduce-r fn (cdr list))))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--reduce-r</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-reduce-r (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (<span style="color: #00cd00;">&amp;optional</span> it acc) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--filter</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-filter</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each ,list (<span style="color: #00cdcd; font-weight: bold;">when</span> ,form (!cons it ,r)))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-filter</span> (pred list)
  <span style="color: #00cd00;">"Return a new list of the items in LIST for which PRED returns a non-nil value.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-select</span><span style="color: #00cd00;">'"</span>
  (--filter (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-select</span> '-filter)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--select</span> '--filter)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--remove</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-remove</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(--filter (not ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove</span> (pred list)
  <span style="color: #00cd00;">"Return a new list of the items in LIST for which PRED returns nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-reject</span><span style="color: #00cd00;">'"</span>
  (--remove (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-reject</span> '-remove)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--reject</span> '--remove)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove-first</span> (pred list)
  <span style="color: #00cd00;">"Return a new list with the first item matching PRED removed.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-reject-first</span><span style="color: #00cd00;">'</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-remove</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-map-first</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (front)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (and list (not (funcall pred (car list))))
      (push (car list) front)
      (!cdr list))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> list
        (-concat (nreverse front) (cdr list))
        (nreverse front))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--remove-first</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-remove-first</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-remove-first (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-reject-first</span> '-remove-first)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--reject-first</span> '--remove-first)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove-last</span> (pred list)
  <span style="color: #00cd00;">"Return a new list with the last item matching PRED removed.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-reject-last</span><span style="color: #00cd00;">'</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-remove</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-map-last</span><span style="color: #00cd00;">'"</span>
  (nreverse (-remove-first pred (nreverse list))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--remove-last</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-remove-last</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-remove-last (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-reject-last</span> '-remove-last)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--reject-last</span> '--remove-last)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove-item</span> (item list)
  <span style="color: #00cd00;">"Remove all occurences of ITEM from LIST.</span>

<span style="color: #00cd00;">Comparison is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'."</span>
  (--remove (equal it item) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--keep</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-keep</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>))
        (m (make-symbol <span style="color: #00cd00;">"mapped"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each ,list (<span style="color: #00cdcd; font-weight: bold;">let</span> ((,m ,form)) (<span style="color: #00cdcd; font-weight: bold;">when</span> ,m (!cons ,m ,r))))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-keep</span> (fn list)
  <span style="color: #00cd00;">"Return a new list of the non-nil results of applying FN to the items in LIST.</span>

<span style="color: #00cd00;">If you want to select the original items satisfying a predicate use `</span><span style="color: #cd00cd;">-filter</span><span style="color: #00cd00;">'."</span>
  (--keep (funcall fn it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-non-nil</span> (list)
  <span style="color: #00cd00;">"Return all non-nil elements of LIST."</span>
  (-remove 'null list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map-indexed</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map-indexed</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each ,list
               (!cons ,form ,r))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map-indexed</span> (fn list)
  <span style="color: #00cd00;">"Return a new list consisting of the result of (FN index item) for each item in LIST.</span>

<span style="color: #00cd00;">In the anaphoric form `</span><span style="color: #cd00cd;">--map-indexed</span><span style="color: #00cd00;">', the index is exposed as `it-index`."</span>
  (--map-indexed (funcall fn it-index it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map-when</span> (pred rep list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map-when</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each ,list (!cons (<span style="color: #00cdcd; font-weight: bold;">if</span> ,pred ,rep it) ,r))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map-when</span> (pred rep list)
  <span style="color: #00cd00;">"Return a new list where the elements in LIST that does not match the PRED function</span>
<span style="color: #00cd00;">are unchanged, and where the elements in LIST that do match the PRED function are mapped</span>
<span style="color: #00cd00;">through the REP function.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-replace-where</span><span style="color: #00cd00;">'</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-update-at</span><span style="color: #00cd00;">'"</span>
  (--map-when (funcall pred it) (funcall rep it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-replace-where</span> '-map-when)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--replace-where</span> '--map-when)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map-first</span> (pred rep list)
  <span style="color: #00cd00;">"Replace first item in LIST satisfying PRED with result of REP called on this item.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-map-when</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-replace-first</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (front)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (and list (not (funcall pred (car list))))
      (push (car list) front)
      (!cdr list))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> list
        (-concat (nreverse front) (cons (funcall rep (car list)) (cdr list)))
        (nreverse front))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map-first</span> (pred rep list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map-first</span><span style="color: #00cd00;">'."</span>
  `(-map-first (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,pred) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) (ignore it) ,rep) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map-last</span> (pred rep list)
  <span style="color: #00cd00;">"Replace first item in LIST satisfying PRED with result of REP called on this item.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-map-when</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-replace-last</span><span style="color: #00cd00;">'"</span>
  (nreverse (-map-first pred rep (nreverse list))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map-last</span> (pred rep list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map-last</span><span style="color: #00cd00;">'."</span>
  `(-map-last (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,pred) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) (ignore it) ,rep) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-replace</span> (old new list)
  <span style="color: #00cd00;">"Replace all OLD items in LIST with NEW.</span>

<span style="color: #00cd00;">Elements are compared using `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-replace-at</span><span style="color: #00cd00;">'"</span>
  (--map-when (equal it old) new list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-replace-first</span> (old new list)
  <span style="color: #00cd00;">"Replace the first occurence of OLD with NEW in LIST.</span>

<span style="color: #00cd00;">Elements are compared using `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-map-first</span><span style="color: #00cd00;">'"</span>
  (--map-first (equal old it) new list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-replace-last</span> (old new list)
  <span style="color: #00cd00;">"Replace the last occurence of OLD with NEW in LIST.</span>

<span style="color: #00cd00;">Elements are compared using `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-map-last</span><span style="color: #00cd00;">'"</span>
  (--map-last (equal old it) new list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--mapcat</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-mapcat</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(apply 'append (--map ,form ,list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-mapcat</span> (fn list)
  <span style="color: #00cd00;">"Return the concatenation of the result of mapping FN over LIST.</span>
<span style="color: #00cd00;">Thus function FN should return a list."</span>
  (--mapcat (funcall fn it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-flatten</span> (l)
  <span style="color: #00cd00;">"Take a nested list L and return its contents as a single, flat list.</span>

<span style="color: #00cd00;">Note that because `</span><span style="color: #cd00cd;">nil</span><span style="color: #00cd00;">' represents a list of zero elements (an</span>
<span style="color: #00cd00;">empty list), any mention of nil in L will disappear after</span>
<span style="color: #00cd00;">flattening.  If you need to preserve nils, consider `</span><span style="color: #cd00cd;">-flatten-n</span><span style="color: #00cd00;">'</span>
<span style="color: #00cd00;">or map them to some unique symbol and then map them back.</span>

<span style="color: #00cd00;">Conses of two atoms are considered \"terminals\", that is, they</span>
<span style="color: #00cd00;">aren't flattened further.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-flatten-n</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (and (listp l) (listp (cdr l)))
      (-mapcat '-flatten l)
      (list l)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--iterate</span> (form init n)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-iterate</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(-iterate (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,init ,n))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-flatten-n</span> (num list)
  <span style="color: #00cd00;">"Flatten NUM levels of a nested LIST.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-flatten</span><span style="color: #00cd00;">'"</span>
  (-last-item (--iterate (--mapcat (-list it) it) list (1+ num))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-concat</span> (<span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Return a new list with the concatenation of the elements in the supplied LISTS."</span>
  (apply 'append lists))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-copy</span> 'copy-sequence
  <span style="color: #00cd00;">"Create a shallow copy of LIST."</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-splice</span> (pred fun list)
  <span style="color: #00cd00;">"Splice lists generated by FUN in place of elements matching PRED in LIST.</span>

<span style="color: #00cd00;">FUN takes the element matching PRED as input.</span>

<span style="color: #00cd00;">This function can be used as replacement for `,@' in case you</span>
<span style="color: #00cd00;">need to splice several lists at marked positions (for example</span>
<span style="color: #00cd00;">with keywords).</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-splice-list</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-insert-at</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (r)
    (--each list
            (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall pred it)
                (<span style="color: #00cdcd; font-weight: bold;">let</span> ((new (funcall fun it)))
                  (--each new (!cons it r)))
                (!cons it r)))
    (nreverse r)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--splice</span> (pred form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-splice</span><span style="color: #00cd00;">'."</span>
  `(-splice (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,pred) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-splice-list</span> (pred new-list list)
  <span style="color: #00cd00;">"Splice NEW-LIST in place of elements matching PRED in LIST.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-splice</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-insert-at</span><span style="color: #00cd00;">'"</span>
  (-splice pred (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (_) new-list) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--splice-list</span> (pred new-list list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-splice-list</span><span style="color: #00cd00;">'."</span>
  `(-splice-list (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,pred) ,new-list ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-cons*</span> (<span style="color: #00cd00;">&amp;rest</span> args)
  <span style="color: #00cd00;">"Make a new list from the elements of ARGS.</span>

<span style="color: #00cd00;">The last 2 members of ARGS are used as the final cons of the</span>
<span style="color: #00cd00;">result so if the final member of ARGS is not a list the result is</span>
<span style="color: #00cd00;">a dotted list."</span>
  (-reduce-r 'cons args))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-snoc</span> (list elem <span style="color: #00cd00;">&amp;rest</span> elements)
  <span style="color: #00cd00;">"Append ELEM to the end of the list.</span>

<span style="color: #00cd00;">This is like `</span><span style="color: #cd00cd;">cons</span><span style="color: #00cd00;">', but operates on the end of list.</span>

<span style="color: #00cd00;">If ELEMENTS is non nil, append these to the list as well."</span>
  (-concat list (list elem) elements))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--first</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-first</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (make-symbol <span style="color: #00cd00;">"needle"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,n)
       (--each-while ,list (not ,n)
                     (<span style="color: #00cdcd; font-weight: bold;">when</span> ,form (setq ,n it)))
       ,n)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-first</span> (pred list)
  <span style="color: #00cd00;">"Return the first x in LIST where (PRED x) is non-nil, else nil.</span>

<span style="color: #00cd00;">To get the first item in the list no questions asked, use `</span><span style="color: #cd00cd;">car</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-find</span><span style="color: #00cd00;">'"</span>
  (--first (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-find</span> '-first)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--find</span> '--first)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--some</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-some</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (make-symbol <span style="color: #00cd00;">"needle"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,n)
       (--each-while ,list (not ,n)
                     (setq ,n ,form))
       ,n)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-some</span> (pred list)
  <span style="color: #00cd00;">"Return (PRED x) for the first LIST item where (PRED x) is non-nil, else nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-any</span><span style="color: #00cd00;">'"</span>
  (--some (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-any</span> '-some)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--any</span> '--some)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--last</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-last</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (make-symbol <span style="color: #00cd00;">"needle"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,n)
       (--each ,list
               (<span style="color: #00cdcd; font-weight: bold;">when</span> ,form (setq ,n it)))
       ,n)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-last</span> (pred list)
  <span style="color: #00cd00;">"Return the last x in LIST where (PRED x) is non-nil, else nil."</span>
  (--last (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-first-item</span> 'car
  <span style="color: #00cd00;">"Return the first item of LIST, or nil on an empty list."</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-last-item</span> (list)
  <span style="color: #00cd00;">"Return the last item of LIST, or nil on an empty list."</span>
  (car (last list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-butlast</span> (list)
  <span style="color: #00cd00;">"Return a list of all items in list except for the last."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (cdr list)
      (!cons (car list) result)
      (!cdr list))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--count</span> (pred list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-count</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,r 0))
       (--each ,list (<span style="color: #00cdcd; font-weight: bold;">when</span> ,pred (setq ,r (1+ ,r))))
       ,r)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-count</span> (pred list)
  <span style="color: #00cd00;">"Counts the number of items in LIST where (PRED item) is non-nil."</span>
  (--count (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">---truthy?</span> (val)
  (not (null val)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--any?</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-any?</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(---truthy? (--first ,form ,list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-any?</span> (pred list)
  <span style="color: #00cd00;">"Return t if (PRED x) is non-nil for any x in LIST, else nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-any-p</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-some?</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-some-p</span><span style="color: #00cd00;">'"</span>
  (--any? (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-some?</span> '-any?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--some?</span> '--any?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-any-p</span> '-any?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--any-p</span> '--any?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-some-p</span> '-any?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--some-p</span> '--any?)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--all?</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-all?</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((a (make-symbol <span style="color: #00cd00;">"all"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,a t))
       (--each-while ,list ,a (setq ,a ,form))
       (---truthy? ,a))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-all?</span> (pred list)
  <span style="color: #00cd00;">"Return t if (PRED x) is non-nil for all x in LIST, else nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-all-p</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-every?</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-every-p</span><span style="color: #00cd00;">'"</span>
  (--all? (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-every?</span> '-all?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--every?</span> '--all?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-all-p</span> '-all?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--all-p</span> '--all?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-every-p</span> '-all?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--every-p</span> '--all?)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--none?</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-none?</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(--all? (not ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-none?</span> (pred list)
  <span style="color: #00cd00;">"Return t if (PRED x) is nil for all x in LIST, else nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-none-p</span><span style="color: #00cd00;">'"</span>
  (--none? (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-none-p</span> '-none?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--none-p</span> '--none?)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--only-some?</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-only-some?</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((y (make-symbol <span style="color: #00cd00;">"yes"</span>))
        (n (make-symbol <span style="color: #00cd00;">"no"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,y ,n)
       (--each-while ,list (not (and ,y ,n))
                     (<span style="color: #00cdcd; font-weight: bold;">if</span> ,form (setq ,y t) (setq ,n t)))
       (---truthy? (and ,y ,n)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-only-some?</span> (pred list)
  <span style="color: #00cd00;">"Return `t` if at least one item of LIST matches PRED and at least one item of LIST does not match PRED.</span>
<span style="color: #00cd00;">Return `nil` both if all items match the predicate or if none of the items match the predicate.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-only-some-p</span><span style="color: #00cd00;">'"</span>
  (--only-some? (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-only-some-p</span> '-only-some?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">--only-some-p</span> '--only-some?)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-slice</span> (list from <span style="color: #00cd00;">&amp;optional</span> to step)
  <span style="color: #00cd00;">"Return copy of LIST, starting from index FROM to index TO.</span>

<span style="color: #00cd00;">FROM or TO may be negative.  These values are then interpreted</span>
<span style="color: #00cd00;">modulo the length of the list.</span>

<span style="color: #00cd00;">If STEP is a number, only each STEPth item in the resulting</span>
<span style="color: #00cd00;">section is returned.  Defaults to 1."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((length (length list))
        (new-list nil))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">to defaults to the end of the list</span>
    (setq to (or to length))
    (setq step (or step 1))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">handle negative indices</span>
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (&lt; from 0)
      (setq from (mod from length)))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> (&lt; to 0)
      (setq to (mod to length)))

    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">iterate through the list, keeping the elements we want</span>
    (--each-while list (&lt; it-index to)
                  (<span style="color: #00cdcd; font-weight: bold;">when</span> (and (&gt;= it-index from)
                             (= (mod (- from it-index) step) 0))
                    (push it new-list)))
    (nreverse new-list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-take</span> (n list)
  <span style="color: #00cd00;">"Return a new list of the first N items in LIST, or all items if there are fewer than N."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (--dotimes n
               (<span style="color: #00cdcd; font-weight: bold;">when</span> list
                 (!cons (car list) result)
                 (!cdr list)))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-drop</span> 'nthcdr <span style="color: #00cd00;">"Return the tail of LIST without the first N items."</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--take-while</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-take-while</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each-while ,list ,form (!cons it ,r))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-take-while</span> (pred list)
  <span style="color: #00cd00;">"Return a new list of successive items from LIST while (PRED item) returns a non-nil value."</span>
  (--take-while (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--drop-while</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-drop-while</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((l (make-symbol <span style="color: #00cd00;">"list"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> (and ,l (<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (car ,l))) ,form))
         (!cdr ,l))
       ,l)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-drop-while</span> (pred list)
  <span style="color: #00cd00;">"Return the tail of LIST starting from the first item for which (PRED item) returns nil."</span>
  (--drop-while (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-split-at</span> (n list)
  <span style="color: #00cd00;">"Return a list of ((-take N LIST) (-drop N LIST)), in no more than one pass through the list."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (--dotimes n
               (<span style="color: #00cdcd; font-weight: bold;">when</span> list
                 (!cons (car list) result)
                 (!cdr list)))
    (list (nreverse result) list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-rotate</span> (n list)
  <span style="color: #00cd00;">"Rotate LIST N places to the right.  With N negative, rotate to the left.</span>
<span style="color: #00cd00;">The time complexity is O(n)."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (&gt; n 0)
      (append (last list n) (butlast list n))
      (append (-drop (- n) list) (-take (- n) list))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-insert-at</span> (n x list)
  <span style="color: #00cd00;">"Return a list with X inserted into LIST at position N.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-splice</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-splice-list</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((split-list (-split-at n list)))
    (nconc (car split-list) (cons x (cadr split-list)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-replace-at</span> (n x list)
  <span style="color: #00cd00;">"Return a list with element at Nth position in LIST replaced with X.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-replace</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((split-list (-split-at n list)))
    (nconc (car split-list) (cons x (cdr (cadr split-list))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-update-at</span> (n func list)
  <span style="color: #00cd00;">"Return a list with element at Nth position in LIST replaced with `(func (nth n list))`.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-map-when</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((split-list (-split-at n list)))
    (nconc (car split-list) (cons (funcall func (car (cadr split-list))) (cdr (cadr split-list))))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--update-at</span> (n form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-update-at</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(-update-at ,n (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove-at</span> (n list)
  <span style="color: #00cd00;">"Return a list with element at Nth position in LIST removed.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-remove-at-indices</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-remove</span><span style="color: #00cd00;">'"</span>
  (-remove-at-indices (list n) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-remove-at-indices</span> (indices list)
  <span style="color: #00cd00;">"Return a list whose elements are elements from LIST without</span>
<span style="color: #00cd00;">elements selected as `(nth i list)` for all i</span>
<span style="color: #00cd00;">from INDICES.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-remove-at</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-remove</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((indices (-sort '&lt; indices))
         (diffs (cons (car indices) (-map '1- (-zip-with '- (cdr indices) indices))))
         r)
    (--each diffs
            (<span style="color: #00cdcd; font-weight: bold;">let</span> ((split (-split-at it list)))
              (!cons (car split) r)
              (setq list (cdr (cadr split)))))
    (!cons list r)
    (apply '-concat (nreverse r))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--split-with</span> (pred list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-split-with</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((l (make-symbol <span style="color: #00cd00;">"list"</span>))
        (r (make-symbol <span style="color: #00cd00;">"result"</span>))
        (c (make-symbol <span style="color: #00cd00;">"continue"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list)
           (,r nil)
           (,c t))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> (and ,l ,c)
         (<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (car ,l)))
           (<span style="color: #00cdcd; font-weight: bold;">if</span> (not ,pred)
               (setq ,c nil)
               (!cons it ,r)
               (!cdr ,l))))
       (list (nreverse ,r) ,l))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-split-with</span> (pred list)
  <span style="color: #00cd00;">"Return a list of ((-take-while PRED LIST) (-drop-while PRED LIST)), in no more than one pass through the list."</span>
  (--split-with (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-split-on</span> (item list)
  <span style="color: #00cd00;">"Split the LIST each time ITEM is found.</span>

<span style="color: #00cd00;">Unlike `</span><span style="color: #cd00cd;">-partition-by</span><span style="color: #00cd00;">', the ITEM is discarded from the results.</span>
<span style="color: #00cd00;">Empty lists are also removed from the result.</span>

<span style="color: #00cd00;">Comparison is done by `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">See also `</span><span style="color: #cd00cd;">-split-when</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-split-when (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) (equal it ,item)) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--split-when</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-split-when</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-split-when (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-split-when</span> (fn list)
  <span style="color: #00cd00;">"Split the LIST on each element where FN returns non-nil.</span>

<span style="color: #00cd00;">Unlike `</span><span style="color: #cd00cd;">-partition-by</span><span style="color: #00cd00;">', the \"matched\" element is discarded from</span>
<span style="color: #00cd00;">the results.  Empty lists are also removed from the result.</span>

<span style="color: #00cd00;">This function can be thought of as a generalization of</span>
<span style="color: #00cd00;">`</span><span style="color: #cd00cd;">split-string</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (r s)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> list
      (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (funcall fn (car list)))
          (push (car list) s)
          (<span style="color: #00cdcd; font-weight: bold;">when</span> s (push (nreverse s) r))
          (setq s nil))
      (!cdr list))
    (<span style="color: #00cdcd; font-weight: bold;">when</span> s (push (nreverse s) r))
    (nreverse r)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--separate</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-separate</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((y (make-symbol <span style="color: #00cd00;">"yes"</span>))
        (n (make-symbol <span style="color: #00cd00;">"no"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,y ,n)
       (--each ,list (<span style="color: #00cdcd; font-weight: bold;">if</span> ,form (!cons it ,y) (!cons it ,n)))
       (list (nreverse ,y) (nreverse ,n)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-separate</span> (pred list)
  <span style="color: #00cd00;">"Return a list of ((-filter PRED LIST) (-remove PRED LIST)), in one pass through the list."</span>
  (--separate (funcall pred it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">---partition-all-in-steps-reversed</span> (n step list)
  <span style="color: #00cd00;">"Private: Used by -partition-all-in-steps and -partition-in-steps."</span>
  (<span style="color: #00cdcd; font-weight: bold;">when</span> (&lt; step 1)
    (<span style="color: #cd0000; font-weight: bold;">error</span> <span style="color: #00cd00;">"Step must be a positive number, or you're looking at some juicy infinite loops."</span>))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result nil))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> list
      (!cons (-take n list) result)
      (setq list (-drop step list)))
    result))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition-all-in-steps</span> (n step list)
  <span style="color: #00cd00;">"Return a new list with the items in LIST grouped into N-sized sublists at offsets STEP apart.</span>
<span style="color: #00cd00;">The last groups may contain less than N items."</span>
  (nreverse (---partition-all-in-steps-reversed n step list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition-in-steps</span> (n step list)
  <span style="color: #00cd00;">"Return a new list with the items in LIST grouped into N-sized sublists at offsets STEP apart.</span>
<span style="color: #00cd00;">If there are not enough items to make the last group N-sized,</span>
<span style="color: #00cd00;">those items are discarded."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (---partition-all-in-steps-reversed n step list)))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (and result (&lt; (length (car result)) n))
      (!cdr result))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition-all</span> (n list)
  <span style="color: #00cd00;">"Return a new list with the items in LIST grouped into N-sized sublists.</span>
<span style="color: #00cd00;">The last group may contain less than N items."</span>
  (-partition-all-in-steps n n list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition</span> (n list)
  <span style="color: #00cd00;">"Return a new list with the items in LIST grouped into N-sized sublists.</span>
<span style="color: #00cd00;">If there are not enough items to make the last group N-sized,</span>
<span style="color: #00cd00;">those items are discarded."</span>
  (-partition-in-steps n n list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--partition-by</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-partition-by</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>))
        (s (make-symbol <span style="color: #00cd00;">"sublist"</span>))
        (v (make-symbol <span style="color: #00cd00;">"value"</span>))
        (n (make-symbol <span style="color: #00cd00;">"new-value"</span>))
        (l (make-symbol <span style="color: #00cd00;">"list"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list))
       (<span style="color: #00cdcd; font-weight: bold;">when</span> ,l
         (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((,r nil)
                (it (car ,l))
                (,s (list it))
                (,v ,form)
                (,l (cdr ,l)))
           (<span style="color: #00cdcd; font-weight: bold;">while</span> ,l
             (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((it (car ,l))
                    (,n ,form))
               (<span style="color: #00cdcd; font-weight: bold;">unless</span> (equal ,v ,n)
                 (!cons (nreverse ,s) ,r)
                 (setq ,s nil)
                 (setq ,v ,n))
               (!cons it ,s)
               (!cdr ,l)))
           (!cons (nreverse ,s) ,r)
           (nreverse ,r))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition-by</span> (fn list)
  <span style="color: #00cd00;">"Apply FN to each item in LIST, splitting it each time FN returns a new value."</span>
  (--partition-by (funcall fn it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--partition-by-header</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-partition-by-header</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>))
        (s (make-symbol <span style="color: #00cd00;">"sublist"</span>))
        (h (make-symbol <span style="color: #00cd00;">"header-value"</span>))
        (b (make-symbol <span style="color: #00cd00;">"seen-body?"</span>))
        (n (make-symbol <span style="color: #00cd00;">"new-value"</span>))
        (l (make-symbol <span style="color: #00cd00;">"list"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list))
       (<span style="color: #00cdcd; font-weight: bold;">when</span> ,l
         (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((,r nil)
                (it (car ,l))
                (,s (list it))
                (,h ,form)
                (,b nil)
                (,l (cdr ,l)))
           (<span style="color: #00cdcd; font-weight: bold;">while</span> ,l
             (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((it (car ,l))
                    (,n ,form))
               (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal ,h ,n)
                   (<span style="color: #00cdcd; font-weight: bold;">when</span> ,b
                     (!cons (nreverse ,s) ,r)
                     (setq ,s nil)
                     (setq ,b nil))
                   (setq ,b t))
               (!cons it ,s)
               (!cdr ,l)))
           (!cons (nreverse ,s) ,r)
           (nreverse ,r))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partition-by-header</span> (fn list)
  <span style="color: #00cd00;">"Apply FN to the first item in LIST. That is the header</span>
<span style="color: #00cd00;">value. Apply FN to each item in LIST, splitting it each time FN</span>
<span style="color: #00cd00;">returns the header value, but only after seeing at least one</span>
<span style="color: #00cd00;">other value (the body)."</span>
  (--partition-by-header (funcall fn it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--group-by</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-group-by</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug t))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (make-symbol <span style="color: #00cd00;">"n"</span>))
        (k (make-symbol <span style="color: #00cd00;">"k"</span>))
        (grp (make-symbol <span style="color: #00cd00;">"grp"</span>)))
    `(nreverse
      (-map
       (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (,n)
         (cons (car ,n)
               (nreverse (cdr ,n))))
       (--reduce-from
        (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((,k (,@form))
               (,grp (assoc ,k acc)))
          (<span style="color: #00cdcd; font-weight: bold;">if</span> ,grp
              (setcdr ,grp (cons it (cdr ,grp)))
              (push
               (list ,k it)
               acc))
          acc)
        nil ,list)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-group-by</span> (fn list)
  <span style="color: #00cd00;">"Separate LIST into an alist whose keys are FN applied to the</span>
<span style="color: #00cd00;">elements of LIST.  Keys are compared by `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'."</span>
  (--group-by (funcall fn it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-interpose</span> (sep list)
  <span style="color: #00cd00;">"Return a new list of all elements in LIST separated by SEP."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (<span style="color: #00cdcd; font-weight: bold;">when</span> list
      (!cons (car list) result)
      (!cdr list))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> list
      (setq result (cons (car list) (cons sep result)))
      (!cdr list))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-interleave</span> (<span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Return a new list of the first item in each list, then the second etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (-none? 'null lists)
      (--each lists (!cons (car it) result))
      (setq lists (-map 'cdr lists)))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--zip-with</span> (form list1 list2)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-zip-with</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">The elements in list1 is bound as `it`, the elements in list2 as `other`."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>))
        (l1 (make-symbol <span style="color: #00cd00;">"list1"</span>))
        (l2 (make-symbol <span style="color: #00cd00;">"list2"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,r nil)
           (,l1 ,list1)
           (,l2 ,list2))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> (and ,l1 ,l2)
         (<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (car ,l1))
               (other (car ,l2)))
           (!cons ,form ,r)
           (!cdr ,l1)
           (!cdr ,l2)))
       (nreverse ,r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-zip-with</span> (fn list1 list2)
  <span style="color: #00cd00;">"Zip the two lists LIST1 and LIST2 using a function FN.  This</span>
<span style="color: #00cd00;">function is applied pairwise taking as first argument element of</span>
<span style="color: #00cd00;">LIST1 and as second argument element of LIST2 at corresponding</span>
<span style="color: #00cd00;">position.</span>

<span style="color: #00cd00;">The anaphoric form `</span><span style="color: #cd00cd;">--zip-with</span><span style="color: #00cd00;">' binds the elements from LIST1 as `it`,</span>
<span style="color: #00cd00;">and the elements from LIST2 as `other`."</span>
  (--zip-with (funcall fn it other) list1 list2))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-zip</span> (<span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Zip LISTS together.  Group the head of each list, followed by the</span>
<span style="color: #00cd00;">second elements of each list, and so on. The lengths of the returned</span>
<span style="color: #00cd00;">groupings are equal to the length of the shortest input list.</span>

<span style="color: #00cd00;">If two lists are provided as arguments, return the groupings as a list</span>
<span style="color: #00cd00;">of cons cells. Otherwise, return the groupings as a list of lists.</span>

<span style="color: #00cd00;">Please note! This distinction is being removed in an upcoming 2.0</span>
<span style="color: #00cd00;">release of Dash. If you rely on this behavior, use -zip-pair instead."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (results)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (-none? 'null lists)
      (setq results (cons (mapcar 'car lists) results))
      (setq lists (mapcar 'cdr lists)))
    (setq results (nreverse results))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (= (length lists) 2)
        <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">to support backward compatability, return</span>
        <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">a cons cell if two lists were provided</span>
        (--map (cons (car it) (cadr it)) results)
        results)))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-zip-pair</span> '-zip)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-zip-fill</span> (fill-value <span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Zip LISTS, with FILL-VALUE padded onto the shorter lists. The</span>
<span style="color: #00cd00;">lengths of the returned groupings are equal to the length of the</span>
<span style="color: #00cd00;">longest input list."</span>
  (apply '-zip (apply '-pad (cons fill-value lists))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-cycle</span> (list)
  <span style="color: #00cd00;">"Return an infinite copy of LIST that will cycle through the</span>
<span style="color: #00cd00;">elements and repeat from the beginning."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((newlist (-map 'identity list)))
    (nconc newlist newlist)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-pad</span> (fill-value <span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Appends FILL-VALUE to the end of each list in LISTS such that they</span>
<span style="color: #00cd00;">will all have the same length."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((annotations (-annotate 'length lists))
         (n (-max (-map 'car annotations))))
    (--map (append (cdr it) (-repeat (- n (car it)) fill-value)) annotations)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-annotate</span> (fn list)
  <span style="color: #00cd00;">"Return a list of cons cells where each cell is FN applied to each</span>
<span style="color: #00cd00;">element of LIST paired with the unmodified element of LIST."</span>
  (-zip (-map fn list) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--annotate</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-annotate</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-annotate (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--table-carry</span> (lists restore-lists <span style="color: #00cd00;">&amp;optional</span> re)
  <span style="color: #00cd00;">"Helper for `</span><span style="color: #cd00cd;">-table</span><span style="color: #00cd00;">' and `</span><span style="color: #cd00cd;">-table-flat</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">If a list overflows, carry to the right and reset the list."</span>
  (<span style="color: #00cdcd; font-weight: bold;">while</span> (not (or (car lists)
                  (equal lists '(nil))))
    (setcar lists (car restore-lists))
    (pop (cadr lists))
    (!cdr lists)
    (!cdr restore-lists)
    (<span style="color: #00cdcd; font-weight: bold;">when</span> re
      (push (nreverse (car re)) (cadr re))
      (setcar re nil)
      (!cdr re))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-table</span> (fn <span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Compute outer product of LISTS using function FN.</span>

<span style="color: #00cd00;">The function FN should have the same arity as the number of</span>
<span style="color: #00cd00;">supplied lists.</span>

<span style="color: #00cd00;">The outer product is computed by applying fn to all possible</span>
<span style="color: #00cd00;">combinations created by taking one element from each list in</span>
<span style="color: #00cd00;">order.  The dimension of the result is (length lists).</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-table-flat</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((restore-lists (copy-sequence lists))
        (last-list (last lists))
        (re (make-list (length lists) nil)))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (car last-list)
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((item (apply fn (-map 'car lists))))
        (push item (car re))
        (setcar lists (cdar lists)) <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">silence byte compiler</span>
        (dash--table-carry lists restore-lists re)))
    (nreverse (car (last re)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-table-flat</span> (fn <span style="color: #00cd00;">&amp;rest</span> lists)
  <span style="color: #00cd00;">"Compute flat outer product of LISTS using function FN.</span>

<span style="color: #00cd00;">The function FN should have the same arity as the number of</span>
<span style="color: #00cd00;">supplied lists.</span>

<span style="color: #00cd00;">The outer product is computed by applying fn to all possible</span>
<span style="color: #00cd00;">combinations created by taking one element from each list in</span>
<span style="color: #00cd00;">order.  The results are flattened, ignoring the tensor structure</span>
<span style="color: #00cd00;">of the result.  This is equivalent to calling:</span>

<span style="color: #00cd00;">  (-flatten-n (1- (length lists)) (-table fn lists))</span>

<span style="color: #00cd00;">but the implementation here is much more efficient.</span>

<span style="color: #00cd00;">See also: `</span><span style="color: #cd00cd;">-flatten-n</span><span style="color: #00cd00;">', `</span><span style="color: #cd00cd;">-table</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">when</span> lists                           <span style="color: #cd0000;">;</span><span style="color: #cd0000;">Just in case.</span>
    (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((list1 (pop lists))
           (restore-lists (copy-sequence lists))
           (last-list (last lists))
           re)
      (<span style="color: #00cdcd; font-weight: bold;">while</span> (car last-list)
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((tail (-map #'car lists)))
          (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (head list1)
            (push (apply fn head tail) re)))
        (pop (car lists))
        (dash--table-carry lists restore-lists))
      (nreverse re))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-partial</span> (fn <span style="color: #00cd00;">&amp;rest</span> args)
  <span style="color: #00cd00;">"Take a function FN and fewer than the normal arguments to FN,</span>
<span style="color: #00cd00;">and return a fn that takes a variable number of additional ARGS.</span>
<span style="color: #00cd00;">When called, the returned function calls FN with ARGS first and</span>
<span style="color: #00cd00;">then additional args."</span>
  (apply 'apply-partially fn args))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-elem-index</span> (elem list)
  <span style="color: #00cd00;">"Return the index of the first element in the given LIST which</span>
<span style="color: #00cd00;">is equal to the query element ELEM, or nil if there is no</span>
<span style="color: #00cd00;">such element."</span>
  (car (-elem-indices elem list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-elem-indices</span> (elem list)
  <span style="color: #00cd00;">"Return the indices of all elements in LIST equal to the query</span>
<span style="color: #00cd00;">element ELEM, in ascending order."</span>
  (-find-indices (-partial 'equal elem) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-find-indices</span> (pred list)
  <span style="color: #00cd00;">"Return the indices of all elements in LIST satisfying the</span>
<span style="color: #00cd00;">predicate PRED, in ascending order."</span>
  (apply 'append (--map-indexed (<span style="color: #00cdcd; font-weight: bold;">when</span> (funcall pred it) (list it-index)) list)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--find-indices</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-find-indices</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-find-indices (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-find-index</span> (pred list)
  <span style="color: #00cd00;">"Take a predicate PRED and a LIST and return the index of the</span>
<span style="color: #00cd00;">first element in the list satisfying the predicate, or nil if</span>
<span style="color: #00cd00;">there is no such element."</span>
  (car (-find-indices pred list)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--find-index</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-find-index</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-find-index (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-find-last-index</span> (pred list)
  <span style="color: #00cd00;">"Take a predicate PRED and a LIST and return the index of the</span>
<span style="color: #00cd00;">last element in the list satisfying the predicate, or nil if</span>
<span style="color: #00cd00;">there is no such element."</span>
  (-last-item (-find-indices pred list)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--find-last-index</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-find-last-index</span><span style="color: #00cd00;">'."</span>
  `(-find-last-index (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-select-by-indices</span> (indices list)
  <span style="color: #00cd00;">"Return a list whose elements are elements from LIST selected</span>
<span style="color: #00cd00;">as `(nth i list)` for all i from INDICES."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (r)
    (--each indices
            (!cons (nth it list) r))
    (nreverse r)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-&gt;&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">--&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-some-&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-some-&gt;&gt;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-some--&gt;</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-grade-up</span> (comparator list)
  <span style="color: #00cd00;">"Grade elements of LIST using COMPARATOR relation, yielding a</span>
<span style="color: #00cd00;">permutation vector such that applying this permutation to LIST</span>
<span style="color: #00cd00;">sorts it in ascending order."</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">ugly hack to "fix" lack of lexical scope</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((comp `(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it other) (funcall ',comparator (car it) (car other)))))
    (-&gt;&gt; (--map-indexed (cons it it-index) list)
         (-sort comp)
         (-map 'cdr))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-grade-down</span> (comparator list)
  <span style="color: #00cd00;">"Grade elements of LIST using COMPARATOR relation, yielding a</span>
<span style="color: #00cd00;">permutation vector such that applying this permutation to LIST</span>
<span style="color: #00cd00;">sorts it in descending order."</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">ugly hack to "fix" lack of lexical scope</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((comp `(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it other) (funcall ',comparator (car other) (car it)))))
    (-&gt;&gt; (--map-indexed (cons it it-index) list)
         (-sort comp)
         (-map 'cdr))))

(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">dash--source-counter</span> 0
  <span style="color: #00cd00;">"Monotonic counter for generated symbols."</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-make-source-symbol</span> ()
  <span style="color: #00cd00;">"Generate a new dash-source symbol.</span>

<span style="color: #00cd00;">All returned symbols are guaranteed to be unique."</span>
  (<span style="color: #00cdcd; font-weight: bold;">prog1</span> (make-symbol (format <span style="color: #00cd00;">"--dash-source-%d--"</span> dash--source-counter))
    (setq dash--source-counter (1+ dash--source-counter))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-ignore-place-p</span> (symbol)
  <span style="color: #00cd00;">"Return non-nil if SYMBOL is a symbol and starts with _."</span>
  (and (symbolp symbol)
       (eq (aref (symbol-name symbol) 0) ?_)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-cons-skip-cdr</span> (skip-cdr source)
  <span style="color: #00cd00;">"Helper function generating idiomatic shifting code."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((= skip-cdr 0)
     `(pop ,source))
    (t
     `(<span style="color: #00cdcd; font-weight: bold;">prog1</span> ,(dash--match-cons-get-car skip-cdr source)
        (setq ,source ,(dash--match-cons-get-cdr (1+ skip-cdr) source))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-cons-get-car</span> (skip-cdr source)
  <span style="color: #00cd00;">"Helper function generating idiomatic code to get nth car."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((= skip-cdr 0)
     `(car ,source))
    ((= skip-cdr 1)
     `(cadr ,source))
    (t
     `(nth ,skip-cdr ,source))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-cons-get-cdr</span> (skip-cdr source)
  <span style="color: #00cd00;">"Helper function generating idiomatic code to get nth cdr."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((= skip-cdr 0)
     source)
    ((= skip-cdr 1)
     `(cdr ,source))
    (t
     `(nthcdr ,skip-cdr ,source))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-cons</span> (match-form source)
  <span style="color: #00cd00;">"Setup a cons matching environment and call the real matcher."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((s (dash--match-make-source-symbol))
        (n 0)
        (m match-form))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (and (consp m)
                (dash--match-ignore-place-p (car m)))
      (setq n (1+ n)) (!cdr m))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">when we only have one pattern in the list, we don't have to</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">create a temporary binding (--dash-source--) for the source</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">and just use the input directly</span>
      ((and (consp m)
            (not (cdr m)))
       (dash--match (car m) (dash--match-cons-get-car n source)))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">handle other special types</span>
      ((&gt; n 0)
       (dash--match m (dash--match-cons-get-cdr n source)))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">this is the only entry-point for dash--match-cons-1, that's</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">why we can't simply use the above branch, it would produce</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">infinite recursion</span>
      (t
       (cons (list s source) (dash--match-cons-1 match-form s))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-cons-1</span> (match-form source <span style="color: #00cd00;">&amp;optional</span> props)
  <span style="color: #00cd00;">"Match MATCH-FORM against SOURCE.</span>

<span style="color: #00cd00;">MATCH-FORM is a proper or improper list.  Each element of</span>
<span style="color: #00cd00;">MATCH-FORM is either a symbol, which gets bound to the respective</span>
<span style="color: #00cd00;">value in source or another match form which gets destructured</span>
<span style="color: #00cd00;">recursively.</span>

<span style="color: #00cd00;">If the cdr of last cons cell in the list is `</span><span style="color: #cd00cd;">nil</span><span style="color: #00cd00;">', matching stops</span>
<span style="color: #00cd00;">there.</span>

<span style="color: #00cd00;">SOURCE is a proper or improper list."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((skip-cdr (or (plist-get props <span style="color: #0000ee; font-weight: bold;">:skip-cdr</span>) 0)))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span>
      ((consp match-form)
       (<span style="color: #00cdcd; font-weight: bold;">cond</span>
         ((cdr match-form)
          (<span style="color: #00cdcd; font-weight: bold;">cond</span>
            ((and (symbolp (car match-form))
                  (memq (car match-form) '(<span style="color: #00cd00;">&amp;keys</span> <span style="color: #00cd00;">&amp;plist</span> <span style="color: #00cd00;">&amp;alist</span> <span style="color: #00cd00;">&amp;hash</span>)))
             (dash--match-kv match-form (dash--match-cons-get-cdr skip-cdr source)))
            ((dash--match-ignore-place-p (car match-form))
             (dash--match-cons-1 (cdr match-form) source
                                 (plist-put props <span style="color: #0000ee; font-weight: bold;">:skip-cdr</span> (1+ skip-cdr))))
            (t
             (-concat (dash--match (car match-form) (dash--match-cons-skip-cdr skip-cdr source))
                      (dash--match-cons-1 (cdr match-form) source)))))
         (t <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Last matching place, no need for shift</span>
          (dash--match (car match-form) (dash--match-cons-get-car skip-cdr source)))))
      ((eq match-form nil)
       nil)
      (t <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Handle improper lists.  Last matching place, no need for shift</span>
       (dash--match match-form (dash--match-cons-get-cdr skip-cdr source))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--vector-tail</span> (seq start)
  <span style="color: #00cd00;">"Return the tail of SEQ starting at START."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((vectorp seq)
     (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((re-length (- (length seq) start))
            (re (make-vector re-length 0)))
       (--dotimes re-length (aset re it (aref seq (+ it start))))
       re))
    ((stringp seq)
     (substring seq start))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-vector</span> (match-form source)
  <span style="color: #00cd00;">"Setup a vector matching environment and call the real matcher."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((s (dash--match-make-source-symbol)))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">don't bind `s' if we only have one sub-pattern</span>
      ((= (length match-form) 1)
       (dash--match (aref match-form 0) `(aref ,source 0)))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">if the source is a symbol, we don't need to re-bind it</span>
      ((symbolp source)
       (dash--match-vector-1 match-form source))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">don't bind `s' if we only have one sub-pattern which is not ignored</span>
      ((<span style="color: #00cdcd; font-weight: bold;">let*</span> ((ignored-places (mapcar 'dash--match-ignore-place-p match-form))
              (ignored-places-n (length (-remove 'null ignored-places))))
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (= ignored-places-n (1- (length match-form)))
           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((n (-find-index 'null ignored-places)))
             (dash--match (aref match-form n) `(aref ,source ,n))))))
      (t
       (cons (list s source) (dash--match-vector-1 match-form s))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-vector-1</span> (match-form source)
  <span style="color: #00cd00;">"Match MATCH-FORM against SOURCE.</span>

<span style="color: #00cd00;">MATCH-FORM is a vector.  Each element of MATCH-FORM is either a</span>
<span style="color: #00cd00;">symbol, which gets bound to the respective value in source or</span>
<span style="color: #00cd00;">another match form which gets destructured recursively.</span>

<span style="color: #00cd00;">If second-from-last place in MATCH-FORM is the symbol &amp;rest, the</span>
<span style="color: #00cd00;">next element of the MATCH-FORM is matched against the tail of</span>
<span style="color: #00cd00;">SOURCE, starting at index of the &amp;rest symbol.  This is</span>
<span style="color: #00cd00;">conceptually the same as the (head . tail) match for improper</span>
<span style="color: #00cd00;">lists, where dot plays the role of &amp;rest.</span>

<span style="color: #00cd00;">SOURCE is a vector.</span>

<span style="color: #00cd00;">If the MATCH-FORM vector is shorter than SOURCE vector, only</span>
<span style="color: #00cd00;">the (length MATCH-FORM) places are bound, the rest of the SOURCE</span>
<span style="color: #00cd00;">is discarded."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((i 0)
        (l (length match-form))
        (re))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (&lt; i l)
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((m (aref match-form i)))
        (push (<span style="color: #00cdcd; font-weight: bold;">cond</span>
                ((and (symbolp m)
                      (eq m '<span style="color: #00cd00;">&amp;rest</span>))
                 (<span style="color: #00cdcd; font-weight: bold;">prog1</span> (dash--match
                         (aref match-form (1+ i))
                         `(dash--vector-tail ,source ,i))
                   (setq i l)))
                ((and (symbolp m)
                      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">do not match symbols starting with _</span>
                      (not (eq (aref (symbol-name m) 0) ?_)))
                 (list (list m `(aref ,source ,i))))
                ((not (symbolp m))
                 (dash--match m `(aref ,source ,i))))
              re)
        (setq i (1+ i))))
    (-flatten-n 1 (nreverse re))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-kv</span> (match-form source)
  <span style="color: #00cd00;">"Setup a kv matching environment and call the real matcher.</span>

<span style="color: #00cd00;">kv can be any key-value store, such as plist, alist or hash-table."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((s (dash--match-make-source-symbol)))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">don't bind `s' if we only have one sub-pattern (&amp;type key val)</span>
      ((= (length match-form) 3)
       (dash--match-kv-1 (cdr match-form) source (car match-form)))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">if the source is a symbol, we don't need to re-bind it</span>
      ((symbolp source)
       (dash--match-kv-1 (cdr match-form) source (car match-form)))
      (t
       (cons (list s source) (dash--match-kv-1 (cdr match-form) s (car match-form)))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-kv-1</span> (match-form source type)
  <span style="color: #00cd00;">"Match MATCH-FORM against SOURCE of type TYPE.</span>

<span style="color: #00cd00;">MATCH-FORM is a proper list of the form (key1 place1 ... keyN</span>
<span style="color: #00cd00;">placeN).  Each placeK is either a symbol, which gets bound to the</span>
<span style="color: #00cd00;">value of keyK retrieved from the key-value store, or another</span>
<span style="color: #00cd00;">match form which gets destructured recursively.</span>

<span style="color: #00cd00;">SOURCE is a key-value store of type TYPE, which can be a plist,</span>
<span style="color: #00cd00;">an alist or a hash table.</span>

<span style="color: #00cd00;">TYPE is a token specifying the type of the key-value store.</span>
<span style="color: #00cd00;">Valid values are &amp;plist, &amp;alist and &amp;hash."</span>
  (-flatten-n 1 (-map
                 (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (kv)
                   (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((k (car kv))
                          (v (cadr kv))
                          (getter (<span style="color: #00cdcd; font-weight: bold;">cond</span>
                                    ((or (eq type '<span style="color: #00cd00;">&amp;plist</span>) (eq type '<span style="color: #00cd00;">&amp;keys</span>))
                                     `(plist-get ,source ,k))
                                    ((eq type '<span style="color: #00cd00;">&amp;alist</span>)
                                     `(cdr (assoc ,k ,source)))
                                    ((eq type '<span style="color: #00cd00;">&amp;hash</span>)
                                     `(gethash ,k ,source)))))
                     (<span style="color: #00cdcd; font-weight: bold;">cond</span>
                       ((symbolp v)
                        (list (list v getter)))
                       (t (dash--match v getter)))))
                 (-partition 2 match-form))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match-symbol</span> (match-form source)
  <span style="color: #00cd00;">"Bind a symbol.</span>

<span style="color: #00cd00;">This works just like `</span><span style="color: #cd00cd;">let</span><span style="color: #00cd00;">', there is no destructuring."</span>
  (list (list match-form source)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash--match</span> (match-form source)
  <span style="color: #00cd00;">"Match MATCH-FORM against SOURCE.</span>

<span style="color: #00cd00;">This function tests the MATCH-FORM and dispatches to specific</span>
<span style="color: #00cd00;">matchers based on the type of the expression.</span>

<span style="color: #00cd00;">Key-value stores are disambiguated by placing a token &amp;plist,</span>
<span style="color: #00cd00;">&amp;alist or &amp;hash as a first item in the MATCH-FORM."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((symbolp match-form)
     (dash--match-symbol match-form source))
    ((consp match-form)
     (<span style="color: #00cdcd; font-weight: bold;">cond</span>
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Handle the "x &amp;as" bindings first.</span>
       ((and (consp (cdr match-form))
             (symbolp (car match-form))
             (eq '<span style="color: #00cd00;">&amp;as</span> (cadr match-form)))
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((s (car match-form)))
          (cons (list s source)
                (dash--match (cddr match-form) s))))
       ((memq (car match-form) '(<span style="color: #00cd00;">&amp;keys</span> <span style="color: #00cd00;">&amp;plist</span> <span style="color: #00cd00;">&amp;alist</span> <span style="color: #00cd00;">&amp;hash</span>))
        (dash--match-kv match-form source))
       (t (dash--match-cons match-form source))))
    ((vectorp match-form)
     <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">We support the &amp;as binding in vectors too</span>
     (<span style="color: #00cdcd; font-weight: bold;">cond</span>
       ((and (&gt; (length match-form) 2)
             (symbolp (aref match-form 0))
             (eq '<span style="color: #00cd00;">&amp;as</span> (aref match-form 1)))
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((s (aref match-form 0)))
          (cons (list s source)
                (dash--match (dash--vector-tail match-form 2) s))))
       (t (dash--match-vector match-form source))))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-let*</span> (varlist <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Bind variables according to VARLIST then eval BODY.</span>

<span style="color: #00cd00;">VARLIST is a list of lists of the form (PATTERN SOURCE).  Each</span>
<span style="color: #00cd00;">PATTERN is matched against the SOURCE structurally.  SOURCE is</span>
<span style="color: #00cd00;">only evaluated once for each PATTERN.</span>

<span style="color: #00cd00;">Each SOURCE can refer to the symbols already bound by this</span>
<span style="color: #00cd00;">VARLIST.  This is useful if you want to destructure SOURCE</span>
<span style="color: #00cd00;">recursively but also want to name the intermediate structures.</span>

<span style="color: #00cd00;">See `</span><span style="color: #cd00cd;">-let</span><span style="color: #00cd00;">' for the list of all possible patterns."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ((<span style="color: #00cd00;">&amp;rest</span> (sexp form)) body))
           (indent 1))
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((bindings (--mapcat (dash--match (car it) (cadr it)) varlist)))
    `(<span style="color: #00cdcd; font-weight: bold;">let*</span> ,bindings
       ,@body)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-let</span> (varlist <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Bind variables according to VARLIST then eval BODY.</span>

<span style="color: #00cd00;">VARLIST is a list of lists of the form (PATTERN SOURCE).  Each</span>
<span style="color: #00cd00;">PATTERN is matched against the SOURCE \"structurally\".  SOURCE</span>
<span style="color: #00cd00;">is only evaluated once for each PATTERN.  Each PATTERN is matched</span>
<span style="color: #00cd00;">recursively, and can therefore contain sub-patterns which are</span>
<span style="color: #00cd00;">matched against corresponding sub-expressions of SOURCE.</span>

<span style="color: #00cd00;">All the SOURCEs are evalled before any symbols are</span>
<span style="color: #00cd00;">bound (i.e. \"in parallel\").</span>

<span style="color: #00cd00;">If VARLIST only contains one (PATTERN SOURCE) element, you can</span>
<span style="color: #00cd00;">optionally specify it using a vector and discarding the</span>
<span style="color: #00cd00;">outer-most parens.  Thus</span>

<span style="color: #00cd00;">  (-let ((PATTERN SOURCE)) ..)</span>

<span style="color: #00cd00;">becomes</span>

<span style="color: #00cd00;">  (-let [PATTERN SOURCE] ..).</span>

<span style="color: #00cd00;">`</span><span style="color: #cd00cd;">-let</span><span style="color: #00cd00;">' uses a convention of not binding places (symbols) starting</span>
<span style="color: #00cd00;">with _ whenever it's possible.  You can use this to skip over</span>
<span style="color: #00cd00;">entries you don't care about.  However, this is not *always*</span>
<span style="color: #00cd00;">possible (as a result of implementation) and these symbols might</span>
<span style="color: #00cd00;">get bound to undefined values.</span>

<span style="color: #00cd00;">Following is the overview of supported patterns.  Remember that</span>
<span style="color: #00cd00;">patterns can be matched recursively, so every a, b, aK in the</span>
<span style="color: #00cd00;">following can be a matching construct and not necessarily a</span>
<span style="color: #00cd00;">symbol/variable.</span>

<span style="color: #00cd00;">Symbol:</span>

<span style="color: #00cd00;">  a - bind the SOURCE to A.  This is just like regular `</span><span style="color: #cd00cd;">let</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">Conses and lists:</span>

<span style="color: #00cd00;">  (a) - bind `</span><span style="color: #cd00cd;">car</span><span style="color: #00cd00;">' of cons/list to A</span>

<span style="color: #00cd00;">  (a . b) - bind car of cons to A and `</span><span style="color: #cd00cd;">cdr</span><span style="color: #00cd00;">' to B</span>

<span style="color: #00cd00;">  (a b) - bind car of list to A and `</span><span style="color: #cd00cd;">cadr</span><span style="color: #00cd00;">' to B</span>

<span style="color: #00cd00;">  (a1 a2 a3  ...) - bind 0th car of list to A1, 1st to A2, 2nd to A3 ...</span>

<span style="color: #00cd00;">  (a1 a2 a3 ... aN . rest) - as above, but bind the Nth cdr to REST.</span>

<span style="color: #00cd00;">Vectors:</span>

<span style="color: #00cd00;">  [a] - bind 0th element of a non-list sequence to A (works with</span>
<span style="color: #00cd00;">        vectors, strings, bit arrays...)</span>

<span style="color: #00cd00;">  [a1 a2 a3 ...] - bind 0th element of non-list sequence to A0, 1st to</span>
<span style="color: #00cd00;">                   A1, 2nd to A2, ...</span>
<span style="color: #00cd00;">                   If the PATTERN is shorter than SOURCE, the values at</span>
<span style="color: #00cd00;">                   places not in PATTERN are ignored.</span>
<span style="color: #00cd00;">                   If the PATTERN is longer than SOURCE, an `</span><span style="color: #cd00cd;">error</span><span style="color: #00cd00;">' is</span>
<span style="color: #00cd00;">                   thrown.</span>

<span style="color: #00cd00;">  [a1 a2 a3 ... &amp;rest rest] - as above, but bind the rest of</span>
<span style="color: #00cd00;">                              the sequence to REST.  This is</span>
<span style="color: #00cd00;">                              conceptually the same as improper list</span>
<span style="color: #00cd00;">                              matching (a1 a2 ... aN . rest)</span>

<span style="color: #00cd00;">Key/value stores:</span>

<span style="color: #00cd00;">  (&amp;plist key0 a0 ... keyN aN) - bind value mapped by keyK in the</span>
<span style="color: #00cd00;">                                 SOURCE plist to aK.  If the</span>
<span style="color: #00cd00;">                                 value is not found, aK is nil.</span>

<span style="color: #00cd00;">  (&amp;alist key0 a0 ... keyN aN) - bind value mapped by keyK in the</span>
<span style="color: #00cd00;">                                 SOURCE alist to aK.  If the</span>
<span style="color: #00cd00;">                                 value is not found, aK is nil.</span>

<span style="color: #00cd00;">  (&amp;hash key0 a0 ... keyN aN) - bind value mapped by keyK in the</span>
<span style="color: #00cd00;">                                SOURCE hash table to aK.  If the</span>
<span style="color: #00cd00;">                                value is not found, aK is nil.</span>

<span style="color: #00cd00;">Further, special keyword &amp;keys supports \"inline\" matching of</span>
<span style="color: #00cd00;">plist-like key-value pairs, similarly to &amp;keys keyword of</span>
<span style="color: #00cd00;">`</span><span style="color: #cd00cd;">cl-defun</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">  (a1 a2 ... aN &amp;keys key1 b1 ... keyN bK)</span>

<span style="color: #00cd00;">This binds N values from the list to a1 ... aN, then interprets</span>
<span style="color: #00cd00;">the cdr as a plist (see key/value matching above).</span>

<span style="color: #00cd00;">You can name the source using the syntax SYMBOL &amp;as PATTERN.</span>
<span style="color: #00cd00;">This syntax works with lists (proper or improper), vectors and</span>
<span style="color: #00cd00;">all types of maps.</span>

<span style="color: #00cd00;">  (list &amp;as a b c) (list 1 2 3)</span>

<span style="color: #00cd00;">binds A to 1, B to 2, C to 3 and LIST to (1 2 3).</span>

<span style="color: #00cd00;">Similarly:</span>

<span style="color: #00cd00;">  (bounds &amp;as beg . end) (cons 1 2)</span>

<span style="color: #00cd00;">binds BEG to 1, END to 2 and BOUNDS to (1 . 2).</span>

<span style="color: #00cd00;">  (items &amp;as first . rest) (list 1 2 3)</span>

<span style="color: #00cd00;">binds FIRST to 1, REST to (2 3) and ITEMS to (1 2 3)</span>

<span style="color: #00cd00;">  [vect &amp;as _ b c] [1 2 3]</span>

<span style="color: #00cd00;">binds B to 2, C to 3 and VECT to [1 2 3] (_ avoids binding as usual).</span>

<span style="color: #00cd00;">  (plist &amp;as &amp;plist :b b) (list :a 1 :b 2 :c 3)</span>

<span style="color: #00cd00;">binds B to 2 and PLIST to (:a 1 :b 2 :c 3).  Same for &amp;alist and &amp;hash.</span>

<span style="color: #00cd00;">This is especially useful when we want to capture the result of a</span>
<span style="color: #00cd00;">computation and destructure at the same time.  Consider the</span>
<span style="color: #00cd00;">form (function-returning-complex-structure) returning a list of</span>
<span style="color: #00cd00;">two vectors with two items each.  We want to capture this entire</span>
<span style="color: #00cd00;">result and pass it to another computation, but at the same time</span>
<span style="color: #00cd00;">we want to get the second item from each vector.  We can achieve</span>
<span style="color: #00cd00;">it with pattern</span>

<span style="color: #00cd00;">  (result &amp;as [_ a] [_ b]) (function-returning-complex-structure)</span>

<span style="color: #00cd00;">Note: Clojure programmers may know this feature as the \":as</span>
<span style="color: #00cd00;">binding\".  The difference is that we put the &amp;as at the front</span>
<span style="color: #00cd00;">because we need to support improper list binding."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ([<span style="color: #00cd00;">&amp;or</span> (<span style="color: #00cd00;">&amp;rest</span> (sexp form))
                        (vector [<span style="color: #00cd00;">&amp;rest</span> [sexp form]])]
                        body))
           (indent 1))
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (vectorp varlist)
      `(<span style="color: #00cdcd; font-weight: bold;">let*</span> ,(dash--match (aref varlist 0) (aref varlist 1))
         ,@body)
      (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((inputs (--map-indexed (list (make-symbol (format <span style="color: #00cd00;">"input%d"</span> it-index)) (cadr it)) varlist))
             (new-varlist (--map (list (caar it) (cadr it)) (-zip varlist inputs))))
        `(<span style="color: #00cdcd; font-weight: bold;">let</span> ,inputs
           (-let* ,new-varlist ,@body)))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-lambda</span> (match-form <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Return a lambda which destructures its input as MATCH-FORM and executes BODY.</span>

<span style="color: #00cd00;">Note that you have to enclose the MATCH-FORM in a pair of parens,</span>
<span style="color: #00cd00;">such that:</span>

<span style="color: #00cd00;">  (-lambda (x) body)</span>
<span style="color: #00cd00;">  (-lambda (x y ...) body)</span>

<span style="color: #00cd00;">has the usual semantics of `</span><span style="color: #cd00cd;">lambda</span><span style="color: #00cd00;">'.  Furthermore, these get</span>
<span style="color: #00cd00;">translated into normal lambda, so there is no performance</span>
<span style="color: #00cd00;">penalty.</span>

<span style="color: #00cd00;">See `</span><span style="color: #cd00cd;">-let</span><span style="color: #00cd00;">' for the description of destructuring mechanism."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (doc-string 2) (indent defun)
           (debug (<span style="color: #00cd00;">&amp;define</span> sexp
                           [<span style="color: #00cd00;">&amp;optional</span> stringp]
                           [<span style="color: #00cd00;">&amp;optional</span> (<span style="color: #00cd00;">"interactive"</span> interactive)]
                           def-body)))
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not (consp match-form))
     (<span style="color: #cd0000; font-weight: bold;">signal</span> 'wrong-type-argument <span style="color: #00cd00;">"match-form must be a list"</span>))
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">no destructuring, so just return regular lambda to make things faster</span>
    ((-all? 'symbolp match-form)
     `(<span style="color: #00cdcd; font-weight: bold;">lambda</span> ,match-form ,@body))
    (t
     (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((inputs (--map-indexed (list it (make-symbol (format <span style="color: #00cd00;">"input%d"</span> it-index))) match-form)))
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">TODO: because inputs to the lambda are evaluated only once,</span>
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">-let* need not to create the extra bindings to ensure that.</span>
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">We should find a way to optimize that.  Not critical however.</span>
       `(<span style="color: #00cdcd; font-weight: bold;">lambda</span> ,(--map (cadr it) inputs)
          (-let* ,inputs ,@body))))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-if-let*</span> (vars-vals then <span style="color: #00cd00;">&amp;rest</span> else)
  <span style="color: #00cd00;">"If all VALS evaluate to true, bind them to their corresponding</span>
<span style="color: #00cd00;">VARS and do THEN, otherwise do ELSE. VARS-VALS should be a list</span>
<span style="color: #00cd00;">of (VAR VAL) pairs.</span>

<span style="color: #00cd00;">Note: binding is done according to `</span><span style="color: #cd00cd;">-let*</span><span style="color: #00cd00;">'.  VALS are evaluated</span>
<span style="color: #00cd00;">sequentially, and evaluation stops after the first nil VAL is</span>
<span style="color: #00cd00;">encountered."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ((<span style="color: #00cd00;">&amp;rest</span> (sexp form)) form body))
           (indent 2))
  (-&gt;&gt; vars-vals
       (--mapcat (dash--match (car it) (cadr it)))
       (--reduce-r-from
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((var (car it))
              (val (cadr it)))
          `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,var ,val))
             (<span style="color: #00cdcd; font-weight: bold;">if</span> ,var ,acc ,@else)))
        then)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-if-let</span> (var-val then <span style="color: #00cd00;">&amp;rest</span> else)
  <span style="color: #00cd00;">"If VAL evaluates to non-nil, bind it to VAR and do THEN,</span>
<span style="color: #00cd00;">otherwise do ELSE. VAR-VAL should be a (VAR VAL) pair.</span>

<span style="color: #00cd00;">Note: binding is done according to `</span><span style="color: #cd00cd;">-let</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ((sexp form) form body))
           (indent 2))
  `(-if-let* (,var-val) ,then ,@else))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--if-let</span> (val then <span style="color: #00cd00;">&amp;rest</span> else)
  <span style="color: #00cd00;">"If VAL evaluates to non-nil, bind it to `</span><span style="color: #cd00cd;">it</span><span style="color: #00cd00;">' and do THEN,</span>
<span style="color: #00cd00;">otherwise do ELSE."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form body))
           (indent 2))
  `(-if-let (it ,val) ,then ,@else))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-when-let*</span> (vars-vals <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"If all VALS evaluate to true, bind them to their corresponding</span>
<span style="color: #00cd00;">VARS and execute body. VARS-VALS should be a list of (VAR VAL)</span>
<span style="color: #00cd00;">pairs.</span>

<span style="color: #00cd00;">Note: binding is done according to `</span><span style="color: #cd00cd;">-let*</span><span style="color: #00cd00;">'.  VALS are evaluated</span>
<span style="color: #00cd00;">sequentially, and evaluation stops after the first nil VAL is</span>
<span style="color: #00cd00;">encountered."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ((<span style="color: #00cd00;">&amp;rest</span> (sexp form)) body))
           (indent 1))
  `(-if-let* ,vars-vals (<span style="color: #00cdcd; font-weight: bold;">progn</span> ,@body)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-when-let</span> (var-val <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"If VAL evaluates to non-nil, bind it to VAR and execute body.</span>
<span style="color: #00cd00;">VAR-VAL should be a (VAR VAL) pair.</span>

<span style="color: #00cd00;">Note: binding is done according to `</span><span style="color: #cd00cd;">-let</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug ((sexp form) body))
           (indent 1))
  `(-if-let ,var-val (<span style="color: #00cdcd; font-weight: bold;">progn</span> ,@body)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--when-let</span> (val <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"If VAL evaluates to non-nil, bind it to `</span><span style="color: #cd00cd;">it</span><span style="color: #00cd00;">' and execute</span>
<span style="color: #00cd00;">body."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form body))
           (indent 1))
  `(--if-let ,val (<span style="color: #00cdcd; font-weight: bold;">progn</span> ,@body)))

(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">-compare-fn</span> nil
  <span style="color: #00cd00;">"Tests for equality use this function or `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">' if this is nil.</span>
<span style="color: #00cd00;">It should only be set using dynamic scope with a let, like:</span>

<span style="color: #00cd00;">  (let ((-compare-fn #'=)) (-union numbers1 numbers2 numbers3)"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-distinct</span> (list)
  <span style="color: #00cd00;">"Return a new list with all duplicates removed.</span>
<span style="color: #00cd00;">The test for equality is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">',</span>
<span style="color: #00cd00;">or with `</span><span style="color: #cd00cd;">-compare-fn</span><span style="color: #00cd00;">' if that's non-nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-uniq</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (result)
    (--each list (<span style="color: #00cdcd; font-weight: bold;">unless</span> (-contains? result it) (!cons it result)))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-uniq</span> '-distinct)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-union</span> (list list2)
  <span style="color: #00cd00;">"Return a new list containing the elements of LIST1 and elements of LIST2 that are not in LIST1.</span>
<span style="color: #00cd00;">The test for equality is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">',</span>
<span style="color: #00cd00;">or with `</span><span style="color: #cd00cd;">-compare-fn</span><span style="color: #00cd00;">' if that's non-nil."</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">We fall back to iteration implementation if the comparison</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">function isn't one of `</span><span style="color: #cd00cd;">eq</span><span style="color: #cd0000;">', `</span><span style="color: #cd00cd;">eql</span><span style="color: #cd0000;">' or `</span><span style="color: #cd00cd;">equal</span><span style="color: #cd0000;">'.</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((result (reverse list))
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">TODO: get rid of this dynamic variable, pass it as an</span>
         <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">argument instead.</span>
         (-compare-fn (<span style="color: #00cdcd; font-weight: bold;">if</span> (bound-and-true-p -compare-fn)
                          -compare-fn
                          'equal)))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (memq -compare-fn '(eq eql equal))
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((ht (make-hash-table <span style="color: #0000ee; font-weight: bold;">:test</span> -compare-fn)))
          (--each list (puthash it t ht))
          (--each list2 (<span style="color: #00cdcd; font-weight: bold;">unless</span> (gethash it ht) (!cons it result))))
        (--each list2 (<span style="color: #00cdcd; font-weight: bold;">unless</span> (-contains? result it) (!cons it result))))
    (nreverse result)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-intersection</span> (list list2)
  <span style="color: #00cd00;">"Return a new list containing only the elements that are members of both LIST and LIST2.</span>
<span style="color: #00cd00;">The test for equality is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">',</span>
<span style="color: #00cd00;">or with `</span><span style="color: #cd00cd;">-compare-fn</span><span style="color: #00cd00;">' if that's non-nil."</span>
  (--filter (-contains? list2 it) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-difference</span> (list list2)
  <span style="color: #00cd00;">"Return a new list with only the members of LIST that are not in LIST2.</span>
<span style="color: #00cd00;">The test for equality is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">',</span>
<span style="color: #00cd00;">or with `</span><span style="color: #cd00cd;">-compare-fn</span><span style="color: #00cd00;">' if that's non-nil."</span>
  (--filter (not (-contains? list2 it)) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-contains?</span> (list element)
  <span style="color: #00cd00;">"Return non-nil if LIST contains ELEMENT.</span>

<span style="color: #00cd00;">The test for equality is done with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">', or with `</span><span style="color: #cd00cd;">-compare-fn</span><span style="color: #00cd00;">'</span>
<span style="color: #00cd00;">if that's non-nil.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-contains-p</span><span style="color: #00cd00;">'"</span>
  (not
   (null
    (<span style="color: #00cdcd; font-weight: bold;">cond</span>
      ((null -compare-fn)    (member element list))
      ((eq -compare-fn 'eq)  (memq element list))
      ((eq -compare-fn 'eql) (memql element list))
      (t
       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((lst list))
         (<span style="color: #00cdcd; font-weight: bold;">while</span> (and lst
                     (not (funcall -compare-fn element (car lst))))
           (setq lst (cdr lst)))
         lst))))))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-contains-p</span> '-contains?)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-same-items?</span> (list list2)
  <span style="color: #00cd00;">"Return true if LIST and LIST2 has the same items.</span>

<span style="color: #00cd00;">The order of the elements in the lists does not matter.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-same-items-p</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((length-a (length list))
        (length-b (length list2)))
    (and
     (= length-a length-b)
     (= length-a (length (-intersection list list2))))))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-same-items-p</span> '-same-items?)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-is-prefix?</span> (prefix list)
  <span style="color: #00cd00;">"Return non-nil if PREFIX is prefix of LIST.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-is-prefix-p</span><span style="color: #00cd00;">'"</span>
  (--each-while list (equal (car prefix) it)
                (!cdr prefix))
  (not prefix))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-is-suffix?</span> (suffix list)
  <span style="color: #00cd00;">"Return non-nil if SUFFIX is suffix of LIST.</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-is-suffix-p</span><span style="color: #00cd00;">'"</span>
  (-is-prefix? (reverse suffix) (reverse list)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-is-infix?</span> (infix list)
  <span style="color: #00cd00;">"Return non-nil if INFIX is infix of LIST.</span>

<span style="color: #00cd00;">This operation runs in O(n^2) time</span>

<span style="color: #00cd00;">Alias: `</span><span style="color: #cd00cd;">-is-infix-p</span><span style="color: #00cd00;">'"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (done)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (and (not done) list)
      (setq done (-is-prefix? infix list))
      (!cdr list))
    done))

(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-is-prefix-p</span> '-is-prefix?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-is-suffix-p</span> '-is-suffix?)
(<span style="color: #00cdcd; font-weight: bold;">defalias</span> '<span style="color: #0000ee; font-weight: bold;">-is-infix-p</span> '-is-infix?)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-sort</span> (comparator list)
  <span style="color: #00cd00;">"Sort LIST, stably, comparing elements using COMPARATOR.</span>
<span style="color: #00cd00;">Return the sorted list.  LIST is NOT modified by side effects.</span>
<span style="color: #00cd00;">COMPARATOR is called with two elements of LIST, and should return non-nil</span>
<span style="color: #00cd00;">if the first element should sort before the second."</span>
  (sort (copy-sequence list) comparator))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--sort</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-sort</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-sort (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it other) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-list</span> (<span style="color: #00cd00;">&amp;rest</span> args)
  <span style="color: #00cd00;">"Return a list with ARGS.</span>

<span style="color: #00cd00;">If first item of ARGS is already a list, simply return ARGS.  If</span>
<span style="color: #00cd00;">not, return a list with ARGS as elements."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((arg (car args)))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (listp arg) arg args)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-repeat</span> (n x)
  <span style="color: #00cd00;">"Return a list with X repeated N times.</span>
<span style="color: #00cd00;">Return nil if N is less than 1."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> (ret)
    (--dotimes n (!cons x ret))
    ret))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-sum</span> (list)
  <span style="color: #00cd00;">"Return the sum of LIST."</span>
  (apply '+ list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-product</span> (list)
  <span style="color: #00cd00;">"Return the product of LIST."</span>
  (apply '* list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-max</span> (list)
  <span style="color: #00cd00;">"Return the largest value from LIST of numbers or markers."</span>
  (apply 'max list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-min</span> (list)
  <span style="color: #00cd00;">"Return the smallest value from LIST of numbers or markers."</span>
  (apply 'min list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-max-by</span> (comparator list)
  <span style="color: #00cd00;">"Take a comparison function COMPARATOR and a LIST and return</span>
<span style="color: #00cd00;">the greatest element of the list by the comparison function.</span>

<span style="color: #00cd00;">See also combinator `</span><span style="color: #cd00cd;">-on</span><span style="color: #00cd00;">' which can transform the values before</span>
<span style="color: #00cd00;">comparing them."</span>
  (--reduce (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall comparator it acc) it acc) list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-min-by</span> (comparator list)
  <span style="color: #00cd00;">"Take a comparison function COMPARATOR and a LIST and return</span>
<span style="color: #00cd00;">the least element of the list by the comparison function.</span>

<span style="color: #00cd00;">See also combinator `</span><span style="color: #cd00cd;">-on</span><span style="color: #00cd00;">' which can transform the values before</span>
<span style="color: #00cd00;">comparing them."</span>
  (--reduce (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall comparator it acc) acc it) list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--max-by</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-max-by</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">The items for the comparator form are exposed as \"it\" and \"other\"."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-max-by (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it other) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--min-by</span> (form list)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-min-by</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">The items for the comparator form are exposed as \"it\" and \"other\"."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-min-by (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it other) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-iterate</span> (fun init n)
  <span style="color: #00cd00;">"Return a list of iterated applications of FUN to INIT.</span>

<span style="color: #00cd00;">This means a list of form:</span>

<span style="color: #00cd00;">  (init (fun init) (fun (fun init)) ...)</span>

<span style="color: #00cd00;">N is the length of the returned list."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (= n 0) nil
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (list init)))
        (--dotimes (1- n)
                   (push (funcall fun (car r)) r))
        (nreverse r))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-fix</span> (fn list)
  <span style="color: #00cd00;">"Compute the (least) fixpoint of FN with initial input LIST.</span>

<span style="color: #00cd00;">FN is called at least once, results are compared with `</span><span style="color: #cd00cd;">equal</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((re (funcall fn list)))
    (<span style="color: #00cdcd; font-weight: bold;">while</span> (not (equal list re))
      (setq list re)
      (setq re (funcall fn re)))
    re))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--fix</span> (form list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-fix</span><span style="color: #00cd00;">'."</span>
  `(-fix (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-unfold</span> (fun seed)
  <span style="color: #00cd00;">"Build a list from SEED using FUN.</span>

<span style="color: #00cd00;">This is \"dual\" operation to `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">': while -reduce-r</span>
<span style="color: #00cd00;">consumes a list to produce a single value, `</span><span style="color: #cd00cd;">-unfold</span><span style="color: #00cd00;">' takes a</span>
<span style="color: #00cd00;">seed value and builds a (potentially infinite!) list.</span>

<span style="color: #00cd00;">FUN should return `</span><span style="color: #cd00cd;">nil</span><span style="color: #00cd00;">' to stop the generating process, or a</span>
<span style="color: #00cd00;">cons (A . B), where A will be prepended to the result and B is</span>
<span style="color: #00cd00;">the new seed."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((last (funcall fun seed)) r)
    (<span style="color: #00cdcd; font-weight: bold;">while</span> last
      (push (car last) r)
      (setq last (funcall fun (cdr last))))
    (nreverse r)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--unfold</span> (form seed)
  <span style="color: #00cd00;">"Anaphoric version of `</span><span style="color: #cd00cd;">-unfold</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-unfold (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,seed))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-cons-pair?</span> (con)
  <span style="color: #00cd00;">"Return non-nil if CON is true cons pair.</span>
<span style="color: #00cd00;">That is (A . B) where B is not a list."</span>
  (and (listp con)
       (not (listp (cdr con)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-cons-to-list</span> (con)
  <span style="color: #00cd00;">"Convert a cons pair to a list with `</span><span style="color: #cd00cd;">car</span><span style="color: #00cd00;">' and `</span><span style="color: #cd00cd;">cdr</span><span style="color: #00cd00;">' of the pair respectively."</span>
  (list (car con) (cdr con)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-value-to-list</span> (val)
  <span style="color: #00cd00;">"Convert a value to a list.</span>

<span style="color: #00cd00;">If the value is a cons pair, make a list with two elements, `</span><span style="color: #cd00cd;">car</span><span style="color: #00cd00;">'</span>
<span style="color: #00cd00;">and `</span><span style="color: #cd00cd;">cdr</span><span style="color: #00cd00;">' of the pair respectively.</span>

<span style="color: #00cd00;">If the value is anything else, wrap it in a list."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((-cons-pair? val) (-cons-to-list val))
    (t (list val))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-mapreduce-from</span> (fn folder init-value tree)
  <span style="color: #00cd00;">"Apply FN to each element of TREE, and make a list of the results.</span>
<span style="color: #00cd00;">If elements of TREE are lists themselves, apply FN recursively to</span>
<span style="color: #00cd00;">elements of these nested lists.</span>

<span style="color: #00cd00;">Then reduce the resulting lists using FOLDER and initial value</span>
<span style="color: #00cd00;">INIT-VALUE. See `</span><span style="color: #cd00cd;">-reduce-r-from</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">This is the same as calling `</span><span style="color: #cd00cd;">-tree-reduce-from</span><span style="color: #00cd00;">' after `</span><span style="color: #cd00cd;">-tree-map</span><span style="color: #00cd00;">'</span>
<span style="color: #00cd00;">but is twice as fast as it only traverse the structure once."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not tree) nil)
    ((-cons-pair? tree) (funcall fn tree))
    ((listp tree)
     (-reduce-r-from folder init-value (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-mapreduce-from fn folder init-value x)) tree)))
    (t (funcall fn tree))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-mapreduce-from</span> (form folder init-value tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-mapreduce-from</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form form)))
  `(-tree-mapreduce-from (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it acc) ,folder) ,init-value ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-mapreduce</span> (fn folder tree)
  <span style="color: #00cd00;">"Apply FN to each element of TREE, and make a list of the results.</span>
<span style="color: #00cd00;">If elements of TREE are lists themselves, apply FN recursively to</span>
<span style="color: #00cd00;">elements of these nested lists.</span>

<span style="color: #00cd00;">Then reduce the resulting lists using FOLDER and initial value</span>
<span style="color: #00cd00;">INIT-VALUE. See `</span><span style="color: #cd00cd;">-reduce-r-from</span><span style="color: #00cd00;">'.</span>

<span style="color: #00cd00;">This is the same as calling `</span><span style="color: #cd00cd;">-tree-reduce</span><span style="color: #00cd00;">' after `</span><span style="color: #cd00cd;">-tree-map</span><span style="color: #00cd00;">'</span>
<span style="color: #00cd00;">but is twice as fast as it only traverse the structure once."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not tree) nil)
    ((-cons-pair? tree) (funcall fn tree))
    ((listp tree)
     (-reduce-r folder (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-mapreduce fn folder x)) tree)))
    (t (funcall fn tree))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-mapreduce</span> (form folder tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-mapreduce</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(-tree-mapreduce (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it acc) ,folder) ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-map</span> (fn tree)
  <span style="color: #00cd00;">"Apply FN to each element of TREE while preserving the tree structure."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not tree) nil)
    ((-cons-pair? tree) (funcall fn tree))
    ((listp tree)
     (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-map fn x)) tree))
    (t (funcall fn tree))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-map</span> (form tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-map</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-tree-map (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-reduce-from</span> (fn init-value tree)
  <span style="color: #00cd00;">"Use FN to reduce elements of list TREE.</span>
<span style="color: #00cd00;">If elements of TREE are lists themselves, apply the reduction recursively.</span>

<span style="color: #00cd00;">FN is first applied to INIT-VALUE and first element of the list,</span>
<span style="color: #00cd00;">then on this result and second element from the list etc.</span>

<span style="color: #00cd00;">The initial value is ignored on cons pairs as they always contain</span>
<span style="color: #00cd00;">two elements."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not tree) nil)
    ((-cons-pair? tree) tree)
    ((listp tree)
     (-reduce-r-from fn init-value (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-reduce-from fn init-value x)) tree)))
    (t tree)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-reduce-from</span> (form init-value tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-reduce-from</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form form)))
  `(-tree-reduce-from (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it acc) ,form) ,init-value ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-reduce</span> (fn tree)
  <span style="color: #00cd00;">"Use FN to reduce elements of list TREE.</span>
<span style="color: #00cd00;">If elements of TREE are lists themselves, apply the reduction recursively.</span>

<span style="color: #00cd00;">FN is first applied to first element of the list and second</span>
<span style="color: #00cd00;">element, then on this result and third element from the list etc.</span>

<span style="color: #00cd00;">See `</span><span style="color: #cd00cd;">-reduce-r</span><span style="color: #00cd00;">' for how exactly are lists of zero or one element handled."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((not tree) nil)
    ((-cons-pair? tree) tree)
    ((listp tree)
     (-reduce-r fn (mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-reduce fn x)) tree)))
    (t tree)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-reduce</span> (form tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-reduce</span><span style="color: #00cd00;">'."</span>
  (<span style="color: #00cdcd; font-weight: bold;">declare</span> (debug (form form)))
  `(-tree-reduce (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it acc) ,form) ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-map-nodes</span> (pred fun tree)
  <span style="color: #00cd00;">"Call FUN on each node of TREE that satisfies PRED.</span>

<span style="color: #00cd00;">If PRED returns nil, continue descending down this node.  If PRED</span>
<span style="color: #00cd00;">returns non-nil, apply FUN to this node and do not descend</span>
<span style="color: #00cd00;">further."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (funcall pred tree)
      (funcall fun tree)
      (<span style="color: #00cdcd; font-weight: bold;">if</span> (and (listp tree)
               (not (-cons-pair? tree)))
          (-map (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-map-nodes pred fun x)) tree)
          tree)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-map-nodes</span> (pred form tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-map-nodes</span><span style="color: #00cd00;">'."</span>
  `(-tree-map-nodes (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,pred) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,form) ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-tree-seq</span> (branch children tree)
  <span style="color: #00cd00;">"Return a sequence of the nodes in TREE, in depth-first search order.</span>

<span style="color: #00cd00;">BRANCH is a predicate of one argument that returns non-nil if the</span>
<span style="color: #00cd00;">passed argument is a branch, that is, a node that can have children.</span>

<span style="color: #00cd00;">CHILDREN is a function of one argument that returns the children</span>
<span style="color: #00cd00;">of the passed branch node.</span>

<span style="color: #00cd00;">Non-branch nodes are simply copied."</span>
  (cons tree
        (<span style="color: #00cdcd; font-weight: bold;">when</span> (funcall branch tree)
          (-mapcat (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (-tree-seq branch children x))
                   (funcall children tree)))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--tree-seq</span> (branch children tree)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-tree-seq</span><span style="color: #00cd00;">'."</span>
  `(-tree-seq (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,branch) (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (it) ,children) ,tree))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-clone</span> (list)
  <span style="color: #00cd00;">"Create a deep copy of LIST.</span>
<span style="color: #00cd00;">The new list has the same elements and structure but all cons are</span>
<span style="color: #00cd00;">replaced with new ones.  This is useful when you need to clone a</span>
<span style="color: #00cd00;">structure such as plist or alist."</span>
  (-tree-map 'identity list))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dash-enable-font-lock</span> ()
  <span style="color: #00cd00;">"Add syntax highlighting to dash functions, macros and magic values."</span>
  (<span style="color: #00cdcd; font-weight: bold;">eval-after-load</span> <span style="color: #00cd00;">"lisp-mode"</span>
    '(<span style="color: #00cdcd; font-weight: bold;">progn</span>
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((new-keywords '(
                            <span style="color: #00cd00;">"-each"</span>
                            <span style="color: #00cd00;">"--each"</span>
                            <span style="color: #00cd00;">"-each-while"</span>
                            <span style="color: #00cd00;">"--each-while"</span>
                            <span style="color: #00cd00;">"-dotimes"</span>
                            <span style="color: #00cd00;">"--dotimes"</span>
                            <span style="color: #00cd00;">"-map"</span>
                            <span style="color: #00cd00;">"--map"</span>
                            <span style="color: #00cd00;">"-reduce-from"</span>
                            <span style="color: #00cd00;">"--reduce-from"</span>
                            <span style="color: #00cd00;">"-reduce"</span>
                            <span style="color: #00cd00;">"--reduce"</span>
                            <span style="color: #00cd00;">"-reduce-r-from"</span>
                            <span style="color: #00cd00;">"--reduce-r-from"</span>
                            <span style="color: #00cd00;">"-reduce-r"</span>
                            <span style="color: #00cd00;">"--reduce-r"</span>
                            <span style="color: #00cd00;">"-filter"</span>
                            <span style="color: #00cd00;">"--filter"</span>
                            <span style="color: #00cd00;">"-select"</span>
                            <span style="color: #00cd00;">"--select"</span>
                            <span style="color: #00cd00;">"-remove"</span>
                            <span style="color: #00cd00;">"--remove"</span>
                            <span style="color: #00cd00;">"-reject"</span>
                            <span style="color: #00cd00;">"--reject"</span>
                            <span style="color: #00cd00;">"-remove-first"</span>
                            <span style="color: #00cd00;">"--remove-first"</span>
                            <span style="color: #00cd00;">"-reject-first"</span>
                            <span style="color: #00cd00;">"--reject-first"</span>
                            <span style="color: #00cd00;">"-remove-last"</span>
                            <span style="color: #00cd00;">"--remove-last"</span>
                            <span style="color: #00cd00;">"-reject-last"</span>
                            <span style="color: #00cd00;">"--reject-last"</span>
                            <span style="color: #00cd00;">"-remove-item"</span>
                            <span style="color: #00cd00;">"-non-nil"</span>
                            <span style="color: #00cd00;">"-keep"</span>
                            <span style="color: #00cd00;">"--keep"</span>
                            <span style="color: #00cd00;">"-map-indexed"</span>
                            <span style="color: #00cd00;">"--map-indexed"</span>
                            <span style="color: #00cd00;">"-splice"</span>
                            <span style="color: #00cd00;">"--splice"</span>
                            <span style="color: #00cd00;">"-splice-list"</span>
                            <span style="color: #00cd00;">"--splice-list"</span>
                            <span style="color: #00cd00;">"-map-when"</span>
                            <span style="color: #00cd00;">"--map-when"</span>
                            <span style="color: #00cd00;">"-replace-where"</span>
                            <span style="color: #00cd00;">"--replace-where"</span>
                            <span style="color: #00cd00;">"-map-first"</span>
                            <span style="color: #00cd00;">"--map-first"</span>
                            <span style="color: #00cd00;">"-map-last"</span>
                            <span style="color: #00cd00;">"--map-last"</span>
                            <span style="color: #00cd00;">"-replace"</span>
                            <span style="color: #00cd00;">"-replace-first"</span>
                            <span style="color: #00cd00;">"-replace-last"</span>
                            <span style="color: #00cd00;">"-flatten"</span>
                            <span style="color: #00cd00;">"-flatten-n"</span>
                            <span style="color: #00cd00;">"-concat"</span>
                            <span style="color: #00cd00;">"-mapcat"</span>
                            <span style="color: #00cd00;">"--mapcat"</span>
                            <span style="color: #00cd00;">"-copy"</span>
                            <span style="color: #00cd00;">"-cons*"</span>
                            <span style="color: #00cd00;">"-snoc"</span>
                            <span style="color: #00cd00;">"-first"</span>
                            <span style="color: #00cd00;">"--first"</span>
                            <span style="color: #00cd00;">"-find"</span>
                            <span style="color: #00cd00;">"--find"</span>
                            <span style="color: #00cd00;">"-some"</span>
                            <span style="color: #00cd00;">"--some"</span>
                            <span style="color: #00cd00;">"-any"</span>
                            <span style="color: #00cd00;">"--any"</span>
                            <span style="color: #00cd00;">"-last"</span>
                            <span style="color: #00cd00;">"--last"</span>
                            <span style="color: #00cd00;">"-first-item"</span>
                            <span style="color: #00cd00;">"-last-item"</span>
                            <span style="color: #00cd00;">"-butlast"</span>
                            <span style="color: #00cd00;">"-count"</span>
                            <span style="color: #00cd00;">"--count"</span>
                            <span style="color: #00cd00;">"-any?"</span>
                            <span style="color: #00cd00;">"--any?"</span>
                            <span style="color: #00cd00;">"-some?"</span>
                            <span style="color: #00cd00;">"--some?"</span>
                            <span style="color: #00cd00;">"-any-p"</span>
                            <span style="color: #00cd00;">"--any-p"</span>
                            <span style="color: #00cd00;">"-some-p"</span>
                            <span style="color: #00cd00;">"--some-p"</span>
                            <span style="color: #00cd00;">"-all?"</span>
                            <span style="color: #00cd00;">"--all?"</span>
                            <span style="color: #00cd00;">"-every?"</span>
                            <span style="color: #00cd00;">"--every?"</span>
                            <span style="color: #00cd00;">"-all-p"</span>
                            <span style="color: #00cd00;">"--all-p"</span>
                            <span style="color: #00cd00;">"-every-p"</span>
                            <span style="color: #00cd00;">"--every-p"</span>
                            <span style="color: #00cd00;">"-none?"</span>
                            <span style="color: #00cd00;">"--none?"</span>
                            <span style="color: #00cd00;">"-none-p"</span>
                            <span style="color: #00cd00;">"--none-p"</span>
                            <span style="color: #00cd00;">"-only-some?"</span>
                            <span style="color: #00cd00;">"--only-some?"</span>
                            <span style="color: #00cd00;">"-only-some-p"</span>
                            <span style="color: #00cd00;">"--only-some-p"</span>
                            <span style="color: #00cd00;">"-slice"</span>
                            <span style="color: #00cd00;">"-take"</span>
                            <span style="color: #00cd00;">"-drop"</span>
                            <span style="color: #00cd00;">"-take-while"</span>
                            <span style="color: #00cd00;">"--take-while"</span>
                            <span style="color: #00cd00;">"-drop-while"</span>
                            <span style="color: #00cd00;">"--drop-while"</span>
                            <span style="color: #00cd00;">"-split-at"</span>
                            <span style="color: #00cd00;">"-rotate"</span>
                            <span style="color: #00cd00;">"-insert-at"</span>
                            <span style="color: #00cd00;">"-replace-at"</span>
                            <span style="color: #00cd00;">"-update-at"</span>
                            <span style="color: #00cd00;">"--update-at"</span>
                            <span style="color: #00cd00;">"-remove-at"</span>
                            <span style="color: #00cd00;">"-remove-at-indices"</span>
                            <span style="color: #00cd00;">"-split-with"</span>
                            <span style="color: #00cd00;">"--split-with"</span>
                            <span style="color: #00cd00;">"-split-on"</span>
                            <span style="color: #00cd00;">"-split-when"</span>
                            <span style="color: #00cd00;">"--split-when"</span>
                            <span style="color: #00cd00;">"-separate"</span>
                            <span style="color: #00cd00;">"--separate"</span>
                            <span style="color: #00cd00;">"-partition-all-in-steps"</span>
                            <span style="color: #00cd00;">"-partition-in-steps"</span>
                            <span style="color: #00cd00;">"-partition-all"</span>
                            <span style="color: #00cd00;">"-partition"</span>
                            <span style="color: #00cd00;">"-partition-by"</span>
                            <span style="color: #00cd00;">"--partition-by"</span>
                            <span style="color: #00cd00;">"-partition-by-header"</span>
                            <span style="color: #00cd00;">"--partition-by-header"</span>
                            <span style="color: #00cd00;">"-group-by"</span>
                            <span style="color: #00cd00;">"--group-by"</span>
                            <span style="color: #00cd00;">"-interpose"</span>
                            <span style="color: #00cd00;">"-interleave"</span>
                            <span style="color: #00cd00;">"-zip-with"</span>
                            <span style="color: #00cd00;">"--zip-with"</span>
                            <span style="color: #00cd00;">"-zip"</span>
                            <span style="color: #00cd00;">"-zip-fill"</span>
                            <span style="color: #00cd00;">"-cycle"</span>
                            <span style="color: #00cd00;">"-pad"</span>
                            <span style="color: #00cd00;">"-annotate"</span>
                            <span style="color: #00cd00;">"--annotate"</span>
                            <span style="color: #00cd00;">"-table"</span>
                            <span style="color: #00cd00;">"-table-flat"</span>
                            <span style="color: #00cd00;">"-partial"</span>
                            <span style="color: #00cd00;">"-elem-index"</span>
                            <span style="color: #00cd00;">"-elem-indices"</span>
                            <span style="color: #00cd00;">"-find-indices"</span>
                            <span style="color: #00cd00;">"--find-indices"</span>
                            <span style="color: #00cd00;">"-find-index"</span>
                            <span style="color: #00cd00;">"--find-index"</span>
                            <span style="color: #00cd00;">"-find-last-index"</span>
                            <span style="color: #00cd00;">"--find-last-index"</span>
                            <span style="color: #00cd00;">"-select-by-indices"</span>
                            <span style="color: #00cd00;">"-grade-up"</span>
                            <span style="color: #00cd00;">"-grade-down"</span>
                            <span style="color: #00cd00;">"-&gt;"</span>
                            <span style="color: #00cd00;">"-&gt;&gt;"</span>
                            <span style="color: #00cd00;">"--&gt;"</span>
                            <span style="color: #00cd00;">"-when-let"</span>
                            <span style="color: #00cd00;">"-when-let*"</span>
                            <span style="color: #00cd00;">"--when-let"</span>
                            <span style="color: #00cd00;">"-if-let"</span>
                            <span style="color: #00cd00;">"-if-let*"</span>
                            <span style="color: #00cd00;">"--if-let"</span>
                            <span style="color: #00cd00;">"-let*"</span>
                            <span style="color: #00cd00;">"-let"</span>
                            <span style="color: #00cd00;">"-lambda"</span>
                            <span style="color: #00cd00;">"-distinct"</span>
                            <span style="color: #00cd00;">"-uniq"</span>
                            <span style="color: #00cd00;">"-union"</span>
                            <span style="color: #00cd00;">"-intersection"</span>
                            <span style="color: #00cd00;">"-difference"</span>
                            <span style="color: #00cd00;">"-contains?"</span>
                            <span style="color: #00cd00;">"-contains-p"</span>
                            <span style="color: #00cd00;">"-same-items?"</span>
                            <span style="color: #00cd00;">"-same-items-p"</span>
                            <span style="color: #00cd00;">"-is-prefix-p"</span>
                            <span style="color: #00cd00;">"-is-prefix?"</span>
                            <span style="color: #00cd00;">"-is-suffix-p"</span>
                            <span style="color: #00cd00;">"-is-suffix?"</span>
                            <span style="color: #00cd00;">"-is-infix-p"</span>
                            <span style="color: #00cd00;">"-is-infix?"</span>
                            <span style="color: #00cd00;">"-sort"</span>
                            <span style="color: #00cd00;">"--sort"</span>
                            <span style="color: #00cd00;">"-list"</span>
                            <span style="color: #00cd00;">"-repeat"</span>
                            <span style="color: #00cd00;">"-sum"</span>
                            <span style="color: #00cd00;">"-product"</span>
                            <span style="color: #00cd00;">"-max"</span>
                            <span style="color: #00cd00;">"-min"</span>
                            <span style="color: #00cd00;">"-max-by"</span>
                            <span style="color: #00cd00;">"--max-by"</span>
                            <span style="color: #00cd00;">"-min-by"</span>
                            <span style="color: #00cd00;">"--min-by"</span>
                            <span style="color: #00cd00;">"-iterate"</span>
                            <span style="color: #00cd00;">"--iterate"</span>
                            <span style="color: #00cd00;">"-fix"</span>
                            <span style="color: #00cd00;">"--fix"</span>
                            <span style="color: #00cd00;">"-unfold"</span>
                            <span style="color: #00cd00;">"--unfold"</span>
                            <span style="color: #00cd00;">"-cons-pair?"</span>
                            <span style="color: #00cd00;">"-cons-to-list"</span>
                            <span style="color: #00cd00;">"-value-to-list"</span>
                            <span style="color: #00cd00;">"-tree-mapreduce-from"</span>
                            <span style="color: #00cd00;">"--tree-mapreduce-from"</span>
                            <span style="color: #00cd00;">"-tree-mapreduce"</span>
                            <span style="color: #00cd00;">"--tree-mapreduce"</span>
                            <span style="color: #00cd00;">"-tree-map"</span>
                            <span style="color: #00cd00;">"--tree-map"</span>
                            <span style="color: #00cd00;">"-tree-reduce-from"</span>
                            <span style="color: #00cd00;">"--tree-reduce-from"</span>
                            <span style="color: #00cd00;">"-tree-reduce"</span>
                            <span style="color: #00cd00;">"--tree-reduce"</span>
                            <span style="color: #00cd00;">"-tree-seq"</span>
                            <span style="color: #00cd00;">"--tree-seq"</span>
                            <span style="color: #00cd00;">"-tree-map-nodes"</span>
                            <span style="color: #00cd00;">"--tree-map-nodes"</span>
                            <span style="color: #00cd00;">"-clone"</span>
                            <span style="color: #00cd00;">"-rpartial"</span>
                            <span style="color: #00cd00;">"-juxt"</span>
                            <span style="color: #00cd00;">"-applify"</span>
                            <span style="color: #00cd00;">"-on"</span>
                            <span style="color: #00cd00;">"-flip"</span>
                            <span style="color: #00cd00;">"-const"</span>
                            <span style="color: #00cd00;">"-cut"</span>
                            <span style="color: #00cd00;">"-orfn"</span>
                            <span style="color: #00cd00;">"-andfn"</span>
                            <span style="color: #00cd00;">"-iteratefn"</span>
                            <span style="color: #00cd00;">"-fixfn"</span>
                            <span style="color: #00cd00;">"-prodfn"</span>
                            ))
            (special-variables '(
                                 <span style="color: #00cd00;">"it"</span>
                                 <span style="color: #00cd00;">"it-index"</span>
                                 <span style="color: #00cd00;">"acc"</span>
                                 <span style="color: #00cd00;">"other"</span>
                                 )))
        (font-lock-add-keywords 'emacs-lisp-mode `((,(concat <span style="color: #00cd00;">"\\_&lt;"</span> (regexp-opt special-variables 'paren) <span style="color: #00cd00;">"\\_&gt;"</span>)
                                                     1 font-lock-variable-name-face)) 'append)
        (font-lock-add-keywords 'emacs-lisp-mode `((,(concat <span style="color: #00cd00;">"(\\s-*"</span> (regexp-opt new-keywords 'paren) <span style="color: #00cd00;">"\\_&gt;"</span>)
                                                     1 font-lock-keyword-face)) 'append))
      (--each (buffer-list)
       (<span style="color: #00cdcd; font-weight: bold;">with-current-buffer</span> it
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (and (eq major-mode 'emacs-lisp-mode)
                    (boundp 'font-lock-mode)
                    font-lock-mode)
           (font-lock-refresh-defaults)))))))

(<span style="color: #00cdcd; font-weight: bold;">provide</span> '<span style="color: #cd00cd;">dash</span>)
<span style="color: #cd0000;">;;; </span><span style="color: #cd0000;">dash.el ends here</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="m_util">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;m_util_contents&gt;&gt;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="m_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">!cons</span> (car cdr)
  <span style="color: #00cd00;">"Destructive: Set CDR to the cons of CAR and CDR."</span>
  `(setq ,cdr (cons ,car ,cdr)))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">!cdr</span> (list)
  <span style="color: #00cd00;">"Destructive: Set LIST to the cdr of LIST."</span>
  `(setq ,list (cdr ,list)))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--each</span> (list <span style="color: #00cd00;">&amp;rest</span> body)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-each</span><span style="color: #00cd00;">'."</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(declare (debug (form body))</span>
  <span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(indent 1))</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((l (make-symbol <span style="color: #00cd00;">"list"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,l ,list)
           (it-index 0))
       (<span style="color: #00cdcd; font-weight: bold;">while</span> ,l
         (<span style="color: #00cdcd; font-weight: bold;">let</span> ((it (car ,l)))
           ,@body)
         (setq it-index (1+ it-index))
         (!cdr ,l)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-each</span> (list fn)
  <span style="color: #00cd00;">"Call FN with every item in LIST. Return nil, used for side-effects only."</span>
  (--each list (funcall fn it)))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--map-when</span> (pred rep list)
  <span style="color: #00cd00;">"Anaphoric form of `</span><span style="color: #cd00cd;">-map-when</span><span style="color: #00cd00;">'."</span>
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(declare (debug (form form form)))</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (make-symbol <span style="color: #00cd00;">"result"</span>)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> (,r)
       (--each ,list (!cons (<span style="color: #00cdcd; font-weight: bold;">if</span> ,pred ,rep it) ,r))
       (nreverse ,r))))


(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">-map-when</span> (pred rep list)
  <span style="color: #00cd00;">"Return a new list where the elements in LIST that does not match the PRED function</span>
<span style="color: #00cd00;">     are unchanged, and where the elements in LIST that do match the PRED function are mapped</span>
<span style="color: #00cd00;">     through the REP function.</span>

<span style="color: #00cd00;">     Alias: `</span><span style="color: #cd00cd;">-replace-where</span><span style="color: #00cd00;">'</span>

<span style="color: #00cd00;">     See also: `</span><span style="color: #cd00cd;">-update-at</span><span style="color: #00cd00;">'"</span>
  (--map-when (funcall pred it) (funcall rep it) list))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-&gt;</span> (x <span style="color: #00cd00;">&amp;optional</span> form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"Thread the expr through the forms. Insert X as the second item</span>
<span style="color: #00cd00;">in the first form, making a list of it if it is not a list</span>
<span style="color: #00cd00;">already. If there are more forms, insert the first form as the</span>
<span style="color: #00cd00;">second item in second form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((null form) x)
    ((null more) (<span style="color: #00cdcd; font-weight: bold;">if</span> (listp form)
                     `(,(car form) ,x ,@(cdr form))
                     (list form x)))
    (<span style="color: #0000ee; font-weight: bold;">:else</span> `(-&gt; (-&gt; ,x ,form) ,@more))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(-&gt; 5 1- ODDP)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (-&gt; (-&gt; 5 1-) ODDP)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (ODDP (-&gt; 5 1-))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (ODDP (1- 5))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(sb-cltl2:macroexpand-all '(-&gt; 'first (cons 'second) (cons 'third)))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (CONS (CONS 'FIRST 'SECOND) 'THIRD)</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-&gt;&gt;</span> (x <span style="color: #00cd00;">&amp;optional</span> form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"Thread the expr through the forms. Insert X as the last item</span>
<span style="color: #00cd00;">in the first form, making a list of it if it is not a list</span>
<span style="color: #00cd00;">already. If there are more forms, insert the first form as the</span>
<span style="color: #00cd00;">last item in second form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((null form) x)
    ((null more) (<span style="color: #00cdcd; font-weight: bold;">if</span> (listp form)
                     `(,@form ,x)
                     (list form x)))
    (<span style="color: #0000ee; font-weight: bold;">:else</span> `(-&gt;&gt; (-&gt;&gt; ,x ,form) ,@more))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(sb-cltl2:macroexpand-all '(-&gt;&gt; 'first (cons 'second) (cons 'third)))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">=&gt; (CONS 'THIRD (CONS 'SECOND 'FIRST))</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">--&gt;</span> (x form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"Thread the expr through the forms. Insert X at the position</span>
<span style="color: #00cd00;">signified by the token `</span><span style="color: #cd00cd;">it</span><span style="color: #00cd00;">' in the first form. If there are more</span>
<span style="color: #00cd00;">forms, insert the first form at the position signified by `</span><span style="color: #cd00cd;">it</span><span style="color: #00cd00;">' in</span>
<span style="color: #00cd00;">in second form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (null more)
      (<span style="color: #00cdcd; font-weight: bold;">if</span> (listp form)
          (--map-when (eq it 'it) x form)
          (list form x))
      `(--&gt; (--&gt; ,x ,form) ,@more)))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-some-&gt;</span> (x <span style="color: #00cd00;">&amp;optional</span> form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"When expr is non-nil, thread it through the first form (via `</span><span style="color: #cd00cd;">-&gt;</span><span style="color: #00cd00;">'),</span>
<span style="color: #00cd00;">     and when that result is non-nil, through the next form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (null form) x
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (make-symbol <span style="color: #00cd00;">"result"</span>)))
        `(-some-&gt; (-when-let (,result ,x)
                    (-&gt; ,result ,form))
                  ,@more))))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-some-&gt;&gt;</span> (x <span style="color: #00cd00;">&amp;optional</span> form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"When expr is non-nil, thread it through the first form (via `</span><span style="color: #cd00cd;">-&gt;&gt;</span><span style="color: #00cd00;">'),</span>
<span style="color: #00cd00;">     and when that result is non-nil, through the next form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (null form) x
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (make-symbol <span style="color: #00cd00;">"result"</span>)))
        `(-some-&gt;&gt; (-when-let (,result ,x)
                     (-&gt;&gt; ,result ,form))
                   ,@more))))


(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">-some--&gt;</span> (x <span style="color: #00cd00;">&amp;optional</span> form <span style="color: #00cd00;">&amp;rest</span> more)
  <span style="color: #00cd00;">"When expr in non-nil, thread it through the first form (via `</span><span style="color: #cd00cd;">--&gt;</span><span style="color: #00cd00;">'),</span>
<span style="color: #00cd00;">     and when that result is non-nil, through the next form, etc."</span>
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (null form) x
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (make-symbol <span style="color: #00cd00;">"result"</span>)))
        `(-some--&gt; (-when-let (,result ,x)
                     (--&gt; ,result ,form))
                   ,@more))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Фунциональные утилиты</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

&lt;&lt;f_util_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-8-2-1" class="outline-4">
<h4 id="sec-8-2-1"><span class="section-number-4">8.2.1</span> Point-free определения:</h4>
<div class="outline-text-4" id="text-8-2-1">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define</span> (form* form)
  (<span style="color: #00cdcd; font-weight: bold;">etypecase</span> form*
    (symbol (<span style="color: #00cdcd; font-weight: bold;">etypecase</span> form
              <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">alias for function or macro</span>
              (symbol `(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> ,form* (<span style="color: #00cd00;">&amp;rest</span> args)
                         `(,',form ,@args)))
              <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">alias for lambda</span>
              (cons   `(<span style="color: #00cdcd; font-weight: bold;">defun</span> ,form* (<span style="color: #00cd00;">&amp;rest</span> args)
                         (apply ,form args)))))
    (cons     <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">scheme-like function definition</span>
     ` (<span style="color: #00cdcd; font-weight: bold;">defun</span> ,(first form*) ,(rest form*)
         ,form))))
</pre>
</div>

<p>
Тут typecase используется до генерации кода - в зависимости от того символы или списки
связываются друг с другом генерируются различные определения. Можно определять
псевдонимы для функций и маросов, псевдоним будет макросом:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define head car)
(define tail cdr)
(define \\   lambda)
(define $    funcall)
</pre>
</div>

<p>
Можно определить функцию f2, которая является псевдонимом для лямбды, возвращённой
формой (f1 a1):
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define f2 (f1 a1))
(f2 a2) ~ (apply (f1 a1) a2)
</pre>
</div>

<p>
Простое определение функций в Scheme-стиле, более соответствующее представлению о
редукции форм:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define (f1 a1) (f2 a2))
(f1 a1) ~ (<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">f1</span> (a1) (f2 a2))
</pre>
</div>

<p>
Также, чтобы определять функции миксующую аргументы с другой функцией, можно ввести
такой макрос:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define*</span> (form* form)
  `(<span style="color: #00cdcd; font-weight: bold;">defun</span> ,(first form*) ,(rest form*)
     (,(first form) ,@(rest form) ,@(rest form*))))
</pre>
</div>

<p>
Пример:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define* (f1 a1) (f2 a2))
(f1 a1) ~ (f2 a2 a1)
</pre>
</div>

<p>
Либо использовать карринг.
</p>
</div>
</div>

<div id="outline-container-sec-8-2-2" class="outline-4">
<h4 id="sec-8-2-2"><span class="section-number-4">8.2.2</span> Flip, карринг, композиции:</h4>
<div class="outline-text-4" id="text-8-2-2">
<p>
далее f, g, &#x2026; обозначают функции,
a, b, &#x2026; - их аргументы.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define (self object) object)
(define (flip f)      (\\ (a b) ($ f b a)))
(define (curry f a)   (\\ (b)   ($ f a b)))
(define (curry* f g)  (\\ (a b) ($ f g a b)))
(define (compose f g) (\\ (a)   ($ f ($ g a))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-3" class="outline-4">
<h4 id="sec-8-2-3"><span class="section-number-4">8.2.3</span> Свёртки и "развёртки":</h4>
<div class="outline-text-4" id="text-8-2-3">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(define (foldl f a list)
    (<span style="color: #00cdcd; font-weight: bold;">typecase</span> list
      (null a)
      (cons (foldl f ($ f a (head list)) (tail list)))))

(define (foldr f a list)
    (<span style="color: #00cdcd; font-weight: bold;">typecase</span> list
      (null a)
      (cons ($ f (head list) (foldr f a (tail list))))))

(define (unfold f i p)
    (<span style="color: #00cdcd; font-weight: bold;">if</span> ($ p i)
        (cons i '())
        (cons i (unfold f ($ f i) p))))

(define fold foldl)
(define my-reduce fold)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-4" class="outline-4">
<h4 id="sec-8-2-4"><span class="section-number-4">8.2.4</span> Отображения и фильтрации:</h4>
<div class="outline-text-4" id="text-8-2-4">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">map &amp; filter</span>
(define (my-map f list) (foldr (\\ (x y) (cons ($ f x) y)) '() list))
(define (filter p list) (foldr (\\ (x y) (<span style="color: #00cdcd; font-weight: bold;">if</span> ($ p x) (cons x y) y)) '() list))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-5" class="outline-4">
<h4 id="sec-8-2-5"><span class="section-number-4">8.2.5</span> Функции для списков на основе карринга и свёрток:</h4>
<div class="outline-text-4" id="text-8-2-5">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">functions for lists</span>
(define (my-list <span style="color: #00cd00;">&amp;rest</span> objs)         objs)
(define (my-length list)             (fold (\\ (x y) (1+ x)) 0 list))
(define (my-reverse list)            (fold (flip 'cons) '() list))
(define (my-append list <span style="color: #00cd00;">&amp;rest</span> lists) (fold (flip (curry* 'foldr 'cons)) list lists))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-6" class="outline-4">
<h4 id="sec-8-2-6"><span class="section-number-4">8.2.6</span> Функции для чисел:</h4>
<div class="outline-text-4" id="text-8-2-6">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">functions for numbers</span>
(define zero?                    (curry '= 0))
(define positive?                (curry '&lt; 0))
(define negative?                (curry '&gt; 0))
(define (odd? number)            (= (mod number 2) 1))
(define (even? number)           (= (mod number 2) 0))
(define (my-max a <span style="color: #00cd00;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #00cdcd; font-weight: bold;">if</span> (&gt; y z) y z)) a numbers))
(define (my-min a <span style="color: #00cd00;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #00cdcd; font-weight: bold;">if</span> (&lt; y z) y z)) a numbers))
(define (summa <span style="color: #00cd00;">&amp;rest</span> numbers)    (fold '+ 0 numbers))
(define (product <span style="color: #00cd00;">&amp;rest</span> numbers)  (fold '* 1 numbers))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-7" class="outline-4">
<h4 id="sec-8-2-7"><span class="section-number-4">8.2.7</span> И для булевых чисел:</h4>
<div class="outline-text-4" id="text-8-2-7">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">functions for booleans</span>
(define (my-and <span style="color: #00cd00;">&amp;rest</span> list)   (fold 'and t list))
(define (my-or <span style="color: #00cd00;">&amp;rest</span> list)    (fold 'or nil list))
(define (any? p <span style="color: #00cd00;">&amp;rest</span> list)   (apply 'my-or (my-map p list)))
(define (every? p <span style="color: #00cd00;">&amp;rest</span> list) (apply 'my-and (my-map p list)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-8" class="outline-4">
<h4 id="sec-8-2-8"><span class="section-number-4">8.2.8</span> Многие другие функции представляются свёртками, например:</h4>
<div class="outline-text-4" id="text-8-2-8">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">member &amp; assoc</span>
(<span style="color: #00cdcd; font-weight: bold;">flet</span> ((helper (p op)
         (\\ (a next) (<span style="color: #00cdcd; font-weight: bold;">if</span> (and (not a) ($ p ($ op next))) next a))))

  (define (my-member object list <span style="color: #00cd00;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'self) nil list))

  (define (my-assoc object alist <span style="color: #00cd00;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'car) nil alist)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2-9" class="outline-4">
<h4 id="sec-8-2-9"><span class="section-number-4">8.2.9</span> Свёртки для деревьев:</h4>
<div class="outline-text-4" id="text-8-2-9">
<p>
Теперь, собственно, код для деревьев. Нужно заметить, что учитывая весь код для
"абстракций", получается существенно меньше, чем при реализации "в лоб" (как у Грэхама,
например).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">for (1 . (2 . 3)) trees</span>

(define (my-append a b)
    (append (<span style="color: #00cdcd; font-weight: bold;">if</span> (atom a) (list a) a)
            (<span style="color: #00cdcd; font-weight: bold;">if</span> (atom b) (list b) b)))

(define (fold-tree f g tree)
    (<span style="color: #00cdcd; font-weight: bold;">typecase</span> tree
      (atom ($ f tree))
      (cons ($ g (fold-tree f g (head tree))
               (fold-tree f g (tail tree))))))

(define* (summa/tree tree) (fold-tree 'self '+))
(define* (depth/tree tree) (fold-tree 'one 'max+1))
(define* (flatten tree)    (fold-tree 'self 'my-append))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Другие утилиты</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun my-range (n)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(let ((i 0))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">#'(lambda ()</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">(if (&lt; i n) (incf i) nil))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(let ((f (my-range 3)))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(list</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(funcall f)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(funcall f)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(funcall f)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(funcall f)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(funcall f)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(range 3)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro do-closure ((i clos) &amp;body body)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(let ((c (gensym)))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">`(let ((,c ,clos))</span>
<span style="color: #cd0000;">;;        </span><span style="color: #cd0000;">(loop for ,i = (funcall ,c)</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">while ,i do ,@body))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(do-closure (i (my-range 100)) (print i))</span>


(<span style="color: #00cdcd; font-weight: bold;">declaim</span> (<span style="color: #00cdcd; font-weight: bold;">inline</span> zip))
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">zip</span> (<span style="color: #00cd00;">&amp;rest</span> args)
  <span style="color: #00cd00;">"</span>
<span style="color: #00cd00;">Zips the elements of @arg{args}.</span>
<span style="color: #00cd00;">Example:</span>
<span style="color: #00cd00;">@lisp</span>
<span style="color: #00cd00;">&gt; (zip '(2 3 4) '(a b c) '(j h c s))</span>
<span style="color: #00cd00;">=&gt; ((2 A J) (3 B H) (4 C C))</span>
<span style="color: #00cd00;">@end lisp</span>
<span style="color: #00cd00;">"</span>
  (apply #'map 'list #'list args))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">symstuff</span> (l)
  <span style="color: #00cd00;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html</span>
<span style="color: #00cd00;">Helper function to (build-symbol)"</span>
  `(concatenate 'string
                ,@(for (x <span style="color: #0000ee; font-weight: bold;">:in</span> l)
                       (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((stringp x)
                              `',x)
                             ((atom x)
                              `',(format nil <span style="color: #00cd00;">"~a"</span> x))
                             ((eq (car x) '<span style="color: #0000ee; font-weight: bold;">:&lt;</span>)
                              `(format nil <span style="color: #00cd00;">"~a"</span> ,(cadr x)))
                             ((eq (car x) '<span style="color: #0000ee; font-weight: bold;">:++</span>)
                              `(format nil <span style="color: #00cd00;">"~a"</span> (incf ,(cadr x))))
                             (t
                              `(format nil <span style="color: #00cd00;">"~a"</span> ,x))))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">build-symbol</span> (<span style="color: #00cd00;">&amp;rest</span> l)
  <span style="color: #00cd00;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((p (find-if (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x) (and (consp x) (eq (car x) '<span style="color: #0000ee; font-weight: bold;">:package</span>)))
                    l)))
    (<span style="color: #00cdcd; font-weight: bold;">cond</span> (p
           (setq l (remove p l))))
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((pkg (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((eq (cadr p) 'nil)
                      nil)
                     (t `(find-package ',(cadr p))))))
      (<span style="color: #00cdcd; font-weight: bold;">cond</span> (p
             (<span style="color: #00cdcd; font-weight: bold;">cond</span> (pkg
                    `(values (intern ,(symstuff l) ,pkg)))
                   (t
                    `(make-symbol ,(symstuff l)))))
            (t
             `(values (intern ,(symstuff l))))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">remove-nth</span> (n seq)
  <span style="color: #00cd00;">"Remove nth element from sequence"</span>
  (remove-if (constantly t) seq <span style="color: #0000ee; font-weight: bold;">:start</span> n <span style="color: #0000ee; font-weight: bold;">:count</span> 1))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">make-hash</span> (<span style="color: #00cd00;">&amp;rest</span> keyvals)
  <span style="color: #00cd00;">"Create a hash table given keys and values"</span>
  (plist-hash-table keyvals))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">make-hash*</span> (<span style="color: #00cd00;">&amp;rest</span> keyvals)
  <span style="color: #00cd00;">"Make a hash table given key/value pairs, allowing use of prior key/val pairs in late r definitions"</span>
  (<span style="color: #00cdcd; font-weight: bold;">loop</span> while keyvals
     for k = (intern (symbol-name (pop keyvals)))
     for v = (pop keyvals)
     collect `(,k ,v) into letargs
     collect (make-keyword k) into objargs
     collect k into objargs
     finally (<span style="color: #00cdcd; font-weight: bold;">return</span>
               `(<span style="color: #00cdcd; font-weight: bold;">let*</span> (,@letargs)
                  (make-hash ,@objargs)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">maphash2</span> (fn ht)
  <span style="color: #00cd00;">"Returns a hash-table with the results of the function of key &amp; value as values"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((ht-out (make-hash-table
                 <span style="color: #0000ee; font-weight: bold;">:test</span> (hash-table-test ht)
                 <span style="color: #0000ee; font-weight: bold;">:size</span> (hash-table-size ht)
                 <span style="color: #0000ee; font-weight: bold;">:rehash-size</span> (hash-table-rehash-size ht)
                 <span style="color: #0000ee; font-weight: bold;">:rehash-threshold</span> (hash-table-rehash-threshold ht))))
    (maphash #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (k v)
                 (setf (gethash k ht-out) (funcall fn k v)))
             ht)
    ht-out))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">maphash-values2</span> (fn ht)
  <span style="color: #00cd00;">"Returns a hash-table with the results of the function of value as values"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((ht-out (make-hash-table)))
    (maphash #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (k v) (setf (gethash k ht-out) (funcall fn v))) ht)
    ht-out))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">swap</span> (pl1 pl2)
  <span style="color: #00cd00;">"Macro to swap two places"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((temp1-name (gensym)) <span style="color: #cd0000;">; </span><span style="color: #cd0000;">don't clobber existing names</span>
        (temp2-name (gensym)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,temp1-name ,pl1)
           (,temp2-name ,pl2))
       (setf ,pl1 ,temp2-name)
       (setf ,pl2 ,temp1-name))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">print-hash-key-or-val</span> (kv stream)
  (format stream (<span style="color: #00cdcd; font-weight: bold;">typecase</span> kv
                   (keyword <span style="color: #00cd00;">" :~a"</span>)
                   (string <span style="color: #00cd00;">" \"~a\""</span>)
                   (symbol <span style="color: #00cd00;">" '~a"</span>)
                   (list <span style="color: #00cd00;">" '~a"</span>)
                   (t <span style="color: #00cd00;">" ~a"</span>)) kv))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">printhash</span> (h <span style="color: #00cd00;">&amp;optional</span> (stream t))
  <span style="color: #00cd00;">"Pretty print a hash table as :KEY VAL on separate lines"</span>
  (format stream <span style="color: #00cd00;">"#&lt;HASH-TABLE~{~a~a~^~&amp;~}&gt;"</span>
          (<span style="color: #00cdcd; font-weight: bold;">loop</span> for k being the hash-keys in h using (hash-value v)
             collect (print-hash-key-or-val k nil)
             collect (print-hash-key-or-val v nil))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">lethash</span> (keys h <span style="color: #00cd00;">&amp;body</span> body)
  <span style="color: #00cd00;">"Let form binding hash table entries to let variables names"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((ht (gensym)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,ht ,h))
       (<span style="color: #00cdcd; font-weight: bold;">let</span> ,(<span style="color: #00cdcd; font-weight: bold;">loop</span> for key in keys
                collect `(,key (gethash ,(make-keyword key) ,ht)))
         ,@body))))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-keys</span> (keys h <span style="color: #00cd00;">&amp;body</span> body)
  <span style="color: #00cd00;">"Make keys of hash table available to body for use &amp; changable via setf"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((ht (gensym)))
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> for key in keys
       for newbody = (subst `(gethash ,(make-keyword key) ,ht) key body)
       then (subst `(gethash ,(make-keyword key) ,ht) key newbody)
       finally (<span style="color: #00cdcd; font-weight: bold;">return</span> `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,ht ,h))
                          ,@newbody)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">linear-interpolation</span> (ys xs x)
  <span style="color: #00cd00;">"Linear interpolation: calculate y(x) at x given table of ys and xs. Also returns ind ex of lookup table interval. Works from first x to less than last x."</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((i (position x xs <span style="color: #0000ee; font-weight: bold;">:test</span> #'&gt;= <span style="color: #0000ee; font-weight: bold;">:from-end</span> t))
         (x0 (elt xs i))
         (x1 (elt xs (1+ i)))
         (y0 (elt ys i))
         (y1 (elt ys (1+ i))))
    (+ y0 (* (- y1 y0) (- x x0) (/ (- x1 x0))))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">maptree</span> (f tree)
  <span style="color: #00cd00;">"Map a function on the leaves of a tree"</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((null tree) nil)
    ((atom tree) (funcall f tree))
    (t (cons (maptree f (car tree))
             (maptree f (cdr tree))))))

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">diff</span> ((l list))
  <span style="color: #00cd00;">"Return list of the 1st differences of given list: l(1)-l(0),...,l(n)-l(n-1)"</span>
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> for i below (1- (length l))
       for li in l
       collect (- (elt l (1+ i)) li)))

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">diff</span> ((v vector))
  <span style="color: #00cd00;">"Return vector of the 1st differences of given vector: v(1)-v(0),...,v(n)-v(n-1)"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((n (length v))
         (v2 (make-array (1- n))))
    (<span style="color: #00cdcd; font-weight: bold;">dotimes</span> (i (1- n))
      (setf (aref v2 i) (- (aref v (1+ i)) (aref v i))))
    v2))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">slot-ref</span> (obj slots)
  <span style="color: #00cd00;">"Reference nested objects by a list of successive slot names. For example, (slot-ref  o 'foo 'bar 'baz) should return (slot-value (slot-value (slot-value o 'foo) 'bar) 'baz) "</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((atom slots) (slot-value obj slots))
    ((null (cdr slots)) (slot-value obj (car slots)))
    (t (slot-ref (slot-value obj (first slots)) (rest slots)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">slot-ref-set</span> (obj slots val)
  <span style="color: #00cd00;">"Set nested object slot reference to new value"</span>
  (<span style="color: #00cdcd; font-weight: bold;">cond</span>
    ((atom slots) (setf (slot-value obj slots) val))
    ((null (cdr slots)) (setf (slot-value obj (car slots)) val))
    (t (slot-ref-set (slot-value obj (first slots)) (rest slots) val))))

(<span style="color: #00cdcd; font-weight: bold;">defsetf</span> <span style="color: #0000ee; font-weight: bold;">slot-ref</span> slot-ref-set)

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">bind-nested-slots</span> (forms obj <span style="color: #00cd00;">&amp;body</span> body)
  <span style="color: #00cd00;">"For each form of (VAR SLOT1 SLOT2 ...) bind VAR to (NESTED-SLOT OBJ SLOT1 SLOT2 ...) "</span>
  `(<span style="color: #00cdcd; font-weight: bold;">let</span> ,(<span style="color: #00cdcd; font-weight: bold;">loop</span> for form in forms
            collect `(,(first form) (slot-ref ,obj ',(rest form))))
     ,@body))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">defpfun</span> (name args pargs <span style="color: #00cd00;">&amp;body</span> body)
  <span style="color: #00cd00;">"Define pandoric function given name, arguments, pandoric arguments,</span>
<span style="color: #00cd00;">&amp; body forms."</span>
  `(setf (symbol-function ',name)
         (plambda ,args ,pargs
                  ,@body)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> Утилиты</h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-lisp" id="utility_file">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*user-agent*</span> <span style="color: #00cd00;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*cookies*</span>
  (list <span style="color: #00cd00;">"portal_tid=1291969547067-10909"</span>
        <span style="color: #00cd00;">"__utma=189530924.115785001.1291969547.1297497611.1297512149.377"</span>
        <span style="color: #00cd00;">"__utmc=3521885"</span>))

(setf *drakma-default-external-format* <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-headers</span> (referer)
  `(
    (<span style="color: #00cd00;">"Accept"</span> . <span style="color: #00cd00;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
    (<span style="color: #00cd00;">"Accept-Language"</span> . <span style="color: #00cd00;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
    (<span style="color: #00cd00;">"Accept-Charset"</span> . <span style="color: #00cd00;">"utf-8"</span>)
    (<span style="color: #00cd00;">"Referer"</span> . ,referer)
    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">("Cookie" . ,(format nil "~{~a; ~}" *cookies*))</span>
    (<span style="color: #00cd00;">"Cookie"</span> . <span style="color: #00cd00;">"ad20c=2; ad17c=2; __utma=48706362.2093251633.1396569814.1413985658.1413990550.145; __utmz=48706362.1413926450.142.18.utmcsr=vk.com|utmccn=(referral)|utmcmd=referral|utmcct=/im; email=avenger-f%40yandex.ru; password=30e3465569cc7433b34d42baeadff18f; PHPSESSID=ms1rrsgjqvm3lhdl5af1aekvv0; __utmc=48706362; __utmb=48706362.5.10.1413990550"</span>)
    ))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">web</span> (to ot)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((x-to (append '(format nil) to))
        (x-ot (append '(format nil) ot)))
    `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((r (sb-ext:octets-to-string
               (drakma:http-request ,x-to
                                    <span style="color: #0000ee; font-weight: bold;">:user-agent</span> *user-agent*
                                    <span style="color: #0000ee; font-weight: bold;">:additional-headers</span> (get-headers ,x-ot)
                                    <span style="color: #0000ee; font-weight: bold;">:redirect</span> 10
                                    <span style="color: #0000ee; font-weight: bold;">:force-binary</span> t)
               <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:utf-8</span>)))
       r)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">fnd</span> (var pattern)
  `(<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (all matches)
       (ppcre:scan-to-strings ,pattern ,var)
     (<span style="color: #00cdcd; font-weight: bold;">let</span> ((str (format nil <span style="color: #00cd00;">"~a"</span> matches)))
       (subseq str 2 (- (length str) 1)))))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">merge-plists</span> (<span style="color: #00cd00;">&amp;rest</span> plists)
  <span style="color: #00cd00;">"Merge all the given plists into a new plist. The new plist has all</span>
<span style="color: #00cd00;">the keys from each plist, with values of keys in later lists</span>
<span style="color: #00cd00;">overriding the values of the same keys in earlier plists.</span>
<span style="color: #00cd00;">No particular order of key/value pairs is guaranteed.</span>
<span style="color: #00cd00;">E.g.:</span>
<span style="color: #00cd00;">&gt; (merge-plists '(:a 1 :b 2) '(:a 3 :c 4) '(:d 5))</span>
<span style="color: #cd0000; font-weight: bold;">(</span><span style="color: #00cd00;">:D 5 :C 4 :A 3 :B 2)"</span>
(<span style="color: #00cdcd; font-weight: bold;">let</span> ((result (copy-list (first plists))))
  (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (plist (rest plists))
    (<span style="color: #00cdcd; font-weight: bold;">do*</span> ((prop (first plist) (first plist))
          (value (second plist) (second plist))
          (oldpl plist plist)
          (plist plist (cddr plist)))
         ((not oldpl))
      (setf (getf result prop) value)))
  result))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">eval-always</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">eval-always</span> (<span style="color: #00cd00;">&amp;body</span> body)
  <span style="color: #00cd00;">"Wrap &lt;_:arg body /&gt; in &lt;_:fun eval-when /&gt; with all keys \(compile, load and execute) mentioned"</span>
  `(<span style="color: #00cdcd; font-weight: bold;">eval-when</span> (<span style="color: #0000ee; font-weight: bold;">:compile-toplevel</span> <span style="color: #0000ee; font-weight: bold;">:load-toplevel</span> <span style="color: #0000ee; font-weight: bold;">:execute</span>)
     ,@body))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">#` syntax</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(eval-always</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(defun |#`-reader| (stream char arg)</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">"Literal syntax for zero/one/two argument lambdas.</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Use @ as the function's argument, % as the second.</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Examples:</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">CL-USER&gt; #`(+ 2 @)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">\(lambda (&amp;optional x y)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(+ 2 x))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">CL-USER&gt;  #`((1+ @) (print @))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">\(lambda (&amp;optional x y)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(1+ x)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(print x))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">CL-USER&gt; #`(+ 1 2)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">\(lambda (&amp;optional x y)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(+ 1 2))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">CL-USER&gt;  #`(+ @ %)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">\(lambda (&amp;optional x y)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">(+ x y))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">"</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(declare (ignore char arg))</span>
<span style="color: #cd0000;">;;     </span><span style="color: #cd0000;">(let ((sexp (read stream t nil t))</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(x (gensym "X"))</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(y (gensym "Y")))</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">`(lambda (&amp;optional ,x ,y)</span>
<span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">(declare (ignorable ,x)</span>
<span style="color: #cd0000;">;;                   </span><span style="color: #cd0000;">(ignorable ,y))</span>
<span style="color: #cd0000;">;;          </span><span style="color: #cd0000;">,@(subst y '%</span>
<span style="color: #cd0000;">;;                   </span><span style="color: #cd0000;">(subst x '@</span>
<span style="color: #cd0000;">;;                          </span><span style="color: #cd0000;">(if (listp (car sexp))</span>
<span style="color: #cd0000;">;;                              </span><span style="color: #cd0000;">sexp</span>
<span style="color: #cd0000;">;;                              </span><span style="color: #cd0000;">(list sexp)))))))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">;; set #`</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(set-dispatch-macro-character #\# #\` #'|#`-reader|))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">anaphoric</span>

(eval-always
 (<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">if-it</span> (test then <span style="color: #00cd00;">&amp;optional</span> else)
   <span style="color: #00cd00;">"Like IF. IT is bound to TEST."</span>
   `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((it ,test))
      (<span style="color: #00cdcd; font-weight: bold;">if</span> it ,then ,else))))

(eval-always
 (<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">when-it</span> (test <span style="color: #00cd00;">&amp;body</span> body)
   <span style="color: #00cd00;">"Like WHEN. IT is bound to TEST."</span>
   `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((it ,test))
      (<span style="color: #00cdcd; font-weight: bold;">when</span> it
        ,@body))))

(eval-always
 (<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">and-it</span> (<span style="color: #00cd00;">&amp;rest</span> args)
   <span style="color: #00cd00;">"Like AND. IT is bound to the value of the previous AND form."</span>
   (<span style="color: #00cdcd; font-weight: bold;">cond</span> ((null args) t)
         ((null (cdr args)) (car args))
         (t `(<span style="color: #00cdcd; font-weight: bold;">when-it</span> ,(car args) (and-it ,@(cdr args)))))))

(eval-always
 (<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">dowhile-it</span> (test <span style="color: #00cd00;">&amp;body</span> body)
   <span style="color: #00cd00;">"Like DOWHILE. IT is bound to TEST."</span>
   `(<span style="color: #00cdcd; font-weight: bold;">do</span> ((it ,test ,test))
        ((not it))
      ,@body)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(eval-always</span>
<span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">(defmacro cond-it (&amp;body body)</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">"Like COND. IT is bound to the passed COND test."</span>
<span style="color: #cd0000;">;;    </span><span style="color: #cd0000;">`(let (it)</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(cond</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">,@(mapcar #``((setf it ,(car @)) ,(cadr @))</span>
<span style="color: #cd0000;">;;                   </span><span style="color: #cd0000;">;; uses the fact, that SETF returns the value set</span>
<span style="color: #cd0000;">;;                   </span><span style="color: #cd0000;">body)))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">maybe</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">maybecall</span> (val <span style="color: #00cd00;">&amp;rest</span> funs)
  `(and-it ,val
           ,@(mapcar (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (fun)
                       `(funcall ,fun it))
                     funs)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">maybe</span> (form)
  <span style="color: #00cd00;">"Return a value, returned by a &lt;_:arg form /&gt; or nil, if &lt;_:class error /&gt; is signalled"</span>
  `(<span style="color: #00cdcd; font-weight: bold;">restart-case</span>
       (<span style="color: #00cdcd; font-weight: bold;">handler-bind</span> ((<span style="color: #cd0000; font-weight: bold;">error</span> #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (c)
                                 (<span style="color: #00cdcd; font-weight: bold;">declare</span> (ignore condition))
                                 (invoke-restart 'skip))))
         ,form)
     (skip () nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> Глобальные определения</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-lisp" id="globals">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">clear db</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(drop '("profile" "vacancy"))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6"><span class="section-number-3">8.6</span> Сущности и автоматы</h3>
<div class="outline-text-3" id="text-8-6">
<p>
Соберем все сущности и автоматы
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="entity_and_automates">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:moto</span>)
&lt;&lt;gen_automat(<span style="color: #00cd00;">"vacancy"</span>,     <span style="color: #00cd00;">"&#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span>,  vacancy_flds,      vacancy_state)&gt;&gt;
&lt;&lt;gen_automat(<span style="color: #00cd00;">"resume"</span>,      <span style="color: #00cd00;">"&#1088;&#1077;&#1079;&#1102;&#1084;&#1077;"</span>,    resume_flds,       vacancy_state)&gt;&gt;
&lt;&lt;gen_automat(<span style="color: #00cd00;">"rule"</span>,        <span style="color: #00cd00;">"&#1087;&#1088;&#1072;&#1074;&#1080;&#1083;&#1072;"</span>,   rule_flds,         rule_state)&gt;&gt;
&lt;&lt;gen_automat(<span style="color: #00cd00;">"srcaccount"</span>,  <span style="color: #00cd00;">"&#1072;&#1082;&#1082;&#1072;&#1091;&#1085;&#1090;&#1072;"</span>,  srcaccount_flds,   srcaccount_state)&gt;&gt;
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1042;&#1089;&#1087;&#1086;&#1084;&#1086;&#1075;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1099;&#1077; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1080; &#1088;&#1077;&#1079;&#1102;&#1084;&#1077;</span>
&lt;&lt;gen_entity(<span style="color: #00cd00;">"education"</span>, <span style="color: #00cd00;">"&#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1075;&#1086; &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;"</span>, education_flds)&gt;&gt;
&lt;&lt;gen_entity(<span style="color: #00cd00;">"lang"</span>, <span style="color: #00cd00;">"&#1103;&#1079;&#1099;&#1082;&#1072;"</span>, lang_flds)&gt;&gt;
&lt;&lt;gen_entity(<span style="color: #00cd00;">"expirience"</span>, <span style="color: #00cd00;">"&#1086;&#1087;&#1099;&#1090;&#1072; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099;"</span>, expirience_flds)&gt;&gt;
&lt;&lt;gen_entity(<span style="color: #00cd00;">"skill"</span>, <span style="color: #00cd00;">"&#1082;&#1083;&#1102;&#1095;&#1077;&#1074;&#1099;&#1093; &#1085;&#1072;&#1074;&#1099;&#1082;&#1086;&#1074;"</span>, skill_flds)&gt;&gt;
&lt;&lt;gen_entity(<span style="color: #00cd00;">"recommendation"</span>, <span style="color: #00cd00;">"&#1088;&#1077;&#1082;&#1086;&#1084;&#1077;&#1085;&#1076;&#1072;&#1094;&#1080;&#1080;"</span>, recommendation_flds)&gt;&gt;
&lt;&lt;gen_entity(<span style="color: #00cd00;">"portfolio"</span>, <span style="color: #00cd00;">"&#1087;&#1086;&#1088;&#1090;&#1092;&#1086;&#1083;&#1080;&#1086;"</span>, portfolio_flds)&gt;&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Lisp</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*num-sheep*</span> 4)
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*month-number*</span> 1)
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*moths-to-print*</span> 12)

(<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> month <span style="color: #0000ee; font-weight: bold;">:from</span> *month-number* <span style="color: #0000ee; font-weight: bold;">:to</span> *moths-to-print* <span style="color: #0000ee; font-weight: bold;">:with</span> current-sheep-count = *num-sheep* <span style="color: #0000ee; font-weight: bold;">:do</span>
   (setf current-sheep-count
         (* 4 current-sheep-count))
   (print (list month current-sheep-count)))
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2016-06-27 Пн. 15:20</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
