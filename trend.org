#+HTML_HEAD: -*- fill-column: 92 -*-

#+TITLE: Trend

#+NAME:css
#+BEGIN_HTML
<link rel="stylesheet" type="text/css" href="css/css.css" />
#+END_HTML

* Переделать

  Субсиди, ипотека и рассрочка должные отноститься не к очереди а к корпусу.

  одна и та же планировка может быть в двух очередях и даже в двух комплексах.

* Бизнес-процесс и цели

  Мы делаем сайт-аггрегатор всех квартир-новостроек в С-Пб.

  Есть застройщики, они строят и продают квартиры. Но для того чтобы реализовать объем квартир они
  не только используют свой отдел продаж, но и привлекают агенства реализации квартир за комиссию
  (агентское вознаграждение)

  Многие застройщики работают с 3-5 крупных агенств, которые в свою очередь привлекают других
  субагентов за комиссию.

  Цель сайта для нашей компании - инициировать обращение посетителя в компанию.

  Цель пользователя - найти квартиру под его возможности и потребности. На сайте пользователю
  предоставляется не вся информация по квартире, чтобы он имел стимул обратиться в нашу компанию,
  где его обработает менеджер по продажам.

  Посетитель на сайте выполняет поиск квартиры (основной пользовательский сценарий). Посетитель
  может выполнить расчет ипотеки, продать свою квартиру, заказать просмотр квартир итп
  (дополнительные сценарии).

  Цель сайта для менеджера - найти квартиру под любые параметры клиента и обеспечить ответ на
  любые вопросы клиента по застройщику и квартире.

  Причины обращений частных клиентов:
  - большой выбор и возможность получить ответы на все вопросы
  - ипотечный центр (берет на себя сложности с ипотекой)
  - показ квартир, который осуществляет компания:
    - индивидуальный показ (на автомобиле)
    - автобусные туры (срез по району) в выходные
  - реализация квартир клиентов (чтобы купить квартиру, клиенту иногда надо
    продать квартиру)
  - Люди не покупают квартиры с сайта. Им психологически сложно расстаться с такой большой суммой
    денег, поэтому они ищут иллюзии понимания этого рынка, которую предоставляет им менеджер
    компании.
  - Вторичку вообще продают через знакомых агентов. Поэтому практически единственное бизнес-value
    агенств вторички - широта связей их менеджеров. Все продается только через знакомых.

  Взаимодействие с застройщиками:
  - Застройщики регулярно отправляют информацию о объектах (или мы ее самостоятельно забираем). У
    поставщиков информация представлена в очень разных форматах. Мы конкурируем с отделом продаж
    застройщиков, поэтому они не заинтересованы предоставлять нам данные в нашем формате.
  - Небольшая часть застройщиков предоставляет данные через т.н. "агентский портал", куда
    менеджер компании может попасть по логину и паролю.
  - У ряда застройщиков есть достаточно актуальное наличие планировок на сайте.
  - Мы сопровождаем договора клиентов с застройщиком.

  Взаимодействие с агентствами:
  - Мы выступаем для суб-агентов в роли застройщика, отправляя им данные о квартирах.
  - Отдел диллерских продаж принимает обращения от агенств, бронируют квартиры.

  Стратегия: Сумма проданных компанией квартир = кол-во обращений клиентов компании * конверсия
  отдела продаж * кол-во менеджеров.

  Новый сайт необходим чтобы увеличить конверсию клик-обращение, и конверсию отдела продаж.

  Компания также хочет чтобы сайт был для пользователя более ценным чем сайты застройщиков, для
  этого планируются дополнительные сервисы - ипотечный калькулятор, расчет инвестиционной
  привлекательности, итп.

  Компания считает что сможет также сократить время обучения используя новый сайт.

  Какая-то часть обработки информации будет производиться контент-менеджерами вручную. Необходимо
  заложить возможности для них. Например: У застройщика есть базовая цена квартиры и регламент -
  как рассчитывать стоимость квартир, иногда очень сложный. Менеджер по развитию проектов должен
  иметь возможность создавать набор правил применяющихся в определенном порядке.

  Менеджер по продаже должен иметь возможность на странице квартиры накидать скидок (иногородний
  покупатель, итп), влиящих на цену квартиры. Это очень важное бизнес-требование.

  С точки зрения бизнес-процесса, продуктом компании яаляется специалист по недвижимости. Его
  время покупает клиент. Поэтому компания заинтересована:
  - Занять нишу ресурса, который позволяет выбрать квартиру в новостройке С-Пб.
  - Сэкономить на обучении специалистов.
  Основные проблемы на этом пути:
  - Товарная линейка ограничена
  - Актуальность данных
  - Юзабилити

* Пользователи и роли

  Пользователи объединены в роли по реализуемым на сайте сценариям. Некоторые сценарии
  являются общими для нескольких ролей, так например и =посетитель= и =менеджер= выполняют
  на сайте сценарии поиска квартир.

  Если кто-то логинится под логином и паролем под которым в данный момент сидит другой
  пользователь - реализуем перехват сессии - старый пользователь автоматически теряет
  сессию.

  Логин и пароль нужен и посетителю. Но он не будет регистрироваться, а скорее отправит на
  почту себе письмо со ссылкой на варианты которые он выбрал в избранном и сравнении.

  Роли и их типичные сценарии:
  - Посетитель
    - Поиск квартиры
    - Сравнение
    - Добавление в избранное
    - Печать
    - ...
  - Менеджер компании
    - Поиск квартиры
    - Сравнение
    - Добавление в избранное - избранное нужно как-то шарить клиенту.
    - Печать
    - ...
  - Контент-менеджер
    - Забивает информацию в базу
  - Менеджеры по развитию (продукт-менеджеры)
    - Создают правила расчета цен
    - Проверяют (пока раз в месяц) качество работы контент-менеджеров.
  - Менеджер субагента
    выпоняет примерно те же задачи что менеджер по продажам компании, но, возможно,
    использует
    меньше данных, чем сотрудник компании
  - Администратор сайта
    - Управляет пользователями
  - Робот
    - Загрузка данных со сторонних сайтов
    - Выгрузка данных на рекламные ресурсы

* Определения сущностей
** DONE Жилой комплекс (cmpx)

   Эта сущность нужна только чтобы объединять очереди жилого комплекса

   #+CAPTION: Данные жилого комплекса
   #+NAME: cmpx_data
     | field name  | field type           | note                 |
     |-------------+----------------------+----------------------|
     | id          | serial               | идентификатор        |
     | name        | varchar              | название             |
     | addr        | (or db-null varchar) | адрес                |
     | district-id | (or db-null integer) | идентификатор района |
     | metro-id    | (or db-null integer) | идентификатор метро  |


   #+NAME: cmpx_flds
   #+BEGIN_SRC emacs-lisp :var table=cmpx_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Очередь жилого комплекса (plex)

   #+CAPTION: Данные очереди жилого комплекса
   #+NAME: plex_data
     | field name  | field type           | note                           |
     |-------------+----------------------+--------------------------------|
     | id          | serial               | идентификатор                  |
     | cmpx-id     | integer              | идентификатор жилого комплекса |
     | name        | (or db-null varchar) | название                       |
     | distance    | (or db-null varchar) | расстояние до метро            |
     | deadline-id | (or db-null integer) | срок сдачи                     |
     | subsidy     | (or db-null boolean) | субсидия                       |
     | finishing   | (or db-null varchar) | отделка                        |
     | ipoteka     | (or db-null boolean) | ипотека                        |
     | installment | (or db-null boolean) | рассрочка                      |

   #+NAME: plex_flds
   #+BEGIN_SRC emacs-lisp :var table=plex_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Корпус очереди жилого комплекса (crps)

   #+CAPTION: Данные корпуса очереди жилого комплекса
   #+NAME: crps_data
     | field name | field type           | note                                   |
     |------------+----------------------+----------------------------------------|
     | id         | serial               | идентификатор                          |
     | plex-id    | integer              | идентификатор очереди жилого комплекса |
     | name       | (or db-null varchar) | название (номер корпуса)               |

   #+NAME: crps_flds
   #+BEGIN_SRC emacs-lisp :var table=crps_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Планировка (flat)

   #+CAPTION: Данные планировки
   #+NAME: flat_data
     | field name   | field type           | note                                           |
     |--------------+----------------------+------------------------------------------------|
     | id           | serial               | идентификатор                                  |
     | crps-id      | (or db-null integer) | идентификатор корпуса очереди жилого комплекса |
     | rooms        | (or db-null integer) | кол-во комнат                                  |
     | area-sum     | (or db-null varchar) | общая площадь квартиры (может быть дробное)    |
     | area-living  | (or db-null varchar) | жилая площадь квартиры (именно varchar)        |
     | area-kitchen | (or db-null varchar) | площадь кухни (может быть дробное)             |
     | price        | (or db-null integer) | цена                                           |
     | balcon       | (or db-null varchar) | балкон/лоджия                                  |
     | sanuzel      | (or db-null boolean) | Санузел раздельный/совмещенный                 |

   #+NAME: flat_flds
   #+BEGIN_SRC emacs-lisp :var table=flat_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Город (city)

   Город в котором находится объект

   #+CAPTION: Данные города
   #+NAME: city_data
     | field name | field type | note            |
     |------------+------------+-----------------|
     | id         | serial     | идентификатор   |
     | name       | varchar    | название города |

   #+NAME: city_flds
   #+BEGIN_SRC emacs-lisp :var table=city_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Район (district)

   Район города, в котором находится объект

   #+CAPTION: Данные района
   #+NAME: district_data
     | field name  | field type | note                                     |
     |-------------+------------+------------------------------------------|
     | id          | serial     | идентификатор                            |
     | name        | varchar    | название района |

   #+NAME: district_flds
   #+BEGIN_SRC emacs-lisp :var table=district_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Метро (metro)

   Метро неподалеку от объекта

   #+CAPTION: Данные метро
   #+NAME: metro_data
     | field name | field type | note             |
     |------------+------------+------------------|
     | id         | serial     | идентификатор    |
     | name       | varchar    | название станции |

   #+NAME: metro_flds
   #+BEGIN_SRC emacs-lisp :var table=metro_data :results value :exports none :session gen
     table
   #+END_SRC

** DONE Сроки сдачи (deadline)

   Сроки сдачи объектов

   #+CAPTION: Данные метро
   #+NAME: deadline_data
     | field name | field type | note             |
     |------------+------------+------------------|
     | id         | serial     | идентификатор    |
     | name       | varchar    | название станции |

   #+NAME: deadline_flds
   #+BEGIN_SRC emacs-lisp :var table=deadline_data :results value :exports none :session gen
     table
   #+END_SRC

** TODO Картинки очередей ЖК
** TODO Картинки планировок
** TODO Картинки хода строительства
* Загрузка данных

  В папке =./data= лежат ЖК, в каждом из них есть подпапки, в которых лежат очереди. Очереди
  в себе содержат подпапки, содержащие изображения:
  - Планировки
  - Рендеры
  - Ход строительства
  и файлы:
  - паспорт.txt - паспорт объекта
  - описание.txt - описание объекта
  - местоположение
  - комфорт
  - квартиры, в формате CSV
    |  корпус | тип | метраж | жилая площадь| площадь кухни | балкон/лоджия | санузел | цена |

** DONE Утилиты
   Напишем проход по всем этим директориям, но перед этим необходимо определить ряд
   вспомогательных макросов и функций.

   Начнем с макроса поиска файла в наборе. В случае, если файл найден, мы выполняем body

   #+NAME: awhen_file
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     (defmacro awhen-file ((file files) &body body)
       `(aif (find ,file ,files :test #'string=)
             ,@body
             ""))
   #+END_SRC

   Нам также понадобится цикл внутри директории, который умеет предоставлять нам
   поддиректории и файловое содержимое этих предоставленных поддиректорий.

   #+NAME: loop_dir
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     (defmacro loop-dir (var (&rest path) &body body)
       `(loop :for ,var :in (mapcar #'(lambda (x) (car (last (ppcre:split "\/" (directory-namestring x)))))
                                    (explore-dir (format nil "~A~{~A/~}*.*" *data-path* (list ,@path)))) :do
           (multiple-value-bind (_ files)
               (explore-dir (format nil "~A~{~A/~}~A/*.*" *data-path* (list ,@path) ,var))
             (declare (ignore _))
             (let ((files (mapcar #'(lambda (x) (car (last (ppcre:split "\/" (file-namestring x)))))
                                  files)))
               ,@body))))
   #+END_SRC

   Еще маленький вспомогательный макрос для извлечения значения по ключу из ассоциативного
   списка:

   #+NAME: assoc_key
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     (defmacro assoc-key (key alist)
       `(cdr (assoc ,key ,alist :test #'string=)))
   #+END_SRC

   Для работы с данными, извлекаемыми из файлов в формате ключ:значение напишем
   функцию-парсер:

   #+NAME: keyval
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     (defun keyval (filename)
       (remove-if #'null
                  (mapcar #'(lambda (in)
                              (let* ((pos (position #\: in :test #'char=)))
                                (if (null pos)
                                    (warn (format nil "wrong param: ~A" in))
                                    (let ((key (subseq in 0 pos))
                                          (val (subseq in (+ 1 pos))))
                                      (cons (string-trim '(#\Space #\Tab #\Newline)
                                                         (ppcre:regex-replace-all "\\s+" key " "))
                                            (string-trim '(#\Space #\Tab #\Newline)
                                                         (ppcre:regex-replace-all "\\s+" val " ")))))))
                          (ppcre:split #\Newline (alexandria:read-file-into-string filename)))))
   #+END_SRC

   Для работы с xls-файлами напишем парсер и декодер:

   #+NAME: xls
   #+BEGIN_SRC lisp :noweb tangle :exports none
    (in-package #:moto)

    (defun decoder-3-csv  (in-string)
      "Второе возвращаемое значение показывает, была ли закрыта кавычка, или строка
           закончилась посередине обрабатываемой ячейки, что указывает на разрыв строки"
      (let ((err))
        (values
         (mapcar #'(lambda (y) (string-trim '(#\Space #\Tab) y))
                 (mapcar #'(lambda (y) (ppcre:regex-replace-all "\\s+" y " "))
                         (mapcar #'(lambda (y) (string-trim '(#\Space #\Tab #\") y))
                                 (let ((inp) (sav) (acc) (res))
                                   (loop :for cur :across in-string do
                                      ;; (print cur)
                                      (if (null inp)
                                          (cond ((equal #\" cur) (progn (setf inp t)
                                                                        ;; (print "open quote : inp t")
                                                                        ))
                                                ((equal #\, cur)  (progn (push "" res)
                                                                         ;; (print "next")
                                                                         ))
                                                ;; (t (print "unknown sign out of quite"))
                                                )
                                          ;; else
                                          (cond ((and (null sav) (equal #\" cur)) (progn (setf sav t)
                                                                                         ;; (print "close quote : sav t")
                                                                                         ))
                                                ((and sav (equal #\" cur)) (progn (setf sav nil)
                                                                                  ;; (print (list ".." #\"))
                                                                                  (push #\" acc)))
                                                ((and sav (equal #\, cur)) (progn (setf sav nil)
                                                                                  (setf inp nil)
                                                                                  (push (coerce (reverse acc) 'string) res)
                                                                                  ;; (print "inp f")
                                                                                  (setf acc nil)))
                                                ((equal #\Return cur)      nil)
                                                (t (progn (push cur acc)
                                                          ;; (print (list "." cur))
                                                          )))))
                                   (when acc
                                     ;; незакрытая кавычка
                                     (if (and inp (null sav))
                                         (setf err t))
                                     ;; (print (list ":" inp sav acc res))
                                     (push (coerce (reverse acc) 'string) res))
                                   (reverse res)))))
         err)))

    (defun xls-processor (infile)
      (let* ((result)
             (output (with-output-to-string (*standard-output*)
                       (let* ((proc (sb-ext:run-program "/usr/bin/xls2csv"
                                                        (list "-q3" (format nil "~a" infile)) :wait nil :output :stream)))
                         (with-open-stream (in (sb-ext:process-output proc))
                           (loop :for i from 1 do
                              (tagbody loop-body
                                 (handler-case
                                     (let ((in-string (read-line in)))
                                       (format nil "~A" in-string)
                                       ;; начинаем декодировать
                                       (tagbody start-decoding
                                          (multiple-value-bind (line err-string-flag)
                                              (decoder-3-csv in-string)
                                            (when err-string-flag
                                              (setf in-string (concatenate 'string in-string (read-line in)))
                                              ;; (format t "~%warn-broken-string [~a] ~a~%" i in-string)
                                              (incf i)
                                              (go start-decoding))
                                            (format t "~%~%str: ~a~%lin: ~a" in-string (bprint line))
                                            (unless (null line)
                                              (handler-case
                                                  (push line result)
                                                (SB-INT:SIMPLE-PARSE-ERROR () nil))
                                              )))
                                       )
                                   (END-OF-FILE () (return i)))))))
                       )))
        (declare (ignore output))
        ;; output
        (reverse result)))
  #+END_SRC

** DONE Загрузчик

   Теперь переходим к загрузке данных:

   #+NAME: loader
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)
     <<awhen_file>>
     <<loop_dir>>
     <<assoc_key>>
     <<keyval>>
     <<xls>>

     ;; (defun clear-db-trend ()
     ;;   (let ((tables '("cmpx" "plex" "crps" "flat")))
     ;;     (flet ((rmtbl (tblname)
     ;;              (when (with-connection *db-spec*
     ;;                      (query (:select 'table_name :from 'information_schema.tables :where
     ;;                                      (:and (:= 'table_schema "public")
     ;;                                            (:= 'table_name tblname)))))
     ;;                (with-connection *db-spec*
     ;;                  (query (:delete-from (intern (string-upcase tblname))))))))
     ;;       (loop :for tblname :in tables :collect
     ;;          (rmtbl tblname)))))

     ;; (defun load-data ()
     ;;   (clear-db-trend)
     ;;   ;; Для каждой подпапке в папке данных..
     ;;   (loop-dir cmpx ()
     ;;      ;; Создаем комплекс и заполняем адрес, если удалось найти соответствующий файл
     ;;        (format t "~%-~A" cmpx)
     ;;        (let ((cmpx-id (id (make-cmpx :name cmpx))))
     ;;          ;; Если найден файл с данными ЖК - обновим созданную очередь ЖК
     ;;          (awhen-file ("complex.txt" files)
     ;;            ;; Прочитать, разбить построчно, отделить ключи от значений, убрать ведущие, ведомые и повторяющиеся пробелы
     ;;            (let ((complex (keyval (format nil "~A~A/~A" *data-path* cmpx it))))
     ;;              (format t "~% ~A - ~A" it (bprint complex))
     ;;              (upd-cmpx (get-cmpx cmpx-id)
     ;;                        (list
     ;;                         :addr (assoc-key "Адрес" complex)
     ;;                         :district-id (let ((obj (find-district :name (assoc-key "Район" complex))))
     ;;                                        (if (null obj)
     ;;                                            (warn (format nil "Район ~A не найден в таблице районов" (assoc-key "Район" complex)))
     ;;                                            (id (car obj))))
     ;;                         :metro-id    (let ((obj (find-metro :name (assoc-key "Метро" complex))))
     ;;                                        (if (null obj)
     ;;                                            (warn (format nil "Метро ~A не найдено в таблице метро" (assoc-key "Метро" complex)))
     ;;                                            (id (car obj))))))))
     ;;          ;; Для каждой подпапки в папке комплекса, кроме планировок, рендеров и хода строительства:
     ;;          (loop-dir plex (cmpx)
     ;;               (unless (or (string= plex "Планировки")
     ;;                           (string= plex "Рендеры")
     ;;                           (string= plex "Ход строительства"))
     ;;                 ;; Создаем очередь ЖК
     ;;                 (format t "~%--~A" plex)
     ;;                 (let ((plex-id (id (make-plex :name plex :cmpx-id cmpx-id))))
     ;;                   ;; Если найден файл с данными очереди ЖК - обновим созданную очередь ЖК
     ;;                   (awhen-file ("data.txt" files)
     ;;                     (let ((data (keyval (format nil "~A~A/~A/~A" *data-path* cmpx plex it))))
     ;;                       (format t "~%  ~A - ~A" it (bprint data))
     ;;                       (upd-plex (get-plex plex-id)
     ;;                                 ;; (assoc-key "Срок сдачи" '(("﻿Срок сдачи" . "2 квартал 2015") ("Субсидия" . "")
     ;;                                 ;;                           ("Отделка" . "предчистовая") ("Ипотека" . "да") ("Рассрочка" . "да")
     ;;                                 ;;                           ("Расстояние до метро" . "1.7 км (21 мин пешком)")))
     ;;                                 (list :deadline-id (let ((dd (assoc-key "Срок сдачи" data)))
     ;;                                                      (format t "~%   dd: ~A | ~A"
     ;;                                                              dd
     ;;                                                              (awhen (find-deadline :name (assoc-key "Срок сдачи" data))
     ;;                                                                (id (car it))))
     ;;                                                      (awhen (find-deadline :name (assoc-key "Срок сдачи" data))
     ;;                                                        (id (car it))))
     ;;                                       :finishing   (assoc-key "Отделка" data)
     ;;                                       :ipoteka     (or (string= "да" (assoc-key "ипотека" data)))
     ;;                                       :installment (or (string= "да" (assoc-key "рассрочка" data)))
     ;;                                       :subsidy     (or (string= "да" (assoc-key "субсидия" data)))
     ;;                                       :distance    (assoc-key "Расстояние до метро" data)))
     ;;                       (format t "~%   rr: ~A" (deadline-id (get-plex plex-id)))
     ;;                       ))
     ;;                   ;; Для каждой подпапки в папке очереди ЖК, кроме планировок, рендеров и хода строительства:
     ;;                   (loop-dir crps (cmpx plex)
     ;;                        (unless (or (string= crps "Планировки")
     ;;                                    (string= crps "Рендеры")
     ;;                                    (string= crps "Ход строительства"))
     ;;                          ;; Создаем корпус
     ;;                          (format t "~%---~A" crps)
     ;;                          (let ((crps-id (id (make-crps :name crps :plex-id plex-id))))
     ;;                            ;; Если найден файл с планировками объекта
     ;;                            (awhen-file ("квартиры.xls" files)
     ;;                              (loop :for item :in (cdr (xls-processor (format nil "~A~A/~A/~A/~A" *data-path* cmpx plex crps it))) :do
     ;;                                 (format t "~%   ~A" (bprint item))
     ;;                                 (make-flat :crps-id crps-id
     ;;                                            :rooms (parse-integer (nth 0 item))
     ;;                                            :area-sum (nth 1 item)
     ;;                                            :area-living (nth 2 item)
     ;;                                            :area-kitchen (nth 3 item)
     ;;                                            :balcon (nth 4 item)
     ;;                                            :sanuzel (if (string= "" (nth 5 item)) t nil)
     ;;                                            :price (parse-integer (nth 6 item)))))))))))))
     ;;   (format t "~%-=finish=-"))

     ;; (load-data)
   #+END_SRC

* Шаблоны

  #+NAME: trendtpl_contents
  #+BEGIN_SRC closure-template-html :comments link :noweb tangle :exports none
    // -*- mode: closure-template-html; fill-column: 140 -*-
    {template root}
    <!DOCTYPE HTML>{\n}
    <html lang="en-US">{\n}
    <head>{\n}
        <meta charset="UTF-8">{\n}
        <meta http-equiv="X-UA-Compatible" content="IE=edge">{\n}
        <title>{$headtitle}</title>{\n}
        <link href="css/bootstrap.min.css" rel="stylesheet">{\n}
        <link rel="stylesheet" type="text/css" href="css/not-responsive.css" media="all" />{\n}
        <link rel="stylesheet" type="text/css" href="css/theme.css" media="all" />{\n}
        <link rel="stylesheet" type="text/css" href="css/fonts.css" media="all" />{\n}
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->{\n}
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->{\n}
        <!--[if lt IE 9]>{\n}
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>{\n}
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>{\n}
        <![endif]-->{\n}
    </head>{\n}
    <body>{\n}
    <div class="bg-cover"></div>{\n}
        <!-- header-->{\n}
        <header>{\n}
            <div class="container">{\n}
                <div class="row">{\n}
                    <div class="col-md-3 col-xs-3 logo"><a href="#"><img src="img/logo.png" alt="" /></a></div>{\n}
                    <div class="col-md-2 col-xs-2 slagan text-center">Первичное жильё <br>из первых рук</div>{\n}
                    <div class="col-md-7 col-xs-7">{\n}
                        <ul class="nav nav-pills pull-right">{\n}
                            <li><a href="#"><span class="glyphicon glyphicon-align-right" aria-hidden="true"></span></span> Сравнение</a></li>{\n}
                            <li><a href="#"><span class="glyphicon glyphicon-heart" aria-hidden="true"></span> Избранное</a></li>{\n}
                            <li><a href="#"><span class="glyphicon glyphicon-book" aria-hidden="true"></span> Просмотрено</a></li>{\n}
                            <li><a class="btn btn-warning" href="#">Контакты</a></li>{\n}
                        </ul>{\n}
                    </div>{\n}
                </div>{\n}
                <div class="row promo-text">{\n}
                    <div class="col-md-6 col-xs-6"><h1>Более 300 объектов <br> недвижимости</h1></div>{\n}
                    <div class="col-md-6 col-xs-6 text-left"><p>В нашем предложении более 300 строящихся и новых <br> домов в Санкт-Петербурге и Ленинградской области.</p> <strong>Мы знаем о новостройках все!</strong></div>{\n}
                </div>{\n}
            </div>{\n}
        </header>{\n}
        <!-- end header -->{\n}
        <!-- filter -->{\n}
        <section id="filter">{\n}
            <div class="container">{\n}
                <div class="tab-panel">{\n}
                    <!-- nav tabs -->{\n}
                    <ul class="nav nav-tabs" role="tablist">{\n}
                        <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Новостройки</a></li>{\n}
                        <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Вторичное жилье</a></li>{\n}
                    </ul>{\n}
                    <!-- tab panes -->{\n}
                    <div class="tab-content">{\n}
                         <div role="tabpanel" class="tab-pane active" id="home">{\n}
                            <!-- form -->{\n}
                            <form action="" method="post">{\n}
                                <div class="row">{\n}
                                    <div class="form-group">{\n}
                                        <div class="col-sm-3">{\n}
                                            <label for="" class="control-label">Название, район, метро, id</label>{\n}
                                            <input type="text" name="" class="form-control" id="" placeholder="Балти" />{\n}
                                            <span class="glyphicon glyphicon-search pull-right" aria-hidden="true"></span>{\n}
                                        </div>{\n}
                                        <div class="col-sm-2 cbox"> {\n}
                                            <label for="" class="control-label">Количество комнат</label><br>{\n}
                                            <input type="checkbox" value=""> C{\n}
                                            <input type="checkbox" value=""> 2{\n}
                                            <input type="checkbox" value="" disabled> 3{\n}
                                            <input type="checkbox" value="" disabled> 4{\n}
                                        </div>{\n}
                                        <div class="col-sm-2">{\n}
                                            <label for="" class="control-label">Срок сдачи, от</label>{\n}
                                            <select class="form-control">{\n}
                                                <option>IV квартал 2014</option>{\n}
                                            </select>{\n}
                                        </div>{\n}
                                        <div class="col-sm-2">{\n}
                                            <label for="" class="control-label">Срок сдачи, до</label>{\n}
                                            <select class="form-control">{\n}
                                                <option>IV квартал 2015</option>{\n}
                                            </select>{\n}
                                        </div>{\n}
                                        <div class="col-sm-3">{\n}
                                            <label for="" class="control-label">Стоимость квартиры, т. р.</label>{\n}
                                            <div class="row">{\n}
                                                <div class="col-sm-5"><input type="text" name="" class="form-control" id="" placeholder="2 800" /></div>{\n}
                                                <div class="col-sm-2 text-center"><span class="entypo-minus"></span></div>{\n}
                                                <div class="col-sm-5"><input type="text" name="" class="form-control" id="" placeholder="3 300" /></div>{\n}
                                            </div>{\n}
                                        </div>{\n}
                                    </div>{\n}
                                </div>{\n}
                                <span class="label label-default">Красносельский район <b class="entypo-cancel"></b></span>{\n}
                                <span class="label label-default">Улица Адмирала Трибуца <b class="entypo-cancel"></b></span>{\n}
                                <span class="label label-default">Улица Пограничника Гарькавого <b class="entypo-cancel"></b></span>{\n}
                                <div class="clearfix"></div>{\n}
                                <div class="row line">{\n}
                                    <div class="col-sm-3"><input type="checkbox" value="" checked> Ипотека </div>{\n}
                                    <div class="col-sm-3"><input type="checkbox" value="" checked> Рассрочка </div>{\n}
                                </div>{\n}
                                <div class="row">{\n}
                                    <div class="col-sm-3">{\n}
                                        <div class="row">{\n}
                                            <div class="col-sm-5"><label for="" class="control-label">Перв. взнос</label><input type="text" name="" class="form-control" id="" placeholder="600 000" /></div>{\n}
                                            <div class="col-sm-2 text-center rid"><div>или</div></div>{\n}
                                            <div class="col-sm-5"><label for="" class="control-label">В мес. платеж</label><input type="text" name="" class="form-control" id="" placeholder="22 800" /></div>{\n}
                                        </div>{\n}
                                    </div>{\n}
                                    <div class="col-sm-3">{\n}
                                        <div class="row">{\n}
                                            <div class="col-sm-5"><label for="" class="control-label">Перв. взнос</label><input type="text" name="" class="form-control" id="" placeholder="" disabled/></div>{\n}
                                            <div class="col-sm-2 text-center rid"><div>или</div></div>{\n}
                                            <div class="col-sm-5"><label for="" class="control-label">В мес. платеж</label><input type="text" name="" class="form-control" id="" placeholder="" disabled/></div>{\n}
                                        </div>{\n}
                                    </div>{\n}
                                    <div class="col-sm-2">{\n}
                                        <label for="" class="control-label">Метраж, м2</label>{\n}
                                        <div class="row">{\n}
                                            <div class="col-sm-5"><input type="text" name="" class="form-control" id="" placeholder="30" /></div>{\n}
                                            <div class="col-sm-2 text-center"><b class="entypo-minus"></b></div>{\n}
                                            <div class="col-sm-5"><input type="text" name="" class="form-control" id="" placeholder="40" /></div>{\n}
                                        </div>{\n}
                                    </div>{\n}
                                    <div class="col-sm-2">{\n}
                                        <div class="checkbox">{\n}
                                            <input type="checkbox" value=""> Субсидия <br>{\n}
                                            <input type="checkbox" value="" checked> Отделка{\n}
                                        </div>{\n}
                                    </div>{\n}
                                    <div class="col-sm-2 text-right">{\n}
                                        <button class="btn btn-primary btn-lg">Подобрать</button>{\n}
                                    </div>{\n}
                                </div>{\n}
                                <div class="text-right top"><a href="#">Быстрый поиск</a></div>{\n}
                            </form>{\n}
                            <!-- end form -->{\n}
                         </div>{\n}
                    </div>{\n}
                </div>{\n}
            </div>{\n}
        </section>{\n}
        <!-- end filter -->{\n}
        <!-- promo -->{\n}
        <section id="promo">{\n}
            <div class="container">{\n}
                    {$content | noAutoescape}{\n}{\n}

                <div class="row">{\n}
                    <div class="col-md-4 col-xs-4">{\n}
                        <h3>Выбор ипотечной <br>программы</h3>{\n}
                        <ul>{\n}
                            <li>Ипотечная ставка <strong>от 11,5%,</strong></li>{\n}
                            <li><strong>Более 50</strong> ипотечных программ.</li>{\n}
                        </ul>{\n}
                    </div>{\n}
                    <div class="col-md-4 col-xs-4">{\n}
                        <h3>Подготовка <br>документов за 30 минут</h3>{\n}
                        <p>Наш специалист соберет весь необходимый комплект доку-ментов в вашем присутствии или без вас.</p>{\n}
                    </div>{\n}
                    <div class="col-md-4 col-xs-4">{\n}
                        <h3>Одобрение в пяти <br>банках за три дня</h3>{\n}
                        <p>Через три дня получайте одобрение на ипотечный кредит в пяти банках.</p>{\n}
                    </div>{\n}
                </div>{\n}
                <div class="text-center top"><a href="#" class="btn btn-lg btn-danger">Рассчитать ипотеку</a></div>{\n}
            </div>{\n}
        </section>{\n}
        <!-- end -->{\n}
        <!-- service -->{\n}
        <section id="service">{\n}
            <div class="container">{\n}
                <h3 class="text-center">Служба демонстрации квартир</h3>{\n}
                <div class="row">{\n}
                    <div class="col-md-6 col-xs-6">{\n}
                        <img src="img/pics1.jpg" alt="" width="280" />{\n}
                        <img src="img/pics2.jpg" alt="" width="280" />{\n}
                        <h4>Служба демонстрации квартир — <span class="text-primary">быстро и удобно!</span></h4>{\n}
                        <p>Индивидуальный показ в удобное вам время от ближайшей станции метро на автомобиле сотрудника. За пару часов своими глазами вы увидите все интересные вам жилые комплексы.</p>{\n}
                    </div>{\n}
                    <div class="col-md-6 col-xs-6">{\n}
                        <div class="pull-left"><img src="img/pics3.jpg" alt="" /></div>{\n}
                        <div class="pull-left">{\n}
                        <h4>Автобусный тур — <span class="text-primary">каждые выходные!</span></h4>{\n}
                        <ul>{\n}
                            <li>Вы ознакомитесь с самым широким предложением по строящимся домам Санкт-Петербурга и Ленинградской области;</li>{\n}
                            <li>посетите несколько районов города за одну поездку, сравнить удобство местоположения и общее развитие территорий;</li>{\n}
                            <li>собственными глазами увидите степень готовности новостроек;</li>{\n}
                            <li>наглядно ознакомитесь с качеством строительства.</li>{\n}
                        </ul>{\n}
                        </div>{\n}
                    </div>{\n}
                </div>{\n}
                <div class="text-center top"><a href="#" class="btn btn-lg btn-default">Записаться бесплатно</a></div>{\n}
            </div>{\n}
        </section>{\n}
        <!-- end service -->{\n}
        <!-- sell -->{\n}
        <section id="sail">{\n}
            <div class="container">{\n}
                <h3 class="text-center">Продажа вашей квартиры</h3>{\n}
                <div class="row">{\n}
                    <div class="col-md-6 col-xs-6">{\n}
                        <p><strong>Мечтаете о квартире</strong> в новом доме, но для реализации задуманного необходимо продать имеющееся жилье?</p>{\n}
                        <p><strong>Не знаете</strong> с чего начать процесс продажи?</p>{\n}
                        <p><strong>Пугают</strong> рутинные и длительные этапы по проведению сделки, подготовке и сбору документов?</p>{\n}
                    </div>{\n}
                    <div class="col-md-6 col-xs-6">{\n}
                        <h4>Мы поможем решить все эти вопросы максимально комфортно и <a href="#">реализовать Вашу квартиру</a> по самым интересным тарифам Санкт-Петербурга</h4>{\n}
                    </div>{\n}
                </div>{\n}
                <div class="text-center top"><a href="#" class="btn btn-lg btn-success">Продать квартиру</a></div>{\n}
            </div>{\n}
        </section>{\n}
        <!-- end sell -->{\n}
        <!-- violet block -->{\n}
        <section id="violet">{\n}
            <div class="container">{\n}
                <div class="text-center">{\n}
                    <h4>Все наши услуги бесплатны</h4>{\n}
                    <a href="#" class="btn btn-lg btn-warning">Связаться с нашим специалистом</a>{\n}
                    <p>Бесплатные звонки по России</p>{\n}
                </div>{\n}
            </div>{\n}
        </section>{\n}
        <!-- end violet -->{\n}
        <!-- footer -->{\n}
        <footer>{\n}
            <div class="black bg-warning">{\n}
                <div class="container">{\n}
                    <div class="row">{\n}
                        <div class="col-md-4 col-xs-4">{\n}
                            <p>Следите за акциями, спецпредложениями и новостями новостроек в соцсетях:</p>{\n}
                        </div>{\n}
                        <div class="col-md-4 col-xs-4">{\n}
                            <ul class="nav nav-pills">{\n}
                                <li><a class="brandico-facebook" title="" href="#"></a></li>{\n}
                                <li><a class="brandico-twitter" title="" href="#"></a></li>{\n}
                                <li><a class="brandico-vkontakte-rect" title="" href="#"></a></li>{\n}
                            </ul>{\n}
                        </div>{\n}
                    </div>{\n}
                </div>{\n}
            </div>{\n}
            <div class="gray bg-danger">{\n}
                <div class="container">{\n}
                    <div class="row">{\n}
                        <div class="col-md-2 col-xs-2">{\n}
                            <h4>Новостройки</h4>{\n}
                            <ul class="nav nav-pills nav-stacked">{\n}
                                <li><a href="#">Объекты на карте</a></li>{\n}
                                <li><a href="#">Подбор квартиры</a></li>{\n}
                                <li><a href="#">Дома в центре</a></li>{\n}
                                <li><a href="#">Дома на севере</a></li>{\n}
                                <li><a href="#">Дома на юге</a></li>{\n}
                            </ul>{\n}
                        </div>{\n}
                        <div class="col-md-2 col-xs-2">{\n}
                            <h4>Популярные запросы</h4>{\n}
                            <ul class="nav nav-pills nav-stacked">{\n}
                                <li><a href="#">Квартиры в готовых домах</a></li>{\n}
                                <li><a href="#">Квартиры в ипотеку</a></li>{\n}
                                <li><a href="#">Квартиры с отделкой</a></li>{\n}
                                <li><a href="#">Квартиры-студии</a></li>{\n}
                                <li><a href="#">Однокомнатные квартиры</a></li>{\n}
                                <li><a href="#">Двухкомнатные квартиры</a></li>{\n}
                                <li><a href="#">Трехкомнатные квартиры</a></li>{\n}
                            </ul>{\n}
                        </div>{\n}
                        <div class="col-md-2 col-xs-2">{\n}
                            <h4>Наши подборки</h4>{\n}
                            <ul class="nav nav-pills nav-stacked">{\n}
                                <li><a href="#">Квартиры по доступной цене</a></li>{\n}
                                <li><a href="#">Квартиры на выгодных условиях</a></li>{\n}
                                <li><a href="#">Квартиры для комфортной жизни</a></li>{\n}
                                <li><a href="#">Квартиры по уступке</a></li>{\n}
                                <li><a href="#">Загородная недвижимость</a></li>{\n}
                            </ul>{\n}
                        </div>{\n}
                        <div class="col-md-2 col-xs-2">{\n}
                            <h4>Компания Тренд</h4>{\n}
                            <ul class="nav nav-pills nav-stacked">{\n}
                                <li><a href="#">О компании</a></li>{\n}
                                <li><a href="#">10 выгодных причин</a></li>{\n}
                                <li><a href="#">Награды и благодарности</a></li>{\n}
                                <li><a href="#">Ипотечный центр</a></li>{\n}
                                <li><a href="#">Новости</a></li>{\n}
                                <li><a href="#">Карьера</a></li>{\n}
                                <li><a class="text-danger" href="#">Пожаловаться</a></li>{\n}
                                <li><a class="text-danger" href="#">Контакты</a></li>{\n}
                            </ul>{\n}
                        </div>{\n}
                        <div class="col-md-4 col-xs-4">{\n}
                            <h3><strong>№ 2.</strong> Бесплатный <br>ипотечный центр</h3>{\n}
                            <h3 class="text-primary">Все 3 причины, <br>почему с нами выгодно</h3>{\n}
                            <form class="form-inline" role="form">{\n}
                                 <div class="form-group"><input type="text" class="form-control" id="" placeholder="Ваш e-mail"></div>{\n}
                                 <button type="submit" class="btn btn-primary"><span class="entypo-right-open-big"></span></button>{\n}
                            </form>{\n}
                            <div class="help-block"><small>Подпишитесь на старты продаж, <br>новости проектов, акции <br>и спецпредложения</small></div>{\n}
                        </div>{\n}
                        {\n}
                    </div>{\n}
                    <div class="clearfix"></div>{\n}
                    <div class="row">{\n}
                        <div class="col-md-3 col-xs-3"><div class="text-left copiryng">Сделано в <a href="#"> Deasign</a></div></div>{\n}
                        <div class="col-md-5 col-xs-5"></div>{\n}
                        <div class="col-md-4 col-xs-4 pull-left"></div>{\n}
                    </div>{\n}
                </div>{\n}
            </div>{\n}
            {\n}
        </footer>{\n}
        <!-- end footer -->{\n}
        {\n}
        {\n}
        {\n}
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->{\n}
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>{\n}
        <!-- Include all compiled plugins (below), or include individual files as needed -->{\n}
        <script src="js/bootstrap.min.js"></script>{\n}
    </body>{\n}
    </html>{\n}
    {/template}
  #+END_SRC

* Interface

  Соберем веб-интерфейс:

  #+NAME: iface
  #+BEGIN_SRC lisp :tangle src/mod/trend/iface.lisp :noweb tangle :exports none :padline no :comments link
    ;;;; iface.lisp

    (in-package #:moto)

    ;; Страницы
    ;; <<iface_contents>>
  #+END_SRC

** Тестовая страница шаблонов

   #+NAME: iface_contents
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     ;; Страница загрузки данных
     ;; (restas:define-route test-page ("/trnd")
     ;;   (trendtpl:root (list :content
   #+END_SRC

** Описание интерфейса поиска

   #+NAME: iface_contents
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     ((количество-комнат
       (radiobtn Студия 1 2 3 4+))
      (стоимость)
      (жилой-комплекс)
      (срок-сдачи)
      (расположение)
      (застройщик)
      (отделка))
   #+END_SRC


   #+NAME: newbldfrm
   #+BEGIN_SRC closure-template-html :noweb tangle :exports none
     <div class="filterbox" id='filter'>
         <input type="hidden" name="bigfilterflag" id="bigfilterflag" value = "1">
         <input type="hidden" name="orderflat" id="orderflat" value = "vaf.amountDisc">
         <input type="hidden" name="ordercomplex" id="ordercomplex" value = "H.Id desc">
         <div class="parametres_box">
             <div class="box">
                 <div class="title">Количество комнат</div>
                 <ul class="choose_list">
                     <li class="study" >
                         <div id='rooms_bt_0' OnClick="RoomsCheck(0);">Студия</div>
                     </li>
                     <li>
                         <div id='rooms_bt_1' OnClick="RoomsCheck(1);">1</div>
                     </li>
                     <li>
                         <div id='rooms_bt_2' OnClick="RoomsCheck(2);">2</div>
                     </li>
                     <li>
                         <div id='rooms_bt_3' OnClick="RoomsCheck(3);">3</div>
                     </li>
                     <li>
                         <div id='rooms_bt_4' OnClick="RoomsCheck(4);">4+</div>
                     </li>
                 </ul>
                 <input type='hidden' id='rooms0' name='rooms0' value='-1'>
                 <input type='hidden' id='rooms1' name='rooms1' value='-1'>
                 <input type='hidden' id='rooms2' name='rooms2' value='-1'>
                 <input type='hidden' id='rooms3' name='rooms3' value='-1'>
                 <input type='hidden' id='rooms4' name='rooms4' value='-1'>
             </div>
             <div class="box">
                 <div class="title">Стоимость</div>
                 <ul class="choose_list">
                     <li class="w100"><a href="javascript:CostCheck('all');" id='cost_all_flat' >Квартира</a></li>
                     <li class="w100"><a href="javascript:CostCheck('meter');" id='cost_per_meter' >Квадратный метр</a></li>
                 </ul>
                 <input type='hidden' id='costval' name='costval' value='all'>
             </div>
             <div class="box min">
                 <div class="title">Жилой комплекс:</div>
                 <asp:ListView ID="complexlist" runat="server"
                               DataKeyNames="id" EnableModelValidation="True">
                     <ItemTemplate>
                         <option value="<%# Eval("id") %>" ><%# Eval("name") %></option>
                     </ItemTemplate>
                     <LayoutTemplate>
                         <select name="complexlist" class="selectbox"><option value="0">Не важно</option><asp:PlaceHolder runat="server" ID="itemPlaceholder"></asp:PlaceHolder></select>
                     </LayoutTemplate>
                 </asp:ListView>
             </div>
             <%--<div class="box min">
                      <div class="title">
                          <a href="javascript: visib('ComplexModal_v2'); BodyScrol(0); GetGroupAllVal('filter', '/ajaxdata/get_complex_list.php', 'ComplexModal_v2_content', '', 0);">Жилой комплекс</a>
                      </div>
                      <div>
                          <input type="text" name="complexlisttext" id="complexlisttext" class="filter_input" OnKeyUp="KeyUpKomplex();"  autocomplete="off"/>
                          <span class="i_bem" id="complex_i_bem" style="display:none;"> </span>
                      </div>
                      <input type='hidden' id='complexlist' name='complexlist' value=''>
             </div>--%>
             <div class="box last">
                 <div class="title">Срок сдачи до:</div>
                 <asp:ListView ID="dateendselect" runat="server"
                               DataKeyNames="yearEnd" EnableModelValidation="True">
                     <ItemTemplate>
                         <option value="<%# Eval("yearEnd") %>" ><%# Eval("yearEnd") %></option>
                     </ItemTemplate>
                     <LayoutTemplate>
                         <select name="dateendselect" class="selectbox"><option value="0">Не важно</option><asp:PlaceHolder runat="server" ID="itemPlaceholder"></asp:PlaceHolder></select>
                     </LayoutTemplate>
                 </asp:ListView>
             </div>
             <div class="clear"></div>
             <div class="box">
                 <div class="title">Расположение</div>
                 <ul class="choose_list">
                     <li class="study"><a href="javascript: visib('RaionModal_v2'); BodyScrol(0); GetGroupAllVal('filter', '/ajaxdata/get_raion_list.php', 'RaionModal_v2_content', '', 0);">Район</a></li>
                     <li class="metro"><a href="javascript: visib('MetroModal_v2'); BodyScrol(0); GetGroupAllVal('filter', '/ajaxdata/get_metro_list.php', 'MetroModal_v2_content', '', 0);">Метро</a></li>
                     <input type='hidden' id='raionlist' name='raionlist' value=''> </span>
                     <input type='hidden' id='metrolist' name='metrolist' value=''> </span>
                     </ul>
                     </div>
                     <div class="box">
                         <div class="title w100">От:</div>
                         <div class="title w100">До:</div>
                         <input type="text" name="costmin" class="filter_input w100" placeholder="Минимально"  id='costmin' OnKeyUp="OktetAdd(document.getElementById('costmin').value, 'costmin');" />
                         <input type="text" name="costmax" class="filter_input w100" placeholder="Максимально" id='costmax' OnKeyUp="OktetAdd(document.getElementById('costmax').value, 'costmax');" />
                     </div>
                     <div class="box min">
                         <div class="title">Застройщик:</div>
                         <asp:ListView ID="devlisttext" runat="server"
                                       DataKeyNames="id" EnableModelValidation="True">
                             <ItemTemplate>
                                 <option value="<%# Eval("id") %>" ><%# Eval("name") %></option>
                             </ItemTemplate>
                             <LayoutTemplate>
                                 <select name="devlisttext" class="selectbox"><option value="0">Не важно</option><asp:PlaceHolder runat="server" ID="itemPlaceholder"></asp:PlaceHolder></select>
                             </LayoutTemplate>
                         </asp:ListView>
                     </div><!--
                               <div class="box min">
                                   <div class="title">
                                       <a href="javascript:visib('DeveloperModal_v2'); BodyScrol(0); GetGroupAllVal('filter', '/ajaxdata/get_developer_list.php', 'DeveloperModal_v2_content', '', 0);">Застройщик</a>
                                   </div>
                                   <div>
                                       <input type="text" name="devlisttext" id="devlisttext" class="filter_input" OnKeyUp="KeyUpDev();"  autocomplete="off"/>
                                       <span class="dev_i_bem" id="dev_i_bem" style="display:none;"> </span>
                                   </div>
                                   <input type='hidden' id='developerlist' name='developerlist' value=''>
                               </div>-->
                     <div class="box last">
                         <div class="title">Отделка:</div>
                         <asp:ListView ID="decorationsel" runat="server"
                                       DataKeyNames="id" EnableModelValidation="True">
                             <ItemTemplate>
                                 <option value="<%# Eval("id") %>" ><%# Eval("name") %></option>
                             </ItemTemplate>
                             <LayoutTemplate>
                                 <select name="decorationsel" class="selectbox"><option value="0">Не важно</option><asp:PlaceHolder runat="server" ID="itemPlaceholder"></asp:PlaceHolder></select>
                             </LayoutTemplate>
                         </asp:ListView>
                     </div>
                     <a href="javascript:visib('advancedfind'); KostilAdvPar();" class="show_param" id='advancedfind_href'>расширенный поиск <img src="/css/images/down.png"></a>
                     </div>
                     <div class="middle" id='advancedfind'>
                         <input type='hidden' id='advanviz' name='advanviz' value='0'>
                         <div class="box w150">
                             <div class="title marg">Площадь общая (М&sup2;)</div>
                             <label>От:</label><input type="text" name="sallmin" class="filter_input" id='sallmin' />
                             <label>До:</label><input type="text" name="sallmax" class="filter_input" id='sallmax' />
                         </div>
                         <div class="box w150">
                             <div class="title marg">Площадь кухни (М&sup2;)</div>
                             <label>От:</label><input type="text" name="skitchenmin" class="filter_input" id='skitchenmin' />
                             <label>До:</label><input type="text" name="skitchenmax" class="filter_input" id='skitchenmax' />
                         </div>
                         <div class="box w150">
                             <div class="title marg">Этаж</div>
                             <label>От:</label><input type="text" name="floormin" class="filter_input" id='floormin' />
                             <label>До:</label><input type="text" name="floormax" class="filter_input" id='floormax' />
                         </div>
                         <div class="box min130">
                             <div class="title">Тип дома</div>
                             <asp:ListView ID="housetype" runat="server"
                                           DataKeyNames="id" EnableModelValidation="True">
                                 <ItemTemplate>
                                     <option value="<%# Eval("id") %>" ><%# Eval("name") %></option>
                                 </ItemTemplate>
                                 <LayoutTemplate>
                                     <select name="decorationsel" class="selectbox"><option value="all">Не важно</option><asp:PlaceHolder runat="server" ID="itemPlaceholder"></asp:PlaceHolder></select>
                                 </LayoutTemplate>
                             </asp:ListView>
                         </div>
                         <div class="box last min">
                             <div class="title">Поиск по ID</div>
                             <input type="text" class="filter_input" placeholder="Укажите ID объекта" name="findid" id='findid' />
                         </div>
                     </div>
                     <div class="resultsbox"  id='tags' >
                         <div id='raiontags' style='padding-left:10px;'name='raiontags'> </div>
                         <div id='metrotags' style='padding-left:10px;'name='metrotags'> </div>
                         <div id='complextags' style='padding-left:10px;'name='complextags'> </div>
                         <div id='developertags' style='padding-left:10px;'name='developertags'> </div>
                         <input type='hidden' id='pagenumber' name='pagenumber' value=1><input type='hidden' id='special' name='special' value=0>
                     </div>
                     <div class="resultsbox">
                         <div class="inline">
                             <div class="filter_button_wrap">
                                 <asp:Button PostBackUrl="/NewBuildingSearchResults.aspx" type="submit" Text="Найти" CssClass="filter_button" runat="server" />
                             </div>
                             <div class="res" id='spanallfind'></div>
                         </div>
                     </div>
                     </div>
  #+END_SRC

** Страничка загрузки данных

   #+NAME: iface_contents
   #+BEGIN_SRC lisp :noweb tangle :exports none
     (in-package #:moto)

     ;; Страница загрузки данных
     (restas:define-route load-data-page ("/load")
       (with-wrapper
         (concatenate
          'string
          "<h1>Загрузка данных из файлов</h1>"
          (if (null *current-user*)
              "Error: Незалогиненные пользователи не имеют права загружать данные"
              (frm (tbl
                    (list
                     (row "" (let ((cmpx-s))
                               (loop-dir cmpx ()
                                    (push cmpx cmpx-s))
                               (format nil "~{~A<br/>~}<br />" cmpx-s)))
                     (row "" (hid "load"))
                     (row "" (submit "Загрузить")))))))))

     ;; Контроллер страницы регистрации
     (restas:define-route load-ctrl ("/load" :method :post)
       (with-wrapper
         (let* ((p (alist-to-plist (hunchentoot:post-parameters*))))
           (if (equal (getf p :load) "")
               (load-data)
               "err"))))
   #+END_SRC

** Список ЖК

 #+NAME: iface_contents
 #+BEGIN_SRC lisp :noweb tangle :exports none

   (in-package #:moto)

   (define-page all-cmpx-s "/cmpxs"
     (concatenate 'string "<h1>" "Жилые комплексы" "</h1>" ""
                  "<br /><br />"
                  (tbl
                   (with-collection (cmpx (funcall #'all-cmpx))
                     (tr
                      (td
                       (format nil "<a href=\"/~a/~a\">~a</a>" "cmpx"
                       (id cmpx) (id cmpx)))
                      (td (name cmpx))
                      (td (addr cmpx))
                      (td (aif (district-id cmpx)
                               (name (get-district it))))
                      (td (aif (metro-id cmpx)
                               (name (get-metro it))))
                      (td (frm %del%))))
                   :border 1))
     (:del (act-btn "DEL" (id cmpx) "Удалить")
           (progn (del-cmpx (getf p :data)))))
 #+END_SRC

** Страница ЖК

   На самом деле это не карточка Жилищного Комплекса, а скорее карточка одной из его очередей,
   т.к. большинство параметров различаются между очередями. С другой стороны все очереди одного
   комплекса между собой связаны, так что нужна какая-то обьединяющая сущность.

   [[file:pics/Trend_complex20.png][Дизайн-макет: Карточка ЖК]]

   Если пользователь попал на эту страницу НЕ через поиск - ему надо
   показать кнопку "К поиску (378)", которая содержит кол-во
   вариантов при самых широких параметров поиска.

   Есть пользователь попал на эту страницу из выборки - эта кнопка
   должна вести на его выборку и содержать кол-во вариантов его
   выборки.

   Тут может быть мемоизация и предвычисления, которые мы на первом
   этапе можем не делать.

   Если пользователь зашел на этот обьект - этот объект нужно
   добавить в его "просмотренные".

   Отсюда пользователь может перейти к сценарию "сравнение",
   "добавить в избранное", "распечатать объект".

   Когда все квартиры в очереди закончились необходимо не удалять
   очередь с сайта, а убирать их в архив, чтобы она не показывалась в
   поиске, но были доступна администратору.

   Видим:
   - Название ЖК
   - Метро
   - Расстояние до метро
   - Район
   - Улица (или пересчение улиц)

   - Картинки (неограниченно, можно листать)
   - Минимальные цены в этом ЖК в формате "тип квартиры - цена -
     метры". При выборе этой ссылки мы сдвигаемся по странице до
     раздела "планировки и цены" где разворачивается аккордеон с
     выбранным им вариантом".
   - Возможность выбора очереди (с инфой о сроке сдачи)
     Когда пользователь выбирает другую очередь - он переходит на
     другую карточку (здесь очевидно нужна таблица связи)
   - Возможность выбора корпуса
     От корпуса зависят цены, карта корпусов, цены в разделе
     "планировки и цены", "преимущества"
   - Кнопка "все корпуса и цены", открывает pop-up "Очереди и корпуса"
   - Преимущества
   - Карта расположения корпусов комплекса
   - Карта объекта с ценой
   - Раздел планировки и цены
     - Форма поиска по квартирам (внутри квартир этой карточки)
       - Сортировка по цене (убыванию и возрастанию)
       - Выбор корпуса
       - Выбор кол-ва комнат
       - Стоимость квартиры (от .. до .. тыс.руб)
       - Первоначальный взнос, от ... до ...
       - Метраж
       - Кнопка поиска
     - Выдача, в аккордеоне, сгруппированные по кол-ву комнат, колонки
       - Номер корпуса
       - Кол-во комнат
       - Общая площадь
       - Жилая площадь
       - Площадь кухни
       - Балкон/лоджия
       - Санузел
       - Отделка
       - Первый взнос от ..
       - Цена с доп. скидками
       - Инвест. привлекательность
       - Добавить в сравнение?
       - Избранное?
       - Подробнее
       При клике на ячейку в таблице или на кнопку "подробнее" мы
       попадаем в карточку квартиры.
   - Картинки (еще раз)
   - Описание
   - Паспорт обьекта
     - Список параметров-значений, и параметры и значения могут добавлять контент-менеджеры.
   - Ход строительства диаграмма месяцев по годам, к каждому месяцу
     несколько фотографий
   - Кнопка "записаться на тур бесплатно"
   - Похожие предложения
     Как выбирать и группировать - непонятно.
     Нужно сделать алгоритм и вручную.
   - Регламент (условия продажи: 100% оплата, рассрочка, ипотека). В дизайне его нет. Надо ли его
     показывать клиентам.
   - Дата обновления. Показывать ли это клиентам?


 #+NAME: iface_contents
 #+BEGIN_SRC lisp :noweb tangle :exports none

   (in-package #:moto)

   (define-page cmpx "/cmpx/:cmpx-id"
     (let* ((i (parse-integer cmpx-id))
            (cmpx (get-cmpx i)))
       (if (null cmpx)
           "Нет такого жилого комплекса"
           (format nil "~{~A~}"
                   (list
                    (format nil "<h1>Страница жилого комплекса ~A</h1>" (id cmpx))
                    (format nil "<h2>Данные комплекса ~A</h2>" (name cmpx))
                    (tbl
                     (with-element (cmpx cmpx)
                       (row "Название" (name cmpx))
                       (row "Адрес" (addr cmpx))
                       (row "Район" (aif (district-id cmpx)
                                         (name (get-district it))))
                       (row "Метро" (aif (metro-id cmpx)
                                         (name (get-metro it)))))
                     :border 1)
                    (format nil "<h2>Очереди комплекса ~A</h2>~%~A"
                            (name cmpx)
                            (tbl
                             (with-collection (i (find-plex :cmpx-id i))
                               (tr
                                (td
                                 (format nil "<a href=\"/~a/~a\">~a</a>" "plex"
                                         (id i) (id i)))
                                (td (name i)) (td (frm %del%))))
                             :border 1))))))
     (:del (act-btn "DEL" (id i) "Удалить")
           (progn (del-plex (getf p :data)))))
 #+END_SRC

** Страница очереди ЖК

 #+NAME: iface_contents
 #+BEGIN_SRC lisp :noweb tangle :exports none

   (in-package #:moto)

   (define-page plex "/plex/:plex-id"
     (let* ((i (parse-integer plex-id))
            (plex (get-plex i)))
       (if (null plex)
           "Нет такой очереди у этого жилого комплекса"
           (format nil "~{~A~}"
                   (list
                    (format nil "<h1>Страница очереди жилого комплекса</h1>")
                    (format nil "<h2>Данные очереди комплекса</h2>")
                    (tbl
                     (with-element (plex plex)
                       (row "Название" (name plex))
                       (row "Срок сдачи" (name (get-deadline (deadline-id plex))))
                       (row "Субсидия" (subsidy plex))
                       (row "Отделка" (finishing plex))
                       (row "Ипотека" (ipoteka plex))
                       (row "Рассрочка" (installment plex))
                       (row "Расстояние до метро" (distance plex)))
                     :border 1)
                     (format nil "<h2>Корпуса очереди жилого комплекса</h2>~%~A"
                            (tbl
                             (with-collection (i (find-crps :plex-id i))
                               (tr
                                (td
                                 (format nil "<a href=\"/~a/~a\">~a</a>" "crps"
                                         (id i) (id i)))
                                (td (name i)) (td (frm %del%))))
                             :border 1))))))
     (:del (act-btn "del" (id i) "Удалить")
           (progn (del-plex (getf p :data)))))
 #+END_SRC

** Страница корпуса очереди ЖК

 #+NAME: iface_contents
 #+BEGIN_SRC lisp :noweb tangle :exports none

   (in-package #:moto)

   (define-page crps "/crps/:crps-id"
     (let* ((i (parse-integer crps-id))
            (crps (get-crps i)))
       (if (null crps)
           "Нет такой очереди у этого жилого комплекса"
           (format nil "~{~A~}"
                   (list
                    (format nil "<h1>Страница корпуса очереди жилого комплекса</h1>")
                    (format nil "<h2>Данные очереди комплекса</h2>")
                    (tbl
                     (with-element (crps crps)
                       (row "Название" (name crps)))
                     :border 1)
                     (format nil "<h2>Планировки корпуса очереди жилого комплекса</h2>~%~A"
                            (tbl
                             (with-collection (i (find-flat :crps-id i))
                               (tr
                                (td
                                 (format nil "<a href=\"/~a/~a\">~a</a>" "flat"
                                         (id i) (id i)))
                                (td (format nil "~A к.кв." (rooms i)))
                                (td (format nil "~:d руб." (price i)))
                                (td (frm %del%))))
                             :border 1))))))
     (:del (act-btn "DEL" (id i) "Удалить")
           (progn (del-flat (getf p :data)))))
 #+END_SRC

** Страничка планировки

   [[file:pics/Trend_apartment02.png][Дизайн-макет: Карточка квартиры]]

   [[file:pics/Trend_apartment_print.png][Дизайн-макет: Карточка квартиры - версия для печати]]

   Есть вариант открывать карточку квартиры в pop-up окне. Но на каждую квартиру должна быть
   прямая ссылка - очевидно надо менять адресную строку. Также должна быть версия для печати,
   чтобы распечатать интересующий вариант.

   Менеджер по продаже должен иметь возможность на странице квартиры накидать скидок (иногородний
   покупатель, итп), влиящих на цену квартиры. Это очень важное бизнес-требование.

   Видим:
   - Пдф
   - Печать
   - Почта
   - Соцсети (шаринг)
   - Тип квартиры (студия, 1комнатная)
   - id
   - Цена при 100% оплате
   - Кнопка "подробности у менедждера" - ссылка на контакты

   Справа карточка комплекса идентичная поисковой выдачи - она оттуда
   и берется.

   - Планировка квартиры - рисунок
   - План этажа
   - Карта на который мы отмечаем где в корпусе расположена
     квартира - чтобы сориентироваться по виду.
   - Карта с минимальной ценой

   - Характеристики квартиры
     - Кол-во комнат
     - жилая площадь
     - общая площадь
     - Пллощадь кухни
     - Санузел
     - Отделка
     - Балкон
     Нужно иметь возможность добавлять сюда параметры

   - Сравнение
   - Избранное

   - Четыре ключевых преимущетва из ЖК

   - калькулятор ипотеки и рассрочки - отдельный кейс

   - Возможность баннеров (автобусные туры)

   - Инфо о жилом комплексе (потому что попадает в распечатку)

   - Сссылка "подробно о комплексе" - к ЖК

   - Квартиры в этом комплексе - ведут в карточку комплекса с
     открытыми двухкомнатными квартирами.

   - Сообщить об ошибке.

   - Когда было последнее обновление информации о квартире. Обновлено и дату. Чтобы менеджер
     видел актуальность. Показывать ли клиентам?

   Соберем шаблоны страницы планировки

   #+NAME: trendtpl_contents
   #+BEGIN_SRC closure-template-html :noweb tangle :exports none
     {template flatpage}
         <<flatpage_tpl_contents>>
     {/template}
   #+END_SRC

  Соберем определения страниц

 #+NAME: iface_contents
 #+BEGIN_SRC lisp :noweb tangle :exports none

   (in-package #:moto)

   (define-page flat "/flat/:flat-id"
     (let* ((i (parse-integer flat-id))
            (flat (get-flat i)))
       (if (null flat)
           "Нет такой квартиры"
           (format nil "~{~A~}"
                   (list
                    (format nil "<h1>Страница квартиры</h1>")
                    (format nil "<h2>Данные квартиры</h2>")
                    (tbl
                     (with-element (flat flat)
                       (row "Кол-во комнат" (rooms flat))
                       (row "Общая площадь" (area-living flat))
                       (row "Площадь кухни" (area-kitchen flat))
                       (row "цена" (format nil "~:d"(price flat)))
                       (row "балкон/лоджия" (balcon flat))
                       (row "Санузел" (sanuzel flat))
                       (row "" (frm %buy%))
                       )
                     :border 1)))))
     (:buy (act-btn "BUY" "BUY" "Купить")
           (progn 1)))
 #+END_SRC

*** TODO Pop-up
    Есть вариант открывать карточку квартиры в pop-up окне. Но на каждую квартиру должна
    быть прямая ссылка - очевидно надо менять адресную строку.

*** TODO Версия для печати
    Также должна быть версия для печати, чтобы распечатать интересующий вариант.

*** TODO Менеджер хочет накидать скидок
    Менеджер по продаже должен иметь возможность на странице квартиры накидать скидок (иногородний
    покупатель, итп), влиящих на цену квартиры. Это очень важное бизнес-требование.
*** TODO Pdf-версия
*** TODO Отправить на почту
*** TODO Рассказать в социальных сетях
*** Тип квартиры

    #+NAME: flatpage_tpl_contents
    #+BEGIN_SRC closure-template-html :noweb tangle :exports none
      {$rooms | noAutoescape}
      <br />
    #+END_SRC

    Тип квартиры показывается исходя из кол-ва комнат:

    #+NAME: flatpage_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none
      :rooms (let ((r (rooms flat)))
               (cond ((equal 0 r) "Квартира-студия")
                     ((equal 1 r) "1-комнатная квартира")
                     ((equal 2 r) "2-комнатная квартира")
                     ((equal 3 r) "3-комнатная квартира")
                     ((equal 4 r) "4-комнатная квартира")
                     (t (err "unknown rooms value"))))
    #+END_SRC

*** Идентификатор квартиры

    #+NAME: flatpage_tpl_contents
    #+BEGIN_SRC closure-template-html :noweb tangle :exports none
      id: {$id | noAutoescape}
      <br />
    #+END_SRC

    Идентификатор квартиры показывается для быстрого доступа

    #+NAME: flatpage_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none
      :id (id flat)
    #+END_SRC

*** Цена при 100% оплате

    #+NAME: flatpage_tpl_contents
    #+BEGIN_SRC closure-template-html :noweb tangle :exports none
      Цена квартиры при 100% оплате: {$price | noAutoescape}
      <br />
    #+END_SRC

    #+NAME: flatpage_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none
      :price (price flat)
    #+END_SRC

*** Кнопка "подробности у менеджера"

    ссылка на контакты

    #+NAME: flatpage_tpl_contents
    #+BEGIN_SRC closure-template-html
      <a href="/contacts">Подробности у менеджера</a>
      <br />
    #+END_SRC

*** TODO Карточка комплекса

    Справа карточка комплекса идентичная поисковой выдачи - она оттуда
    и берется.

    - Планировка квартиры - рисунок
    - План этажа
    - Карта на который мы отмечаем где в корпусе расположена
      квартира - чтобы сориентироваться по виду.
    - Карта с минимальной ценой

*** TODO Характеристики квартиры

    Нужно иметь возможность добавлять сюда параметры, но в первом прототипе мы это пока не
    делаем

    #+NAME: flatpage_tpl_contents
    #+BEGIN_SRC closure-template-html :noweb tangle :exports none
      <br />
      <div style="border: 1px solid blue;">
          Кол_во комнат: {$rooms | noAutoescape}
          <br />
          Жилая площадь: {$area_living | noAutoescape}
          <br />
          Общая площадь: {$area_sum | noAutoescape}
          <br />
          Пллощадь кухни: {$area_kitchen | noAutoescape}
          <br />
          Санузел: {$sanuzel | noAutoescape}
          <br />
          Отделка: {$finishing | noAutoescape}
          <br />
          Балкон: {$balcon | noAutoescape}
          <br />
      </div>
      <br />
    #+END_SRC

    #+NAME: flatpage_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none
      :rooms (rooms flat)
      :area_living (area-living flat)
      :area_sum (area-sum flat)
      :area_kitchen (area-kitchen flat)
      :sanuzel (sanuzel flat)
      :finishing (finishing flat)
      :balcon (balcon flat)
    #+END_SRC

*** TODO Добавить в сравнение
*** TODO Добавить в избранное
*** TODO Четыре ключевых преимущетва из ЖК
*** TODO калькулятор ипотеки и рассрочки - отдельный кейс
*** TODO Возможность баннеров (автобусные туры)
*** TODO Инфо о жилом комплексе (потому что попадает в распечатку)
*** TODO Сссылка "подробно о комплексе" - к ЖК
*** TODO Квартиры в этом комплексе - ведут в карточку комплекса с открытыми двухкомнатными квартирами.
*** TODO Сообщить об ошибке.
*** TODO Когда было последнее обновление информации о квартире.

    Обновлено и дату. Чтобы менеджер видел актуальность. Показывать ли клиентам?

** START Поиск квартиры в новостройке

   Клиент может искать квартиру используя =простой поиск= или =расширенный поиск=. В сложном
   поиске больше параметров. В обоих случаях он получает одну и ту же выдачу, которая может быть
   представлена в двух разных форматах: =поисковая выдача с картой= или =поисковая выдача
   таблицей=.

   Экcпертов также часто интересует id квартиры - при вводе в строку поиска числового значения,
   находится должен искомый объект.

*** START Простой поиск

    [[file:pics/Trend_mainpage.png][Дизайн-макет: Простой поиск на главной странице]]

    При поиске клиенту интересны следующие параметры:
    - Район
    - Метро
    - Название жилищного комплекса
    - Количество комнат
    - Срок сдачи (не позднее)
    - Стоимость квартиры

    Требуется выводить подсказки в поисковой строке
    [[file:pics/Trend_mainpage07.png][Пример подсказок в дизайн-макете]]

    Пользователь, выполнивший простой поиск попадает в выдачу.

    #+NAME: iface_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none

      (in-package #:moto)

      (define-page findpage "/find"
        (format nil "~{~A~}"
                (list
                 (format nil "<h1>Страница поиска</h1>")
                 (format nil "<h2>Простой поиск</h2>")
                 (frm
                  (tbl
                   (list
                    (row "Район"
                      (select ("district")
                        (list* (list "Не важен" "0")
                               (with-collection (i (all-district))
                                 (list (name i)
                                       (id i))))))
                    (row "Метро"
                      (select ("metro")
                        (list* (list "Любое" "0")
                               (with-collection (i (all-metro))
                                 (list (name i)
                                       (id i))))))
                    (row "Название ЖК"
                      (select ("cmpx")
                        (list* (list "Любой ЖК" "0")
                               (with-collection (i (all-cmpx))
                                 (list (name i)
                                       (id i))))))
                    (row "Кол-во комнат"
                      (tbl
                       (list
                        (row "" "Выберите не менее одного варианта")
                        (row (input "checkbox" :name "studio" :value t) "Студия")
                        (row (input "checkbox" :name "one" :value t) "Однокомнатная")
                        (row (input "checkbox" :name "two" :value t) "Двухкомнатная")
                        (row (input "checkbox" :name "three" :value t) "Трехкомнатная"))))
                    (row "Срок сдачи (не позднее)"
                      (select ("deadline")
                        (list* (list "Не важен" "0")
                               (with-collection (i (all-deadline))
                                 (list (name i)
                                       (id i))))))
                    (row "Стоимость квартиры"
                      (tbl
                       (list
                        (row "" "Обязательные поля")
                        (row "от" (fld "price-from"))
                        (row "до" (fld "price-to")))))
                    (row "" %find%))
                   :border 1)
                  :action "/results")))
        (:find (act-btn "FIND" "FIND" "Искать")
               "Err: redirect to /results!"))
   #+END_SRC

*** Расширенный поиск

    [[file:pics/Trend_mainpage_search.png][Дизайн-макет: Расширенный поиск на главной странице]]

    Все тоже самое что и в =простом поиске=, но:

    - Вместо "Срока сдачи" можно задать интервал (от ... до ...) тоже списком выбора
    - Добавляется блок "ипотека", в котором есть "первоначальный взнос" и "ежемесячный
      платеж". Клиент должен ввести число либо в одно поле либо в другое.
    - Рассрочка - либо "первоначальный взнос" либо "ежемесячный платеж". Если клиент готов
      рассматривать или ипотеку или рассрочку - то в выдаче мы выдаем и те и другие варианты
    - Метраж (от ... до ...)
    - Субсидия (галочка) - квартиру можно приобрести с помощью жилищного сертификата, который
      покрывает часть стоимости квартиры. Это можно объяснять всплывающей подсказкой
    - Отделка (галочка) - если клиент ставит галочку, то мы выдаем только те квартиры в которых
      есть обои, раковины и можно сразу жить.
    - Инвестиционная привлекательность удорожание в процентах или предоставить форму с двумя полями:
      - Сумма которую хочет инвестировать клиент
      - Срок на который хочет инвестировать клиент (поквартально)



    Также нужен поиск по расстоянию до метро, но мы будем стараться чтобы этот параметр был
    доступен только для менеджера компании

*** Поисковая выдача с картой

    [[file:pics/Trend_search12_map.png][Дизайн-макет: Поисковая выдача с картой]]

    Выдача отдается в две колонки - слева список, включающий:
    - Фото комплекса
    - Название
    - Район
    - Метро
    - Расстояние до метро
    - Срок сдачи
    - Тип отделки
    - Ипотека (если есть)
    - Рассрочка (если есть)
    - Цена квартир которых он искал (от...). Если он в поиске выбрал и
      однушку и двушку и трешку показывается самое дешевое с метражом
    - Цена всех вариантов (однушку и двушку и трешку), по клику на
      плюсике (с метражом)
    - В избранное
    - В сравнение

    В правой колонке выводятся маркеры на карте, содержащие цену и синхронизированные со списком
    выдачи (рамки при наведении итп)

    При этом при скроллировании карта остается на месте, а выдача прокручивается.

    Сортировать можно:
    - по цене туда и обратно
    - по сроку сдачи
    - по району
    - по станции метро
    - возможно, по расстоянию до метро

    Надо указывать число найденных комплексов.

    Возможность переключения между выдачей на карте и выдачей списком

    Нажимая на элемент выдачи он попадает в карточку ЖК

    После выдачи идет блок похожих предложений, но возможно откажемся от этого блока здесь.

*** START Поисковая выдача таблицей

    [[file:pics/Trend_search11_list.png][Дизайн-макет: Поисковая выдача таблицей]]

    Выдается таблица с колонками:
    - Район
    - Название ЖК
    - Станция метро
    - До метро
    - Срок сдачи
    - Отделка
    - Ипотека/Рассрочка
    - Кол-во комнат
    - Общая площадь
    - Цена с доп. скидками
    - Цена всех вариантов (однушку и двушку и трешку), по клику на
      плюсике (с метражом)
    - В избранное
    - В сравнение

    Сортировать необходимо по столбцам.

    Нажимая на элемент выдачи он попадает в карточку ЖК

    После выдачи идет блок похожих предложений, но возможно откажемся от этого блока здесь.

    #+NAME: iface_contents
    #+BEGIN_SRC lisp :noweb tangle :exports none
      (in-package #:moto)

      (defmacro find-query (price-from price-to &optional &key district metro deadline cmpx studio one two three)
        `(with-connection *db-spec*
           (query
            (:limit
             (:select (:as 'district.name 'district)  (:as 'cmpx.name 'cmpx)
                      (:as 'metro.name    'metro)     'distance
                      (:as 'deadline.name 'deadline)  'finishing
                      'ipoteka  'installment  'rooms  'area-sum  'price
                      :from 'flat
                      :inner-join 'crps :on (:= 'flat.crps_id 'crps.id)
                      :inner-join 'plex :on (:= 'crps.plex_id 'plex.id)
                      :inner-join 'cmpx :on (:= 'plex.cmpx_id 'cmpx.id)
                      :inner-join 'district :on (:= 'cmpx.district_id 'district.id)
                      :inner-join 'metro :on (:= 'cmpx.metro_id 'metro.id)
                      :inner-join 'deadline :on (:= 'plex.deadline_id 'deadline.id)
                      :where (:and ,(remove-if #'null
                                               `(:or ,(when studio `(:= 'rooms 0))
                                                     ,(when one    `(:= 'rooms 1))
                                                     ,(when two    `(:= 'rooms 2))
                                                     ,(when three  `(:= 'rooms 3))))
                                   (:and (:> 'price ,price-from)
                                         (:< 'price ,price-to))
                                   ,(if district
                                        `(:= 'district_id ,district)
                                        t)
                                   ,(if metro
                                        `(:= 'metro_id ,metro)
                                        t)
                                   ,(if deadline
                                        `(:<= 'deadline_id ,deadline)
                                        t)
                                   ,(if cmpx
                                        `(:= 'cmpx_id ,cmpx)
                                        t)))
             2000))))

      (define-page results "/results"
        (format nil "~{~A~}"
                (list
                 (format nil "<h1>Страница поиска</h1>")
                 (format nil "<h2>Простой поиск</h2>")
                 "Пустой поисковый запрос"))
        (:find (act-btn "FIND" "FIND" "Искать")
               (format nil "~{~A~}"
                       (list
                        (format nil "~%<h1>Страница поиска</h1>")
                        (format nil "~%<h2>Выборка</h2>")
                        (format nil "~%<br /><br />Параметры поиска: ~A" (bprint p))
                        (format nil "~%<br /><br />~A"
                                (let* ((form `(find-query
                                               ,(parse-integer (getf p :price-from))
                                               ,(parse-integer (getf p :price-to))
                                               )))
                                  (unless (equal "0" (getf p :district))
                                    (setf form (append form (list :district (parse-integer (getf p :district))))))
                                  (unless (equal "0" (getf p :metro))
                                    (setf form (append form (list :metro (parse-integer (getf p :metro))))))
                                  (unless (equal "0" (getf p :deadline))
                                    (setf form (append form (list :deadline (parse-integer (getf p :deadline))))))
                                  (unless (equal "0" (getf p :cmpx))
                                    (setf form (append form (list :cmpx (parse-integer (getf p :cmpx))))))
                                  (when (getf p :studio)
                                    (setf form (append form (list :studio t))))
                                  (when (getf p :one)
                                    (setf form (append form (list :one t))))
                                  (when (getf p :two)
                                    (setf form (append form (list :two t))))
                                  (when (getf p :three)
                                    (setf form (append form (list :three t))))
                                  (format nil "~%<br /><br />Запрос: ~A~%<br /><br />Результат: <br/><br />~A"
                                          (bprint form)
                                          (format nil "<table border=1><tr>~{~A~}</tr>~{~A~}</table>"
                                                  (loop :for item :in '("Район" "Комплекс" "Метро" "Расстояние" "Срок сдачи"
                                                                        "Отделка" "Ипотека" "Рассрочка" "Кол-во комнат" "Общая площадь" "Цена") :collect
                                                     (format nil "~%<th>~A</th>" item))
                                                  (loop :for item :in (eval form) :collect
                                                     (format nil "~%<tr>~{~A~}</tr>"
                                                             (loop :for item :in item :collect
                                                                (format nil "~%<td>&nbsp;~A&nbsp;</td>" item))))))))))))
   #+END_SRC

* Проект CRM-системы для отдела продаж

  Обращение стоит денег, его надо оформлять в объект базы CRM - чтобы
  не терялись. В первую очередь необходимо зафиксировать телефон, с
  которого звонит клиент

* Сценарии использования
** Просто карта

   Макета нет, но можно ориентировать на Trend_search_map.

   Title: Все ЖК.

   ostrovok.ru

   Закрыть карту.

   Нам надо развернуть карту на целый экран или свернуть чтобы показть выборку.

   Надо подумать делать просто большую карту или вместе с выборкой и фильтрами

   По умолчанию открыватся большая, после клика на маркер нужно что-то показать об выбранном
   комплексе. Можно попапом, или в карту уменьшить и сбоку.

   Все комплексы.

   Карта не должна скроллиться

** Поиск вторичного жилья

   В первом релизе не будет.

   Вторичное жилье не так критично, т.к. занимает 1% от
   реализаций, ему можно оставить только простой поиск.

   Для вторички нет срока сдачи, но есть тип дома (список выбора)

   Экпертов также часто интересует id обьекта - при вводе в строку
   поиска числа находится должен искомый объект. id должен печататься
   и на карточке квартиры, для того чтобы, можно было по телефону
   объяснить о каком объекте идет речь.

** Ипотечный калькулятор в карточке квартиры

   Задачи:
   - Показать клиенту что он может взять квартиру в ипотеку
   - Дать клиенту возможность оценить свои возможности, поиграв с калькулятором.

   Мы должны иметь возможность присваивать программы =корпусу очереди=. У одного корпуса может быть
   множество разных программ от множества разных банков.  На карточке квартиры нужно показать
   расчет с эвристически лучшей программой - например, с самой низкой процентной ставкой и самым
   длинным сроком кредита - но есть вариант рекомендовать это вручную.  Мы не показываем ему инфу
   по программе банка (даже наименование банка не светим), чтобы он консультировался с нашим
   специалистом. Но менеджеры получают подробную инфу.

   Параметры:
   - Стоимость квартиры (мин 10% от стоимости квартиры) - не давать клиенту забить меньше
   - Первоначальный взнаос (мин 10%) - не давать клиенту забить меньше
   - Срок кредита (макс 25 лет)
   - Процентная ставка % в год - по идее если клиенту показывается оптимальный банк то он не
     должен мочь ее менять.
   - Менеджеру видно банки, % и ежемесячный платеж.
   Результат
   - Ежемесячный платеж

** Ипотечный калькулятор в отдельном разделе

   Ипотечный калькулятор используется клиентом чтобы расчитать ипотеку неважно для какой
   квартиры. После рассчета можно отдать клиенту выборку подходящих квартир.

   Есть банки, у них есть "программы". Мы дожны создавать базу по банкам и их программам. У
   программы банка есть:
   - Наименование
   - Максимальный срок кредита
   - Процентная ставка
   - Минимальный первый взнос в процентах.

   Сценарии проговаривать с ипотечниками - уточнять по ходу дела.

   Варианты расчета:
   - Отталкиваемся от дохода
     - Ставим максммальный срок
     - Подбираем сумму кредита (доход 50.000, может ли взять 2.000.000)
     - Определяем ежемесячный платеж - смотрим сможет ли платить.
     - Манипулируем суммами чтобы учесть все интересы.
   - Отталкиваемся от максимального размера ежемесячный платежей
   - Отталкиваемся от максимального срока погашения (из-за возраста)
   - Отталкиваемся от единственного банка или от суммы кредита

** Калькулятор рассрочки

   Чем сложнее чем ипотечный калькулятор?

   Если мы говорм про рассрочку, то параметры там те же самые что и в ипотеке:
   - мин перв взнос
   - срок
   - процент
   но если вносишь 10% и платишь за 2 года, то тебе такая процентная ставка
   Там очень много программ и все они зависят сложным образом от входных параметров, которых
   неопределенное число, и иногда даже зависит от типа квартир или, например, от этажности, акции
   и фазы луны.

   Застройщик делает программы рассрочки со сложными условиями..

   Как формализовать условия? У нас есть менеддеры по внутреннему развитию проектов. Они умеют
   делать экселевские калькуляторы для себя. Также многие застройщики деляют экселевские файлы для
   рассчетов своих рассрочек.

** Запись на демонстрацию квартир
   Просто форма заявки, пусть клиент запоняет.
** Похожие предложения
   Первый вариант - назначает менеджер вручную, в первом релизе можно ограничиться им.
   Второй вариант - назначить алгоритмом:
   - Берем за базу цену, отсекаем все что выходит за коридор цены.
   - Срок сдачи (коридор срока)
   - Район (тут все сложно - рядом по территориальности, например)
   Вариант:
** Продажа своей квартиры
   Ссылка на контакты пока или форму заявки.
** Обращение в компанию
   Контакты
** Подписка на рассылку
   В первом релизе можно обойтись без нее.
   Рассылка долждна быть в нескольких вариантах.
   - Возможность подписаться на новости по конкретному объекту
   - Возможность подписать на инвестиционные предложения, которые мы сами генерируем
   - Подписка на старте продаж.
** Сравнение
   Trend_comparisioon

   В сравнение можно добавлять и жилые комплексы и квартиры. Если человек добавляет квартиру, то
   ЖК добавляется автоматически.

   О ЖК:

   При нажатии менеджером "отправить на почту" нужно генерировать ссылку с этими объектами,
   добавленными в сравнение. Это нужно чтобы отдать клиенту "на подумать".

   Карта с объектами с автоматическим расчетом центра и масштаба

   Скроллер влево-вправо
   Сердечко - добавить в избранное
   Удалить их сравнения
   Блок "о комплексе"
   - Рендер (кликабельно в объект)
   - Название ЖК и очередь
   - Район
   - Метро и расстояние до него
   - Срок сдачи
   - Цена минимальных квартир
   - Тип отделки
   - Ипотека с указанием макс срока
   - Рассрочка с указанием макс срока
   - Стандартный блок "тип квартиры- цена от - метраж по всем типам квартир"
   Блок сравнения по паспорту объекта
   ... поднимаем из комплекса

   О квартирах:
   - Сердечко - добавить в избранное
   - Удалить их сравнения
   - Планировка (картинка с увеличением)
   - Сравнение по данным таблицы по квартирам, которую мы описывали в карточке ЖК.

** Избранное

   Trend_favorite_map

   Избранное согласно поисковой выдаче. Все так же, только избранное.
   Но в избранном может быть как комплекс так и квартира. Как отображать это таблицей -
   понятно. А как отображать на карте?

** "Просмотрено" - список объектов просмотренных пользователем ранее
   Отображается точно также как избранное, но заносим мы туда только комплексы, без
   квартир. Непонятно почему?

** Хранение и визуализация истории цен по объекту (!) (менеджер и возможно клиент)
   Это нужно чтобы показать клиенту инвестиционную привлекательность квартиры в этом корпусе.

   График с четырьмя кривыми цен по типам квартиры.

   Нам нужна цена квадратного метра в зависимости от типа квартиры.

   Контенщик или робот заносит в базу базовую цену квадратного метра (разную в зависимости от
   типа квартиры)
** Внесение данных контентщиком
** Внесение данных объектов роботом
** Скачать pdf
* Тесты

  #+NAME: trend_test
  #+BEGIN_SRC lisp :noweb tangle :exports none

    ;; Тестируем trend
    (defun trend-test ()
      <<trend_test_contents>>
      (dbg "passed: trend-test~%"))
    (trend-test)
  #+END_SRC

  #+NAME: trend_test_contents
  #+BEGIN_SRC lisp :noweb tangle :exports none

  #+END_SRC
* Остальное

  Элементарный поиск (то что есть на существующем сайте)
  Карточки квартир
  Поиск по большому кол-ву параметров:
  - первый взнос
  - платеж в месяц
  - инвестиционная привлекательность
  - ...
  Личный кабинет менеджера
  - Графики чтобы обосновать клиенту инвест. привлекательность
  - Статистика работы менеджеров
  - ...
* Конкуренты
  cian.ru
  петербургская недвижимость
  миан
  миель
  инком
  ндв-недвижимость
* Инвест-привлекательность:

  В идеале для клиента надо предоставить форму с двумя полями:
  - Сумма которую хочет инвестировать клиент
  - Срок на который хочет инвестировать клиент

  И система автоматически подберет ему подходящие варианты (из числа заранее отобранных
  менеджерами компании)

* Точки входа

  Соберем шаблоны:

  #+NAME: trend_tpl
  #+BEGIN_SRC closure-template-html :tangle src/mod/trend/trend-tpl.htm :noweb tangle :exports none
    // -*- mode: closure-template-html; fill-column: 140 -*-
    {namespace trendtpl}

    <<trendtpl_contents>>
  #+END_SRC

  Скомпилируем шаблоны при подготовке модуля

  #+NAME: trend_prepare
  #+BEGIN_SRC lisp :tangle src/mod/trend/trend-prepare.lisp :noweb tangle :exports none
    (in-package #:moto)

    ;; Скомпилируем шаблон
    (closure-template:compile-template
     :common-lisp-backend
     (pathname
      (concatenate 'string *base-path* "mod/trend/trend-tpl.htm")))
  #+END_SRC

  Соберем контроллеры и все функции, которые контроллеры вызывают

  #+NAME: trend_fn
  #+BEGIN_SRC lisp :tangle src/mod/trend/trend.lisp :noweb tangle :exports none
    (in-package #:moto)

    <<flat_entity>>

    <<trend_fn_contents>>

    <<trend_test>>
  #+END_SRC

* Сборка
** Сущности и автоматы

   Соберем все сущности и автоматы

   #+NAME: entity_and_automates
   #+BEGIN_SRC lisp :tangle src/mod/trend/entityes.lisp :noweb tangle :exports none :padline no :comments link
     (in-package #:moto)

     <<asm_cmpx()>>

     <<asm_plex()>>

     <<asm_crps()>>

     <<asm_flat()>>

     <<asm_city()>>

     <<asm_district()>>

     ;; Районы города
     ;; (make-district :name "Адмиралтейский")
     ;; (make-district :name "Василеостровский")
     ;; (make-district :name "Выборгский")
     ;; (make-district :name "Калининский")
     ;; (make-district :name "Кировский")
     ;; (make-district :name "Колпинский")
     ;; (make-district :name "Красногвардейский")
     ;; (make-district :name "Красносельский")
     ;; (make-district :name "Кронштадтский")
     ;; (make-district :name "Курортный")
     ;; (make-district :name "Московский")
     ;; (make-district :name "Невский")
     ;; (make-district :name "Петроградский")
     ;; (make-district :name "Петродворцовый")
     ;; (make-district :name "Приморский")
     ;; (make-district :name "Пушкинский")
     ;; (make-district :name "Фрунзенский")
     ;; (make-district :name "Центральный")
     ;; (make-district :name "Всеволожкси")

     ;; Районы области
     ;; (make-district :name "Бокситогорский")
     ;; (make-district :name "Волосовский")
     ;; (make-district :name "Волховский")
     ;; (make-district :name "Всеволожский")
     ;; (make-district :name "Выборгский")
     ;; (make-district :name "Гатчинский")
     ;; (make-district :name "Кингисеппский")
     ;; (make-district :name "Киришский")
     ;; (make-district :name "Кировский")
     ;; (make-district :name "Лодейнопольский")
     ;; (make-district :name "Ломоносовский")
     ;; (make-district :name "Лужский")
     ;; (make-district :name "Подпорожский")
     ;; (make-district :name "Приозерский")
     ;; (make-district :name "Сланцевский")
     ;; (make-district :name "Тихвинский")
     ;; (make-district :name "Тосненский")

     <<asm_metro()>>

     ;; (make-metro :name "Автово")
     ;; (make-metro :name "Адмиралтейская")
     ;; (make-metro :name "Академическая")
     ;; (make-metro :name "Балтийская")
     ;; (make-metro :name "Бухарестская")
     ;; (make-metro :name "Василеостровская")
     ;; (make-metro :name "Владимирская")
     ;; (make-metro :name "Волковская")
     ;; (make-metro :name "Выборгская")
     ;; (make-metro :name "Горьковская")
     ;; (make-metro :name "Гостиный двор")
     ;; (make-metro :name "Гражданский проспект")
     ;; (make-metro :name "Девяткино")
     ;; (make-metro :name "Достоевская")
     ;; (make-metro :name "Елизаровская")
     ;; (make-metro :name "Звёздная")
     ;; (make-metro :name "Звенигородская")
     ;; (make-metro :name "Кировский завод")
     ;; (make-metro :name "Комендантский проспект")
     ;; (make-metro :name "Крестовский остров")
     ;; (make-metro :name "Купчино")
     ;; (make-metro :name "Ладожская")
     ;; (make-metro :name "Ленинский проспект")
     ;; (make-metro :name "Лесная")
     ;; (make-metro :name "Лиговский проспект")
     ;; (make-metro :name "Ломоносовская")
     ;; (make-metro :name "Маяковская")
     ;; (make-metro :name "Международная")
     ;; (make-metro :name "Московская")
     ;; (make-metro :name "Московские ворота")
     ;; (make-metro :name "Нарвская")
     ;; (make-metro :name "Невский проспект")
     ;; (make-metro :name "Новочеркасская")
     ;; (make-metro :name "Обводный канал")
     ;; (make-metro :name "Обухово")
     ;; (make-metro :name "Озерки")
     ;; (make-metro :name "Парк Победы")
     ;; (make-metro :name "Парнас")
     ;; (make-metro :name "Петроградская")
     ;; (make-metro :name "Пионерская")
     ;; (make-metro :name "Площадь Александра Невского")
     ;; (make-metro :name "Площадь Александра Невского")
     ;; (make-metro :name "Площадь Восстания")
     ;; (make-metro :name "Площадь Ленина")
     ;; (make-metro :name "Площадь Мужества")
     ;; (make-metro :name "Политехническая")
     ;; (make-metro :name "Приморская")
     ;; (make-metro :name "Пролетарская")
     ;; (make-metro :name "Проспект Большевиков")
     ;; (make-metro :name "Проспект Ветеранов")
     ;; (make-metro :name "Проспект Просвещения")
     ;; (make-metro :name "Пушкинская")
     ;; (make-metro :name "Рыбацкое")
     ;; (make-metro :name "Садовая")
     ;; (make-metro :name "Сенная площадь")
     ;; (make-metro :name "Спасская")
     ;; (make-metro :name "Спортивная")
     ;; (make-metro :name "Старая Деревня")
     ;; (make-metro :name "Технологический институт")
     ;; (make-metro :name "Технологический институт")
     ;; (make-metro :name "Удельная")
     ;; (make-metro :name "Улица Дыбенко")
     ;; (make-metro :name "Фрунзенская")
     ;; (make-metro :name "Чёрная речка")
     ;; (make-metro :name "Чернышевская")
     ;; (make-metro :name "Чкаловская")
     ;; (make-metro :name "Электросила")

     <<asm_deadline()>>

     ;; (make-deadline :name "1 квартал 2015")
     ;; (make-deadline :name "2 квартал 2015")
     ;; (make-deadline :name "3 квартал 2015")
     ;; (make-deadline :name "4 квартал 2015")

     ;; (make-deadline :name "1 квартал 2016")
     ;; (make-deadline :name "2 квартал 2016")
     ;; (make-deadline :name "3 квартал 2016")
     ;; (make-deadline :name "4 квартал 2016")

     ;; (make-deadline :name "1 квартал 2017")
     ;; (make-deadline :name "2 квартал 2017")
     ;; (make-deadline :name "3 квартал 2017")
     ;; (make-deadline :name "4 квартал 2017")

     ;; (make-deadline :name "1 квартал 2018")
     ;; (make-deadline :name "2 квартал 2018")
     ;; (make-deadline :name "3 квартал 2018")
     ;; (make-deadline :name "4 квартал 2018")

     ;; (make-deadline :name "1 квартал 2019")
     ;; (make-deadline :name "2 квартал 2019")
     ;; (make-deadline :name "3 квартал 2019")
     ;; (make-deadline :name "4 квартал 2019")

   #+END_SRC

*** Жилой комплекс

    #+NAME: asm_cmpx
    #+BEGIN_SRC emacs-lisp :var flds=cmpx_flds :exports none :session gen
      ;; (gen-entity "cmpx" "комплекса" flds)
    #+END_SRC

*** Очередь жилого комплекса

    #+NAME: asm_plex
    #+BEGIN_SRC emacs-lisp :var flds=plex_flds :exports none :session gen
      ;; (gen-entity "plex" "очереди жилого комплекса" flds)
    #+END_SRC

*** Корпус очереди жилого комплекса

    #+NAME: asm_crps
    #+BEGIN_SRC emacs-lisp :var flds=crps_flds :exports none :session gen
      ;; (gen-entity "crps" "корпуса очереди жилого комплекса" flds)
    #+END_SRC

*** Планировка

    #+NAME: asm_flat
    #+BEGIN_SRC emacs-lisp :var flds=flat_flds :exports none :session gen
      ;; (gen-entity "flat" "планировки" flds)
    #+END_SRC

*** Город

    #+NAME: asm_city
    #+BEGIN_SRC emacs-lisp :var flds=city_flds :exports none :session gen
      ;; (gen-entity "city" "города" flds)
    #+END_SRC

*** Районы

    #+NAME: asm_district
    #+BEGIN_SRC emacs-lisp :var flds=district_flds :exports none :session gen
      ;; (gen-entity "district" "района" flds)
    #+END_SRC

*** Метро

    #+NAME: asm_metro
    #+BEGIN_SRC emacs-lisp :var flds=metro_flds :exports none :session gen
      ;; (gen-entity "metro" "метро" flds)
    #+END_SRC

*** Сроки сдачи

    #+NAME: asm_deadline
    #+BEGIN_SRC emacs-lisp :var flds=deadline_flds :exports none :session gen
      ;; (gen-entity "deadline" "метро" flds)
    #+END_SRC

** Загрузчик данных из файлов

   Соберем загрузчик

   #+NAME: asm_loader
   #+BEGIN_SRC lisp :tangle src/mod/trend/loader.lisp :noweb tangle :exports none :padline no :comments link
   <<loader>>
   #+END_SRC
